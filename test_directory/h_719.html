<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Развертывание Azure RTOS и USB стека на STM32H753 / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/582742\/"},"headline":"Развертывание Azure RTOS и USB стека на STM32H753","datePublished":"2021-10-11T13:14:37+03:00","dateModified":"2021-10-11T13:52:01+03:00","author":{"@type":"Person","name":"Indemsys"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Здесь разберем следующие темы:Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.Подключение на один порт USB одновременн...","url":"https:\/\/habr.com\/ru\/post\/582742\/#post-content-body","about":["h_open_source","h_controllers","h_electronics","h_DIY","h_easyelectronics","f_develop","f_popsci"],"image":["https:\/\/habr.com\/share\/publication\/582742\/1a6f127220729c5c14258e7d7366286a\/","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/b7e\/33a\/0f2\/b7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/138\/83f\/306\/13883f3066a66f1ae91a35a2a72a743c.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Развертывание Azure RTOS и USB стека на STM32H753" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Развертывание Azure RTOS и USB стека на STM32H753" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Развертывание Azure RTOS и USB стека на STM32H753" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Здесь разберем следующие темы:Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.Подключение на один порт USB одновременно трех разных интерфейсов: Mass..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Здесь разберем следующие темы:Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.Подключение на один порт USB одновременно трех разных интерфейсов: Mass..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Здесь разберем следующие темы:Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.Подключение на один порт USB одновременно трех разных интерфейсов: Mass..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Здесь разберем следующие темы:Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.Подключение на один порт USB одновременно трех разных интерфейсов: Mass..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Здесь разберем следующие темы:Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.Подключение на один порт USB одновременно трех разных интерфейсов: Mass..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habrastorage.org/getpro/habr/upload_files/b7e/33a/0f2/b7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/b7e/33a/0f2/b7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/b7e/33a/0f2/b7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/b7e/33a/0f2/b7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/b7e/33a/0f2/b7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="582742" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-11T10:14:37.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/582742/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/582742/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habrastorage.org/getpro/habr/upload_files/b7e/33a/0f2/b7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png" data-vmid="image:href"><link data-vue-meta="ssr" rel="amphtml" href="https://habr.com/ru/amp/post/582742/">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/Indemsys/" title="Indemsys" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_blue"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="/ru/users/Indemsys/" class="tm-user-info__username">
      Indemsys
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-11T10:14:37.000Z" title="2021-10-11, 13:14">11  октября   в 13:14</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Развертывание Azure RTOS и USB стека на STM32H753</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/open_source/" class="tm-article-snippet__hubs-item-link"><span>Open source</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/controllers/" class="tm-article-snippet__hubs-item-link"><span>Программирование микроконтроллеров</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/electronics/" class="tm-article-snippet__hubs-item-link"><span>Производство и разработка электроники</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/DIY/" class="tm-article-snippet__hubs-item-link"><span>DIY или Сделай сам</span> <!----></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/easyelectronics/" class="tm-article-snippet__hubs-item-link"><span>Электроника для начинающих</span> <!----></a></span></div> <div class="tm-article-snippet__labels"><div class="tm-article-snippet__label"><span>
        Tutorial
      </span></div></div> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><figure class="full-width "><img src="/img/image-loader.svg" height="421" data-src="https://habrastorage.org/getpro/habr/upload_files/b7e/33a/0f2/b7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png" data-width="592"/><figcaption></figcaption></figure><p>Здесь разберем следующие темы:</p><ul><li><p>Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.</p></li><li><p>Подключение на один порт USB одновременно трех разных интерфейсов: Mass Storage, Virtual COM, RNDIS </p></li><li><p>Универсальный драйвер последовательного ввода-вывода способный работать через UART, USB,  Telnet, FreeMaster и прочие каналы связи. </p></li></ul><p>Репозиторий проекта со схемами, исходными кодами проектов и статьями: <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0" rel="noopener noreferrer nofollow">https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0</a></p><p><strong><em>Краткое содержание предыдущих статей</em></strong>:</p><p>Была <a href="https://habr.com/ru/post/557242/" rel="noopener noreferrer nofollow"><u>разработана схема</u></a> универсального контроллера резервного питания. Потом <a href="https://habr.com/ru/post/562462/" rel="noopener noreferrer nofollow"><u>разработана плата</u></a>. Затем начата <a href="https://habr.com/ru/post/573352/" rel="noopener noreferrer nofollow"><u>разработка софта</u></a> и после изготовления платы <a href="https://habr.com/ru/post/574088/" rel="noopener noreferrer nofollow"><u>отладка</u></a>. Затем кризис поставок микросхем нарушил планы и плата была <a href="https://habr.com/ru/post/578940/" rel="noopener noreferrer nofollow"><u>переделана под STM32H753</u></a> и получила номер версии 2.0. </p><p>И вот снова перед нами не отлаженная плата и снова ставим на нее Azure RTOS. Для демонстрации этапа развертывания Azure RTOS был создан демо-проект<a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/tree/main/Software/Azure_RTOS_Example1" rel="noopener noreferrer nofollow"><u> Example1</u></a>.</p><p>По началу  нам помог могучий инструмент  STM32CubeMX. Но по мере разработки программного проекта контроллера приходится все дальше отдаляться от архитектуры задаваемой при генерации исходников этим инструментом. Поэтому несмотря на то что файл Example1.ioc проекта STM32CubeMX  все еще находится в рабочей директории запускать генерацию из него нельзя. Он нужен только для того чтобы посмотреть в него и вспомнить настройки портов и тактирования, поскольку из содержимого исходников выяснить эти настройки довольно трудно.  </p><h3>Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0</h3><p>Сам базис приложения с Azure RTOS изначально был сгенерирован с помощью STM32CubeMX. Но затем была мной сильно изменена структура директорий поскольку совсем не понравилось как выполнена структура и именование директорий после STM32CubeMX. Далее было обнаружено что даже самый последний апгрейд STM32CubeMX не содержит самую последнюю версию Azure RTOS и дальше уже апгрейды Azure RTOS приходится делать вручную. </p><p>STM32CubeMX освободил от многих нюансов портирования RTOS, но некоторые моменты в файле  <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/ThreadX/tx_initialize_low_level.s" rel="noopener noreferrer nofollow"><u>tx_initialize_low_level.s</u></a><em> </em>все же пришлось изменить - это объявление <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/0a3a2a708e4389397eafa4df7d33977634cbb146/Software/Azure_RTOS_Example1/ThreadX/tx_initialize_low_level.s#L58" rel="noopener noreferrer nofollow"><u>системного тика</u></a> , объявление <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/0a3a2a708e4389397eafa4df7d33977634cbb146/Software/Azure_RTOS_Example1/ThreadX/tx_initialize_low_level.s#L60" rel="noopener noreferrer nofollow"><u>начала свободной памяти</u></a> и <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/0a3a2a708e4389397eafa4df7d33977634cbb146/Software/Azure_RTOS_Example1/ThreadX/tx_initialize_low_level.s#L154" rel="noopener noreferrer nofollow"><u>установка приоритетов</u></a> системных прерываний.  </p><h4>Выделение динамической памяти через файл линкера и стартовую процедуру RTOS</h4><p>Память в микроконтроллере сильно фрагментирована. Поэтому для динамической памяти выбираем наиболее универсальную и наибольшую область памяти - AXI SRAM. </p><p>В файле <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/stm32h753xx_example1.icf" rel="noopener noreferrer nofollow"><u>stm32h753xx_example1.icf</u></a> объявляем в этой области секцию <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/10bfaace89cd4c17b4f7a6a540b36ffbb9333475/Software/Azure_RTOS_Example1/stm32h753xx_example1.icf#L48" rel="noopener noreferrer nofollow"><u>FREE_MEM</u></a></p><p>Далее в исходниках RTOS в файле <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/ThreadX/tx_initialize_low_level.s" rel="noopener noreferrer nofollow"><u>tx_initialize_low_level.s</u></a> присутствует размещение переменной <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/10bfaace89cd4c17b4f7a6a540b36ffbb9333475/Software/Azure_RTOS_Example1/ThreadX/tx_initialize_low_level.s#L61" rel="noopener noreferrer nofollow"><u>_tx_free_memory_start</u></a>  в секции <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/10bfaace89cd4c17b4f7a6a540b36ffbb9333475/Software/Azure_RTOS_Example1/ThreadX/tx_initialize_low_level.s#L59" rel="noopener noreferrer nofollow"><u>FREE_MEM</u></a>. Адрес этой переменной передается в виде аргумента в функцию <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/10bfaace89cd4c17b4f7a6a540b36ffbb9333475/Software/Azure_RTOS_Example1/ThreadX/src/tx_initialize_kernel_enter.c#L132" rel="noopener noreferrer nofollow"><u>tx_application_define</u></a>.  И уже в <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/10bfaace89cd4c17b4f7a6a540b36ffbb9333475/Software/Azure_RTOS_Example1/App/Main.c#L51" rel="noopener noreferrer nofollow"><u>реализации этой</u></a> функции наше демо-приложение получает адрес для <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/10bfaace89cd4c17b4f7a6a540b36ffbb9333475/Software/Azure_RTOS_Example1/App/Main.c#L53" rel="noopener noreferrer nofollow"><u>организации</u></a> байтового <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/10bfaace89cd4c17b4f7a6a540b36ffbb9333475/Software/Azure_RTOS_Example1/App/Mem_man.c#L22" rel="noopener noreferrer nofollow"><u>пула динамической памяти</u></a>.   Размер пула определяется границей области AXI SRAM -    <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/10bfaace89cd4c17b4f7a6a540b36ffbb9333475/Software/Azure_RTOS_Example1/App/App.h#L58" rel="noopener noreferrer nofollow"><u>AXI_SRAM_END</u></a></p><h4>Управление размерами стеков и приоритетами задач</h4><p>Часто встречается когда размеры стеков и приоритеты задач устанавливаются непосредственно в программных модулях организующих эти задачи. Это усложняет поиск и планирование всей архитектуры проекта и может приводить к ошибкам. Поэтому в данном проекте все стеки и приоритеты объявлены в одном файле - <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/10bfaace89cd4c17b4f7a6a540b36ffbb9333475/Software/Azure_RTOS_Example1/App/App.h#L85" rel="noopener noreferrer nofollow"><u>App.h</u></a></p><h4>Дополнение управляющей структуры  RTOS полями с вспомогательными объектами.</h4><p>Azure RTOS предоставляет механизм дополнения управляющей структуры задач своими кастомными полями.  И кастомные поля в данном проекте понадобились для организации универсального многозадачного драйвера последовательного ввода-вывода. </p><p>Кастомные поля объявляются в файле <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/ThreadX/tx_user.h" rel="noopener noreferrer nofollow"><u>tx_user.h</u></a> в макросе <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/10bfaace89cd4c17b4f7a6a540b36ffbb9333475/Software/Azure_RTOS_Example1/ThreadX/tx_user.h#L275" rel="noopener noreferrer nofollow"><u>TX_THREAD_USER_EXTENSION</u></a> .  </p><p>#define TX_THREAD_USER_EXTENSION                ULONG environment; ULONG driver;</p><p>Переменная <strong><em>environment</em></strong> используется для передаче в управляющую структуру задачи указателя на другие управляющие структуры связанные с функционированием приложения, например управляющую структуру сервера VT100, который может присутствовать в виде отдельного экземпляра в нескольких задачах.  Переменная <strong><em>driver</em></strong>  используется для передачи указателя на <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/77a3fa1454859252611b4f45fac7cecfc1408622/Software/Azure_RTOS_Example1/App/Serial_driver.h#L30" rel="noopener noreferrer nofollow"><u>API универсального драйвера последовательного ввода-вывода</u></a>.  </p><p><strong>Важно!</strong></p><p>Для обеспечения работы с контроллером SD карты через его встроенный IDMA было отключено кэширование RAM.</p><h3>Подключение на один USB порт интерфейсов Mass Storage, Virtual COM и RNDIS.</h3><p>Стандартные драйвера сопровождающие примеры из STM32CubeMX были значительно отрефакторены и очищены от некоторых зависимостей и макросов.<em>  </em></p><h4>Важные изменения в исходном коде для правильной организации интерфейсов.</h4><ol><li><p><em> Чтобы стек USB мог организовать 3-и независимых устройства на одном USB порте  нужно переопределить макрос в файле </em><strong><em>ux_port.h</em></strong><em>: <br/>#define UX_MAX_SLAVE_CLASS_DRIVER                           3</em></p></li><li><p><em>В файле </em><a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/App/USB/USB_descriptors_builder.h" rel="noopener noreferrer nofollow"><em><u>USB_descriptors_builder.h</u></em></a><em> назначаем желаемые </em><a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/77a3fa1454859252611b4f45fac7cecfc1408622/Software/Azure_RTOS_Example1/App/USB/USB_descriptors_builder.h#L219" rel="noopener noreferrer nofollow"><em><u>VID и PID</u></em></a><em> устройства и строковые дескрипторы.</em></p></li><li><p><em>Назначаем адреса конечных точек всех интерфейсов. Адреса у всех точек должны быть уникальными и быть в диапазоне от 1 до 8 (без учета старшего бита направления) . Не имеет значение как будут распределены адреса: последовательно или хаотично.</em></p></li><li><p><em>Объявляем массив интерфейсов  </em><a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/77a3fa1454859252611b4f45fac7cecfc1408622/Software/Azure_RTOS_Example1/App/USB/USB_descriptors_builder.c#L5" rel="noopener noreferrer nofollow"><em><u>UserClassInstance</u></em></a><em> в файле </em><a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/App/USB/USB_descriptors_builder.c" rel="noopener noreferrer nofollow"><em><u>USB_descriptors_builder.c</u></em></a><em>. Здесь следует оставить порядок такой какой выполнен в файле. Перенос интерфейса CLASS_TYPE_MSC в начало массива может вызвать неработоспособность композитного устройства. </em></p></li><li><p><em>Основная работа по конструированию дескрипторов находится в функции </em><a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/77a3fa1454859252611b4f45fac7cecfc1408622/Software/Azure_RTOS_Example1/App/USB/USB_descriptors_builder.c#L329" rel="noopener noreferrer nofollow"><em><u>USBD_FrameWork_AddToConfDesc</u></em></a><em>. Она рефакторится по необходимости для включения тех или иных интерфейсов.</em></p></li><li><p><em>Непосредственно инициализация и запуск стека и интерфейса USB находится в функции  </em><a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/77a3fa1454859252611b4f45fac7cecfc1408622/Software/Azure_RTOS_Example1/App/USB/USB_device_init.c#L22" rel="noopener noreferrer nofollow"><em><u>App_USBX_Device_Init</u></em></a><em>.    </em></p></li><li><p><em>В файле  </em><a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/App/USB/usb_descriptor_examples.txt" rel="noopener noreferrer nofollow"><em><u>usb_descriptor_examples.txt</u></em></a><em> находятся примеры дескрипторов композитных устройств (Samsung S8 RNDIS descriptor in USB tethering mode и Beaglebone Board) на случай появления проблем дескрипторов и совместимости с PC.   </em></p></li></ol><p><strong>Чем RNDIS лучше виртуального COM порта (VCOM).<em> </em></strong></p><p>При подключении через VCOM порт пользователю приходится самому искать и настраивать номер порта в клиентских программах на PC. Это несколько утомительно учитывая эффект периодического изменения номеров VCOM портов устройств при переподключении USB в разные разъемы. </p><p>В случае  RNDIS сетевое соединение на PC устанавливается автоматически.  Клиентским программам  достаточно только слушать заданный TCP порт.   Вторым преимуществом является то, что устройство способно установить соединение с любым удаленным компьютером в сети, а не только с локальным к которому оно физически подключено.  </p><p>Если VCOM дает удобную  возможность работать с устройством через терминальные программы, то RNDIS предоставляет такую же возможность, только в терминальных программах надо выбрать подключение через Telnet. И тут проявляется удобство стабильности IP адреса в противовес меняющемуся номеру порта у VCOM. </p><p>В дальнейшем проект будет дополняться WEB и FTP серверами через RNDIS. FTP сервер может как дублировать функции Mass Storage так и предоставлять доступ к нестандартной файловой системе реализованной на внутренней Flash микроконтроллера, чего не может сделать Mass Storage.</p><h4>Настройки RNDIS в контроллере.</h4><p>MAC адреса интерфейса контроллера и клиента  задаются в функции <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/33c382a232152552032652e9e37e6e2e415525a9/Software/Azure_RTOS_Example1/App/USB/USB_RNDIS_driver.c#L85" rel="noopener noreferrer nofollow"><u>Register_rndis_class</u></a></p><p>Контроллер может работать в двух режимах назначения IP адресов. Режим устанавливается в параметрах переменной wvar.rndis_config.</p><p>Если переменной назначено значение RNDIS_CONFIG_PRECONFIGURED_DHCP_SERVER, то контроллер на старте включает DHCP сервер и назначает себе IP адрес 192.168.3.1, а клиенту (компьютеру, планшету, смартфону...) адрес 192.168.3.2.</p><p>Если переменной назначено значение RNDIS_CONFIG_WINDOWS_HOME_NETWORK, то контроллер назначает себе IP адрес 192.168.137.2, а клиенту адрес 192.168.137.1. DHCP сервер в этом случае не включается. Этот режим позволяет контроллеру через технологию Windows  Internet Connection Sharing <strong>выходить в интернет</strong> посредством подключенного компьютера. </p><p>Назначение IP адресов происходит в функции <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/33c382a232152552032652e9e37e6e2e415525a9/Software/Azure_RTOS_Example1/App/USB/USB_RNDIS_driver.c#L121" rel="noopener noreferrer nofollow"><u>_RNDIS_get_IP_proprties</u></a></p><p><strong>Почему все же реализован один VCOM?</strong></p><p>Потому что он нужен для работы протокола FreeMaster. О том что такое и чем удобен FreeMaster рассказано <a href="https://habr.com/ru/post/574088/" rel="noopener noreferrer nofollow"><u>здесь</u></a>.</p><h3>Универсальный драйвер последовательного ввода-вывода</h3><p>В малых RTOS типа Azure RTOS ThreadX нет концепции драйверов принятой в OS общего назначения типа Windows. Понятие драйвер здесь применено в том смысле что это некое программное обеспечение для доступа операционной системы к периферии. Скажем есть в операционной системе необходимость доступа к абстрактному носителю и  есть конкретный носитель. Но чтобы носитель выполнял команды и указания из абстрактного интерфейса системы нужен драйвер  переводящий эти указания в правильные числовые коды и протоколы взаимодействия. Сменой драйвера можно легко вместо одного носителя представить системе другой на других физических принципах и система этого вполне может не заметить если не интересуется этим специально. </p><p>В Azure RTOS ThreadX и других малых RTOS такого нет, поскольку сама система настолько мала что ей не требуется самой по себе ни носителей, ни сетевых стеков ни других сложных стеков сопряженных с периферией. Системный таймер да несколько специфических процедур переключения контекста, учитывающих организацию регистров и контроллера прерываний, - вот все что RTOS нужно от периферии.    Но к Azure RTOS прилагается так называемое промежуточное программное обеспечение (middleware), которое включает файловую систему FileX, сетевой стек NetX Duo, графическую библиотеку GuiX, USB стек USBX и проч. Они являются частью пакета, но не являются неотъемлемой частью RTOS. Они имеют своё изолированное API и только пользуются некоторыми сервисами RTOS. У промежуточного программного обеспечения (ППО) Azure RTOS уже есть интерфейсы подключения драйверов, но у каждого компонента он специфичный и довольно плохо документированный. С  STM32CubeMX поставляются уже готовые драйверы для работы с SD/MMC картами памяти, с Ethernet и USB периферией, графическим контроллером. К остальной периферии предоставляются наборы  функций именуемые  HAL (hardware abstraction layer) and low-layer drivers, но не имеющие к RTOS никакого отношения. </p><p>Но вот среди всего этого нет драйвера абстрагирующего сервер VT100 или например движок  FreeMaster от среды передачи.  Если работаем с UART, то нужно делать вызовы HAL, если через USB, то нужно вызывать функции стека USBX, если через канал Telnet, то нужно привлекать функции NetX Duo. Таким образом появляется зависимость исходников прикладного уровня VT100 от  низкоуровневой периферии, которая на каждой аппаратной платформе разная. Для абстрагирования от периферии и конкретных коммуникационных стеков  и была создана мной спецификация универсального последовательного драйвера для Azure RTOS. Особенностью моей спецификации является то что она примитивна. Я просто решил что универсальному драйверу нужно только пять функций: инициализаци, деинициализация, отсылка буфера, отсылка форматированной строки, прием символа. Никаких специфических IOControl и проч. </p><p>Все какие нужны драйверу объявления сделаны в файле <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/App/Serial_driver.h" rel="noopener noreferrer nofollow"><u>Serial_driver.h</u></a></p><p>Управляющая структура драйвера выглядит вот так:</p><pre><code class="cpp">typedef struct
{
    const uint32_t   mark;                                          // Magic word. Идентифицирует блок как управляющую структуру драйвера  
    const int        driver_type;                                   // Идентификатор типа драйвера
    int              (_init)(void **pcbl, void pdrv);               // Инициализация
    int              (_send_buf)(const void buf, unsigned int len); // Отсылка буфера с данными
    int              (_wait_char)(unsigned char b,  int ticks);     // Ожидание символа. ticks - время ожидания выражается в тиках (если 0 то без ожидания)
    int              (_printf)(const char , ...);                   // Вывод форматированной строки
    int              (_deinit)(void **pcbl);                        // Деинициализация
    void              pdrvcbl;                                      // Указатель на управляющую структуру необходимую для работы драйвера
} T_serial_io_driver;</code></pre><p>А дальше программируется реализация драйверов для нужных интерфейсов.  Для Telnet драйвер реализован в файле <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/App/Network/Net_Telnet.c" rel="noopener noreferrer nofollow"><u>Net_Telnet.c</u></a>, для USB VCOM драйвер реализован в файле <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/App/USB/USB_CDC_driver.c" rel="noopener noreferrer nofollow"><u>USB_CDC_driver.c</u></a>. Для UART-а драйвера нет, поскольку на плате BACKPMAN v2.0 просто нет UART-а.</p><p>В задачу просто передаем указатель на драйвер, например в таком виде:</p><pre><code class="cpp">Task_VT100_create(Mnsdrv_get_usbfs_vcom0_driver(),0);</code></pre><p>B дальше задача располагая только знанием об API этого абстрактного драйвера вызывает его инициализацию и ведет обмен. Драйвера реализуются используя сервисы RTOS и потому однотипных задач может работать несколько одновременно. Например контроллер может одновременно поддерживать независимые сессии VT100 с локальным компьютером через USB и с удаленным компьютером через  Telnet. </p><p>На базе такого же драйвера организовано взаимодействие с движком <a href="https://www.nxp.com/design/software/development-software/freemaster-run-time-debugging-tool:FREEMASTER" rel="noopener noreferrer nofollow"><u>FreeMaster</u></a>.</p><p>И, как всегда, первое что мы делаем - это проверяем загрузку процессора при работающей RTOS. За измерение нагрузки процессора отвечает фоновая задача в файле  <a href="https://github.com/Indemsys/Backup-controller_BACKPMAN-v2.0/blob/main/Software/Azure_RTOS_Example1/App/IDLE_task.c" rel="noopener noreferrer nofollow"><u>IDLE_task.c</u></a></p><figure class="full-width "><img src="/img/image-loader.svg" height="523" data-src="https://habrastorage.org/getpro/habr/upload_files/138/83f/306/13883f3066a66f1ae91a35a2a72a743c.png" data-width="862"/><figcaption></figcaption></figure><p>Как видно при частоте системного тика 1000 Гц загрузка процессора не превышает 2.4%. Всплески же активности до 5% можно объяснить работой самого движка FreeMaster.Итак RTOS и отладочные коммуникации запущены. Работа над основной программой продолжается. </p></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BAzure%20RTOS%5D" class="tm-tags-list__link">Azure RTOS</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BThreadX%5D" class="tm-tags-list__link">ThreadX</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BUSB%20RNDIS%5D" class="tm-tags-list__link">USB RNDIS</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BVCOM%5D" class="tm-tags-list__link">VCOM</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bvt100%5D" class="tm-tags-list__link">vt100</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BSTM32H753%5D" class="tm-tags-list__link">STM32H753</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B5%20%D0%BF%D0%B8%D1%82%D0%B0%D0%BD%D0%B8%D0%B5%5D" class="tm-tags-list__link">резервное питание</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/open_source/" class="tm-hubs-list__link">
    Open source
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/controllers/" class="tm-hubs-list__link">
    Программирование микроконтроллеров
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/electronics/" class="tm-hubs-list__link">
    Производство и разработка электроники
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/DIY/" class="tm-hubs-list__link">
    DIY или Сделай сам
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/easyelectronics/" class="tm-hubs-list__link">
    Электроника для начинающих
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 12: ↑11 и ↓1</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 12: ↑11 и ↓1" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+10</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">1.8K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    27
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/Indemsys/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_blue"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 79 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    60.7
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">18</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><!----> <a href="/ru/users/Indemsys/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @Indemsys
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Пользователь</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/582742/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 9 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/582742/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/582742/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"582742":{"id":"582742","timePublished":"2021-10-11T10:14:37+00:00","isCorporative":false,"lang":"ru","titleHtml":"Развертывание Azure RTOS и USB стека на STM32H753","leadData":{"textHtml":"\u003Cp\u003EЗдесь разберем следующие темы:\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E•\u003C\u002Fstrong\u003E Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.\u003Cbr\u003E\u003Cbr\u003E\u003Cstrong\u003E• \u003C\u002Fstrong\u003EПодключение на один порт USB одновременно трех разных интерфейсов: Mass Storage, Virtual COM, RNDIS&nbsp;\u003Cbr\u003E\u003Cbr\u003E\u003Cstrong\u003E• \u003C\u002Fstrong\u003EУниверсальный драйвер последовательного ввода-вывода способный работать через UART, USB,&nbsp; Telnet, FreeMaster и прочие каналы связи.&nbsp;\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb7e\u002F33a\u002F0f2\u002Fb7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb7e\u002F33a\u002F0f2\u002Fb7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png","fit":"cover","positionY":0,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[{"type":"tutorial","data":null}],"author":{"scoreStats":{"score":60.7,"votesCount":79},"rating":18,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"967248","alias":"Indemsys","fullname":null,"avatarUrl":null,"speciality":null},"statistics":{"commentsCount":9,"favoritesCount":27,"readingCount":1786,"score":10,"votesCount":12},"hubs":[{"relatedData":null,"id":"144","alias":"open_source","type":"collective","title":"Open source","titleHtml":"Open source","isProfiled":true},{"relatedData":null,"id":"19737","alias":"controllers","type":"collective","title":"Программирование микроконтроллеров","titleHtml":"Программирование микроконтроллеров","isProfiled":true},{"relatedData":null,"id":"21484","alias":"electronics","type":"collective","title":"Производство и разработка электроники","titleHtml":"Производство и разработка электроники","isProfiled":true},{"relatedData":null,"id":"21976","alias":"DIY","type":"collective","title":"DIY или Сделай сам","titleHtml":"DIY или Сделай сам","isProfiled":false},{"relatedData":null,"id":"22016","alias":"easyelectronics","type":"collective","title":"Электроника для начинающих","titleHtml":"Электроника для начинающих","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"421\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb7e\u002F33a\u002F0f2\u002Fb7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png\" data-width=\"592\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЗдесь разберем следующие темы:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003EСпецифика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EПодключение на один порт USB одновременно трех разных интерфейсов: Mass Storage, Virtual COM, RNDIS \u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EУниверсальный драйвер последовательного ввода-вывода способный работать через UART, USB,  Telnet, FreeMaster и прочие каналы связи. \u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EРепозиторий проекта со схемами, исходными кодами проектов и статьями: \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\" rel=\"noopener noreferrer nofollow\"\u003Ehttps:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E\u003Cem\u003EКраткое содержание предыдущих статей\u003C\u002Fem\u003E\u003C\u002Fstrong\u003E:\u003C\u002Fp\u003E\u003Cp\u003EБыла \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F557242\u002F\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eразработана схема\u003C\u002Fu\u003E\u003C\u002Fa\u003E универсального контроллера резервного питания. Потом \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F562462\u002F\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eразработана плата\u003C\u002Fu\u003E\u003C\u002Fa\u003E. Затем начата \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F573352\u002F\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eразработка софта\u003C\u002Fu\u003E\u003C\u002Fa\u003E и после изготовления платы \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F574088\u002F\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eотладка\u003C\u002Fu\u003E\u003C\u002Fa\u003E. Затем кризис поставок микросхем нарушил планы и плата была \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F578940\u002F\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eпеределана под STM32H753\u003C\u002Fu\u003E\u003C\u002Fa\u003E и получила номер версии 2.0. \u003C\u002Fp\u003E\u003Cp\u003EИ вот снова перед нами не отлаженная плата и снова ставим на нее Azure RTOS. Для демонстрации этапа развертывания Azure RTOS был создан демо-проект\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Ftree\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003E Example1\u003C\u002Fu\u003E\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EПо началу  нам помог могучий инструмент  STM32CubeMX. Но по мере разработки программного проекта контроллера приходится все дальше отдаляться от архитектуры задаваемой при генерации исходников этим инструментом. Поэтому несмотря на то что файл Example1.ioc проекта STM32CubeMX  все еще находится в рабочей директории запускать генерацию из него нельзя. Он нужен только для того чтобы посмотреть в него и вспомнить настройки портов и тактирования, поскольку из содержимого исходников выяснить эти настройки довольно трудно.  \u003C\u002Fp\u003E\u003Ch3\u003EСпецифика конфигурации Azure RTOS на платформе BACKPMAN v2.0\u003C\u002Fh3\u003E\u003Cp\u003EСам базис приложения с Azure RTOS изначально был сгенерирован с помощью STM32CubeMX. Но затем была мной сильно изменена структура директорий поскольку совсем не понравилось как выполнена структура и именование директорий после STM32CubeMX. Далее было обнаружено что даже самый последний апгрейд STM32CubeMX не содержит самую последнюю версию Azure RTOS и дальше уже апгрейды Azure RTOS приходится делать вручную. \u003C\u002Fp\u003E\u003Cp\u003ESTM32CubeMX освободил от многих нюансов портирования RTOS, но некоторые моменты в файле  \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002FThreadX\u002Ftx_initialize_low_level.s\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Etx_initialize_low_level.s\u003C\u002Fu\u003E\u003C\u002Fa\u003E\u003Cem\u003E \u003C\u002Fem\u003Eвсе же пришлось изменить - это объявление \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F0a3a2a708e4389397eafa4df7d33977634cbb146\u002FSoftware\u002FAzure_RTOS_Example1\u002FThreadX\u002Ftx_initialize_low_level.s#L58\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eсистемного тика\u003C\u002Fu\u003E\u003C\u002Fa\u003E , объявление \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F0a3a2a708e4389397eafa4df7d33977634cbb146\u002FSoftware\u002FAzure_RTOS_Example1\u002FThreadX\u002Ftx_initialize_low_level.s#L60\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eначала свободной памяти\u003C\u002Fu\u003E\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F0a3a2a708e4389397eafa4df7d33977634cbb146\u002FSoftware\u002FAzure_RTOS_Example1\u002FThreadX\u002Ftx_initialize_low_level.s#L154\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eустановка приоритетов\u003C\u002Fu\u003E\u003C\u002Fa\u003E системных прерываний.  \u003C\u002Fp\u003E\u003Ch4\u003EВыделение динамической памяти через файл линкера и стартовую процедуру RTOS\u003C\u002Fh4\u003E\u003Cp\u003EПамять в микроконтроллере сильно фрагментирована. Поэтому для динамической памяти выбираем наиболее универсальную и наибольшую область памяти - AXI SRAM. \u003C\u002Fp\u003E\u003Cp\u003EВ файле \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002Fstm32h753xx_example1.icf\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Estm32h753xx_example1.icf\u003C\u002Fu\u003E\u003C\u002Fa\u003E объявляем в этой области секцию \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F10bfaace89cd4c17b4f7a6a540b36ffbb9333475\u002FSoftware\u002FAzure_RTOS_Example1\u002Fstm32h753xx_example1.icf#L48\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003EFREE_MEM\u003C\u002Fu\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003EДалее в исходниках RTOS в файле \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002FThreadX\u002Ftx_initialize_low_level.s\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Etx_initialize_low_level.s\u003C\u002Fu\u003E\u003C\u002Fa\u003E присутствует размещение переменной \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F10bfaace89cd4c17b4f7a6a540b36ffbb9333475\u002FSoftware\u002FAzure_RTOS_Example1\u002FThreadX\u002Ftx_initialize_low_level.s#L61\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003E_tx_free_memory_start\u003C\u002Fu\u003E\u003C\u002Fa\u003E  в секции \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F10bfaace89cd4c17b4f7a6a540b36ffbb9333475\u002FSoftware\u002FAzure_RTOS_Example1\u002FThreadX\u002Ftx_initialize_low_level.s#L59\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003EFREE_MEM\u003C\u002Fu\u003E\u003C\u002Fa\u003E. Адрес этой переменной передается в виде аргумента в функцию \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F10bfaace89cd4c17b4f7a6a540b36ffbb9333475\u002FSoftware\u002FAzure_RTOS_Example1\u002FThreadX\u002Fsrc\u002Ftx_initialize_kernel_enter.c#L132\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Etx_application_define\u003C\u002Fu\u003E\u003C\u002Fa\u003E.  И уже в \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F10bfaace89cd4c17b4f7a6a540b36ffbb9333475\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FMain.c#L51\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eреализации этой\u003C\u002Fu\u003E\u003C\u002Fa\u003E функции наше демо-приложение получает адрес для \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F10bfaace89cd4c17b4f7a6a540b36ffbb9333475\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FMain.c#L53\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eорганизации\u003C\u002Fu\u003E\u003C\u002Fa\u003E байтового \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F10bfaace89cd4c17b4f7a6a540b36ffbb9333475\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FMem_man.c#L22\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eпула динамической памяти\u003C\u002Fu\u003E\u003C\u002Fa\u003E.   Размер пула определяется границей области AXI SRAM -    \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F10bfaace89cd4c17b4f7a6a540b36ffbb9333475\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FApp.h#L58\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003EAXI_SRAM_END\u003C\u002Fu\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Ch4\u003EУправление размерами стеков и приоритетами задач\u003C\u002Fh4\u003E\u003Cp\u003EЧасто встречается когда размеры стеков и приоритеты задач устанавливаются непосредственно в программных модулях организующих эти задачи. Это усложняет поиск и планирование всей архитектуры проекта и может приводить к ошибкам. Поэтому в данном проекте все стеки и приоритеты объявлены в одном файле - \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F10bfaace89cd4c17b4f7a6a540b36ffbb9333475\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FApp.h#L85\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003EApp.h\u003C\u002Fu\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Ch4\u003EДополнение управляющей структуры  RTOS полями с вспомогательными объектами.\u003C\u002Fh4\u003E\u003Cp\u003EAzure RTOS предоставляет механизм дополнения управляющей структуры задач своими кастомными полями.  И кастомные поля в данном проекте понадобились для организации универсального многозадачного драйвера последовательного ввода-вывода. \u003C\u002Fp\u003E\u003Cp\u003EКастомные поля объявляются в файле \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002FThreadX\u002Ftx_user.h\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Etx_user.h\u003C\u002Fu\u003E\u003C\u002Fa\u003E в макросе \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F10bfaace89cd4c17b4f7a6a540b36ffbb9333475\u002FSoftware\u002FAzure_RTOS_Example1\u002FThreadX\u002Ftx_user.h#L275\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003ETX_THREAD_USER_EXTENSION\u003C\u002Fu\u003E\u003C\u002Fa\u003E .  \u003C\u002Fp\u003E\u003Cp\u003E#define TX_THREAD_USER_EXTENSION                ULONG environment; ULONG driver;\u003C\u002Fp\u003E\u003Cp\u003EПеременная \u003Cstrong\u003E\u003Cem\u003Eenvironment\u003C\u002Fem\u003E\u003C\u002Fstrong\u003E используется для передаче в управляющую структуру задачи указателя на другие управляющие структуры связанные с функционированием приложения, например управляющую структуру сервера VT100, который может присутствовать в виде отдельного экземпляра в нескольких задачах.  Переменная \u003Cstrong\u003E\u003Cem\u003Edriver\u003C\u002Fem\u003E\u003C\u002Fstrong\u003E  используется для передачи указателя на \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F77a3fa1454859252611b4f45fac7cecfc1408622\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FSerial_driver.h#L30\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003EAPI универсального драйвера последовательного ввода-вывода\u003C\u002Fu\u003E\u003C\u002Fa\u003E.  \u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EВажно!\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EДля обеспечения работы с контроллером SD карты через его встроенный IDMA было отключено кэширование RAM.\u003C\u002Fp\u003E\u003Ch3\u003EПодключение на один USB порт интерфейсов Mass Storage, Virtual COM и RNDIS.\u003C\u002Fh3\u003E\u003Cp\u003EСтандартные драйвера сопровождающие примеры из STM32CubeMX были значительно отрефакторены и очищены от некоторых зависимостей и макросов.\u003Cem\u003E  \u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Ch4\u003EВажные изменения в исходном коде для правильной организации интерфейсов.\u003C\u002Fh4\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003E\u003Cem\u003E Чтобы стек USB мог организовать 3-и независимых устройства на одном USB порте  нужно переопределить макрос в файле \u003C\u002Fem\u003E\u003Cstrong\u003E\u003Cem\u003Eux_port.h\u003C\u002Fem\u003E\u003C\u002Fstrong\u003E\u003Cem\u003E: \u003Cbr\u002F\u003E#define UX_MAX_SLAVE_CLASS_DRIVER                           3\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cem\u003EВ файле \u003C\u002Fem\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FUSB\u002FUSB_descriptors_builder.h\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003E\u003Cu\u003EUSB_descriptors_builder.h\u003C\u002Fu\u003E\u003C\u002Fem\u003E\u003C\u002Fa\u003E\u003Cem\u003E назначаем желаемые \u003C\u002Fem\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F77a3fa1454859252611b4f45fac7cecfc1408622\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FUSB\u002FUSB_descriptors_builder.h#L219\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003E\u003Cu\u003EVID и PID\u003C\u002Fu\u003E\u003C\u002Fem\u003E\u003C\u002Fa\u003E\u003Cem\u003E устройства и строковые дескрипторы.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cem\u003EНазначаем адреса конечных точек всех интерфейсов. Адреса у всех точек должны быть уникальными и быть в диапазоне от 1 до 8 (без учета старшего бита направления) . Не имеет значение как будут распределены адреса: последовательно или хаотично.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cem\u003EОбъявляем массив интерфейсов  \u003C\u002Fem\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F77a3fa1454859252611b4f45fac7cecfc1408622\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FUSB\u002FUSB_descriptors_builder.c#L5\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003E\u003Cu\u003EUserClassInstance\u003C\u002Fu\u003E\u003C\u002Fem\u003E\u003C\u002Fa\u003E\u003Cem\u003E в файле \u003C\u002Fem\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FUSB\u002FUSB_descriptors_builder.c\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003E\u003Cu\u003EUSB_descriptors_builder.c\u003C\u002Fu\u003E\u003C\u002Fem\u003E\u003C\u002Fa\u003E\u003Cem\u003E. Здесь следует оставить порядок такой какой выполнен в файле. Перенос интерфейса CLASS_TYPE_MSC в начало массива может вызвать неработоспособность композитного устройства. \u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cem\u003EОсновная работа по конструированию дескрипторов находится в функции \u003C\u002Fem\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F77a3fa1454859252611b4f45fac7cecfc1408622\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FUSB\u002FUSB_descriptors_builder.c#L329\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003E\u003Cu\u003EUSBD_FrameWork_AddToConfDesc\u003C\u002Fu\u003E\u003C\u002Fem\u003E\u003C\u002Fa\u003E\u003Cem\u003E. Она рефакторится по необходимости для включения тех или иных интерфейсов.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cem\u003EНепосредственно инициализация и запуск стека и интерфейса USB находится в функции  \u003C\u002Fem\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F77a3fa1454859252611b4f45fac7cecfc1408622\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FUSB\u002FUSB_device_init.c#L22\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003E\u003Cu\u003EApp_USBX_Device_Init\u003C\u002Fu\u003E\u003C\u002Fem\u003E\u003C\u002Fa\u003E\u003Cem\u003E.    \u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cem\u003EВ файле  \u003C\u002Fem\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FUSB\u002Fusb_descriptor_examples.txt\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003E\u003Cu\u003Eusb_descriptor_examples.txt\u003C\u002Fu\u003E\u003C\u002Fem\u003E\u003C\u002Fa\u003E\u003Cem\u003E находятся примеры дескрипторов композитных устройств (Samsung S8 RNDIS descriptor in USB tethering mode и Beaglebone Board) на случай появления проблем дескрипторов и совместимости с PC.   \u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003E\u003Cstrong\u003EЧем RNDIS лучше виртуального COM порта (VCOM).\u003Cem\u003E \u003C\u002Fem\u003E\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EПри подключении через VCOM порт пользователю приходится самому искать и настраивать номер порта в клиентских программах на PC. Это несколько утомительно учитывая эффект периодического изменения номеров VCOM портов устройств при переподключении USB в разные разъемы. \u003C\u002Fp\u003E\u003Cp\u003EВ случае  RNDIS сетевое соединение на PC устанавливается автоматически.  Клиентским программам  достаточно только слушать заданный TCP порт.   Вторым преимуществом является то, что устройство способно установить соединение с любым удаленным компьютером в сети, а не только с локальным к которому оно физически подключено.  \u003C\u002Fp\u003E\u003Cp\u003EЕсли VCOM дает удобную  возможность работать с устройством через терминальные программы, то RNDIS предоставляет такую же возможность, только в терминальных программах надо выбрать подключение через Telnet. И тут проявляется удобство стабильности IP адреса в противовес меняющемуся номеру порта у VCOM. \u003C\u002Fp\u003E\u003Cp\u003EВ дальнейшем проект будет дополняться WEB и FTP серверами через RNDIS. FTP сервер может как дублировать функции Mass Storage так и предоставлять доступ к нестандартной файловой системе реализованной на внутренней Flash микроконтроллера, чего не может сделать Mass Storage.\u003C\u002Fp\u003E\u003Ch4\u003EНастройки RNDIS в контроллере.\u003C\u002Fh4\u003E\u003Cp\u003EMAC адреса интерфейса контроллера и клиента  задаются в функции \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F33c382a232152552032652e9e37e6e2e415525a9\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FUSB\u002FUSB_RNDIS_driver.c#L85\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003ERegister_rndis_class\u003C\u002Fu\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003EКонтроллер может работать в двух режимах назначения IP адресов. Режим устанавливается в параметрах переменной wvar.rndis_config.\u003C\u002Fp\u003E\u003Cp\u003EЕсли переменной назначено значение RNDIS_CONFIG_PRECONFIGURED_DHCP_SERVER, то контроллер на старте включает DHCP сервер и назначает себе IP адрес 192.168.3.1, а клиенту (компьютеру, планшету, смартфону...) адрес 192.168.3.2.\u003C\u002Fp\u003E\u003Cp\u003EЕсли переменной назначено значение RNDIS_CONFIG_WINDOWS_HOME_NETWORK, то контроллер назначает себе IP адрес 192.168.137.2, а клиенту адрес 192.168.137.1. DHCP сервер в этом случае не включается. Этот режим позволяет контроллеру через технологию Windows  Internet Connection Sharing \u003Cstrong\u003Eвыходить в интернет\u003C\u002Fstrong\u003E посредством подключенного компьютера. \u003C\u002Fp\u003E\u003Cp\u003EНазначение IP адресов происходит в функции \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002F33c382a232152552032652e9e37e6e2e415525a9\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FUSB\u002FUSB_RNDIS_driver.c#L121\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003E_RNDIS_get_IP_proprties\u003C\u002Fu\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EПочему все же реализован один VCOM?\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EПотому что он нужен для работы протокола FreeMaster. О том что такое и чем удобен FreeMaster рассказано \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F574088\u002F\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003Eздесь\u003C\u002Fu\u003E\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Ch3\u003EУниверсальный драйвер последовательного ввода-вывода\u003C\u002Fh3\u003E\u003Cp\u003EВ малых RTOS типа Azure RTOS ThreadX нет концепции драйверов принятой в OS общего назначения типа Windows. Понятие драйвер здесь применено в том смысле что это некое программное обеспечение для доступа операционной системы к периферии. Скажем есть в операционной системе необходимость доступа к абстрактному носителю и  есть конкретный носитель. Но чтобы носитель выполнял команды и указания из абстрактного интерфейса системы нужен драйвер  переводящий эти указания в правильные числовые коды и протоколы взаимодействия. Сменой драйвера можно легко вместо одного носителя представить системе другой на других физических принципах и система этого вполне может не заметить если не интересуется этим специально. \u003C\u002Fp\u003E\u003Cp\u003EВ Azure RTOS ThreadX и других малых RTOS такого нет, поскольку сама система настолько мала что ей не требуется самой по себе ни носителей, ни сетевых стеков ни других сложных стеков сопряженных с периферией. Системный таймер да несколько специфических процедур переключения контекста, учитывающих организацию регистров и контроллера прерываний, - вот все что RTOS нужно от периферии.    Но к Azure RTOS прилагается так называемое промежуточное программное обеспечение (middleware), которое включает файловую систему FileX, сетевой стек NetX Duo, графическую библиотеку GuiX, USB стек USBX и проч. Они являются частью пакета, но не являются неотъемлемой частью RTOS. Они имеют своё изолированное API и только пользуются некоторыми сервисами RTOS. У промежуточного программного обеспечения (ППО) Azure RTOS уже есть интерфейсы подключения драйверов, но у каждого компонента он специфичный и довольно плохо документированный. С  STM32CubeMX поставляются уже готовые драйверы для работы с SD\u002FMMC картами памяти, с Ethernet и USB периферией, графическим контроллером. К остальной периферии предоставляются наборы  функций именуемые  HAL (hardware abstraction layer) and low-layer drivers, но не имеющие к RTOS никакого отношения. \u003C\u002Fp\u003E\u003Cp\u003EНо вот среди всего этого нет драйвера абстрагирующего сервер VT100 или например движок  FreeMaster от среды передачи.  Если работаем с UART, то нужно делать вызовы HAL, если через USB, то нужно вызывать функции стека USBX, если через канал Telnet, то нужно привлекать функции NetX Duo. Таким образом появляется зависимость исходников прикладного уровня VT100 от  низкоуровневой периферии, которая на каждой аппаратной платформе разная. Для абстрагирования от периферии и конкретных коммуникационных стеков  и была создана мной спецификация универсального последовательного драйвера для Azure RTOS. Особенностью моей спецификации является то что она примитивна. Я просто решил что универсальному драйверу нужно только пять функций: инициализаци, деинициализация, отсылка буфера, отсылка форматированной строки, прием символа. Никаких специфических IOControl и проч. \u003C\u002Fp\u003E\u003Cp\u003EВсе какие нужны драйверу объявления сделаны в файле \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FSerial_driver.h\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003ESerial_driver.h\u003C\u002Fu\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003EУправляющая структура драйвера выглядит вот так:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Etypedef struct\n{\n    const uint32_t   mark;                                          \u002F\u002F Magic word. Идентифицирует блок как управляющую структуру драйвера  \n    const int        driver_type;                                   \u002F\u002F Идентификатор типа драйвера\n    int              (_init)(void **pcbl, void pdrv);               \u002F\u002F Инициализация\n    int              (_send_buf)(const void buf, unsigned int len); \u002F\u002F Отсылка буфера с данными\n    int              (_wait_char)(unsigned char b,  int ticks);     \u002F\u002F Ожидание символа. ticks - время ожидания выражается в тиках (если 0 то без ожидания)\n    int              (_printf)(const char , ...);                   \u002F\u002F Вывод форматированной строки\n    int              (_deinit)(void **pcbl);                        \u002F\u002F Деинициализация\n    void              pdrvcbl;                                      \u002F\u002F Указатель на управляющую структуру необходимую для работы драйвера\n} T_serial_io_driver;\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EА дальше программируется реализация драйверов для нужных интерфейсов.  Для Telnet драйвер реализован в файле \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FNetwork\u002FNet_Telnet.c\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003ENet_Telnet.c\u003C\u002Fu\u003E\u003C\u002Fa\u003E, для USB VCOM драйвер реализован в файле \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FUSB\u002FUSB_CDC_driver.c\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003EUSB_CDC_driver.c\u003C\u002Fu\u003E\u003C\u002Fa\u003E. Для UART-а драйвера нет, поскольку на плате BACKPMAN v2.0 просто нет UART-а.\u003C\u002Fp\u003E\u003Cp\u003EВ задачу просто передаем указатель на драйвер, например в таком виде:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003ETask_VT100_create(Mnsdrv_get_usbfs_vcom0_driver(),0);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EB дальше задача располагая только знанием об API этого абстрактного драйвера вызывает его инициализацию и ведет обмен. Драйвера реализуются используя сервисы RTOS и потому однотипных задач может работать несколько одновременно. Например контроллер может одновременно поддерживать независимые сессии VT100 с локальным компьютером через USB и с удаленным компьютером через  Telnet. \u003C\u002Fp\u003E\u003Cp\u003EНа базе такого же драйвера организовано взаимодействие с движком \u003Ca href=\"https:\u002F\u002Fwww.nxp.com\u002Fdesign\u002Fsoftware\u002Fdevelopment-software\u002Ffreemaster-run-time-debugging-tool:FREEMASTER\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003EFreeMaster\u003C\u002Fu\u003E\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EИ, как всегда, первое что мы делаем - это проверяем загрузку процессора при работающей RTOS. За измерение нагрузки процессора отвечает фоновая задача в файле  \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FIndemsys\u002FBackup-controller_BACKPMAN-v2.0\u002Fblob\u002Fmain\u002FSoftware\u002FAzure_RTOS_Example1\u002FApp\u002FIDLE_task.c\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cu\u003EIDLE_task.c\u003C\u002Fu\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"523\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F138\u002F83f\u002F306\u002F13883f3066a66f1ae91a35a2a72a743c.png\" data-width=\"862\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак видно при частоте системного тика 1000 Гц загрузка процессора не превышает 2.4%. Всплески же активности до 5% можно объяснить работой самого движка FreeMaster.Итак RTOS и отладочные коммуникации запущены. Работа над основной программой продолжается. \u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"Azure RTOS"},{"titleHtml":"ThreadX"},{"titleHtml":"USB RNDIS"},{"titleHtml":"VCOM"},{"titleHtml":"vt100"},{"titleHtml":"STM32H753"},{"titleHtml":"резервное питание"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb7e\u002F33a\u002F0f2\u002Fb7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb7e\u002F33a\u002F0f2\u002Fb7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F582742\\\u002F\"},\"headline\":\"Развертывание Azure RTOS и USB стека на STM32H753\",\"datePublished\":\"2021-10-11T13:14:37+03:00\",\"dateModified\":\"2021-10-11T13:52:01+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Indemsys\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Здесь разберем следующие темы:Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.Подключение на один порт USB одновременн...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F582742\\\u002F#post-content-body\",\"about\":[\"h_open_source\",\"h_controllers\",\"h_electronics\",\"h_DIY\",\"h_easyelectronics\",\"f_develop\",\"f_popsci\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F582742\\\u002F1a6f127220729c5c14258e7d7366286a\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fb7e\\\u002F33a\\\u002F0f2\\\u002Fb7e33a0f2efbd4a8a14bb4ae3ab4ba3a.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F138\\\u002F83f\\\u002F306\\\u002F13883f3066a66f1ae91a35a2a72a743c.png\"]}","metaDescription":"Здесь разберем следующие темы:Специфика конфигурации Azure RTOS на платформе BACKPMAN v2.0 с микроконтроллером STM32H753.Подключение на один порт USB одновременно трех разных интерфейсов: Mass...","mainImageUrl":null,"amp":true},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"open_source,controllers,electronics,DIY,easyelectronics"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
