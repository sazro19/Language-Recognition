<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Создание и использование динамических библиотек в Rust / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/company\/otus\/blog\/584248\/"},"headline":"Создание и использование динамических библиотек в Rust","datePublished":"2021-10-21T18:22:40+03:00","dateModified":"2021-10-22T01:56:08+03:00","author":{"@type":"Person","name":"Федченко Кирилл"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Иногда, при разработке возникает необходимость в стыковке кода на разных языках программирования. Или в динамической загрузке, выгрузке и замене разных частей пр...","url":"https:\/\/habr.com\/ru\/company\/otus\/blog\/584248\/#post-content-body","about":["c_otus","h_system_programming","h_rust","f_develop"],"image":["https:\/\/habr.com\/share\/publication\/584248\/006b19875bedfab14c65424c3001d28c\/","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/eaf\/a41\/17d\/eafa4117d812895a1cf9ae274554716f.jpg"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Создание и использование динамических библиотек в Rust" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Создание и использование динамических библиотек в Rust" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Создание и использование динамических библиотек в Rust" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Иногда, при разработке возникает необходимость в стыковке кода на разных языках программирования. Или в динамической загрузке, выгрузке и замене разных частей программы в процессе её выполнения...." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Иногда, при разработке возникает необходимость в стыковке кода на разных языках программирования. Или в динамической загрузке, выгрузке и замене разных частей программы в процессе её выполнения...." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Иногда, при разработке возникает необходимость в стыковке кода на разных языках программирования. Или в динамической загрузке, выгрузке и замене разных частей программы в процессе её выполнения...." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Иногда, при разработке возникает необходимость в стыковке кода на разных языках программирования. Или в динамической загрузке, выгрузке и замене разных частей программы в процессе её выполнения...." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Иногда, при разработке возникает необходимость в стыковке кода на разных языках программирования. Или в динамической загрузке, выгрузке и замене разных частей программы в процессе её выполнения...." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habrastorage.org/getpro/habr/upload_files/8e8/da9/499/8e8da94991532ebd9a665ae52f71cd6c.jpg" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/8e8/da9/499/8e8da94991532ebd9a665ae52f71cd6c.jpg" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/8e8/da9/499/8e8da94991532ebd9a665ae52f71cd6c.jpg" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/8e8/da9/499/8e8da94991532ebd9a665ae52f71cd6c.jpg" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/8e8/da9/499/8e8da94991532ebd9a665ae52f71cd6c.jpg" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="584248" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-21T15:22:40.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/584248/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/company/otus/blog/584248/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habrastorage.org/getpro/habr/upload_files/8e8/da9/499/8e8da94991532ebd9a665ae52f71cd6c.jpg" data-vmid="image:href"><link data-vue-meta="ssr" rel="amphtml" href="https://habr.com/ru/amp/post/584248/">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" companyName="otus" data-async-called="true" class="tm-page"><div class="tm-page-width"><div class="tm-page__header"><!----></div> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"><div class="tm-company-card tm-company-article__company-card"><div class="tm-company-card__info"><div class="tm-company-card__header"><a href="/ru/company/otus/profile/" class="tm-company-card__avatar"><div class="tm-entity-image"><img alt="" height="48" src="//habrastorage.org/getpro/habr/company/968/422/761/968422761136a38a89fc391fd927f903.jpg" width="48" class="tm-entity-image__pic"></div></a> <!----> <div class="tm-rating tm-company-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">407.38</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div> <div class="tm-company-card__info"><a href="/ru/company/otus/profile/" class="tm-company-card__name">
        OTUS
      </a> <div class="tm-company-card__description">Цифровые навыки от ведущих экспертов</div></div></div> <div class="tm-company-card__buttons"><!----> <!----></div></div> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/F3kilo/" title="F3kilo" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_blue"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="/ru/users/F3kilo/" class="tm-user-info__username">
      F3kilo
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-21T15:22:40.000Z" title="2021-10-21, 18:22">21  октября   в 18:22</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Создание и использование динамических библиотек в Rust</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/company/otus/blog/" class="tm-article-snippet__hubs-item-link router-link-active"><span>Блог компании OTUS</span> <!----></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/system_programming/" class="tm-article-snippet__hubs-item-link"><span>Системное программирование</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/rust/" class="tm-article-snippet__hubs-item-link"><span>Rust</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><figure class="full-width "><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/eaf/a41/17d/eafa4117d812895a1cf9ae274554716f.jpg" width="780" height="439" data-src="https://habrastorage.org/getpro/habr/upload_files/eaf/a41/17d/eafa4117d812895a1cf9ae274554716f.jpg" data-blurred="true"/><figcaption></figcaption></figure><p>Иногда, при разработке возникает необходимость в стыковке кода на разных языках программирования. Или в динамической загрузке, выгрузке и замене разных частей программы в процессе её выполнения. Динамические библиотеки позволяют решить эти задачи. Их можно компилировать и обновлять независимо от использующих программ, при условии сохранения интерфейса. Такой подход открывает ряд дополнительных возможностей при разработке ПО. Например, написание разных модулей приложения на разных языках. Или создание системы динамически подключаемых плагинов. В данной статье мы (в теории и на примере) рассмотрим, как создавать и загружать динамические библиотеки в Rust.</p><h2>Содержание</h2><ol><li><p><a href="#dyn_lib">Динамические библиотеки</a></p></li><li><p><a href="#create_dyn_lib">Создание динамической библиотеки</a></p></li><li><p><a href="#load_dyn_lib">Подключение динамической библиотеки</a></p></li><li><p><a href="#example">Пример</a></p></li><li><p><a href="#summary">Заключение</a></p></li></ol><a class="anchor" name="dyn_lib" id="dyn_lib"></a><h2>Динамические библиотеки</h2><p>Для предоставления доступа к логике и данным программного кода, из которого скомпилирована библиотека, она экспортирует сущности, которые другие программы могут импортировать и использовать. Для того чтобы корректно пользоваться импортированной сущностью, нужно корректно интерпретировать её бинарное представление после импорта. Для этого динамические библиотеки, обычно, поставляются с описанием своего бинарного интерфейса (<a href="https://ru.wikipedia.org/wiki/%D0%94%D0%B2%D0%BE%D0%B8%D1%87%D0%BD%D1%8B%D0%B9_%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81_%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9">ABI</a>). Чаще всего, это описание представляется в виде программного кода, описывающего сигнатуры экспортируемых функций, соглашение о вызовах и используемые в интерфейсе типы данных.</p><p>Возникает вопрос: как использовать например, классы из С++ в программе на другом языке, у которого классы (или аналогичные им сущности) представляются в бинарном виде совершенно не так, как в С++? Во избежание подобных проблем, при создании динамической библиотеки, которая должна быть доступна другим языкам, принято использовать стандартный С ABI. Иными словами, динамическая библиотека должна экспортировать только те сущности, которые присутствуют в языке С. Большинство языков, поддерживающих работу с динамическими библиотеками поддерживают и примитивы из С. И Rust входит в их число.</p><a class="anchor" name="create_dyn_lib" id="create_dyn_lib"></a><h2>Создание динамической библиотеки</h2><p>Для создания динамической библиотеки c C ABI нужно, для начала, указать компилятору, что мы хотим в качестве выходного продукта иметь именно её. Для этого в файл <code>Cargo.toml</code> добавим следующее:</p><pre><code class="rust">[lib]
crate-type = ["cdylib"]</code></pre><p>Далее, чтобы экспортировать функцию из библиотеки, нужно пометить её ключевым словом <code>extern</code>:</p><pre><code class="rust">#[no_mangle]
pub extern "C" fn foo() -> u32 {...}</code></pre><p>Параметр "С" используется по умолчанию и его можно не указывать явно. Он означает, что при экспорте данной функции будет использован стандартный бинарный интерфейс С для целевой платформы компилятора. Другие варианты параметров экспорта функции можно посмотреть в <a href="https://doc.rust-lang.org/reference/items/external-blocks.html#abi">документации</a>.</p><p>Аттрибут <code>#[no_mangle]</code> сообщает компилятору, что имя функции не должно модифицироваться при компиляции.</p><p>Таким образом, при сборке проекта, в директории выходных файлов создаётся динамическая библиотека, экспортирующая символ <code>foo</code>. Теперь можно написать программу, которая:</p><ol><li><p>загрузит эту библиотеку,</p></li><li><p>импортирует из неё символ <code>foo</code>,</p></li><li><p>интерпретирует его как С функцию без аргументов, возвращающую 32-х битное беззнаковое целое число,</p></li><li><p>будет вызывать библиотечную функцию и пользоваться результатом. </p></li></ol><a class="anchor" name="load_dyn_lib" id="load_dyn_lib"></a><h2>Подключение динамической библиотеки</h2><p>Для подключения динамической библиотеки и импорта символов из неё, используются функции операционной системы. Чтобы добиться кроссплатформенности можно использовать абстракции построенные поверх системных вызовов. Наиболее популярный вариант такой абстракции для работы с динамическими библиотеками в Rust - крейт <a href="https://crates.io/crates/libloading">libloading</a>. Помимо загрузки библиотек и символов из них, этот крейт помогает избежать глупых ошибок. Например, использовать загруженный символ после того, как библиотека была выгружена.</p><p>Пример использования данной библиотеки из её документации:</p><pre><code class="rust">fn call_dynamic() -> Result&lt;u32, Box&lt;dyn std::error::Error>> {
    unsafe {
        let lib = libloading::Library::new("/path/to/lib/library.so")?;
        let func: libloading::Symbol&lt;unsafe extern fn() -> u32> = lib.get(b"my_func")?;
        Ok(func())
    }
}</code></pre><p>В данном примере мы загружаем библиотеку, расположенную по пути <code>/path/to/lib/library.so</code>. В случае успеха, мы импортируем символ с названием <code>my_func</code>, интерпретируя его как функцию с сигнатурой <code>unsafe extern fn () -> u32</code> и присваивая переменной <code>func</code>. Если данный символ существует и импортировался успешно, то возвращаем результат вызова <code>func</code>.</p><p>Загрузка библиотеки является <code>unsafe</code> операцией, так как при этом, в общем случае, вызываются функции инициализации, гарантия корректности которых возлагается на разработчика. Это относится и к деинициализации библиотеки.</p><p>Загрузка символа из библиотеки, также, не безопасна, так как компилятор не имеет возможности проверить корректность типа загружаемого символа. За корректность интерпретации бинарных данных загружаемого символа отвечает разработчик.</p><a class="anchor" name="example" id="example"></a><h2>Пример</h2><p>Для демонстрации использования описанных выше возможностей, рассмотрим небольшой <a href="https://github.com/F3kilo/image_sl">пример</a>. В данном примере крейт собирается как динамическая библиотека, а example использует её.</p><h3>Библиотека</h3><p>Крейт представляет собой библиотеку для работы с изображениями, построенную поверх крейта <a href="https://crates.io/crates/image">image</a>. Данная библиотека позволяет открывать и сохранять изображения, а также применять пару преобразований: размытие и зеркальное отражение.</p><p>Единственная функция, которую должен импортировать пользователь библиотеки выглядит так:</p><pre><code class="rust">/// Returns all functions of this library.
#[no_mangle]
pub extern "C" fn functions() -> FunctionsBlock {
    FunctionsBlock::default()
}</code></pre><p>Данная функция возвращает структуру <code>FunctionsBlock</code>, содержащую указатели на все полезные функции данной библиотеки.</p><pre><code class="rust">/// Contains functions provided by library. Allow to import just `functions()` function and get all
/// functionality of library through this struct.
/// `size` field contain size of this struct. It helps to avoid versioning and some other errors.
#[allow(unused)]
#[repr(C)]
pub struct FunctionsBlock {
    size: usize,
    open_image: OpenImageFn,
    save_image: SaveImageFn,
    destroy_image: DestroyImageFn,
    blur_image: BlurImageFn,
    mirror_image: MirrorImageFn,
}

impl Default for FunctionsBlock {
    fn default() -> Self {
        Self {
            size: std::mem::size_of::&lt;Self>(),
            open_image: img_open,
            save_image: img_save,
            destroy_image: img_destroy,
            blur_image: img_blur,
            mirror_image: img_mirror,
        }
    }
}</code></pre><p>Аттрибут <code>#[repr(С)]</code> сообщает компилятору, что данная структура должна быть бинарно-совместима с аналогичной структурой, определённой в С.</p><p>Такой подход позволяет клиентскому коду импортировать только одну функцию, а все остальные получить, как результат её вызова. Это снижает вероятность ошибки при вводе имени каждой функции. Поле <code>size</code> содержит размер структуры в байтах и используется для того, чтобы клиентский код мог удостовериться, что корректно интерпретирует тип структуры, а не пропустил поле, например.</p><p>Типы функций содержащихся в FunctionsBlock описываются следующим образом:</p><pre><code class="rust">/// Loads image from file function type.
type OpenImageFn = unsafe extern "C" fn(RawPath, *mut ImageHandle) -> ImageError;
/// Saves image to file function type.
type SaveImageFn = unsafe extern "C" fn(RawPath, ImageHandle) -> ImageError;
/// Destroys image function type.
type DestroyImageFn = unsafe extern "C" fn(ImageHandle);

/// Performs a Gaussian blur on the supplied image function type.
type BlurImageFn = unsafe extern "C" fn(ImageHandle, f32) -> ImageHandle;
/// Flips image horizontally function type.
type MirrorImageFn = unsafe extern "C" fn(ImageHandle);</code></pre><p>Ключевое слово <code>extern</code> необходимо, так как эти функции будут вызываться внешним клиентом. Поэтому они должны быть совместимы с С ABI. Компилятор Rust выдаст предупреждение при попытке использовать не совместимые с С типы в сигнатурах <code>extern</code> функций. </p><p>Реализации функций конвертируют C примитивы в объекты Rust и вызывают функции крейта <code>image</code>.</p><pre><code class="rust">/// # Safety
/// - `path` is valid pointer to null-terminated UTF-8 string.
/// - `handle` is valid image handle.
unsafe extern "C" fn img_save(path: RawPath, handle: ImageHandle) -> ImageError {
    if handle.0.is_null() || path.0.is_null() {
        return ImageError::Parameter;
    }

    let path: &amp;Path = match (&amp;path).try_into() {
        Ok(p) => p,
        Err(e) => return e,
    };

    let img = handle.as_image();
    match img.save(path) {
        Ok(_) => ImageError::NoError,
        Err(e) => e.into(),
    }
}

/// Destroys image created by this library.
unsafe extern "C" fn img_destroy(handle: ImageHandle) {
    handle.into_image();
}

/// Blurs image with `sigma` blur radius. Returns new image.
unsafe extern "C" fn img_blur(handle: ImageHandle, sigma: f32) -> ImageHandle {
    let image = handle.as_image();
    let buffer = image::imageops::blur(image, sigma);
    let blurred = image::DynamicImage::ImageRgba8(buffer);
    ImageHandle::from_image(blurred)
}

/// Flip image horizontally in place.
unsafe extern "C" fn img_mirror(handle: ImageHandle) {
    let image_ref = handle.as_image();
    image::imageops::flip_horizontal_in_place(image_ref);
}</code></pre><p><code>ImageHandle</code> и <code>RawPath</code> - это небольшие обёртки для С-совместимых типов. Эти обёртки позволяют использовать ассоциированные функции и реализовывать трейты. Подробнее: <a href="https://rust-unofficial.github.io/patterns/patterns/behavioural/newtype.html">newtype pattern</a>. <code>ImageHandle</code> содержит указатель на объект типа <code>DynamicImage</code> из крейта image. <code>RawPath</code> содержит указатель на С строку.</p><pre><code class="rust">/// Incapsulate raw pointer to image.
#[repr(transparent)]
struct ImageHandle(*mut c_void);</code></pre><pre><code class="rust">/// Contain pointer to null-terminated UTF-8 path.
#[repr(transparent)]
struct RawPath(*const c_char);</code></pre><p>Аттрибут <code>#[repr(transparent)]</code> сообщает компилятору, что структура должна быть представлена в бинарном виде также, как и её поле.</p><p>Работа с С строками не безопасна, поэтому мы полагаемся на то, что в качестве путей клиентский код будет передавать нам корректные <em>null-terminated</em> С строки в UTF-8 кодировке.</p><p>Коды ошибок представлены в виде нумерованного перечисления:</p><pre><code class="rust">/// Error codes for image oprerations.
#[repr(u32)]
#[derive(Debug)]
enum ImageError {
    NoError = 0,
    Io,
    Decoding,
    Encoding,
    Parameter,
    Unsupported,
}</code></pre><p>Аттрибут <code>#[repr(u32)]</code> сообщает компилятору, что значения перечисления представляется в памяти, как 32-х битные беззнаковые целые числа.</p><h3>Использование библиотеки</h3><p>Приложение, использующее библиотеку, представлено в данном проекте в виде example-а <code>use_lib</code>.</p><p>Модуль <code>bindings</code> повторяет определения типов данных из библиотеки, что позволяет правильно интерпретировать загруженные бинарные данные. Также, в нем находится функция, возвращающую путь к библиотеке. Эта функция возвращает разные значения для разных операционных систем. Это достигается за счёт условной компиляции.</p><pre><code class="rust">/// Statically known path to library.
#[cfg(target_os = "linux")]
pub fn lib_path() -> &amp;'static Path {
    Path::new("target/release/image_sl.so")
}

/// Statically known path to library.
#[cfg(target_os = "windows")]
pub fn lib_path() -> &amp;'static Path {
    Path::new("target/release/image_sl.dll")
}</code></pre><p>Модуль <code>img</code> предоставляет две абстракции: <code>ImageFactory</code> и <code>Image</code>. Также, он содержит приватную обёртку для работы с библиотекой <code>Lib</code>.</p><p>При создании экземпляра структуры <code>Lib</code> происходит импорт символа <code>functions</code>, получение набора функций <code>Functions</code> и проверка корректности полученной структуры посредством сравнения размеров. Структура <code>Lib</code> хранит в себе счётчик ссылок на загруженную библиотеку и полученные из неё функции. Это позволяет нам гарантировать, что функции библиотеки не будут вызываться после её отключения. В дальнейшем, <code>Lib</code> будет копироваться во все экземпляры структуры <code>Image</code>, предоставляя им доступ к функциям библиотеки.</p><pre><code class="rust">/// Creates new instance of `Lib`. Loads functons from shared library.
pub unsafe fn new(lib: Library) -> Result&lt;Self, anyhow::Error> {
  let load_fn: libloading::Symbol&lt;FunctionsFn> = lib.get(b"functions")?;
  let functions = load_fn();

  if functions.size != std::mem::size_of::&lt;Functions>() {
    return Err(anyhow::Error::msg(
      "Lib Functions size != app Functions size",
    ));
  }

  Ok(Self {
    lib: Arc::new(lib),
    functions,
  })
}</code></pre><p><code>ImageFactory</code> необходим для создания новых <code>Image</code> через функцию <code>open()</code> и передачи в них копии <code>Lib</code>.</p><p><code>Image</code> инкапсулирует работу с изображением, предоставляя safe интерфейс. Также, <code>Image</code> контролирует уничтожение изображения, вызывая в деструкторе функцию <code>destroy_image()</code>.</p><p>Функция <code>main()</code> создаёт экземпляр <code>ImageFactory</code>, открывает <code>.jpg</code> изображение, размывает его, отражает зеркально и сохраняет размытый и отраженный варианты в формате <code>.png</code>.</p><pre><code class="rust">fn main() -> Result&lt;(), Box&lt;dyn Error>> {
    println!("{:?}", std::env::current_dir());
    let image_factory = ImageFactory::new()?;
    let mut image = image_factory.open_image("data/logo.jpg")?;

    let blurred = image.blur(40.);
    image.mirror();

    image.save("data/mirrored.png")?;
    blurred.save("data/blurred.png")?;
    Ok(())
}
</code></pre><a class="anchor" name="summary" id="summary"></a><h2>Заключение</h2><p>Мы рассмотрели механизм создания и подключения динамических библиотек в Rust. Для создания библиотеки в <code>Cargo.toml</code>  добавляется указание на генерацию динамической библиотеки <code>crate-type = ["cdylib"]</code> . Для экспорта символов используется ключевое слово <code>extern</code>. </p><p>Для загрузки библиотеки был использован крейт <code>libloading</code>, скрывающий сложность и небезопасность системных вызовов за абстракциями. После загрузки библиотеки и символов из неё, над ними следует создавать безопасные обёртки, для поддержания инвариантов и уменьшения количества потенциальных ошибок.</p><p>Описанные подходы были продемонстрированы на <a href="https://github.com/F3kilo/image_sl">примере библиотеки </a>работы с изображениями и приложения, эту библиотеку использующего.</p><p>На практике, динамические библиотеки написанные на Rust можно применять для ускорения требовательных к производительности мест приложения на высокоуровневых языках, таких как C#, Java, Python. Или, например, для добавления нового функционала в легаси код на низкоуровневых языках, таких как С и С++.</p><p>Возможность подключения динамических библиотек в Rust можно применить, например, для создания механизма динамического подключения плагинов к приложению.</p><p>Благодарю за внимание. Побольше вам удобных библиотек!</p><hr/><p>Статья написана в преддверии старта курса <a href="https://otus.pw/M0it/">Rust Developer.</a> </p><p><a href="https://otus.pw/M0it/">Узнать подробнее о курсе.</a></p></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Brust%5D" class="tm-tags-list__link">rust</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%B1%D0%B8%D0%B1%D0%BB%D0%B8%D0%BE%D1%82%D0%B5%D0%BA%D0%B8%5D" class="tm-tags-list__link">библиотеки</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%B1%D0%B8%D0%B1%D0%BB%D0%B8%D0%BE%D1%82%D0%B5%D0%BA%D0%B0%5D" class="tm-tags-list__link">библиотека</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bdll%5D" class="tm-tags-list__link">dll</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bshared%20library%5D" class="tm-tags-list__link">shared library</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BF%D0%BB%D0%B0%D0%B3%D0%B8%D0%BD%D1%8B%5D" class="tm-tags-list__link">плагины</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/company/otus/blog/" class="tm-hubs-list__link router-link-active">
    Блог компании OTUS
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/system_programming/" class="tm-hubs-list__link">
    Системное программирование
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/rust/" class="tm-hubs-list__link">
    Rust
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 32: ↑32 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 32: ↑32 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+32</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">3.2K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    38
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"><div class="tm-article-author__company"><div class="tm-article-author__company-card"><div class="tm-company-snippet"><a href="/ru/company/otus/profile/" class="tm-company-snippet__logo-link"><div class="tm-entity-image"><img alt="" height="40" src="//habrastorage.org/getpro/habr/company/968/422/761/968422761136a38a89fc391fd927f903.jpg" width="40" class="tm-entity-image__pic"></div></a> <div class="tm-company-snippet__info"><a href="/ru/company/otus/profile/" class="tm-company-snippet__title">OTUS</a> <div class="tm-company-snippet__description">Цифровые навыки от ведущих экспертов</div></div></div> <div class="tm-article-author__buttons"><!----> <!----></div></div> <div class="tm-article-author__company-contacts"><a href="https://otus.ru" rel="noopener" target="_blank" class="tm-article-author__contact">
      Сайт
    </a><a href="https://facebook.com/otus.ru" rel="noopener" target="_blank" class="tm-article-author__contact">
      Facebook
    </a><a href="https://vk.com/club145052891" rel="noopener" target="_blank" class="tm-article-author__contact">
      ВКонтакте
    </a><a href="https://telegram.me/Otusjava" rel="noopener" target="_blank" class="tm-article-author__contact">
      Telegram
    </a></div> <div class="tm-article-author__separator"></div></div> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/F3kilo/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_blue"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 19 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    17
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">82</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Федченко Кирилл</span> <a href="/ru/users/F3kilo/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @F3kilo
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Старший разработчик Rust</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/company/otus/blog/584248/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментировать 
    </span></a> <!----></div></div></div>  <!---->  <!----> <!----></div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__placeholder_initial"></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <section class="tm-block tm-block_spacing-bottom"><header class="tm-block__header"><h2 class="tm-block__title">Информация</h2> <!----></header> <div class="tm-block__body"><div class="tm-company-basic-info"><dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата основания</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2017-03-31T21:00:00.000Z" title="2017-04-01, 00:00">1  апреля  2017</time></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Местоположение</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    Россия
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Сайт</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><a href="https://otus.ru" target="_blank" class="tm-company-basic-info__link">
      otus.ru
    </a></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Численность</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    51–100 человек
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата регистрации</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2017-03-22T08:17:26.000Z" title="2017-03-22, 11:17">22  марта  2017</time></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Представитель</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><a href="/ru/users/MaxRokatansky/" class="tm-company-basic-info__link">
      OTUS
    </a></dd></dl></div></div> <!----></section> <div class="tm-company-widgets"></div> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/company/otus/blog/584248/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/company/otus/blog/584248/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"584248":{"id":"584248","timePublished":"2021-10-21T15:22:40+00:00","isCorporative":true,"lang":"ru","titleHtml":"Создание и использование динамических библиотек в Rust","leadData":{"textHtml":"\u003Cp\u003EДинамические библиотеки подключаются к программе во время выполнения. Это позволяет обновлять их реализацию и компилировать независимо от использующих программ. Такой подход открывает ряд дополнительных возможностей при разработке ПО. Например, написание разных модулей приложения на разных языках. Или создание системы динамически подключаемых плагинов. В данной статье мы рассмотрим, как создавать и загружать динамические библиотеки в Rust.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8e8\u002Fda9\u002F499\u002F8e8da94991532ebd9a665ae52f71cd6c.jpg","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8e8\u002Fda9\u002F499\u002F8e8da94991532ebd9a665ae52f71cd6c.jpg","fit":"cover","positionY":0,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":17,"votesCount":19},"rating":82,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"2447605","alias":"F3kilo","fullname":"Федченко Кирилл","avatarUrl":null,"speciality":"Старший разработчик Rust"},"statistics":{"commentsCount":0,"favoritesCount":38,"readingCount":3232,"score":32,"votesCount":32},"hubs":[{"relatedData":null,"id":"21052","alias":"otus","type":"corporative","title":"Блог компании OTUS","titleHtml":"Блог компании OTUS","isProfiled":false},{"relatedData":null,"id":"5767","alias":"system_programming","type":"collective","title":"Системное программирование","titleHtml":"Системное программирование","isProfiled":true},{"relatedData":null,"id":"18961","alias":"rust","type":"collective","title":"Rust","titleHtml":"Rust","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Feaf\u002Fa41\u002F17d\u002Feafa4117d812895a1cf9ae274554716f.jpg\" width=\"780\" height=\"439\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Feaf\u002Fa41\u002F17d\u002Feafa4117d812895a1cf9ae274554716f.jpg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EИногда, при разработке возникает необходимость в стыковке кода на разных языках программирования. Или в динамической загрузке, выгрузке и замене разных частей программы в процессе её выполнения. Динамические библиотеки позволяют решить эти задачи. Их можно компилировать и обновлять независимо от использующих программ, при условии сохранения интерфейса. Такой подход открывает ряд дополнительных возможностей при разработке ПО. Например, написание разных модулей приложения на разных языках. Или создание системы динамически подключаемых плагинов. В данной статье мы (в теории и на примере) рассмотрим, как создавать и загружать динамические библиотеки в Rust.\u003C\u002Fp\u003E\u003Ch2\u003EСодержание\u003C\u002Fh2\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#dyn_lib\"\u003EДинамические библиотеки\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#create_dyn_lib\"\u003EСоздание динамической библиотеки\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#load_dyn_lib\"\u003EПодключение динамической библиотеки\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#example\"\u003EПример\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#summary\"\u003EЗаключение\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Ca class=\"anchor\" name=\"dyn_lib\" id=\"dyn_lib\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EДинамические библиотеки\u003C\u002Fh2\u003E\u003Cp\u003EДля предоставления доступа к логике и данным программного кода, из которого скомпилирована библиотека, она экспортирует сущности, которые другие программы могут импортировать и использовать. Для того чтобы корректно пользоваться импортированной сущностью, нужно корректно интерпретировать её бинарное представление после импорта. Для этого динамические библиотеки, обычно, поставляются с описанием своего бинарного интерфейса (\u003Ca href=\"https:\u002F\u002Fru.wikipedia.org\u002Fwiki\u002F%D0%94%D0%B2%D0%BE%D0%B8%D1%87%D0%BD%D1%8B%D0%B9_%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81_%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9\"\u003EABI\u003C\u002Fa\u003E). Чаще всего, это описание представляется в виде программного кода, описывающего сигнатуры экспортируемых функций, соглашение о вызовах и используемые в интерфейсе типы данных.\u003C\u002Fp\u003E\u003Cp\u003EВозникает вопрос: как использовать например, классы из С++ в программе на другом языке, у которого классы (или аналогичные им сущности) представляются в бинарном виде совершенно не так, как в С++? Во избежание подобных проблем, при создании динамической библиотеки, которая должна быть доступна другим языкам, принято использовать стандартный С ABI. Иными словами, динамическая библиотека должна экспортировать только те сущности, которые присутствуют в языке С. Большинство языков, поддерживающих работу с динамическими библиотеками поддерживают и примитивы из С. И Rust входит в их число.\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"create_dyn_lib\" id=\"create_dyn_lib\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EСоздание динамической библиотеки\u003C\u002Fh2\u003E\u003Cp\u003EДля создания динамической библиотеки c C ABI нужно, для начала, указать компилятору, что мы хотим в качестве выходного продукта иметь именно её. Для этого в файл \u003Ccode\u003ECargo.toml\u003C\u002Fcode\u003E добавим следующее:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E[lib]\ncrate-type = [\"cdylib\"]\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EДалее, чтобы экспортировать функцию из библиотеки, нужно пометить её ключевым словом \u003Ccode\u003Eextern\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E#[no_mangle]\npub extern \"C\" fn foo() -\u003E u32 {...}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПараметр \"С\" используется по умолчанию и его можно не указывать явно. Он означает, что при экспорте данной функции будет использован стандартный бинарный интерфейс С для целевой платформы компилятора. Другие варианты параметров экспорта функции можно посмотреть в \u003Ca href=\"https:\u002F\u002Fdoc.rust-lang.org\u002Freference\u002Fitems\u002Fexternal-blocks.html#abi\"\u003Eдокументации\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EАттрибут \u003Ccode\u003E#[no_mangle]\u003C\u002Fcode\u003E сообщает компилятору, что имя функции не должно модифицироваться при компиляции.\u003C\u002Fp\u003E\u003Cp\u003EТаким образом, при сборке проекта, в директории выходных файлов создаётся динамическая библиотека, экспортирующая символ \u003Ccode\u003Efoo\u003C\u002Fcode\u003E. Теперь можно написать программу, которая:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003Eзагрузит эту библиотеку,\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eимпортирует из неё символ \u003Ccode\u003Efoo\u003C\u002Fcode\u003E,\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eинтерпретирует его как С функцию без аргументов, возвращающую 32-х битное беззнаковое целое число,\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eбудет вызывать библиотечную функцию и пользоваться результатом. \u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Ca class=\"anchor\" name=\"load_dyn_lib\" id=\"load_dyn_lib\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EПодключение динамической библиотеки\u003C\u002Fh2\u003E\u003Cp\u003EДля подключения динамической библиотеки и импорта символов из неё, используются функции операционной системы. Чтобы добиться кроссплатформенности можно использовать абстракции построенные поверх системных вызовов. Наиболее популярный вариант такой абстракции для работы с динамическими библиотеками в Rust - крейт \u003Ca href=\"https:\u002F\u002Fcrates.io\u002Fcrates\u002Flibloading\"\u003Elibloading\u003C\u002Fa\u003E. Помимо загрузки библиотек и символов из них, этот крейт помогает избежать глупых ошибок. Например, использовать загруженный символ после того, как библиотека была выгружена.\u003C\u002Fp\u003E\u003Cp\u003EПример использования данной библиотеки из её документации:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003Efn call_dynamic() -\u003E Result&lt;u32, Box&lt;dyn std::error::Error\u003E\u003E {\n    unsafe {\n        let lib = libloading::Library::new(\"\u002Fpath\u002Fto\u002Flib\u002Flibrary.so\")?;\n        let func: libloading::Symbol&lt;unsafe extern fn() -\u003E u32\u003E = lib.get(b\"my_func\")?;\n        Ok(func())\n    }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВ данном примере мы загружаем библиотеку, расположенную по пути \u003Ccode\u003E\u002Fpath\u002Fto\u002Flib\u002Flibrary.so\u003C\u002Fcode\u003E. В случае успеха, мы импортируем символ с названием \u003Ccode\u003Emy_func\u003C\u002Fcode\u003E, интерпретируя его как функцию с сигнатурой \u003Ccode\u003Eunsafe extern fn () -\u003E u32\u003C\u002Fcode\u003E и присваивая переменной \u003Ccode\u003Efunc\u003C\u002Fcode\u003E. Если данный символ существует и импортировался успешно, то возвращаем результат вызова \u003Ccode\u003Efunc\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003EЗагрузка библиотеки является \u003Ccode\u003Eunsafe\u003C\u002Fcode\u003E операцией, так как при этом, в общем случае, вызываются функции инициализации, гарантия корректности которых возлагается на разработчика. Это относится и к деинициализации библиотеки.\u003C\u002Fp\u003E\u003Cp\u003EЗагрузка символа из библиотеки, также, не безопасна, так как компилятор не имеет возможности проверить корректность типа загружаемого символа. За корректность интерпретации бинарных данных загружаемого символа отвечает разработчик.\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"example\" id=\"example\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EПример\u003C\u002Fh2\u003E\u003Cp\u003EДля демонстрации использования описанных выше возможностей, рассмотрим небольшой \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FF3kilo\u002Fimage_sl\"\u003Eпример\u003C\u002Fa\u003E. В данном примере крейт собирается как динамическая библиотека, а example использует её.\u003C\u002Fp\u003E\u003Ch3\u003EБиблиотека\u003C\u002Fh3\u003E\u003Cp\u003EКрейт представляет собой библиотеку для работы с изображениями, построенную поверх крейта \u003Ca href=\"https:\u002F\u002Fcrates.io\u002Fcrates\u002Fimage\"\u003Eimage\u003C\u002Fa\u003E. Данная библиотека позволяет открывать и сохранять изображения, а также применять пару преобразований: размытие и зеркальное отражение.\u003C\u002Fp\u003E\u003Cp\u003EЕдинственная функция, которую должен импортировать пользователь библиотеки выглядит так:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E\u002F\u002F\u002F Returns all functions of this library.\n#[no_mangle]\npub extern \"C\" fn functions() -\u003E FunctionsBlock {\n    FunctionsBlock::default()\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EДанная функция возвращает структуру \u003Ccode\u003EFunctionsBlock\u003C\u002Fcode\u003E, содержащую указатели на все полезные функции данной библиотеки.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E\u002F\u002F\u002F Contains functions provided by library. Allow to import just `functions()` function and get all\n\u002F\u002F\u002F functionality of library through this struct.\n\u002F\u002F\u002F `size` field contain size of this struct. It helps to avoid versioning and some other errors.\n#[allow(unused)]\n#[repr(C)]\npub struct FunctionsBlock {\n    size: usize,\n    open_image: OpenImageFn,\n    save_image: SaveImageFn,\n    destroy_image: DestroyImageFn,\n    blur_image: BlurImageFn,\n    mirror_image: MirrorImageFn,\n}\n\nimpl Default for FunctionsBlock {\n    fn default() -\u003E Self {\n        Self {\n            size: std::mem::size_of::&lt;Self\u003E(),\n            open_image: img_open,\n            save_image: img_save,\n            destroy_image: img_destroy,\n            blur_image: img_blur,\n            mirror_image: img_mirror,\n        }\n    }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EАттрибут \u003Ccode\u003E#[repr(С)]\u003C\u002Fcode\u003E сообщает компилятору, что данная структура должна быть бинарно-совместима с аналогичной структурой, определённой в С.\u003C\u002Fp\u003E\u003Cp\u003EТакой подход позволяет клиентскому коду импортировать только одну функцию, а все остальные получить, как результат её вызова. Это снижает вероятность ошибки при вводе имени каждой функции. Поле \u003Ccode\u003Esize\u003C\u002Fcode\u003E содержит размер структуры в байтах и используется для того, чтобы клиентский код мог удостовериться, что корректно интерпретирует тип структуры, а не пропустил поле, например.\u003C\u002Fp\u003E\u003Cp\u003EТипы функций содержащихся в FunctionsBlock описываются следующим образом:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E\u002F\u002F\u002F Loads image from file function type.\ntype OpenImageFn = unsafe extern \"C\" fn(RawPath, *mut ImageHandle) -\u003E ImageError;\n\u002F\u002F\u002F Saves image to file function type.\ntype SaveImageFn = unsafe extern \"C\" fn(RawPath, ImageHandle) -\u003E ImageError;\n\u002F\u002F\u002F Destroys image function type.\ntype DestroyImageFn = unsafe extern \"C\" fn(ImageHandle);\n\n\u002F\u002F\u002F Performs a Gaussian blur on the supplied image function type.\ntype BlurImageFn = unsafe extern \"C\" fn(ImageHandle, f32) -\u003E ImageHandle;\n\u002F\u002F\u002F Flips image horizontally function type.\ntype MirrorImageFn = unsafe extern \"C\" fn(ImageHandle);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EКлючевое слово \u003Ccode\u003Eextern\u003C\u002Fcode\u003E необходимо, так как эти функции будут вызываться внешним клиентом. Поэтому они должны быть совместимы с С ABI. Компилятор Rust выдаст предупреждение при попытке использовать не совместимые с С типы в сигнатурах \u003Ccode\u003Eextern\u003C\u002Fcode\u003E функций. \u003C\u002Fp\u003E\u003Cp\u003EРеализации функций конвертируют C примитивы в объекты Rust и вызывают функции крейта \u003Ccode\u003Eimage\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E\u002F\u002F\u002F # Safety\n\u002F\u002F\u002F - `path` is valid pointer to null-terminated UTF-8 string.\n\u002F\u002F\u002F - `handle` is valid image handle.\nunsafe extern \"C\" fn img_save(path: RawPath, handle: ImageHandle) -\u003E ImageError {\n    if handle.0.is_null() || path.0.is_null() {\n        return ImageError::Parameter;\n    }\n\n    let path: &amp;Path = match (&amp;path).try_into() {\n        Ok(p) =\u003E p,\n        Err(e) =\u003E return e,\n    };\n\n    let img = handle.as_image();\n    match img.save(path) {\n        Ok(_) =\u003E ImageError::NoError,\n        Err(e) =\u003E e.into(),\n    }\n}\n\n\u002F\u002F\u002F Destroys image created by this library.\nunsafe extern \"C\" fn img_destroy(handle: ImageHandle) {\n    handle.into_image();\n}\n\n\u002F\u002F\u002F Blurs image with `sigma` blur radius. Returns new image.\nunsafe extern \"C\" fn img_blur(handle: ImageHandle, sigma: f32) -\u003E ImageHandle {\n    let image = handle.as_image();\n    let buffer = image::imageops::blur(image, sigma);\n    let blurred = image::DynamicImage::ImageRgba8(buffer);\n    ImageHandle::from_image(blurred)\n}\n\n\u002F\u002F\u002F Flip image horizontally in place.\nunsafe extern \"C\" fn img_mirror(handle: ImageHandle) {\n    let image_ref = handle.as_image();\n    image::imageops::flip_horizontal_in_place(image_ref);\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Ccode\u003EImageHandle\u003C\u002Fcode\u003E и \u003Ccode\u003ERawPath\u003C\u002Fcode\u003E - это небольшие обёртки для С-совместимых типов. Эти обёртки позволяют использовать ассоциированные функции и реализовывать трейты. Подробнее: \u003Ca href=\"https:\u002F\u002Frust-unofficial.github.io\u002Fpatterns\u002Fpatterns\u002Fbehavioural\u002Fnewtype.html\"\u003Enewtype pattern\u003C\u002Fa\u003E. \u003Ccode\u003EImageHandle\u003C\u002Fcode\u003E содержит указатель на объект типа \u003Ccode\u003EDynamicImage\u003C\u002Fcode\u003E из крейта image. \u003Ccode\u003ERawPath\u003C\u002Fcode\u003E содержит указатель на С строку.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E\u002F\u002F\u002F Incapsulate raw pointer to image.\n#[repr(transparent)]\nstruct ImageHandle(*mut c_void);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E\u002F\u002F\u002F Contain pointer to null-terminated UTF-8 path.\n#[repr(transparent)]\nstruct RawPath(*const c_char);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EАттрибут \u003Ccode\u003E#[repr(transparent)]\u003C\u002Fcode\u003E сообщает компилятору, что структура должна быть представлена в бинарном виде также, как и её поле.\u003C\u002Fp\u003E\u003Cp\u003EРабота с С строками не безопасна, поэтому мы полагаемся на то, что в качестве путей клиентский код будет передавать нам корректные \u003Cem\u003Enull-terminated\u003C\u002Fem\u003E С строки в UTF-8 кодировке.\u003C\u002Fp\u003E\u003Cp\u003EКоды ошибок представлены в виде нумерованного перечисления:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E\u002F\u002F\u002F Error codes for image oprerations.\n#[repr(u32)]\n#[derive(Debug)]\nenum ImageError {\n    NoError = 0,\n    Io,\n    Decoding,\n    Encoding,\n    Parameter,\n    Unsupported,\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EАттрибут \u003Ccode\u003E#[repr(u32)]\u003C\u002Fcode\u003E сообщает компилятору, что значения перечисления представляется в памяти, как 32-х битные беззнаковые целые числа.\u003C\u002Fp\u003E\u003Ch3\u003EИспользование библиотеки\u003C\u002Fh3\u003E\u003Cp\u003EПриложение, использующее библиотеку, представлено в данном проекте в виде example-а \u003Ccode\u003Euse_lib\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003EМодуль \u003Ccode\u003Ebindings\u003C\u002Fcode\u003E повторяет определения типов данных из библиотеки, что позволяет правильно интерпретировать загруженные бинарные данные. Также, в нем находится функция, возвращающую путь к библиотеке. Эта функция возвращает разные значения для разных операционных систем. Это достигается за счёт условной компиляции.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E\u002F\u002F\u002F Statically known path to library.\n#[cfg(target_os = \"linux\")]\npub fn lib_path() -\u003E &amp;'static Path {\n    Path::new(\"target\u002Frelease\u002Fimage_sl.so\")\n}\n\n\u002F\u002F\u002F Statically known path to library.\n#[cfg(target_os = \"windows\")]\npub fn lib_path() -\u003E &amp;'static Path {\n    Path::new(\"target\u002Frelease\u002Fimage_sl.dll\")\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EМодуль \u003Ccode\u003Eimg\u003C\u002Fcode\u003E предоставляет две абстракции: \u003Ccode\u003EImageFactory\u003C\u002Fcode\u003E и \u003Ccode\u003EImage\u003C\u002Fcode\u003E. Также, он содержит приватную обёртку для работы с библиотекой \u003Ccode\u003ELib\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003EПри создании экземпляра структуры \u003Ccode\u003ELib\u003C\u002Fcode\u003E происходит импорт символа \u003Ccode\u003Efunctions\u003C\u002Fcode\u003E, получение набора функций \u003Ccode\u003EFunctions\u003C\u002Fcode\u003E и проверка корректности полученной структуры посредством сравнения размеров. Структура \u003Ccode\u003ELib\u003C\u002Fcode\u003E хранит в себе счётчик ссылок на загруженную библиотеку и полученные из неё функции. Это позволяет нам гарантировать, что функции библиотеки не будут вызываться после её отключения. В дальнейшем, \u003Ccode\u003ELib\u003C\u002Fcode\u003E будет копироваться во все экземпляры структуры \u003Ccode\u003EImage\u003C\u002Fcode\u003E, предоставляя им доступ к функциям библиотеки.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003E\u002F\u002F\u002F Creates new instance of `Lib`. Loads functons from shared library.\npub unsafe fn new(lib: Library) -\u003E Result&lt;Self, anyhow::Error\u003E {\n  let load_fn: libloading::Symbol&lt;FunctionsFn\u003E = lib.get(b\"functions\")?;\n  let functions = load_fn();\n\n  if functions.size != std::mem::size_of::&lt;Functions\u003E() {\n    return Err(anyhow::Error::msg(\n      \"Lib Functions size != app Functions size\",\n    ));\n  }\n\n  Ok(Self {\n    lib: Arc::new(lib),\n    functions,\n  })\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Ccode\u003EImageFactory\u003C\u002Fcode\u003E необходим для создания новых \u003Ccode\u003EImage\u003C\u002Fcode\u003E через функцию \u003Ccode\u003Eopen()\u003C\u002Fcode\u003E и передачи в них копии \u003Ccode\u003ELib\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EImage\u003C\u002Fcode\u003E инкапсулирует работу с изображением, предоставляя safe интерфейс. Также, \u003Ccode\u003EImage\u003C\u002Fcode\u003E контролирует уничтожение изображения, вызывая в деструкторе функцию \u003Ccode\u003Edestroy_image()\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003EФункция \u003Ccode\u003Emain()\u003C\u002Fcode\u003E создаёт экземпляр \u003Ccode\u003EImageFactory\u003C\u002Fcode\u003E, открывает \u003Ccode\u003E.jpg\u003C\u002Fcode\u003E изображение, размывает его, отражает зеркально и сохраняет размытый и отраженный варианты в формате \u003Ccode\u003E.png\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"rust\"\u003Efn main() -\u003E Result&lt;(), Box&lt;dyn Error\u003E\u003E {\n    println!(\"{:?}\", std::env::current_dir());\n    let image_factory = ImageFactory::new()?;\n    let mut image = image_factory.open_image(\"data\u002Flogo.jpg\")?;\n\n    let blurred = image.blur(40.);\n    image.mirror();\n\n    image.save(\"data\u002Fmirrored.png\")?;\n    blurred.save(\"data\u002Fblurred.png\")?;\n    Ok(())\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Ca class=\"anchor\" name=\"summary\" id=\"summary\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EЗаключение\u003C\u002Fh2\u003E\u003Cp\u003EМы рассмотрели механизм создания и подключения динамических библиотек в Rust. Для создания библиотеки в \u003Ccode\u003ECargo.toml\u003C\u002Fcode\u003E  добавляется указание на генерацию динамической библиотеки \u003Ccode\u003Ecrate-type = [\"cdylib\"]\u003C\u002Fcode\u003E . Для экспорта символов используется ключевое слово \u003Ccode\u003Eextern\u003C\u002Fcode\u003E. \u003C\u002Fp\u003E\u003Cp\u003EДля загрузки библиотеки был использован крейт \u003Ccode\u003Elibloading\u003C\u002Fcode\u003E, скрывающий сложность и небезопасность системных вызовов за абстракциями. После загрузки библиотеки и символов из неё, над ними следует создавать безопасные обёртки, для поддержания инвариантов и уменьшения количества потенциальных ошибок.\u003C\u002Fp\u003E\u003Cp\u003EОписанные подходы были продемонстрированы на \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FF3kilo\u002Fimage_sl\"\u003Eпримере библиотеки \u003C\u002Fa\u003Eработы с изображениями и приложения, эту библиотеку использующего.\u003C\u002Fp\u003E\u003Cp\u003EНа практике, динамические библиотеки написанные на Rust можно применять для ускорения требовательных к производительности мест приложения на высокоуровневых языках, таких как C#, Java, Python. Или, например, для добавления нового функционала в легаси код на низкоуровневых языках, таких как С и С++.\u003C\u002Fp\u003E\u003Cp\u003EВозможность подключения динамических библиотек в Rust можно применить, например, для создания механизма динамического подключения плагинов к приложению.\u003C\u002Fp\u003E\u003Cp\u003EБлагодарю за внимание. Побольше вам удобных библиотек!\u003C\u002Fp\u003E\u003Chr\u002F\u003E\u003Cp\u003EСтатья написана в преддверии старта курса \u003Ca href=\"https:\u002F\u002Fotus.pw\u002FM0it\u002F\"\u003ERust Developer.\u003C\u002Fa\u003E \u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fotus.pw\u002FM0it\u002F\"\u003EУзнать подробнее о курсе.\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"rust"},{"titleHtml":"библиотеки"},{"titleHtml":"библиотека"},{"titleHtml":"dll"},{"titleHtml":"shared library"},{"titleHtml":"плагины"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8e8\u002Fda9\u002F499\u002F8e8da94991532ebd9a665ae52f71cd6c.jpg","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8e8\u002Fda9\u002F499\u002F8e8da94991532ebd9a665ae52f71cd6c.jpg","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002Fotus\\\u002Fblog\\\u002F584248\\\u002F\"},\"headline\":\"Создание и использование динамических библиотек в Rust\",\"datePublished\":\"2021-10-21T18:22:40+03:00\",\"dateModified\":\"2021-10-22T01:56:08+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Федченко Кирилл\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Иногда, при разработке возникает необходимость в стыковке кода на разных языках программирования. Или в динамической загрузке, выгрузке и замене разных частей пр...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002Fotus\\\u002Fblog\\\u002F584248\\\u002F#post-content-body\",\"about\":[\"c_otus\",\"h_system_programming\",\"h_rust\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F584248\\\u002F006b19875bedfab14c65424c3001d28c\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Feaf\\\u002Fa41\\\u002F17d\\\u002Feafa4117d812895a1cf9ae274554716f.jpg\"]}","metaDescription":"Иногда, при разработке возникает необходимость в стыковке кода на разных языках программирования. Или в динамической загрузке, выгрузке и замене разных частей программы в процессе её выполнения....","mainImageUrl":null,"amp":true},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":""},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{"otus":{"alias":"otus","imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fcompany\u002F968\u002F422\u002F761\u002F968422761136a38a89fc391fd927f903.jpg","titleHtml":"OTUS","descriptionHtml":"Цифровые навыки от ведущих экспертов","relatedData":null,"statistics":{"postsCount":1483,"newsCount":2,"vacanciesCount":0,"employeesCount":46,"careerRating":null,"subscribersCount":66839,"rating":407.38,"invest":null},"foundationDate":{"year":"2017","month":"04","day":"01"},"location":{"city":{"id":"447159","title":"Москва"},"region":{"id":"1885","title":"Москва и Московская обл."},"country":{"id":"168","title":"Россия"}},"siteUrl":"https:\u002F\u002Fotus.ru","staffNumber":"51–100 человек","registrationDate":"2017-03-22T08:17:26+00:00","representativeUser":{"alias":"MaxRokatansky","fullname":"OTUS"},"contacts":[{"title":"Сайт","url":"https:\u002F\u002Fotus.ru"},{"title":"Facebook","url":"https:\u002F\u002Ffacebook.com\u002Fotus.ru"},{"title":"ВКонтакте","url":"https:\u002F\u002Fvk.com\u002Fclub145052891"},{"title":"Telegram","url":"https:\u002F\u002Ftelegram.me\u002FOtusjava"}],"settings":{"analyticsSettings":[],"branding":null,"status":"active"},"metadata":{"titleHtml":"OTUS, Москва - Цифровые навыки от ведущих экспертов с 1 апреля 2017 г.","title":"OTUS, Москва - Цифровые навыки от ведущих экспертов с 1 апреля 2017 г.","keywords":["Программирование","Python","Java","Информационная безопасность","Машинное обучение"],"descriptionHtml":"1 483 статьи от авторов компании OTUS","description":"1 483 статьи от авторов компании OTUS"},"aDeskSettings":null,"careerAlias":"otus","maxCustomTrackerLinks":0}},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
