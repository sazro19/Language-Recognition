<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>А твой Exchange в полном порядке? Как бесплатно мониторить здоровье сервера / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/585218\/"},"headline":"А твой Exchange в полном порядке? Как бесплатно мониторить здоровье сервера","datePublished":"2021-10-24T19:14:18+03:00","dateModified":"2021-10-24T19:14:18+03:00","author":{"@type":"Person","name":"Игорь"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Всем привет. Меня зовут Игорь -&nbsp;я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в комп...","url":"https:\/\/habr.com\/ru\/post\/585218\/#post-content-body","about":["h_linux","h_open_source","h_sys_admin","f_develop","f_admin"],"image":["https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/58c\/b01\/4d5\/58cb014d5eb617a7920fad1931608412.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/553\/227\/eee\/553227eee3bb02a42f496eaa3e3cedd4.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/c21\/15e\/e87\/c2115ee87d2c2897fd154a8dd58fafe5.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/c83\/0b9\/2fa\/c830b92fac565cdcab5b44a31200612f.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/6cc\/bec\/f02\/6ccbecf02a29b8d371a29faa0ad8f8fd.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/eb8\/65e\/72a\/eb865e72a72aeea56a0a61f8df024ebe.jpg"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="А твой Exchange в полном порядке? Как бесплатно мониторить здоровье сервера" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="А твой Exchange в полном порядке? Как бесплатно мониторить здоровье сервера" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="А твой Exchange в полном порядке? Как бесплатно мониторить здоровье сервера" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Всем привет. Меня зовут Игорь -&amp;nbsp;я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в компании NUT.Tech.Уже более 10-ти лет..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Всем привет. Меня зовут Игорь -&amp;nbsp;я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в компании NUT.Tech.Уже более 10-ти лет..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Всем привет. Меня зовут Игорь -&amp;nbsp;я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в компании NUT.Tech.Уже более 10-ти лет..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Всем привет. Меня зовут Игорь -&amp;nbsp;я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в компании NUT.Tech.Уже более 10-ти лет..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Всем привет. Меня зовут Игорь -&amp;nbsp;я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в компании NUT.Tech.Уже более 10-ти лет..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/585218/a6617c90f7bbd5f33661bef85713972a/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/585218/a6617c90f7bbd5f33661bef85713972a/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/585218/a6617c90f7bbd5f33661bef85713972a/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/585218/a6617c90f7bbd5f33661bef85713972a/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/585218/a6617c90f7bbd5f33661bef85713972a/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="585218" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-24T16:14:18.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/585218/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/585218/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/585218/a6617c90f7bbd5f33661bef85713972a/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/Igolu/" title="Igolu" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/586/af7/c7f/586af7c7fd6e9040d0b60dc436c2acf2.jpg" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/Igolu/" class="tm-user-info__username">
      Igolu
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-24T16:14:18.000Z" title="2021-10-24, 19:14">вчера в 19:14</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>А твой Exchange в полном порядке? Как бесплатно мониторить здоровье сервера</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/linux/" class="tm-article-snippet__hubs-item-link"><span>Настройка Linux</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/open_source/" class="tm-article-snippet__hubs-item-link"><span>Open source</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/sys_admin/" class="tm-article-snippet__hubs-item-link"><span>Системное администрирование</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <div class="tm-article-snippet__labels"><div class="tm-article-snippet__label"><span>
        Из песочницы
      </span></div></div> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><p>Всем привет. Меня зовут Игорь - я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в компании NUT.Tech.</p><p>Уже более 10-ти лет я так или иначе сталкиваюсь с различными задачами, связанными с администрированием Microsoft Exchange Server. В основном – ничего сложного, обычные прикладные задачи вроде создания в системе новых почтовых ящиков и решения различных проблем с доставкой почтовых сообщений. Но так или иначе у меня накопилась некоторая экспертиза в этом вопросе.</p><p>Основная идея этой статьи – рассказать о решении, которое позволяет быстро и без затрат реализовать мониторинг Exchange сервера, используя популярные open source решения.</p><p>Знание этих несложных инструментов и умение применять их на практике позволят вам детализировать мониторинг Exchange практически до любого уровня, а также откроют возможности для осуществления мониторинга большого числа других сервисов и компонентов вашей инфраструктуры.</p><p>Microsoft Exchange можно условно назвать "коробочным решением" в том плане, что, несмотря на некоторую сложность в его внедрении (требуется инфраструктура ADDS, опыт работы с продуктами MS, покупка лицензий и.т.д.), после установки и настройки, он просто работает и ничего особенного с ним не происходит. Сообщения принимаются и отправляются, Outlook стабильно подключается к серверу, а веб-интерфейс OWA (Outlook Web Access) радует пользователей.</p><p>На мой субъективный взгляд такая вот "коробочная" особенность Exchange позволяет рядовому офисному администратору, который оказался ответственным за Exchange, особо не задумываться о том, а насколько же в действительности хорошо или плохо функционирует корпоративный почтовый сервер. Скорее всего такой админ не совершает проактивных действий по предотвращению возможных инцидентов с почтой, а о многих неполадках узнает от пользователей или, еще хуже, от своего руководства. Согласитесь, неприятно оказаться в ситуации, когда звонит начальник и сообщает, что он уже несколько часов назад отправил одно очень важное письмо, а партнеры его до сих пор не получили. И уже после проведения диагностики оказывается, что сервер перестал отправлять внешние сообщения, т.к. ваш IP адрес оказался в черном списке, при этом внутренняя почта продолжает работать и нет никаких признаков, что существует проблема.</p><p>Само собой, в крупных компаниях, где IT направление в целом находится на высоком уровне, скорее всего применяются коммерческие системы мониторинга, в которых есть готовые шаблоны по мониторингу Exchange и на которые можно полностью положиться, особо не вдаваясь в детали различных показателей работы сервиса и того, как они могут влиять на его состояние. С другой стороны, небольшие компании по примеру тех, в которых мне довелось работать, вряд ли готовы закладывать в свой бюджет расходы на энтерпрайз систему мониторинга. Администраторы в таких компаниях, как правило, загружены рутинной работой, и не горят желанием разбираться с метриками Exchange сервера, тем более что "Почту настраивал предыдущий админ, я тут работаю уже пару лет, и она еще ни разу не ломалась". Да, такой подход имеет место быть. И я не говорю, что он совсем неприменим. Даже наоборот, Exchange действительно довольно стабильная система и, на самом деле, можно несколько лет с ней ничего не делать, и она будет работать без каких-либо проблем.</p><p>Но статья же не об этом, правильно? Давайте перейдем ближе к делу.</p><p>Однажды, будучи таким вот офисным админом, я задумался о том, что, в действительности, я не располагаю какой-либо оперативной информацией о состоянии сервиса. Я имею в виду, что у меня под рукой совсем нет никаких показателей, на которые я бы мог посмотреть и понять работает ли почта. Да, конечно, я в любой момент могу зайти на сервер по RDP или подключиться удаленно через консоль или PowerShell, зайти на нем в пару мест и понять, что с сервером ничего плохого не происходит - почта приходит и уходит, клиенты подключаются, все хорошо. Но для совершения этих действий мне бы пришлось отвлечься от других задач, ненадолго, но выпасть из рабочего процесса, да и зачем мне лазить на сервер, когда ничего не случилось, и я уверен, что он в полном порядке.</p><p>Спустя некоторое время, разрешив свой внутренний конфликт и немного поразмыслив, я решил, что для дальнейшего душевного спокойствия мне хотелось бы иметь дашборд (сводную информацию) с какими-то основными метриками, которые бы помещались на одном экране и на которые я мог бы периодически поглядывать и визуально оценивать текущее здоровье сервиса.</p><p>Так как до этого момента мне не приходилось иметь дело с системами мониторинга, я не особо понимал, как можно осуществить задуманное и с чего вообще начать. Немного пообщавшись со своими более опытными коллегами в НАТ.Тех и изучив доступную в интернете информацию, я довольно быстро нашел несколько популярных open source продуктов, которые в дальнейшем и помогли мне реализовать задачу мониторинга MS Exchange Server.</p><p>Для всех этих продуктов в интернете существует большое количество документации, всевозможных мануалов и инструкций, так что для тех, кто уже знаком с ними я ничего нового не расскажу, но постараюсь рассказать про некоторые интересные моменты, с которыми я столкнулся в процессе настройки. Также, я надеюсь, что эта статья будет полезна тем, кто, как и я, никогда на разворачивал системы мониторинга для Exchange.</p><p>Итак, примерно разобравшись с тем, как должна выглядеть архитектура моего сервиса, я пришел к следующей схеме по её реализации.</p><figure class=""><img src="/img/image-loader.svg" height="253" data-src="https://habrastorage.org/getpro/habr/upload_files/58c/b01/4d5/58cb014d5eb617a7920fad1931608412.png" data-width="378"/><figcaption></figcaption></figure><ol><li><p><strong>Telegraf.</strong> Агент для сбора и передачи метрик с сервера Exchange. <a href="https://www.influxdata.com/time-series-platform/telegraf/" rel="noopener noreferrer nofollow">https://www.influxdata.com/time-series-platform/telegraf/</a></p></li><li><p><strong>InfluxDB. </strong>База данных для хранения данных в виде временных рядов. (Time series database) <a href="https://www.influxdata.com/" rel="noopener noreferrer nofollow">https://www.influxdata.com/</a></p></li><li><p><strong>Grafana.</strong> Веб-платформа для аналитики и интерактивной визуализации данных из различных источников.<strong> </strong><a href="https://grafana.com/" rel="noopener noreferrer nofollow">https://grafana.com/</a></p></li></ol><p><em>Для простоты, все компоненты, кроме агента Telegraf, я установлю на одной виртуальной машине с OS CentOS 7. Агент необходимо установить на сервер Exchange.</em></p><h2>Начнем с установки базы данных InfluxDB.</h2><p>На странице <a href="https://portal.influxdata.com/downloads/" rel="noopener noreferrer nofollow">https://portal.influxdata.com/downloads/</a> выберите из списка вашу OS и воспользуйтесь автоматически сгенерированной командой для загрузки и установки пакета.</p><p>В моем случае для загрузки пакета я использовал утилиту CURL, так как wget по умолчанию не установлен в CentOS 7.</p><p><code>curl -O https://dl.influxdata.com/influxdb/releases/influxdb2-2.0.7.x86_64.rpm</code></p><p><code>yum localinstall influxdb2-2.0.7.x86_64.rpm</code></p><p>Запустим службу InfluxDB и добавим её в автозапуск</p><p><code>systemctl start influxdb</code></p><p><code>systemctl enable influxdb</code></p><p>В рамках тестовой среды отключим firewall. Если планируете вводить сервис в эксплуатацию, не отключайте firewall, а произведите его настройку.</p><p><code>systemctl stop firewalld</code></p><p>Для проверки доступности сервиса со стороны Exchange можно выполнить следующую команду в PowerShell.</p><p><code>curl -Uri IP_адрес_сервера_INFLUXDB:8086/ping -UseBasicParsing</code></p><p>Должно произойти соединение с сервером, и команда вернет ответ </p><p><code>StatusCode: 204</code></p><p>Сервис доступен.</p><p><em>Важный момент - в конце 2020 года вышла новая версия influxdb версии 2.0. В этой версии очень сильно изменилась идеология продукта. Приведенные ниже примеры подойдут только для influxdb версии 2.x. В версии 1.x алгоритм настройки будет сильно отличаться.</em></p><p>Для дальнейшей настройки воспользуемся веб-интерфейсом, который предоставляет платформа InfluxDB.</p><p>Веб-интерфейс доступен по адресу <a href="http://IP_адрес_сервера_INFLUXDB:8086/" rel="noopener noreferrer nofollow">http://IP_адрес_сервера_INFLUXDB:8086/</a></p><p>Придумываем имя пользователя, пароль, название организации и название корзины (условной базы данных, в которую будут записываться наши метрики).</p><p>На следующем шаге выбираем вариант настройки "Advanced" - это позволит нам сразу настроить подключение для будущего агента Telegraf.</p><p>Для осуществления операций по чтению и записи данных в корзину нам потребуется токен нашей учетной записи.</p><p>В веб интерфейсе в левом меню идем в раздел DATA-Tokens, щелкаем по имени вашего пользователя. Откроется окошко с параметрами токена, скопируйте его в блокнот - он нам понадобится на следующем этапе.</p><p>Для того, чтобы можно было использовать InfluxQL, более простой язык запросов к базе данных, вместо более сложного FLUX, который появился в версии 2, потребуется сделать дополнительные настройки.</p><p><a href="https://docs.influxdata.com/influxdb/v2.0/query-data/influxql/" rel="noopener noreferrer nofollow"><em>Вот здесь есть более подробное описание, как это делается.</em></a></p><p>Сначала необходимо получить ID корзины, для которой мы настраиваем доступ по логину и паролю. В веб интерфейсе в левом меню идем в раздел DATA-Buckets. В списке найдите корзину, которую вы создали и скопируйте её ID, который отображается рядом с именем.</p><p>Следующие команды выполняем в консоли вашего сервера.</p><p>Создаем пользователя, чтобы была возможность подключиться к InfluxDB, используя логин и пароль, вместо токена</p><pre><code>influx v1 auth create \
 --username grafanauser \
 --password grafanauser \
 --org НАЗВАНИЕ_ОРГАНИЗАЦИИ_В_INFLUXDB \
 --read-bucket ID_ВАШЕЙ_КОРЗИНЫ \
 -t ТОКЕН_ВАШЕГО_ПОЛЬЗОВАТЕЛЯ</code></pre><p>Создаем привязку корзины к базе данных</p><pre><code>influx v1 dbrp create \
   --db test \
   --rp test-rp \
   --bucket-id ID_ВАШЕЙ_КОРЗИНЫ \
   --default \
   --org НАЗВАНИЕ_ОРГАНИЗАЦИИ_В_INFLUXDB \
   -t ТОКЕН_ВАШЕГО_ПОЛЬЗОВАТЕЛЯ</code></pre><p>Ну вот и все, теперь у нас есть первый компонент нашего сервиса мониторинга.</p><h2>Переходим к установке агента Telegraf</h2><p><em>Дальнейшие действия необходимо производить на сервере Exchange.</em></p><p><a href="https://portal.influxdata.com/downloads/" rel="noopener noreferrer nofollow">Скачиваем дистрибутив для Windows тут</a>.</p><p>На сайте выберете платформу Windows и увидите сгенерированные команды для загрузки и установки файлов.</p><p>Этими командами можно воспользоваться в PowerShell.</p><p><code>wget https://dl.influxdata.com/telegraf/releases/telegraf-1.19.1_windows_amd64.zip -UseBasicParsing -OutFile telegraf-1.19.1_windows_amd64.zip</code></p><p>Файл загрузится не в ту директорию, где выполняется команда, а в вашу домашнюю директорию. Распаковать скаченный архив можно тут же при помощи команды.</p><p><code>Expand-Archive ~\telegraf-1.19.1_windows_amd64.zip -DestinationPath 'C:\ProgramFiles\InfluxData\telegraf\'</code></p><p>В директории окажется два файла:</p><p><strong>telgraf.exe</strong> - собственно сам исполняемый файл;</p><p><strong>telegraf.conf</strong> - конфигурационный файл с настройками подключения к хранилищу данных и описанием метрик, которые будет собирать наш агент.</p><p>В этом файле практически все строки закомментированы и содержат описания возможных параметров конфигурации.  Они приведены для примера настройки различных сценариев использования агента Telegraf. Чтобы не запутаться в конфигурации, давайте самостоятельно создадим этот файл с чистого листа и добавим только те параметры, которые нам будут нужны.</p><p>Для начала сделайте копию исходного файла и переименуйте его в telegraf.bak</p><p>Откройте оригинальный файл, выделите в нем весь текст и удалите его, чтобы он остался совершенно пустым.</p><p>Отлично.</p><p>Первым делом нам нужно создать секцию <strong>[agent]</strong>. В этой секции задаются глобальные параметры работы агента. Скопируйте основные параметры.</p><p>Для нас пока важен только параметр interval, который задает интервал (частоту) сбора метрик. Установите его в 5 секунд, чтобы в процессе настройки мы могли быстрее видеть новые значения метрик. В дальнейшем вы можете подобрать эти параметры под ваши требования.</p><pre><code>[[agent]]
  interval = "5s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_jitter = "0s"
  precision = ""</code></pre><p>Далее нам нужно создать секцию <strong>[Output]</strong>, которая описывает параметры для отправки полученных агентом метрик в базу данных.</p><p>В нашем случае секция будет называться <strong>[[outputs.influxdb_v2]]</strong></p><p>Конфигурирование этой секции очень простое, а, если быть точным, все параметры автоматически генерируются на стороне InfluxDB в соответствии с настройками вашей инсталляции и нам остается только скопировать эти готовые параметры.</p><p>Для этого открываем веб интерфейс InfluxDB, идем в раздел Data -> Telegraf и нажимаем на кнопку "InfluxDB output plugin"</p><p>Откроется окошко с нужными нам параметрами, далее скопируем эту секцию в наш конфигурационный файл.</p><p>Проверьте все параметры и убедитесь, что они соответствуют настройкам вашей инсталляции.</p><p>Также в параметр Token скопируйте ранее сохраненный токен пользователя, созданный в InfluxDB, заполните поля «organization» и «bucket» в соответствии с вашими параметрами.</p><pre><code>[[outputs.influxdb_v2]]
  ## The URLs of the InfluxDB cluster nodes.
  ##
  ## Multiple URLs can be specified for a single cluster, only ONE of the
  ## urls will be written to each interval.
  ## urls exp: http://127.0.0.1:9999

  urls = ["http://IP_адрес_сервера_INFLUXDB:8086"]

  ## Token for authentication.
  token = "$INFLUX_TOKEN"

  ## Organization is the name of the organization you wish to write to; must exist.
  organization = "test"

  ## Destination bucket to write into.
  bucket = "test"
  timeout = "5s"</code></pre><p>И последняя секция, которая нам понадобится на данном этапе, это секция Inputs, в которой перечисляются метрики, значения которых будут отправляться в базу данных.</p><p>Для примера давайте сконфигурируем метрику загрузки процессора.</p><p>Метрики, относящиеся к Exchange, добавим позже, когда все компоненты сервиса будут установлены.</p><pre><code>[[inputs.win_perf_counters]]
  [[inputs.win_perf_counters.object]]

    # Processor usage, alternative to native, reports on a per core.
    ObjectName = "Processor"

    Instances = ["*"]
    Counters = ["% Idle Time", "% Interrupt Time", "% Privileged Time", "% User Time", "% Processor Time"]
    Measurement = "win_cpu"</code></pre><p>Давайте запустим Telegraf в тестовом режиме и проверим, что в нашем конфиге нет никаких ошибок. В таком режиме Telegraf не отправляет метрики в базу данных, а выводит их в консоль.</p><p>В командной строке перейдите в директорию, в которую вы распаковали файлы Telegraf.</p><p><code>cd "C:\Program Files\InfluxData\telegraf\telegraf-1.19.1"</code></p><p>и выполните команду:</p><p><code>.\telegraf.exe -config telegraf.conf -test</code></p><p>Команда запустит Telegraf с нашим конфигом и выведет несколько значений по текущей загрузке каждого ядра процессора.</p><p>Для моего 4-х ядерного процессора я получил 8 строчек со значениями для каждого логического ядра.</p><p>Если на вашей системе вы получаете метрики загрузки процессора и при запуске нет никаких ошибок, то можете запустит Telegraf уже в полноценном режиме, чтобы он отправлял метрики в наше хранилище данных с помощью команды.</p><p><code>telegraf -config telegraf.conf</code></p><p>Для дальнейшей полноценной эксплуатации вы можете установить Telegraf в качестве службы.</p><p><code>telegraf.exe --service install</code></p><h2>Установка последнего и самого интересного компонента - Grafana</h2><p>Идем на страничку <a href="https://grafana.com/grafana/download" rel="noopener noreferrer nofollow">https://grafana.com/grafana/download</a></p><p>Находим нужные команды для нашей ОС. В моем случае для CentOS для загрузки и установки пакета я использую команды:</p><p><code>curl -O https://dl.grafana.com/oss/release/grafana-8.0.5-1.x86_64.rpm</code></p><p><code>yum install grafana-8.0.5-1.x86_64.rpm</code></p><p>Как обычно добавим сервис в автозапуск и запустим</p><p><code>systemctl start grafana-server</code></p><p><code>systemctl enable grafana-server</code></p><p>Веб-интерфейс доступен по адресу<a href="http://IP_адрес_сервера_INFLUXDB:3000/" rel="noopener noreferrer nofollow"> http://IP_адрес_сервера_INFLUXDB:3000/</a></p><p><strong>Пароль по умолчанию admin:admin</strong></p><p>Первое, что необходимо сделать, это подключить нашу базу данных в качестве источника данных.</p><p>В левом меню идем в раздел Configuration (шестеренка) -> Data Sources, нажимаем кнопку «Add Data source».</p><p>В списке находим и выбираем InfluxDB, откроется окно с настройками подключения.</p><p>Проверяем, что в поле «Query Language» установлен InfluxQL. Это позволит нам использовать визуальный конструктор запросов к хранилищу данных.</p><p>Заполняем следующие поля:</p><p><strong>Раздел HTTP</strong></p><p><code>URL: http://IP_адрес_сервера_INFLUXDB:8086</code></p><p><strong>Раздел InfluxDB Details</strong></p><p><code>Database: test (название нашей корзины в InfluxDB)</code></p><p><code>User: grafanauser</code></p><p><code>Password: grafanauser</code></p><p><code>HTTP Method: GET</code></p><p>Все. Нажимаем кнопку «Save and test».</p><p>Должно произойти тестовое подключение к хранилищу данных и отобразится зеленая галочка с надписью "Data source is working"</p><figure class=""><img src="/img/image-loader.svg" height="432" data-src="https://habrastorage.org/getpro/habr/upload_files/553/227/eee/553227eee3bb02a42f496eaa3e3cedd4.png" data-width="510"/><figcaption></figcaption></figure><p>Теперь создадим новый дашборд и выведем на него наши тестовые метрики по загрузке процессора.</p><p>Слева в меню идем в раздел "Create" иконка +, выбираем Dashboard, на дашборде в новой панели выбираем "Add an empty panel".</p><p>Откроются настройки новой панели. Проверьте, что в качестве источника данных у вас установлен <strong>InfluxDB</strong> (так как он пока единственный источник).</p><p>Далее в визуальном конструкторе запроса выбираем параметры как на скриншоте:</p><figure class=""><img src="/img/image-loader.svg" height="396" data-src="https://habrastorage.org/getpro/habr/upload_files/c21/15e/e87/c2115ee87d2c2897fd154a8dd58fafe5.png" data-width="510"/><figcaption></figcaption></figure><p>Если все настройки выполнены верно, вы увидите график загрузки процессора.</p><p>В правой части есть различные параметры отрисовки данных на графике, можете их настроить по своему вкусу.</p><p>Когда завершите все настройки, сверху нажмите кнопку Save, чтобы сохранить ваш дашборд, на котором располагается пока что только одна панель с метриками.</p><p>Все компоненты сервиса установлены и настроены. Последнее, что остается сделать, это добавить в конфигурацию агента Telegraf описание интересующих нас метрик Exchange и вывести их в отдельные графики на нашем дашборде в Grafana.</p><p>Расскажу, как это сделать.</p><h2>Добавляем метрики Exchange в конфигурацию Telegraf.</h2><p>Наверное, все знают, что в Windows есть оснастка <strong>Performance Monitor</strong>. Если кто-то из вас ни разу не пользовался этой штукой, в интернете полно информации.</p><p>Так вот, при установке Exchange Server в систему автоматически добавляется большое количество разнообразных метрик, которые как раз можно просматривать в Performance Monitor.</p><p>А в нашем агенте Telegraf очень удачно есть специальный модуль <strong>[[inputs.win_perf_counters]]</strong> , который позволяет читать любые метрики из Performance Monitor и отправлять в нашу базу данных ровно точно также как и ранее настроенные показатели загрузки процессора.</p><p>Давайте добавим в конфигурацию дополнительные секции для сбора интересующих нас метрик.</p><p>Я расскажу из чего состоит конфигурация на примере одной метрики. Все остальные метрики вы сможете добавить сами по этому шаблону.</p><p>Также в конце я приложу файл конфигурации со всеми метриками, которые я использовал в своей работе.</p><p>Вот так выглядит конфигурация секции <strong>[[inputs.win_perf_counters]]</strong></p><pre><code>[[inputs.win_perf_counters]]
  [[inputs.win_perf_counters.object]]

    ObjectName = "MSExchangeImap4"
    
    Counters = [
      "Current Connections",
      "Request rate",
    ]

    Measurement = "ex01__MSExchangeImap4"

    Instances = ["*"]

    IncludeTotal=true</code></pre><p>Для нас тут важно поле <strong>ObjectName</strong>. Оно задает имя интересующего нас объекта для получения метрик. Каждый такой объект содержит свой набор различных метрик.</p><p>В поле counters перечислены метрики, которые существуют в данном объекте и значения которых мы будем отправлять в базу данных.</p><p>Поле <strong>Measurement</strong> определяет название таблицы, в которую на стороне базы данных записываются значения метрик, перечисленных в поле <strong>counters</strong>. Тут мы можем придумать своё название, чтобы нам легче было ориентироваться при добавлении метрик на наш дашборд.</p><p>Некоторые из счетчиков подразделяются на экземпляры (Instances), например, в счетчике загрузки процессора будет 8 экземпляров.</p><p>Если нам не нужен какой-то конкретный экземпляр счетчика, и мы хотим получить значения всех существующих экземпляров, то в поле Instances указывается *.</p><p>Для некоторых счетчиков экземпляры не предусмотрены (например, для оперативной памяти), в этом случае обязательно указывать "Instances = ["------"]", иначе Telegraf сообщит об ошибке в конфигурации и не будет работать.</p><p>Также можно указать параметр IncludeTotal=true, который позволяет получить отдельной метрикой общее значение для всех экземпляров счетчика, чтобы не считать их "вручную".</p><p>Список всех доступных объектов можно посмотреть в оснастке Performance Monitor.</p><figure class=""><img src="/img/image-loader.svg" height="290" data-src="https://habrastorage.org/getpro/habr/upload_files/c83/0b9/2fa/c830b92fac565cdcab5b44a31200612f.png" data-width="341"/><figcaption></figcaption></figure><p>Также их можно вывести с помощью команды Powershell.</p><p><code>Get-Counter -List * | ft CounterSetName</code></p><p>Отфильтровать вывод можно так:</p><p><code>Get-Counter -List * | Where {$_.countersetname -like "*processor*"} | ft CounterSetName</code></p><p>Список доступных счетчиков в объекте можно вывести командой:</p><p><code>(Get-Counter -ListSet MSExchangeImap4).Paths</code></p><p>К сожалению, вывод команды будет зависеть от языка системы, так в русском интерфейсе эти команды будут выводить название счетчиков на русском языке.</p><p>И ожидаемо - русские названия объектов не поддерживаются в конфигурации Telegraf.</p><p>Самое простое решение - это отобразить все необходимые счетчики в Performance Monitor, затем нажать кнопку "копировать свойства" в буфер обмена, открыть чистый блокнот и вставить туда содержимое буфера обмена.</p><figure class=""><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/6cc/bec/f02/6ccbecf02a29b8d371a29faa0ad8f8fd.jpg" width="510" height="119" data-src="https://habrastorage.org/getpro/habr/upload_files/6cc/bec/f02/6ccbecf02a29b8d371a29faa0ad8f8fd.jpg" data-blurred="true"/><figcaption></figcaption></figure><p>Это текстовое описание текущего отображения счетчиков, в котором среди кучи параметров будет параметр PATH, значение VALUE которого содержит название объекта и счетчика на английском языке, который как раз подойдет для использования в конфигурации Telegraf.</p><p><code>&lt;PARAM NAME="Counter00001.Path" VALUE="\Memory\% Committed Bytes In Use"/></code></p><p>Ну вот и все, теперь вы сами сможете добавлять интересующие вас метрики Exchange, и не только его, на дашборд системы мониторинга.</p><p>Ну а мне остается только перечислить те метрики, которые я использовал в своей работе.</p><p>Общие параметры производительности сервера. Наиболее показательные</p><pre><code>Processor\% Processor Time
LogicalDisk(D:)\% Disk Time</code></pre><p>Подключение клиентов Outlook. Очень полезная метрика. Наглядно отображает, сколько сейчас подключено клиентов. На дашборде можно сразу заметить аномалии, если происходит массовое отключение клиентов от сервера.</p><pre><code>MSExchange RpcClientAccess\User Count
MSExchange RpcClientAccess\Connection Count

# Подключение клиентов по протоколу IMAP.

MSExchangeImap4\Current Connections
MSExchangeImap4\Request rate

# Подключение клиентов по протоколу Activeync

MSExchange ActiveSync\Requests/sec
MSExchange ActiveSync\Current Requests
MSExchange ActiveSync\Sync Commands/sec

# Подключение клиентов через службу Outlook Anywhere, а также через веб-интерфейс 

W3SVC_W3WP\Requests / Sec</code></pre><p>Состояние репликации базы данных почтовых ящиков. Актуально для инсталляций, которые используют DAG (database availability group).</p><pre><code>MSExchange Replication(_total)/CopyQueueLength
MSExchange Replication(_total)/ReplayQueueLength</code></pre><p>Ну и как обещал, прикладываю свою конфигурацию секции Inputs, содержащую все вышеперечисленные метрики.</p><details class="spoiler"><summary>Конфигурация секции Inputs</summary><div class="spoiler__content"><pre><code>[[inputs.win_perf_counters]]
  [[inputs.win_perf_counters.object]]
    ObjectName = "Processor"
    Instances = ["*"]
    Counters = [
      "% Processor Time",
    ]
    Measurement = "ex_win_cpu"
    IncludeTotal=true

[[inputs.win_perf_counters]]
  [[inputs.win_perf_counters.object]]
    ObjectName = "MSExchange RpcClientAccess"
    Counters = [
      "User Count",
      "Connection Count",
    ]
    Measurement = "ex__RpcClientAccess"
    Instances = ["------"]

[[inputs.win_perf_counters]]
  [[inputs.win_perf_counters.object]]
    ObjectName = "MSExchangeImap4"
    Counters = [
      "Current Connections",
      "Request rate",
    ]
    Measurement = "ex__MSExchangeImap4"
    Instances = ["*"]
    IncludeTotal=true
	
[[inputs.win_perf_counters]]
  [[inputs.win_perf_counters.object]]
    ObjectName = "MSExchange ActiveSync"
    Counters = [
      "Requests/sec",
      "Current Requests",
    ]
    Measurement = "ex__MSExchangeActiveSync"
    Instances = ["*"]
    IncludeTotal=true
	
[[inputs.win_perf_counters]]
  [[inputs.win_perf_counters.object]]
    ObjectName = "W3SVC_W3WP"
    Counters = [
      "Requests / Sec",
    ]
    Measurement = "ex__W3SVC_W3WP"
    Instances = ["*"]
    IncludeTotal=true

[[inputs.win_perf_counters]]
  [[inputs.win_perf_counters.object]]
    ObjectName = "MSExchange Replication(_total)"
    Counters = [
      "CopyQueueLength",
      "ReplayQueueLength",
    ]
    Measurement = "ex_DB_Replication"
    Instances = ["------"]

[[inputs.win_perf_counters]]
  [[inputs.win_perf_counters.object]]
    ObjectName = "LogicalDisk(D:)"
    Counters = [
      "% Disk Time",
    ]
    Measurement = "ex__LogicalDisk(D:)"
    Instances = ["------"]</code></pre></div></details><p>А вот пример того, как может выглядеть дашборд, когда вы добавите на него интересующие вас метрики сервера Exchange.</p><figure class="full-width "><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/eb8/65e/72a/eb865e72a72aeea56a0a61f8df024ebe.jpg" width="1280" height="411" data-src="https://habrastorage.org/getpro/habr/upload_files/eb8/65e/72a/eb865e72a72aeea56a0a61f8df024ebe.jpg" data-blurred="true"/><figcaption></figcaption></figure><p>Спасибо всем, кто дочитал статью до конца.</p></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bexchange%5D" class="tm-tags-list__link">exchange</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bmonitoring%5D" class="tm-tags-list__link">monitoring</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bgrafana%5D" class="tm-tags-list__link">grafana</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Btelegraf%5D" class="tm-tags-list__link">telegraf</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Binfluxdb%5D" class="tm-tags-list__link">influxdb</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BF%D0%BE%D1%87%D1%82%D0%BE%D0%B2%D1%8B%D0%B9%20%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%5D" class="tm-tags-list__link">почтовый сервер</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/linux/" class="tm-hubs-list__link">
    Настройка Linux
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/open_source/" class="tm-hubs-list__link">
    Open source
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/sys_admin/" class="tm-hubs-list__link">
    Системное администрирование
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 11: ↑11 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 11: ↑11 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+11</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">3.6K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    30
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/Igolu/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/586/af7/c7f/586af7c7fd6e9040d0b60dc436c2acf2.jpg" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 6 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    6
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">11</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Игорь</span> <a href="/ru/users/Igolu/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @Igolu
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Системный администратор</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/585218/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 6 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/585218/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/585218/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"585218":{"id":"585218","timePublished":"2021-10-24T16:14:18+00:00","isCorporative":false,"lang":"ru","titleHtml":"А твой Exchange в полном порядке? Как бесплатно мониторить здоровье сервера","leadData":{"textHtml":"\u003Cp\u003EВсем привет. Меня зовут Игорь -&nbsp;я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в компании NUT.Tech.\u003C\u002Fp\u003E\u003Cp\u003EУже более 10-ти лет я так или иначе сталкиваюсь с различными задачами, связанными с администрированием Microsoft Exchange Server. В основном – ничего сложного, обычные прикладные задачи вроде создания в системе новых почтовых ящиков и решения различных проблем с доставкой почтовых сообщений. Но так или иначе у меня накопилась некоторая экспертиза в этом вопросе.\u003C\u002Fp\u003E\u003Cp\u003EОсновная идея этой статьи – рассказать о решении, которое позволяет быстро и без затрат реализовать мониторинг Exchange сервера, используя популярные open source решения.\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F9f0\u002F3ea\u002F7c3\u002F9f03ea7c3d4320d3b535fa95ebb5e961.png","fit":"cover","positionY":0,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[{"type":"sandbox","data":null}],"author":{"scoreStats":{"score":6,"votesCount":6},"rating":11,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"2799715","alias":"Igolu","fullname":"Игорь","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F586\u002Faf7\u002Fc7f\u002F586af7c7fd6e9040d0b60dc436c2acf2.jpg","speciality":"Системный администратор"},"statistics":{"commentsCount":6,"favoritesCount":30,"readingCount":3587,"score":11,"votesCount":11},"hubs":[{"relatedData":null,"id":"36","alias":"linux","type":"collective","title":"Настройка Linux","titleHtml":"Настройка Linux","isProfiled":true},{"relatedData":null,"id":"144","alias":"open_source","type":"collective","title":"Open source","titleHtml":"Open source","isProfiled":true},{"relatedData":null,"id":"221","alias":"sys_admin","type":"collective","title":"Системное администрирование","titleHtml":"Системное администрирование","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"6","alias":"admin","title":"Администрирование"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cp\u003EВсем привет. Меня зовут Игорь - я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в компании NUT.Tech.\u003C\u002Fp\u003E\u003Cp\u003EУже более 10-ти лет я так или иначе сталкиваюсь с различными задачами, связанными с администрированием Microsoft Exchange Server. В основном – ничего сложного, обычные прикладные задачи вроде создания в системе новых почтовых ящиков и решения различных проблем с доставкой почтовых сообщений. Но так или иначе у меня накопилась некоторая экспертиза в этом вопросе.\u003C\u002Fp\u003E\u003Cp\u003EОсновная идея этой статьи – рассказать о решении, которое позволяет быстро и без затрат реализовать мониторинг Exchange сервера, используя популярные open source решения.\u003C\u002Fp\u003E\u003Cp\u003EЗнание этих несложных инструментов и умение применять их на практике позволят вам детализировать мониторинг Exchange практически до любого уровня, а также откроют возможности для осуществления мониторинга большого числа других сервисов и компонентов вашей инфраструктуры.\u003C\u002Fp\u003E\u003Cp\u003EMicrosoft Exchange можно условно назвать \"коробочным решением\" в том плане, что, несмотря на некоторую сложность в его внедрении (требуется инфраструктура ADDS, опыт работы с продуктами MS, покупка лицензий и.т.д.), после установки и настройки, он просто работает и ничего особенного с ним не происходит. Сообщения принимаются и отправляются, Outlook стабильно подключается к серверу, а веб-интерфейс OWA (Outlook Web Access) радует пользователей.\u003C\u002Fp\u003E\u003Cp\u003EНа мой субъективный взгляд такая вот \"коробочная\" особенность Exchange позволяет рядовому офисному администратору, который оказался ответственным за Exchange, особо не задумываться о том, а насколько же в действительности хорошо или плохо функционирует корпоративный почтовый сервер. Скорее всего такой админ не совершает проактивных действий по предотвращению возможных инцидентов с почтой, а о многих неполадках узнает от пользователей или, еще хуже, от своего руководства. Согласитесь, неприятно оказаться в ситуации, когда звонит начальник и сообщает, что он уже несколько часов назад отправил одно очень важное письмо, а партнеры его до сих пор не получили. И уже после проведения диагностики оказывается, что сервер перестал отправлять внешние сообщения, т.к. ваш IP адрес оказался в черном списке, при этом внутренняя почта продолжает работать и нет никаких признаков, что существует проблема.\u003C\u002Fp\u003E\u003Cp\u003EСамо собой, в крупных компаниях, где IT направление в целом находится на высоком уровне, скорее всего применяются коммерческие системы мониторинга, в которых есть готовые шаблоны по мониторингу Exchange и на которые можно полностью положиться, особо не вдаваясь в детали различных показателей работы сервиса и того, как они могут влиять на его состояние. С другой стороны, небольшие компании по примеру тех, в которых мне довелось работать, вряд ли готовы закладывать в свой бюджет расходы на энтерпрайз систему мониторинга. Администраторы в таких компаниях, как правило, загружены рутинной работой, и не горят желанием разбираться с метриками Exchange сервера, тем более что \"Почту настраивал предыдущий админ, я тут работаю уже пару лет, и она еще ни разу не ломалась\". Да, такой подход имеет место быть. И я не говорю, что он совсем неприменим. Даже наоборот, Exchange действительно довольно стабильная система и, на самом деле, можно несколько лет с ней ничего не делать, и она будет работать без каких-либо проблем.\u003C\u002Fp\u003E\u003Cp\u003EНо статья же не об этом, правильно? Давайте перейдем ближе к делу.\u003C\u002Fp\u003E\u003Cp\u003EОднажды, будучи таким вот офисным админом, я задумался о том, что, в действительности, я не располагаю какой-либо оперативной информацией о состоянии сервиса. Я имею в виду, что у меня под рукой совсем нет никаких показателей, на которые я бы мог посмотреть и понять работает ли почта. Да, конечно, я в любой момент могу зайти на сервер по RDP или подключиться удаленно через консоль или PowerShell, зайти на нем в пару мест и понять, что с сервером ничего плохого не происходит - почта приходит и уходит, клиенты подключаются, все хорошо. Но для совершения этих действий мне бы пришлось отвлечься от других задач, ненадолго, но выпасть из рабочего процесса, да и зачем мне лазить на сервер, когда ничего не случилось, и я уверен, что он в полном порядке.\u003C\u002Fp\u003E\u003Cp\u003EСпустя некоторое время, разрешив свой внутренний конфликт и немного поразмыслив, я решил, что для дальнейшего душевного спокойствия мне хотелось бы иметь дашборд (сводную информацию) с какими-то основными метриками, которые бы помещались на одном экране и на которые я мог бы периодически поглядывать и визуально оценивать текущее здоровье сервиса.\u003C\u002Fp\u003E\u003Cp\u003EТак как до этого момента мне не приходилось иметь дело с системами мониторинга, я не особо понимал, как можно осуществить задуманное и с чего вообще начать. Немного пообщавшись со своими более опытными коллегами в НАТ.Тех и изучив доступную в интернете информацию, я довольно быстро нашел несколько популярных open source продуктов, которые в дальнейшем и помогли мне реализовать задачу мониторинга MS Exchange Server.\u003C\u002Fp\u003E\u003Cp\u003EДля всех этих продуктов в интернете существует большое количество документации, всевозможных мануалов и инструкций, так что для тех, кто уже знаком с ними я ничего нового не расскажу, но постараюсь рассказать про некоторые интересные моменты, с которыми я столкнулся в процессе настройки. Также, я надеюсь, что эта статья будет полезна тем, кто, как и я, никогда на разворачивал системы мониторинга для Exchange.\u003C\u002Fp\u003E\u003Cp\u003EИтак, примерно разобравшись с тем, как должна выглядеть архитектура моего сервиса, я пришел к следующей схеме по её реализации.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"253\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F58c\u002Fb01\u002F4d5\u002F58cb014d5eb617a7920fad1931608412.png\" data-width=\"378\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003E\u003Cstrong\u003ETelegraf.\u003C\u002Fstrong\u003E Агент для сбора и передачи метрик с сервера Exchange. \u003Ca href=\"https:\u002F\u002Fwww.influxdata.com\u002Ftime-series-platform\u002Ftelegraf\u002F\" rel=\"noopener noreferrer nofollow\"\u003Ehttps:\u002F\u002Fwww.influxdata.com\u002Ftime-series-platform\u002Ftelegraf\u002F\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cstrong\u003EInfluxDB. \u003C\u002Fstrong\u003EБаза данных для хранения данных в виде временных рядов. (Time series database) \u003Ca href=\"https:\u002F\u002Fwww.influxdata.com\u002F\" rel=\"noopener noreferrer nofollow\"\u003Ehttps:\u002F\u002Fwww.influxdata.com\u002F\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cstrong\u003EGrafana.\u003C\u002Fstrong\u003E Веб-платформа для аналитики и интерактивной визуализации данных из различных источников.\u003Cstrong\u003E \u003C\u002Fstrong\u003E\u003Ca href=\"https:\u002F\u002Fgrafana.com\u002F\" rel=\"noopener noreferrer nofollow\"\u003Ehttps:\u002F\u002Fgrafana.com\u002F\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003E\u003Cem\u003EДля простоты, все компоненты, кроме агента Telegraf, я установлю на одной виртуальной машине с OS CentOS 7. Агент необходимо установить на сервер Exchange.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Ch2\u003EНачнем с установки базы данных InfluxDB.\u003C\u002Fh2\u003E\u003Cp\u003EНа странице \u003Ca href=\"https:\u002F\u002Fportal.influxdata.com\u002Fdownloads\u002F\" rel=\"noopener noreferrer nofollow\"\u003Ehttps:\u002F\u002Fportal.influxdata.com\u002Fdownloads\u002F\u003C\u002Fa\u003E выберите из списка вашу OS и воспользуйтесь автоматически сгенерированной командой для загрузки и установки пакета.\u003C\u002Fp\u003E\u003Cp\u003EВ моем случае для загрузки пакета я использовал утилиту CURL, так как wget по умолчанию не установлен в CentOS 7.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Ecurl -O https:\u002F\u002Fdl.influxdata.com\u002Finfluxdb\u002Freleases\u002Finfluxdb2-2.0.7.x86_64.rpm\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eyum localinstall influxdb2-2.0.7.x86_64.rpm\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EЗапустим службу InfluxDB и добавим её в автозапуск\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Esystemctl start influxdb\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Esystemctl enable influxdb\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EВ рамках тестовой среды отключим firewall. Если планируете вводить сервис в эксплуатацию, не отключайте firewall, а произведите его настройку.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Esystemctl stop firewalld\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EДля проверки доступности сервиса со стороны Exchange можно выполнить следующую команду в PowerShell.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Ecurl -Uri IP_адрес_сервера_INFLUXDB:8086\u002Fping -UseBasicParsing\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EДолжно произойти соединение с сервером, и команда вернет ответ \u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EStatusCode: 204\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EСервис доступен.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cem\u003EВажный момент - в конце 2020 года вышла новая версия influxdb версии 2.0. В этой версии очень сильно изменилась идеология продукта. Приведенные ниже примеры подойдут только для influxdb версии 2.x. В версии 1.x алгоритм настройки будет сильно отличаться.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cp\u003EДля дальнейшей настройки воспользуемся веб-интерфейсом, который предоставляет платформа InfluxDB.\u003C\u002Fp\u003E\u003Cp\u003EВеб-интерфейс доступен по адресу \u003Ca href=\"http:\u002F\u002FIP_адрес_сервера_INFLUXDB:8086\u002F\" rel=\"noopener noreferrer nofollow\"\u003Ehttp:\u002F\u002FIP_адрес_сервера_INFLUXDB:8086\u002F\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003EПридумываем имя пользователя, пароль, название организации и название корзины (условной базы данных, в которую будут записываться наши метрики).\u003C\u002Fp\u003E\u003Cp\u003EНа следующем шаге выбираем вариант настройки \"Advanced\" - это позволит нам сразу настроить подключение для будущего агента Telegraf.\u003C\u002Fp\u003E\u003Cp\u003EДля осуществления операций по чтению и записи данных в корзину нам потребуется токен нашей учетной записи.\u003C\u002Fp\u003E\u003Cp\u003EВ веб интерфейсе в левом меню идем в раздел DATA-Tokens, щелкаем по имени вашего пользователя. Откроется окошко с параметрами токена, скопируйте его в блокнот - он нам понадобится на следующем этапе.\u003C\u002Fp\u003E\u003Cp\u003EДля того, чтобы можно было использовать InfluxQL, более простой язык запросов к базе данных, вместо более сложного FLUX, который появился в версии 2, потребуется сделать дополнительные настройки.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fdocs.influxdata.com\u002Finfluxdb\u002Fv2.0\u002Fquery-data\u002Finfluxql\u002F\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003EВот здесь есть более подробное описание, как это делается.\u003C\u002Fem\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003EСначала необходимо получить ID корзины, для которой мы настраиваем доступ по логину и паролю. В веб интерфейсе в левом меню идем в раздел DATA-Buckets. В списке найдите корзину, которую вы создали и скопируйте её ID, который отображается рядом с именем.\u003C\u002Fp\u003E\u003Cp\u003EСледующие команды выполняем в консоли вашего сервера.\u003C\u002Fp\u003E\u003Cp\u003EСоздаем пользователя, чтобы была возможность подключиться к InfluxDB, используя логин и пароль, вместо токена\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Einflux v1 auth create \\\n --username grafanauser \\\n --password grafanauser \\\n --org НАЗВАНИЕ_ОРГАНИЗАЦИИ_В_INFLUXDB \\\n --read-bucket ID_ВАШЕЙ_КОРЗИНЫ \\\n -t ТОКЕН_ВАШЕГО_ПОЛЬЗОВАТЕЛЯ\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EСоздаем привязку корзины к базе данных\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Einflux v1 dbrp create \\\n   --db test \\\n   --rp test-rp \\\n   --bucket-id ID_ВАШЕЙ_КОРЗИНЫ \\\n   --default \\\n   --org НАЗВАНИЕ_ОРГАНИЗАЦИИ_В_INFLUXDB \\\n   -t ТОКЕН_ВАШЕГО_ПОЛЬЗОВАТЕЛЯ\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EНу вот и все, теперь у нас есть первый компонент нашего сервиса мониторинга.\u003C\u002Fp\u003E\u003Ch2\u003EПереходим к установке агента Telegraf\u003C\u002Fh2\u003E\u003Cp\u003E\u003Cem\u003EДальнейшие действия необходимо производить на сервере Exchange.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fportal.influxdata.com\u002Fdownloads\u002F\" rel=\"noopener noreferrer nofollow\"\u003EСкачиваем дистрибутив для Windows тут\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EНа сайте выберете платформу Windows и увидите сгенерированные команды для загрузки и установки файлов.\u003C\u002Fp\u003E\u003Cp\u003EЭтими командами можно воспользоваться в PowerShell.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Ewget https:\u002F\u002Fdl.influxdata.com\u002Ftelegraf\u002Freleases\u002Ftelegraf-1.19.1_windows_amd64.zip -UseBasicParsing -OutFile telegraf-1.19.1_windows_amd64.zip\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EФайл загрузится не в ту директорию, где выполняется команда, а в вашу домашнюю директорию. Распаковать скаченный архив можно тут же при помощи команды.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EExpand-Archive ~\\telegraf-1.19.1_windows_amd64.zip -DestinationPath 'C:\\ProgramFiles\\InfluxData\\telegraf\\'\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EВ директории окажется два файла:\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003Etelgraf.exe\u003C\u002Fstrong\u003E - собственно сам исполняемый файл;\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003Etelegraf.conf\u003C\u002Fstrong\u003E - конфигурационный файл с настройками подключения к хранилищу данных и описанием метрик, которые будет собирать наш агент.\u003C\u002Fp\u003E\u003Cp\u003EВ этом файле практически все строки закомментированы и содержат описания возможных параметров конфигурации.  Они приведены для примера настройки различных сценариев использования агента Telegraf. Чтобы не запутаться в конфигурации, давайте самостоятельно создадим этот файл с чистого листа и добавим только те параметры, которые нам будут нужны.\u003C\u002Fp\u003E\u003Cp\u003EДля начала сделайте копию исходного файла и переименуйте его в telegraf.bak\u003C\u002Fp\u003E\u003Cp\u003EОткройте оригинальный файл, выделите в нем весь текст и удалите его, чтобы он остался совершенно пустым.\u003C\u002Fp\u003E\u003Cp\u003EОтлично.\u003C\u002Fp\u003E\u003Cp\u003EПервым делом нам нужно создать секцию \u003Cstrong\u003E[agent]\u003C\u002Fstrong\u003E. В этой секции задаются глобальные параметры работы агента. Скопируйте основные параметры.\u003C\u002Fp\u003E\u003Cp\u003EДля нас пока важен только параметр interval, который задает интервал (частоту) сбора метрик. Установите его в 5 секунд, чтобы в процессе настройки мы могли быстрее видеть новые значения метрик. В дальнейшем вы можете подобрать эти параметры под ваши требования.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E[[agent]]\n  interval = \"5s\"\n  round_interval = true\n  metric_batch_size = 1000\n  metric_buffer_limit = 10000\n  collection_jitter = \"0s\"\n  flush_jitter = \"0s\"\n  precision = \"\"\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EДалее нам нужно создать секцию \u003Cstrong\u003E[Output]\u003C\u002Fstrong\u003E, которая описывает параметры для отправки полученных агентом метрик в базу данных.\u003C\u002Fp\u003E\u003Cp\u003EВ нашем случае секция будет называться \u003Cstrong\u003E[[outputs.influxdb_v2]]\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EКонфигурирование этой секции очень простое, а, если быть точным, все параметры автоматически генерируются на стороне InfluxDB в соответствии с настройками вашей инсталляции и нам остается только скопировать эти готовые параметры.\u003C\u002Fp\u003E\u003Cp\u003EДля этого открываем веб интерфейс InfluxDB, идем в раздел Data -\u003E Telegraf и нажимаем на кнопку \"InfluxDB output plugin\"\u003C\u002Fp\u003E\u003Cp\u003EОткроется окошко с нужными нам параметрами, далее скопируем эту секцию в наш конфигурационный файл.\u003C\u002Fp\u003E\u003Cp\u003EПроверьте все параметры и убедитесь, что они соответствуют настройкам вашей инсталляции.\u003C\u002Fp\u003E\u003Cp\u003EТакже в параметр Token скопируйте ранее сохраненный токен пользователя, созданный в InfluxDB, заполните поля «organization» и «bucket» в соответствии с вашими параметрами.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E[[outputs.influxdb_v2]]\n  ## The URLs of the InfluxDB cluster nodes.\n  ##\n  ## Multiple URLs can be specified for a single cluster, only ONE of the\n  ## urls will be written to each interval.\n  ## urls exp: http:\u002F\u002F127.0.0.1:9999\n\n  urls = [\"http:\u002F\u002FIP_адрес_сервера_INFLUXDB:8086\"]\n\n  ## Token for authentication.\n  token = \"$INFLUX_TOKEN\"\n\n  ## Organization is the name of the organization you wish to write to; must exist.\n  organization = \"test\"\n\n  ## Destination bucket to write into.\n  bucket = \"test\"\n  timeout = \"5s\"\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EИ последняя секция, которая нам понадобится на данном этапе, это секция Inputs, в которой перечисляются метрики, значения которых будут отправляться в базу данных.\u003C\u002Fp\u003E\u003Cp\u003EДля примера давайте сконфигурируем метрику загрузки процессора.\u003C\u002Fp\u003E\u003Cp\u003EМетрики, относящиеся к Exchange, добавим позже, когда все компоненты сервиса будут установлены.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E[[inputs.win_perf_counters]]\n  [[inputs.win_perf_counters.object]]\n\n    # Processor usage, alternative to native, reports on a per core.\n    ObjectName = \"Processor\"\n\n    Instances = [\"*\"]\n    Counters = [\"% Idle Time\", \"% Interrupt Time\", \"% Privileged Time\", \"% User Time\", \"% Processor Time\"]\n    Measurement = \"win_cpu\"\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EДавайте запустим Telegraf в тестовом режиме и проверим, что в нашем конфиге нет никаких ошибок. В таком режиме Telegraf не отправляет метрики в базу данных, а выводит их в консоль.\u003C\u002Fp\u003E\u003Cp\u003EВ командной строке перейдите в директорию, в которую вы распаковали файлы Telegraf.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Ecd \"C:\\Program Files\\InfluxData\\telegraf\\telegraf-1.19.1\"\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003Eи выполните команду:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E.\\telegraf.exe -config telegraf.conf -test\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EКоманда запустит Telegraf с нашим конфигом и выведет несколько значений по текущей загрузке каждого ядра процессора.\u003C\u002Fp\u003E\u003Cp\u003EДля моего 4-х ядерного процессора я получил 8 строчек со значениями для каждого логического ядра.\u003C\u002Fp\u003E\u003Cp\u003EЕсли на вашей системе вы получаете метрики загрузки процессора и при запуске нет никаких ошибок, то можете запустит Telegraf уже в полноценном режиме, чтобы он отправлял метрики в наше хранилище данных с помощью команды.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Etelegraf -config telegraf.conf\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EДля дальнейшей полноценной эксплуатации вы можете установить Telegraf в качестве службы.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Etelegraf.exe --service install\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Ch2\u003EУстановка последнего и самого интересного компонента - Grafana\u003C\u002Fh2\u003E\u003Cp\u003EИдем на страничку \u003Ca href=\"https:\u002F\u002Fgrafana.com\u002Fgrafana\u002Fdownload\" rel=\"noopener noreferrer nofollow\"\u003Ehttps:\u002F\u002Fgrafana.com\u002Fgrafana\u002Fdownload\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003EНаходим нужные команды для нашей ОС. В моем случае для CentOS для загрузки и установки пакета я использую команды:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Ecurl -O https:\u002F\u002Fdl.grafana.com\u002Foss\u002Frelease\u002Fgrafana-8.0.5-1.x86_64.rpm\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Eyum install grafana-8.0.5-1.x86_64.rpm\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EКак обычно добавим сервис в автозапуск и запустим\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Esystemctl start grafana-server\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003Esystemctl enable grafana-server\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EВеб-интерфейс доступен по адресу\u003Ca href=\"http:\u002F\u002FIP_адрес_сервера_INFLUXDB:3000\u002F\" rel=\"noopener noreferrer nofollow\"\u003E http:\u002F\u002FIP_адрес_сервера_INFLUXDB:3000\u002F\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EПароль по умолчанию admin:admin\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EПервое, что необходимо сделать, это подключить нашу базу данных в качестве источника данных.\u003C\u002Fp\u003E\u003Cp\u003EВ левом меню идем в раздел Configuration (шестеренка) -\u003E Data Sources, нажимаем кнопку «Add Data source».\u003C\u002Fp\u003E\u003Cp\u003EВ списке находим и выбираем InfluxDB, откроется окно с настройками подключения.\u003C\u002Fp\u003E\u003Cp\u003EПроверяем, что в поле «Query Language» установлен InfluxQL. Это позволит нам использовать визуальный конструктор запросов к хранилищу данных.\u003C\u002Fp\u003E\u003Cp\u003EЗаполняем следующие поля:\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EРаздел HTTP\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EURL: http:\u002F\u002FIP_адрес_сервера_INFLUXDB:8086\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EРаздел InfluxDB Details\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EDatabase: test (название нашей корзины в InfluxDB)\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EUser: grafanauser\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EPassword: grafanauser\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EHTTP Method: GET\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EВсе. Нажимаем кнопку «Save and test».\u003C\u002Fp\u003E\u003Cp\u003EДолжно произойти тестовое подключение к хранилищу данных и отобразится зеленая галочка с надписью \"Data source is working\"\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"432\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F553\u002F227\u002Feee\u002F553227eee3bb02a42f496eaa3e3cedd4.png\" data-width=\"510\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EТеперь создадим новый дашборд и выведем на него наши тестовые метрики по загрузке процессора.\u003C\u002Fp\u003E\u003Cp\u003EСлева в меню идем в раздел \"Create\" иконка +, выбираем Dashboard, на дашборде в новой панели выбираем \"Add an empty panel\".\u003C\u002Fp\u003E\u003Cp\u003EОткроются настройки новой панели. Проверьте, что в качестве источника данных у вас установлен \u003Cstrong\u003EInfluxDB\u003C\u002Fstrong\u003E (так как он пока единственный источник).\u003C\u002Fp\u003E\u003Cp\u003EДалее в визуальном конструкторе запроса выбираем параметры как на скриншоте:\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"396\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc21\u002F15e\u002Fe87\u002Fc2115ee87d2c2897fd154a8dd58fafe5.png\" data-width=\"510\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЕсли все настройки выполнены верно, вы увидите график загрузки процессора.\u003C\u002Fp\u003E\u003Cp\u003EВ правой части есть различные параметры отрисовки данных на графике, можете их настроить по своему вкусу.\u003C\u002Fp\u003E\u003Cp\u003EКогда завершите все настройки, сверху нажмите кнопку Save, чтобы сохранить ваш дашборд, на котором располагается пока что только одна панель с метриками.\u003C\u002Fp\u003E\u003Cp\u003EВсе компоненты сервиса установлены и настроены. Последнее, что остается сделать, это добавить в конфигурацию агента Telegraf описание интересующих нас метрик Exchange и вывести их в отдельные графики на нашем дашборде в Grafana.\u003C\u002Fp\u003E\u003Cp\u003EРасскажу, как это сделать.\u003C\u002Fp\u003E\u003Ch2\u003EДобавляем метрики Exchange в конфигурацию Telegraf.\u003C\u002Fh2\u003E\u003Cp\u003EНаверное, все знают, что в Windows есть оснастка \u003Cstrong\u003EPerformance Monitor\u003C\u002Fstrong\u003E. Если кто-то из вас ни разу не пользовался этой штукой, в интернете полно информации.\u003C\u002Fp\u003E\u003Cp\u003EТак вот, при установке Exchange Server в систему автоматически добавляется большое количество разнообразных метрик, которые как раз можно просматривать в Performance Monitor.\u003C\u002Fp\u003E\u003Cp\u003EА в нашем агенте Telegraf очень удачно есть специальный модуль \u003Cstrong\u003E[[inputs.win_perf_counters]]\u003C\u002Fstrong\u003E , который позволяет читать любые метрики из Performance Monitor и отправлять в нашу базу данных ровно точно также как и ранее настроенные показатели загрузки процессора.\u003C\u002Fp\u003E\u003Cp\u003EДавайте добавим в конфигурацию дополнительные секции для сбора интересующих нас метрик.\u003C\u002Fp\u003E\u003Cp\u003EЯ расскажу из чего состоит конфигурация на примере одной метрики. Все остальные метрики вы сможете добавить сами по этому шаблону.\u003C\u002Fp\u003E\u003Cp\u003EТакже в конце я приложу файл конфигурации со всеми метриками, которые я использовал в своей работе.\u003C\u002Fp\u003E\u003Cp\u003EВот так выглядит конфигурация секции \u003Cstrong\u003E[[inputs.win_perf_counters]]\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E[[inputs.win_perf_counters]]\n  [[inputs.win_perf_counters.object]]\n\n    ObjectName = \"MSExchangeImap4\"\n    \n    Counters = [\n      \"Current Connections\",\n      \"Request rate\",\n    ]\n\n    Measurement = \"ex01__MSExchangeImap4\"\n\n    Instances = [\"*\"]\n\n    IncludeTotal=true\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EДля нас тут важно поле \u003Cstrong\u003EObjectName\u003C\u002Fstrong\u003E. Оно задает имя интересующего нас объекта для получения метрик. Каждый такой объект содержит свой набор различных метрик.\u003C\u002Fp\u003E\u003Cp\u003EВ поле counters перечислены метрики, которые существуют в данном объекте и значения которых мы будем отправлять в базу данных.\u003C\u002Fp\u003E\u003Cp\u003EПоле \u003Cstrong\u003EMeasurement\u003C\u002Fstrong\u003E определяет название таблицы, в которую на стороне базы данных записываются значения метрик, перечисленных в поле \u003Cstrong\u003Ecounters\u003C\u002Fstrong\u003E. Тут мы можем придумать своё название, чтобы нам легче было ориентироваться при добавлении метрик на наш дашборд.\u003C\u002Fp\u003E\u003Cp\u003EНекоторые из счетчиков подразделяются на экземпляры (Instances), например, в счетчике загрузки процессора будет 8 экземпляров.\u003C\u002Fp\u003E\u003Cp\u003EЕсли нам не нужен какой-то конкретный экземпляр счетчика, и мы хотим получить значения всех существующих экземпляров, то в поле Instances указывается *.\u003C\u002Fp\u003E\u003Cp\u003EДля некоторых счетчиков экземпляры не предусмотрены (например, для оперативной памяти), в этом случае обязательно указывать \"Instances = [\"------\"]\", иначе Telegraf сообщит об ошибке в конфигурации и не будет работать.\u003C\u002Fp\u003E\u003Cp\u003EТакже можно указать параметр IncludeTotal=true, который позволяет получить отдельной метрикой общее значение для всех экземпляров счетчика, чтобы не считать их \"вручную\".\u003C\u002Fp\u003E\u003Cp\u003EСписок всех доступных объектов можно посмотреть в оснастке Performance Monitor.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"290\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc83\u002F0b9\u002F2fa\u002Fc830b92fac565cdcab5b44a31200612f.png\" data-width=\"341\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EТакже их можно вывести с помощью команды Powershell.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EGet-Counter -List * | ft CounterSetName\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EОтфильтровать вывод можно так:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003EGet-Counter -List * | Where {$_.countersetname -like \"*processor*\"} | ft CounterSetName\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EСписок доступных счетчиков в объекте можно вывести командой:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E(Get-Counter -ListSet MSExchangeImap4).Paths\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EК сожалению, вывод команды будет зависеть от языка системы, так в русском интерфейсе эти команды будут выводить название счетчиков на русском языке.\u003C\u002Fp\u003E\u003Cp\u003EИ ожидаемо - русские названия объектов не поддерживаются в конфигурации Telegraf.\u003C\u002Fp\u003E\u003Cp\u003EСамое простое решение - это отобразить все необходимые счетчики в Performance Monitor, затем нажать кнопку \"копировать свойства\" в буфер обмена, открыть чистый блокнот и вставить туда содержимое буфера обмена.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6cc\u002Fbec\u002Ff02\u002F6ccbecf02a29b8d371a29faa0ad8f8fd.jpg\" width=\"510\" height=\"119\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6cc\u002Fbec\u002Ff02\u002F6ccbecf02a29b8d371a29faa0ad8f8fd.jpg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЭто текстовое описание текущего отображения счетчиков, в котором среди кучи параметров будет параметр PATH, значение VALUE которого содержит название объекта и счетчика на английском языке, который как раз подойдет для использования в конфигурации Telegraf.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003E&lt;PARAM NAME=\"Counter00001.Path\" VALUE=\"\\Memory\\% Committed Bytes In Use\"\u002F\u003E\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EНу вот и все, теперь вы сами сможете добавлять интересующие вас метрики Exchange, и не только его, на дашборд системы мониторинга.\u003C\u002Fp\u003E\u003Cp\u003EНу а мне остается только перечислить те метрики, которые я использовал в своей работе.\u003C\u002Fp\u003E\u003Cp\u003EОбщие параметры производительности сервера. Наиболее показательные\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003EProcessor\\% Processor Time\nLogicalDisk(D:)\\% Disk Time\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПодключение клиентов Outlook. Очень полезная метрика. Наглядно отображает, сколько сейчас подключено клиентов. На дашборде можно сразу заметить аномалии, если происходит массовое отключение клиентов от сервера.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003EMSExchange RpcClientAccess\\User Count\nMSExchange RpcClientAccess\\Connection Count\n\n# Подключение клиентов по протоколу IMAP.\n\nMSExchangeImap4\\Current Connections\nMSExchangeImap4\\Request rate\n\n# Подключение клиентов по протоколу Activeync\n\nMSExchange ActiveSync\\Requests\u002Fsec\nMSExchange ActiveSync\\Current Requests\nMSExchange ActiveSync\\Sync Commands\u002Fsec\n\n# Подключение клиентов через службу Outlook Anywhere, а также через веб-интерфейс \n\nW3SVC_W3WP\\Requests \u002F Sec\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EСостояние репликации базы данных почтовых ящиков. Актуально для инсталляций, которые используют DAG (database availability group).\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003EMSExchange Replication(_total)\u002FCopyQueueLength\nMSExchange Replication(_total)\u002FReplayQueueLength\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EНу и как обещал, прикладываю свою конфигурацию секции Inputs, содержащую все вышеперечисленные метрики.\u003C\u002Fp\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EКонфигурация секции Inputs\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cpre\u003E\u003Ccode\u003E[[inputs.win_perf_counters]]\n  [[inputs.win_perf_counters.object]]\n    ObjectName = \"Processor\"\n    Instances = [\"*\"]\n    Counters = [\n      \"% Processor Time\",\n    ]\n    Measurement = \"ex_win_cpu\"\n    IncludeTotal=true\n\n[[inputs.win_perf_counters]]\n  [[inputs.win_perf_counters.object]]\n    ObjectName = \"MSExchange RpcClientAccess\"\n    Counters = [\n      \"User Count\",\n      \"Connection Count\",\n    ]\n    Measurement = \"ex__RpcClientAccess\"\n    Instances = [\"------\"]\n\n[[inputs.win_perf_counters]]\n  [[inputs.win_perf_counters.object]]\n    ObjectName = \"MSExchangeImap4\"\n    Counters = [\n      \"Current Connections\",\n      \"Request rate\",\n    ]\n    Measurement = \"ex__MSExchangeImap4\"\n    Instances = [\"*\"]\n    IncludeTotal=true\n\t\n[[inputs.win_perf_counters]]\n  [[inputs.win_perf_counters.object]]\n    ObjectName = \"MSExchange ActiveSync\"\n    Counters = [\n      \"Requests\u002Fsec\",\n      \"Current Requests\",\n    ]\n    Measurement = \"ex__MSExchangeActiveSync\"\n    Instances = [\"*\"]\n    IncludeTotal=true\n\t\n[[inputs.win_perf_counters]]\n  [[inputs.win_perf_counters.object]]\n    ObjectName = \"W3SVC_W3WP\"\n    Counters = [\n      \"Requests \u002F Sec\",\n    ]\n    Measurement = \"ex__W3SVC_W3WP\"\n    Instances = [\"*\"]\n    IncludeTotal=true\n\n[[inputs.win_perf_counters]]\n  [[inputs.win_perf_counters.object]]\n    ObjectName = \"MSExchange Replication(_total)\"\n    Counters = [\n      \"CopyQueueLength\",\n      \"ReplayQueueLength\",\n    ]\n    Measurement = \"ex_DB_Replication\"\n    Instances = [\"------\"]\n\n[[inputs.win_perf_counters]]\n  [[inputs.win_perf_counters.object]]\n    ObjectName = \"LogicalDisk(D:)\"\n    Counters = [\n      \"% Disk Time\",\n    ]\n    Measurement = \"ex__LogicalDisk(D:)\"\n    Instances = [\"------\"]\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cp\u003EА вот пример того, как может выглядеть дашборд, когда вы добавите на него интересующие вас метрики сервера Exchange.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Feb8\u002F65e\u002F72a\u002Feb865e72a72aeea56a0a61f8df024ebe.jpg\" width=\"1280\" height=\"411\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Feb8\u002F65e\u002F72a\u002Feb865e72a72aeea56a0a61f8df024ebe.jpg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСпасибо всем, кто дочитал статью до конца.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"exchange"},{"titleHtml":"monitoring"},{"titleHtml":"grafana"},{"titleHtml":"telegraf"},{"titleHtml":"influxdb"},{"titleHtml":"почтовый сервер"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F585218\u002Fa6617c90f7bbd5f33661bef85713972a\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F585218\u002Fa6617c90f7bbd5f33661bef85713972a\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F585218\\\u002F\"},\"headline\":\"А твой Exchange в полном порядке? Как бесплатно мониторить здоровье сервера\",\"datePublished\":\"2021-10-24T19:14:18+03:00\",\"dateModified\":\"2021-10-24T19:14:18+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Игорь\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Всем привет. Меня зовут Игорь -&nbsp;я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в комп...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F585218\\\u002F#post-content-body\",\"about\":[\"h_linux\",\"h_open_source\",\"h_sys_admin\",\"f_develop\",\"f_admin\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F58c\\\u002Fb01\\\u002F4d5\\\u002F58cb014d5eb617a7920fad1931608412.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F553\\\u002F227\\\u002Feee\\\u002F553227eee3bb02a42f496eaa3e3cedd4.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fc21\\\u002F15e\\\u002Fe87\\\u002Fc2115ee87d2c2897fd154a8dd58fafe5.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fc83\\\u002F0b9\\\u002F2fa\\\u002Fc830b92fac565cdcab5b44a31200612f.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F6cc\\\u002Fbec\\\u002Ff02\\\u002F6ccbecf02a29b8d371a29faa0ad8f8fd.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Feb8\\\u002F65e\\\u002F72a\\\u002Feb865e72a72aeea56a0a61f8df024ebe.jpg\"]}","metaDescription":"Всем привет. Меня зовут Игорь -&nbsp;я занимаюсь администрированием  офисной инфраструктуры, руковожу отделом мониторинга и технической поддержки пользователей в компании NUT.Tech.Уже более 10-ти лет...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"linux,open_source,sys_admin"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
