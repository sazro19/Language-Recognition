<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Как я сэкономил 5000 долларов дроплетом за 5 баксов / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/581974\/"},"headline":"Как я сэкономил 5000 долларов дроплетом за 5 баксов","datePublished":"2021-10-18T09:20:02+03:00","dateModified":"2021-10-18T10:40:28+03:00","author":{"@type":"Person","name":"PatientZero"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"С 20 ноября 2020 года Docker начал ограничивать по количеству передач запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей,...","url":"https:\/\/habr.com\/ru\/post\/581974\/#post-content-body","about":["h_virtualization","h_s_admin","f_admin"],"image":["https:\/\/habrastorage.org\/webt\/2x\/kl\/t1\/2xklt1jqexivcwld7zwjzfdxx8g.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Как я сэкономил 5000 долларов дроплетом за 5 баксов" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Как я сэкономил 5000 долларов дроплетом за 5 баксов" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Как я сэкономил 5000 долларов дроплетом за 5 баксов" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="С 20 ноября 2020 года Docker начал ограничивать по количеству передач запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей, анонимных и бесплатных. После..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="С 20 ноября 2020 года Docker начал ограничивать по количеству передач запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей, анонимных и бесплатных. После..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="С 20 ноября 2020 года Docker начал ограничивать по количеству передач запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей, анонимных и бесплатных. После..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="С 20 ноября 2020 года Docker начал ограничивать по количеству передач запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей, анонимных и бесплатных. После..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="С 20 ноября 2020 года Docker начал ограничивать по количеству передач запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей, анонимных и бесплатных. После..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/581974/313ffb33261f3eff321620df51761cd0/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/581974/313ffb33261f3eff321620df51761cd0/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/581974/313ffb33261f3eff321620df51761cd0/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/581974/313ffb33261f3eff321620df51761cd0/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/581974/313ffb33261f3eff321620df51761cd0/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="581974" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-18T06:20:02.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/581974/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/581974/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/581974/313ffb33261f3eff321620df51761cd0/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/PatientZero/" title="PatientZero" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/8de/9c5/34a/8de9c534a18a6cb8693270a2b528d4c0.png" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/PatientZero/" class="tm-user-info__username">
      PatientZero
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-18T06:20:02.000Z" title="2021-10-18, 09:20">18  октября   в 09:20</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Как я сэкономил 5000 долларов дроплетом за 5 баксов</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/virtualization/" class="tm-article-snippet__hubs-item-link"><span>Виртуализация</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/s_admin/" class="tm-article-snippet__hubs-item-link"><span>Серверное администрирование</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <div class="tm-article-snippet__labels"><div class="tm-article-snippet__label"><span>
        Перевод
      </span></div><div class="tm-article-snippet__label"><span>
        Tutorial
      </span></div></div> <!----> <!----></div></div> <div class="tm-article-presenter__origin"><a href="https://earthly.dev/blog/pull-through-cache/" target="_blank" class="tm-article-presenter__origin-link">
                Автор оригинала:
                <span>
                  Corey Larson
                </span></a></div> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/2x/kl/t1/2xklt1jqexivcwld7zwjzfdxx8g.png"/></div><br/>
С 20 ноября 2020 года Docker начал <a href="https://docs.docker.com/docker-hub/download-rate-limit/" rel="nofollow noopener noreferrer">ограничивать по количеству передач</a> запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей, анонимных и бесплатных. После внедрения изменения процесс работы разработчиков по всему миру резко затормозил. Для решения проблемы многим просто было достаточно залогиниться (для залогиненных аккаунтов уровень ограничения передачи выше), однако другим потребовалось платить за <a href="https://docs.docker.com/docker-hub/service-accounts/" rel="nofollow noopener noreferrer">сервисный аккаунт</a>. При высоких нагрузках сервисные аккаунты могут быть дорогими.<br/>
<br/>
Нет ничего плохого в том, чтобы решать проблемы деньгами. Возможно, в вашей ситуации это даже будет правильным решением. Однако для других реальность может быть не такой приятной.<br/>
<br/>
Работая в Earthly, я столкнулся с этими ограничениями передачи. Для создания контейнированной сборки приходится подтягивать <em>кучу</em> контейнеров, и делать это часто. За пару часов мы 2-3 раза запускали наш тестовый набор, что приводило к активации ограничения передачи… и с каждым новым тестом ситуация становилась всё хуже. Возможно, это вам знакомо?<br/>
<br/>
Поэтому вместо того, чтобы платить за сервисный аккаунт я настроил <em>Pull-Through Cache</em>, служащий посредником для всех запросов к Docker Hub. После его создания все отказы, вызванные ограничениями передачи, исчезли. Кроме того, это дешевле, чем платить за сервисный аккаунт! Чтобы сэкономить вам время, я задокументировал то, что сделал.<br/>
<a name="habracut"></a><br/>
<h2>Что такое Pull-Through Cache?</h2><br/>
Прежде чем вдаваться в подробности нашей системы в Earthly, давайте разберёмся, чем является и чем <i>не является</i> pull-through cache.<br/>
<br/>
С точки зрения клиента, pull-through cache — это просто обычный реестр. Ну или почти. Например, <a href="https://docs.docker.com/registry/configuration/#proxy" rel="nofollow noopener noreferrer">в него нельзя пушить образы</a>. Но из него можно пуллить. Когда из кэша впервые запрашивается образ (или его метаданные), он прозрачно получается из репозитория вверх по потоку. При последующих запросах будет использоваться кэшированная версия.<br/>
<br/>
Подобная схема работает особенно хорошо, когда извлекаемые образы меняются нечасто. Хотя для обеспечения <i>повторяемости</i> обычно рекомендуют использовать определённые тэги, применение этой практики при работе с кэшем приведёт и к снижению количества циклов прохождения пути туда и обратно. Разве нам нужна ещё одна причина не пользоваться <code>:latest</code>?<br/>
<br/>
Разумеется, существуют дополнительные методы и инструменты, которые можно использовать для кэширования образов. В частности, есть удобный <a href="https://github.com/rpardini/docker-registry-proxy" rel="nofollow noopener noreferrer"><code>rpardini/docker-registry-proxy</code></a>, использующий прокси <code>nginx</code> и кэширующий запросы; принцип работы похож на <a href="https://earthly.dev/blog/mitmproxy" rel="nofollow noopener noreferrer">MITM Proxy</a>. В других реестрах есть режимы кэширования, например <a href="https://www.jfrog.com/confluence/display/JFROG/Repository+Management#RepositoryManagement-RemoteRepositories" rel="nofollow noopener noreferrer">Artifactory</a> и <a href="https://cloud.google.com/container-registry/docs/pulling-cached-images" rel="nofollow noopener noreferrer">GCP</a>.<br/>
<br/>
В этой статье я рассмотрю стандартный реестр Docker, находящийся в (<a href="https://github.com/distribution/distribution" rel="nofollow noopener noreferrer"><code>distribution/distribution</code></a>), потому что он прост и хорошо задокументирован. Если вы хотите сразу перейти к делу, то <a href="https://github.com/earthly/ci-examples/tree/main/pull-through-cache" rel="nofollow noopener noreferrer">вся наша работа выложена на GitHub</a>.<br/>
<br/>
<h2>Получение реестра</h2><br/>
Каноническим реестром является <a href="https://hub.docker.com/_/registry" rel="nofollow noopener noreferrer"><code>registry:2</code></a>. Можно получить его, просто выполнив <code>docker pull registry:2</code>. Однако есть некоторые тонкости, изложенные ниже в разделе «HTTPS».<br/>
<br/>
<h2>Конфигурирование реестра</h2><br/>
В процессе разбора опций, которые вам может понадобиться настроить для вашего pull-through cache, я буду делиться фрагментами из готового <a href="https://github.com/earthly/ci-examples/tree/main/pull-through-cache/terraform/module/cloud-init.yaml#L38-72" rel="nofollow noopener noreferrer">примера файла конфигурации</a>. Если какая-то часть информации подходит вам не полностью, то существует достаточно исчерпывающая <a href="https://docs.docker.com/registry/configuration/" rel="nofollow noopener noreferrer">документация по конфигурированию реестра</a>.<br/>
<br/>
<h3>Режим прокси</h3><br/>
Чтобы использовать реестр Distribution как pull-through cache, вам нужно сообщить ему о необходимости работать в качестве кэша, что неудивительно. Это можно сделать при помощи ключа верхнего уровня <a href="https://docs.docker.com/registry/configuration/#proxy" rel="nofollow noopener noreferrer"><code>proxy</code></a>.<br/>
<br/>
<blockquote><code>proxy:<br/>
 remoteurl: https://registry-1.docker.io<br/>
 username: my_dockerhub_user<br/>
 password: my_dockerhub_password</code></blockquote><br/>
Стоит заметить, что <code>username</code> и <code>password</code> в этом разделе <em>не</em> являются идентификационными данными, которые вы будете использовать для логина в кэш; это идентификационные данные, которые будет использовать кэш, чтобы пуллить сверху по потоку в <code>remoteurl</code>.<br/>
<br/>
По умолчанию кэш <em>не</em> будет аутентифицировать пользователей. Это означает, что без настройки аутентификации для зеркала (см. ниже), <strong>любые частные репозитории, доступные в <code>my_dockerhub_user</code>, по сути станут публичными</strong>. Убедитесь, что вы делаете всё правильно, чтобы избежать утечки уязвимой информации!<br/>
<br/>
<h3>Аутентификация в кэше</h3><br/>
Чтобы сторонние люди не пуллили ваши частные образы или не тратили драгоценный трафик, зеркало должно быть защищено какой-нибудь аутентификацией. Её можно реализовать при помощи ключа верхнего уровня <a href="https://docs.docker.com/registry/configuration/#auth" rel="nofollow noopener noreferrer"><code>auth</code></a>:<br/>
<br/>
<blockquote><code>auth:<br/>
 htpasswd:<br/>
 realm: basic-realm<br/>
 path: /auth/htpasswd</code></blockquote><br/>
Так как я работаю с относительно небольшой командой, достаточно использовать статичные имя пользователя/пароль в стандартном файле <code>htpasswd</code>. Если вам нужна помощь в генерировании файла <code>htpasswd</code>, то прочитайте <a href="https://httpd.apache.org/docs/2.4/programs/htpasswd.html" rel="nofollow noopener noreferrer">документацию по Apache</a>.<br/>
<br/>
<em>Не</em> используйте тип аутентификации <code>silly</code>, так как он предназначен только для разработки. Это должно быть понятно из названия (ну, мы надеемся).<br/>
<br/>
Система <code>token</code> должна позволить вам подключить её к имеющейся в компании структуре аутентификации. Обычно она присутствует в крупных организациях и для подобного окружения подойдёт больше.<br/>
<br/>
<h3>HTTPS</h3><br/>
Инфраструктура нашей компании находится в домене <code>.dev</code>. Весь <code>.dev</code> использует <a href="https://hstspreload.org/" rel="nofollow noopener noreferrer">HSTS</a>. Это означает, что я не могу просто оставить наш кэш на HTTP. Кроме того, в современную эпоху <a href="https://letsencrypt.org/" rel="nofollow noopener noreferrer">Let’s Encrypt</a> всё это довольно просто настроить, не так ли?<br/>
<br/>
Ну, типа того. На момент написания статьи существует <a href="https://github.com/docker/distribution-library-image/issues/96" rel="nofollow noopener noreferrer">проблема с образом по умолчанию</a> и <a href="https://github.com/distribution/distribution/issues/3041" rel="nofollow noopener noreferrer">похожая проблема вверх по потоку для самой программы реестра</a>. Так как Let’s Encrypt отключил соответствующие API, а образ по умолчанию очень стар, вам придётся использовать одно из трёх решений:<br/>
<br/>
<h4>Скомпилировать реестр</h4><br/>
<a href="https://github.com/earthly/registry" rel="nofollow noopener noreferrer">Это решение использовал я</a>. Можно просто обернуть существующий образ <code>registry</code> в ещё один Dockerfile при помощи <code>FROM registry:2</code> (или использовать Earthfile) и заменить двоичный файл другим, собранным из исходников <code>distribution/registry</code>.<br/>
<br/>
После этого достаточно будет настроить его следующим образом при помощи ключа <a href="https://docs.docker.com/registry/configuration/#letsencrypt" rel="nofollow noopener noreferrer"><code>http.letsencrypt</code></a>:<br/>
<br/>
<blockquote><code>tls:<br/>
 letsencrypt:<br/>
 cachefile: /certs/cachefile<br/>
 email: me@my_domain.dev<br/>
 hosts: [mirror.my_domain.dev]</code></blockquote><br/>
Благодаря этому Let’s Encrypt выпустит сертификат для доменов в ключе <code>hosts</code> и будет автоматически поддерживать его актуальность.<br/>
<br/>
<h4>Загрузка сертификатов вручную</h4><br/>
Вы можете загрузить собственные сертификаты при помощи ключа <a href="https://docs.docker.com/registry/configuration/#tls" rel="nofollow noopener noreferrer"><code>https.tls</code></a>. При этом нельзя использовать старые или поломанные библиотеки Let’s Encrypt в образе по умолчанию. При необходимости вы можете настроить <a href="https://certbot.eff.org/docs/" rel="nofollow noopener noreferrer"><code>certbot</code> для обработки их вручную</a>.<br/>
<br/>
<h4>Реверсный прокси</h4><br/>
Это был наш второй вариант после компилироваться собственной версии. Использование чего-то наподобие <a href="https://doc.traefik.io/traefik/getting-started/quick-start/" rel="nofollow noopener noreferrer">Traefik</a> со встроенной поддержкой для Let’s Encrypt — стандартная практика, и она упомянута в указанных выше описаниях проблем как возможное решение.<br/>
<br/>
<h3>Хранилище</h3><br/>
Так как реестр — это просто кэш, и он не критичен, я решил сохранять кэш просто в локальное дисковое пространство на VPS, в котором я развернул систему. К тому же, метаданные для образов тоже не так критичны, поэтому я решил разместить их в памяти. Подробнее об этих опциях можно прочитать в ключах <a href="https://github.com/docker/docker.github.io/blob/master/registry/storage-drivers/filesystem.md" rel="nofollow noopener noreferrer"><code>storage.filesystem</code></a> и <a href="https://docs.docker.com/registry/configuration/#cache" rel="nofollow noopener noreferrer"><code>storage.cache</code></a>.<br/>
<br/>
<blockquote><code>storage:<br/>
 cache:<br/>
 blobdescriptor: inmemory<br/>
 filesystem:<br/>
 rootdirectory: /var/lib/registry</code></blockquote><br/>
Существуют и другие драйверы хранилищ. В корневом ключе <a href="https://docs.docker.com/registry/configuration/#storage" rel="nofollow noopener noreferrer"><code>storage</code></a> подробно описаны доступные драйверы.<br/>
<br/>
<h3>Прочие мелкие улучшения</h3><br/>
Я <em>уже</em> добавил множество опций настройки… так почему бы не добавить ещё немного? Вот какие улучшения я добавил ещё:<br/>
<br/>
Проверка состояния хранилища (на случай, если в кэше начнёт заканчиваться место или произойдут другие странности с VPC):<br/>
<br/>
<blockquote><code>health:<br/>
 storagedriver:<br/>
 enabled: true<br/>
 interval: 10s<br/>
 threshold: 3</code></blockquote><br/>
Настройка порта, который будет слушать реестр. Закомментированная часть настраивает порт отладки; если её пропустить, то порт отладки будет отключен. Он полезен как свидетельство того, что попадания в кэш происходят.<br/>
<br/>
Можно получить эту информацию через порт отладки (если он включен), перейдя в <code>/debug/vars</code>.<br/>
<br/>
<blockquote><code>http:<br/>
 addr: :5000<br/>
 # Uncomment to add debug to the mirror.<br/>
 # debug:<br/>
 # addr: 0.0.0.0:6000<br/>
 headers:<br/>
 X-Content-Type-Options: [nosniff]</code></blockquote><br/>
Включение логгинга на уровне info, что упрощает отладку и тестирование:<br/>
<br/>
<blockquote><code>log:<br/>
 level: info<br/>
 fields:<br/>
 service: registry</code></blockquote><br/>
<h2>Хостинг своего кэша</h2><br/>
После всего этого вы сможете запустить реестр локально и даже успешно к нему подключиться! Команда для этого может выглядеть так:<br/>
<br/>
<blockquote><code>docker run -d -p 443:5000 --restart=always --name=through-cache -v ./auth:/auth -v ./certs:/certs -v ./config.yaml:/etc/docker/registry/config.yml registry:2</code></blockquote><br/>
Но кэш, который находится только на вашей машине, не так полезен, как общий или как находящийся между Docker Hub и вашей CI. К счастью, его не так сложно настроить и запустить на VPS.<br/>
<br/>
Выбрать VPS для своего кэша легко — вероятно, стоит просто использовать тот, которым пользуется ваша компания. Однако я решил выбрать Digital Ocean, потому что у его разумные цены, простая настройка и щедрые лимиты.<br/>
<br/>
Большую часть времени наш кэш достаточно хорошо работал на единственном дроплете за 5 долларов, однако дополнительная нагрузка из-за CI заставила нас подняться на один уровень выше. Если ваши потребности выше, чем возможности одного узла, то всегда есть возможность <a href="https://docs.docker.com/registry/deploying/#load-balancing-considerations" rel="nofollow noopener noreferrer">запустить несколько инстансов с балансировщиком нагрузки</a> или <a href="https://docs.docker.com/registry/configuration/#example-middleware-configuration" rel="nofollow noopener noreferrer">воспользоваться CDN</a>.<br/>
<br/>
Хотя вполне можно создать инстанс VPS вручную, давайте сделаем ещё один шаг и полностью автоматизируем этот процесс при помощи <a href="https://www.terraform.io/" rel="nofollow noopener noreferrer">Terraform</a> и <a href="https://cloud-init.io/" rel="nofollow noopener noreferrer">clout-init</a>. Если вы сразу хотите перейти к делу, то <a href="https://github.com/earthly/ci-examples/tree/main/pull-through-cache/terraform" rel="nofollow noopener noreferrer">изучите полный пример</a>.<br/>
<br/>
Давайте начнём с создания инстанса VPS. В отличие от показанных выше примеров с реестром я оставлю переменные, которые использовал в нашем модуле Terraform.<br/>
<br/>
<blockquote><code>resource "digitalocean_droplet" "docker_cache" {<br/>
 image = "ubuntu-20-04-x64"<br/>
 name = "docker-cache-${var.repository_to_mirror}"<br/>
 region = "sfo3"<br/>
 size = "s-1cpu-1gb"<br/>
 monitoring = true<br/>
 ssh_keys = [var.ssh_key.fingerprint]<br/>
 user_data = data.template_file.cloud-init.rendered<br/>
}</code></blockquote><br/>
Это довольно стандартная, простая конфигурация для запуска дроплета. Но как запустить наш кэш на свежем дроплете? С помощью ключа <code>user_data</code> cloud-init. Мы используем Terraform для создания шаблона с теми же переменными, которые указаны в нашем модуле, и помещаем результат в этот раздел HCL. Вот урезанная версия нашего шаблона cloud-init:<br/>
<br/>
<blockquote><code>#cloud-config<br/>
<br/>
package_update: true<br/>
package_upgrade: true<br/>
package_reboot_if_required: true<br/>
<br/>
groups:<br/>
 - docker<br/>
<br/>
users:<br/>
 - name: griswoldthecat<br/>
 lock_passwd: true<br/>
 shell: /bin/bash<br/>
 ssh_authorized_keys:<br/>
 - ${init_ssh_public_key}<br/>
 groups: docker<br/>
 sudo: ALL=(ALL) NOPASSWD:ALL<br/>
<br/>
packages:<br/>
 - apt-transport-https<br/>
 - ca-certificates<br/>
 - curl<br/>
 - gnupg-agent<br/>
 - software-properties-common<br/>
 - unattended-upgrades<br/>
<br/>
write_files:<br/>
 - path: /auth/htpasswd<br/>
 owner: root:root<br/>
 permissions: 0644<br/>
 content: ${init_htpasswd}<br/>
<br/>
- path: /config.yaml<br/>
 owner: root:root<br/>
 permissions: 0644<br/>
 content: |<br/>
 # A parameterized version of our registry config...<br/>
<br/>
runcmd:<br/>
 - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -<br/>
 - add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"<br/>
 - apt-get update -y<br/>
 - apt-get install -y docker-ce docker-ce-cli containerd.io<br/>
 - systemctl start docker<br/>
 - systemctl enable docker<br/>
 - docker run -d -p 443:5000 --restart=always --name=through-cache -v /auth:/auth -v /certs:/certs -v /config.yaml:/etc/docker/registry/config.yml registry:2</code></blockquote><br/>
Этот шаблон cloud-init настраивает Docker, конфигурирует наш реестр и запускает контейнер.<br/>
<br/>
<h2>Используем наш кэш</h2><br/>
Пользоваться зеркалом очень просто. Достаточно <a href="https://docs.docker.com/registry/recipes/mirror/#configure-the-docker-daemon" rel="nofollow noopener noreferrer">добавить зеркало в свой список</a>, и если настроена аутентификация, выполнить <code>docker login</code> с соответствующими идентификационными данными (указанными выше данными <code>htpasswd</code>). <code>docker</code> должен запуститься автоматически и уже использовать зеркало.<br/>
<br/>
Если ваше зеркало оказывается недоступным, <code>docker</code> будет подниматься вверх по потоку без дополнительной настройки.<br/>
<br/>
<h2>Заключение</h2><br/>
Настройка и поддержка собственного pull-through cache избавили нас от головной боли и сэкономили деньги. Наша CI больше не подвержена ограничениям передачи. Это означает, что наши сборки стали более целостными, надёжными и быстрыми.</div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bdocker%5D" class="tm-tags-list__link">docker</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bdocker%20hub%5D" class="tm-tags-list__link">docker hub</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D1%8B%5D" class="tm-tags-list__link">контейнеры</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%BD%D0%B0%D1%8F%20%D0%B2%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%5D" class="tm-tags-list__link">контейнерная виртуализация</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/virtualization/" class="tm-hubs-list__link">
    Виртуализация
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/s_admin/" class="tm-hubs-list__link">
    Серверное администрирование
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 9: ↑9 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 9: ↑9 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+9</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">5.1K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    44
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/PatientZero/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/8de/9c5/34a/8de9c534a18a6cb8693270a2b528d4c0.png" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 1329 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    1201
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">91.2</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><!----> <a href="/ru/users/PatientZero/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @PatientZero
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Переводчик-фрилансер</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <button type="submit" class="tm-user-card__button btn btn_transparent btn_small">
      Задонатить
    </button> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/581974/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 16 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/581974/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/581974/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"581974":{"id":"581974","timePublished":"2021-10-18T06:20:02+00:00","isCorporative":false,"lang":"ru","titleHtml":"Как я сэкономил 5000 долларов дроплетом за 5 баксов","leadData":{"textHtml":"\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F2x\u002Fkl\u002Ft1\u002F2xklt1jqexivcwld7zwjzfdxx8g.png\"\u003E\u003C\u002Fdiv\u003E\u003Cbr\u003E\r\nС 20 ноября 2020 года Docker начал \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fdocker-hub\u002Fdownload-rate-limit\u002F\" rel=\"nofollow noopener noreferrer\"\u003Eограничивать по количеству передач\u003C\u002Fa\u003E запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей, анонимных и бесплатных. После внедрения изменения процесс работы разработчиков по всему миру резко затормозил. Для решения проблемы многим просто было достаточно залогиниться (для залогиненных аккаунтов уровень ограничения передачи выше), однако другим потребовалось платить за \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fdocker-hub\u002Fservice-accounts\u002F\" rel=\"nofollow noopener noreferrer\"\u003Eсервисный аккаунт\u003C\u002Fa\u003E. При высоких нагрузках сервисные аккаунты могут быть дорогими.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nНет ничего плохого в том, чтобы решать проблемы деньгами. Возможно, в вашей ситуации это даже будет правильным решением. Однако для других реальность может быть не такой приятной.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nРаботая в Earthly, я столкнулся с этими ограничениями передачи. Для создания контейнированной сборки приходится подтягивать \u003Cem\u003Eкучу\u003C\u002Fem\u003E контейнеров, и делать это часто. За пару часов мы 2-3 раза запускали наш тестовый набор, что приводило к активации ограничения передачи… и с каждым новым тестом ситуация становилась всё хуже. Возможно, это вам знакомо?\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nПоэтому вместо того, чтобы платить за сервисный аккаунт я настроил \u003Cem\u003EPull-Through Cache\u003C\u002Fem\u003E, служащий посредником для всех запросов к Docker Hub. После его создания все отказы, вызванные ограничениями передачи, исчезли. Кроме того, это дешевле, чем платить за сервисный аккаунт! Чтобы сэкономить вам время, я задокументировал то, что сделал.\u003Cbr\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"editorVersion":"1.0","postType":"article","postLabels":[{"type":"translation","data":{"originalAuthorName":"Corey Larson","originalUrl":"https:\u002F\u002Fearthly.dev\u002Fblog\u002Fpull-through-cache\u002F"}},{"type":"tutorial","data":null}],"author":{"scoreStats":{"score":1201,"votesCount":1329},"rating":91.2,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":"410013829899665","paymentPayPalMe":"vadimivshin","paymentWebmoney":null},"id":"78894","alias":"PatientZero","fullname":null,"avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F8de\u002F9c5\u002F34a\u002F8de9c534a18a6cb8693270a2b528d4c0.png","speciality":"Переводчик-фрилансер"},"statistics":{"commentsCount":16,"favoritesCount":44,"readingCount":5071,"score":9,"votesCount":9},"hubs":[{"relatedData":null,"id":"7312","alias":"virtualization","type":"collective","title":"Виртуализация","titleHtml":"Виртуализация","isProfiled":true},{"relatedData":null,"id":"17350","alias":"s_admin","type":"collective","title":"Серверное администрирование","titleHtml":"Серверное администрирование","isProfiled":true}],"flows":[{"id":"6","alias":"admin","title":"Администрирование"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F2x\u002Fkl\u002Ft1\u002F2xklt1jqexivcwld7zwjzfdxx8g.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\nС 20 ноября 2020 года Docker начал \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fdocker-hub\u002Fdownload-rate-limit\u002F\" rel=\"nofollow noopener noreferrer\"\u003Eограничивать по количеству передач\u003C\u002Fa\u003E запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей, анонимных и бесплатных. После внедрения изменения процесс работы разработчиков по всему миру резко затормозил. Для решения проблемы многим просто было достаточно залогиниться (для залогиненных аккаунтов уровень ограничения передачи выше), однако другим потребовалось платить за \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fdocker-hub\u002Fservice-accounts\u002F\" rel=\"nofollow noopener noreferrer\"\u003Eсервисный аккаунт\u003C\u002Fa\u003E. При высоких нагрузках сервисные аккаунты могут быть дорогими.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНет ничего плохого в том, чтобы решать проблемы деньгами. Возможно, в вашей ситуации это даже будет правильным решением. Однако для других реальность может быть не такой приятной.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРаботая в Earthly, я столкнулся с этими ограничениями передачи. Для создания контейнированной сборки приходится подтягивать \u003Cem\u003Eкучу\u003C\u002Fem\u003E контейнеров, и делать это часто. За пару часов мы 2-3 раза запускали наш тестовый набор, что приводило к активации ограничения передачи… и с каждым новым тестом ситуация становилась всё хуже. Возможно, это вам знакомо?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПоэтому вместо того, чтобы платить за сервисный аккаунт я настроил \u003Cem\u003EPull-Through Cache\u003C\u002Fem\u003E, служащий посредником для всех запросов к Docker Hub. После его создания все отказы, вызванные ограничениями передачи, исчезли. Кроме того, это дешевле, чем платить за сервисный аккаунт! Чтобы сэкономить вам время, я задокументировал то, что сделал.\u003Cbr\u002F\u003E\r\n\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EЧто такое Pull-Through Cache?\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nПрежде чем вдаваться в подробности нашей системы в Earthly, давайте разберёмся, чем является и чем \u003Ci\u003Eне является\u003C\u002Fi\u003E pull-through cache.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nС точки зрения клиента, pull-through cache — это просто обычный реестр. Ну или почти. Например, \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Fconfiguration\u002F#proxy\" rel=\"nofollow noopener noreferrer\"\u003Eв него нельзя пушить образы\u003C\u002Fa\u003E. Но из него можно пуллить. Когда из кэша впервые запрашивается образ (или его метаданные), он прозрачно получается из репозитория вверх по потоку. При последующих запросах будет использоваться кэшированная версия.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПодобная схема работает особенно хорошо, когда извлекаемые образы меняются нечасто. Хотя для обеспечения \u003Ci\u003Eповторяемости\u003C\u002Fi\u003E обычно рекомендуют использовать определённые тэги, применение этой практики при работе с кэшем приведёт и к снижению количества циклов прохождения пути туда и обратно. Разве нам нужна ещё одна причина не пользоваться \u003Ccode\u003E:latest\u003C\u002Fcode\u003E?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРазумеется, существуют дополнительные методы и инструменты, которые можно использовать для кэширования образов. В частности, есть удобный \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Frpardini\u002Fdocker-registry-proxy\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Erpardini\u002Fdocker-registry-proxy\u003C\u002Fcode\u003E\u003C\u002Fa\u003E, использующий прокси \u003Ccode\u003Enginx\u003C\u002Fcode\u003E и кэширующий запросы; принцип работы похож на \u003Ca href=\"https:\u002F\u002Fearthly.dev\u002Fblog\u002Fmitmproxy\" rel=\"nofollow noopener noreferrer\"\u003EMITM Proxy\u003C\u002Fa\u003E. В других реестрах есть режимы кэширования, например \u003Ca href=\"https:\u002F\u002Fwww.jfrog.com\u002Fconfluence\u002Fdisplay\u002FJFROG\u002FRepository+Management#RepositoryManagement-RemoteRepositories\" rel=\"nofollow noopener noreferrer\"\u003EArtifactory\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fcloud.google.com\u002Fcontainer-registry\u002Fdocs\u002Fpulling-cached-images\" rel=\"nofollow noopener noreferrer\"\u003EGCP\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ этой статье я рассмотрю стандартный реестр Docker, находящийся в (\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fdistribution\u002Fdistribution\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Edistribution\u002Fdistribution\u003C\u002Fcode\u003E\u003C\u002Fa\u003E), потому что он прост и хорошо задокументирован. Если вы хотите сразу перейти к делу, то \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fearthly\u002Fci-examples\u002Ftree\u002Fmain\u002Fpull-through-cache\" rel=\"nofollow noopener noreferrer\"\u003Eвся наша работа выложена на GitHub\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EПолучение реестра\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nКаноническим реестром является \u003Ca href=\"https:\u002F\u002Fhub.docker.com\u002F_\u002Fregistry\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Eregistry:2\u003C\u002Fcode\u003E\u003C\u002Fa\u003E. Можно получить его, просто выполнив \u003Ccode\u003Edocker pull registry:2\u003C\u002Fcode\u003E. Однако есть некоторые тонкости, изложенные ниже в разделе «HTTPS».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EКонфигурирование реестра\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nВ процессе разбора опций, которые вам может понадобиться настроить для вашего pull-through cache, я буду делиться фрагментами из готового \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fearthly\u002Fci-examples\u002Ftree\u002Fmain\u002Fpull-through-cache\u002Fterraform\u002Fmodule\u002Fcloud-init.yaml#L38-72\" rel=\"nofollow noopener noreferrer\"\u003Eпримера файла конфигурации\u003C\u002Fa\u003E. Если какая-то часть информации подходит вам не полностью, то существует достаточно исчерпывающая \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Fconfiguration\u002F\" rel=\"nofollow noopener noreferrer\"\u003Eдокументация по конфигурированию реестра\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EРежим прокси\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nЧтобы использовать реестр Distribution как pull-through cache, вам нужно сообщить ему о необходимости работать в качестве кэша, что неудивительно. Это можно сделать при помощи ключа верхнего уровня \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Fconfiguration\u002F#proxy\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Eproxy\u003C\u002Fcode\u003E\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003Eproxy:\u003Cbr\u002F\u003E\r\n remoteurl: https:\u002F\u002Fregistry-1.docker.io\u003Cbr\u002F\u003E\r\n username: my_dockerhub_user\u003Cbr\u002F\u003E\r\n password: my_dockerhub_password\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nСтоит заметить, что \u003Ccode\u003Eusername\u003C\u002Fcode\u003E и \u003Ccode\u003Epassword\u003C\u002Fcode\u003E в этом разделе \u003Cem\u003Eне\u003C\u002Fem\u003E являются идентификационными данными, которые вы будете использовать для логина в кэш; это идентификационные данные, которые будет использовать кэш, чтобы пуллить сверху по потоку в \u003Ccode\u003Eremoteurl\u003C\u002Fcode\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПо умолчанию кэш \u003Cem\u003Eне\u003C\u002Fem\u003E будет аутентифицировать пользователей. Это означает, что без настройки аутентификации для зеркала (см. ниже), \u003Cstrong\u003Eлюбые частные репозитории, доступные в \u003Ccode\u003Emy_dockerhub_user\u003C\u002Fcode\u003E, по сути станут публичными\u003C\u002Fstrong\u003E. Убедитесь, что вы делаете всё правильно, чтобы избежать утечки уязвимой информации!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EАутентификация в кэше\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nЧтобы сторонние люди не пуллили ваши частные образы или не тратили драгоценный трафик, зеркало должно быть защищено какой-нибудь аутентификацией. Её можно реализовать при помощи ключа верхнего уровня \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Fconfiguration\u002F#auth\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Eauth\u003C\u002Fcode\u003E\u003C\u002Fa\u003E:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003Eauth:\u003Cbr\u002F\u003E\r\n htpasswd:\u003Cbr\u002F\u003E\r\n realm: basic-realm\u003Cbr\u002F\u003E\r\n path: \u002Fauth\u002Fhtpasswd\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nТак как я работаю с относительно небольшой командой, достаточно использовать статичные имя пользователя\u002Fпароль в стандартном файле \u003Ccode\u003Ehtpasswd\u003C\u002Fcode\u003E. Если вам нужна помощь в генерировании файла \u003Ccode\u003Ehtpasswd\u003C\u002Fcode\u003E, то прочитайте \u003Ca href=\"https:\u002F\u002Fhttpd.apache.org\u002Fdocs\u002F2.4\u002Fprograms\u002Fhtpasswd.html\" rel=\"nofollow noopener noreferrer\"\u003Eдокументацию по Apache\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cem\u003EНе\u003C\u002Fem\u003E используйте тип аутентификации \u003Ccode\u003Esilly\u003C\u002Fcode\u003E, так как он предназначен только для разработки. Это должно быть понятно из названия (ну, мы надеемся).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСистема \u003Ccode\u003Etoken\u003C\u002Fcode\u003E должна позволить вам подключить её к имеющейся в компании структуре аутентификации. Обычно она присутствует в крупных организациях и для подобного окружения подойдёт больше.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EHTTPS\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nИнфраструктура нашей компании находится в домене \u003Ccode\u003E.dev\u003C\u002Fcode\u003E. Весь \u003Ccode\u003E.dev\u003C\u002Fcode\u003E использует \u003Ca href=\"https:\u002F\u002Fhstspreload.org\u002F\" rel=\"nofollow noopener noreferrer\"\u003EHSTS\u003C\u002Fa\u003E. Это означает, что я не могу просто оставить наш кэш на HTTP. Кроме того, в современную эпоху \u003Ca href=\"https:\u002F\u002Fletsencrypt.org\u002F\" rel=\"nofollow noopener noreferrer\"\u003ELet’s Encrypt\u003C\u002Fa\u003E всё это довольно просто настроить, не так ли?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНу, типа того. На момент написания статьи существует \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fdocker\u002Fdistribution-library-image\u002Fissues\u002F96\" rel=\"nofollow noopener noreferrer\"\u003Eпроблема с образом по умолчанию\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fdistribution\u002Fdistribution\u002Fissues\u002F3041\" rel=\"nofollow noopener noreferrer\"\u003Eпохожая проблема вверх по потоку для самой программы реестра\u003C\u002Fa\u003E. Так как Let’s Encrypt отключил соответствующие API, а образ по умолчанию очень стар, вам придётся использовать одно из трёх решений:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003EСкомпилировать реестр\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fearthly\u002Fregistry\" rel=\"nofollow noopener noreferrer\"\u003EЭто решение использовал я\u003C\u002Fa\u003E. Можно просто обернуть существующий образ \u003Ccode\u003Eregistry\u003C\u002Fcode\u003E в ещё один Dockerfile при помощи \u003Ccode\u003EFROM registry:2\u003C\u002Fcode\u003E (или использовать Earthfile) и заменить двоичный файл другим, собранным из исходников \u003Ccode\u003Edistribution\u002Fregistry\u003C\u002Fcode\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПосле этого достаточно будет настроить его следующим образом при помощи ключа \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Fconfiguration\u002F#letsencrypt\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Ehttp.letsencrypt\u003C\u002Fcode\u003E\u003C\u002Fa\u003E:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003Etls:\u003Cbr\u002F\u003E\r\n letsencrypt:\u003Cbr\u002F\u003E\r\n cachefile: \u002Fcerts\u002Fcachefile\u003Cbr\u002F\u003E\r\n email: me@my_domain.dev\u003Cbr\u002F\u003E\r\n hosts: [mirror.my_domain.dev]\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nБлагодаря этому Let’s Encrypt выпустит сертификат для доменов в ключе \u003Ccode\u003Ehosts\u003C\u002Fcode\u003E и будет автоматически поддерживать его актуальность.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003EЗагрузка сертификатов вручную\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nВы можете загрузить собственные сертификаты при помощи ключа \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Fconfiguration\u002F#tls\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Ehttps.tls\u003C\u002Fcode\u003E\u003C\u002Fa\u003E. При этом нельзя использовать старые или поломанные библиотеки Let’s Encrypt в образе по умолчанию. При необходимости вы можете настроить \u003Ca href=\"https:\u002F\u002Fcertbot.eff.org\u002Fdocs\u002F\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Ecertbot\u003C\u002Fcode\u003E для обработки их вручную\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003EРеверсный прокси\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nЭто был наш второй вариант после компилироваться собственной версии. Использование чего-то наподобие \u003Ca href=\"https:\u002F\u002Fdoc.traefik.io\u002Ftraefik\u002Fgetting-started\u002Fquick-start\u002F\" rel=\"nofollow noopener noreferrer\"\u003ETraefik\u003C\u002Fa\u003E со встроенной поддержкой для Let’s Encrypt — стандартная практика, и она упомянута в указанных выше описаниях проблем как возможное решение.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EХранилище\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nТак как реестр — это просто кэш, и он не критичен, я решил сохранять кэш просто в локальное дисковое пространство на VPS, в котором я развернул систему. К тому же, метаданные для образов тоже не так критичны, поэтому я решил разместить их в памяти. Подробнее об этих опциях можно прочитать в ключах \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fdocker\u002Fdocker.github.io\u002Fblob\u002Fmaster\u002Fregistry\u002Fstorage-drivers\u002Ffilesystem.md\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Estorage.filesystem\u003C\u002Fcode\u003E\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Fconfiguration\u002F#cache\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Estorage.cache\u003C\u002Fcode\u003E\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003Estorage:\u003Cbr\u002F\u003E\r\n cache:\u003Cbr\u002F\u003E\r\n blobdescriptor: inmemory\u003Cbr\u002F\u003E\r\n filesystem:\u003Cbr\u002F\u003E\r\n rootdirectory: \u002Fvar\u002Flib\u002Fregistry\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nСуществуют и другие драйверы хранилищ. В корневом ключе \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Fconfiguration\u002F#storage\" rel=\"nofollow noopener noreferrer\"\u003E\u003Ccode\u003Estorage\u003C\u002Fcode\u003E\u003C\u002Fa\u003E подробно описаны доступные драйверы.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EПрочие мелкие улучшения\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nЯ \u003Cem\u003Eуже\u003C\u002Fem\u003E добавил множество опций настройки… так почему бы не добавить ещё немного? Вот какие улучшения я добавил ещё:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПроверка состояния хранилища (на случай, если в кэше начнёт заканчиваться место или произойдут другие странности с VPC):\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003Ehealth:\u003Cbr\u002F\u003E\r\n storagedriver:\u003Cbr\u002F\u003E\r\n enabled: true\u003Cbr\u002F\u003E\r\n interval: 10s\u003Cbr\u002F\u003E\r\n threshold: 3\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nНастройка порта, который будет слушать реестр. Закомментированная часть настраивает порт отладки; если её пропустить, то порт отладки будет отключен. Он полезен как свидетельство того, что попадания в кэш происходят.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nМожно получить эту информацию через порт отладки (если он включен), перейдя в \u003Ccode\u003E\u002Fdebug\u002Fvars\u003C\u002Fcode\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003Ehttp:\u003Cbr\u002F\u003E\r\n addr: :5000\u003Cbr\u002F\u003E\r\n # Uncomment to add debug to the mirror.\u003Cbr\u002F\u003E\r\n # debug:\u003Cbr\u002F\u003E\r\n # addr: 0.0.0.0:6000\u003Cbr\u002F\u003E\r\n headers:\u003Cbr\u002F\u003E\r\n X-Content-Type-Options: [nosniff]\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nВключение логгинга на уровне info, что упрощает отладку и тестирование:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003Elog:\u003Cbr\u002F\u003E\r\n level: info\u003Cbr\u002F\u003E\r\n fields:\u003Cbr\u002F\u003E\r\n service: registry\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EХостинг своего кэша\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nПосле всего этого вы сможете запустить реестр локально и даже успешно к нему подключиться! Команда для этого может выглядеть так:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003Edocker run -d -p 443:5000 --restart=always --name=through-cache -v .\u002Fauth:\u002Fauth -v .\u002Fcerts:\u002Fcerts -v .\u002Fconfig.yaml:\u002Fetc\u002Fdocker\u002Fregistry\u002Fconfig.yml registry:2\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nНо кэш, который находится только на вашей машине, не так полезен, как общий или как находящийся между Docker Hub и вашей CI. К счастью, его не так сложно настроить и запустить на VPS.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВыбрать VPS для своего кэша легко — вероятно, стоит просто использовать тот, которым пользуется ваша компания. Однако я решил выбрать Digital Ocean, потому что у его разумные цены, простая настройка и щедрые лимиты.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nБольшую часть времени наш кэш достаточно хорошо работал на единственном дроплете за 5 долларов, однако дополнительная нагрузка из-за CI заставила нас подняться на один уровень выше. Если ваши потребности выше, чем возможности одного узла, то всегда есть возможность \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Fdeploying\u002F#load-balancing-considerations\" rel=\"nofollow noopener noreferrer\"\u003Eзапустить несколько инстансов с балансировщиком нагрузки\u003C\u002Fa\u003E или \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Fconfiguration\u002F#example-middleware-configuration\" rel=\"nofollow noopener noreferrer\"\u003Eвоспользоваться CDN\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nХотя вполне можно создать инстанс VPS вручную, давайте сделаем ещё один шаг и полностью автоматизируем этот процесс при помощи \u003Ca href=\"https:\u002F\u002Fwww.terraform.io\u002F\" rel=\"nofollow noopener noreferrer\"\u003ETerraform\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fcloud-init.io\u002F\" rel=\"nofollow noopener noreferrer\"\u003Eclout-init\u003C\u002Fa\u003E. Если вы сразу хотите перейти к делу, то \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fearthly\u002Fci-examples\u002Ftree\u002Fmain\u002Fpull-through-cache\u002Fterraform\" rel=\"nofollow noopener noreferrer\"\u003Eизучите полный пример\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДавайте начнём с создания инстанса VPS. В отличие от показанных выше примеров с реестром я оставлю переменные, которые использовал в нашем модуле Terraform.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003Eresource \"digitalocean_droplet\" \"docker_cache\" {\u003Cbr\u002F\u003E\r\n image = \"ubuntu-20-04-x64\"\u003Cbr\u002F\u003E\r\n name = \"docker-cache-${var.repository_to_mirror}\"\u003Cbr\u002F\u003E\r\n region = \"sfo3\"\u003Cbr\u002F\u003E\r\n size = \"s-1cpu-1gb\"\u003Cbr\u002F\u003E\r\n monitoring = true\u003Cbr\u002F\u003E\r\n ssh_keys = [var.ssh_key.fingerprint]\u003Cbr\u002F\u003E\r\n user_data = data.template_file.cloud-init.rendered\u003Cbr\u002F\u003E\r\n}\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nЭто довольно стандартная, простая конфигурация для запуска дроплета. Но как запустить наш кэш на свежем дроплете? С помощью ключа \u003Ccode\u003Euser_data\u003C\u002Fcode\u003E cloud-init. Мы используем Terraform для создания шаблона с теми же переменными, которые указаны в нашем модуле, и помещаем результат в этот раздел HCL. Вот урезанная версия нашего шаблона cloud-init:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Ccode\u003E#cloud-config\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\npackage_update: true\u003Cbr\u002F\u003E\r\npackage_upgrade: true\u003Cbr\u002F\u003E\r\npackage_reboot_if_required: true\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\ngroups:\u003Cbr\u002F\u003E\r\n - docker\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nusers:\u003Cbr\u002F\u003E\r\n - name: griswoldthecat\u003Cbr\u002F\u003E\r\n lock_passwd: true\u003Cbr\u002F\u003E\r\n shell: \u002Fbin\u002Fbash\u003Cbr\u002F\u003E\r\n ssh_authorized_keys:\u003Cbr\u002F\u003E\r\n - ${init_ssh_public_key}\u003Cbr\u002F\u003E\r\n groups: docker\u003Cbr\u002F\u003E\r\n sudo: ALL=(ALL) NOPASSWD:ALL\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\npackages:\u003Cbr\u002F\u003E\r\n - apt-transport-https\u003Cbr\u002F\u003E\r\n - ca-certificates\u003Cbr\u002F\u003E\r\n - curl\u003Cbr\u002F\u003E\r\n - gnupg-agent\u003Cbr\u002F\u003E\r\n - software-properties-common\u003Cbr\u002F\u003E\r\n - unattended-upgrades\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nwrite_files:\u003Cbr\u002F\u003E\r\n - path: \u002Fauth\u002Fhtpasswd\u003Cbr\u002F\u003E\r\n owner: root:root\u003Cbr\u002F\u003E\r\n permissions: 0644\u003Cbr\u002F\u003E\r\n content: ${init_htpasswd}\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n- path: \u002Fconfig.yaml\u003Cbr\u002F\u003E\r\n owner: root:root\u003Cbr\u002F\u003E\r\n permissions: 0644\u003Cbr\u002F\u003E\r\n content: |\u003Cbr\u002F\u003E\r\n # A parameterized version of our registry config...\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nruncmd:\u003Cbr\u002F\u003E\r\n - curl -fsSL https:\u002F\u002Fdownload.docker.com\u002Flinux\u002Fubuntu\u002Fgpg | apt-key add -\u003Cbr\u002F\u003E\r\n - add-apt-repository \"deb [arch=amd64] https:\u002F\u002Fdownload.docker.com\u002Flinux\u002Fubuntu $(lsb_release -cs) stable\"\u003Cbr\u002F\u003E\r\n - apt-get update -y\u003Cbr\u002F\u003E\r\n - apt-get install -y docker-ce docker-ce-cli containerd.io\u003Cbr\u002F\u003E\r\n - systemctl start docker\u003Cbr\u002F\u003E\r\n - systemctl enable docker\u003Cbr\u002F\u003E\r\n - docker run -d -p 443:5000 --restart=always --name=through-cache -v \u002Fauth:\u002Fauth -v \u002Fcerts:\u002Fcerts -v \u002Fconfig.yaml:\u002Fetc\u002Fdocker\u002Fregistry\u002Fconfig.yml registry:2\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nЭтот шаблон cloud-init настраивает Docker, конфигурирует наш реестр и запускает контейнер.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EИспользуем наш кэш\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nПользоваться зеркалом очень просто. Достаточно \u003Ca href=\"https:\u002F\u002Fdocs.docker.com\u002Fregistry\u002Frecipes\u002Fmirror\u002F#configure-the-docker-daemon\" rel=\"nofollow noopener noreferrer\"\u003Eдобавить зеркало в свой список\u003C\u002Fa\u003E, и если настроена аутентификация, выполнить \u003Ccode\u003Edocker login\u003C\u002Fcode\u003E с соответствующими идентификационными данными (указанными выше данными \u003Ccode\u003Ehtpasswd\u003C\u002Fcode\u003E). \u003Ccode\u003Edocker\u003C\u002Fcode\u003E должен запуститься автоматически и уже использовать зеркало.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЕсли ваше зеркало оказывается недоступным, \u003Ccode\u003Edocker\u003C\u002Fcode\u003E будет подниматься вверх по потоку без дополнительной настройки.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EЗаключение\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nНастройка и поддержка собственного pull-through cache избавили нас от головной боли и сэкономили деньги. Наша CI больше не подвержена ограничениям передачи. Это означает, что наши сборки стали более целостными, надёжными и быстрыми.\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"docker"},{"titleHtml":"docker hub"},{"titleHtml":"контейнеры"},{"titleHtml":"контейнерная виртуализация"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F581974\u002F313ffb33261f3eff321620df51761cd0\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F581974\u002F313ffb33261f3eff321620df51761cd0\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F581974\\\u002F\"},\"headline\":\"Как я сэкономил 5000 долларов дроплетом за 5 баксов\",\"datePublished\":\"2021-10-18T09:20:02+03:00\",\"dateModified\":\"2021-10-18T10:40:28+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"PatientZero\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"С 20 ноября 2020 года Docker начал ограничивать по количеству передач запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей,...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F581974\\\u002F#post-content-body\",\"about\":[\"h_virtualization\",\"h_s_admin\",\"f_admin\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F2x\\\u002Fkl\\\u002Ft1\\\u002F2xklt1jqexivcwld7zwjzfdxx8g.png\"]}","metaDescription":"С 20 ноября 2020 года Docker начал ограничивать по количеству передач запросы к его популярному реестру Docker Hub. Это изменение затронуло всех пользователей, анонимных и бесплатных. После...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":true}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"virtualization,s_admin"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
