<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Игра по правилам Event loop в Node.js / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/company\/lineate\/blog\/585050\/"},"headline":"Игра по правилам Event loop в Node.js","datePublished":"2021-10-22T19:18:19+03:00","dateModified":"2021-10-22T19:53:48+03:00","author":{"@type":"Person","name":"Илья Горкун"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Я пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на в...","url":"https:\/\/habr.com\/ru\/company\/lineate\/blog\/585050\/#post-content-body","about":["c_lineate","h_javascript","h_programming","h_nodejs","f_develop"],"image":["https:\/\/habr.com\/share\/publication\/585050\/e20e3d33ef66dfc785d05a35678f18a4\/","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/3c0\/958\/341\/3c09583419fb578379f15e058bc1725b.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/16e\/4f5\/1af\/16e4f51af60851dbe62e17a3f0beca5c.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/cc1\/df0\/501\/cc1df0501730401720ee7ca5aac31ffb.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/cd7\/f67\/284\/cd7f67284e7e30c22e84d72fcf5ecea2.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/0c2\/3c7\/edf\/0c23c7edf03698dc0894b27a05fa1ee6.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/a0b\/ae1\/3e5\/a0bae13e59c927da416d5a4482682b0d.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/bc4\/978\/c40\/bc4978c40b19553cf8fc9f40fcc955f0.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/3d9\/9e1\/1cf\/3d99e11cfdba9fa2f26a03263ff6f329.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f20\/2ef\/209\/f202ef2092fae7edc8186ab2e30bd346.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/162\/308\/2b8\/1623082b89b35c3e95c68af4a72be342.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/c34\/55c\/e65\/c3455ce65fc0d2685887168d871da03f.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/0e3\/566\/dfe\/0e3566dfe4e4f5954047894ed87a3ec1.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f48\/7e6\/fbd\/f487e6fbd2fbe20ad40cc1d6bcb7a601.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/bb7\/f9f\/ccc\/bb7f9fccc968cfc7dd690a4484f54f6a.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/a26\/ce3\/51c\/a26ce351cce41d0fe7d202840b6e12de.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/a1b\/7f9\/7da\/a1b7f97da424e6ab8ef58b3d709ce1f5.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/4a0\/041\/9f8\/4a00419f839fd04e747924ffa9b61791.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/351\/64a\/822\/35164a822f5187fe53446dfeef14b21c.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/121\/e84\/894\/121e848949f90d44ee695f4819744e07.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/6c0\/527\/4a8\/6c05274a83f366a78053b282a40b3537.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/94a\/f8a\/e7c\/94af8ae7c2e3f22fb4eefeee030aed56.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/fb1\/b23\/beb\/fb1b23beb22f7313d13cf231e21df970.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/016\/c95\/dbd\/016c95dbdfff3625023eb22c88d701e2.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/488\/9c2\/26a\/4889c226acf52adfab096655ca84ec11.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/699\/b34\/935\/699b34935247cc535f57e137bab3fee5.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/5fe\/113\/2a7\/5fe1132a76483ab6d0b574470372ea6e.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/696\/fb6\/f90\/696fb6f90e40d4018810b83c73d81d97.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/399\/b12\/2a2\/399b122a21f9860f6902ab54386d051a.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Игра по правилам Event loop в Node.js" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Игра по правилам Event loop в Node.js" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Игра по правилам Event loop в Node.js" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Я пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на возникающие у меня вопросы, но, как..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Я пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на возникающие у меня вопросы, но, как..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Я пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на возникающие у меня вопросы, но, как..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Я пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на возникающие у меня вопросы, но, как..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Я пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на возникающие у меня вопросы, но, как..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habrastorage.org/getpro/habr/upload_files/3b0/829/d02/3b0829d02464c22c12ec8109bb7c6c3f.png" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/3b0/829/d02/3b0829d02464c22c12ec8109bb7c6c3f.png" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/3b0/829/d02/3b0829d02464c22c12ec8109bb7c6c3f.png" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/3b0/829/d02/3b0829d02464c22c12ec8109bb7c6c3f.png" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/3b0/829/d02/3b0829d02464c22c12ec8109bb7c6c3f.png" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="585050" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-22T16:18:19.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/585050/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/company/lineate/blog/585050/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habrastorage.org/getpro/habr/upload_files/3b0/829/d02/3b0829d02464c22c12ec8109bb7c6c3f.png" data-vmid="image:href"><link data-vue-meta="ssr" rel="amphtml" href="https://habr.com/ru/amp/post/585050/">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" companyName="lineate" data-async-called="true" class="tm-page"><div class="tm-page-width"><div class="tm-page__header"><!----></div> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"><div class="tm-company-card tm-company-article__company-card"><div class="tm-company-card__info"><div class="tm-company-card__header"><a href="/ru/company/lineate/profile/" class="tm-company-card__avatar"><div class="tm-entity-image"><img alt="" height="48" src="//habrastorage.org/getpro/habr/company/c68/0e3/5d6/c680e35d646d65ff4db7b29cdd808f5b.png" width="48" class="tm-entity-image__pic"></div></a> <!----> <div class="tm-rating tm-company-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">34.02</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div> <div class="tm-company-card__info"><a href="/ru/company/lineate/profile/" class="tm-company-card__name">
        Lineate
      </a> <div class="tm-company-card__description"></div></div></div> <div class="tm-company-card__buttons"><!----> <!----></div></div> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/jomb_g/" title="jomb_g" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/f8d/a4f/1a9/f8da4f1a9f99f9a9dd230f6fd3082b42.png" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/jomb_g/" class="tm-user-info__username">
      jomb_g
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-22T16:18:19.000Z" title="2021-10-22, 19:18">22  октября   в 19:18</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Игра по правилам Event loop в Node.js</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/company/lineate/blog/" class="tm-article-snippet__hubs-item-link router-link-active"><span>Блог компании Lineate</span> <!----></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/javascript/" class="tm-article-snippet__hubs-item-link"><span>JavaScript</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/programming/" class="tm-article-snippet__hubs-item-link"><span>Программирование</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/nodejs/" class="tm-article-snippet__hubs-item-link"><span>Node.JS</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><p>Я пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на возникающие у меня вопросы, но, как оказалось, никто не был уверен в своих ответах на 100%. C Event loop разобраться сложно и не всегда понятно, зачем это нужно на практике. Поэтому даже у опытных коллег знания по этой технологии часто только теоретические — в рабочих условиях ее применяют редко. Опрос, созданный мной в Google Form, прошли около 25 человек, вопросы были совершенно стандартные, из тех, что обычно задают на собеседованиях. Правильных ответов было очень мало, около 23-24%. </p><p>И тут возникли такие задачи, где без хорошего понимания Node.js было бы сложно повысить перфоманс, а следовательно, и лояльность к клиенту.  Тогда мы решили более глубоко изучить теорию, а позже и поделиться полученной информацией о том, что происходит под капотом в Node.js.</p><p>Результаты публикуем на Хабре. Если мы хотим добиться производительности, нам нужно отойти от стандартных идей и играть по правилам Node.js. </p><h2>Детали, на которых базируется Node.js</h2><h4>Паттерн Reactor</h4><p>Обратимся к классической модели блокирующего I/O: есть сервер, и есть некий компонент системы, обращающийся к БД ( это может быть и другой сервис, и чтение из файла, то есть все то, что заставляет ждать). </p><p>В данном примере выполнение кода блокируется, пока не придет ответ компоненту от БД:</p><figure class=""><img src="/img/image-loader.svg" height="66" data-src="https://habrastorage.org/getpro/habr/upload_files/3c0/958/341/3c09583419fb578379f15e058bc1725b.png" data-width="429"/><figcaption></figcaption></figure><p>Это создаст некоторую сложность, если как минимум два пользователя одновременно обратятся к серверу. Поэтому самый логичный вариант, который позволит выйти из этой ситуации – создать для другого подключения отдельный поток или процесс (или повторно использовать один из имеющихся в пуле), в котором он бы выполнял свои задачи.</p><p>Рассмотрим рисунок, который отображает суть модели:</p><figure class="full-width "><img src="/img/image-loader.svg" height="267" data-src="https://habrastorage.org/getpro/habr/upload_files/16e/4f5/1af/16e4f51af60851dbe62e17a3f0beca5c.png" data-width="655"/><figcaption></figcaption></figure><p>Желтым цветов выделена полезная работа, которая совершается, когда мы получаем новые данные из одного конкретного потока, а бежевым – бездействие потока. На каждый поток у нас тратится ресурс памяти, а также вызывается переключение контекстов, что при достаточно большом количестве подключений делает работу сервера не оптимальной.</p><p>Кроме блокирующего I/O существует <strong>неблокирующий I/O</strong>. При его использовании системные вызовы немедленно возвращают управление, не ожидая чтения файла или сетевого запроса. Одним из вариантов неблокирующего I/O будет реализация цикла ожидания (busy-waiting). </p><p>Идея алгоритма заключается в том, что мы проводим активный опрос ресурсов, пока не получим ответа об их готовности:</p><figure class=""><img src="/img/image-loader.svg" height="338" data-src="https://habrastorage.org/getpro/habr/upload_files/cc1/df0/501/cc1df0501730401720ee7ca5aac31ffb.png" data-width="498"/><figcaption></figcaption></figure><p>Через <strong>цикл ожидания</strong> мы можем обрабатывать несколько ресурсов в одном потоке, но этот метод будет не слишком эффективен, так как мы тратим драгоценное процессорное время на обход ресурсов, недоступных большую часть времени.</p><p>Вообще цикл ожиданий можно представить как консьержа, который работает в большом отеле: он бегает по всем номерам и спрашивает, что принести постояльцам. Он будет бегать с первого до последнего этажа и обратно. А если отель очень большой, то для консьержа эта задача станет крайне сложной. </p><figure class="full-width "><img src="/img/image-loader.svg" height="323" data-src="https://habrastorage.org/getpro/habr/upload_files/cd7/f67/284/cd7f67284e7e30c22e84d72fcf5ecea2.png" data-width="816"/><figcaption></figcaption></figure><p>Поэтому нужно избавить наш цикл от опроса ресурсов, которые еще не завершились, а сосредоточить на работе только с теми ресурсами, которые нам уже доступны.</p><p>Рассмотрим другой вариант, который является более эффективным механизмом параллельной работы с ресурсами. Механизм называется <strong>синхронным демультиплексированием событий</strong> или интерфейсом уведомления событий.</p><figure class=""><img src="/img/image-loader.svg" height="287" data-src="https://habrastorage.org/getpro/habr/upload_files/0c2/3c7/edf/0c23c7edf03698dc0894b27a05fa1ee6.png" data-width="463"/><figcaption></figcaption></figure><p>Основная идея, заложенная в этом принципе, такова: у нас есть структура, которая добавляет в себя ресурсы с неким статусом для использования, а механизм оповещения наблюдает за группой ресурсов. Этот вызов работает синхронно и блокирует выполнение до готовности к чтению любого из наблюдаемых ресурсов. Когда вызов выполняется, демультиплексор возобновляет работу и становится доступным для обработки нового набора событий. </p><p>В вызове обрабатываются все события, возвращенные демультиплексором. Здесь ресурс, связанный с событием, гарантировано готов к чтению и не блокирует выполнение. После обработки всех событий поток демультиплексора вновь блокируется до готовности обработки новых событий.</p><p>Данная реализация уже работает не как простой консьерж: теперь ему помогает менеджер отеля.</p><figure class="full-width "><img src="/img/image-loader.svg" height="450" data-src="https://habrastorage.org/getpro/habr/upload_files/a0b/ae1/3e5/a0bae13e59c927da416d5a4482682b0d.png" data-width="831"/><figcaption></figcaption></figure><p>Менеджер соберет все данные, которые получит от постояльцев, обработает их, выполнит все задачи и только потом делегирует обязанности консьержу, который будет работать только с теми постояльцами, которые действительно оставляли запрос.</p><p>Те идеи, которые мы рассмотрели выше, содержатся в паттерне Reactor, на котором основана сама технология Node.js.</p><p><strong><u>Детальный разбор паттерна</u></strong></p><ol><li><p>У нас есть приложение, которое использует паттерн Reactor.</p><figure class="full-width "><img src="/img/image-loader.svg" height="460" data-src="https://habrastorage.org/getpro/habr/upload_files/bc4/978/c40/bc4978c40b19553cf8fc9f40fcc955f0.png" data-width="805"/><figcaption></figcaption></figure></li><li><p>Приложение создает новую операцию I/O, передает запрос демультиплексору событий, а также определяет обработчика для этой операции . Демультиплексор не блокирует приложение, а немедленно передает ему управление. Все работы по операциям происходят на уровне ОС.</p><figure class="full-width "><img src="/img/image-loader.svg" height="473" data-src="https://habrastorage.org/getpro/habr/upload_files/3d9/9e1/1cf/3d99e11cfdba9fa2f26a03263ff6f329.png" data-width="827"/><figcaption></figcaption></figure></li><li><p>После обработки набора операции I/O демультиплексор добавляет новые события в очередь событий.</p><figure class="full-width "><img src="/img/image-loader.svg" height="470" data-src="https://habrastorage.org/getpro/habr/upload_files/f20/2ef/209/f202ef2092fae7edc8186ab2e30bd346.png" data-width="836"/><figcaption></figcaption></figure></li><li><p>Цикл событий приступает к обходу очереди событий.</p><figure class="full-width "><img src="/img/image-loader.svg" height="473" data-src="https://habrastorage.org/getpro/habr/upload_files/162/308/2b8/1623082b89b35c3e95c68af4a72be342.png" data-width="846"/><figcaption></figcaption></figure></li><li><p>Для каждого события выполняется свой обработчик.</p><figure class="full-width "><img src="/img/image-loader.svg" height="471" data-src="https://habrastorage.org/getpro/habr/upload_files/c34/55c/e65/c3455ce65fc0d2685887168d871da03f.png" data-width="836"/><figcaption></figcaption></figure></li><li><p>Обработчики делятся на две группы:</p><ul><li><p>те, которые выполняются и передают управление в цикл событий, чтобы тот взял новое событие; </p></li><li><p>те, которые создают новую операцию I/O, что приводит к добавлению новой операции в демультиплексор событий до возврата обратно к циклу событий. </p><figure class="full-width "><img src="/img/image-loader.svg" height="474" data-src="https://habrastorage.org/getpro/habr/upload_files/0e3/566/dfe/0e3566dfe4e4f5954047894ed87a3ec1.png" data-width="843"/><figcaption></figcaption></figure></li></ul></li><li><p>После обработки всех событий в очереди событий демультиплексор блокирует цикл. Он снова заработает, когда демультиплексор событий не отправит новые события в очередь.</p><figure class="full-width "><img src="/img/image-loader.svg" height="471" data-src="https://habrastorage.org/getpro/habr/upload_files/f48/7e6/fbd/f487e6fbd2fbe20ad40cc1d6bcb7a601.png" data-width="838"/><figcaption></figcaption></figure></li></ol><p><strong><u>Реализация демультиплексора событий</u></strong></p><p>Поскольку операции I/O происходят на уровне ОС, то любая операция может вести себя совершенно различно в разных ОС. К примеру, в Unix не поддерживается неблокирующий I/O, так что для имитации этой операции приходится создавать отдельный поток вне цикла событий. Подобные таким несоответствия привели инженеров к созданию адаптера между приложением и системными вызовами ОС.</p><p>Библиотека, реализующая этот адаптер, называется <strong>libuv</strong>.</p><figure class=""><img src="/img/image-loader.svg" height="400" data-src="https://habrastorage.org/getpro/habr/upload_files/bb7/f9f/ccc/bb7f9fccc968cfc7dd690a4484f54f6a.png" data-width="400"/><figcaption></figcaption></figure><p>Но libuv не только выполняет функцию адаптера, его создатели также добавили туда реализацию самого паттерна Reactor, цикл событий и очередь событий.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Ремарка: V8 вообще не причастен к циклу событий, как многие могли бы подумать." title="Ремарка: V8 вообще не причастен к циклу событий, как многие могли бы подумать." height="405" data-src="https://habrastorage.org/getpro/habr/upload_files/a26/ce3/51c/a26ce351cce41d0fe7d202840b6e12de.png" data-width="606"/><figcaption>Ремарка: V8 вообще не причастен к циклу событий, как многие могли бы подумать.</figcaption></figure><p>Итак, по сравнению с концепцией «один поток на одно соединение», Node.js предоставляет иной подход к обработке запросов. Если классическая модель создает на каждую задачу отдельный поток (то есть для этого она выделяет системные ресурсы), то Node.js работает в одном потоке. Поэтому единственным ресурсом, на котором Node.js может выполнять много задач, является время. Из этого вытекает правило: для лучшей работы на обработчик не нужно вешать очень сложные задачи, затрагивающие ресурс процессора.</p><figure class="full-width "><img src="/img/image-loader.svg" height="250" data-src="https://habrastorage.org/getpro/habr/upload_files/a1b/7f9/7da/a1b7f97da424e6ab8ef58b3d709ce1f5.png" data-width="668"/><figcaption></figcaption></figure><p>Может возникнуть вопрос: почему для своих проектов мы выбрали именно Node.js? Наш текущий проект развивается с 2014 года, Node.js уже тогда был удобен для использования, потому что позволял быстро и качественно, потратив всего несколько дней, получить готовый работающий прототип. Мы работаем с Node.js до сих пор, за 7 лет, конечно, он изменился, вышли новые версии библиотек, но остались юзабилити и высокая скорость работы.</p><h4>Цикл событий – Event Loop</h4><p>О цикле событий мы говорили выше, когда обсуждали паттерн Reactor. Его задачей было разбирать события, которые нам отдает демультиплексор событий, и затухать, когда очередь пуста, а у демультиплексора событий еще есть задачи блокирующего I/O.</p><p>Но цикл событий выполняет приходящие в очередь события довольно нетривиально, что фактически и делает его довольно быстрым.</p><p>Структурно Event Loop выглядит так: </p><figure class="full-width "><img src="/img/image-loader.svg" height="466" data-src="https://habrastorage.org/getpro/habr/upload_files/4a0/041/9f8/4a00419f839fd04e747924ffa9b61791.png" data-width="701"/><figcaption></figcaption></figure><p>Кратко рассмотрим каждую фазу:</p><ol><li><p>Timer – обрабатываем все колбэки setTimeout() и setInterval(). <em>Интересный факт: для libuv эти две функции – одно и тоже, просто в интервальном таймере параметр repeat стоит с 1.</em></p></li><li><p>Pending callbacks – эта фаза выполняет обратные вызовы для некоторых системных операций, например, ошибки TCP.</p></li><li><p>Idle, prepare – это системные фазы, у нас нет к ним доступа, Node.js сама их вызывает ( особо нас не интересует).</p></li><li><p>Poll – занимается обработкой I/O операций.</p></li><li><p>Check – выполняет колбэки setImmediate().</p></li><li><p>Close callbacks – выполняются события ‘close’, socket.on(‘close’)</p></li></ol><p>Отдельно есть так называемые микротаски:</p><ol><li><p>NextTickQueue – выполняются вызовы process.nextTick()</p></li><li><p>Other microtasks queue – в основном здесь выполняются Promise.</p></li></ol><p>Данные микротаски выполняются, если цикл событий не находится в одной из 6 вышеописанных фаз.</p><p>Хочется заметить, что каждая фаза представляет из себя <strong>очередь</strong>, в которой содержатся колбэки одного типа. Они выполнятся все: если мы оказались в конкретной фазе и в ней есть определенное количество колбэков, то это все количество колбэков поочередно выполнятся, потом фаза завершится.</p><h3>Приступим к разбору кода </h3><p><em><u>Обратите внимание</u>: версия ноды, на которой запускался скрипт – 14.15.0, если ваша версия отличается, то вывод на экран может быть другим.</em></p><figure class="full-width "><img src="/img/image-loader.svg" height="522" data-src="https://habrastorage.org/getpro/habr/upload_files/351/64a/822/35164a822f5187fe53446dfeef14b21c.png" data-width="606"/><figcaption></figcaption></figure><p><strong>Приступим:</strong></p><p>После запуска кода – node index.js, который содержит только функцию main и ее вызов, мы идем по коду сверху вниз, потенциально пытаясь выполнить команды на нашем пути. Встречая на пути синхронные операции, мы их сразу выполняем, асинхронные же операции мы отправляем демультиплексору событий, который займется их обработкой. </p><p>Здесь синхронными операциями будут console.log, промисы с await (не будем забывать, что main  –  async function), а также зарезолвленные промисы. </p><p>На момент, когда node.js дойдет до конца функции, мы будем иметь на экране и в очередях фаз:</p><figure class="full-width "><img src="/img/image-loader.svg" height="449" data-src="https://habrastorage.org/getpro/habr/upload_files/121/e84/894/121e848949f90d44ee695f4819744e07.png" data-width="636"/><figcaption></figcaption></figure><p>Теперь в работу вступает цикл событий, он видит, что для него есть задачи. </p><p>Первым делом мы выполняем микротаски, которых у нас две в очереди событий. Как только мы со всеми разберемся, то перейдем уже к основным фазам.</p><p>В каждой фазе мы будем выполнять все ее готовые колбэки. Выходя из фазы, мы будем потенциально выполнять все новые микротаски, а только потом переходить к новой фазе. </p><p>На момент, как цикл событий дойдет до фазы Poll, мы будем иметь на экране и в очередях фаз:</p><figure class="full-width "><img src="/img/image-loader.svg" height="462" data-src="https://habrastorage.org/getpro/habr/upload_files/6c0/527/4a8/6c05274a83f366a78053b282a40b3537.png" data-width="650"/><figcaption></figcaption></figure><p><em><u>Обратите внимание</u></em>: вывод на экран SetTimeout и SetImmediate может отличаться. Объяснить такую ситуацию довольно просто: если они оба запускаются из основного модуля, то из-за конкретных особенностей системы (например, из-за производительности процессора) порядок выполнения SetTimeout и SetImmediate может быть разным. </p><div><div class="table"><table><tbody><tr><td><p>SetTimeout</p><p>SetTimeout</p><p>SetImmediate</p></td><td><p>SetTimeout</p><p>SetImmediate</p><p>SetTimeout</p></td></tr></tbody></table></div></div><p>Перед тем, как выполнить потенциальные функции обратного вызова у Poll, цикл событий проверяет на пустоту фазу Check, если в ней что-то есть, то он немедленно переключается на нее. В рамках этой итерации цикл событий Poll уже трогать не будет. </p><p>На данный момент будем иметь такую картину:</p><figure class="full-width "><img src="/img/image-loader.svg" height="469" data-src="https://habrastorage.org/getpro/habr/upload_files/94a/f8a/e7c/94af8ae7c2e3f22fb4eefeee030aed56.png" data-width="667"/><figcaption></figcaption></figure><p>Закончив эту итерацию, цикл проверит, нужно ли ему начать новую, есть ли еще невыполненные колбэки. На новой итерации он будет вести себя так же, как на прошлой, с единственной оговоркой, что в фазах он долго задерживаться не будет, ведь нечего обрабатывать, пока не дойдет до фазы Poll, которую пропустил на прошлой итерации. </p><p>Выполнив фазу Poll, мы получим новый результат:</p><figure class="full-width "><img src="/img/image-loader.svg" height="515" data-src="https://habrastorage.org/getpro/habr/upload_files/fb1/b23/beb/fb1b23beb22f7313d13cf231e21df970.png" data-width="661"/><figcaption></figcaption></figure><p>После выхода из Poll цикл ведет себя штатно: он будет ходить по таскам и микротаскам, используя те правила, о которых я писал выше. Единственное, что тут можно заметить – setImmediate выполнится гарантированно раньше, чем setTimeout. Этому есть разумное объяснение: цикл событий уже прошел фазу Timer, но еще не прошел стадию Check. </p><p>Когда мы начнем новую итерацию и выполним таймеры, то будем иметь:</p><figure class="full-width "><img src="/img/image-loader.svg" height="566" data-src="https://habrastorage.org/getpro/habr/upload_files/016/c95/dbd/016c95dbdfff3625023eb22c88d701e2.png" data-width="684"/><figcaption></figcaption></figure><p>Мы видим, что очереди фаз пустуют, что код больше не создаст новой асинхронной операции, но циклу событий этого неизвестно, он еще раз честно пройдет начавшуюся итерацию, которую мы начали из-за необработанного колбэка таймера, а только потом прекратит свою работу:</p><figure class="full-width "><img src="/img/image-loader.svg" height="470" data-src="https://habrastorage.org/getpro/habr/upload_files/488/9c2/26a/4889c226acf52adfab096655ca84ec11.png" data-width="722"/><figcaption></figcaption></figure><figure class="full-width "><img src="/img/image-loader.svg" height="474" data-src="https://habrastorage.org/getpro/habr/upload_files/699/b34/935/699b34935247cc535f57e137bab3fee5.png" data-width="757"/><figcaption></figcaption></figure><ul><li><p><strong>логика Event Loop</strong>. До 11 версии Node.js последовательность действий могла меняться. </p></li><li><p><strong>выполнение макротасков</strong> – пока все микротаски не выполнятся, макротаски не будут выполняться. </p></li></ul><p>Здесь возникает вопрос – как долго Event Loop может эти микротаски выполнять? Есть определенное количество или выполнение будет происходить, пока они вообще есть в наличии или пока не закончатся ресурсы? </p><p>Чтобы Event Loop выполнял их всегда, достаточно сделать так: </p><ul><li><p>пишем рекурсивную функцию с process.NextTick();</p></li><li><p>запускаем таймер, который выполнится через 10 секунд.</p></li></ul><p>В итоге process.NextTick забьет таймер, и результат работы таймера мы не увидим. </p><p>Об этих кейсах мы поговорим подробнее в наших дальнейших статьях.</p><p>Event Loop иногда не справляется со своими задачами. У нас тоже возникали проблемы в работе, например, одна из них – игнорирование сложных операций.</p><p>Мы занимаемся разработкой и поддержкой сервиса, который манипулирует с огромным датасетом в специфичной теме. Данные в датасете имеют неисчисляемый вариант конфигураций, а также миллион факторов, влияющих на них. В функциональности данного сервиса есть возможность создавать различные pdf-репорты на основе агрегации датасета, а также вычислять множество различных статистических значений по нетривиальным правилам.</p><p>Когда вы реализуете сервис с такой функциональностью на Node.js, вам стоит продумать каждый аспект «от и до». Ведь вы даете любому пользователю в любое время и в любом масштабе манипулировать с данными. Такие действия могут привести к тому, что ваш перфоманс упадет, а следовательно, и лояльность к сервису испарится. </p><h2>Пример работы с Node.js</h2><p>Давайте с вами создадим маленькое Node.js приложение, которое будет иметь два GET запроса:</p><ol><li><p>возвращает некие фиксированные данные;</p></li><li><p>вычисляет среднюю зарплату по компаниям</p></li></ol><p>Чтобы упростить генерацию компаний и людей, чтобы не придумывать каждой компании свое название, я использовал <a href="https://github.com/marak/Faker.js/"><u>https://github.com/marak/Faker.js/</u></a></p><p>Итак, мы генерим много компаний, в каждой компании у нас довольно много сотрудников, за моконые данные будет отвечать факир, а сами компании и их работников для простоты будем хранить в памяти.  </p><p>Так вот, если вы сейчас вызовете эндпоинт по статистике, то сразу данные вы не получите. Разумеется, железо вашего сервера тоже влияет на скорость выполнения запроса, но всегда ведь есть свой предел по количеству данных. Например, мой локальный предел – это 10000 компаний, с 1000 сотрудников, с ЗП до 100000. В такие моменты я действительно жду, когда Node.js посчитает все среднее. </p><figure class=""><img src="/img/image-loader.svg" height="305" data-src="https://habrastorage.org/getpro/habr/upload_files/5fe/113/2a7/5fe1132a76483ab6d0b574470372ea6e.png" data-width="488"/><figcaption></figcaption></figure><p>Попробуйте в этот момент пойти на первый эндпоинт. К сожалению, он тоже будет висеть. </p><figure class=""><img src="/img/image-loader.svg" height="106" data-src="https://habrastorage.org/getpro/habr/upload_files/696/fb6/f90/696fb6f90e40d4018810b83c73d81d97.png" data-width="332"/><figcaption></figcaption></figure><p>Как так? Ведь это статичные данные, которым нужно константное время?  – Не забывайте про особенности Node.js. </p><p>Сейчас мы в локальных условиях продемонстрировали то, что может произойти на реальном проекте, если не просчитать все аспекты вашей системы. Но только давайте помнить, что реальный проект имеет гораздо больше данных, эндпоинтов и формул.</p><p>И сейчас я повторюсь: основной ресурс, на котором ваше Node.js приложение может работать эффективно – <strong>время</strong>. Потому что Node.js не любит сидеть на одном месте, он всегда делегирует задачу, пришедшую из бизнеса, кому-то другому. </p><p>Основываясь на этом, мы инкапсулировали почти всю ресурсозатратную логику на отдельном сервисе, что позволило Node.js не блокироваться, а обрабатывать запросы других пользователей без аффекта. Также мы стали максимально кэшировать всю полезную нагрузку с отдельных сервисов на MongoDB, чтобы еще повысить перфоманс. И даже манипуляцию с MongoDB мы отдали MongoDB, а не Node.js. Почти всю математику и перебор данных мы свели к нулю.  </p><p>Вернемся к нашему примеру, теперь давайте напишем еще одно Node.js приложение и делегируем ему логику сложных вычислений, а старому эндпоинту дадим логику делегирования. </p><p>Попробуем еще раз, если мы запустим эндпоинт со статистикой, то снова будем ждать. Но: если теперь зайдем на эндпоинт с фиксированным данными, то сразу получим ответ, потому что мы не застряли на одной таске, мы пошли дальше, а к ней вернемся, когда она уже будет выполнена.</p><figure class=""><img src="/img/image-loader.svg" height="131" data-src="https://habrastorage.org/getpro/habr/upload_files/399/b12/2a2/399b122a21f9860f6902ab54386d051a.png" data-width="400"/><figcaption></figcaption></figure><p>Итак, работая с Node.js, я для себя сделал следующие выводы:</p><ol><li><p>Никогда не нагружай Node.js. Это самое главное правило. Чем меньше твои задачки, чем меньше Node.js будет тратить времени на их выполнение, тем перфоманс твоего проекта будет лучше. Поэтому максимально<strong> </strong>уменьшай задачи.</p></li><li><p>Если ты делаешь какие-то сложные вычислительные вещи, строишь графики, вычисляешь значения функции, и ты не можешь реализовать делегирование, то стоит задуматься, может не использовать вообще Node.js? Возможно, стоит использовать другой язык программирования.</p></li><li><p>Если все-таки выбор остается за Node.js, то можно использовать отдельный микросервис или отдельно поднимать другую ноду.</p></li><li><p>Если проект существует уже довольно долго, то от legacy стоит избавляться. Он не использует новые фишки javascript, он использует старые библиотеки, это сильно тормозит работу. Совмещать современную разработку и legacy очень тяжело, здесь есть два варианта: 1) обновлять кодовую базу как можно чаще и 2) использовать все современные практики, которые действительно упрощают разработку.</p></li></ol><h3>Вывод</h3><p>Node.js – отличная платформа, основанная на нескольких важных принципах, которые обеспечивают быструю разработку гибких приложений. Для многих разработчиков эти идеи покажутся незнакомыми: асинхронный характер паттерна Reactor, основанный на функциях обратного вызова, требует другого стиля программирования; event loop, который имеет свой конкретный порядок и правила выполнения событий. И, если вы хотите добиться нужного вам перфоманса, все эти правила придется знать и соблюдать.     </p><h3>Источники:</h3><p><a href="https://www.ozon.ru/product/shablony-proektirovaniya-node-js-141553158/?sh=I2yEwxnL">Книга: «Шаблоны проектирования Node.JS» Каскиаро Марио</a></p><p><a href="https://www.ozon.ru/product/node-js-design-patterns-third-edition-design-and-implement-production-grade-node-js-214826009/?sh=OoFzDo5V">Книга в оригинале</a></p><p><a href="https://en.wikipedia.org/wiki/Main_Page">Википедия</a></p><p><a href="https://nodejs.org/ru/docs/">Документация Node.js</a> </p></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bnode.js%5D" class="tm-tags-list__link">node.js</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bevent%20loop%5D" class="tm-tags-list__link">event loop</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bjavascript%5D" class="tm-tags-list__link">javascript</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Blibuv%5D" class="tm-tags-list__link">libuv</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%91%D0%BB%D0%BE%D0%B3%20%D0%BA%D0%BE%D0%BC%D0%BF%D0%B0%D0%BD%D0%B8%D0%B8%20Lineate%5D" class="tm-tags-list__link">Блог компании Lineate</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/company/lineate/blog/" class="tm-hubs-list__link router-link-active">
    Блог компании Lineate
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/javascript/" class="tm-hubs-list__link">
    JavaScript
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/programming/" class="tm-hubs-list__link">
    Программирование
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/nodejs/" class="tm-hubs-list__link">
    Node.JS
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 8: ↑7 и ↓1</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 8: ↑7 и ↓1" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+6</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">5.5K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    82
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"><div class="tm-article-author__company"><div class="tm-article-author__company-card"><div class="tm-company-snippet"><a href="/ru/company/lineate/profile/" class="tm-company-snippet__logo-link"><div class="tm-entity-image"><img alt="" height="40" src="//habrastorage.org/getpro/habr/company/c68/0e3/5d6/c680e35d646d65ff4db7b29cdd808f5b.png" width="40" class="tm-entity-image__pic"></div></a> <div class="tm-company-snippet__info"><a href="/ru/company/lineate/profile/" class="tm-company-snippet__title">Lineate</a> <div class="tm-company-snippet__description">Компания</div></div></div> <div class="tm-article-author__buttons"><!----> <!----></div></div> <div class="tm-article-author__company-contacts"><a href="https://www.lineate.ru/" rel="noopener" target="_blank" class="tm-article-author__contact">
      Сайт
    </a></div> <div class="tm-article-author__separator"></div></div> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/jomb_g/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/f8d/a4f/1a9/f8da4f1a9f99f9a9dd230f6fd3082b42.png" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 4 голоса " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    2
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">6</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Илья Горкун</span> <a href="/ru/users/jomb_g/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @jomb_g
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">full stack developer</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/company/lineate/blog/585050/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 21 
    </span></a> <!----></div></div></div>  <!---->  <!----> <!----></div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__placeholder_initial"></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <section class="tm-block tm-block_spacing-bottom"><header class="tm-block__header"><h2 class="tm-block__title">Информация</h2> <!----></header> <div class="tm-block__body"><div class="tm-company-basic-info"><dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата основания</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2006-09-04T20:00:00.000Z" title="2006-09-05, 00:00">5  сентября  2006</time></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Местоположение</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    Россия
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Сайт</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><a href="https://www.lineate.ru/" target="_blank" class="tm-company-basic-info__link">
      www.lineate.ru
    </a></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Численность</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    201–500 человек
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата регистрации</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2021-09-27T07:08:44.000Z" title="2021-09-27, 10:08">27  сентября  </time></dd></dl> <!----></div></div> <!----></section> <div class="tm-company-widgets"></div> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/company/lineate/blog/585050/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/company/lineate/blog/585050/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"585050":{"id":"585050","timePublished":"2021-10-22T16:18:19+00:00","isCorporative":true,"lang":"ru","titleHtml":"Игра по правилам Event loop в Node.js","leadData":{"textHtml":"\u003Cp\u003EЯ пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на возникающие у меня вопросы, но, как оказалось, никто не был уверен в своих ответах на 100%. C Event loop разобраться сложно и не всегда понятно, зачем это нужно на практике. Поэтому даже у опытных коллег знания по этой технологии часто только теоретические — в рабочих условиях ее применяют редко. Опрос, созданный мной в Google Form, прошли около 25 человек, вопросы были совершенно стандартные, из тех, что обычно задают на собеседованиях. Правильных ответов было очень мало, около 23-24%.&nbsp;\u003C\u002Fp\u003E\u003Cp\u003EИ тут возникли такие задачи, где без хорошего понимания Node.js было бы сложно повысить перфоманс, а следовательно, и лояльность к клиенту.&nbsp; Тогда мы решили более глубоко изучить теорию, а позже и поделиться полученной информацией о том, что происходит под капотом в Node.js.\u003C\u002Fp\u003E\u003Cp\u003EРезультаты публикуем на Хабре. Если мы хотим добиться производительности, нам нужно отойти от стандартных идей и играть по правилам Node.js.&nbsp;\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3b0\u002F829\u002Fd02\u002F3b0829d02464c22c12ec8109bb7c6c3f.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3b0\u002F829\u002Fd02\u002F3b0829d02464c22c12ec8109bb7c6c3f.png","fit":"cover","positionY":0,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":2,"votesCount":4},"rating":6,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"2809893","alias":"jomb_g","fullname":"Илья Горкун","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Ff8d\u002Fa4f\u002F1a9\u002Ff8da4f1a9f99f9a9dd230f6fd3082b42.png","speciality":"full stack developer"},"statistics":{"commentsCount":21,"favoritesCount":82,"readingCount":5494,"score":6,"votesCount":8},"hubs":[{"relatedData":null,"id":"22814","alias":"lineate","type":"corporative","title":"Блог компании Lineate","titleHtml":"Блог компании Lineate","isProfiled":false},{"relatedData":null,"id":"357","alias":"javascript","type":"collective","title":"JavaScript","titleHtml":"JavaScript","isProfiled":true},{"relatedData":null,"id":"359","alias":"programming","type":"collective","title":"Программирование","titleHtml":"Программирование","isProfiled":true},{"relatedData":null,"id":"17110","alias":"nodejs","type":"collective","title":"Node.JS","titleHtml":"Node.JS","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cp\u003EЯ пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на возникающие у меня вопросы, но, как оказалось, никто не был уверен в своих ответах на 100%. C Event loop разобраться сложно и не всегда понятно, зачем это нужно на практике. Поэтому даже у опытных коллег знания по этой технологии часто только теоретические — в рабочих условиях ее применяют редко. Опрос, созданный мной в Google Form, прошли около 25 человек, вопросы были совершенно стандартные, из тех, что обычно задают на собеседованиях. Правильных ответов было очень мало, около 23-24%. \u003C\u002Fp\u003E\u003Cp\u003EИ тут возникли такие задачи, где без хорошего понимания Node.js было бы сложно повысить перфоманс, а следовательно, и лояльность к клиенту.  Тогда мы решили более глубоко изучить теорию, а позже и поделиться полученной информацией о том, что происходит под капотом в Node.js.\u003C\u002Fp\u003E\u003Cp\u003EРезультаты публикуем на Хабре. Если мы хотим добиться производительности, нам нужно отойти от стандартных идей и играть по правилам Node.js. \u003C\u002Fp\u003E\u003Ch2\u003EДетали, на которых базируется Node.js\u003C\u002Fh2\u003E\u003Ch4\u003EПаттерн Reactor\u003C\u002Fh4\u003E\u003Cp\u003EОбратимся к классической модели блокирующего I\u002FO: есть сервер, и есть некий компонент системы, обращающийся к БД ( это может быть и другой сервис, и чтение из файла, то есть все то, что заставляет ждать). \u003C\u002Fp\u003E\u003Cp\u003EВ данном примере выполнение кода блокируется, пока не придет ответ компоненту от БД:\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"66\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3c0\u002F958\u002F341\u002F3c09583419fb578379f15e058bc1725b.png\" data-width=\"429\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЭто создаст некоторую сложность, если как минимум два пользователя одновременно обратятся к серверу. Поэтому самый логичный вариант, который позволит выйти из этой ситуации – создать для другого подключения отдельный поток или процесс (или повторно использовать один из имеющихся в пуле), в котором он бы выполнял свои задачи.\u003C\u002Fp\u003E\u003Cp\u003EРассмотрим рисунок, который отображает суть модели:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"267\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F16e\u002F4f5\u002F1af\u002F16e4f51af60851dbe62e17a3f0beca5c.png\" data-width=\"655\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЖелтым цветов выделена полезная работа, которая совершается, когда мы получаем новые данные из одного конкретного потока, а бежевым – бездействие потока. На каждый поток у нас тратится ресурс памяти, а также вызывается переключение контекстов, что при достаточно большом количестве подключений делает работу сервера не оптимальной.\u003C\u002Fp\u003E\u003Cp\u003EКроме блокирующего I\u002FO существует \u003Cstrong\u003Eнеблокирующий I\u002FO\u003C\u002Fstrong\u003E. При его использовании системные вызовы немедленно возвращают управление, не ожидая чтения файла или сетевого запроса. Одним из вариантов неблокирующего I\u002FO будет реализация цикла ожидания (busy-waiting). \u003C\u002Fp\u003E\u003Cp\u003EИдея алгоритма заключается в том, что мы проводим активный опрос ресурсов, пока не получим ответа об их готовности:\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"338\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fcc1\u002Fdf0\u002F501\u002Fcc1df0501730401720ee7ca5aac31ffb.png\" data-width=\"498\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЧерез \u003Cstrong\u003Eцикл ожидания\u003C\u002Fstrong\u003E мы можем обрабатывать несколько ресурсов в одном потоке, но этот метод будет не слишком эффективен, так как мы тратим драгоценное процессорное время на обход ресурсов, недоступных большую часть времени.\u003C\u002Fp\u003E\u003Cp\u003EВообще цикл ожиданий можно представить как консьержа, который работает в большом отеле: он бегает по всем номерам и спрашивает, что принести постояльцам. Он будет бегать с первого до последнего этажа и обратно. А если отель очень большой, то для консьержа эта задача станет крайне сложной. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"323\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fcd7\u002Ff67\u002F284\u002Fcd7f67284e7e30c22e84d72fcf5ecea2.png\" data-width=\"816\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПоэтому нужно избавить наш цикл от опроса ресурсов, которые еще не завершились, а сосредоточить на работе только с теми ресурсами, которые нам уже доступны.\u003C\u002Fp\u003E\u003Cp\u003EРассмотрим другой вариант, который является более эффективным механизмом параллельной работы с ресурсами. Механизм называется \u003Cstrong\u003Eсинхронным демультиплексированием событий\u003C\u002Fstrong\u003E или интерфейсом уведомления событий.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"287\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0c2\u002F3c7\u002Fedf\u002F0c23c7edf03698dc0894b27a05fa1ee6.png\" data-width=\"463\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EОсновная идея, заложенная в этом принципе, такова: у нас есть структура, которая добавляет в себя ресурсы с неким статусом для использования, а механизм оповещения наблюдает за группой ресурсов. Этот вызов работает синхронно и блокирует выполнение до готовности к чтению любого из наблюдаемых ресурсов. Когда вызов выполняется, демультиплексор возобновляет работу и становится доступным для обработки нового набора событий. \u003C\u002Fp\u003E\u003Cp\u003EВ вызове обрабатываются все события, возвращенные демультиплексором. Здесь ресурс, связанный с событием, гарантировано готов к чтению и не блокирует выполнение. После обработки всех событий поток демультиплексора вновь блокируется до готовности обработки новых событий.\u003C\u002Fp\u003E\u003Cp\u003EДанная реализация уже работает не как простой консьерж: теперь ему помогает менеджер отеля.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"450\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa0b\u002Fae1\u002F3e5\u002Fa0bae13e59c927da416d5a4482682b0d.png\" data-width=\"831\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EМенеджер соберет все данные, которые получит от постояльцев, обработает их, выполнит все задачи и только потом делегирует обязанности консьержу, который будет работать только с теми постояльцами, которые действительно оставляли запрос.\u003C\u002Fp\u003E\u003Cp\u003EТе идеи, которые мы рассмотрели выше, содержатся в паттерне Reactor, на котором основана сама технология Node.js.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E\u003Cu\u003EДетальный разбор паттерна\u003C\u002Fu\u003E\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EУ нас есть приложение, которое использует паттерн Reactor.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"460\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fbc4\u002F978\u002Fc40\u002Fbc4978c40b19553cf8fc9f40fcc955f0.png\" data-width=\"805\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EПриложение создает новую операцию I\u002FO, передает запрос демультиплексору событий, а также определяет обработчика для этой операции . Демультиплексор не блокирует приложение, а немедленно передает ему управление. Все работы по операциям происходят на уровне ОС.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"473\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3d9\u002F9e1\u002F1cf\u002F3d99e11cfdba9fa2f26a03263ff6f329.png\" data-width=\"827\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EПосле обработки набора операции I\u002FO демультиплексор добавляет новые события в очередь событий.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"470\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff20\u002F2ef\u002F209\u002Ff202ef2092fae7edc8186ab2e30bd346.png\" data-width=\"836\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EЦикл событий приступает к обходу очереди событий.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"473\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F162\u002F308\u002F2b8\u002F1623082b89b35c3e95c68af4a72be342.png\" data-width=\"846\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EДля каждого события выполняется свой обработчик.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"471\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc34\u002F55c\u002Fe65\u002Fc3455ce65fc0d2685887168d871da03f.png\" data-width=\"836\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EОбработчики делятся на две группы:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eте, которые выполняются и передают управление в цикл событий, чтобы тот взял новое событие; \u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eте, которые создают новую операцию I\u002FO, что приводит к добавлению новой операции в демультиплексор событий до возврата обратно к циклу событий. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"474\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0e3\u002F566\u002Fdfe\u002F0e3566dfe4e4f5954047894ed87a3ec1.png\" data-width=\"843\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EПосле обработки всех событий в очереди событий демультиплексор блокирует цикл. Он снова заработает, когда демультиплексор событий не отправит новые события в очередь.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"471\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff48\u002F7e6\u002Ffbd\u002Ff487e6fbd2fbe20ad40cc1d6bcb7a601.png\" data-width=\"838\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003E\u003Cstrong\u003E\u003Cu\u003EРеализация демультиплексора событий\u003C\u002Fu\u003E\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EПоскольку операции I\u002FO происходят на уровне ОС, то любая операция может вести себя совершенно различно в разных ОС. К примеру, в Unix не поддерживается неблокирующий I\u002FO, так что для имитации этой операции приходится создавать отдельный поток вне цикла событий. Подобные таким несоответствия привели инженеров к созданию адаптера между приложением и системными вызовами ОС.\u003C\u002Fp\u003E\u003Cp\u003EБиблиотека, реализующая этот адаптер, называется \u003Cstrong\u003Elibuv\u003C\u002Fstrong\u003E.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"400\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fbb7\u002Ff9f\u002Fccc\u002Fbb7f9fccc968cfc7dd690a4484f54f6a.png\" data-width=\"400\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНо libuv не только выполняет функцию адаптера, его создатели также добавили туда реализацию самого паттерна Reactor, цикл событий и очередь событий.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Ремарка: V8 вообще не причастен к циклу событий, как многие могли бы подумать.\" title=\"Ремарка: V8 вообще не причастен к циклу событий, как многие могли бы подумать.\" height=\"405\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa26\u002Fce3\u002F51c\u002Fa26ce351cce41d0fe7d202840b6e12de.png\" data-width=\"606\"\u002F\u003E\u003Cfigcaption\u003EРемарка: V8 вообще не причастен к циклу событий, как многие могли бы подумать.\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EИтак, по сравнению с концепцией «один поток на одно соединение», Node.js предоставляет иной подход к обработке запросов. Если классическая модель создает на каждую задачу отдельный поток (то есть для этого она выделяет системные ресурсы), то Node.js работает в одном потоке. Поэтому единственным ресурсом, на котором Node.js может выполнять много задач, является время. Из этого вытекает правило: для лучшей работы на обработчик не нужно вешать очень сложные задачи, затрагивающие ресурс процессора.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"250\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa1b\u002F7f9\u002F7da\u002Fa1b7f97da424e6ab8ef58b3d709ce1f5.png\" data-width=\"668\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EМожет возникнуть вопрос: почему для своих проектов мы выбрали именно Node.js? Наш текущий проект развивается с 2014 года, Node.js уже тогда был удобен для использования, потому что позволял быстро и качественно, потратив всего несколько дней, получить готовый работающий прототип. Мы работаем с Node.js до сих пор, за 7 лет, конечно, он изменился, вышли новые версии библиотек, но остались юзабилити и высокая скорость работы.\u003C\u002Fp\u003E\u003Ch4\u003EЦикл событий – Event Loop\u003C\u002Fh4\u003E\u003Cp\u003EО цикле событий мы говорили выше, когда обсуждали паттерн Reactor. Его задачей было разбирать события, которые нам отдает демультиплексор событий, и затухать, когда очередь пуста, а у демультиплексора событий еще есть задачи блокирующего I\u002FO.\u003C\u002Fp\u003E\u003Cp\u003EНо цикл событий выполняет приходящие в очередь события довольно нетривиально, что фактически и делает его довольно быстрым.\u003C\u002Fp\u003E\u003Cp\u003EСтруктурно Event Loop выглядит так: \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"466\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F4a0\u002F041\u002F9f8\u002F4a00419f839fd04e747924ffa9b61791.png\" data-width=\"701\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКратко рассмотрим каждую фазу:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003ETimer – обрабатываем все колбэки setTimeout() и setInterval(). \u003Cem\u003EИнтересный факт: для libuv эти две функции – одно и тоже, просто в интервальном таймере параметр repeat стоит с 1.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EPending callbacks – эта фаза выполняет обратные вызовы для некоторых системных операций, например, ошибки TCP.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EIdle, prepare – это системные фазы, у нас нет к ним доступа, Node.js сама их вызывает ( особо нас не интересует).\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EPoll – занимается обработкой I\u002FO операций.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003ECheck – выполняет колбэки setImmediate().\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EClose callbacks – выполняются события ‘close’, socket.on(‘close’)\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EОтдельно есть так называемые микротаски:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003ENextTickQueue – выполняются вызовы process.nextTick()\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EOther microtasks queue – в основном здесь выполняются Promise.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EДанные микротаски выполняются, если цикл событий не находится в одной из 6 вышеописанных фаз.\u003C\u002Fp\u003E\u003Cp\u003EХочется заметить, что каждая фаза представляет из себя \u003Cstrong\u003Eочередь\u003C\u002Fstrong\u003E, в которой содержатся колбэки одного типа. Они выполнятся все: если мы оказались в конкретной фазе и в ней есть определенное количество колбэков, то это все количество колбэков поочередно выполнятся, потом фаза завершится.\u003C\u002Fp\u003E\u003Ch3\u003EПриступим к разбору кода \u003C\u002Fh3\u003E\u003Cp\u003E\u003Cem\u003E\u003Cu\u003EОбратите внимание\u003C\u002Fu\u003E: версия ноды, на которой запускался скрипт – 14.15.0, если ваша версия отличается, то вывод на экран может быть другим.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"522\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F351\u002F64a\u002F822\u002F35164a822f5187fe53446dfeef14b21c.png\" data-width=\"606\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003Cstrong\u003EПриступим:\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EПосле запуска кода – node index.js, который содержит только функцию main и ее вызов, мы идем по коду сверху вниз, потенциально пытаясь выполнить команды на нашем пути. Встречая на пути синхронные операции, мы их сразу выполняем, асинхронные же операции мы отправляем демультиплексору событий, который займется их обработкой. \u003C\u002Fp\u003E\u003Cp\u003EЗдесь синхронными операциями будут console.log, промисы с await (не будем забывать, что main  –  async function), а также зарезолвленные промисы. \u003C\u002Fp\u003E\u003Cp\u003EНа момент, когда node.js дойдет до конца функции, мы будем иметь на экране и в очередях фаз:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"449\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F121\u002Fe84\u002F894\u002F121e848949f90d44ee695f4819744e07.png\" data-width=\"636\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EТеперь в работу вступает цикл событий, он видит, что для него есть задачи. \u003C\u002Fp\u003E\u003Cp\u003EПервым делом мы выполняем микротаски, которых у нас две в очереди событий. Как только мы со всеми разберемся, то перейдем уже к основным фазам.\u003C\u002Fp\u003E\u003Cp\u003EВ каждой фазе мы будем выполнять все ее готовые колбэки. Выходя из фазы, мы будем потенциально выполнять все новые микротаски, а только потом переходить к новой фазе. \u003C\u002Fp\u003E\u003Cp\u003EНа момент, как цикл событий дойдет до фазы Poll, мы будем иметь на экране и в очередях фаз:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"462\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6c0\u002F527\u002F4a8\u002F6c05274a83f366a78053b282a40b3537.png\" data-width=\"650\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003Cem\u003E\u003Cu\u003EОбратите внимание\u003C\u002Fu\u003E\u003C\u002Fem\u003E: вывод на экран SetTimeout и SetImmediate может отличаться. Объяснить такую ситуацию довольно просто: если они оба запускаются из основного модуля, то из-за конкретных особенностей системы (например, из-за производительности процессора) порядок выполнения SetTimeout и SetImmediate может быть разным. \u003C\u002Fp\u003E\u003Cdiv\u003E\u003Cdiv class=\"table\"\u003E\u003Ctable\u003E\u003Ctbody\u003E\u003Ctr\u003E\u003Ctd\u003E\u003Cp\u003ESetTimeout\u003C\u002Fp\u003E\u003Cp\u003ESetTimeout\u003C\u002Fp\u003E\u003Cp\u003ESetImmediate\u003C\u002Fp\u003E\u003C\u002Ftd\u003E\u003Ctd\u003E\u003Cp\u003ESetTimeout\u003C\u002Fp\u003E\u003Cp\u003ESetImmediate\u003C\u002Fp\u003E\u003Cp\u003ESetTimeout\u003C\u002Fp\u003E\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003C\u002Ftbody\u003E\u003C\u002Ftable\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cp\u003EПеред тем, как выполнить потенциальные функции обратного вызова у Poll, цикл событий проверяет на пустоту фазу Check, если в ней что-то есть, то он немедленно переключается на нее. В рамках этой итерации цикл событий Poll уже трогать не будет. \u003C\u002Fp\u003E\u003Cp\u003EНа данный момент будем иметь такую картину:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"469\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F94a\u002Ff8a\u002Fe7c\u002F94af8ae7c2e3f22fb4eefeee030aed56.png\" data-width=\"667\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЗакончив эту итерацию, цикл проверит, нужно ли ему начать новую, есть ли еще невыполненные колбэки. На новой итерации он будет вести себя так же, как на прошлой, с единственной оговоркой, что в фазах он долго задерживаться не будет, ведь нечего обрабатывать, пока не дойдет до фазы Poll, которую пропустил на прошлой итерации. \u003C\u002Fp\u003E\u003Cp\u003EВыполнив фазу Poll, мы получим новый результат:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"515\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffb1\u002Fb23\u002Fbeb\u002Ffb1b23beb22f7313d13cf231e21df970.png\" data-width=\"661\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПосле выхода из Poll цикл ведет себя штатно: он будет ходить по таскам и микротаскам, используя те правила, о которых я писал выше. Единственное, что тут можно заметить – setImmediate выполнится гарантированно раньше, чем setTimeout. Этому есть разумное объяснение: цикл событий уже прошел фазу Timer, но еще не прошел стадию Check. \u003C\u002Fp\u003E\u003Cp\u003EКогда мы начнем новую итерацию и выполним таймеры, то будем иметь:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"566\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F016\u002Fc95\u002Fdbd\u002F016c95dbdfff3625023eb22c88d701e2.png\" data-width=\"684\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EМы видим, что очереди фаз пустуют, что код больше не создаст новой асинхронной операции, но циклу событий этого неизвестно, он еще раз честно пройдет начавшуюся итерацию, которую мы начали из-за необработанного колбэка таймера, а только потом прекратит свою работу:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"470\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F488\u002F9c2\u002F26a\u002F4889c226acf52adfab096655ca84ec11.png\" data-width=\"722\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"474\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F699\u002Fb34\u002F935\u002F699b34935247cc535f57e137bab3fee5.png\" data-width=\"757\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003E\u003Cstrong\u003Eлогика Event Loop\u003C\u002Fstrong\u003E. До 11 версии Node.js последовательность действий могла меняться. \u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Cstrong\u003Eвыполнение макротасков\u003C\u002Fstrong\u003E – пока все микротаски не выполнятся, макротаски не будут выполняться. \u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EЗдесь возникает вопрос – как долго Event Loop может эти микротаски выполнять? Есть определенное количество или выполнение будет происходить, пока они вообще есть в наличии или пока не закончатся ресурсы? \u003C\u002Fp\u003E\u003Cp\u003EЧтобы Event Loop выполнял их всегда, достаточно сделать так: \u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eпишем рекурсивную функцию с process.NextTick();\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eзапускаем таймер, который выполнится через 10 секунд.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EВ итоге process.NextTick забьет таймер, и результат работы таймера мы не увидим. \u003C\u002Fp\u003E\u003Cp\u003EОб этих кейсах мы поговорим подробнее в наших дальнейших статьях.\u003C\u002Fp\u003E\u003Cp\u003EEvent Loop иногда не справляется со своими задачами. У нас тоже возникали проблемы в работе, например, одна из них – игнорирование сложных операций.\u003C\u002Fp\u003E\u003Cp\u003EМы занимаемся разработкой и поддержкой сервиса, который манипулирует с огромным датасетом в специфичной теме. Данные в датасете имеют неисчисляемый вариант конфигураций, а также миллион факторов, влияющих на них. В функциональности данного сервиса есть возможность создавать различные pdf-репорты на основе агрегации датасета, а также вычислять множество различных статистических значений по нетривиальным правилам.\u003C\u002Fp\u003E\u003Cp\u003EКогда вы реализуете сервис с такой функциональностью на Node.js, вам стоит продумать каждый аспект «от и до». Ведь вы даете любому пользователю в любое время и в любом масштабе манипулировать с данными. Такие действия могут привести к тому, что ваш перфоманс упадет, а следовательно, и лояльность к сервису испарится. \u003C\u002Fp\u003E\u003Ch2\u003EПример работы с Node.js\u003C\u002Fh2\u003E\u003Cp\u003EДавайте с вами создадим маленькое Node.js приложение, которое будет иметь два GET запроса:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003Eвозвращает некие фиксированные данные;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eвычисляет среднюю зарплату по компаниям\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EЧтобы упростить генерацию компаний и людей, чтобы не придумывать каждой компании свое название, я использовал \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fmarak\u002FFaker.js\u002F\"\u003E\u003Cu\u003Ehttps:\u002F\u002Fgithub.com\u002Fmarak\u002FFaker.js\u002F\u003C\u002Fu\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003EИтак, мы генерим много компаний, в каждой компании у нас довольно много сотрудников, за моконые данные будет отвечать факир, а сами компании и их работников для простоты будем хранить в памяти.  \u003C\u002Fp\u003E\u003Cp\u003EТак вот, если вы сейчас вызовете эндпоинт по статистике, то сразу данные вы не получите. Разумеется, железо вашего сервера тоже влияет на скорость выполнения запроса, но всегда ведь есть свой предел по количеству данных. Например, мой локальный предел – это 10000 компаний, с 1000 сотрудников, с ЗП до 100000. В такие моменты я действительно жду, когда Node.js посчитает все среднее. \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"305\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F5fe\u002F113\u002F2a7\u002F5fe1132a76483ab6d0b574470372ea6e.png\" data-width=\"488\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПопробуйте в этот момент пойти на первый эндпоинт. К сожалению, он тоже будет висеть. \u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"106\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F696\u002Ffb6\u002Ff90\u002F696fb6f90e40d4018810b83c73d81d97.png\" data-width=\"332\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак так? Ведь это статичные данные, которым нужно константное время?  – Не забывайте про особенности Node.js. \u003C\u002Fp\u003E\u003Cp\u003EСейчас мы в локальных условиях продемонстрировали то, что может произойти на реальном проекте, если не просчитать все аспекты вашей системы. Но только давайте помнить, что реальный проект имеет гораздо больше данных, эндпоинтов и формул.\u003C\u002Fp\u003E\u003Cp\u003EИ сейчас я повторюсь: основной ресурс, на котором ваше Node.js приложение может работать эффективно – \u003Cstrong\u003Eвремя\u003C\u002Fstrong\u003E. Потому что Node.js не любит сидеть на одном месте, он всегда делегирует задачу, пришедшую из бизнеса, кому-то другому. \u003C\u002Fp\u003E\u003Cp\u003EОсновываясь на этом, мы инкапсулировали почти всю ресурсозатратную логику на отдельном сервисе, что позволило Node.js не блокироваться, а обрабатывать запросы других пользователей без аффекта. Также мы стали максимально кэшировать всю полезную нагрузку с отдельных сервисов на MongoDB, чтобы еще повысить перфоманс. И даже манипуляцию с MongoDB мы отдали MongoDB, а не Node.js. Почти всю математику и перебор данных мы свели к нулю.  \u003C\u002Fp\u003E\u003Cp\u003EВернемся к нашему примеру, теперь давайте напишем еще одно Node.js приложение и делегируем ему логику сложных вычислений, а старому эндпоинту дадим логику делегирования. \u003C\u002Fp\u003E\u003Cp\u003EПопробуем еще раз, если мы запустим эндпоинт со статистикой, то снова будем ждать. Но: если теперь зайдем на эндпоинт с фиксированным данными, то сразу получим ответ, потому что мы не застряли на одной таске, мы пошли дальше, а к ней вернемся, когда она уже будет выполнена.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"131\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F399\u002Fb12\u002F2a2\u002F399b122a21f9860f6902ab54386d051a.png\" data-width=\"400\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EИтак, работая с Node.js, я для себя сделал следующие выводы:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EНикогда не нагружай Node.js. Это самое главное правило. Чем меньше твои задачки, чем меньше Node.js будет тратить времени на их выполнение, тем перфоманс твоего проекта будет лучше. Поэтому максимально\u003Cstrong\u003E \u003C\u002Fstrong\u003Eуменьшай задачи.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EЕсли ты делаешь какие-то сложные вычислительные вещи, строишь графики, вычисляешь значения функции, и ты не можешь реализовать делегирование, то стоит задуматься, может не использовать вообще Node.js? Возможно, стоит использовать другой язык программирования.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EЕсли все-таки выбор остается за Node.js, то можно использовать отдельный микросервис или отдельно поднимать другую ноду.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EЕсли проект существует уже довольно долго, то от legacy стоит избавляться. Он не использует новые фишки javascript, он использует старые библиотеки, это сильно тормозит работу. Совмещать современную разработку и legacy очень тяжело, здесь есть два варианта: 1) обновлять кодовую базу как можно чаще и 2) использовать все современные практики, которые действительно упрощают разработку.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Ch3\u003EВывод\u003C\u002Fh3\u003E\u003Cp\u003ENode.js – отличная платформа, основанная на нескольких важных принципах, которые обеспечивают быструю разработку гибких приложений. Для многих разработчиков эти идеи покажутся незнакомыми: асинхронный характер паттерна Reactor, основанный на функциях обратного вызова, требует другого стиля программирования; event loop, который имеет свой конкретный порядок и правила выполнения событий. И, если вы хотите добиться нужного вам перфоманса, все эти правила придется знать и соблюдать.     \u003C\u002Fp\u003E\u003Ch3\u003EИсточники:\u003C\u002Fh3\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fwww.ozon.ru\u002Fproduct\u002Fshablony-proektirovaniya-node-js-141553158\u002F?sh=I2yEwxnL\"\u003EКнига: «Шаблоны проектирования Node.JS» Каскиаро Марио\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fwww.ozon.ru\u002Fproduct\u002Fnode-js-design-patterns-third-edition-design-and-implement-production-grade-node-js-214826009\u002F?sh=OoFzDo5V\"\u003EКнига в оригинале\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FMain_Page\"\u003EВикипедия\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fnodejs.org\u002Fru\u002Fdocs\u002F\"\u003EДокументация Node.js\u003C\u002Fa\u003E \u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"node.js"},{"titleHtml":"event loop"},{"titleHtml":"javascript"},{"titleHtml":"libuv"},{"titleHtml":"Блог компании Lineate"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3b0\u002F829\u002Fd02\u002F3b0829d02464c22c12ec8109bb7c6c3f.png","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3b0\u002F829\u002Fd02\u002F3b0829d02464c22c12ec8109bb7c6c3f.png","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002Flineate\\\u002Fblog\\\u002F585050\\\u002F\"},\"headline\":\"Игра по правилам Event loop в Node.js\",\"datePublished\":\"2021-10-22T19:18:19+03:00\",\"dateModified\":\"2021-10-22T19:53:48+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Илья Горкун\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Я пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на в...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002Flineate\\\u002Fblog\\\u002F585050\\\u002F#post-content-body\",\"about\":[\"c_lineate\",\"h_javascript\",\"h_programming\",\"h_nodejs\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F585050\\\u002Fe20e3d33ef66dfc785d05a35678f18a4\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F3c0\\\u002F958\\\u002F341\\\u002F3c09583419fb578379f15e058bc1725b.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F16e\\\u002F4f5\\\u002F1af\\\u002F16e4f51af60851dbe62e17a3f0beca5c.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fcc1\\\u002Fdf0\\\u002F501\\\u002Fcc1df0501730401720ee7ca5aac31ffb.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fcd7\\\u002Ff67\\\u002F284\\\u002Fcd7f67284e7e30c22e84d72fcf5ecea2.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F0c2\\\u002F3c7\\\u002Fedf\\\u002F0c23c7edf03698dc0894b27a05fa1ee6.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fa0b\\\u002Fae1\\\u002F3e5\\\u002Fa0bae13e59c927da416d5a4482682b0d.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fbc4\\\u002F978\\\u002Fc40\\\u002Fbc4978c40b19553cf8fc9f40fcc955f0.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F3d9\\\u002F9e1\\\u002F1cf\\\u002F3d99e11cfdba9fa2f26a03263ff6f329.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff20\\\u002F2ef\\\u002F209\\\u002Ff202ef2092fae7edc8186ab2e30bd346.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F162\\\u002F308\\\u002F2b8\\\u002F1623082b89b35c3e95c68af4a72be342.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fc34\\\u002F55c\\\u002Fe65\\\u002Fc3455ce65fc0d2685887168d871da03f.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F0e3\\\u002F566\\\u002Fdfe\\\u002F0e3566dfe4e4f5954047894ed87a3ec1.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff48\\\u002F7e6\\\u002Ffbd\\\u002Ff487e6fbd2fbe20ad40cc1d6bcb7a601.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fbb7\\\u002Ff9f\\\u002Fccc\\\u002Fbb7f9fccc968cfc7dd690a4484f54f6a.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fa26\\\u002Fce3\\\u002F51c\\\u002Fa26ce351cce41d0fe7d202840b6e12de.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fa1b\\\u002F7f9\\\u002F7da\\\u002Fa1b7f97da424e6ab8ef58b3d709ce1f5.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F4a0\\\u002F041\\\u002F9f8\\\u002F4a00419f839fd04e747924ffa9b61791.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F351\\\u002F64a\\\u002F822\\\u002F35164a822f5187fe53446dfeef14b21c.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F121\\\u002Fe84\\\u002F894\\\u002F121e848949f90d44ee695f4819744e07.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F6c0\\\u002F527\\\u002F4a8\\\u002F6c05274a83f366a78053b282a40b3537.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F94a\\\u002Ff8a\\\u002Fe7c\\\u002F94af8ae7c2e3f22fb4eefeee030aed56.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ffb1\\\u002Fb23\\\u002Fbeb\\\u002Ffb1b23beb22f7313d13cf231e21df970.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F016\\\u002Fc95\\\u002Fdbd\\\u002F016c95dbdfff3625023eb22c88d701e2.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F488\\\u002F9c2\\\u002F26a\\\u002F4889c226acf52adfab096655ca84ec11.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F699\\\u002Fb34\\\u002F935\\\u002F699b34935247cc535f57e137bab3fee5.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F5fe\\\u002F113\\\u002F2a7\\\u002F5fe1132a76483ab6d0b574470372ea6e.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F696\\\u002Ffb6\\\u002Ff90\\\u002F696fb6f90e40d4018810b83c73d81d97.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F399\\\u002Fb12\\\u002F2a2\\\u002F399b122a21f9860f6902ab54386d051a.png\"]}","metaDescription":"Я пришел в компанию Lineate работать именно на Node.js. В процессе выполнения проектов мне приходилось обращаться к более опытным коллегам и выяснять ответы на возникающие у меня вопросы, но, как...","mainImageUrl":null,"amp":true},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":""},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{"lineate":{"alias":"lineate","imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fcompany\u002Fc68\u002F0e3\u002F5d6\u002Fc680e35d646d65ff4db7b29cdd808f5b.png","titleHtml":"Lineate","descriptionHtml":null,"relatedData":null,"statistics":{"postsCount":1,"newsCount":0,"vacanciesCount":0,"employeesCount":2,"careerRating":null,"subscribersCount":8,"rating":34.02,"invest":null},"foundationDate":{"year":"2006","month":"09","day":"05"},"location":{"city":{"id":"447347","title":"Омск"},"region":{"id":"1912","title":"Омская обл."},"country":{"id":"168","title":"Россия"}},"siteUrl":"https:\u002F\u002Fwww.lineate.ru\u002F","staffNumber":"201–500 человек","registrationDate":"2021-09-27T07:08:44+00:00","representativeUser":null,"contacts":[{"title":"Сайт","url":"https:\u002F\u002Fwww.lineate.ru\u002F"}],"settings":{"analyticsSettings":[],"branding":null,"status":"active"},"metadata":{"titleHtml":"Lineate, Омск -  с 5 сентября 2006 г.","title":"Lineate, Омск -  с 5 сентября 2006 г.","keywords":["JavaScript","Программирование","Node.JS"],"descriptionHtml":"1 статья от авторов компании Lineate","description":"1 статья от авторов компании Lineate"},"aDeskSettings":null,"careerAlias":"lineate","maxCustomTrackerLinks":0}},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
