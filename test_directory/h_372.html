<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Go и MySQL: настраиваем пул соединений / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/company\/oleg-bunin\/blog\/583558\/"},"headline":"Go и MySQL: настраиваем пул соединений","datePublished":"2021-10-18T12:00:02+03:00","dateModified":"2021-10-22T00:52:31+03:00","author":{"@type":"Person","name":"hanagantig"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Каждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем My...","url":"https:\/\/habr.com\/ru\/company\/oleg-bunin\/blog\/583558\/#post-content-body","about":["c_oleg-bunin","c_citymobil","h_mysql","h_go","f_develop"],"image":["https:\/\/habr.com\/share\/publication\/583558\/1496bae271a4dba321bb85600423089f\/","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/501\/d88\/907\/501d889072b9d188f72b03b76ff974a6.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/3f5\/b44\/f62\/3f5b44f628062e054d27b02e9ea448a0.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/94a\/999\/708\/94a999708d24df29b03ee8b77465ef95.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/d15\/056\/f52\/d15056f52e8ddef15f06f4a25cd0666e.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/a1c\/7a9\/914\/a1c7a9914179d91af207410fb255dd0d.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/a4d\/805\/0cc\/a4d8050cc48a5ab28695a23029783272.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/549\/865\/244\/549865244b8a523f3e8dcadbdf7b226d.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/9e3\/aed\/20a\/9e3aed20ab2cfad74009dea56e5d0586.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/c0a\/78f\/147\/c0a78f147e7d6b2f8e54bf24968ee316.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/da5\/225\/06b\/da522506b679612c0eac26f7321280f4.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f7f\/121\/caa\/f7f121caa235fd659024da31b83572c7.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Go и MySQL: настраиваем пул соединений" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Go и MySQL: настраиваем пул соединений" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Go и MySQL: настраиваем пул соединений" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Каждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем MySQL, поэтому я расскажу про..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Каждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем MySQL, поэтому я расскажу про..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Каждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем MySQL, поэтому я расскажу про..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Каждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем MySQL, поэтому я расскажу про..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Каждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем MySQL, поэтому я расскажу про..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habrastorage.org/getpro/habr/upload_files/d5d/985/20d/d5d98520d9a432fb0dcb58854eb4a4d3.png" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/d5d/985/20d/d5d98520d9a432fb0dcb58854eb4a4d3.png" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/d5d/985/20d/d5d98520d9a432fb0dcb58854eb4a4d3.png" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/d5d/985/20d/d5d98520d9a432fb0dcb58854eb4a4d3.png" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/d5d/985/20d/d5d98520d9a432fb0dcb58854eb4a4d3.png" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="583558" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-18T09:00:02.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/583558/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/company/oleg-bunin/blog/583558/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habrastorage.org/getpro/habr/upload_files/d5d/985/20d/d5d98520d9a432fb0dcb58854eb4a4d3.png" data-vmid="image:href"><link data-vue-meta="ssr" rel="amphtml" href="https://habr.com/ru/amp/post/583558/">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" companyName="oleg-bunin" data-async-called="true" class="tm-page"><div class="tm-page-width"><div class="tm-page__header"><div class="tm-company-card__branding tm-company-article__branding tm-company-card__branding_loading"><div class="tm-company-card__branding-placeholder"><!----></div> <a href="https://www.highload.ru/moscow/2021/?utm_source=habr&amp;utm_medium=cpc&amp;utm_campaign=title&amp;utm_content=banner"><img src="//habrastorage.org/getpro/habr/branding/673/a67/310/673a67310118a40a792e1eb97151fd97.png" width="100%" class="tm-company-card__branding-image"></a></div></div> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"><div class="tm-company-card tm-company-article__company-card"><div class="tm-company-card__info"><div class="tm-company-card__header"><a href="/ru/company/oleg-bunin/profile/" class="tm-company-card__avatar"><div class="tm-entity-image"><img alt="" height="48" src="//habrastorage.org/getpro/habr/company/7c3/ad4/7b2/7c3ad47b2aae71b56795f618534e7a51.jpg" width="48" class="tm-entity-image__pic"></div></a> <!----> <div class="tm-rating tm-company-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">401.34</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div> <div class="tm-company-card__info"><a href="/ru/company/oleg-bunin/profile/" class="tm-company-card__name">
        Конференции Олега Бунина (Онтико)
      </a> <div class="tm-company-card__description">Профессиональные конференции для IT-разработчиков</div></div></div> <div class="tm-company-card__buttons"><!----> <!----></div></div> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/hanagantig/" title="hanagantig" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_lilac"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="/ru/users/hanagantig/" class="tm-user-info__username">
      hanagantig
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-18T09:00:02.000Z" title="2021-10-18, 12:00">18  октября   в 12:00</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Go и MySQL: настраиваем пул соединений</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/company/oleg-bunin/blog/" class="tm-article-snippet__hubs-item-link router-link-active"><span>Блог компании Конференции Олега Бунина (Онтико)</span> <!----></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/company/citymobil/blog/" class="tm-article-snippet__hubs-item-link"><span>Блог компании Ситимобил</span> <!----></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/mysql/" class="tm-article-snippet__hubs-item-link"><span>MySQL</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/go/" class="tm-article-snippet__hubs-item-link"><span>Go</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><p>Каждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем MySQL, поэтому я расскажу про конфигурирование соединений с этой базой данных. Пройдемся по основным моментам, на которые нужно обращать внимание при работе с MySQL средствами языка Go: </p><ul><li><p>немного затронем <strong>основы клиент-серверного протокола MySQL</strong>, его базовое устройство и принципы работы;</p></li><li><p>дальше перейдем к Go части и <strong>разберем реализацию пула соединений</strong>;</p></li><li><p>будем двигаться от <strong>конфигурирования соединений к выполнению запросов</strong>, параллельно заглядывая в код драйвера.</p></li></ul><p>Надеюсь каждый для себя найдет что-то полезное.</p><h3>Клиент-серверный протокол MySQL</h3><p>Это полудуплексный протокол, другими словами, он — синхронный. А это значит, что в любой момент времени мы либо отправляем запрос, либо его принимаем. </p><p>После отправки команды на сервер, клиент должен дождаться от него ответа, прежде чем отправить что-то еще. При этом он должен получить сообщение целиком — клиент не может остановиться на полуслове, если только не оборвется соединение.</p><p>Все передаваемые по протоколу данные упаковываются в пакеты. На стороне сервера и на стороне клиента существуют свои предопределенные типы пакетов, которыми они могут обмениваться.</p><p>Как правило, клиент отправляет запрос, упакованный в один пакет, тогда как сервер может ответить несколькими. И даже если клиенту нужна лишь часть пакетов, он все равно должен получить все.</p><p>Транспортом в этом протоколе является TCP, поверх которого клиент и сервер обмениваются этими самыми пакетами в бинарном виде.</p><p>MySQL-протокол разделяют на две основные фазы:</p><h4>Фаза соединения</h4><figure class="full-width "><img src="/img/image-loader.svg" height="441" data-src="https://habrastorage.org/getpro/habr/upload_files/501/d88/907/501d889072b9d188f72b03b76ff974a6.png" data-width="780"/><figcaption></figcaption></figure><p>устанавливается TCP-коннект, после чего сервер MySQL отправляет клиенту <a href="https://dev.mysql.com/doc/internals/en/connection-phase-packets.html#packet-Protocol::Handshake"><u>пакет с хендшейком</u></a> и происходит обмен параметров. Например, клиент может запросить SSL соединение, и в итоге отправить серверу <a href="https://dev.mysql.com/doc/internals/en/connection-phase-packets.html#packet-Protocol::HandshakeResponse"><u>ответный пакет на хендшейк</u></a>.<br/>После успешной первой фазы протокол входит в режим командной фазы.</p><h4>Командная фаза</h4><figure class="full-width "><img src="/img/image-loader.svg" height="441" data-src="https://habrastorage.org/getpro/habr/upload_files/3f5/b44/f62/3f5b44f628062e054d27b02e9ea448a0.png" data-width="781"/><figcaption></figcaption></figure><p>В этой фазе инициативу на себя берет клиент и отправляет серверу <a href="https://dev.mysql.com/doc/internals/en/command-phase.html"><u>командные пакеты</u></a>. В них входят запросы, подготовленные выражения, хранимые процедуры и команды репликации. Сервер обрабатывает запросы клиента и отвечает результатом.</p><p>На протокол MySQL можно посмотреть. Для этого у базы данных есть плагин, который выводит трэйс. Его удобно использовать для тестирования (не продакшн решений), поэтому по умолчанию он в выключенном состоянии. Чтобы его включить, нужно собрать сервер базы данных с опцией <a href="https://dev.mysql.com/doc/extending-mysql/5.7/en/test-protocol-trace-plugin.html"><u>WITH_TEST_TRACE_PLUGIN</u></a>.</p><p>Вы можете наблюдать вывод трэйса в терминале после подключения к серверу. Вот как это выглядит.</p><figure class="full-width "><img src="/img/image-loader.svg" height="1192" data-src="https://habrastorage.org/getpro/habr/upload_files/94a/999/708/94a999708d24df29b03ee8b77465ef95.png" data-width="1308"/><figcaption></figcaption></figure><p>Другой способ посмотреть на передаваемые данные — воспользоваться утилитой <strong>ngrep</strong> на клиенте:</p><pre><code class="bash">sudo ngrep -x -q -d any port 3306</code></pre><p>Вывод данных между клиентом и сервером будет выглядеть так:</p><figure class="full-width "><img src="/img/image-loader.svg" height="879" data-src="https://habrastorage.org/getpro/habr/upload_files/d15/056/f52/d15056f52e8ddef15f06f4a25cd0666e.png" data-width="1015"/><figcaption></figcaption></figure><h2>Библиотеки для GO</h2><p>В стандартной библиотеке языка присутствует лишь основной интерфейс — <a href="https://golang.org/pkg/database/sql/">database/sql</a> для всех sql или sql-like баз данных. Реализацию протоколов для конкретных баз данных мейнтейнеры языка оставили на совести сторонних разработчиков. Поэтому для соединения с MySQL мы будем использовать их <a href="https://github.com/go-sql-driver/mysql"><u>официальный драйвер go-mysql</u></a>, который сам по себе является отдельным пакетом.</p><p>В стандартном пакете sql интерфейса используется пул соединений для подключений к базам данных. Потому что , в протоколе MySQL все запросы происходят синхронно —  каждый клиент может выполнить следующий запрос, только после того, как завершит предыдущий. </p><p>Но есть ли другие варианты?</p><a class="anchor" name="singleConnect" id="singleConnect"></a><h3>Одно соединение</h3><p>Самое первое, что может прийти в голову — использовать одно глобальное соединение для всего сервиса. Понятно, что в результате все новые запросы будут ждать, пока соединение не освободится. Это станет узким местом, и наш сервис может надолго зависнуть.</p><a class="anchor" name="unlimitedConnects" id="unlimitedConnects"></a><h3>Соединение на каждый запрос</h3><p>Можно создавать новое соединение при каждом запросе, закрывая его при завершении. </p><figure class="full-width "><img src="/img/image-loader.svg" height="441" data-src="https://habrastorage.org/getpro/habr/upload_files/a1c/7a9/914/a1c7a9914179d91af207410fb255dd0d.png" data-width="780"/><figcaption></figcaption></figure><p>Это решает основной вопрос с ожиданием соединения, но появляются другие проблемы.</p><p><strong>Во-первых</strong>, мы не сможем контролировать рост соединений в нашу базу. Количество наших соединений будет напрямую зависеть от количества запросов —  сколько запросов придет, столько соединений откроет сервис. A для базы данных это плохо. В штатном режиме у нас может не быть проблем, но в моменты пиковых нагрузок можно дойти до максимально возможного количества соединений со стороны базы данных — и она просто перестанет отвечать. Мы получим ошибки при соединении с базой и в нашем сервисе, и во всех других, которые ее используют.</p><p><strong>Во-вторых</strong>, мы каждый раз будем вынуждены проходить первую фазу соединения с сервером MySQL, в которой устанавливается TCP коннект, хендшейк и авторизация. Эта фаза, по сравнению с командной, более затратная по времени, и мы будем тратить дополнительное время, создавая каждый раз новый коннект.</p><p>Тогда как пул соединений в той или иной мере решает все эти проблемы.</p><h2>Пул соединений</h2><p>С пулом мы можем контролировать общее количество соединений, по которым сервис может ходить в базу. Тем самым, мы можем обезопасить и базу,  и минимизировать число прохождений первой фазы соединения. Потому что в пуле у нас лежат, как правило, подготовленные в командной фазе соединения, с уже пройденной первой фазой коннекта.</p><h3>Инициализация пула</h3><p>Начнем с инициализации нашего пула и посмотрим что происходит в коде прямо из документации пакета go-sql-driver.</p><pre><code class="go">import (
	"database/sql"
	"time"

	_ "github.com/go-sql-driver/mysql"
)

// ...

db, err := sql.Open("mysql", "user:password@/dbname")
if err != nil {
	panic(err)
}
// See "Important settings" section.
db.SetConnMaxLifetime(time.Minute * 3)
db.SetMaxOpenConns(10)
db.SetMaxIdleConns(10)</code></pre><p>В самом начале, при импорте go-sql драйвера, происходит регистрация протокола mysql:</p><pre><code class="go">func init() {
	sql.Register("mysql", &amp;MySQLDriver{})
}

func Register(name string, driver driver.Driver) {
	driversMu.Lock()
	defer driversMu.Unlock()
	if driver == nil {
		panic("sql: Register driver is nil")
	}
	if _, dup := drivers[name]; dup {
		panic("sql: Register called twice for driver " + name)
	}
	drivers[name] = driver
}
</code></pre><p>И дальше, при вызове метода <em>Open</em>, мы говорим, что хотим открыть пул, который будет использовать при соединении протокол с названием ‘mysql’ (первый параметр), реализованный в пакете go-sql-driver,  с переданными конфигурациями во втором параметре. После чего вызываются методы конфигурирования нашего пула, о них поговорим чуть позже.</p><h3>Представление пула</h3><pre><code class="go">type DB struct {
	waitDuration int64 // Total time waited for new connections.

	connector driver.Connector
	numClosed uint64
	mu           sync.Mutex // protects following fields
	freeConn     []*driverConn
	connRequests map[uint64]chan connRequest
	nextRequest  uint64 // Next key to use in connRequests.
	numOpen      int    // number of opened and pending open connections
	openerCh          chan struct{}
	closed            bool
	dep               map[finalCloser]depSet
	lastPut           map[*driverConn]string // stacktrace of last conn's put; debug only
	maxIdleCount      int                    // zero means defaultMaxIdleConns; negative means 0
	maxOpen           int                    // &lt;= 0 means unlimited
	maxLifetime       time.Duration          // maximum amount of time a connection may be reused
	maxIdleTime       time.Duration          // maximum amount of time a connection may be idle before being closed
	cleanerCh         chan struct{}
	waitCount         int64 // Total number of connections waited for.
	maxIdleClosed     int64 // Total number of connections closed due to idle count.
	maxIdleTimeClosed int64 // Total number of connections closed due to idle time.
	maxLifetimeClosed int64 // Total number of connections closed due to max connection lifetime limit.

	stop func() // stop cancels the connection opener.
}</code></pre><p>Эта структура — своего рода абстракция над нашим соединением. Вы можете видеть различные поля структуры, необходимые для конфигураций. Например, поле  <code>freeConn</code>, которое представляет собой слайс из ссылок на соединения по нашему выбранному протоколу (собственно говоря этим полем представлен сам набор наших свободных соединений). Или, например, поле <code>connRequests</code><em>, которое</em> служит для того, чтобы запросить новое соединение и т.д.</p><p>Вызов метода <code>Open</code> приводит к созданию новой структуры <code>DB</code>.</p><h3>Создание пустого пула</h3><p>Внутри него вызывается метод <code>OpenDB</code>, в котором инициализируется структура с начальными данными.</p><pre><code class="go">func OpenDB(c driver.Connector) *DB {
	ctx, cancel := context.WithCancel(context.Background())
	db := &amp;DB{
		connector:    c,
		openerCh:     make(chan struct{}, connectionRequestQueueSize),
		lastPut:      make(map[*driverConn]string),
		connRequests: make(map[uint64]chan connRequest),
		stop:         cancel,
	}

	go db.connectionOpener(ctx)

	return db
}

func (db *DB) connectionOpener(ctx context.Context) {
	for {
		select {
		case &lt;-ctx.Done():
			return
		case &lt;-db.openerCh:
			db.openNewConnection(ctx)
		}
	}
}</code></pre><p>Как видно из приведенного кода, пул инициализируется пустой. Это значит, что на данном этапе никакого соединения к базе мы еще не установили. Поэтому, если у вас есть неверные данные в конфигурации — например, неверный логин или вы ошиблись с паролем — то при вызове метода <em>Open</em> вы об этом еще не узнаете.</p><p>Итак, мы создали пул, и после этого его нужно обязательно настроить.</p><h2>Конфигурирование пула</h2><p>Для настройки пула в основном используются следующие методы:</p><ul><li><p><a href="#SetMaxOpenConns">SetMaxOpenConns()</a></p></li><li><p><a href="#SetMaxIdleConns">SetMaxIdleConns()</a></p></li><li><p><a href="#SetConnMaxLifetime">SetConnMaxLifetime()</a></p></li><li><p><a href="#SetConnMaxIdleTime">SetConnMaxIdleTime()</a></p></li></ul><p>Остановимся на каждом из них подробнее.</p><a class="anchor" name="SetMaxOpenConns" id="SetMaxOpenConns"></a><h3>Максимальное количество соединений</h3><p>Методом <code>SetMaxOpenConns()</code> мы устанавливаем максимально возможное количество открытых соединений до БД из нашего пула. <strong>Будьте внимательны</strong> — по умолчанию это значение равно 0, что означает безлимитное количество соединений. Это может привести к ситуации, о которой мы говорили <a href="#unlimitedConnects">выше</a>, когда при каждом запросе в ваш сервис будет открываться новое соединение.</p><p>Когда же создаются соединения? Обычно, после инициализации пула вызывают метод пинг, который создает соединение к базе. Тут же, кстати можно и проверить что наш конфиг верен:</p><pre><code>err = db.Ping()</code></pre><h4>Стратегии создания соединений</h4><p>Перед каждым выполнением запроса, наш пул пытается получить соединение путем вызова метода <code>conn(ctx context.Context, strategy connReuseStrategy)</code></p><p>В методе реализовано 2 стратегии создания подключения. <strong>AlwaysNewConn</strong> всегда создает новый коннект, а <strong>cachedOrNewConn</strong> сначала пытается взять свободное соединение из пула, если оно есть.</p><p>Если соединений в пуле нет, то метод создаст новое. Если создать новое невозможно в силу установленных нами лимитов на количество открытых соединений, то он создаст запрос на открытие нового соединения и будет ждать его исполнения. </p><p>Соединение, полученное этим методом, сразу переходит в использование и помечается как занятое — мы готовы выполнять свои запросы. После того, как мы освободим это соединение, оно попытается вернуться в пул.</p><a class="anchor" name="SetMaxIdleConns" id="SetMaxIdleConns"></a><h3>Ограничение размера пула</h3><p>Методом <code>SetMaxIdleConns()</code> мы регулируем максимальное количество свободных соединений, которые могут храниться в пуле и ждать пока их используют. По умолчанию в пул можно положить до двух соединений.</p><pre><code class="go">func (db *DB) query(ctx context.Context, query string, args []interface{}, strategy connReuseStrategy) (*Rows, error) {
	dc, err := db.conn(ctx, strategy)
	if err != nil {
		return nil, err
	}

	return db.queryDC(ctx, nil, dc, dc.releaseConn, query, args)
}</code></pre><p>Метод query — это один из самых часто вызываемых методов для выполнения запросов, в котором соединение после использования освобождается и происходит попытка положить его обратно в пул свободных коннектов. В приведенном коде за это отвечает функция <code>dc.releaseConn</code>. Если в пуле уже максимальное количество соединений, то освободившееся соединение закроется.</p><p>Но соединения еще закрываются по времени. Это тоже настраивается.</p><a class="anchor" name="SetConnMaxLifetime" id="SetConnMaxLifetime"></a><h3>Время жизни соединения</h3><p>Метод  <code>SetConnMaxLifetime()</code>  отвечает за определение срока жизни соединения в пуле с момента его создания.</p><pre><code class="go">func (db *DB) startCleanerLocked() {
	if (db.maxLifetime > 0 || db.maxIdleTime > 0) &amp;&amp; db.numOpen > 0 &amp;&amp; db.cleanerCh == nil {
		db.cleanerCh = make(chan struct{}, 1)
		go db.connectionCleaner(db.shortestIdleTimeLocked())
	}
}</code></pre><p>Проверка на возраст осуществляется при каждой попытке достать коннект из пула. Также за возрастом следит <code>connectionCleaner</code>. Он просто закрывает просроченные коннекты, перебирая их в цикле и проверяя срок жизни.</p><p>Но это еще не все. Начиная с Go версии 1.15 для соединения можно указать срок ожидания.</p><a class="anchor" name="SetConnMaxIdleTime" id="SetConnMaxIdleTime"></a><h3>Время ожидания в пуле</h3><p>Метод <code>SetConnMaxIdleTime()</code>  настраивает максимальное количество времени, в течении которого соединение может находиться в пуле в режиме ожидания. Эта настройка очень похожа на предыдущую, но существенное отличие в том, что время жизни соединения отсчитывается от даты его создания, а время ожидания в пуле считается с того момента времени, когда это соединение вернулось в пул.</p><p>После истечения этого времени соединение также закрывается.</p><h2>Возврат соединения в пул</h2><p>Как мы говорили, при выполнении запроса соединение берется из пула или создается, если в пуле ничего нет, после чего помечается как занятое. После выполнения запросов мы должны его освобождать.</p><p>Когда мы получаем данные по нашему запросу, нам возвращается структура с результатами Rows, в которой также находится наше соединение.</p><pre><code class="go">var (
		id int
		title string
	)
	// ...
	rows, err := db.QueryContext(ctx, "SELECT id, title FROM articles WHERE author_id = ?", 1)
	if err != nil {
		log.Fatal(err)
	}

	for rows.Next() {
		err := rows.Scan(&amp;id, &amp;title)
		if err != nil {
			log.Fatal(err)
		}
		log.Println(id, title)
	}
	// ...</code></pre><p>При вызове метода <code>Close()</code> происходит освобождение соединения и попытка положить его в пул или закрыть, если в пуле нет места. Поэтому писать код, как в примере выше — плохо. Обязательно вызывайте <code>Close</code>, как минимум, в <code>defer</code>.</p><pre><code class="go">// ...
	rows, err := db.QueryContext(ctx, "SELECT id, title FROM articles WHERE author_id = ?", 1)
	if err != nil {
		log.Fatal(err)
	}
	
	defer rows.Close()
	for rows.Next() {
		err := rows.Scan(&amp;id, &amp;title)
		if err != nil {
			log.Fatal(err)
		}
		log.Println(id, title)
	}
	// ...</code></pre><p>Если не освобождать соединения, то они будут просто висеть в статусе «занятые», расходовать память и забивать количество открытых соединений. В итоге мы можем получить пустой пул, так как все соединения будут считаться занятыми, но при этом новое соединение мы создать не сможем, потому что достигли лимита максимально открытых соединений. Все это приведет к ситуации, при которой мы не можем ни создать новые соединения, ни воспользоваться имеющимися.</p><p>Но еще лучше делать таким образом:</p><pre><code class="go">// ...
	rows, err := db.QueryContext(ctx, "SELECT id, title FROM articles WHERE author_id = ?", 1)
	if err != nil {
		log.Fatal(err)
	}

	defer rows.Close()
	for rows.Next() {
		err := rows.Scan(&amp;id, &amp;title)
		if err != nil {
			log.Fatal(err)
		}
		log.Println(id, title)
	}
	err = rows.Close()
	if err != nil {
		log.Fatal(err)
	}
	// ...</code></pre><p>Дело в том, что когда происходит Scan(), Go пытается конвертировать байты, которые пришли из MySQL к типам данных переданных в параметрах. И обратите внимание, что метод выполнения запроса завязан на контексте. Если в процессе выполнения <em>Scan()</em> произойдет обнуление контекста, то данные могут получиться поврежденными. Об этой проблеме довольно подробно написано в <a href="https://github.blog/2020-05-20-three-bugs-in-the-go-mysql-driver/"><u>данной статье в разделе «The race»</u></a>.</p><p>Отловить эту ошибку можно только в явном вызове метода <code>Close</code> и проверке на ошибку. А в <code>defer</code> мы оставляем <code>Close</code> для уверенности, что если произойдут какие-то паники, то коннект вернется в пул.</p><p>Дальше я на синтетических примерах покажу, как все это влияет на реальные запросы в базу данных. Но перед этим давайте посмотрим еще на один интересный нюанс, который влияет на наши запросы.</p><h2>Интерполяция параметров</h2><p>Как правило, для выполнения запросов с параметрами используются плейсхолдеры, чтобы избежать возможных sql инъекций:</p><pre><code class="go">db.QueryRow(“SELECT * FROM client WHERE id=?”, id)</code></pre><p>Но данный способ выполнения запросов может работать по-разному, в зависимости от настроек.</p><p>В качестве конфигурирования соединения с MySQL также поддерживается параметр <code>interpolateParams=true/false.</code> По умолчанию его значение равно <code>false</code>, что равносильно непереданному параметру.</p><p>В случае <code>false</code> для выполнения приведенного запроса сначала на сервер БД отправляется команда для подготовки выражения (<a href="https://dev.mysql.com/doc/refman/8.0/en/sql-prepared-statements.html"><u>Prepared Statements</u></a>), после чего будет отправлена новая команда на выполнение подготовленного выражения.</p><p>Когда у нас большой и сложный запрос с многочисленными плейсхолдерами, который будет выполняться в методе несколько раз (например мы что-то выполняем батчами), то подготовленные выражения ускоряют нашу работу. Выполнив один раз подготовку на сервере MySQL, дальше мы используем готовый запрос, не тратя каждый раз ресурсы на его парсинг.</p><p>При включенной интерполяции, то есть в значении <code>true</code>, замена плейсхолдеров на значения выполняется в коде библиотеки go. Но если не включить интерполяцию параметров для обычных разовых запросов, мы получим по два TCP запроса к серверу MySQL вместо одного (не считая само соединение).</p><p>Запрос с параметром <code>interpolateParams=false</code></p><figure class="full-width "><img src="/img/image-loader.svg" height="335" data-src="https://habrastorage.org/getpro/habr/upload_files/a4d/805/0cc/a4d8050cc48a5ab28695a23029783272.png" data-width="1726"/><figcaption></figcaption></figure><p>тот же запрос, с <code>interpolateParams=true</code></p><figure class="full-width "><img src="/img/image-loader.svg" height="366" data-src="https://habrastorage.org/getpro/habr/upload_files/549/865/244/549865244b8a523f3e8dcadbdf7b226d.png" data-width="1813"/><figcaption></figcaption></figure><h2>Пул на практике</h2><p>Давайте посмотрим несколько примеров конфигурации пула в действии. Я буду выполнять в цикле запрос <code>SELECT SLEEP(2);</code> в базу данных MySQL и смотреть, что происходит с соединениями. В приведенном коде есть пауза в одну секунду после каждого запроса, чтобы соединения не успевали переиспользоваться и мы увидели более наглядную картину:</p><pre><code class="go">func BenchmarkPool(b *testing.B) {
  ctx := context.Background()
  maxLifeTime := time.Second * 0
	maxOpenConns := 0
	maxIdleConns := 0
	db := NewPool(maxLifeTime, maxOpenConns,maxIdleConns)


  tx := apm.DefaultTracer.StartTransaction("BenchmarkPool", "request")
  ctx = apm.ContextWithTransaction(ctx, tx)

  for i := 0; i &lt; 5; i++ {
     db.wg.Add(1)
     go db.selectSleep(ctx)
     time.Sleep(1 * time.Second)
  }
  db.wg.Wait()

  tx.End()
  apm.DefaultTracer.Flush(nil)
}
</code></pre><p>В первом кейсе посмотрим на вариант с <code>maxOpenConns = 1</code> и <code>maxIdleConns = 0</code><em>:</em></p><pre><code class="go">maxLifeTime := time.Second * 10
maxOpenConns := 1
maxIdleConns := 0
db := NewPool(maxLifeTime, maxOpenConns,maxIdleConns)</code></pre><p>Это нас приведет к ситуации, о которой мы говорили <a href="#singleConnect">выше</a>. Когда каждый вызов нашего метода будет блокировать на себя соединение, а остальные запросы будут ждать, пока соединение не освободится. Обратите внимание на то, что потребовалось 11 секунд:</p><figure class="full-width "><img src="/img/image-loader.svg" height="934" data-src="https://habrastorage.org/getpro/habr/upload_files/9e3/aed/20a/9e3aed20ab2cfad74009dea56e5d0586.png" data-width="2598"/><figcaption></figcaption></figure><p>Дальше я изменю <code>maxOpenConns := 0</code><em>:</em></p><pre><code class="go">maxLifeTime := time.Second * 10
maxOpenConns := 0
maxIdleConns := 0
db := NewPool(maxLifeTime, maxOpenConns,maxIdleConns)</code></pre><p>Это приведет ко <a href="#unlimitedConnects">второму</a> нашему случаю, когда каждый запрос будет создавать новое соединение к базе. В итоге мы будем получать ошибку при попытке соединения, так как на стороне базы данных установлены ограничения на количество подключений:</p><figure class="full-width "><img src="/img/image-loader.svg" height="942" data-src="https://habrastorage.org/getpro/habr/upload_files/c0a/78f/147/c0a78f147e7d6b2f8e54bf24968ee316.png" data-width="2644"/><figcaption></figcaption></figure><p>Теперь выставим <code>maxOpenConns=3</code> так как у нас есть ограничения:</p><pre><code class="go">maxLifeTime := time.Second * 10
maxOpenConns := 3
maxIdleConns := 0
db := NewPool(maxLifeTime, maxOpenConns,maxIdleConns)</code></pre><p>В данном случае у нас уже есть возможность открыть три соединения, которые могут работать параллельно. И те же пять запросов заняли 6.2 секунды вместо 11, как в первом случае. Но при этом видим, что на каждый запрос мы заново проходим этап соединения с базой.</p><figure class="full-width "><img src="/img/image-loader.svg" height="1454" data-src="https://habrastorage.org/getpro/habr/upload_files/da5/225/06b/da522506b679612c0eac26f7321280f4.png" data-width="2410"/><figcaption></figcaption></figure><p>Сконфигурируем пул так, чтобы минимизировать соединения. Установим <code>maxIdleConns=3</code><em>:</em></p><pre><code class="go">maxLifeTime := time.Second * 10 
maxOpenConns := 3 
maxIdleConns := 3 
db := NewPool(maxLifeTime, maxOpenConns,maxIdleConns)</code></pre><figure class="full-width "><img src="/img/image-loader.svg" height="1224" data-src="https://habrastorage.org/getpro/habr/upload_files/f7f/121/caa/f7f121caa235fd659024da31b83572c7.png" data-width="2472"/><figcaption></figcaption></figure><p>В результате мы проходим этап соединения всего 3 раза и помещаем подготовленные коннекты в пул. При последующих запросах в базу данных они берутся из пула с уже пройденной фазой авторизации и остается просто отправить команду. И в целом запросы выполняются быстрее.</p><h2>Подводим итоги</h2><ol><li><p>Никогда не оставляйте настройки пула соединений по умолчанию, его всегда нужно настраивать под ваши нужды;</p></li><li><p>Устанавливайте <code>maxOpenConns</code> ниже настроенных лимитов соединений на стороне базы данных;</p></li><li><p><code>maxOpenConns = 0</code> означает неограниченное количество соединений;</p></li><li><p>Если на вашем сервере MySQL настроены таймауты для неактивных соединений и закрываются они на стороне базы данных, то нет необходимости в использовании <code>maxLifeTime</code>, так как go драйвер сам обнаружит обрыв и пересоздаст соединение;</p></li><li><p>Подбирайте значение <code>maxLifeTime</code> так, чтобы минимизировать создание соединений при пиковых нагрузках на ваш сервис, а когда нагрузка падает - соединения не должны долго висеть без дела;</p></li><li><p>Не забывайте про метод <code>SetConnMaxIdleTime</code> (с go 1.15). С его помощью вы сможете сократить время ожидания соединения в пуле, удаляя его, если им никто не пользуется. Так вы сэкономите на количестве открытых соединений в базе данных и уменьшите расход памяти в сервисе.</p></li><li><p>Всегда освобождайте соединение после запроса (<code>rows.Close()</code>). Некоторые методы делают это сами, но ничего страшного, если вы повторите вызов <code>Close()</code> для надежности; </p></li><li><p>Если вы используете несколько пулов для одной базы данных (например пул для чтения и пул для записи), то суммарное количество  <code>maxOpenConns</code> этих двух пулов должно быть меньше настроенных лимитов соединений на стороне базы данных;</p></li><li><p>Если вы масштабируете свой сервис, то не забывайте что открытые соединения также увеличатся. Если добавляете три инстанса, то следите, чтобы сумма <code>maxOpenConns</code> всех трех была меньше настроенных лимитов соединений на стороне базы данных;</p></li><li><p>Не забывайте про различные прокси, которые со своими таймаутами и ограничениями могут стоять между вами и вашей базой данных. Учитывайте настройки посредников тоже;</p></li><li><p>Учитывайте особенности своего сервиса. Принимайте во внимание характер нагрузки и корректируйте настройки пула;</p></li><li><p>Не забывайте про мониторинги, за пулом тоже нужно следить.</p><p>Спасибо, что дочитали до конца! Если остались вопросы, пишите в комментариях, буду рад помочь.</p></li></ol><p><strong>UPD:<br/></strong>Дополнение по комментарию <a class="mention" href="/users/atercattus">@AterCattus</a><br/><br/>Если производительности "стандартного" пакета MySQL недостаточно, то можно взять альтернативу - <a href="https://github.com/go-mysql-org/go-mysql/">https://github.com/go-mysql-org/go-mysql/</a>. Данный пакет не совсем совместим с <a href="https://golang.org/pkg/database/sql/">database/sql</a>, но позволяет пропускать через себя значительно больше запросов за счет минимизации абстракций и аллокаций.</p><p><strong>UPD 2:<br/>Дополнение о подготовленных выражениях</strong> по вопросу из комментариев.</p><p>Для общего понимания, определим как происходит подготовка запроса:</p><ol><li><p>Клиент отправляет команду серверу на подготовку запроса с плейсхолдерами;</p></li><li><p>Сервер обрабатывает запрос и возвращает идентификатор подготовленного выражения;</p></li><li><p>Клиент выполняет запрос отправляя серверу идентификатор подготовленного выражения и параметры, с которыми должен выполниться запрос.</p></li></ol><p>Для подготовки выражения мы можем воспользоваться методом <code>(*DB).Prepare()</code>, который после выполнения подготовки вернет нам ссылку на структуру <code>*Stmt</code>. Метод <code>(*DB).Prepare()</code> никак не учитывает настройку <code>interpolateParams</code>, он просто отправляет команду mysql серверу.</p><p>Чтобы выполнить запрос с подготовленным выражением нужно воспользоваться методом <code>(*Stmt) Query()</code>, замечу, что это другой метод, отличный от метода <code>(*DB) Query()</code> , и он тоже не учитывает  <code>interpolateParams</code> . Мы явно просим библиотеку выполнить подготовку на сервере и потом отправляем вторую команду на выполнение запроса для подготовленного выражения.</p><p>Подготовленное выражение по методу <code>(*DB).Prepare()</code> завязывается на соединение. Если при выполнении <code>(*Stmt) Query()</code> соединение, с которым выполнялась подготовка, недоступно (занято или вовсе закрылось), то будет создано (взято из пула) новое соединение и снова выполнится команда подготовки выражения, и только потом уже сам запрос. Это может привести к лишним подготовкам одних и тех же запросов. Метод <code>(*Stmt) Close()</code> при этом закрывает выражение и выполнение запросов после этого приведет к ошибке <code>sql: statement is closed</code>.</p></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bgo%5D" class="tm-tags-list__link">go</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bgolang%5D" class="tm-tags-list__link">golang</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bmysql%5D" class="tm-tags-list__link">mysql</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bhighload%5D" class="tm-tags-list__link">highload</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bconnection%20pool%5D" class="tm-tags-list__link">connection pool</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BC%D0%B8%D0%BA%D1%80%D0%BE%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B%5D" class="tm-tags-list__link">микросервисы</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/company/oleg-bunin/blog/" class="tm-hubs-list__link router-link-active">
    Блог компании Конференции Олега Бунина (Онтико)
  </a></li><li class="tm-separated-list__item"><a href="/ru/company/citymobil/blog/" class="tm-hubs-list__link">
    Блог компании Ситимобил
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/mysql/" class="tm-hubs-list__link">
    MySQL
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/go/" class="tm-hubs-list__link">
    Go
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 43: ↑42 и ↓1</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 43: ↑42 и ↓1" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+41</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">6K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    83
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"><div class="tm-article-author__company"><div class="tm-article-author__company-card"><div class="tm-company-snippet"><a href="/ru/company/oleg-bunin/profile/" class="tm-company-snippet__logo-link"><div class="tm-entity-image"><img alt="" height="40" src="//habrastorage.org/getpro/habr/company/7c3/ad4/7b2/7c3ad47b2aae71b56795f618534e7a51.jpg" width="40" class="tm-entity-image__pic"></div></a> <div class="tm-company-snippet__info"><a href="/ru/company/oleg-bunin/profile/" class="tm-company-snippet__title">Конференции Олега Бунина (Онтико)</a> <div class="tm-company-snippet__description">Профессиональные конференции для IT-разработчиков</div></div></div> <div class="tm-article-author__buttons"><!----> <!----></div></div> <div class="tm-article-author__company-contacts"><a href="https://facebook.com/oleg.bunin" rel="noopener" target="_blank" class="tm-article-author__contact">
      Facebook
    </a><a href="https://facebook.com/HighLoadConference" rel="noopener" target="_blank" class="tm-article-author__contact">
      Facebook
    </a><a href="https://facebook.com/ritfest" rel="noopener" target="_blank" class="tm-article-author__contact">
      Facebook
    </a></div> <div class="tm-article-author__separator"></div></div> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/hanagantig/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_lilac"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 18 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    16
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">41</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><!----> <a href="/ru/users/hanagantig/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @hanagantig
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Backend developer</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/company/oleg-bunin/blog/583558/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 12 
    </span></a> <!----></div></div></div>  <!---->  <!----> <!----></div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__placeholder_initial"></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <section class="tm-block tm-block_spacing-bottom"><header class="tm-block__header"><h2 class="tm-block__title">Информация</h2> <!----></header> <div class="tm-block__body"><div class="tm-company-basic-info"><dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата основания</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2007-12-31T21:00:00.000Z" title="2008-01-01, 00:00">1  января  2008</time></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Местоположение</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    Россия
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Сайт</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><a href="http://www.ontico.ru/" target="_blank" class="tm-company-basic-info__link">
      www.ontico.ru
    </a></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Численность</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    11–30 человек
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата регистрации</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2010-02-24T19:37:40.000Z" title="2010-02-24, 22:37">24  февраля  2010</time></dd></dl> <!----></div></div> <!----></section> <div class="tm-company-widgets"></div> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/company/oleg-bunin/blog/583558/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/company/oleg-bunin/blog/583558/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"583558":{"id":"583558","timePublished":"2021-10-18T09:00:02+00:00","isCorporative":true,"lang":"ru","titleHtml":"Go и MySQL: настраиваем пул соединений","leadData":{"textHtml":"\u003Cp\u003EКаждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем MySQL, поэтому я расскажу про конфигурирование соединений с этой базой данных. Пройдемся по основным моментам, на которые нужно обращать внимание при работе с MySQL средствами языка Go:&nbsp;\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E•\u003C\u002Fstrong\u003E немного затронем \u003Cstrong\u003Eосновы клиент-серверного протокола MySQL\u003C\u002Fstrong\u003E, его базовое устройство и принципы работы;\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E•\u003C\u002Fstrong\u003E дальше перейдем к Go части и \u003Cstrong\u003Eразберем реализацию пула соединений\u003C\u002Fstrong\u003E;\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E•\u003C\u002Fstrong\u003E будем двигаться от \u003Cstrong\u003Eконфигурирования соединений к выполнению запросов\u003C\u002Fstrong\u003E, параллельно заглядывая в код драйвера.\u003C\u002Fp\u003E\u003Cp\u003EНадеюсь каждый для себя найдет что-то полезное.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd5d\u002F985\u002F20d\u002Fd5d98520d9a432fb0dcb58854eb4a4d3.png","buttonTextHtml":"Поехали","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd5d\u002F985\u002F20d\u002Fd5d98520d9a432fb0dcb58854eb4a4d3.png","fit":"cover","positionY":0,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":16,"votesCount":18},"rating":41,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"214261","alias":"hanagantig","fullname":null,"avatarUrl":null,"speciality":"Backend developer"},"statistics":{"commentsCount":12,"favoritesCount":83,"readingCount":6002,"score":41,"votesCount":43},"hubs":[{"relatedData":null,"id":"14332","alias":"oleg-bunin","type":"corporative","title":"Блог компании Конференции Олега Бунина (Онтико)","titleHtml":"Блог компании Конференции Олега Бунина (Онтико)","isProfiled":false},{"relatedData":null,"id":"22390","alias":"citymobil","type":"corporative","title":"Блог компании Ситимобил","titleHtml":"Блог компании Ситимобил","isProfiled":false},{"relatedData":null,"id":"306","alias":"mysql","type":"collective","title":"MySQL","titleHtml":"MySQL","isProfiled":true},{"relatedData":null,"id":"17748","alias":"go","type":"collective","title":"Go","titleHtml":"Go","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cp\u003EКаждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем MySQL, поэтому я расскажу про конфигурирование соединений с этой базой данных. Пройдемся по основным моментам, на которые нужно обращать внимание при работе с MySQL средствами языка Go: \u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eнемного затронем \u003Cstrong\u003Eосновы клиент-серверного протокола MySQL\u003C\u002Fstrong\u003E, его базовое устройство и принципы работы;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eдальше перейдем к Go части и \u003Cstrong\u003Eразберем реализацию пула соединений\u003C\u002Fstrong\u003E;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eбудем двигаться от \u003Cstrong\u003Eконфигурирования соединений к выполнению запросов\u003C\u002Fstrong\u003E, параллельно заглядывая в код драйвера.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EНадеюсь каждый для себя найдет что-то полезное.\u003C\u002Fp\u003E\u003Ch3\u003EКлиент-серверный протокол MySQL\u003C\u002Fh3\u003E\u003Cp\u003EЭто полудуплексный протокол, другими словами, он — синхронный. А это значит, что в любой момент времени мы либо отправляем запрос, либо его принимаем. \u003C\u002Fp\u003E\u003Cp\u003EПосле отправки команды на сервер, клиент должен дождаться от него ответа, прежде чем отправить что-то еще. При этом он должен получить сообщение целиком — клиент не может остановиться на полуслове, если только не оборвется соединение.\u003C\u002Fp\u003E\u003Cp\u003EВсе передаваемые по протоколу данные упаковываются в пакеты. На стороне сервера и на стороне клиента существуют свои предопределенные типы пакетов, которыми они могут обмениваться.\u003C\u002Fp\u003E\u003Cp\u003EКак правило, клиент отправляет запрос, упакованный в один пакет, тогда как сервер может ответить несколькими. И даже если клиенту нужна лишь часть пакетов, он все равно должен получить все.\u003C\u002Fp\u003E\u003Cp\u003EТранспортом в этом протоколе является TCP, поверх которого клиент и сервер обмениваются этими самыми пакетами в бинарном виде.\u003C\u002Fp\u003E\u003Cp\u003EMySQL-протокол разделяют на две основные фазы:\u003C\u002Fp\u003E\u003Ch4\u003EФаза соединения\u003C\u002Fh4\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"441\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F501\u002Fd88\u002F907\u002F501d889072b9d188f72b03b76ff974a6.png\" data-width=\"780\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003Eустанавливается TCP-коннект, после чего сервер MySQL отправляет клиенту \u003Ca href=\"https:\u002F\u002Fdev.mysql.com\u002Fdoc\u002Finternals\u002Fen\u002Fconnection-phase-packets.html#packet-Protocol::Handshake\"\u003E\u003Cu\u003Eпакет с хендшейком\u003C\u002Fu\u003E\u003C\u002Fa\u003E и происходит обмен параметров. Например, клиент может запросить SSL соединение, и в итоге отправить серверу \u003Ca href=\"https:\u002F\u002Fdev.mysql.com\u002Fdoc\u002Finternals\u002Fen\u002Fconnection-phase-packets.html#packet-Protocol::HandshakeResponse\"\u003E\u003Cu\u003Eответный пакет на хендшейк\u003C\u002Fu\u003E\u003C\u002Fa\u003E.\u003Cbr\u002F\u003EПосле успешной первой фазы протокол входит в режим командной фазы.\u003C\u002Fp\u003E\u003Ch4\u003EКомандная фаза\u003C\u002Fh4\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"441\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3f5\u002Fb44\u002Ff62\u002F3f5b44f628062e054d27b02e9ea448a0.png\" data-width=\"781\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ этой фазе инициативу на себя берет клиент и отправляет серверу \u003Ca href=\"https:\u002F\u002Fdev.mysql.com\u002Fdoc\u002Finternals\u002Fen\u002Fcommand-phase.html\"\u003E\u003Cu\u003Eкомандные пакеты\u003C\u002Fu\u003E\u003C\u002Fa\u003E. В них входят запросы, подготовленные выражения, хранимые процедуры и команды репликации. Сервер обрабатывает запросы клиента и отвечает результатом.\u003C\u002Fp\u003E\u003Cp\u003EНа протокол MySQL можно посмотреть. Для этого у базы данных есть плагин, который выводит трэйс. Его удобно использовать для тестирования (не продакшн решений), поэтому по умолчанию он в выключенном состоянии. Чтобы его включить, нужно собрать сервер базы данных с опцией \u003Ca href=\"https:\u002F\u002Fdev.mysql.com\u002Fdoc\u002Fextending-mysql\u002F5.7\u002Fen\u002Ftest-protocol-trace-plugin.html\"\u003E\u003Cu\u003EWITH_TEST_TRACE_PLUGIN\u003C\u002Fu\u003E\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EВы можете наблюдать вывод трэйса в терминале после подключения к серверу. Вот как это выглядит.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"1192\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F94a\u002F999\u002F708\u002F94a999708d24df29b03ee8b77465ef95.png\" data-width=\"1308\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДругой способ посмотреть на передаваемые данные — воспользоваться утилитой \u003Cstrong\u003Engrep\u003C\u002Fstrong\u003E на клиенте:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Esudo ngrep -x -q -d any port 3306\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВывод данных между клиентом и сервером будет выглядеть так:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"879\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd15\u002F056\u002Ff52\u002Fd15056f52e8ddef15f06f4a25cd0666e.png\" data-width=\"1015\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Ch2\u003EБиблиотеки для GO\u003C\u002Fh2\u003E\u003Cp\u003EВ стандартной библиотеке языка присутствует лишь основной интерфейс — \u003Ca href=\"https:\u002F\u002Fgolang.org\u002Fpkg\u002Fdatabase\u002Fsql\u002F\"\u003Edatabase\u002Fsql\u003C\u002Fa\u003E для всех sql или sql-like баз данных. Реализацию протоколов для конкретных баз данных мейнтейнеры языка оставили на совести сторонних разработчиков. Поэтому для соединения с MySQL мы будем использовать их \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fgo-sql-driver\u002Fmysql\"\u003E\u003Cu\u003Eофициальный драйвер go-mysql\u003C\u002Fu\u003E\u003C\u002Fa\u003E, который сам по себе является отдельным пакетом.\u003C\u002Fp\u003E\u003Cp\u003EВ стандартном пакете sql интерфейса используется пул соединений для подключений к базам данных. Потому что , в протоколе MySQL все запросы происходят синхронно —  каждый клиент может выполнить следующий запрос, только после того, как завершит предыдущий. \u003C\u002Fp\u003E\u003Cp\u003EНо есть ли другие варианты?\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"singleConnect\" id=\"singleConnect\"\u003E\u003C\u002Fa\u003E\u003Ch3\u003EОдно соединение\u003C\u002Fh3\u003E\u003Cp\u003EСамое первое, что может прийти в голову — использовать одно глобальное соединение для всего сервиса. Понятно, что в результате все новые запросы будут ждать, пока соединение не освободится. Это станет узким местом, и наш сервис может надолго зависнуть.\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"unlimitedConnects\" id=\"unlimitedConnects\"\u003E\u003C\u002Fa\u003E\u003Ch3\u003EСоединение на каждый запрос\u003C\u002Fh3\u003E\u003Cp\u003EМожно создавать новое соединение при каждом запросе, закрывая его при завершении. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"441\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa1c\u002F7a9\u002F914\u002Fa1c7a9914179d91af207410fb255dd0d.png\" data-width=\"780\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЭто решает основной вопрос с ожиданием соединения, но появляются другие проблемы.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EВо-первых\u003C\u002Fstrong\u003E, мы не сможем контролировать рост соединений в нашу базу. Количество наших соединений будет напрямую зависеть от количества запросов —  сколько запросов придет, столько соединений откроет сервис. A для базы данных это плохо. В штатном режиме у нас может не быть проблем, но в моменты пиковых нагрузок можно дойти до максимально возможного количества соединений со стороны базы данных — и она просто перестанет отвечать. Мы получим ошибки при соединении с базой и в нашем сервисе, и во всех других, которые ее используют.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EВо-вторых\u003C\u002Fstrong\u003E, мы каждый раз будем вынуждены проходить первую фазу соединения с сервером MySQL, в которой устанавливается TCP коннект, хендшейк и авторизация. Эта фаза, по сравнению с командной, более затратная по времени, и мы будем тратить дополнительное время, создавая каждый раз новый коннект.\u003C\u002Fp\u003E\u003Cp\u003EТогда как пул соединений в той или иной мере решает все эти проблемы.\u003C\u002Fp\u003E\u003Ch2\u003EПул соединений\u003C\u002Fh2\u003E\u003Cp\u003EС пулом мы можем контролировать общее количество соединений, по которым сервис может ходить в базу. Тем самым, мы можем обезопасить и базу,  и минимизировать число прохождений первой фазы соединения. Потому что в пуле у нас лежат, как правило, подготовленные в командной фазе соединения, с уже пройденной первой фазой коннекта.\u003C\u002Fp\u003E\u003Ch3\u003EИнициализация пула\u003C\u002Fh3\u003E\u003Cp\u003EНачнем с инициализации нашего пула и посмотрим что происходит в коде прямо из документации пакета go-sql-driver.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003Eimport (\n\t\"database\u002Fsql\"\n\t\"time\"\n\n\t_ \"github.com\u002Fgo-sql-driver\u002Fmysql\"\n)\n\n\u002F\u002F ...\n\ndb, err := sql.Open(\"mysql\", \"user:password@\u002Fdbname\")\nif err != nil {\n\tpanic(err)\n}\n\u002F\u002F See \"Important settings\" section.\ndb.SetConnMaxLifetime(time.Minute * 3)\ndb.SetMaxOpenConns(10)\ndb.SetMaxIdleConns(10)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВ самом начале, при импорте go-sql драйвера, происходит регистрация протокола mysql:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc init() {\n\tsql.Register(\"mysql\", &amp;MySQLDriver{})\n}\n\nfunc Register(name string, driver driver.Driver) {\n\tdriversMu.Lock()\n\tdefer driversMu.Unlock()\n\tif driver == nil {\n\t\tpanic(\"sql: Register driver is nil\")\n\t}\n\tif _, dup := drivers[name]; dup {\n\t\tpanic(\"sql: Register called twice for driver \" + name)\n\t}\n\tdrivers[name] = driver\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EИ дальше, при вызове метода \u003Cem\u003EOpen\u003C\u002Fem\u003E, мы говорим, что хотим открыть пул, который будет использовать при соединении протокол с названием ‘mysql’ (первый параметр), реализованный в пакете go-sql-driver,  с переданными конфигурациями во втором параметре. После чего вызываются методы конфигурирования нашего пула, о них поговорим чуть позже.\u003C\u002Fp\u003E\u003Ch3\u003EПредставление пула\u003C\u002Fh3\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003Etype DB struct {\n\twaitDuration int64 \u002F\u002F Total time waited for new connections.\n\n\tconnector driver.Connector\n\tnumClosed uint64\n\tmu           sync.Mutex \u002F\u002F protects following fields\n\tfreeConn     []*driverConn\n\tconnRequests map[uint64]chan connRequest\n\tnextRequest  uint64 \u002F\u002F Next key to use in connRequests.\n\tnumOpen      int    \u002F\u002F number of opened and pending open connections\n\topenerCh          chan struct{}\n\tclosed            bool\n\tdep               map[finalCloser]depSet\n\tlastPut           map[*driverConn]string \u002F\u002F stacktrace of last conn's put; debug only\n\tmaxIdleCount      int                    \u002F\u002F zero means defaultMaxIdleConns; negative means 0\n\tmaxOpen           int                    \u002F\u002F &lt;= 0 means unlimited\n\tmaxLifetime       time.Duration          \u002F\u002F maximum amount of time a connection may be reused\n\tmaxIdleTime       time.Duration          \u002F\u002F maximum amount of time a connection may be idle before being closed\n\tcleanerCh         chan struct{}\n\twaitCount         int64 \u002F\u002F Total number of connections waited for.\n\tmaxIdleClosed     int64 \u002F\u002F Total number of connections closed due to idle count.\n\tmaxIdleTimeClosed int64 \u002F\u002F Total number of connections closed due to idle time.\n\tmaxLifetimeClosed int64 \u002F\u002F Total number of connections closed due to max connection lifetime limit.\n\n\tstop func() \u002F\u002F stop cancels the connection opener.\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЭта структура — своего рода абстракция над нашим соединением. Вы можете видеть различные поля структуры, необходимые для конфигураций. Например, поле  \u003Ccode\u003EfreeConn\u003C\u002Fcode\u003E, которое представляет собой слайс из ссылок на соединения по нашему выбранному протоколу (собственно говоря этим полем представлен сам набор наших свободных соединений). Или, например, поле \u003Ccode\u003EconnRequests\u003C\u002Fcode\u003E\u003Cem\u003E, которое\u003C\u002Fem\u003E служит для того, чтобы запросить новое соединение и т.д.\u003C\u002Fp\u003E\u003Cp\u003EВызов метода \u003Ccode\u003EOpen\u003C\u002Fcode\u003E приводит к созданию новой структуры \u003Ccode\u003EDB\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Ch3\u003EСоздание пустого пула\u003C\u002Fh3\u003E\u003Cp\u003EВнутри него вызывается метод \u003Ccode\u003EOpenDB\u003C\u002Fcode\u003E, в котором инициализируется структура с начальными данными.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc OpenDB(c driver.Connector) *DB {\n\tctx, cancel := context.WithCancel(context.Background())\n\tdb := &amp;DB{\n\t\tconnector:    c,\n\t\topenerCh:     make(chan struct{}, connectionRequestQueueSize),\n\t\tlastPut:      make(map[*driverConn]string),\n\t\tconnRequests: make(map[uint64]chan connRequest),\n\t\tstop:         cancel,\n\t}\n\n\tgo db.connectionOpener(ctx)\n\n\treturn db\n}\n\nfunc (db *DB) connectionOpener(ctx context.Context) {\n\tfor {\n\t\tselect {\n\t\tcase &lt;-ctx.Done():\n\t\t\treturn\n\t\tcase &lt;-db.openerCh:\n\t\t\tdb.openNewConnection(ctx)\n\t\t}\n\t}\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EКак видно из приведенного кода, пул инициализируется пустой. Это значит, что на данном этапе никакого соединения к базе мы еще не установили. Поэтому, если у вас есть неверные данные в конфигурации — например, неверный логин или вы ошиблись с паролем — то при вызове метода \u003Cem\u003EOpen\u003C\u002Fem\u003E вы об этом еще не узнаете.\u003C\u002Fp\u003E\u003Cp\u003EИтак, мы создали пул, и после этого его нужно обязательно настроить.\u003C\u002Fp\u003E\u003Ch2\u003EКонфигурирование пула\u003C\u002Fh2\u003E\u003Cp\u003EДля настройки пула в основном используются следующие методы:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#SetMaxOpenConns\"\u003ESetMaxOpenConns()\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#SetMaxIdleConns\"\u003ESetMaxIdleConns()\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#SetConnMaxLifetime\"\u003ESetConnMaxLifetime()\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#SetConnMaxIdleTime\"\u003ESetConnMaxIdleTime()\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EОстановимся на каждом из них подробнее.\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"SetMaxOpenConns\" id=\"SetMaxOpenConns\"\u003E\u003C\u002Fa\u003E\u003Ch3\u003EМаксимальное количество соединений\u003C\u002Fh3\u003E\u003Cp\u003EМетодом \u003Ccode\u003ESetMaxOpenConns()\u003C\u002Fcode\u003E мы устанавливаем максимально возможное количество открытых соединений до БД из нашего пула. \u003Cstrong\u003EБудьте внимательны\u003C\u002Fstrong\u003E — по умолчанию это значение равно 0, что означает безлимитное количество соединений. Это может привести к ситуации, о которой мы говорили \u003Ca href=\"#unlimitedConnects\"\u003Eвыше\u003C\u002Fa\u003E, когда при каждом запросе в ваш сервис будет открываться новое соединение.\u003C\u002Fp\u003E\u003Cp\u003EКогда же создаются соединения? Обычно, после инициализации пула вызывают метод пинг, который создает соединение к базе. Тут же, кстати можно и проверить что наш конфиг верен:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Eerr = db.Ping()\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Ch4\u003EСтратегии создания соединений\u003C\u002Fh4\u003E\u003Cp\u003EПеред каждым выполнением запроса, наш пул пытается получить соединение путем вызова метода \u003Ccode\u003Econn(ctx context.Context, strategy connReuseStrategy)\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cp\u003EВ методе реализовано 2 стратегии создания подключения. \u003Cstrong\u003EAlwaysNewConn\u003C\u002Fstrong\u003E всегда создает новый коннект, а \u003Cstrong\u003EcachedOrNewConn\u003C\u002Fstrong\u003E сначала пытается взять свободное соединение из пула, если оно есть.\u003C\u002Fp\u003E\u003Cp\u003EЕсли соединений в пуле нет, то метод создаст новое. Если создать новое невозможно в силу установленных нами лимитов на количество открытых соединений, то он создаст запрос на открытие нового соединения и будет ждать его исполнения. \u003C\u002Fp\u003E\u003Cp\u003EСоединение, полученное этим методом, сразу переходит в использование и помечается как занятое — мы готовы выполнять свои запросы. После того, как мы освободим это соединение, оно попытается вернуться в пул.\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"SetMaxIdleConns\" id=\"SetMaxIdleConns\"\u003E\u003C\u002Fa\u003E\u003Ch3\u003EОграничение размера пула\u003C\u002Fh3\u003E\u003Cp\u003EМетодом \u003Ccode\u003ESetMaxIdleConns()\u003C\u002Fcode\u003E мы регулируем максимальное количество свободных соединений, которые могут храниться в пуле и ждать пока их используют. По умолчанию в пул можно положить до двух соединений.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc (db *DB) query(ctx context.Context, query string, args []interface{}, strategy connReuseStrategy) (*Rows, error) {\n\tdc, err := db.conn(ctx, strategy)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn db.queryDC(ctx, nil, dc, dc.releaseConn, query, args)\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EМетод query — это один из самых часто вызываемых методов для выполнения запросов, в котором соединение после использования освобождается и происходит попытка положить его обратно в пул свободных коннектов. В приведенном коде за это отвечает функция \u003Ccode\u003Edc.releaseConn\u003C\u002Fcode\u003E. Если в пуле уже максимальное количество соединений, то освободившееся соединение закроется.\u003C\u002Fp\u003E\u003Cp\u003EНо соединения еще закрываются по времени. Это тоже настраивается.\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"SetConnMaxLifetime\" id=\"SetConnMaxLifetime\"\u003E\u003C\u002Fa\u003E\u003Ch3\u003EВремя жизни соединения\u003C\u002Fh3\u003E\u003Cp\u003EМетод  \u003Ccode\u003ESetConnMaxLifetime()\u003C\u002Fcode\u003E  отвечает за определение срока жизни соединения в пуле с момента его создания.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc (db *DB) startCleanerLocked() {\n\tif (db.maxLifetime \u003E 0 || db.maxIdleTime \u003E 0) &amp;&amp; db.numOpen \u003E 0 &amp;&amp; db.cleanerCh == nil {\n\t\tdb.cleanerCh = make(chan struct{}, 1)\n\t\tgo db.connectionCleaner(db.shortestIdleTimeLocked())\n\t}\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПроверка на возраст осуществляется при каждой попытке достать коннект из пула. Также за возрастом следит \u003Ccode\u003EconnectionCleaner\u003C\u002Fcode\u003E. Он просто закрывает просроченные коннекты, перебирая их в цикле и проверяя срок жизни.\u003C\u002Fp\u003E\u003Cp\u003EНо это еще не все. Начиная с Go версии 1.15 для соединения можно указать срок ожидания.\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"SetConnMaxIdleTime\" id=\"SetConnMaxIdleTime\"\u003E\u003C\u002Fa\u003E\u003Ch3\u003EВремя ожидания в пуле\u003C\u002Fh3\u003E\u003Cp\u003EМетод \u003Ccode\u003ESetConnMaxIdleTime()\u003C\u002Fcode\u003E  настраивает максимальное количество времени, в течении которого соединение может находиться в пуле в режиме ожидания. Эта настройка очень похожа на предыдущую, но существенное отличие в том, что время жизни соединения отсчитывается от даты его создания, а время ожидания в пуле считается с того момента времени, когда это соединение вернулось в пул.\u003C\u002Fp\u003E\u003Cp\u003EПосле истечения этого времени соединение также закрывается.\u003C\u002Fp\u003E\u003Ch2\u003EВозврат соединения в пул\u003C\u002Fh2\u003E\u003Cp\u003EКак мы говорили, при выполнении запроса соединение берется из пула или создается, если в пуле ничего нет, после чего помечается как занятое. После выполнения запросов мы должны его освобождать.\u003C\u002Fp\u003E\u003Cp\u003EКогда мы получаем данные по нашему запросу, нам возвращается структура с результатами Rows, в которой также находится наше соединение.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003Evar (\n\t\tid int\n\t\ttitle string\n\t)\n\t\u002F\u002F ...\n\trows, err := db.QueryContext(ctx, \"SELECT id, title FROM articles WHERE author_id = ?\", 1)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tfor rows.Next() {\n\t\terr := rows.Scan(&amp;id, &amp;title)\n\t\tif err != nil {\n\t\t\tlog.Fatal(err)\n\t\t}\n\t\tlog.Println(id, title)\n\t}\n\t\u002F\u002F ...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПри вызове метода \u003Ccode\u003EClose()\u003C\u002Fcode\u003E происходит освобождение соединения и попытка положить его в пул или закрыть, если в пуле нет места. Поэтому писать код, как в примере выше — плохо. Обязательно вызывайте \u003Ccode\u003EClose\u003C\u002Fcode\u003E, как минимум, в \u003Ccode\u003Edefer\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003E\u002F\u002F ...\n\trows, err := db.QueryContext(ctx, \"SELECT id, title FROM articles WHERE author_id = ?\", 1)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\t\n\tdefer rows.Close()\n\tfor rows.Next() {\n\t\terr := rows.Scan(&amp;id, &amp;title)\n\t\tif err != nil {\n\t\t\tlog.Fatal(err)\n\t\t}\n\t\tlog.Println(id, title)\n\t}\n\t\u002F\u002F ...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЕсли не освобождать соединения, то они будут просто висеть в статусе «занятые», расходовать память и забивать количество открытых соединений. В итоге мы можем получить пустой пул, так как все соединения будут считаться занятыми, но при этом новое соединение мы создать не сможем, потому что достигли лимита максимально открытых соединений. Все это приведет к ситуации, при которой мы не можем ни создать новые соединения, ни воспользоваться имеющимися.\u003C\u002Fp\u003E\u003Cp\u003EНо еще лучше делать таким образом:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003E\u002F\u002F ...\n\trows, err := db.QueryContext(ctx, \"SELECT id, title FROM articles WHERE author_id = ?\", 1)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tdefer rows.Close()\n\tfor rows.Next() {\n\t\terr := rows.Scan(&amp;id, &amp;title)\n\t\tif err != nil {\n\t\t\tlog.Fatal(err)\n\t\t}\n\t\tlog.Println(id, title)\n\t}\n\terr = rows.Close()\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\t\u002F\u002F ...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EДело в том, что когда происходит Scan(), Go пытается конвертировать байты, которые пришли из MySQL к типам данных переданных в параметрах. И обратите внимание, что метод выполнения запроса завязан на контексте. Если в процессе выполнения \u003Cem\u003EScan()\u003C\u002Fem\u003E произойдет обнуление контекста, то данные могут получиться поврежденными. Об этой проблеме довольно подробно написано в \u003Ca href=\"https:\u002F\u002Fgithub.blog\u002F2020-05-20-three-bugs-in-the-go-mysql-driver\u002F\"\u003E\u003Cu\u003Eданной статье в разделе «The race»\u003C\u002Fu\u003E\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EОтловить эту ошибку можно только в явном вызове метода \u003Ccode\u003EClose\u003C\u002Fcode\u003E и проверке на ошибку. А в \u003Ccode\u003Edefer\u003C\u002Fcode\u003E мы оставляем \u003Ccode\u003EClose\u003C\u002Fcode\u003E для уверенности, что если произойдут какие-то паники, то коннект вернется в пул.\u003C\u002Fp\u003E\u003Cp\u003EДальше я на синтетических примерах покажу, как все это влияет на реальные запросы в базу данных. Но перед этим давайте посмотрим еще на один интересный нюанс, который влияет на наши запросы.\u003C\u002Fp\u003E\u003Ch2\u003EИнтерполяция параметров\u003C\u002Fh2\u003E\u003Cp\u003EКак правило, для выполнения запросов с параметрами используются плейсхолдеры, чтобы избежать возможных sql инъекций:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003Edb.QueryRow(“SELECT * FROM client WHERE id=?”, id)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EНо данный способ выполнения запросов может работать по-разному, в зависимости от настроек.\u003C\u002Fp\u003E\u003Cp\u003EВ качестве конфигурирования соединения с MySQL также поддерживается параметр \u003Ccode\u003EinterpolateParams=true\u002Ffalse.\u003C\u002Fcode\u003E По умолчанию его значение равно \u003Ccode\u003Efalse\u003C\u002Fcode\u003E, что равносильно непереданному параметру.\u003C\u002Fp\u003E\u003Cp\u003EВ случае \u003Ccode\u003Efalse\u003C\u002Fcode\u003E для выполнения приведенного запроса сначала на сервер БД отправляется команда для подготовки выражения (\u003Ca href=\"https:\u002F\u002Fdev.mysql.com\u002Fdoc\u002Frefman\u002F8.0\u002Fen\u002Fsql-prepared-statements.html\"\u003E\u003Cu\u003EPrepared Statements\u003C\u002Fu\u003E\u003C\u002Fa\u003E), после чего будет отправлена новая команда на выполнение подготовленного выражения.\u003C\u002Fp\u003E\u003Cp\u003EКогда у нас большой и сложный запрос с многочисленными плейсхолдерами, который будет выполняться в методе несколько раз (например мы что-то выполняем батчами), то подготовленные выражения ускоряют нашу работу. Выполнив один раз подготовку на сервере MySQL, дальше мы используем готовый запрос, не тратя каждый раз ресурсы на его парсинг.\u003C\u002Fp\u003E\u003Cp\u003EПри включенной интерполяции, то есть в значении \u003Ccode\u003Etrue\u003C\u002Fcode\u003E, замена плейсхолдеров на значения выполняется в коде библиотеки go. Но если не включить интерполяцию параметров для обычных разовых запросов, мы получим по два TCP запроса к серверу MySQL вместо одного (не считая само соединение).\u003C\u002Fp\u003E\u003Cp\u003EЗапрос с параметром \u003Ccode\u003EinterpolateParams=false\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"335\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa4d\u002F805\u002F0cc\u002Fa4d8050cc48a5ab28695a23029783272.png\" data-width=\"1726\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003Eтот же запрос, с \u003Ccode\u003EinterpolateParams=true\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"366\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F549\u002F865\u002F244\u002F549865244b8a523f3e8dcadbdf7b226d.png\" data-width=\"1813\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Ch2\u003EПул на практике\u003C\u002Fh2\u003E\u003Cp\u003EДавайте посмотрим несколько примеров конфигурации пула в действии. Я буду выполнять в цикле запрос \u003Ccode\u003ESELECT SLEEP(2);\u003C\u002Fcode\u003E в базу данных MySQL и смотреть, что происходит с соединениями. В приведенном коде есть пауза в одну секунду после каждого запроса, чтобы соединения не успевали переиспользоваться и мы увидели более наглядную картину:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc BenchmarkPool(b *testing.B) {\n  ctx := context.Background()\n  maxLifeTime := time.Second * 0\n\tmaxOpenConns := 0\n\tmaxIdleConns := 0\n\tdb := NewPool(maxLifeTime, maxOpenConns,maxIdleConns)\n\n\n  tx := apm.DefaultTracer.StartTransaction(\"BenchmarkPool\", \"request\")\n  ctx = apm.ContextWithTransaction(ctx, tx)\n\n  for i := 0; i &lt; 5; i++ {\n     db.wg.Add(1)\n     go db.selectSleep(ctx)\n     time.Sleep(1 * time.Second)\n  }\n  db.wg.Wait()\n\n  tx.End()\n  apm.DefaultTracer.Flush(nil)\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВ первом кейсе посмотрим на вариант с \u003Ccode\u003EmaxOpenConns = 1\u003C\u002Fcode\u003E и \u003Ccode\u003EmaxIdleConns = 0\u003C\u002Fcode\u003E\u003Cem\u003E:\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003EmaxLifeTime := time.Second * 10\nmaxOpenConns := 1\nmaxIdleConns := 0\ndb := NewPool(maxLifeTime, maxOpenConns,maxIdleConns)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЭто нас приведет к ситуации, о которой мы говорили \u003Ca href=\"#singleConnect\"\u003Eвыше\u003C\u002Fa\u003E. Когда каждый вызов нашего метода будет блокировать на себя соединение, а остальные запросы будут ждать, пока соединение не освободится. Обратите внимание на то, что потребовалось 11 секунд:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"934\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F9e3\u002Faed\u002F20a\u002F9e3aed20ab2cfad74009dea56e5d0586.png\" data-width=\"2598\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДальше я изменю \u003Ccode\u003EmaxOpenConns := 0\u003C\u002Fcode\u003E\u003Cem\u003E:\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003EmaxLifeTime := time.Second * 10\nmaxOpenConns := 0\nmaxIdleConns := 0\ndb := NewPool(maxLifeTime, maxOpenConns,maxIdleConns)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЭто приведет ко \u003Ca href=\"#unlimitedConnects\"\u003Eвторому\u003C\u002Fa\u003E нашему случаю, когда каждый запрос будет создавать новое соединение к базе. В итоге мы будем получать ошибку при попытке соединения, так как на стороне базы данных установлены ограничения на количество подключений:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"942\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc0a\u002F78f\u002F147\u002Fc0a78f147e7d6b2f8e54bf24968ee316.png\" data-width=\"2644\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EТеперь выставим \u003Ccode\u003EmaxOpenConns=3\u003C\u002Fcode\u003E так как у нас есть ограничения:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003EmaxLifeTime := time.Second * 10\nmaxOpenConns := 3\nmaxIdleConns := 0\ndb := NewPool(maxLifeTime, maxOpenConns,maxIdleConns)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВ данном случае у нас уже есть возможность открыть три соединения, которые могут работать параллельно. И те же пять запросов заняли 6.2 секунды вместо 11, как в первом случае. Но при этом видим, что на каждый запрос мы заново проходим этап соединения с базой.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"1454\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fda5\u002F225\u002F06b\u002Fda522506b679612c0eac26f7321280f4.png\" data-width=\"2410\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСконфигурируем пул так, чтобы минимизировать соединения. Установим \u003Ccode\u003EmaxIdleConns=3\u003C\u002Fcode\u003E\u003Cem\u003E:\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"go\"\u003EmaxLifeTime := time.Second * 10 \nmaxOpenConns := 3 \nmaxIdleConns := 3 \ndb := NewPool(maxLifeTime, maxOpenConns,maxIdleConns)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"1224\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff7f\u002F121\u002Fcaa\u002Ff7f121caa235fd659024da31b83572c7.png\" data-width=\"2472\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ результате мы проходим этап соединения всего 3 раза и помещаем подготовленные коннекты в пул. При последующих запросах в базу данных они берутся из пула с уже пройденной фазой авторизации и остается просто отправить команду. И в целом запросы выполняются быстрее.\u003C\u002Fp\u003E\u003Ch2\u003EПодводим итоги\u003C\u002Fh2\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EНикогда не оставляйте настройки пула соединений по умолчанию, его всегда нужно настраивать под ваши нужды;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EУстанавливайте \u003Ccode\u003EmaxOpenConns\u003C\u002Fcode\u003E ниже настроенных лимитов соединений на стороне базы данных;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EmaxOpenConns = 0\u003C\u002Fcode\u003E означает неограниченное количество соединений;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EЕсли на вашем сервере MySQL настроены таймауты для неактивных соединений и закрываются они на стороне базы данных, то нет необходимости в использовании \u003Ccode\u003EmaxLifeTime\u003C\u002Fcode\u003E, так как go драйвер сам обнаружит обрыв и пересоздаст соединение;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EПодбирайте значение \u003Ccode\u003EmaxLifeTime\u003C\u002Fcode\u003E так, чтобы минимизировать создание соединений при пиковых нагрузках на ваш сервис, а когда нагрузка падает - соединения не должны долго висеть без дела;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EНе забывайте про метод \u003Ccode\u003ESetConnMaxIdleTime\u003C\u002Fcode\u003E (с go 1.15). С его помощью вы сможете сократить время ожидания соединения в пуле, удаляя его, если им никто не пользуется. Так вы сэкономите на количестве открытых соединений в базе данных и уменьшите расход памяти в сервисе.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EВсегда освобождайте соединение после запроса (\u003Ccode\u003Erows.Close()\u003C\u002Fcode\u003E). Некоторые методы делают это сами, но ничего страшного, если вы повторите вызов \u003Ccode\u003EClose()\u003C\u002Fcode\u003E для надежности; \u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EЕсли вы используете несколько пулов для одной базы данных (например пул для чтения и пул для записи), то суммарное количество  \u003Ccode\u003EmaxOpenConns\u003C\u002Fcode\u003E этих двух пулов должно быть меньше настроенных лимитов соединений на стороне базы данных;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EЕсли вы масштабируете свой сервис, то не забывайте что открытые соединения также увеличатся. Если добавляете три инстанса, то следите, чтобы сумма \u003Ccode\u003EmaxOpenConns\u003C\u002Fcode\u003E всех трех была меньше настроенных лимитов соединений на стороне базы данных;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EНе забывайте про различные прокси, которые со своими таймаутами и ограничениями могут стоять между вами и вашей базой данных. Учитывайте настройки посредников тоже;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EУчитывайте особенности своего сервиса. Принимайте во внимание характер нагрузки и корректируйте настройки пула;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EНе забывайте про мониторинги, за пулом тоже нужно следить.\u003C\u002Fp\u003E\u003Cp\u003EСпасибо, что дочитали до конца! Если остались вопросы, пишите в комментариях, буду рад помочь.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003E\u003Cstrong\u003EUPD:\u003Cbr\u002F\u003E\u003C\u002Fstrong\u003EДополнение по комментарию \u003Ca class=\"mention\" href=\"\u002Fusers\u002Fatercattus\"\u003E@AterCattus\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\u003Cbr\u002F\u003EЕсли производительности \"стандартного\" пакета MySQL недостаточно, то можно взять альтернативу - \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fgo-mysql-org\u002Fgo-mysql\u002F\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fgo-mysql-org\u002Fgo-mysql\u002F\u003C\u002Fa\u003E. Данный пакет не совсем совместим с \u003Ca href=\"https:\u002F\u002Fgolang.org\u002Fpkg\u002Fdatabase\u002Fsql\u002F\"\u003Edatabase\u002Fsql\u003C\u002Fa\u003E, но позволяет пропускать через себя значительно больше запросов за счет минимизации абстракций и аллокаций.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EUPD 2:\u003Cbr\u002F\u003EДополнение о подготовленных выражениях\u003C\u002Fstrong\u003E по вопросу из комментариев.\u003C\u002Fp\u003E\u003Cp\u003EДля общего понимания, определим как происходит подготовка запроса:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EКлиент отправляет команду серверу на подготовку запроса с плейсхолдерами;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EСервер обрабатывает запрос и возвращает идентификатор подготовленного выражения;\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EКлиент выполняет запрос отправляя серверу идентификатор подготовленного выражения и параметры, с которыми должен выполниться запрос.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EДля подготовки выражения мы можем воспользоваться методом \u003Ccode\u003E(*DB).Prepare()\u003C\u002Fcode\u003E, который после выполнения подготовки вернет нам ссылку на структуру \u003Ccode\u003E*Stmt\u003C\u002Fcode\u003E. Метод \u003Ccode\u003E(*DB).Prepare()\u003C\u002Fcode\u003E никак не учитывает настройку \u003Ccode\u003EinterpolateParams\u003C\u002Fcode\u003E, он просто отправляет команду mysql серверу.\u003C\u002Fp\u003E\u003Cp\u003EЧтобы выполнить запрос с подготовленным выражением нужно воспользоваться методом \u003Ccode\u003E(*Stmt) Query()\u003C\u002Fcode\u003E, замечу, что это другой метод, отличный от метода \u003Ccode\u003E(*DB) Query()\u003C\u002Fcode\u003E , и он тоже не учитывает  \u003Ccode\u003EinterpolateParams\u003C\u002Fcode\u003E . Мы явно просим библиотеку выполнить подготовку на сервере и потом отправляем вторую команду на выполнение запроса для подготовленного выражения.\u003C\u002Fp\u003E\u003Cp\u003EПодготовленное выражение по методу \u003Ccode\u003E(*DB).Prepare()\u003C\u002Fcode\u003E завязывается на соединение. Если при выполнении \u003Ccode\u003E(*Stmt) Query()\u003C\u002Fcode\u003E соединение, с которым выполнялась подготовка, недоступно (занято или вовсе закрылось), то будет создано (взято из пула) новое соединение и снова выполнится команда подготовки выражения, и только потом уже сам запрос. Это может привести к лишним подготовкам одних и тех же запросов. Метод \u003Ccode\u003E(*Stmt) Close()\u003C\u002Fcode\u003E при этом закрывает выражение и выполнение запросов после этого приведет к ошибке \u003Ccode\u003Esql: statement is closed\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"go"},{"titleHtml":"golang"},{"titleHtml":"mysql"},{"titleHtml":"highload"},{"titleHtml":"connection pool"},{"titleHtml":"микросервисы"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd5d\u002F985\u002F20d\u002Fd5d98520d9a432fb0dcb58854eb4a4d3.png","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd5d\u002F985\u002F20d\u002Fd5d98520d9a432fb0dcb58854eb4a4d3.png","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002Foleg-bunin\\\u002Fblog\\\u002F583558\\\u002F\"},\"headline\":\"Go и MySQL: настраиваем пул соединений\",\"datePublished\":\"2021-10-18T12:00:02+03:00\",\"dateModified\":\"2021-10-22T00:52:31+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"hanagantig\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Каждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем My...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002Foleg-bunin\\\u002Fblog\\\u002F583558\\\u002F#post-content-body\",\"about\":[\"c_oleg-bunin\",\"c_citymobil\",\"h_mysql\",\"h_go\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F583558\\\u002F1496bae271a4dba321bb85600423089f\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F501\\\u002Fd88\\\u002F907\\\u002F501d889072b9d188f72b03b76ff974a6.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F3f5\\\u002Fb44\\\u002Ff62\\\u002F3f5b44f628062e054d27b02e9ea448a0.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F94a\\\u002F999\\\u002F708\\\u002F94a999708d24df29b03ee8b77465ef95.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fd15\\\u002F056\\\u002Ff52\\\u002Fd15056f52e8ddef15f06f4a25cd0666e.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fa1c\\\u002F7a9\\\u002F914\\\u002Fa1c7a9914179d91af207410fb255dd0d.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fa4d\\\u002F805\\\u002F0cc\\\u002Fa4d8050cc48a5ab28695a23029783272.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F549\\\u002F865\\\u002F244\\\u002F549865244b8a523f3e8dcadbdf7b226d.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F9e3\\\u002Faed\\\u002F20a\\\u002F9e3aed20ab2cfad74009dea56e5d0586.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fc0a\\\u002F78f\\\u002F147\\\u002Fc0a78f147e7d6b2f8e54bf24968ee316.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fda5\\\u002F225\\\u002F06b\\\u002Fda522506b679612c0eac26f7321280f4.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff7f\\\u002F121\\\u002Fcaa\\\u002Ff7f121caa235fd659024da31b83572c7.png\"]}","metaDescription":"Каждый день мы пишем код в условиях высоких нагрузок, и нередко в таких случаях сталкиваемся с проблемами, связанными с базой данных. Мы в компании используем MySQL, поэтому я расскажу про...","mainImageUrl":null,"amp":true},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":""},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{"oleg-bunin":{"alias":"oleg-bunin","imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fcompany\u002F7c3\u002Fad4\u002F7b2\u002F7c3ad47b2aae71b56795f618534e7a51.jpg","titleHtml":"Конференции Олега Бунина (Онтико)","descriptionHtml":"Профессиональные конференции для IT-разработчиков","relatedData":null,"statistics":{"postsCount":677,"newsCount":7,"vacanciesCount":0,"employeesCount":82,"careerRating":null,"subscribersCount":48428,"rating":401.34,"invest":null},"foundationDate":{"year":"2008","month":"01","day":"01"},"location":{"city":{"id":"447159","title":"Москва"},"region":{"id":"1885","title":"Москва и Московская обл."},"country":{"id":"168","title":"Россия"}},"siteUrl":"http:\u002F\u002Fwww.ontico.ru\u002F","staffNumber":"11–30 человек","registrationDate":"2010-02-24T19:37:40+00:00","representativeUser":null,"contacts":[{"title":"Facebook","url":"https:\u002F\u002Ffacebook.com\u002Foleg.bunin"},{"title":"Facebook","url":"https:\u002F\u002Ffacebook.com\u002FHighLoadConference"},{"title":"Facebook","url":"https:\u002F\u002Ffacebook.com\u002Fritfest"}],"settings":{"analyticsSettings":[{"type":"ym","trackingId":"55760638"}],"branding":{"imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fbranding\u002F673\u002Fa67\u002F310\u002F673a67310118a40a792e1eb97151fd97.png","linkUrl":"https:\u002F\u002Fwww.highload.ru\u002Fmoscow\u002F2021\u002F?utm_source=habr&utm_medium=cpc&utm_campaign=title&utm_content=banner","pixelUrl":""},"status":"active"},"metadata":{"titleHtml":"Конференции Олега Бунина (Онтико), Москва - Профессиональные конференции для IT-разработчиков с 1 января 2008 г.","title":"Конференции Олега Бунина (Онтико), Москва - Профессиональные конференции для IT-разработчиков с 1 января 2008 г.","keywords":["Конференции","Управление разработкой","Программирование","Управление персоналом","Высокая производительность"],"descriptionHtml":"677 статей от авторов компании Конференции Олега Бунина (Онтико)","description":"677 статей от авторов компании Конференции Олега Бунина (Онтико)"},"aDeskSettings":null,"careerAlias":"ontico","maxCustomTrackerLinks":3}},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
