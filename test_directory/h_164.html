<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Улучшения в эмуляторе Dolphin / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/581406\/"},"headline":"Улучшения в эмуляторе Dolphin","datePublished":"2021-10-22T09:52:45+03:00","dateModified":"2021-10-22T11:24:06+03:00","author":{"@type":"Person","name":"PatientZero"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Многие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы &mdash; важная часть многих сообществ любителей классических игр, они...","url":"https:\/\/habr.com\/ru\/post\/581406\/#post-content-body","about":["h_3d_graphics","h_gamedev","h_reverse-engineering","h_games","f_develop","f_design","f_popsci"],"image":["https:\/\/dolphin-emu.org\/m\/user\/blog\/progress-report\/2021-august\/spongebobold-vertexroundingon.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/c70\/12a\/2a5\/c7012a2a51506a23fdbaa10dc5f2c104.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/be0\/8d0\/e2c\/be08d0e2c021f18f3c4fc293d5f66751.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/783\/d0a\/1d5\/783d0a1d5f1d50309e051af405299988.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/181\/463\/727\/1814637276bf9b45d4b803f385739011.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/9ad\/35d\/60b\/9ad35d60be3a1bff4e2dba406b4df69b.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/86d\/5f4\/aba\/86d5f4aba6107ff010df3669e6c1f6d8.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/5e9\/813\/cef\/5e9813cef22ced7dbcc47785b6c91ee6.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/724\/c97\/03e\/724c9703e8cf4523703b26551382232e.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/e43\/7a2\/621\/e437a2621879baf14a21cd7e683227a6.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/362\/8ae\/b8b\/3628aeb8b3eaacc234a19f84303b4650.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/43e\/0a6\/846\/43e0a6846d82e217c7597a28eb419866.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/78c\/759\/de5\/78c759de5222db2eafca3be5a3dac47d.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/239\/915\/2c1\/2399152c11c6651845023c98f970dc9d.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/f67\/7ff\/1db\/f677ff1db493a0aac20e3c938a035c32.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/c0c\/cf4\/da8\/c0ccf4da814778205c4d5f2d1eb6b100.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/ad3\/fa3\/472\/ad3fa3472b0ab17e0ca67ee019732b0d.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/cd8\/a94\/b26\/cd8a94b26754d577992fb784ea5ee3a3.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/d46\/373\/c24\/d46373c242f736eb1d0dc511b01fdbbe.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/f0d\/4c5\/5f4\/f0d4c55f4b886aa172f334bd821627ed.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/aeb\/91e\/5fe\/aeb91e5fe802798f9210ada7713a5873.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/e17\/60c\/e41\/e1760ce413ed82c2f603eebcf1858512.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/7d7\/e45\/6cb\/7d7e456cb3db7fea84d9c722085d4563.jpg","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/649\/998\/7a1\/6499987a1df749e524017236c722925e.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/ac4\/b40\/4d1\/ac4b404d11c649898fa773a28cd99ce3.jpg"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Улучшения в эмуляторе Dolphin" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Улучшения в эмуляторе Dolphin" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Улучшения в эмуляторе Dolphin" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Многие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы — важная часть многих сообществ любителей классических игр, они предоставляют игрокам доступ к таким..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Многие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы — важная часть многих сообществ любителей классических игр, они предоставляют игрокам доступ к таким..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Многие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы — важная часть многих сообществ любителей классических игр, они предоставляют игрокам доступ к таким..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Многие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы — важная часть многих сообществ любителей классических игр, они предоставляют игрокам доступ к таким..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Многие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы — важная часть многих сообществ любителей классических игр, они предоставляют игрокам доступ к таким..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/581406/6aea9e0b7a94057534b7f1dd17acad17/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/581406/6aea9e0b7a94057534b7f1dd17acad17/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/581406/6aea9e0b7a94057534b7f1dd17acad17/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/581406/6aea9e0b7a94057534b7f1dd17acad17/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/581406/6aea9e0b7a94057534b7f1dd17acad17/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="581406" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-22T06:52:45.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/581406/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/581406/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/581406/6aea9e0b7a94057534b7f1dd17acad17/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/PatientZero/" title="PatientZero" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/8de/9c5/34a/8de9c534a18a6cb8693270a2b528d4c0.png" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/PatientZero/" class="tm-user-info__username">
      PatientZero
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-22T06:52:45.000Z" title="2021-10-22, 09:52">22  октября   в 09:52</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Улучшения в эмуляторе Dolphin</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/3d_graphics/" class="tm-article-snippet__hubs-item-link"><span>Работа с 3D-графикой</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/gamedev/" class="tm-article-snippet__hubs-item-link"><span>Разработка игр</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/reverse-engineering/" class="tm-article-snippet__hubs-item-link"><span>Реверс-инжиниринг</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/games/" class="tm-article-snippet__hubs-item-link"><span>Игры и игровые приставки</span> <!----></a></span></div> <div class="tm-article-snippet__labels"><div class="tm-article-snippet__label"><span>
        Перевод
      </span></div></div> <!----> <!----></div></div> <div class="tm-article-presenter__origin"><a href="https://ru.dolphin-emu.org/blog/2021/09/07/dolphin-progress-report-august-2021/?cr=ru" target="_blank" class="tm-article-presenter__origin-link">
                Автор оригинала:
                <span>
                  MayImilae
                </span></a></div> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><div style="text-align:center;"><img src="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/spongebobold-vertexroundingon.jpg" alt="image" data-src="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/spongebobold-vertexroundingon.jpg" data-blurred="true"/></div><br/>
Многие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы — важная часть многих сообществ любителей классических игр, они предоставляют игрокам доступ к таким функциям, как сетевой мультиплеер, моддинг, сохранения, а также открывают усовершенствования, невозможные на консоли. Если вам захочется поиграть в любимую игру, иногда просто удобнее воспользоваться эмулятором на десктопном компьютере, планшете или телефоне, чем откапывать и подключать консоль. Однако важно заметить, что наши отношения с игровыми сообществами взаимны и без помощи игроков и фанатов мы бы не смогли поддерживать библиотеку из тысяч игр.<br/>
<br/>
Основным катализатором многих изменений, описанных в этом отчёте, стали сообщества игроков. Они занимались сложной отладкой, находили мелкие проблемы, которые оставались бы незаметными для тех, кто не знает игру в совершенстве, и даже создавали патчи, чтобы игры лучше подстраивались под усовершенствования в эмуляторе. Весь этот вклад, хотя и не являлся кодом, очень ценим нами, благодаря нему Dolphin стал тем, что мы видим сегодня. <br/>
<a name="habracut"></a><br/>
<h3>Значимые изменения</h3><br/>
<h4><a href="https://dolphin-emu.org/download/dev/master/5.0-14795/" rel="nofollow noopener noreferrer">5.0-14795 — JIT: Fix FMA Negation Ordering</a>, <a href="https://github.com/JosJuice" rel="nofollow noopener noreferrer">JosJuice</a></h4><br/>
<a href="https://wiki.dolphin-emu.org/index.php?title=Inazuma_Eleven_GO:_Strikers_2013" rel="nofollow noopener noreferrer">Inazuma Eleven GO: Strikers 2013</a> — последний релиз для Wii любимой игроками <a href="https://en.wikipedia.org/wiki/Inazuma_Eleven" rel="nofollow noopener noreferrer">футбольной серии Inazuma Eleven</a>. Эту игру можно любить за многое — множество персонажей, специальные движения, длинный режим RPG-истории, в которой вы собираете собственную футбольную команду, прокачиваете персонажей и побеждаете противников. Несмотря на то, что игра была выпущена только в Японии, она стала культовой для игроков всего мира. Существуют её фанатские переводы, по ней проводятся турниры между странами и даже есть «Кубок мира»!<br/>
<br/>
<div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/getpro/habr/post_images/c70/12a/2a5/c7012a2a51506a23fdbaa10dc5f2c104.png"/></div><br/>
<i>В этом году уже прошло несколько турниров и онлайн-соревнований!</i><br/>
<br/>
Хотя в <a href="https://wiimmfi.de/" rel="nofollow noopener noreferrer">Wiimmfi</a> уже есть полная поддержка игры, в <a href="https://wiki.dolphin-emu.org/index.php?title=Inazuma_Eleven_GO:_Strikers_2013" rel="nofollow noopener noreferrer">Inazuma Eleven GO: Strikers 2013</a> по-прежнему играют онлайн через <a href="https://en.wikipedia.org/wiki/Nintendo_Wi-Fi_Connection" rel="nofollow noopener noreferrer">Nintendo Wi-Fi Connection</a>, и многие пользователи выбирают Dolphin. Это одна из немногих игр Wii, для которых до сих пор можно найти матчи, особенно если зайти на один из Discord-серверов сообщества. В Dolphin всё работает отлично, за исключением одного раздражающего изъяна: Dolphin не может синхронизироваться с консолями Wii. При попытке выполнить блок <em>Hissatsu</em> (специальные движения) или отбор мяча игра обнаруживает проблему и откатывается к точке до момента её возникновения, обычно сбрасывая мяч в неподвижную позицию. Это означает, что забивать голы мощными специальными движениями невозможно, как и отбирать мяч у противников. Игра была неиграбельной.<br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/615d9bf9abb378f6450d1a03" data-style="" id="615d9bf9abb378f6450d1a03" width=""></div></div><br/>
<i>В анимации показана неудачная попытка поймать мяч, однако после небольшой загрузки мяч всё равно оказывается в руках вратаря. Причина этого — откат для восстановления из-за рассинхронизации. Видео в высоком качестве можно посмотреть <a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/inazuma-desync.mp4" rel="nofollow noopener noreferrer">здесь</a></i><br/>
<br/>
Одним из поединков в рамках организованного сообществом Кубка мира должна была стать игра Франции и Японии, что создавало проблему. Французское сообщество игроков в основном использует Dolphin, а большинство японских игроков играет только на консоли. Это означало, что игрокам или придётся перейти на непривычную систему, или отменить матч из-за этого бага. Игроки сообществ всех стран решили, что с них хватит: они доберутся до самой сути этой проблемы, чего бы это ни стоило. Ветераны Inazuma, в том числе такие игроки, как Obluda, AS, GalacticPirate и множество других, объединили свои усилия для выявления абсолютно кошмарного бага эмуляции.<br/>
<br/>
Этот баг стал такой проблемой из-за чрезвычайно конкретных условий, которые требовались для его воссоздания. Обычно при исследовании потенциальных багов ЦП приходится выполнять такие действия, как приостановка эмуляции, подключение отладчиков, изучение регистров и другие технические действия, чтобы конкретно изучить происходящее. Вдобавок ко всему этому разработчики часто используют интерпретатор Dolphin для проверки правильности JIT, чтобы определить, с каким типом бага они имеют дело. В прошлом подобные инструменты и тесты оборудования помогли разработчикам найти различия в вычислениях, которые когда-то вызывали рассинхронизацию реплеев в таких играх, как <a href="https://wiki.dolphin-emu.org/index.php?title=Mario_Kart_Wii" rel="nofollow noopener noreferrer">Mario Kart Wii</a>, <a href="https://wiki.dolphin-emu.org/index.php?title=F-Zero_GX" rel="nofollow noopener noreferrer">F-Zero GX</a>, <a href="https://wiki.dolphin-emu.org/index.php?title=Super_Smash_Bros._Brawl" rel="nofollow noopener noreferrer">Super Smash Bros. Brawl</a> и многих других.<br/>
<br/>
<a href="https://wiki.dolphin-emu.org/index.php?title=Inazuma_Eleven_GO:_Strikers_2013" rel="nofollow noopener noreferrer">Inazuma Eleven GO: Strikers 2013</a> имела похожую проблему, но из-за одного ограничения её было очень сложно изучить. Чтобы баг проявился, <em>эмулятор должен быть подключен к Wi-Fi, соединённому с Wii</em>. Это означало, что Dolphin должен работать <em>почти</em> на полной скорости и его нельзя ставить на паузу на долгий промежуток времени, ведь в противном случае соединение будет утеряно. По сути, это отсекает большинство способов, которые обычно используются для исследования и тестирования связанных с ЦП багов; даже процесс проверки в интерпретаторе того, что проблема возникла, становится нетривиальной задачей. Полный анализ команд обычными средствами тоже было невозможно реализовать, потому что это слишком бы снизило производительность. И хотя все <em>подозревали</em>, что это был баг JIT, мы не могли в этом убедиться, поскольку не было возможности проверить, устраняет ли её переключение на интерпретатор!<br/>
<br/>
Несмотря на эти препятствия, сообщество игроков в Inazuma приложило все свои усилия. Вместо использования традиционного анализа оно начало мучительный путь отката небольших групп команд в интерпретатор. При наличии достаточно быстрого процессора игроки могли запускать игру с полной скоростью и медленно тестировать каждую версию команд в интерпретаторе, чтобы проверить, не устранит ли одна из них проблему. Они достигли успеха, исследуя команды <em>JIT с плавающей запятой</em>. Отключив их группу, они смогли устранить рассинхронизацию, оставаясь <em>почти</em> на полной скорости, чтобы соединение с Wii не разорвалось. Имея на руках эту информацию, в работу включился <strong><a href="https://github.com/JosJuice" rel="nofollow noopener noreferrer">JosJuice</a></strong>, чтобы помочь пользователям в анализе оставшихся команд, и они нашли причину в командах <a href="https://en.wikipedia.org/wiki/Multiply%E2%80%93accumulate_operation" rel="nofollow noopener noreferrer">совмещённого умножения-сложения (Fused Multiply–Add, FMA)</a> с плавающей запятой. Разработчики отнеслись к этому анализу скептически, потому JIT и x86-64, и AArch64 были тщательно проверены. К тому моменту они должны были стать практически идеальными, что подтверждается тестами оборудования и многими играми с файлами реплеев.<br/>
<br/>
К нему присоединились другие пользователи, а один разработчик даже импортировал игру, чтобы проверить, что происходит. Благодаря помощи сообщества <a href="https://wiki.dolphin-emu.org/index.php?title=Inazuma_Eleven_GO:_Strikers_2013" rel="nofollow noopener noreferrer">Inazuma Eleven GO</a> мы смогли лично убедиться в происходящем и подтвердить анализ команд. Определённо, с вычислениями FMA в Dolphin было что-то не то. Проблема заключалась в том, что никто не мог найти источник, хоть мы и знали, что что-то сломано. После долгого изучения проблемы <strong><a href="https://github.com/JosJuice" rel="nofollow noopener noreferrer">JosJuice</a></strong> наконец-то разобрался: оказалось, проблема заключалась в различиях в конкретном моменте смены знака. Давайте рассмотрим технические подробности.<br/>
<br/>
<div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/be0/8d0/e2c/be08d0e2c021f18f3c4fc293d5f66751.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/be0/8d0/e2c/be08d0e2c021f18f3c4fc293d5f66751.jpg" data-blurred="true"/></div><br/>
Смена знака — это изменение знака с положительного на отрицательный, или наоборот. Для эффективности она объединяется в дублирующие версии команд FMA, например, <code>madd</code> (умножение-сложение) имеет вариант со сменой знака <code>nmadd</code>, который должен, теоретически, иметь противоположный <code>madd</code> знак. Однако различные архитектуры ЦП могут применять смену знака в разные моменты вычислений, что изменяет результат. Команды <code>nmadd</code> и <code>nmsub</code> (умножение-вычитание со сменой знака) архитектуры PowerPC выполняют смену знака в конце операции уравнением <code>-(A * C ± B)</code>. Это логично, поэтому, разумеется, никакая другая архитектура не выполняет операции подобным образом.<br/>
<br/>
x86-64 в своей бесконечной мудрости <em>меняет знак результата операции умножения</em>, а затем выполняет сложение или вычитание. Уравнение имеет вид <code>-(A * C) ± B</code>, то есть сильно отличается от версии PowerPC и совершенно с ней несовместимо. Однако предыдущие разработчики Dolphin нашли хитрый способ обхода этой проблемы. Для этого достаточно было просто поменять местами ADD и SUB для этих команд. Просто выполняя обратные действия, мы можем получить результаты, которые ожидает код игры для PowerPC.<br/>
<br/>
Но AArch64 всё меняет. Уравнение <code>nmadd</code> для AArch64 выглядит как <code>-(A * C) - B</code>, то есть оно полностью идентично уравнению <code>nmsub</code> на x86-64! То, что команда <em>сложения</em> на самом деле <em>вычитает</em> — это, конечно, любопытное решение со стороны ARM, но благодаря нему нам не нужно выполнять трюк с заменой SUB, потому что AArch64 уже сделала его за нас, позволив сопоставить <code>nmadd</code> PowerPC напрямую с AArch64, несмотря на очень разные уравнения. Что ещё более странно, уравнение <code>nmsub</code> на AArch64 выглядит как <code>(A * C) - B</code>, то есть <em>смена знака в нём вообще не происходит</em>. Однако по какой-то причине знак меняется в <code>msub</code> AArch64, поэтому мы использовали её. Мы уже научились не задавать лишних вопросов.<br/>
<br/>
Эти трюки очень продуманы и они оказались очень точными. Однако, как доказала игра <a href="https://wiki.dolphin-emu.org/index.php?title=Inazuma_Eleven_GO:_Strikers_2013" rel="nofollow noopener noreferrer">Inazuma Eleven GO: Strikers 2013</a>, они были неидеальными. Пользователь <strong><a href="https://github.com/booto" rel="nofollow noopener noreferrer">booto</a></strong> обнаружил, что из-за различий в порядке смены знака в уравнениях, этот способ не срабатывает, когда все входные данные равны нулю — <code>nmsub</code> PowerPC даёт -0, а <code>nmadd</code> x86 и <code>msub</code> AArch64 дают +0. Ой-ёй. Мы не знаем, почему конкретно <a href="https://wiki.dolphin-emu.org/index.php?title=Inazuma_Eleven_GO:_Strikers_2013" rel="nofollow noopener noreferrer">Inazuma</a> использует это необычное поведение, но это баг, вызывавший рассинхронизацию при совместном подключении к Wi-Fi Connection эмулятора Dolphin и консолей Wii.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/inazuma-thewall.jpg" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/783/d0a/1d5/783d0a1d5f1d50309e051af405299988.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/783/d0a/1d5/783d0a1d5f1d50309e051af405299988.jpg" data-blurred="true"/></div></a><br/>
Хотя мы устранили эту проблему в <a href="https://wiki.dolphin-emu.org/index.php?title=Inazuma_Eleven_GO:_Strikers_2013" rel="nofollow noopener noreferrer">Inazuma</a>, дальнейшие исследования выявили другие возможные проблемы. Описанные выше трюки дают одинаковые результаты на консоли, какие бы данные она ни обрабатывала… но только когда они выполняются обычной математикой. На реальном оборудовании эти уравнения выполняются при помощи <a href="https://www.youtube.com/watch?v=PZRI1IfStY0" rel="nofollow noopener noreferrer">математики с плавающей запятой</a>, поэтому снова всплывают давно известные нам <em>погрешности округления операций с плавающей запятой</em>. При смене знака на разных этапах вычисления уравнений, расчёты с плавающей запятой округлялись не так, как в процессорах PowerPC. Обычно это было допустимо, но в пограничных случаях округления, например, при округлении в сторону бесконечности, различия в округлении оказывались достаточно серьёзными, чтобы создать другой результат с плавающей запятой. Не знаю, возникала ли уже в каком-то ПО эта проблема, но по возможности стоит устранять подобные баги.<br/>
<br/>
Чтобы устранить все эти странности, мы теперь просто пользуемся стандартными командами <code>madd</code> и <code>msub</code> (и <code>nmsub</code> на AArch64), после чего самостоятельно меняем их знак отдельными командами смены знака. Это простое изменение разрешает все проблемы пограничных случаев и позволяет эмулятору Dolphin играть против реальных Wii в <a href="https://wiki.dolphin-emu.org/index.php?title=Inazuma_Eleven_GO:_Strikers_2013" rel="nofollow noopener noreferrer">Inazuma Eleven GO: Strikers 2013</a>! Хотя из-за использования двух команд вместо одной производительность снижается на чрезвычайно малую величину, мы гарантируем, что вы этого не заметите. Вероятно. Ведь не найдётся ни одной игры, которая станет настолько тупо пользоваться простыми командами смены знака FMA, чтобы это вызвало значительное снижение производительности. (Во всяком случае, мы на это надеемся.)<br/>
<br/>
Без потрясающего сообщества игроков в Inazuma, проводившего кошмарный анализ команд со строгим ограничением невозможности <i>слишком</i> большого снижения производительности, эта проблема никогда бы не была устранена. Если вы хотите попробовать сыграть в эту игру, то у неё до сих пор есть активное сообщество, проводятся турниры и существует куча руководств. Мы хотим выразить особую признательность <a href="https://twitter.com/inazuma_france" rel="nofollow noopener noreferrer">Inazuma France</a> за помощь.<br/>
<br/>
<h4><a href="https://dolphin-emu.org/download/dev/master/5.0-15009/" rel="nofollow noopener noreferrer">5.0-15009 — IOS/Networking: Make Name Resolution Asynchronous</a>, <a href="https://github.com/sepalani" rel="nofollow noopener noreferrer">sepalani</a></h4><br/>
При тестировании онлайна для <a href="https://wiki.dolphin-emu.org/index.php?title=Inazuma_Eleven_GO:_Strikers_2013" rel="nofollow noopener noreferrer">Inazuma Eleven GO: Strikers 2013</a>, <a href="https://wiki.dolphin-emu.org/index.php?title=Mario_Kart_Wii" rel="nofollow noopener noreferrer">Mario Kart Wii</a> и других игр с поддержкой WiFi на таких резервных серверах, как Wiimmfi, было замечено, что при первоначальном подключении возникают очень серьёзные торможения. Так как из-за проблем <a href="https://wiki.dolphin-emu.org/index.php?title=Inazuma_Eleven_GO:_Strikers_2013" rel="nofollow noopener noreferrer">Inazuma Eleven</a> с WiFi онлайн-функции и так тестировались, нам представился идеальный шанс протестировать модификацию разработчика <strong><a href="https://github.com/sepalani" rel="nofollow noopener noreferrer">sepalani</a></strong> по асинхронному выполнению выбора доменных имён. Благодаря выполнению операции в отдельном потоке торможения при подключении к игре с поддержкой Wi-Fi полностью устранялись.<br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/6162c0b2abb378f6450d1a13" data-style="" id="6162c0b2abb378f6450d1a13" width=""></div></div><br/>
<i>Ранее подключение было совершенно дёрганным. Видео в более высоком качестве можно посмотреть <a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/inazumaasyncloading-stutter.mp4" rel="nofollow noopener noreferrer">здесь</a>.</i><br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/6162c0b2122cc8f6386967f6" data-style="" id="6162c0b2122cc8f6386967f6" width=""></div></div><br/>
<i>Но теперь оно работает точно так же, как на консоли. Видео в более высоком качестве можно посмотреть <a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/inazumaasyncloading-smooth.mp4" rel="nofollow noopener noreferrer">здесь</a>.</i><br/>
<br/>
<h4><a href="https://dolphin-emu.org/download/dev/master/5.0-14810/" rel="nofollow noopener noreferrer">5.0-14810</a>, <a href="https://dolphin-emu.org/download/dev/master/5.0-14848/" rel="nofollow noopener noreferrer">5.0-14848</a> и <a href="https://dolphin-emu.org/download/dev/master/5.0-15105/" rel="nofollow noopener noreferrer">5.0-15105</a> — GameINI: «Heavy Iron Studios» Games Quality of Life Changes</h4><br/>
Ни один из разработчиков лицензионных игр для <a href="https://en.wikipedia.org/wiki/Sixth_generation_of_video_game_consoles" rel="nofollow noopener noreferrer">консолей шестого поколения</a> не оставил наследия лучше, чем <a href="https://wiki.dolphin-emu.org/index.php?title=Category:Heavy_Iron_Studios_(Developer)" rel="nofollow noopener noreferrer">Heavy Iron Studios</a>. Одна из игр компании, <a href="https://wiki.dolphin-emu.org/index.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom" rel="nofollow noopener noreferrer">SpongeBob Squarepants: Battle for Bikini Bottom</a> — культовая классика, получившая <a href="https://en.wikipedia.org/wiki/SpongeBob_SquarePants:_Battle_for_Bikini_Bottom_%E2%80%93_Rehydrated" rel="nofollow noopener noreferrer">HD-ремейк на современных консолях</a>, а среди прочих игр студии есть и <a href="https://wiki.dolphin-emu.org/index.php?title=Scooby-Doo!_Night_of_100_Frights" rel="nofollow noopener noreferrer">крепкие середнячки</a>, и <a href="https://wiki.dolphin-emu.org/index.php?title=The_SpongeBob_SquarePants_Movie" rel="nofollow noopener noreferrer">довольно неплохие проекты</a>. В целом, это были увлекательные игры, правильно использовавшие франшизы и сочетающие в себе интересный геймплей с любимыми персонажами.<br/>
<br/>
Так как эти лицензионные игры имеют довольно большую базу фанатов, пользователи хотели играть в них на Dolphin со всеми теми преимуществами, которые даёт эмуляция. К сожалению, возникли ограничения. Dolphin мог корректно эмулировать эти игры… но самые продвинутые его возможности работали не очень хорошо. При повышении внутреннего разрешения игры возникали серьёзные проблемы с графикой, поэтому игрокам приходилось пользоваться нативным разрешением. Но это не какой-то баг Dolphin! Большинство игр <a href="https://wiki.dolphin-emu.org/index.php?title=Category:Heavy_Iron_Studios_(Developer)" rel="nofollow noopener noreferrer">Heavy Iron Studios</a> разрабатывалось таким образом, что <em>в них нельзя было играть в повышенном разрешении</em> из-за использованных при рендеринге трюках (по крайней мере, чтобы решить эту проблему, пользователи и разработчиков эмуляторов должны были придумывать хитрости).<br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/6162c0b21370783b8bf93085" data-style="" id="6162c0b21370783b8bf93085" width=""></div></div><br/>
<i>При нативном внутреннем разрешении 1x игра Battle For Bikini Bottom работала нормально...</i><br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/6162c0b3cd09f7f6552eb389" data-style="" id="6162c0b3cd09f7f6552eb389" width=""></div></div><br/>
<i>Но при более высоких внутренних разрешениях возникали серьёзные визуальные ошибки</i><br/>
<br/>
Истоки этой проблемы можно отследить в первой игре, выпущенной <a href="https://wiki.dolphin-emu.org/index.php?title=Category:Heavy_Iron_Studios_(Developer)" rel="nofollow noopener noreferrer">Heavy Iron Studios</a> для GameCube — <a href="https://wiki.dolphin-emu.org/index.php?title=Scooby-Doo!_Night_of_100_Frights" rel="nofollow noopener noreferrer">Scooby Doo: Night of 100 Frights</a>. В ней используются те же техники, что и в <a href="https://wiki.dolphin-emu.org/index.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom" rel="nofollow noopener noreferrer">Battle for Bikini Bottom</a>, но с одним важным отличием. Эта игра неправильно задаёт матрицу проекции; она настроена на вывод размером 639 на 479 вместо истинного разрешения 640 на 480. Поэтому когда игра копирует из памяти фрагмент буфера кадров размером 256x256, при копировании обратно он пропускается через неправильную матрицу проекции и оказывается слегка деформированным до размера фрагмента 256.401 на 256.534. Проще всего представить этот баг, сравнив его с редактированием фотографии. Представьте, что вы скопировали часть изображения, <i>незначительно</i> уменьшили масштаб всего остального изображения, но при копировании фрагмента обратно вы не изменили его масштаб, а потом отмасштабировали полное изображение до исходного размера. Аналогия неидеальна, но, по крайней мере, может дать вам представление о том, какие визуальные проблемы это может вызвать. Но дело в том, что нативное разрешение GameCube настолько мало, что такие незначительные отклонения не приводили к заметным проблемам. Баг может проявляться визуально только из-за того, что Dolphin позволяет использовать повышенное внутреннее разрешение.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/scoobs-vertexroundingoff.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/getpro/habr/post_images/181/463/727/1814637276bf9b45d4b803f385739011.png"/></div></a><br/>
<i>При увеличенных разрешениях возникает незначительный излом в пикселях верхнего левого квадранта...</i><br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/scoobs-vertexroundingon.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/getpro/habr/post_images/9ad/35d/60b/9ad35d60be3a1bff4e2dba406b4df69b.png"/></div></a><br/>
<i>Однако функция округления вершин (Vertex Rounding) полностью его устраняет.</i><br/>
<br/>
Ко времени выпуска <a href="https://wiki.dolphin-emu.org/index.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom" rel="nofollow noopener noreferrer">SpongeBob Squarepants: Battle for Bikini Bottom</a> компания <a href="https://wiki.dolphin-emu.org/index.php?title=Category:Heavy_Iron_Studios_(Developer)" rel="nofollow noopener noreferrer">Heavy Iron Studios</a> заметила этот баг и скорректировала поведение. Она не только исправила матрицу проекции, сменив размер на 640x480, но и добавила горизонтальное и вертикальное смещение на 1/512 (полпикселя) к позиции и координатам текстур. Благодаря этому всё <em>действительно</em> выравнивается при повышенных внутренних разрешениях, однако теперь размер текстуры составляет 513/512, а не 1.0. Это означает, что копирование EFB захватывает части самого края экрана. Если мы разобьём на части процесс рендеринга изображения, то увидим, как повышенные разрешения ломают картинку.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/shadowrenderingnative.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/86d/5f4/aba/86d5f4aba6107ff010df3669e6c1f6d8.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/86d/5f4/aba/86d5f4aba6107ff010df3669e6c1f6d8.jpg" data-blurred="true"/></div></a><br/>
<i>Это скриншот того, как выглядит игра примерно на середине процесса рендеринга кадра. Мы видим, что тень ещё не наложена.</i><br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/shadowrenderingnative.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/getpro/habr/post_images/5e9/813/cef/5e9813cef22ced7dbcc47785b6c91ee6.png"/></div></a><br/>
<i>При нативном разрешении всё очищается на краю экрана.</i><br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/shadowrendering3x.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/getpro/habr/post_images/724/c97/03e/724c9703e8cf4523703b26551382232e.png"/></div></a><br/>
<i>При повышенных разрешениях смещения могут вызывать визуальные проблемы.</i><br/>
<br/>
Пользователи, заметившие эту проблему, прозвали её проблемой «синего бокса», потому что чаще всего она дублировала части скайбокса. Хотя Vertex Rounding может <em>исправить</em> координаты позиций, починив таким образом рендеринг теней, он делает ещё более заметным то, что данные берутся с самого края экрана, потому что координаты текстур по-прежнему смещены.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/spongebobold-vertexroundingoff.jpg" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/e43/7a2/621/e437a2621879baf14a21cd7e683227a6.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/e43/7a2/621/e437a2621879baf14a21cd7e683227a6.jpg" data-blurred="true"/></div></a><br/>
<i>Без Vertex Rounding тени вполне ожидаемо поломаны, а в левом верхнем углу иногда появляется синий бокс.</i><br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/spongebobold-vertexroundingon.jpg" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/362/8ae/b8b/3628aeb8b3eaacc234a19f84303b4650.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/362/8ae/b8b/3628aeb8b3eaacc234a19f84303b4650.jpg" data-blurred="true"/></div></a><br/>
<i>Vertex Rounding исправил тени, но проблема с синим боксом стала гораздо более заметной.</i><br/>
<br/>
Из-за смещения текстур Dolphin никак не мог улучшить рендеринг, если только не применять исключительно неудобные хаки для каждой конкретной игры. Поэтому пользователи решили выбрать другой путь — манипулировать самой игрой, а не пытаться подстроить эмулятор под неё. Для этого они выбрали код <em>Action Replay</em>, позволявший им модифицировать игру непосредственно в памяти. Несколько лет назад люди в отчёте <a href="https://bugs.dolphin-emu.org/issues/9649" rel="nofollow noopener noreferrer">об этой самой проблеме</a> обсуждали идею использования для улучшения ситуации кодов action replay. Они даже опубликовали коды, частично разъяснившие ситуацию, а <a href="https://bugs.dolphin-emu.org/users/6405" rel="nofollow noopener noreferrer">Disorderly</a> запостил конкретный адрес, который должен оказаться в catalyst для исправления этой игры.<br/>
<br/>
К сожалению, эти решения слишком опередили своё время. Тогда в Dolphin ещё не было хака Vertex Rounding, к тому же в нём присутствовали погрешности округления, из-за которых игра могла некорректно рендериться даже в нативном разрешении. Так как пользователям приходилось одновременно справляться с несколькими проблемами, коды становились чрезмерно сложными и имели множество недостатков. Из-за этого почти никто не понял <em>насколько близко</em> они были тогда к решению.<br/>
<br/>
Такая ситуация сохранялась до этого года, когда разработчикам стало известно решение, позволяющее устранить проблемы с рендерингом игры без багов графики при помощи кода Action Replay из одной строки, появившегося на <a href="https://wiki.dolphin-emu.org/index.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom" rel="nofollow noopener noreferrer">вики-странице Battle for Bikini Bottom эмулятора Dolphin</a>. Оставалось всего лишь собрать всё вместе. Накопившиеся за годы исправления во внутреннем округлении Dolphin, хак Vertex Rounding и этот код Action Replay наконец-то заставили игру красиво рендериться при высоких разрешениях.<br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/6164162c4615593b75e2468f" data-style="" id="6164162c4615593b75e2468f" width=""></div></div><br/>
<i>Благодаря этим хитростям Bikini Bottom отлично работает с любым внутренним разрешением!</i><br/>
<br/>
Однако для этого игрокам приходилось находить код в <a href="https://wiki.dolphin-emu.org/index.php?title=Main_Page" rel="nofollow noopener noreferrer">вики</a>, вводить его в INI эмулятора Dolphin или в меню action replay, включать читы и хак Vertex Rounding, не имея при этом никаких инструкций. Проверив код самостоятельно, <strong><a href="https://github.com/JMC47" rel="nofollow noopener noreferrer">JMC47</a></strong> захотел облегчить жизнь пользователей. Однако вопрос заключался в том, можно ли упростить доступ к повышенному разрешению, не мешая тем, кто хочет наслаждаться игрой в нативном разрешении и без хаков.<br/>
<br/>
При нативном разрешении Vertex Rounding автоматически отключается, поэтому это без проблем можно сделать настройкой по умолчанию. Хотя мы не могли включить по умолчанию код Action Replay, потому что он представляет собой просто запись значения в память, его легко преобразовать в патч для игры. Единственное, в чём нам нужно было убедиться — что этот патч не вызывает проблем в нативном разрешении. Для этого <strong><a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></strong> проанализировал влияние патча при помощи инструмента FifoAnalyzer эмулятора Dolphin. В конечном итоге патч был признан безвредным и преобразован из кода Action Replay в патч игры, который можно автоматически применять при её запуске.<br/>
<br/>
Ради полноты решения <strong><a href="https://github.com/JMC47" rel="nofollow noopener noreferrer">JMC47</a></strong> <em>также</em> модифицировал патч так, чтобы он работал с PAL-версией игры, чтобы вне зависимости от запущенной версии пользователи могли играть в последних тестовых сборках с повышенным разрешением!<br/>
<br/>
Это <em>могло бы</em> стать концом истории, но все пользователи ощущали какую-то горечь. Пусть <a href="https://wiki.dolphin-emu.org/index.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom" rel="nofollow noopener noreferrer">SpongeBob SquarePants: Battle for Bikini Bottom</a> и является самой популярной игрой <a href="https://wiki.dolphin-emu.org/index.php?title=Category:Heavy_Iron_Studios_(Developer)" rel="nofollow noopener noreferrer">Heavy Iron Studios</a>, и её исправление порадовало большинство игроков, другие игры компании всё равно оставались сломанными. Действительно ли эти игры менее важны из-за того, что в них хочет играть меньше людей?<br/>
<br/>
Но был и ещё более важный аспект. Так как эти игры были менее популярны, чем <a href="https://wiki.dolphin-emu.org/index.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom" rel="nofollow noopener noreferrer">Battle for Bikini Bottom</a>, для них не существовало кода, способного решить проблему со смещениями. Или, по крайней мере, так мы думали. Как ни удивительно, но ещё одна из игр, <a href="https://wiki.dolphin-emu.org/index.php?title=The_SpongeBob_SquarePants_Movie" rel="nofollow noopener noreferrer">The SpongeBob SquarePants Movie</a> тоже имела в вики код, помогающий с повышенными разрешениями! Решив, что это не будет большой проблемой, <strong><a href="https://github.com/JMC47" rel="nofollow noopener noreferrer">JMC47</a></strong> решил портировать в патч и этот код. Однако, кое-что мы упустили.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/spongebobmovienoshadow.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/43e/0a6/846/43e0a6846d82e217c7597a28eb419866.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/43e/0a6/846/43e0a6846d82e217c7597a28eb419866.jpg" data-blurred="true"/></div></a><br/>
<i>Имевшийся код для The SpongeBob SquarePants Movie удалял большинство эффектов затенения.</i><br/>
<br/>
Код для <a href="https://wiki.dolphin-emu.org/index.php?title=The_SpongeBob_SquarePants_Movie" rel="nofollow noopener noreferrer">The SpongeBob SquarePants Movie</a> не удалял смещение из исполняемого файла, а полностью исключал из рендеринга проблемные копии EFB! Хоть это и устраняло артефакты, при этом терялось и множество спецэффектов игры. Это решение нельзя было использовать как рабочий патч для игры, включенный по умолчанию. Однако эти игры казались настолько похожими, что <strong><a href="https://github.com/JMC47" rel="nofollow noopener noreferrer">JMC47</a></strong> верил в возможность правильного патча. Чтобы создать его, он ещё раз заручился помощью <strong><a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></strong>, чтобы изучить рендеринг игры с кодом action replay и без него. Вместе они убедились в том, что этот код был тупиковым путём для устранения источника проблемы. Однако в процессе этого исследования <strong><a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></strong> сообщил, что код для <a href="https://wiki.dolphin-emu.org/index.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom" rel="nofollow noopener noreferrer">Battle for Bikini Bottom</a> скорее всего более детализирован не из-за популярности игры, а потому, что на её диске содержались <em>отладочные символы</em> в виде неурезанного исполняемого файла ELF. <em>Отладочные символы</em> чрезвычайно полезны для реверс-инжиниринга, поскольку они разбивают программу на функции и назначают им названия непосредственно в коде. Это сильно упрощает понимание их работы.<br/>
<br/>
Разработчики оставили <em>отладочные символы</em> в предыдущей игре, но могли ли они оставить их снова в сиквеле...?<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/unstrippedelf.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/getpro/habr/post_images/78c/759/de5/78c759de5222db2eafca3be5a3dac47d.png"/></div></a><br/>
<i>Джекпот!</i><br/>
<br/>
Оказалось, что на дисках <strong>всех игр <a href="https://wiki.dolphin-emu.org/index.php?title=Category:Heavy_Iron_Studios_(Developer)" rel="nofollow noopener noreferrer">Heavy Iron Studios</a> той эпохи присутствовал неурезанный файл ELF</strong>. Благодаря этому мучительный проект по реверс-инжинирингу превратился в задачу, с которой при достаточном количестве времени и труда справится даже новичок. Благодаря руководству <strong><a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></strong> пользователь <strong><a href="https://github.com/JMC47" rel="nofollow noopener noreferrer">JMC47</a></strong> научился работать с инструментом для реверс-инжиниринга <a href="https://ghidra-sre.org/" rel="nofollow noopener noreferrer">Ghidra</a>, а также с плагинами, разработанными специально для анализа исполняемых файлов GameCube и Wii. Процесс был медленным, но помощь <strong><a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></strong> позволила с ним справиться. На этот раз смещение было не таким, как в <a href="https://wiki.dolphin-emu.org/index.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom" rel="nofollow noopener noreferrer">Battle for Bikini Bottom</a>; копирование EFB теперь выполнялось в половинном разрешении, но во всём остальном процесс рендеринга не отличался от предыдущей игры. <strong><a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></strong> смог определить значение, находившееся в памяти, после чего <strong><a href="https://github.com/JMC47" rel="nofollow noopener noreferrer">JMC47</a></strong> начал патчить каждое вхождение числа с плавающей запятой, пока не нашёл адрес памяти, исправлявший рендеринг. Сделав это, он создал новый <a href="https://wiki.dolphin-emu.org/index.php?title=FifoPlayer" rel="nofollow noopener noreferrer">Fifolog</a> для <strong><a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></strong>, чтобы тот убедился в работе патча и портировал код на другие регионы игры.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/spongebobmovieimproved.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/239/915/2c1/2399152c11c6651845023c98f970dc9d.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/239/915/2c1/2399152c11c6651845023c98f970dc9d.jpg" data-blurred="true"/></div></a><br/>
<i>Даже Патрик удивлён тому, что все баги пропали</i><br/>
<br/>
… Но и на этом история не заканчивается. <a href="https://wiki.dolphin-emu.org/index.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom" rel="nofollow noopener noreferrer">SpongeBob Squarepants: Battle for Bikini Bottom</a> и <a href="https://wiki.dolphin-emu.org/index.php?title=The_SpongeBob_SquarePants_Movie" rel="nofollow noopener noreferrer">The SpongeBob SquarePants Movie</a> были самыми популярными играми с этой проблемой, но <a href="https://wiki.dolphin-emu.org/index.php?title=Category:Heavy_Iron_Studios_(Developer)" rel="nofollow noopener noreferrer">Heavy Iron Studios</a> использовала ту же технику в большинстве своих игр. Благодаря работе над <a href="https://wiki.dolphin-emu.org/index.php?title=The_SpongeBob_SquarePants_Movie" rel="nofollow noopener noreferrer">The SpongeBob SquarePants Movie</a> <strong><a href="https://github.com/JMC47" rel="nofollow noopener noreferrer">JMC47</a></strong> знал точную последовательность действий для поиска смещённых копий EFB и устранению проблемы. Хотя больше ни одна игра компании для GameCube не была и близко столь же популярна, только лень могла помешать заставить патч работать для <em>всех игр, в которых известна эта проблема</em>. На этот раз кодов, которые можно взять за основу, не было, но на теперь они уже и не требовались.<br/>
<br/>
За следующие несколько недель он собрал все известные игры и версии с этой проблемой, проверил их и разработал патчи для каждой. Поэтому теперь игры наподобие <a href="https://wiki.dolphin-emu.org/index.php?title=The_Incredibles" rel="nofollow noopener noreferrer">The Incredibles</a>, <a href="https://wiki.dolphin-emu.org/index.php?title=The_Incredibles:_Rise_of_the_Underminer" rel="nofollow noopener noreferrer">The Incredibles: Rise of the Underminer</a> и даже различные сборки <a href="https://wiki.dolphin-emu.org/index.php?title=2_Games_in_1:_Nickelodeon_SpongeBob_Schwammkopf:_Der_Film_%2B_Nickelodeon_SpongeBob_Schwammkopf:_Schlacht_um_Bikini_Bottom" rel="nofollow noopener noreferrer">2 in 1 SpongeBob/Incredibles</a> имели патчи, обеспечивавшие правильную работу в высоких разрешениях.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/incredibles-vertexroundingoff.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/f67/7ff/1db/f677ff1db493a0aac20e3c938a035c32.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/f67/7ff/1db/f677ff1db493a0aac20e3c938a035c32.jpg" data-blurred="true"/></div></a><br/>
<i>Из-за сломанных теней игру приходилось запускать в нативном разрешении.</i><br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/incredibles-vertexroundingon.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/c0c/cf4/da8/c0ccf4da814778205c4d5f2d1eb6b100.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/c0c/cf4/da8/c0ccf4da814778205c4d5f2d1eb6b100.jpg" data-blurred="true"/></div></a><br/>
<i>Но теперь можно играть почти в любую из старых игр Heavy Iron Studios с повышенным разрешением!</i><br/>
<br/>
И теперь все эти игры работают в повышенном разрешении, но не благодаря каким-то улучшениям в эмуляции, а из-за модификации игры, позволяющей удобнее выполнять рендеринг. Хотя <em>обычно</em> Dolphin по умолчанию не использует включенные патчи или улучшения, мы понимаем, что многие наши пользователи рады возможности запуска игр в высоком разрешении. В данном случае мы не можем особо улучшить эмуляцию игры, но изменив саму игру, мы улучшили рендеринг в высоких разрешениях. И стоит помнить о том, что включение патчей <em>не ухудшает</em> рендеринг игры в нативном разрешении. Поэтому в последних тестовых сборках мы по умолчанию включили и эти патчи, <em>и</em> Vertex Rounding.<br/>
<br/>
Также в последних тестовых сборках мы по умолчанию <em>отключили Dual Core</em> для этих игр после того, как <strong><a href="https://github.com/JoeyBallentine" rel="nofollow noopener noreferrer">JoeyBallentine</a></strong> и сообщество спидраннеров <a href="https://wiki.dolphin-emu.org/index.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom" rel="nofollow noopener noreferrer">SpongeBob Squarepants: Battle for Bikini Bottom</a> сообщили нам о проблемах со стабильностью игры. Так как эти игры нетребовательны и им не нужны многие вычислительно затратные функции, это не должно стать проблемой для большинства десктопов и мощных устройствах Android. Но если вас устраивают возникающие время от времени сбои, то вы можете снова включить Dual Core для неё на странице свойств игры.<br/>
<br/>
В течение нескольких лет мы знали, что многие игроки разочарованы количеством проблем Dolphin с играми <a href="https://wiki.dolphin-emu.org/index.php?title=Category:Heavy_Iron_Studios_(Developer)" rel="nofollow noopener noreferrer">Heavy Iron Studios</a>. Теперь у них появился отличный шанс пройти эти классические игры заново. Мы думаем, им понравится то, что они увидят.<br/>
<br/>
<h4><a href="https://dolphin-emu.org/download/dev/master/5.0-14812/" rel="nofollow noopener noreferrer">5.0-14812 — Convert NaN to 1 When Generating Texture Coordinates</a>, <a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></h4><br/>
Когда ни донимают его просьбами о помощи в реверс-инжиниринге других игр, <strong><a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></strong> углубляется в исследование самых странных графических багов, возникающих в Dolphin. Его внимание привлекла одна проблема в issue tracker, потому что не было никаких зацепок для её решения. <a href="https://wiki.dolphin-emu.org/index.php?title=Shadow_the_Hedgehog" rel="nofollow noopener noreferrer">Shadow the Hedgehog</a> — игра, любимая абсолютно всеми фанатами Соника, имела проблемы с рендерингом век глаз персонажей, особенно в некоторых катсценах. К счастью, тестер сохранил <a href="https://wiki.dolphin-emu.org/index.php?title=FifoPlayer" rel="nofollow noopener noreferrer">Fifolog</a> этого бага, поэтому <strong><a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></strong> проанализировал Fifolog и выяснил, что веки имеют координату текстур <strong>NaN</strong> (Not a Number). Так как это казалось ужасной ошибкой, он решил воспроизвести Fifolog при помощи Hardware Fifoplayer, и нашёл нечто очень любопытное.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/shadoweyes-broken.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/getpro/habr/post_images/ad3/fa3/472/ad3fa3472b0ab17e0ca67ee019732b0d.png"/></div></a><br/>
<i>Вот как рендерится Fifolog в Dolphin.</i><br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/shadoweyes-console.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/cd8/a94/b26/cd8a94b26754d577992fb784ea5ee3a3.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/cd8/a94/b26/cd8a94b26754d577992fb784ea5ee3a3.jpg" data-blurred="true"/></div></a><br/>
<i>Но на консоли Fifolog рендерится корректно, то есть на ней существует какая-то специальная обработка NaN!</i><br/>
<br/>
Походило на то, что реальное «железо» каким-то образом автоматически исправляет NaN. <strong><a href="https://github.com/Pokechu22" rel="nofollow noopener noreferrer">Pokechu22</a></strong> продолжил разбираться с проблемой на консоли, в конечном итоге поняв, что консоль интерпретирует координаты текстур NaN как «1» или "-1". После <a href="https://github.com/dolphin-emu/dolphin/pull/9928#issuecomment-893043811" rel="nofollow noopener noreferrer">тщательного анализа</a> значений он добавил в эмуляцию графики Dolphin условие преобразования NaN в 1, чтобы временно решить эту проблему.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/shadoweyes-fixed.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/getpro/habr/post_images/d46/373/c24/d46373c242f736eb1d0dc511b01fdbbe.png"/></div></a><br/>
<i>С этой дополнительной обработкой веки выглядят гораздо ближе к тому, что мы видим на консоли.</i><br/>
<br/>
В <a href="https://wiki.dolphin-emu.org/index.php?title=Shadow_the_Hedgehog" rel="nofollow noopener noreferrer">Shadow the Hedgehog</a> по-прежнему остались кое-какие странности с рендерингом век, но на данный момент ситуация сильно улучшилась. К сожалению, если вы используете Ubershaders D3D11 или D3D12, то точно эмулировать это поведение не удастся. D3D11/12 автоматически оптимизирует попытки Dolphin использовать isnan для проверки наличия значений NaN в шейдерах, как бы мы ни пытались сказать им, что нам <em>действительно</em> нужно знать, NaN или нет. Из-за этого пока глаза в D3D11/12 при использовании Ubershaders остаются сломанными.<br/>
<br/>
<h4><a href="https://dolphin-emu.org/download/dev/master/5.0-14829/" rel="nofollow noopener noreferrer">5.0-14829 — PowerPC: Implement Broken Masking Behavior on Uncached Writes</a>, <a href="https://github.com/JosJuice" rel="nofollow noopener noreferrer">JosJuice</a> при поддержке <a href="https://github.com/eigenform" rel="nofollow noopener noreferrer">eigenform</a>, <a href="https://github.com/delroth" rel="nofollow noopener noreferrer">delroth</a>, <a href="https://github.com/phire" rel="nofollow noopener noreferrer">phire</a>, <a href="https://github.com/marcan" rel="nofollow noopener noreferrer">marcan</a>, <a href="https://github.com/segher" rel="nofollow noopener noreferrer">segher</a>, <a href="https://github.com/Extrems" rel="nofollow noopener noreferrer">Extrems</a> и <a href="https://www.youtube.com/channel/UCWYUUzuybieMseJy3KyCA7g" rel="nofollow noopener noreferrer">Rylie</a></h4><br/>
Сложно найти более крупную группу знаменитых разработчиков эмуляторов и реверс-инженеров GameCube/Wii, работающих над одним изменением. Собрал их вместе не какой-то серьёзный баг в Dolphin и не проблема, касающаяся многих сотен игр. Их собрал вместе странный аппаратный баг, попытки протестировать его и в конечном итоге сэмулировать. На самом деле, этот аппаратный баг был известен довольно давно, но его игнорировали, потому что ни в одной коммерческой игре он не использовался… до недавнего времени.<br/>
<br/>
Нам уже было хорошо известно, что игры серии Zelda для N64 были невероятно поломанными. Благодаря выполнению произвольного кода (Arbitrary Code Execution, ACE) игроки в буквальном смысле записывали какой-нибудь код в память и заставляли исполнять его, чтобы перейти сразу к финальным титрам игры. Благодаря этому время спидранов версии <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Ocarina_of_Time" rel="nofollow noopener noreferrer">Ocarina of Time</a> для N64 стало <em>меньше десяти минут</em>. К сожалению, пока ACE было невозможно на версиях <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Ocarina_of_Time" rel="nofollow noopener noreferrer">Ocarina of Time</a> и <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Majora%27s_Mask" rel="nofollow noopener noreferrer">Majora's Mask</a> для Virtual Console, из-за чего игроки были вынуждены искать альтернативы и новые идеи.<br/>
<br/>
Одно из удивительных открытий, изначально сделанное <a href="https://github.com/MrCheeze" rel="nofollow noopener noreferrer">MrCheeze</a>, называется <strong>LightNode SRM</strong>. Это более мощный способ манипуляций с устаревшими ссылками (Stale Reference Manipulation) (в мире программных уязвимостей более известный как Use-After-Free или UAF), который работает <em>лучше</em> в версиях для Virtual Console, и выполняется довольно быстро. Он работает и в <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Ocarina_of_Time" rel="nofollow noopener noreferrer">Ocarina of Time</a> и в <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Majora%27s_Mask" rel="nofollow noopener noreferrer">Majora's Mask</a>, и сегодня используется для самого быстрого прохождения <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Ocarina_of_Time" rel="nofollow noopener noreferrer">OoT</a> в категории Any%! <i>[Прим. пер.: в этой категории игроки стремятся как можно быстрее добраться до финальной катсцены/титров игнорируя прохождение сюжета, выполнение квестов и собирание предметов.]</i><br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/6165666b6a73daf6662a1ba6" data-style="" id="6165666b6a73daf6662a1ba6" width=""></div></div><br/>
<i>Работа нового бага на консоли.</i><br/>
<br/>
Что же такое LightNode SRM и почему оно работает лучше с версиями этих игр для Virtual Console? Давайте рассмотрим сам баг. Важнейший компонент срабатывания бага заключается в том, чтобы найти способ заставить Линка нести «актора» (игровую сущность), который уже был выгружен. Один из простейших способов добиться этого — сменить комнату в состоянии задержки захвата параллельно с использованием классического приёма <a href="https://www.zeldaspeedruns.com/oot/tech/superslide" rel="nofollow noopener noreferrer">superslide</a>.<br/>
<br/>
Как только Линк начинает нести <em>ничего</em>, начинается самое веселье. На самом деле он записывает три слова и два полуслова в части памяти, которые принадлежали актору, но теперь используются для других данных. Даже если вы выполните этот глитч для большинства акторов, то всё равно будете ограничены возможностью перезаписи только частей кучи актора, которые содержат такие элементы, как данные о врагах и предметах. Это достаточно полезная возможность, но если найти способ выбраться за пределы кучи актора, то откроется огромный потенциал для взлома. Именно здесь вступает в дело LightNode SRM!<br/>
<br/>
LightNode SRM названо так, потому что использует освещение в игре. Игра обрабатывает загружаемые/выгружаемые источники динамического освещения при помощи <a href="https://en.wikipedia.org/wiki/Doubly_linked_list" rel="nofollow noopener noreferrer">двунаправленного списка</a> всех загруженных на текущий момент источников. Одним из примеров таких источников являются разбросанные по всей игре факелы.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/LNSRM_Angle3.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/f0d/4c5/5f4/f0d4c55f4b886aa172f334bd821627ed.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/f0d/4c5/5f4/f0d4c55f4b886aa172f334bd821627ed.jpg" data-blurred="true"/></div></a><br/>
<i>Во время LightNode SRM огонь «схваченного» игроком LightNode отсутствует!</i><br/>
<br/>
Важно здесь то, что при каждой выгрузке актора с источником динамического освещения, соответствующий ему LightNode удаляется из связанного списка:<br/>
<br/>
<pre><code class="cpp">node->prev->next = node->next;
node->next->prev = node->prev;</code></pre><br/>
Указатель на узел источника (<code>node</code> в этом фрагменте кода) хранится в данных экземпляра актора, поэтому его можно переписать выполнением SRM и изменить так, чтобы он указывал на управляемую спидраннерами область памяти. Это означает, что <code>node->prev</code> и <code>node->next</code> могут быть чем угодно и указывать на всё, что захочет модифицировать спидраннер, даже за пределами кучи актора!<br/>
<br/>
По сути, это даёт спидраннерам возможность выполнять в обеих играх произвольные записи в ОЗУ! Так как манипулирование узлом <code>node</code> выполняется указанием на координаты респауна Линка, адрес записи и записываемое значение в конечном итоге управляются позицией Линка. На оборудовании Nintendo 64 предоставляемые этим трюком возможности чуть более ограничены, чем на консолях с PowerPC из-за особенностей поведения ЦП в некоторых ключевых ситуациях. В <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Ocarina_of_Time" rel="nofollow noopener noreferrer">Ocarina of Time</a> это в конечном итоге было не так важно, потому что имя файла было выровнено и находилось достаточно близко к доступу из связанного списка. Заставив указатель LightNode считать имя файла, вы можете записать в название файла полезную нагрузку.<br/>
<br/>
В <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Majora%27s_Mask" rel="nofollow noopener noreferrer">Majora's Mask</a> всё устроено немного иначе — из-за использования <a href="https://en.wikipedia.org/wiki/Nintendo_64_accessories#Expansion_Pak" rel="nofollow noopener noreferrer">N64 Expansion RAM</a> имя файла находится слишком далеко в памяти, поэтому использовать его чуть сложнее. Здесь ещё большую важность приобретает способность GameCube/Wii выполнения невыровненных операций записи. Она даёт игрокам гораздо больший контроль над тем, какие значения можно записывать в память, и позволяет им управлять записью в ОЗУ значений с плавающей запятой. Благодаря этому версии этих игр для GameCube и Virtual Console способны на вещи, невозможные на оборудовании N64. Так как версии для Virtual Console быстрее и стабильнее, чем эмуляторы GC N64, спидраннеры продолжили работать с ними.<br/>
<br/>
Первое применение LightNode SRM дало свои плоды в <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Majora%27s_Mask" rel="nofollow noopener noreferrer">Majora's Mask</a> в категории Any%; спидран не поставил мирового рекорда, но всё равно показал потенциал новой техники. Вскоре после этого LightNode SRM прославилось тем, что впервые позволило пройти меньше чем за <em>7</em> минут <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Ocarina_of_Time" rel="nofollow noopener noreferrer">любую версию Ocarina of Time</a>! Этот способ работает только на GameCube/Wii из-за <em>ещё одного</em> поведения ЦП, вызывающего явление, которое спидраннеры называют DoubleWord Write (DWW) и QuadWord Write (QWW). Мы вернёмся к нему чуть позже, потому что объяснение его довольно сложно.<br/>
<br/>
С точки зрения спидраннинга, эти техники открывали множество новых возможностей, особенно вне категории Any%. Выполнение произвольного кода — <em>настолько мощная техника</em>, что запрещено во многих категориях, чтобы не усложнять определения категорий и сохранять интересность прохождения. Если у вас получилось исполнять собственный код, то вы можете сделать что угодно. Стоит заметить, что запрет ACE <em>включает в себя</em> использование LightNode SRM для перезаписи кода, но так как его можно использовать для перезаписи данных, что совершенно законно, оно сильно повлияло на множество различных категорий.<br/>
<br/>
Как и в случае с любым важным багом, игроки начали стремиться расширить его через эмуляцию. На этот раз они использовали не эмулятор N64, потому что лучше всего для спидранов подходят версии для Virtual Console Nintendo Wii. К сожалению, как понятно из представленного выше видео, Dolphin не очень хорошо подходит для этой задачи. Хотя все основные шаги работали, значения, записываемые в ОЗУ при помощи LightNode, немного различались на консоли и в Dolphin. Причина этого может быть немного неожиданной: они использовали функцию, которая <em>работала</em> в Dolphin, но была поломана на консоли.<br/>
<br/>
Именно так — трюк зависел от точной эмуляции <em>Uncached Writes</em>.<br/>
<br/>
<div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/aeb/91e/5fe/aeb91e5fe802798f9210ada7713a5873.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/aeb/91e/5fe/aeb91e5fe802798f9210ada7713a5873.jpg" data-blurred="true"/></div><br/>
На Nintendo GameCube и Wii есть аппаратная особенность, вызывающая неправильное поведение невыровненных некэшированных операций записи. Для Dolphin это не было особой проблемой, потому что в коммерческом ПО такие операции записи не использовались. Не было никакого смысла прикладывать усилия для эмуляции «мёртвой» функции консоли. Однако давайте вспомним о той функции ЦП, которая вызывала DWW и QWW. Это были именно те самые поломанные невыровненные некэшированные операции записи! Их поломанность позволяла перезаписывать больше памяти, чем было бы возможно при правильной работе. Это и было ключом к спидрану — в показанном выше видео с переходом к титрам игры автор переписал две соседние записи входа, чтобы вызвать две разные катсцены с титрами в Termina Field!<br/>
<br/>
К сожалению, в Dolphin это не работало. Эти некэшированные операции записи вели себя <em>правильно</em>, то есть сломанное дублирование не эмулировалось и вторая запись входа не записывалась. Спидраннеры <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Majora%27s_Mask" rel="nofollow noopener noreferrer">Majora's Mask</a> обратились к разработчикам Dolphin с вопросом: можно ли заставить этот способ работать?<br/>
<br/>
Отчёт о проблеме был отправлен, спидраннеры уже были готовы тестировать игру, а <strong><a href="https://github.com/JosJuice" rel="nofollow noopener noreferrer">JosJuice</a></strong> начал разрабатывать тест оборудования, чтобы разобраться, что же конкретно происходит. К сожалению, он почти сразу же зашёл в тупик. Оказалось, что попытка проверки поведения на консоли приводит к внезапному <em>сбою</em>. Что ни делали тестеры, некэшированные операции записи завершались зависанием консоли. К анализу происходящего привлекли других разработчиков. Консоль не должна была зависать; мы знали это, потому что спидран показал, что, по крайней мере, это <em>должно</em> работать. Постепенно всё больше разработчиков начинало разбираться в проблеме, и вскоре вокруг неё собрались реверс-инженеры с огромным опытом. Было протестировано множество разных подходов, одни разработчики пытались воссоздать условия игры, другие пробовали упростить тест, чтобы понять, не возникает ли ошибка в другом фрагменте теста.<br/>
<br/>
Но что бы ни происходило, консоль зависала на первой некэшированной записи.<br/>
<br/>
Спустя несколько дней экспериментов <strong><a href="https://github.com/eigenform" rel="nofollow noopener noreferrer">eigenform</a></strong> решил головоломку. Почти все homebrew-проекты созданы на основе homebrew-библиотеки <a href="https://wiibrew.org/wiki/Libogc" rel="nofollow noopener noreferrer">libogc</a>, используемой для обеспечения интерфейса с оборудованием GameCube и Wii. Она сильно упрощает написание, компилирование и тестирование homebrew-программ, предоставляя API для взаимодействия с оборудованием и имея множество примеров проектов. <strong><a href="https://github.com/eigenform" rel="nofollow noopener noreferrer">eigenform</a></strong> решил написать тест, <em>не использующий</em> libogc. Хотя этот способ был гораздо более сложным, в конечном итоге он подтвердил, что проблема связана с самой libogc. К анализу были привлечены уже десятки разработчиков, поэтому потребовалась всего пара минут для выяснения того, что зависание было вызвано libogc, забывающей сбросить прерывание; из-за этого библиотека снова и снова обрабатывала одно и то же прерывание. Благодаря тестированию этот баг устранён в последних версиях libogc.<br/>
<br/>
После того, как тесты оборудования начали работать, <strong><a href="https://github.com/JosJuice" rel="nofollow noopener noreferrer">JosJuice</a></strong> смог протестировать и понять, как именно некэшированные тесты работали на консоли, и реализовал их сломанное поведение в Dolphin. Мы попросили сообщество спидраннеров убедиться, что всё работает правильно, и они продемонстрировали нам безошибочное прохождение в Dolphin версии <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Majora%27s_Mask" rel="nofollow noopener noreferrer">Majora's Mask's</a> для Virtual Console в категории Any%.<br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/6166ef3cedd610f626b80cc5" data-style="" id="6166ef3cedd610f626b80cc5" width=""></div></div><br/>
<i>После внесённых изменений Rylie подтвердила, что прохождение работает в Dolphin!</i><br/>
<br/>
Без <strong><a href="https://www.youtube.com/channel/UCWYUUzuybieMseJy3KyCA7g" rel="nofollow noopener noreferrer">Rylie</a></strong> и безумных сообществ любителей <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Ocarina_of_Time" rel="nofollow noopener noreferrer">Ocarina of Time</a> и <a href="https://wiki.dolphin-emu.org/index.php?title=The_Legend_of_Zelda:_Majora%27s_Mask" rel="nofollow noopener noreferrer">Majora's Mask</a> мы могли и никогда не узнать, что некэшированная запись могла использоваться в коммерческой игре для чего-то полезного…<br/>
<br/>
На самом деле, нам известен один конкретный <em>homebrew</em>, который использовал это поведение в качестве меры защиты. Версии <a href="https://wiki.dolphin-emu.org/index.php?title=Homebrew_Channel" rel="nofollow noopener noreferrer">Homebrew Channel</a> с закрытыми исходниками имели множество защит и странных поведений, использовавшихся для того, чтобы их запускали надёжным образом. Одной из функций, которые они использвоали, было <em>поломанное</em> поведение некэшированных записей. Мы даже не занимались этим приложением, потому что в те времена Dolphin был настолько ненадёжен, что мы и не надеялись его запустить. Но годы улучшений изменили ситуацию, и при наличии поддержки невыровненных кэшированных операций записи версии Homebrew Channel с закрытыми исходниками наконец-то начали проявлять в Dolphin признаки жизни. На самом деле, приложение позволяло даже добраться до меню… однако с некоторыми <em>особенностями</em>.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/thehbc1.jpg" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/getpro/habr/post_images/e17/60c/e41/e1760ce413ed82c2f603eebcf1858512.png"/></div></a><br/>
<i>Если защиты в старой версии Homebrew Channel выполнялись неправильно, они не позволяли пройти уведомление о жульничестве. Однако спустя час ожидания они всё равно самостоятельно позволяли загрузить меню.</i><br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/thehbc2.jpg" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/7d7/e45/6cb/7d7e456cb3db7fea84d9c722085d4563.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/7d7/e45/6cb/7d7e456cb3db7fea84d9c722085d4563.jpg" data-blurred="true"/></div></a><br/>
<i>Однако они демонстрировали этот дружелюбный жест.</i><br/>
<br/>
Некоторые из наших пользователей могут задаться вопросом: как же им удавалось запускать Homebrew Channel в Dolphin. Дело в том, что последняя версия Homebrew Channel (называющаяся <a href="https://hackmii.com/2016/11/the-open-homebrew-channel/" rel="nofollow noopener noreferrer">Open Homebrew Channel</a>) избавилась от всех защит, чтобы упростить работу Dolphin. Так как большинство злодеев, использовавших канал в своих целях, уже давно перешло на более современные консоли, защиты не добавляли ничего, кроме головной боли для разработчиков Dolphin. Тем не менее, всё равно было бы здорово победить все проверки в старых версиях Homebrew Channel и заставить их загружаться без срабатывания защитных процедур.<br/>
<br/>
<h4><a href="https://dolphin-emu.org/download/dev/master/5.0-14844/" rel="nofollow noopener noreferrer">5.0-14844 — Implement Late VI Updates</a>, <a href="https://github.com/Techjar" rel="nofollow noopener noreferrer">Techjar</a> и <a href="https://github.com/phire" rel="nofollow noopener noreferrer">phire</a></h4><br/>
Большая часть работы по выводу кадров в Dolphin заключается в создании оптимизаций, обеспечивающих эмулятору минимальные задержки. Хотя большинство игр упрощает работу благодаря использованию стандартной конфигурации Video Interface (VI) и позволяют <a href="https://dolphin-emu.org/blog/2017/11/19/hybridxfb/#immediately-present-xfb" rel="nofollow noopener noreferrer">Dolphin обходить большую часть эмуляции XFB</a>, снижая задержку <em>сильнее</em>, чем это возможно на консоли, многие игры применяют более сложные конфигурации VI. Это заставляет Dolphin делать всё правильно и на самом деле эмулировать процедуру считывания данных. Но даже в этом случае Dolphin <em>всё равно</em> немного жульничает, выводя копию XFB с параметрами, которые она имела в начале поля, а не применяя их на протяжении процесса вывода копии XFB. Это позволяет сэкономить примерно 16 мс задержки. Считалось, что такая техника поддерживается <em>всеми играми</em>… пока на горизонте не появилась <a href="https://wiki.dolphin-emu.org/index.php?title=WWE_Crush_Hour" rel="nofollow noopener noreferrer">WWE Crush Hour</a>.<br/>
<br/>
<div class="oembed"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/6167cf20122cc8f638696805" data-style="" id="6167cf20122cc8f638696805" width=""></div></div><br/>
<i>Представьте это мерцание с частотой 60fps. Видео с полной скоростью можно посмотреть <a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/crushhour-flashing.mp4" rel="nofollow noopener noreferrer">здесь</a> (опасно для эпилептиков).</i><br/>
<br/>
Эта очень странная игра обладает поведением, которое никто не встречал ни в одной коммерческой игре: она меняет параметры VI <em>во время </em> вывода кадра на экран. Dolphin ничего не может с этим поделать, потому что уже закончил обработку с неправильными параметрами VI к тому времени, как игра их изменила. Спустя четыре года после некорректного анализа ZephyrSurfer повторно проанализировал эту проблему и понял, что предыдущее внедрение в <a href="https://dolphin-emu.org/blog/2017/11/19/hybridxfb/" rel="nofollow noopener noreferrer">Hybrid XFB</a> было неверным. Этот новый анализ привёл к появлению версии <a href="https://dolphin-emu.org/download/dev/7ee6d082131cf40b8a8471ff3ac967e30326f59e/" rel="nofollow noopener noreferrer">5.0-146</a> и к оптимизации задержек.<br/>
<br/>
Увидев это, <strong><a href="https://github.com/phire" rel="nofollow noopener noreferrer">phire</a></strong> рассказал всем о хаке задержки и объяснил, как обойти эту проблему. По сути, в Dolphin просто нужно было добавить опцию <em>ожидания конца вывода</em> для правильного вывода кадра. Это приводит к дополнительной задержке ровно в один кадр, поэтому было предложено реализовать эту функцию как отдельную опцию только для этой игры. Хотя оба разработчика были слишком заняты, оставленные ими объяснения оказались достаточно чёткими для того, чтобы <strong><a href="https://github.com/Techjar" rel="nofollow noopener noreferrer">Techjar</a></strong> смог реализовать это исправление. Важно заметить, что ни одна из этих реализаций не является <em>точной</em>; чтобы делать всё правильно, Dolphin должен был бы применять конфигурации VI <em>во время</em> вывода, что было бы гораздо сложнее, но почти не принесло бы пользы.<br/>
<br/>
<h4><a href="https://dolphin-emu.org/download/dev/master/5.0-14866/" rel="nofollow noopener noreferrer">5.0-14866 — D3D12 — Fix GPU Texture Decoding on AMD</a>, <a href="https://github.com/K0bin" rel="nofollow noopener noreferrer">K0bin</a></h4><br/>
Новый участник проекта <strong><a href="https://github.com/K0bin" rel="nofollow noopener noreferrer">K0bin</a></strong> обратил внимание на отсутствующий барьер памяти в бэкенде D3D12 эмулятора Dolphin, который мог бы вызывать проблемы с декодированием текстур в GPU. Драйверов NVIDIA это не коснулось (вероятно, из-за игнорирования переходов между состояниями), но в картах AMD включение GPU Texture Decoding вызывало серьёзные проблемы и сбои. Проблему удалось решить одной строкой кода.<br/>
<br/>
<div style="text-align:center;"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/getpro/habr/post_images/649/998/7a1/6499987a1df749e524017236c722925e.png"/></div><br/>
<i>Здесь бы мог быть скриншот 6900 XT с устранённой проблемой, если бы у нас была эта карта!</i><br/>
<br/>
<h4><a href="https://dolphin-emu.org/download/dev/master/5.0-14821/" rel="nofollow noopener noreferrer">5.0-14821</a>, <a href="https://dolphin-emu.org/download/dev/master/5.0-14833/" rel="nofollow noopener noreferrer">5.0-14833</a>, <a href="https://dolphin-emu.org/download/dev/master/5.0-14897/" rel="nofollow noopener noreferrer">5.0-14897</a> и <a href="https://dolphin-emu.org/download/dev/master/5.0-15019/" rel="nofollow noopener noreferrer">5.0-15019</a> — Fix <code>dcbx</code> Invalidation Performance Without Breaking Everything This Time, <a href="https://github.com/AdmiralCurtiss" rel="nofollow noopener noreferrer">AdmiralCurtiss</a> и <a href="https://github.com/JosJuice" rel="nofollow noopener noreferrer">JosJuice</a></h4><br/>
Если вы следили за июльскими тестовыми сборками, то могли заметить тенденции в изменениях с <code>dcbx</code> (инвалидация/сброс/обнуление кэша данных и т.п.). Наша цель заключалась в том, чтобы масштабные инвалидации были быстрыми <em>и</em> корректными, но достижение обоих требований оказалось сложной задачей. В конце июльского отчёта Progress Report <a href="https://dolphin-emu.org/blog/2021/08/01/dolphin-progress-report-june-and-july-2021/#50-14768-jit-perform-bat-lookup-in-dcbfdcbidcbst-instructions-by-josjuice" rel="nofollow noopener noreferrer">мы решили, что у нас есть простое исправление снижения производительности, касающегося различных команд сброса/инвалидации кэша данных</a>. Казалось, что в обоих поломанных случаях всё работает хорошо, и разработчики подумали, что эта сага подошла к своему завершению. Как же мы ошибались…<br/>
<br/>
После выпуска Progress Report к нам начали поступать отчёты о проблемах, и самые частые были связаны с серией игр <a href="https://wiki.dolphin-emu.org/index.php?title=Category:Mario_%26_Sonic_(Series)" rel="nofollow noopener noreferrer">Mario and Sonic at the Olympic Games</a>. Первоначальный анализ показал, что всё было очень плохо. JIT архитектуры x86-64 эмулятора Dolphin вёл себя неправильно и дважды транслировал адрес во время <code>dcbx</code>, таким образом переходя к неправильному флагу. Также в <i>обоих</i> JIT Dolphin было поломано маскирование, из-за чего поломанными в конце месяца оказались довольно многие игры.<br/>
<br/>
<strong><a href="https://github.com/JosJuice" rel="nofollow noopener noreferrer">JosJuice</a></strong> и <strong><a href="https://github.com/AdmiralCurtiss" rel="nofollow noopener noreferrer">AdmiralCurtiss</a></strong> объединили усилия, чтобы быстро исправить JIT и как можно быстрее снова заставить всё работать. <strong><a href="https://github.com/JosJuice" rel="nofollow noopener noreferrer">JosJuice</a></strong> занялся исправление маскирования в JIT AArch64, а <strong><a href="https://github.com/AdmiralCurtiss" rel="nofollow noopener noreferrer">AdmiralCurtiss</a></strong> внёс гораздо более объёмные изменения в JIT x86-64, чтобы гарантировать, что Dolphin всегда будет передавать командам <code>dcbx</code> правильный адрес.<br/>
<br/>
Благодаря этой быстрой работе менее чем через две недели всё снова заработало. Однако эти исправления имели свою цену. Из-за них пропали все улучшения производительности из предыдущего отчёта об изменениях, то есть <a href="https://wiki.dolphin-emu.org/index.php?title=Arc_Rise_Fantasia" rel="nofollow noopener noreferrer">Arc Rise Fantasia</a> и другие игры, одновременно инвалидирующие большие области памяти, снова имели проблемы с производительностью. Проще говоря, ситуация была не самой хорошей, и для её исправления требовались усилия.<br/>
<br/>
<a href="https://dolphin-emu.org/m/user/blog/progress-report/2021-august/arcrisefantasia.png" rel="nofollow noopener noreferrer"><div style="text-align:center;"><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/ac4/b40/4d1/ac4b404d11c649898fa773a28cd99ce3.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/ac4/b40/4d1/ac4b404d11c649898fa773a28cd99ce3.jpg" data-blurred="true"/></div></a><br/>
<i>Загрузка областей с карты мира приводила к серьёзному проседанию FPS, поскольку игра очищала большие участки памяти.</i><br/>
<br/>
<strong><a href="https://github.com/AdmiralCurtiss" rel="nofollow noopener noreferrer">AdmiralCurtiss</a></strong> приступил к изучению причин торможения, чтобы найти виновника. При первоначальной загрузке <a href="https://wiki.dolphin-emu.org/index.php?title=Super_Mario_Sunshine" rel="nofollow noopener noreferrer">Super Mario Sunshine</a>, которая является одним из наихудших сценариев для <code>dcbx</code>, код трансляции страниц вызывался <strong>134 миллионов раз</strong>. Что ещё страннее, так это то, что инвалидируемые игрой данные даже не отображались на физическую память! Выполнение всех этих вызовов по отдельности было ужасно неэффективным, поэтому нужно было что-то сделать, чтобы их сгруппировать. Мы решили поискать подсказки в том, как работает <em>idleskipping</em>. Idleskipping — это функция в JIT Dolphin, ищущая в коде <em>циклы</em>, предназначенные просто для «сжигания» излишнего времени ЦП. Вместо того, чтобы эмулировать эти пустые операции, мы можем просто обнаруживать и <em>пропускать</em> их, при этом подстраивая downcount и другие аспекты, чтобы сильно увеличить производительность ЦП.<br/>
<br/>
Хотя <code>dcbx</code> не является пустой операцией наподобие idleloops, благодаря распознаванию их циклов <strong><a href="https://github.com/AdmiralCurtiss" rel="nofollow noopener noreferrer">AdmiralCurtiss</a></strong> смог сделать так, чтобы вместо выполнения сотен миллионов отдельных вызовов Dolphin статически анализировал ситуацию для объединения их в <em>одну крупную dcbx</em>, а затем подстраивал downcount и другие вещи, чтобы в конечном итоге оптимизация с точки зрения эмулируемого окружения оказывалась эквивалентом отдельных вызовов. Этот трюк восстанавливает производительность до уровней, которые были в этих играх раньше и при этом больше ничего <em>не ломает</em>.<br/>
<br/>
И JIT x86-64, и JIT AArch64 теперь оснащены этой новой оптимизацией (для AArch64 её реализовал <strong><a href="https://github.com/JosJuice" rel="nofollow noopener noreferrer">JosJuice</a></strong>). И <em>теперь</em> всё должно быть и <em>быстрым</em>, и <em>корректным</em>, а нам не придётся выбирать одно из двух, как это было в последние два месяца.</div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%8D%D0%BC%D1%83%D0%BB%D1%8F%D1%82%D0%BE%D1%80%D1%8B%5D" class="tm-tags-list__link">эмуляторы</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bdolphin%20emulator%5D" class="tm-tags-list__link">dolphin emulator</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bwii%5D" class="tm-tags-list__link">wii</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bnintendo%20wii%5D" class="tm-tags-list__link">nintendo wii</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bgamecube%5D" class="tm-tags-list__link">gamecube</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bnintendo%2064%5D" class="tm-tags-list__link">nintendo 64</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BE%D0%B1%D1%80%D0%B0%D1%82%D0%BD%D0%B0%D1%8F%20%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0%5D" class="tm-tags-list__link">обратная разработка</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/3d_graphics/" class="tm-hubs-list__link">
    Работа с 3D-графикой
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/gamedev/" class="tm-hubs-list__link">
    Разработка игр
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/reverse-engineering/" class="tm-hubs-list__link">
    Реверс-инжиниринг
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/games/" class="tm-hubs-list__link">
    Игры и игровые приставки
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 24: ↑24 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 24: ↑24 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+24</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">2.7K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    17
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/PatientZero/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/8de/9c5/34a/8de9c534a18a6cb8693270a2b528d4c0.png" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 1329 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    1201
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">91.2</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><!----> <a href="/ru/users/PatientZero/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @PatientZero
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Переводчик-фрилансер</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <button type="submit" class="tm-user-card__button btn btn_transparent btn_small">
      Задонатить
    </button> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/581406/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 3 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/581406/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/581406/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"581406":{"id":"581406","timePublished":"2021-10-22T06:52:45+00:00","isCorporative":false,"lang":"ru","titleHtml":"Улучшения в эмуляторе Dolphin","leadData":{"textHtml":"\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F3ce\u002F42f\u002Fe9c\u002F3ce42fe9cc6e11586ca5a002a91927cb.jpg\" alt=\"image\"\u003E\u003C\u002Fdiv\u003E\u003Cbr\u003E\r\nМногие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы — важная часть многих сообществ любителей классических игр, они предоставляют игрокам доступ к таким функциям, как сетевой мультиплеер, моддинг, сохранения, а также открывают усовершенствования, невозможные на консоли. Если вам захочется поиграть в любимую игру, иногда просто удобнее воспользоваться эмулятором на десктопном компьютере, планшете или телефоне, чем откапывать и подключать консоль. Однако важно заметить, что наши отношения с игровыми сообществами взаимны и без помощи игроков и фанатов мы бы не смогли поддерживать библиотеку из тысяч игр.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nОсновным катализатором многих изменений, описанных в этом отчёте, стали сообщества игроков. Они занимались сложной отладкой, находили мелкие проблемы, которые оставались бы незаметными для тех, кто не знает игру в совершенстве, и даже создавали патчи, чтобы игры лучше подстраивались под усовершенствования в эмуляторе. Весь этот вклад, хотя и не являлся кодом, очень ценим нами, благодаря нему Dolphin стал тем, что мы видим сегодня. \u003Cbr\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше &rarr;","image":null},"editorVersion":"1.0","postType":"article","postLabels":[{"type":"translation","data":{"originalAuthorName":"MayImilae","originalUrl":"https:\u002F\u002Fru.dolphin-emu.org\u002Fblog\u002F2021\u002F09\u002F07\u002Fdolphin-progress-report-august-2021\u002F?cr=ru"}}],"author":{"scoreStats":{"score":1201,"votesCount":1329},"rating":91.2,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":"410013829899665","paymentPayPalMe":"vadimivshin","paymentWebmoney":null},"id":"78894","alias":"PatientZero","fullname":null,"avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F8de\u002F9c5\u002F34a\u002F8de9c534a18a6cb8693270a2b528d4c0.png","speciality":"Переводчик-фрилансер"},"statistics":{"commentsCount":3,"favoritesCount":17,"readingCount":2687,"score":24,"votesCount":24},"hubs":[{"relatedData":null,"id":"643","alias":"3d_graphics","type":"collective","title":"Работа с 3D-графикой","titleHtml":"Работа с 3D-графикой","isProfiled":true},{"relatedData":null,"id":"7773","alias":"gamedev","type":"collective","title":"Разработка игр","titleHtml":"Разработка игр","isProfiled":true},{"relatedData":null,"id":"19011","alias":"reverse-engineering","type":"collective","title":"Реверс-инжиниринг","titleHtml":"Реверс-инжиниринг","isProfiled":true},{"relatedData":null,"id":"21980","alias":"games","type":"collective","title":"Игры и игровые приставки","titleHtml":"Игры и игровые приставки","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"2","alias":"design","title":"Дизайн"},{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fspongebobold-vertexroundingon.jpg\" alt=\"image\" data-src=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fspongebobold-vertexroundingon.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\nМногие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы — важная часть многих сообществ любителей классических игр, они предоставляют игрокам доступ к таким функциям, как сетевой мультиплеер, моддинг, сохранения, а также открывают усовершенствования, невозможные на консоли. Если вам захочется поиграть в любимую игру, иногда просто удобнее воспользоваться эмулятором на десктопном компьютере, планшете или телефоне, чем откапывать и подключать консоль. Однако важно заметить, что наши отношения с игровыми сообществами взаимны и без помощи игроков и фанатов мы бы не смогли поддерживать библиотеку из тысяч игр.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОсновным катализатором многих изменений, описанных в этом отчёте, стали сообщества игроков. Они занимались сложной отладкой, находили мелкие проблемы, которые оставались бы незаметными для тех, кто не знает игру в совершенстве, и даже создавали патчи, чтобы игры лучше подстраивались под усовершенствования в эмуляторе. Весь этот вклад, хотя и не являлся кодом, очень ценим нами, благодаря нему Dolphin стал тем, что мы видим сегодня. \u003Cbr\u002F\u003E\r\n\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EЗначимые изменения\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-14795\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-14795 — JIT: Fix FMA Negation Ordering\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJosJuice\" rel=\"nofollow noopener noreferrer\"\u003EJosJuice\u003C\u002Fa\u003E\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Inazuma_Eleven_GO:_Strikers_2013\" rel=\"nofollow noopener noreferrer\"\u003EInazuma Eleven GO: Strikers 2013\u003C\u002Fa\u003E — последний релиз для Wii любимой игроками \u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FInazuma_Eleven\" rel=\"nofollow noopener noreferrer\"\u003Eфутбольной серии Inazuma Eleven\u003C\u002Fa\u003E. Эту игру можно любить за многое — множество персонажей, специальные движения, длинный режим RPG-истории, в которой вы собираете собственную футбольную команду, прокачиваете персонажей и побеждаете противников. Несмотря на то, что игра была выпущена только в Японии, она стала культовой для игроков всего мира. Существуют её фанатские переводы, по ней проводятся турниры между странами и даже есть «Кубок мира»!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fc70\u002F12a\u002F2a5\u002Fc7012a2a51506a23fdbaa10dc5f2c104.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EВ этом году уже прошло несколько турниров и онлайн-соревнований!\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nХотя в \u003Ca href=\"https:\u002F\u002Fwiimmfi.de\u002F\" rel=\"nofollow noopener noreferrer\"\u003EWiimmfi\u003C\u002Fa\u003E уже есть полная поддержка игры, в \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Inazuma_Eleven_GO:_Strikers_2013\" rel=\"nofollow noopener noreferrer\"\u003EInazuma Eleven GO: Strikers 2013\u003C\u002Fa\u003E по-прежнему играют онлайн через \u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FNintendo_Wi-Fi_Connection\" rel=\"nofollow noopener noreferrer\"\u003ENintendo Wi-Fi Connection\u003C\u002Fa\u003E, и многие пользователи выбирают Dolphin. Это одна из немногих игр Wii, для которых до сих пор можно найти матчи, особенно если зайти на один из Discord-серверов сообщества. В Dolphin всё работает отлично, за исключением одного раздражающего изъяна: Dolphin не может синхронизироваться с консолями Wii. При попытке выполнить блок \u003Cem\u003EHissatsu\u003C\u002Fem\u003E (специальные движения) или отбор мяча игра обнаруживает проблему и откатывается к точке до момента её возникновения, обычно сбрасывая мяч в неподвижную позицию. Это означает, что забивать голы мощными специальными движениями невозможно, как и отбирать мяч у противников. Игра была неиграбельной.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fembedd.srv.habr.com\u002Fiframe\u002F615d9bf9abb378f6450d1a03\" data-style=\"\" id=\"615d9bf9abb378f6450d1a03\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EВ анимации показана неудачная попытка поймать мяч, однако после небольшой загрузки мяч всё равно оказывается в руках вратаря. Причина этого — откат для восстановления из-за рассинхронизации. Видео в высоком качестве можно посмотреть \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Finazuma-desync.mp4\" rel=\"nofollow noopener noreferrer\"\u003Eздесь\u003C\u002Fa\u003E\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОдним из поединков в рамках организованного сообществом Кубка мира должна была стать игра Франции и Японии, что создавало проблему. Французское сообщество игроков в основном использует Dolphin, а большинство японских игроков играет только на консоли. Это означало, что игрокам или придётся перейти на непривычную систему, или отменить матч из-за этого бага. Игроки сообществ всех стран решили, что с них хватит: они доберутся до самой сути этой проблемы, чего бы это ни стоило. Ветераны Inazuma, в том числе такие игроки, как Obluda, AS, GalacticPirate и множество других, объединили свои усилия для выявления абсолютно кошмарного бага эмуляции.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЭтот баг стал такой проблемой из-за чрезвычайно конкретных условий, которые требовались для его воссоздания. Обычно при исследовании потенциальных багов ЦП приходится выполнять такие действия, как приостановка эмуляции, подключение отладчиков, изучение регистров и другие технические действия, чтобы конкретно изучить происходящее. Вдобавок ко всему этому разработчики часто используют интерпретатор Dolphin для проверки правильности JIT, чтобы определить, с каким типом бага они имеют дело. В прошлом подобные инструменты и тесты оборудования помогли разработчикам найти различия в вычислениях, которые когда-то вызывали рассинхронизацию реплеев в таких играх, как \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Mario_Kart_Wii\" rel=\"nofollow noopener noreferrer\"\u003EMario Kart Wii\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=F-Zero_GX\" rel=\"nofollow noopener noreferrer\"\u003EF-Zero GX\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Super_Smash_Bros._Brawl\" rel=\"nofollow noopener noreferrer\"\u003ESuper Smash Bros. Brawl\u003C\u002Fa\u003E и многих других.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Inazuma_Eleven_GO:_Strikers_2013\" rel=\"nofollow noopener noreferrer\"\u003EInazuma Eleven GO: Strikers 2013\u003C\u002Fa\u003E имела похожую проблему, но из-за одного ограничения её было очень сложно изучить. Чтобы баг проявился, \u003Cem\u003Eэмулятор должен быть подключен к Wi-Fi, соединённому с Wii\u003C\u002Fem\u003E. Это означало, что Dolphin должен работать \u003Cem\u003Eпочти\u003C\u002Fem\u003E на полной скорости и его нельзя ставить на паузу на долгий промежуток времени, ведь в противном случае соединение будет утеряно. По сути, это отсекает большинство способов, которые обычно используются для исследования и тестирования связанных с ЦП багов; даже процесс проверки в интерпретаторе того, что проблема возникла, становится нетривиальной задачей. Полный анализ команд обычными средствами тоже было невозможно реализовать, потому что это слишком бы снизило производительность. И хотя все \u003Cem\u003Eподозревали\u003C\u002Fem\u003E, что это был баг JIT, мы не могли в этом убедиться, поскольку не было возможности проверить, устраняет ли её переключение на интерпретатор!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНесмотря на эти препятствия, сообщество игроков в Inazuma приложило все свои усилия. Вместо использования традиционного анализа оно начало мучительный путь отката небольших групп команд в интерпретатор. При наличии достаточно быстрого процессора игроки могли запускать игру с полной скоростью и медленно тестировать каждую версию команд в интерпретаторе, чтобы проверить, не устранит ли одна из них проблему. Они достигли успеха, исследуя команды \u003Cem\u003EJIT с плавающей запятой\u003C\u002Fem\u003E. Отключив их группу, они смогли устранить рассинхронизацию, оставаясь \u003Cem\u003Eпочти\u003C\u002Fem\u003E на полной скорости, чтобы соединение с Wii не разорвалось. Имея на руках эту информацию, в работу включился \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJosJuice\" rel=\"nofollow noopener noreferrer\"\u003EJosJuice\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E, чтобы помочь пользователям в анализе оставшихся команд, и они нашли причину в командах \u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FMultiply%E2%80%93accumulate_operation\" rel=\"nofollow noopener noreferrer\"\u003Eсовмещённого умножения-сложения (Fused Multiply–Add, FMA)\u003C\u002Fa\u003E с плавающей запятой. Разработчики отнеслись к этому анализу скептически, потому JIT и x86-64, и AArch64 были тщательно проверены. К тому моменту они должны были стать практически идеальными, что подтверждается тестами оборудования и многими играми с файлами реплеев.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nК нему присоединились другие пользователи, а один разработчик даже импортировал игру, чтобы проверить, что происходит. Благодаря помощи сообщества \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Inazuma_Eleven_GO:_Strikers_2013\" rel=\"nofollow noopener noreferrer\"\u003EInazuma Eleven GO\u003C\u002Fa\u003E мы смогли лично убедиться в происходящем и подтвердить анализ команд. Определённо, с вычислениями FMA в Dolphin было что-то не то. Проблема заключалась в том, что никто не мог найти источник, хоть мы и знали, что что-то сломано. После долгого изучения проблемы \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJosJuice\" rel=\"nofollow noopener noreferrer\"\u003EJosJuice\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E наконец-то разобрался: оказалось, проблема заключалась в различиях в конкретном моменте смены знака. Давайте рассмотрим технические подробности.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fbe0\u002F8d0\u002Fe2c\u002Fbe08d0e2c021f18f3c4fc293d5f66751.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fbe0\u002F8d0\u002Fe2c\u002Fbe08d0e2c021f18f3c4fc293d5f66751.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\nСмена знака — это изменение знака с положительного на отрицательный, или наоборот. Для эффективности она объединяется в дублирующие версии команд FMA, например, \u003Ccode\u003Emadd\u003C\u002Fcode\u003E (умножение-сложение) имеет вариант со сменой знака \u003Ccode\u003Enmadd\u003C\u002Fcode\u003E, который должен, теоретически, иметь противоположный \u003Ccode\u003Emadd\u003C\u002Fcode\u003E знак. Однако различные архитектуры ЦП могут применять смену знака в разные моменты вычислений, что изменяет результат. Команды \u003Ccode\u003Enmadd\u003C\u002Fcode\u003E и \u003Ccode\u003Enmsub\u003C\u002Fcode\u003E (умножение-вычитание со сменой знака) архитектуры PowerPC выполняют смену знака в конце операции уравнением \u003Ccode\u003E-(A * C ± B)\u003C\u002Fcode\u003E. Это логично, поэтому, разумеется, никакая другая архитектура не выполняет операции подобным образом.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nx86-64 в своей бесконечной мудрости \u003Cem\u003Eменяет знак результата операции умножения\u003C\u002Fem\u003E, а затем выполняет сложение или вычитание. Уравнение имеет вид \u003Ccode\u003E-(A * C) ± B\u003C\u002Fcode\u003E, то есть сильно отличается от версии PowerPC и совершенно с ней несовместимо. Однако предыдущие разработчики Dolphin нашли хитрый способ обхода этой проблемы. Для этого достаточно было просто поменять местами ADD и SUB для этих команд. Просто выполняя обратные действия, мы можем получить результаты, которые ожидает код игры для PowerPC.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНо AArch64 всё меняет. Уравнение \u003Ccode\u003Enmadd\u003C\u002Fcode\u003E для AArch64 выглядит как \u003Ccode\u003E-(A * C) - B\u003C\u002Fcode\u003E, то есть оно полностью идентично уравнению \u003Ccode\u003Enmsub\u003C\u002Fcode\u003E на x86-64! То, что команда \u003Cem\u003Eсложения\u003C\u002Fem\u003E на самом деле \u003Cem\u003Eвычитает\u003C\u002Fem\u003E — это, конечно, любопытное решение со стороны ARM, но благодаря нему нам не нужно выполнять трюк с заменой SUB, потому что AArch64 уже сделала его за нас, позволив сопоставить \u003Ccode\u003Enmadd\u003C\u002Fcode\u003E PowerPC напрямую с AArch64, несмотря на очень разные уравнения. Что ещё более странно, уравнение \u003Ccode\u003Enmsub\u003C\u002Fcode\u003E на AArch64 выглядит как \u003Ccode\u003E(A * C) - B\u003C\u002Fcode\u003E, то есть \u003Cem\u003Eсмена знака в нём вообще не происходит\u003C\u002Fem\u003E. Однако по какой-то причине знак меняется в \u003Ccode\u003Emsub\u003C\u002Fcode\u003E AArch64, поэтому мы использовали её. Мы уже научились не задавать лишних вопросов.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЭти трюки очень продуманы и они оказались очень точными. Однако, как доказала игра \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Inazuma_Eleven_GO:_Strikers_2013\" rel=\"nofollow noopener noreferrer\"\u003EInazuma Eleven GO: Strikers 2013\u003C\u002Fa\u003E, они были неидеальными. Пользователь \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fbooto\" rel=\"nofollow noopener noreferrer\"\u003Ebooto\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E обнаружил, что из-за различий в порядке смены знака в уравнениях, этот способ не срабатывает, когда все входные данные равны нулю — \u003Ccode\u003Enmsub\u003C\u002Fcode\u003E PowerPC даёт -0, а \u003Ccode\u003Enmadd\u003C\u002Fcode\u003E x86 и \u003Ccode\u003Emsub\u003C\u002Fcode\u003E AArch64 дают +0. Ой-ёй. Мы не знаем, почему конкретно \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Inazuma_Eleven_GO:_Strikers_2013\" rel=\"nofollow noopener noreferrer\"\u003EInazuma\u003C\u002Fa\u003E использует это необычное поведение, но это баг, вызывавший рассинхронизацию при совместном подключении к Wi-Fi Connection эмулятора Dolphin и консолей Wii.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Finazuma-thewall.jpg\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F783\u002Fd0a\u002F1d5\u002F783d0a1d5f1d50309e051af405299988.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F783\u002Fd0a\u002F1d5\u002F783d0a1d5f1d50309e051af405299988.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nХотя мы устранили эту проблему в \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Inazuma_Eleven_GO:_Strikers_2013\" rel=\"nofollow noopener noreferrer\"\u003EInazuma\u003C\u002Fa\u003E, дальнейшие исследования выявили другие возможные проблемы. Описанные выше трюки дают одинаковые результаты на консоли, какие бы данные она ни обрабатывала… но только когда они выполняются обычной математикой. На реальном оборудовании эти уравнения выполняются при помощи \u003Ca href=\"https:\u002F\u002Fwww.youtube.com\u002Fwatch?v=PZRI1IfStY0\" rel=\"nofollow noopener noreferrer\"\u003Eматематики с плавающей запятой\u003C\u002Fa\u003E, поэтому снова всплывают давно известные нам \u003Cem\u003Eпогрешности округления операций с плавающей запятой\u003C\u002Fem\u003E. При смене знака на разных этапах вычисления уравнений, расчёты с плавающей запятой округлялись не так, как в процессорах PowerPC. Обычно это было допустимо, но в пограничных случаях округления, например, при округлении в сторону бесконечности, различия в округлении оказывались достаточно серьёзными, чтобы создать другой результат с плавающей запятой. Не знаю, возникала ли уже в каком-то ПО эта проблема, но по возможности стоит устранять подобные баги.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧтобы устранить все эти странности, мы теперь просто пользуемся стандартными командами \u003Ccode\u003Emadd\u003C\u002Fcode\u003E и \u003Ccode\u003Emsub\u003C\u002Fcode\u003E (и \u003Ccode\u003Enmsub\u003C\u002Fcode\u003E на AArch64), после чего самостоятельно меняем их знак отдельными командами смены знака. Это простое изменение разрешает все проблемы пограничных случаев и позволяет эмулятору Dolphin играть против реальных Wii в \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Inazuma_Eleven_GO:_Strikers_2013\" rel=\"nofollow noopener noreferrer\"\u003EInazuma Eleven GO: Strikers 2013\u003C\u002Fa\u003E! Хотя из-за использования двух команд вместо одной производительность снижается на чрезвычайно малую величину, мы гарантируем, что вы этого не заметите. Вероятно. Ведь не найдётся ни одной игры, которая станет настолько тупо пользоваться простыми командами смены знака FMA, чтобы это вызвало значительное снижение производительности. (Во всяком случае, мы на это надеемся.)\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nБез потрясающего сообщества игроков в Inazuma, проводившего кошмарный анализ команд со строгим ограничением невозможности \u003Ci\u003Eслишком\u003C\u002Fi\u003E большого снижения производительности, эта проблема никогда бы не была устранена. Если вы хотите попробовать сыграть в эту игру, то у неё до сих пор есть активное сообщество, проводятся турниры и существует куча руководств. Мы хотим выразить особую признательность \u003Ca href=\"https:\u002F\u002Ftwitter.com\u002Finazuma_france\" rel=\"nofollow noopener noreferrer\"\u003EInazuma France\u003C\u002Fa\u003E за помощь.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-15009\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-15009 — IOS\u002FNetworking: Make Name Resolution Asynchronous\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fsepalani\" rel=\"nofollow noopener noreferrer\"\u003Esepalani\u003C\u002Fa\u003E\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nПри тестировании онлайна для \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Inazuma_Eleven_GO:_Strikers_2013\" rel=\"nofollow noopener noreferrer\"\u003EInazuma Eleven GO: Strikers 2013\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Mario_Kart_Wii\" rel=\"nofollow noopener noreferrer\"\u003EMario Kart Wii\u003C\u002Fa\u003E и других игр с поддержкой WiFi на таких резервных серверах, как Wiimmfi, было замечено, что при первоначальном подключении возникают очень серьёзные торможения. Так как из-за проблем \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Inazuma_Eleven_GO:_Strikers_2013\" rel=\"nofollow noopener noreferrer\"\u003EInazuma Eleven\u003C\u002Fa\u003E с WiFi онлайн-функции и так тестировались, нам представился идеальный шанс протестировать модификацию разработчика \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fsepalani\" rel=\"nofollow noopener noreferrer\"\u003Esepalani\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E по асинхронному выполнению выбора доменных имён. Благодаря выполнению операции в отдельном потоке торможения при подключении к игре с поддержкой Wi-Fi полностью устранялись.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fembedd.srv.habr.com\u002Fiframe\u002F6162c0b2abb378f6450d1a13\" data-style=\"\" id=\"6162c0b2abb378f6450d1a13\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EРанее подключение было совершенно дёрганным. Видео в более высоком качестве можно посмотреть \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Finazumaasyncloading-stutter.mp4\" rel=\"nofollow noopener noreferrer\"\u003Eздесь\u003C\u002Fa\u003E.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fembedd.srv.habr.com\u002Fiframe\u002F6162c0b2122cc8f6386967f6\" data-style=\"\" id=\"6162c0b2122cc8f6386967f6\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EНо теперь оно работает точно так же, как на консоли. Видео в более высоком качестве можно посмотреть \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Finazumaasyncloading-smooth.mp4\" rel=\"nofollow noopener noreferrer\"\u003Eздесь\u003C\u002Fa\u003E.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-14810\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-14810\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-14848\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-14848\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-15105\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-15105\u003C\u002Fa\u003E — GameINI: «Heavy Iron Studios» Games Quality of Life Changes\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nНи один из разработчиков лицензионных игр для \u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FSixth_generation_of_video_game_consoles\" rel=\"nofollow noopener noreferrer\"\u003Eконсолей шестого поколения\u003C\u002Fa\u003E не оставил наследия лучше, чем \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Category:Heavy_Iron_Studios_(Developer)\" rel=\"nofollow noopener noreferrer\"\u003EHeavy Iron Studios\u003C\u002Fa\u003E. Одна из игр компании, \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003ESpongeBob Squarepants: Battle for Bikini Bottom\u003C\u002Fa\u003E — культовая классика, получившая \u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FSpongeBob_SquarePants:_Battle_for_Bikini_Bottom_%E2%80%93_Rehydrated\" rel=\"nofollow noopener noreferrer\"\u003EHD-ремейк на современных консолях\u003C\u002Fa\u003E, а среди прочих игр студии есть и \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Scooby-Doo!_Night_of_100_Frights\" rel=\"nofollow noopener noreferrer\"\u003Eкрепкие середнячки\u003C\u002Fa\u003E, и \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_SpongeBob_SquarePants_Movie\" rel=\"nofollow noopener noreferrer\"\u003Eдовольно неплохие проекты\u003C\u002Fa\u003E. В целом, это были увлекательные игры, правильно использовавшие франшизы и сочетающие в себе интересный геймплей с любимыми персонажами.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТак как эти лицензионные игры имеют довольно большую базу фанатов, пользователи хотели играть в них на Dolphin со всеми теми преимуществами, которые даёт эмуляция. К сожалению, возникли ограничения. Dolphin мог корректно эмулировать эти игры… но самые продвинутые его возможности работали не очень хорошо. При повышении внутреннего разрешения игры возникали серьёзные проблемы с графикой, поэтому игрокам приходилось пользоваться нативным разрешением. Но это не какой-то баг Dolphin! Большинство игр \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Category:Heavy_Iron_Studios_(Developer)\" rel=\"nofollow noopener noreferrer\"\u003EHeavy Iron Studios\u003C\u002Fa\u003E разрабатывалось таким образом, что \u003Cem\u003Eв них нельзя было играть в повышенном разрешении\u003C\u002Fem\u003E из-за использованных при рендеринге трюках (по крайней мере, чтобы решить эту проблему, пользователи и разработчиков эмуляторов должны были придумывать хитрости).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fembedd.srv.habr.com\u002Fiframe\u002F6162c0b21370783b8bf93085\" data-style=\"\" id=\"6162c0b21370783b8bf93085\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EПри нативном внутреннем разрешении 1x игра Battle For Bikini Bottom работала нормально...\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fembedd.srv.habr.com\u002Fiframe\u002F6162c0b3cd09f7f6552eb389\" data-style=\"\" id=\"6162c0b3cd09f7f6552eb389\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EНо при более высоких внутренних разрешениях возникали серьёзные визуальные ошибки\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИстоки этой проблемы можно отследить в первой игре, выпущенной \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Category:Heavy_Iron_Studios_(Developer)\" rel=\"nofollow noopener noreferrer\"\u003EHeavy Iron Studios\u003C\u002Fa\u003E для GameCube — \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Scooby-Doo!_Night_of_100_Frights\" rel=\"nofollow noopener noreferrer\"\u003EScooby Doo: Night of 100 Frights\u003C\u002Fa\u003E. В ней используются те же техники, что и в \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003EBattle for Bikini Bottom\u003C\u002Fa\u003E, но с одним важным отличием. Эта игра неправильно задаёт матрицу проекции; она настроена на вывод размером 639 на 479 вместо истинного разрешения 640 на 480. Поэтому когда игра копирует из памяти фрагмент буфера кадров размером 256x256, при копировании обратно он пропускается через неправильную матрицу проекции и оказывается слегка деформированным до размера фрагмента 256.401 на 256.534. Проще всего представить этот баг, сравнив его с редактированием фотографии. Представьте, что вы скопировали часть изображения, \u003Ci\u003Eнезначительно\u003C\u002Fi\u003E уменьшили масштаб всего остального изображения, но при копировании фрагмента обратно вы не изменили его масштаб, а потом отмасштабировали полное изображение до исходного размера. Аналогия неидеальна, но, по крайней мере, может дать вам представление о том, какие визуальные проблемы это может вызвать. Но дело в том, что нативное разрешение GameCube настолько мало, что такие незначительные отклонения не приводили к заметным проблемам. Баг может проявляться визуально только из-за того, что Dolphin позволяет использовать повышенное внутреннее разрешение.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fscoobs-vertexroundingoff.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F181\u002F463\u002F727\u002F1814637276bf9b45d4b803f385739011.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EПри увеличенных разрешениях возникает незначительный излом в пикселях верхнего левого квадранта...\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fscoobs-vertexroundingon.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F9ad\u002F35d\u002F60b\u002F9ad35d60be3a1bff4e2dba406b4df69b.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EОднако функция округления вершин (Vertex Rounding) полностью его устраняет.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКо времени выпуска \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003ESpongeBob Squarepants: Battle for Bikini Bottom\u003C\u002Fa\u003E компания \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Category:Heavy_Iron_Studios_(Developer)\" rel=\"nofollow noopener noreferrer\"\u003EHeavy Iron Studios\u003C\u002Fa\u003E заметила этот баг и скорректировала поведение. Она не только исправила матрицу проекции, сменив размер на 640x480, но и добавила горизонтальное и вертикальное смещение на 1\u002F512 (полпикселя) к позиции и координатам текстур. Благодаря этому всё \u003Cem\u003Eдействительно\u003C\u002Fem\u003E выравнивается при повышенных внутренних разрешениях, однако теперь размер текстуры составляет 513\u002F512, а не 1.0. Это означает, что копирование EFB захватывает части самого края экрана. Если мы разобьём на части процесс рендеринга изображения, то увидим, как повышенные разрешения ломают картинку.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fshadowrenderingnative.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F86d\u002F5f4\u002Faba\u002F86d5f4aba6107ff010df3669e6c1f6d8.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F86d\u002F5f4\u002Faba\u002F86d5f4aba6107ff010df3669e6c1f6d8.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EЭто скриншот того, как выглядит игра примерно на середине процесса рендеринга кадра. Мы видим, что тень ещё не наложена.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fshadowrenderingnative.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F5e9\u002F813\u002Fcef\u002F5e9813cef22ced7dbcc47785b6c91ee6.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EПри нативном разрешении всё очищается на краю экрана.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fshadowrendering3x.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F724\u002Fc97\u002F03e\u002F724c9703e8cf4523703b26551382232e.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EПри повышенных разрешениях смещения могут вызывать визуальные проблемы.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПользователи, заметившие эту проблему, прозвали её проблемой «синего бокса», потому что чаще всего она дублировала части скайбокса. Хотя Vertex Rounding может \u003Cem\u003Eисправить\u003C\u002Fem\u003E координаты позиций, починив таким образом рендеринг теней, он делает ещё более заметным то, что данные берутся с самого края экрана, потому что координаты текстур по-прежнему смещены.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fspongebobold-vertexroundingoff.jpg\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fe43\u002F7a2\u002F621\u002Fe437a2621879baf14a21cd7e683227a6.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fe43\u002F7a2\u002F621\u002Fe437a2621879baf14a21cd7e683227a6.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EБез Vertex Rounding тени вполне ожидаемо поломаны, а в левом верхнем углу иногда появляется синий бокс.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fspongebobold-vertexroundingon.jpg\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F362\u002F8ae\u002Fb8b\u002F3628aeb8b3eaacc234a19f84303b4650.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F362\u002F8ae\u002Fb8b\u002F3628aeb8b3eaacc234a19f84303b4650.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EVertex Rounding исправил тени, но проблема с синим боксом стала гораздо более заметной.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИз-за смещения текстур Dolphin никак не мог улучшить рендеринг, если только не применять исключительно неудобные хаки для каждой конкретной игры. Поэтому пользователи решили выбрать другой путь — манипулировать самой игрой, а не пытаться подстроить эмулятор под неё. Для этого они выбрали код \u003Cem\u003EAction Replay\u003C\u002Fem\u003E, позволявший им модифицировать игру непосредственно в памяти. Несколько лет назад люди в отчёте \u003Ca href=\"https:\u002F\u002Fbugs.dolphin-emu.org\u002Fissues\u002F9649\" rel=\"nofollow noopener noreferrer\"\u003Eоб этой самой проблеме\u003C\u002Fa\u003E обсуждали идею использования для улучшения ситуации кодов action replay. Они даже опубликовали коды, частично разъяснившие ситуацию, а \u003Ca href=\"https:\u002F\u002Fbugs.dolphin-emu.org\u002Fusers\u002F6405\" rel=\"nofollow noopener noreferrer\"\u003EDisorderly\u003C\u002Fa\u003E запостил конкретный адрес, который должен оказаться в catalyst для исправления этой игры.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nК сожалению, эти решения слишком опередили своё время. Тогда в Dolphin ещё не было хака Vertex Rounding, к тому же в нём присутствовали погрешности округления, из-за которых игра могла некорректно рендериться даже в нативном разрешении. Так как пользователям приходилось одновременно справляться с несколькими проблемами, коды становились чрезмерно сложными и имели множество недостатков. Из-за этого почти никто не понял \u003Cem\u003Eнасколько близко\u003C\u002Fem\u003E они были тогда к решению.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТакая ситуация сохранялась до этого года, когда разработчикам стало известно решение, позволяющее устранить проблемы с рендерингом игры без багов графики при помощи кода Action Replay из одной строки, появившегося на \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003Eвики-странице Battle for Bikini Bottom эмулятора Dolphin\u003C\u002Fa\u003E. Оставалось всего лишь собрать всё вместе. Накопившиеся за годы исправления во внутреннем округлении Dolphin, хак Vertex Rounding и этот код Action Replay наконец-то заставили игру красиво рендериться при высоких разрешениях.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fembedd.srv.habr.com\u002Fiframe\u002F6164162c4615593b75e2468f\" data-style=\"\" id=\"6164162c4615593b75e2468f\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EБлагодаря этим хитростям Bikini Bottom отлично работает с любым внутренним разрешением!\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОднако для этого игрокам приходилось находить код в \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Main_Page\" rel=\"nofollow noopener noreferrer\"\u003Eвики\u003C\u002Fa\u003E, вводить его в INI эмулятора Dolphin или в меню action replay, включать читы и хак Vertex Rounding, не имея при этом никаких инструкций. Проверив код самостоятельно, \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJMC47\" rel=\"nofollow noopener noreferrer\"\u003EJMC47\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E захотел облегчить жизнь пользователей. Однако вопрос заключался в том, можно ли упростить доступ к повышенному разрешению, не мешая тем, кто хочет наслаждаться игрой в нативном разрешении и без хаков.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПри нативном разрешении Vertex Rounding автоматически отключается, поэтому это без проблем можно сделать настройкой по умолчанию. Хотя мы не могли включить по умолчанию код Action Replay, потому что он представляет собой просто запись значения в память, его легко преобразовать в патч для игры. Единственное, в чём нам нужно было убедиться — что этот патч не вызывает проблем в нативном разрешении. Для этого \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E проанализировал влияние патча при помощи инструмента FifoAnalyzer эмулятора Dolphin. В конечном итоге патч был признан безвредным и преобразован из кода Action Replay в патч игры, который можно автоматически применять при её запуске.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРади полноты решения \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJMC47\" rel=\"nofollow noopener noreferrer\"\u003EJMC47\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E \u003Cem\u003Eтакже\u003C\u002Fem\u003E модифицировал патч так, чтобы он работал с PAL-версией игры, чтобы вне зависимости от запущенной версии пользователи могли играть в последних тестовых сборках с повышенным разрешением!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЭто \u003Cem\u003Eмогло бы\u003C\u002Fem\u003E стать концом истории, но все пользователи ощущали какую-то горечь. Пусть \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003ESpongeBob SquarePants: Battle for Bikini Bottom\u003C\u002Fa\u003E и является самой популярной игрой \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Category:Heavy_Iron_Studios_(Developer)\" rel=\"nofollow noopener noreferrer\"\u003EHeavy Iron Studios\u003C\u002Fa\u003E, и её исправление порадовало большинство игроков, другие игры компании всё равно оставались сломанными. Действительно ли эти игры менее важны из-за того, что в них хочет играть меньше людей?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНо был и ещё более важный аспект. Так как эти игры были менее популярны, чем \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003EBattle for Bikini Bottom\u003C\u002Fa\u003E, для них не существовало кода, способного решить проблему со смещениями. Или, по крайней мере, так мы думали. Как ни удивительно, но ещё одна из игр, \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_SpongeBob_SquarePants_Movie\" rel=\"nofollow noopener noreferrer\"\u003EThe SpongeBob SquarePants Movie\u003C\u002Fa\u003E тоже имела в вики код, помогающий с повышенными разрешениями! Решив, что это не будет большой проблемой, \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJMC47\" rel=\"nofollow noopener noreferrer\"\u003EJMC47\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E решил портировать в патч и этот код. Однако, кое-что мы упустили.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fspongebobmovienoshadow.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F43e\u002F0a6\u002F846\u002F43e0a6846d82e217c7597a28eb419866.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F43e\u002F0a6\u002F846\u002F43e0a6846d82e217c7597a28eb419866.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EИмевшийся код для The SpongeBob SquarePants Movie удалял большинство эффектов затенения.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКод для \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_SpongeBob_SquarePants_Movie\" rel=\"nofollow noopener noreferrer\"\u003EThe SpongeBob SquarePants Movie\u003C\u002Fa\u003E не удалял смещение из исполняемого файла, а полностью исключал из рендеринга проблемные копии EFB! Хоть это и устраняло артефакты, при этом терялось и множество спецэффектов игры. Это решение нельзя было использовать как рабочий патч для игры, включенный по умолчанию. Однако эти игры казались настолько похожими, что \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJMC47\" rel=\"nofollow noopener noreferrer\"\u003EJMC47\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E верил в возможность правильного патча. Чтобы создать его, он ещё раз заручился помощью \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E, чтобы изучить рендеринг игры с кодом action replay и без него. Вместе они убедились в том, что этот код был тупиковым путём для устранения источника проблемы. Однако в процессе этого исследования \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E сообщил, что код для \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003EBattle for Bikini Bottom\u003C\u002Fa\u003E скорее всего более детализирован не из-за популярности игры, а потому, что на её диске содержались \u003Cem\u003Eотладочные символы\u003C\u002Fem\u003E в виде неурезанного исполняемого файла ELF. \u003Cem\u003EОтладочные символы\u003C\u002Fem\u003E чрезвычайно полезны для реверс-инжиниринга, поскольку они разбивают программу на функции и назначают им названия непосредственно в коде. Это сильно упрощает понимание их работы.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРазработчики оставили \u003Cem\u003Eотладочные символы\u003C\u002Fem\u003E в предыдущей игре, но могли ли они оставить их снова в сиквеле...?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Funstrippedelf.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F78c\u002F759\u002Fde5\u002F78c759de5222db2eafca3be5a3dac47d.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EДжекпот!\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОказалось, что на дисках \u003Cstrong\u003Eвсех игр \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Category:Heavy_Iron_Studios_(Developer)\" rel=\"nofollow noopener noreferrer\"\u003EHeavy Iron Studios\u003C\u002Fa\u003E той эпохи присутствовал неурезанный файл ELF\u003C\u002Fstrong\u003E. Благодаря этому мучительный проект по реверс-инжинирингу превратился в задачу, с которой при достаточном количестве времени и труда справится даже новичок. Благодаря руководству \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E пользователь \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJMC47\" rel=\"nofollow noopener noreferrer\"\u003EJMC47\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E научился работать с инструментом для реверс-инжиниринга \u003Ca href=\"https:\u002F\u002Fghidra-sre.org\u002F\" rel=\"nofollow noopener noreferrer\"\u003EGhidra\u003C\u002Fa\u003E, а также с плагинами, разработанными специально для анализа исполняемых файлов GameCube и Wii. Процесс был медленным, но помощь \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E позволила с ним справиться. На этот раз смещение было не таким, как в \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003EBattle for Bikini Bottom\u003C\u002Fa\u003E; копирование EFB теперь выполнялось в половинном разрешении, но во всём остальном процесс рендеринга не отличался от предыдущей игры. \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E смог определить значение, находившееся в памяти, после чего \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJMC47\" rel=\"nofollow noopener noreferrer\"\u003EJMC47\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E начал патчить каждое вхождение числа с плавающей запятой, пока не нашёл адрес памяти, исправлявший рендеринг. Сделав это, он создал новый \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=FifoPlayer\" rel=\"nofollow noopener noreferrer\"\u003EFifolog\u003C\u002Fa\u003E для \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E, чтобы тот убедился в работе патча и портировал код на другие регионы игры.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fspongebobmovieimproved.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F239\u002F915\u002F2c1\u002F2399152c11c6651845023c98f970dc9d.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F239\u002F915\u002F2c1\u002F2399152c11c6651845023c98f970dc9d.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EДаже Патрик удивлён тому, что все баги пропали\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n… Но и на этом история не заканчивается. \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003ESpongeBob Squarepants: Battle for Bikini Bottom\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_SpongeBob_SquarePants_Movie\" rel=\"nofollow noopener noreferrer\"\u003EThe SpongeBob SquarePants Movie\u003C\u002Fa\u003E были самыми популярными играми с этой проблемой, но \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Category:Heavy_Iron_Studios_(Developer)\" rel=\"nofollow noopener noreferrer\"\u003EHeavy Iron Studios\u003C\u002Fa\u003E использовала ту же технику в большинстве своих игр. Благодаря работе над \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_SpongeBob_SquarePants_Movie\" rel=\"nofollow noopener noreferrer\"\u003EThe SpongeBob SquarePants Movie\u003C\u002Fa\u003E \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJMC47\" rel=\"nofollow noopener noreferrer\"\u003EJMC47\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E знал точную последовательность действий для поиска смещённых копий EFB и устранению проблемы. Хотя больше ни одна игра компании для GameCube не была и близко столь же популярна, только лень могла помешать заставить патч работать для \u003Cem\u003Eвсех игр, в которых известна эта проблема\u003C\u002Fem\u003E. На этот раз кодов, которые можно взять за основу, не было, но на теперь они уже и не требовались.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЗа следующие несколько недель он собрал все известные игры и версии с этой проблемой, проверил их и разработал патчи для каждой. Поэтому теперь игры наподобие \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Incredibles\" rel=\"nofollow noopener noreferrer\"\u003EThe Incredibles\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Incredibles:_Rise_of_the_Underminer\" rel=\"nofollow noopener noreferrer\"\u003EThe Incredibles: Rise of the Underminer\u003C\u002Fa\u003E и даже различные сборки \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=2_Games_in_1:_Nickelodeon_SpongeBob_Schwammkopf:_Der_Film_%2B_Nickelodeon_SpongeBob_Schwammkopf:_Schlacht_um_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003E2 in 1 SpongeBob\u002FIncredibles\u003C\u002Fa\u003E имели патчи, обеспечивавшие правильную работу в высоких разрешениях.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fincredibles-vertexroundingoff.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Ff67\u002F7ff\u002F1db\u002Ff677ff1db493a0aac20e3c938a035c32.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Ff67\u002F7ff\u002F1db\u002Ff677ff1db493a0aac20e3c938a035c32.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EИз-за сломанных теней игру приходилось запускать в нативном разрешении.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fincredibles-vertexroundingon.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fc0c\u002Fcf4\u002Fda8\u002Fc0ccf4da814778205c4d5f2d1eb6b100.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fc0c\u002Fcf4\u002Fda8\u002Fc0ccf4da814778205c4d5f2d1eb6b100.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EНо теперь можно играть почти в любую из старых игр Heavy Iron Studios с повышенным разрешением!\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИ теперь все эти игры работают в повышенном разрешении, но не благодаря каким-то улучшениям в эмуляции, а из-за модификации игры, позволяющей удобнее выполнять рендеринг. Хотя \u003Cem\u003Eобычно\u003C\u002Fem\u003E Dolphin по умолчанию не использует включенные патчи или улучшения, мы понимаем, что многие наши пользователи рады возможности запуска игр в высоком разрешении. В данном случае мы не можем особо улучшить эмуляцию игры, но изменив саму игру, мы улучшили рендеринг в высоких разрешениях. И стоит помнить о том, что включение патчей \u003Cem\u003Eне ухудшает\u003C\u002Fem\u003E рендеринг игры в нативном разрешении. Поэтому в последних тестовых сборках мы по умолчанию включили и эти патчи, \u003Cem\u003Eи\u003C\u002Fem\u003E Vertex Rounding.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТакже в последних тестовых сборках мы по умолчанию \u003Cem\u003Eотключили Dual Core\u003C\u002Fem\u003E для этих игр после того, как \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJoeyBallentine\" rel=\"nofollow noopener noreferrer\"\u003EJoeyBallentine\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E и сообщество спидраннеров \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=SpongeBob_SquarePants:_Battle_for_Bikini_Bottom\" rel=\"nofollow noopener noreferrer\"\u003ESpongeBob Squarepants: Battle for Bikini Bottom\u003C\u002Fa\u003E сообщили нам о проблемах со стабильностью игры. Так как эти игры нетребовательны и им не нужны многие вычислительно затратные функции, это не должно стать проблемой для большинства десктопов и мощных устройствах Android. Но если вас устраивают возникающие время от времени сбои, то вы можете снова включить Dual Core для неё на странице свойств игры.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ течение нескольких лет мы знали, что многие игроки разочарованы количеством проблем Dolphin с играми \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Category:Heavy_Iron_Studios_(Developer)\" rel=\"nofollow noopener noreferrer\"\u003EHeavy Iron Studios\u003C\u002Fa\u003E. Теперь у них появился отличный шанс пройти эти классические игры заново. Мы думаем, им понравится то, что они увидят.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-14812\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-14812 — Convert NaN to 1 When Generating Texture Coordinates\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nКогда ни донимают его просьбами о помощи в реверс-инжиниринге других игр, \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E углубляется в исследование самых странных графических багов, возникающих в Dolphin. Его внимание привлекла одна проблема в issue tracker, потому что не было никаких зацепок для её решения. \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Shadow_the_Hedgehog\" rel=\"nofollow noopener noreferrer\"\u003EShadow the Hedgehog\u003C\u002Fa\u003E — игра, любимая абсолютно всеми фанатами Соника, имела проблемы с рендерингом век глаз персонажей, особенно в некоторых катсценах. К счастью, тестер сохранил \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=FifoPlayer\" rel=\"nofollow noopener noreferrer\"\u003EFifolog\u003C\u002Fa\u003E этого бага, поэтому \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E проанализировал Fifolog и выяснил, что веки имеют координату текстур \u003Cstrong\u003ENaN\u003C\u002Fstrong\u003E (Not a Number). Так как это казалось ужасной ошибкой, он решил воспроизвести Fifolog при помощи Hardware Fifoplayer, и нашёл нечто очень любопытное.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fshadoweyes-broken.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fad3\u002Ffa3\u002F472\u002Fad3fa3472b0ab17e0ca67ee019732b0d.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EВот как рендерится Fifolog в Dolphin.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fshadoweyes-console.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fcd8\u002Fa94\u002Fb26\u002Fcd8a94b26754d577992fb784ea5ee3a3.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fcd8\u002Fa94\u002Fb26\u002Fcd8a94b26754d577992fb784ea5ee3a3.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EНо на консоли Fifolog рендерится корректно, то есть на ней существует какая-то специальная обработка NaN!\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПоходило на то, что реальное «железо» каким-то образом автоматически исправляет NaN. \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FPokechu22\" rel=\"nofollow noopener noreferrer\"\u003EPokechu22\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E продолжил разбираться с проблемой на консоли, в конечном итоге поняв, что консоль интерпретирует координаты текстур NaN как «1» или \"-1\". После \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fdolphin-emu\u002Fdolphin\u002Fpull\u002F9928#issuecomment-893043811\" rel=\"nofollow noopener noreferrer\"\u003Eтщательного анализа\u003C\u002Fa\u003E значений он добавил в эмуляцию графики Dolphin условие преобразования NaN в 1, чтобы временно решить эту проблему.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fshadoweyes-fixed.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fd46\u002F373\u002Fc24\u002Fd46373c242f736eb1d0dc511b01fdbbe.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EС этой дополнительной обработкой веки выглядят гораздо ближе к тому, что мы видим на консоли.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Shadow_the_Hedgehog\" rel=\"nofollow noopener noreferrer\"\u003EShadow the Hedgehog\u003C\u002Fa\u003E по-прежнему остались кое-какие странности с рендерингом век, но на данный момент ситуация сильно улучшилась. К сожалению, если вы используете Ubershaders D3D11 или D3D12, то точно эмулировать это поведение не удастся. D3D11\u002F12 автоматически оптимизирует попытки Dolphin использовать isnan для проверки наличия значений NaN в шейдерах, как бы мы ни пытались сказать им, что нам \u003Cem\u003Eдействительно\u003C\u002Fem\u003E нужно знать, NaN или нет. Из-за этого пока глаза в D3D11\u002F12 при использовании Ubershaders остаются сломанными.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-14829\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-14829 — PowerPC: Implement Broken Masking Behavior on Uncached Writes\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJosJuice\" rel=\"nofollow noopener noreferrer\"\u003EJosJuice\u003C\u002Fa\u003E при поддержке \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Feigenform\" rel=\"nofollow noopener noreferrer\"\u003Eeigenform\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fdelroth\" rel=\"nofollow noopener noreferrer\"\u003Edelroth\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fphire\" rel=\"nofollow noopener noreferrer\"\u003Ephire\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fmarcan\" rel=\"nofollow noopener noreferrer\"\u003Emarcan\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fsegher\" rel=\"nofollow noopener noreferrer\"\u003Esegher\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FExtrems\" rel=\"nofollow noopener noreferrer\"\u003EExtrems\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fwww.youtube.com\u002Fchannel\u002FUCWYUUzuybieMseJy3KyCA7g\" rel=\"nofollow noopener noreferrer\"\u003ERylie\u003C\u002Fa\u003E\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nСложно найти более крупную группу знаменитых разработчиков эмуляторов и реверс-инженеров GameCube\u002FWii, работающих над одним изменением. Собрал их вместе не какой-то серьёзный баг в Dolphin и не проблема, касающаяся многих сотен игр. Их собрал вместе странный аппаратный баг, попытки протестировать его и в конечном итоге сэмулировать. На самом деле, этот аппаратный баг был известен довольно давно, но его игнорировали, потому что ни в одной коммерческой игре он не использовался… до недавнего времени.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНам уже было хорошо известно, что игры серии Zelda для N64 были невероятно поломанными. Благодаря выполнению произвольного кода (Arbitrary Code Execution, ACE) игроки в буквальном смысле записывали какой-нибудь код в память и заставляли исполнять его, чтобы перейти сразу к финальным титрам игры. Благодаря этому время спидранов версии \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Ocarina_of_Time\" rel=\"nofollow noopener noreferrer\"\u003EOcarina of Time\u003C\u002Fa\u003E для N64 стало \u003Cem\u003Eменьше десяти минут\u003C\u002Fem\u003E. К сожалению, пока ACE было невозможно на версиях \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Ocarina_of_Time\" rel=\"nofollow noopener noreferrer\"\u003EOcarina of Time\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Majora%27s_Mask\" rel=\"nofollow noopener noreferrer\"\u003EMajora's Mask\u003C\u002Fa\u003E для Virtual Console, из-за чего игроки были вынуждены искать альтернативы и новые идеи.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОдно из удивительных открытий, изначально сделанное \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FMrCheeze\" rel=\"nofollow noopener noreferrer\"\u003EMrCheeze\u003C\u002Fa\u003E, называется \u003Cstrong\u003ELightNode SRM\u003C\u002Fstrong\u003E. Это более мощный способ манипуляций с устаревшими ссылками (Stale Reference Manipulation) (в мире программных уязвимостей более известный как Use-After-Free или UAF), который работает \u003Cem\u003Eлучше\u003C\u002Fem\u003E в версиях для Virtual Console, и выполняется довольно быстро. Он работает и в \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Ocarina_of_Time\" rel=\"nofollow noopener noreferrer\"\u003EOcarina of Time\u003C\u002Fa\u003E и в \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Majora%27s_Mask\" rel=\"nofollow noopener noreferrer\"\u003EMajora's Mask\u003C\u002Fa\u003E, и сегодня используется для самого быстрого прохождения \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Ocarina_of_Time\" rel=\"nofollow noopener noreferrer\"\u003EOoT\u003C\u002Fa\u003E в категории Any%! \u003Ci\u003E[Прим. пер.: в этой категории игроки стремятся как можно быстрее добраться до финальной катсцены\u002Fтитров игнорируя прохождение сюжета, выполнение квестов и собирание предметов.]\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fembedd.srv.habr.com\u002Fiframe\u002F6165666b6a73daf6662a1ba6\" data-style=\"\" id=\"6165666b6a73daf6662a1ba6\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EРабота нового бага на консоли.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧто же такое LightNode SRM и почему оно работает лучше с версиями этих игр для Virtual Console? Давайте рассмотрим сам баг. Важнейший компонент срабатывания бага заключается в том, чтобы найти способ заставить Линка нести «актора» (игровую сущность), который уже был выгружен. Один из простейших способов добиться этого — сменить комнату в состоянии задержки захвата параллельно с использованием классического приёма \u003Ca href=\"https:\u002F\u002Fwww.zeldaspeedruns.com\u002Foot\u002Ftech\u002Fsuperslide\" rel=\"nofollow noopener noreferrer\"\u003Esuperslide\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКак только Линк начинает нести \u003Cem\u003Eничего\u003C\u002Fem\u003E, начинается самое веселье. На самом деле он записывает три слова и два полуслова в части памяти, которые принадлежали актору, но теперь используются для других данных. Даже если вы выполните этот глитч для большинства акторов, то всё равно будете ограничены возможностью перезаписи только частей кучи актора, которые содержат такие элементы, как данные о врагах и предметах. Это достаточно полезная возможность, но если найти способ выбраться за пределы кучи актора, то откроется огромный потенциал для взлома. Именно здесь вступает в дело LightNode SRM!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nLightNode SRM названо так, потому что использует освещение в игре. Игра обрабатывает загружаемые\u002Fвыгружаемые источники динамического освещения при помощи \u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FDoubly_linked_list\" rel=\"nofollow noopener noreferrer\"\u003Eдвунаправленного списка\u003C\u002Fa\u003E всех загруженных на текущий момент источников. Одним из примеров таких источников являются разбросанные по всей игре факелы.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002FLNSRM_Angle3.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Ff0d\u002F4c5\u002F5f4\u002Ff0d4c55f4b886aa172f334bd821627ed.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Ff0d\u002F4c5\u002F5f4\u002Ff0d4c55f4b886aa172f334bd821627ed.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EВо время LightNode SRM огонь «схваченного» игроком LightNode отсутствует!\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВажно здесь то, что при каждой выгрузке актора с источником динамического освещения, соответствующий ему LightNode удаляется из связанного списка:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Enode-\u003Eprev-\u003Enext = node-\u003Enext;\nnode-\u003Enext-\u003Eprev = node-\u003Eprev;\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nУказатель на узел источника (\u003Ccode\u003Enode\u003C\u002Fcode\u003E в этом фрагменте кода) хранится в данных экземпляра актора, поэтому его можно переписать выполнением SRM и изменить так, чтобы он указывал на управляемую спидраннерами область памяти. Это означает, что \u003Ccode\u003Enode-\u003Eprev\u003C\u002Fcode\u003E и \u003Ccode\u003Enode-\u003Enext\u003C\u002Fcode\u003E могут быть чем угодно и указывать на всё, что захочет модифицировать спидраннер, даже за пределами кучи актора!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПо сути, это даёт спидраннерам возможность выполнять в обеих играх произвольные записи в ОЗУ! Так как манипулирование узлом \u003Ccode\u003Enode\u003C\u002Fcode\u003E выполняется указанием на координаты респауна Линка, адрес записи и записываемое значение в конечном итоге управляются позицией Линка. На оборудовании Nintendo 64 предоставляемые этим трюком возможности чуть более ограничены, чем на консолях с PowerPC из-за особенностей поведения ЦП в некоторых ключевых ситуациях. В \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Ocarina_of_Time\" rel=\"nofollow noopener noreferrer\"\u003EOcarina of Time\u003C\u002Fa\u003E это в конечном итоге было не так важно, потому что имя файла было выровнено и находилось достаточно близко к доступу из связанного списка. Заставив указатель LightNode считать имя файла, вы можете записать в название файла полезную нагрузку.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Majora%27s_Mask\" rel=\"nofollow noopener noreferrer\"\u003EMajora's Mask\u003C\u002Fa\u003E всё устроено немного иначе — из-за использования \u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FNintendo_64_accessories#Expansion_Pak\" rel=\"nofollow noopener noreferrer\"\u003EN64 Expansion RAM\u003C\u002Fa\u003E имя файла находится слишком далеко в памяти, поэтому использовать его чуть сложнее. Здесь ещё большую важность приобретает способность GameCube\u002FWii выполнения невыровненных операций записи. Она даёт игрокам гораздо больший контроль над тем, какие значения можно записывать в память, и позволяет им управлять записью в ОЗУ значений с плавающей запятой. Благодаря этому версии этих игр для GameCube и Virtual Console способны на вещи, невозможные на оборудовании N64. Так как версии для Virtual Console быстрее и стабильнее, чем эмуляторы GC N64, спидраннеры продолжили работать с ними.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПервое применение LightNode SRM дало свои плоды в \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Majora%27s_Mask\" rel=\"nofollow noopener noreferrer\"\u003EMajora's Mask\u003C\u002Fa\u003E в категории Any%; спидран не поставил мирового рекорда, но всё равно показал потенциал новой техники. Вскоре после этого LightNode SRM прославилось тем, что впервые позволило пройти меньше чем за \u003Cem\u003E7\u003C\u002Fem\u003E минут \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Ocarina_of_Time\" rel=\"nofollow noopener noreferrer\"\u003Eлюбую версию Ocarina of Time\u003C\u002Fa\u003E! Этот способ работает только на GameCube\u002FWii из-за \u003Cem\u003Eещё одного\u003C\u002Fem\u003E поведения ЦП, вызывающего явление, которое спидраннеры называют DoubleWord Write (DWW) и QuadWord Write (QWW). Мы вернёмся к нему чуть позже, потому что объяснение его довольно сложно.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nС точки зрения спидраннинга, эти техники открывали множество новых возможностей, особенно вне категории Any%. Выполнение произвольного кода — \u003Cem\u003Eнастолько мощная техника\u003C\u002Fem\u003E, что запрещено во многих категориях, чтобы не усложнять определения категорий и сохранять интересность прохождения. Если у вас получилось исполнять собственный код, то вы можете сделать что угодно. Стоит заметить, что запрет ACE \u003Cem\u003Eвключает в себя\u003C\u002Fem\u003E использование LightNode SRM для перезаписи кода, но так как его можно использовать для перезаписи данных, что совершенно законно, оно сильно повлияло на множество различных категорий.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКак и в случае с любым важным багом, игроки начали стремиться расширить его через эмуляцию. На этот раз они использовали не эмулятор N64, потому что лучше всего для спидранов подходят версии для Virtual Console Nintendo Wii. К сожалению, как понятно из представленного выше видео, Dolphin не очень хорошо подходит для этой задачи. Хотя все основные шаги работали, значения, записываемые в ОЗУ при помощи LightNode, немного различались на консоли и в Dolphin. Причина этого может быть немного неожиданной: они использовали функцию, которая \u003Cem\u003Eработала\u003C\u002Fem\u003E в Dolphin, но была поломана на консоли.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИменно так — трюк зависел от точной эмуляции \u003Cem\u003EUncached Writes\u003C\u002Fem\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Faeb\u002F91e\u002F5fe\u002Faeb91e5fe802798f9210ada7713a5873.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Faeb\u002F91e\u002F5fe\u002Faeb91e5fe802798f9210ada7713a5873.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\nНа Nintendo GameCube и Wii есть аппаратная особенность, вызывающая неправильное поведение невыровненных некэшированных операций записи. Для Dolphin это не было особой проблемой, потому что в коммерческом ПО такие операции записи не использовались. Не было никакого смысла прикладывать усилия для эмуляции «мёртвой» функции консоли. Однако давайте вспомним о той функции ЦП, которая вызывала DWW и QWW. Это были именно те самые поломанные невыровненные некэшированные операции записи! Их поломанность позволяла перезаписывать больше памяти, чем было бы возможно при правильной работе. Это и было ключом к спидрану — в показанном выше видео с переходом к титрам игры автор переписал две соседние записи входа, чтобы вызвать две разные катсцены с титрами в Termina Field!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nК сожалению, в Dolphin это не работало. Эти некэшированные операции записи вели себя \u003Cem\u003Eправильно\u003C\u002Fem\u003E, то есть сломанное дублирование не эмулировалось и вторая запись входа не записывалась. Спидраннеры \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Majora%27s_Mask\" rel=\"nofollow noopener noreferrer\"\u003EMajora's Mask\u003C\u002Fa\u003E обратились к разработчикам Dolphin с вопросом: можно ли заставить этот способ работать?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОтчёт о проблеме был отправлен, спидраннеры уже были готовы тестировать игру, а \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJosJuice\" rel=\"nofollow noopener noreferrer\"\u003EJosJuice\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E начал разрабатывать тест оборудования, чтобы разобраться, что же конкретно происходит. К сожалению, он почти сразу же зашёл в тупик. Оказалось, что попытка проверки поведения на консоли приводит к внезапному \u003Cem\u003Eсбою\u003C\u002Fem\u003E. Что ни делали тестеры, некэшированные операции записи завершались зависанием консоли. К анализу происходящего привлекли других разработчиков. Консоль не должна была зависать; мы знали это, потому что спидран показал, что, по крайней мере, это \u003Cem\u003Eдолжно\u003C\u002Fem\u003E работать. Постепенно всё больше разработчиков начинало разбираться в проблеме, и вскоре вокруг неё собрались реверс-инженеры с огромным опытом. Было протестировано множество разных подходов, одни разработчики пытались воссоздать условия игры, другие пробовали упростить тест, чтобы понять, не возникает ли ошибка в другом фрагменте теста.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНо что бы ни происходило, консоль зависала на первой некэшированной записи.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСпустя несколько дней экспериментов \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Feigenform\" rel=\"nofollow noopener noreferrer\"\u003Eeigenform\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E решил головоломку. Почти все homebrew-проекты созданы на основе homebrew-библиотеки \u003Ca href=\"https:\u002F\u002Fwiibrew.org\u002Fwiki\u002FLibogc\" rel=\"nofollow noopener noreferrer\"\u003Elibogc\u003C\u002Fa\u003E, используемой для обеспечения интерфейса с оборудованием GameCube и Wii. Она сильно упрощает написание, компилирование и тестирование homebrew-программ, предоставляя API для взаимодействия с оборудованием и имея множество примеров проектов. \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Feigenform\" rel=\"nofollow noopener noreferrer\"\u003Eeigenform\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E решил написать тест, \u003Cem\u003Eне использующий\u003C\u002Fem\u003E libogc. Хотя этот способ был гораздо более сложным, в конечном итоге он подтвердил, что проблема связана с самой libogc. К анализу были привлечены уже десятки разработчиков, поэтому потребовалась всего пара минут для выяснения того, что зависание было вызвано libogc, забывающей сбросить прерывание; из-за этого библиотека снова и снова обрабатывала одно и то же прерывание. Благодаря тестированию этот баг устранён в последних версиях libogc.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПосле того, как тесты оборудования начали работать, \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJosJuice\" rel=\"nofollow noopener noreferrer\"\u003EJosJuice\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E смог протестировать и понять, как именно некэшированные тесты работали на консоли, и реализовал их сломанное поведение в Dolphin. Мы попросили сообщество спидраннеров убедиться, что всё работает правильно, и они продемонстрировали нам безошибочное прохождение в Dolphin версии \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Majora%27s_Mask\" rel=\"nofollow noopener noreferrer\"\u003EMajora's Mask's\u003C\u002Fa\u003E для Virtual Console в категории Any%.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fembedd.srv.habr.com\u002Fiframe\u002F6166ef3cedd610f626b80cc5\" data-style=\"\" id=\"6166ef3cedd610f626b80cc5\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EПосле внесённых изменений Rylie подтвердила, что прохождение работает в Dolphin!\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nБез \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fwww.youtube.com\u002Fchannel\u002FUCWYUUzuybieMseJy3KyCA7g\" rel=\"nofollow noopener noreferrer\"\u003ERylie\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E и безумных сообществ любителей \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Ocarina_of_Time\" rel=\"nofollow noopener noreferrer\"\u003EOcarina of Time\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=The_Legend_of_Zelda:_Majora%27s_Mask\" rel=\"nofollow noopener noreferrer\"\u003EMajora's Mask\u003C\u002Fa\u003E мы могли и никогда не узнать, что некэшированная запись могла использоваться в коммерческой игре для чего-то полезного…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНа самом деле, нам известен один конкретный \u003Cem\u003Ehomebrew\u003C\u002Fem\u003E, который использовал это поведение в качестве меры защиты. Версии \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Homebrew_Channel\" rel=\"nofollow noopener noreferrer\"\u003EHomebrew Channel\u003C\u002Fa\u003E с закрытыми исходниками имели множество защит и странных поведений, использовавшихся для того, чтобы их запускали надёжным образом. Одной из функций, которые они использвоали, было \u003Cem\u003Eполоманное\u003C\u002Fem\u003E поведение некэшированных записей. Мы даже не занимались этим приложением, потому что в те времена Dolphin был настолько ненадёжен, что мы и не надеялись его запустить. Но годы улучшений изменили ситуацию, и при наличии поддержки невыровненных кэшированных операций записи версии Homebrew Channel с закрытыми исходниками наконец-то начали проявлять в Dolphin признаки жизни. На самом деле, приложение позволяло даже добраться до меню… однако с некоторыми \u003Cem\u003Eособенностями\u003C\u002Fem\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fthehbc1.jpg\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fe17\u002F60c\u002Fe41\u002Fe1760ce413ed82c2f603eebcf1858512.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EЕсли защиты в старой версии Homebrew Channel выполнялись неправильно, они не позволяли пройти уведомление о жульничестве. Однако спустя час ожидания они всё равно самостоятельно позволяли загрузить меню.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fthehbc2.jpg\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F7d7\u002Fe45\u002F6cb\u002F7d7e456cb3db7fea84d9c722085d4563.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F7d7\u002Fe45\u002F6cb\u002F7d7e456cb3db7fea84d9c722085d4563.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EОднако они демонстрировали этот дружелюбный жест.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНекоторые из наших пользователей могут задаться вопросом: как же им удавалось запускать Homebrew Channel в Dolphin. Дело в том, что последняя версия Homebrew Channel (называющаяся \u003Ca href=\"https:\u002F\u002Fhackmii.com\u002F2016\u002F11\u002Fthe-open-homebrew-channel\u002F\" rel=\"nofollow noopener noreferrer\"\u003EOpen Homebrew Channel\u003C\u002Fa\u003E) избавилась от всех защит, чтобы упростить работу Dolphin. Так как большинство злодеев, использовавших канал в своих целях, уже давно перешло на более современные консоли, защиты не добавляли ничего, кроме головной боли для разработчиков Dolphin. Тем не менее, всё равно было бы здорово победить все проверки в старых версиях Homebrew Channel и заставить их загружаться без срабатывания защитных процедур.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-14844\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-14844 — Implement Late VI Updates\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FTechjar\" rel=\"nofollow noopener noreferrer\"\u003ETechjar\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fphire\" rel=\"nofollow noopener noreferrer\"\u003Ephire\u003C\u002Fa\u003E\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nБольшая часть работы по выводу кадров в Dolphin заключается в создании оптимизаций, обеспечивающих эмулятору минимальные задержки. Хотя большинство игр упрощает работу благодаря использованию стандартной конфигурации Video Interface (VI) и позволяют \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fblog\u002F2017\u002F11\u002F19\u002Fhybridxfb\u002F#immediately-present-xfb\" rel=\"nofollow noopener noreferrer\"\u003EDolphin обходить большую часть эмуляции XFB\u003C\u002Fa\u003E, снижая задержку \u003Cem\u003Eсильнее\u003C\u002Fem\u003E, чем это возможно на консоли, многие игры применяют более сложные конфигурации VI. Это заставляет Dolphin делать всё правильно и на самом деле эмулировать процедуру считывания данных. Но даже в этом случае Dolphin \u003Cem\u003Eвсё равно\u003C\u002Fem\u003E немного жульничает, выводя копию XFB с параметрами, которые она имела в начале поля, а не применяя их на протяжении процесса вывода копии XFB. Это позволяет сэкономить примерно 16 мс задержки. Считалось, что такая техника поддерживается \u003Cem\u003Eвсеми играми\u003C\u002Fem\u003E… пока на горизонте не появилась \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=WWE_Crush_Hour\" rel=\"nofollow noopener noreferrer\"\u003EWWE Crush Hour\u003C\u002Fa\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fembedd.srv.habr.com\u002Fiframe\u002F6167cf20122cc8f638696805\" data-style=\"\" id=\"6167cf20122cc8f638696805\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EПредставьте это мерцание с частотой 60fps. Видео с полной скоростью можно посмотреть \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Fcrushhour-flashing.mp4\" rel=\"nofollow noopener noreferrer\"\u003Eздесь\u003C\u002Fa\u003E (опасно для эпилептиков).\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЭта очень странная игра обладает поведением, которое никто не встречал ни в одной коммерческой игре: она меняет параметры VI \u003Cem\u003Eво время \u003C\u002Fem\u003E вывода кадра на экран. Dolphin ничего не может с этим поделать, потому что уже закончил обработку с неправильными параметрами VI к тому времени, как игра их изменила. Спустя четыре года после некорректного анализа ZephyrSurfer повторно проанализировал эту проблему и понял, что предыдущее внедрение в \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fblog\u002F2017\u002F11\u002F19\u002Fhybridxfb\u002F\" rel=\"nofollow noopener noreferrer\"\u003EHybrid XFB\u003C\u002Fa\u003E было неверным. Этот новый анализ привёл к появлению версии \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002F7ee6d082131cf40b8a8471ff3ac967e30326f59e\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-146\u003C\u002Fa\u003E и к оптимизации задержек.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nУвидев это, \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fphire\" rel=\"nofollow noopener noreferrer\"\u003Ephire\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E рассказал всем о хаке задержки и объяснил, как обойти эту проблему. По сути, в Dolphin просто нужно было добавить опцию \u003Cem\u003Eожидания конца вывода\u003C\u002Fem\u003E для правильного вывода кадра. Это приводит к дополнительной задержке ровно в один кадр, поэтому было предложено реализовать эту функцию как отдельную опцию только для этой игры. Хотя оба разработчика были слишком заняты, оставленные ими объяснения оказались достаточно чёткими для того, чтобы \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FTechjar\" rel=\"nofollow noopener noreferrer\"\u003ETechjar\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E смог реализовать это исправление. Важно заметить, что ни одна из этих реализаций не является \u003Cem\u003Eточной\u003C\u002Fem\u003E; чтобы делать всё правильно, Dolphin должен был бы применять конфигурации VI \u003Cem\u003Eво время\u003C\u002Fem\u003E вывода, что было бы гораздо сложнее, но почти не принесло бы пользы.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-14866\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-14866 — D3D12 — Fix GPU Texture Decoding on AMD\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FK0bin\" rel=\"nofollow noopener noreferrer\"\u003EK0bin\u003C\u002Fa\u003E\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nНовый участник проекта \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FK0bin\" rel=\"nofollow noopener noreferrer\"\u003EK0bin\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E обратил внимание на отсутствующий барьер памяти в бэкенде D3D12 эмулятора Dolphin, который мог бы вызывать проблемы с декодированием текстур в GPU. Драйверов NVIDIA это не коснулось (вероятно, из-за игнорирования переходов между состояниями), но в картах AMD включение GPU Texture Decoding вызывало серьёзные проблемы и сбои. Проблему удалось решить одной строкой кода.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002F649\u002F998\u002F7a1\u002F6499987a1df749e524017236c722925e.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EЗдесь бы мог быть скриншот 6900 XT с устранённой проблемой, если бы у нас была эта карта!\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-14821\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-14821\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-14833\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-14833\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-14897\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-14897\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fdownload\u002Fdev\u002Fmaster\u002F5.0-15019\u002F\" rel=\"nofollow noopener noreferrer\"\u003E5.0-15019\u003C\u002Fa\u003E — Fix \u003Ccode\u003Edcbx\u003C\u002Fcode\u003E Invalidation Performance Without Breaking Everything This Time, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FAdmiralCurtiss\" rel=\"nofollow noopener noreferrer\"\u003EAdmiralCurtiss\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJosJuice\" rel=\"nofollow noopener noreferrer\"\u003EJosJuice\u003C\u002Fa\u003E\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nЕсли вы следили за июльскими тестовыми сборками, то могли заметить тенденции в изменениях с \u003Ccode\u003Edcbx\u003C\u002Fcode\u003E (инвалидация\u002Fсброс\u002Fобнуление кэша данных и т.п.). Наша цель заключалась в том, чтобы масштабные инвалидации были быстрыми \u003Cem\u003Eи\u003C\u002Fem\u003E корректными, но достижение обоих требований оказалось сложной задачей. В конце июльского отчёта Progress Report \u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fblog\u002F2021\u002F08\u002F01\u002Fdolphin-progress-report-june-and-july-2021\u002F#50-14768-jit-perform-bat-lookup-in-dcbfdcbidcbst-instructions-by-josjuice\" rel=\"nofollow noopener noreferrer\"\u003Eмы решили, что у нас есть простое исправление снижения производительности, касающегося различных команд сброса\u002Fинвалидации кэша данных\u003C\u002Fa\u003E. Казалось, что в обоих поломанных случаях всё работает хорошо, и разработчики подумали, что эта сага подошла к своему завершению. Как же мы ошибались…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПосле выпуска Progress Report к нам начали поступать отчёты о проблемах, и самые частые были связаны с серией игр \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Category:Mario_%26_Sonic_(Series)\" rel=\"nofollow noopener noreferrer\"\u003EMario and Sonic at the Olympic Games\u003C\u002Fa\u003E. Первоначальный анализ показал, что всё было очень плохо. JIT архитектуры x86-64 эмулятора Dolphin вёл себя неправильно и дважды транслировал адрес во время \u003Ccode\u003Edcbx\u003C\u002Fcode\u003E, таким образом переходя к неправильному флагу. Также в \u003Ci\u003Eобоих\u003C\u002Fi\u003E JIT Dolphin было поломано маскирование, из-за чего поломанными в конце месяца оказались довольно многие игры.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJosJuice\" rel=\"nofollow noopener noreferrer\"\u003EJosJuice\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E и \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FAdmiralCurtiss\" rel=\"nofollow noopener noreferrer\"\u003EAdmiralCurtiss\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E объединили усилия, чтобы быстро исправить JIT и как можно быстрее снова заставить всё работать. \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJosJuice\" rel=\"nofollow noopener noreferrer\"\u003EJosJuice\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E занялся исправление маскирования в JIT AArch64, а \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FAdmiralCurtiss\" rel=\"nofollow noopener noreferrer\"\u003EAdmiralCurtiss\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E внёс гораздо более объёмные изменения в JIT x86-64, чтобы гарантировать, что Dolphin всегда будет передавать командам \u003Ccode\u003Edcbx\u003C\u002Fcode\u003E правильный адрес.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nБлагодаря этой быстрой работе менее чем через две недели всё снова заработало. Однако эти исправления имели свою цену. Из-за них пропали все улучшения производительности из предыдущего отчёта об изменениях, то есть \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Arc_Rise_Fantasia\" rel=\"nofollow noopener noreferrer\"\u003EArc Rise Fantasia\u003C\u002Fa\u003E и другие игры, одновременно инвалидирующие большие области памяти, снова имели проблемы с производительностью. Проще говоря, ситуация была не самой хорошей, и для её исправления требовались усилия.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fdolphin-emu.org\u002Fm\u002Fuser\u002Fblog\u002Fprogress-report\u002F2021-august\u002Farcrisefantasia.png\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fac4\u002Fb40\u002F4d1\u002Fac4b404d11c649898fa773a28cd99ce3.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fac4\u002Fb40\u002F4d1\u002Fac4b404d11c649898fa773a28cd99ce3.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EЗагрузка областей с карты мира приводила к серьёзному проседанию FPS, поскольку игра очищала большие участки памяти.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FAdmiralCurtiss\" rel=\"nofollow noopener noreferrer\"\u003EAdmiralCurtiss\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E приступил к изучению причин торможения, чтобы найти виновника. При первоначальной загрузке \u003Ca href=\"https:\u002F\u002Fwiki.dolphin-emu.org\u002Findex.php?title=Super_Mario_Sunshine\" rel=\"nofollow noopener noreferrer\"\u003ESuper Mario Sunshine\u003C\u002Fa\u003E, которая является одним из наихудших сценариев для \u003Ccode\u003Edcbx\u003C\u002Fcode\u003E, код трансляции страниц вызывался \u003Cstrong\u003E134 миллионов раз\u003C\u002Fstrong\u003E. Что ещё страннее, так это то, что инвалидируемые игрой данные даже не отображались на физическую память! Выполнение всех этих вызовов по отдельности было ужасно неэффективным, поэтому нужно было что-то сделать, чтобы их сгруппировать. Мы решили поискать подсказки в том, как работает \u003Cem\u003Eidleskipping\u003C\u002Fem\u003E. Idleskipping — это функция в JIT Dolphin, ищущая в коде \u003Cem\u003Eциклы\u003C\u002Fem\u003E, предназначенные просто для «сжигания» излишнего времени ЦП. Вместо того, чтобы эмулировать эти пустые операции, мы можем просто обнаруживать и \u003Cem\u003Eпропускать\u003C\u002Fem\u003E их, при этом подстраивая downcount и другие аспекты, чтобы сильно увеличить производительность ЦП.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nХотя \u003Ccode\u003Edcbx\u003C\u002Fcode\u003E не является пустой операцией наподобие idleloops, благодаря распознаванию их циклов \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FAdmiralCurtiss\" rel=\"nofollow noopener noreferrer\"\u003EAdmiralCurtiss\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E смог сделать так, чтобы вместо выполнения сотен миллионов отдельных вызовов Dolphin статически анализировал ситуацию для объединения их в \u003Cem\u003Eодну крупную dcbx\u003C\u002Fem\u003E, а затем подстраивал downcount и другие вещи, чтобы в конечном итоге оптимизация с точки зрения эмулируемого окружения оказывалась эквивалентом отдельных вызовов. Этот трюк восстанавливает производительность до уровней, которые были в этих играх раньше и при этом больше ничего \u003Cem\u003Eне ломает\u003C\u002Fem\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИ JIT x86-64, и JIT AArch64 теперь оснащены этой новой оптимизацией (для AArch64 её реализовал \u003Cstrong\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FJosJuice\" rel=\"nofollow noopener noreferrer\"\u003EJosJuice\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E). И \u003Cem\u003Eтеперь\u003C\u002Fem\u003E всё должно быть и \u003Cem\u003Eбыстрым\u003C\u002Fem\u003E, и \u003Cem\u003Eкорректным\u003C\u002Fem\u003E, а нам не придётся выбирать одно из двух, как это было в последние два месяца.\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"эмуляторы"},{"titleHtml":"dolphin emulator"},{"titleHtml":"wii"},{"titleHtml":"nintendo wii"},{"titleHtml":"gamecube"},{"titleHtml":"nintendo 64"},{"titleHtml":"обратная разработка"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F581406\u002F6aea9e0b7a94057534b7f1dd17acad17\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F581406\u002F6aea9e0b7a94057534b7f1dd17acad17\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F581406\\\u002F\"},\"headline\":\"Улучшения в эмуляторе Dolphin\",\"datePublished\":\"2021-10-22T09:52:45+03:00\",\"dateModified\":\"2021-10-22T11:24:06+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"PatientZero\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Многие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы &mdash; важная часть многих сообществ любителей классических игр, они...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F581406\\\u002F#post-content-body\",\"about\":[\"h_3d_graphics\",\"h_gamedev\",\"h_reverse-engineering\",\"h_games\",\"f_develop\",\"f_design\",\"f_popsci\"],\"image\":[\"https:\\\u002F\\\u002Fdolphin-emu.org\\\u002Fm\\\u002Fuser\\\u002Fblog\\\u002Fprogress-report\\\u002F2021-august\\\u002Fspongebobold-vertexroundingon.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fc70\\\u002F12a\\\u002F2a5\\\u002Fc7012a2a51506a23fdbaa10dc5f2c104.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fbe0\\\u002F8d0\\\u002Fe2c\\\u002Fbe08d0e2c021f18f3c4fc293d5f66751.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F783\\\u002Fd0a\\\u002F1d5\\\u002F783d0a1d5f1d50309e051af405299988.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F181\\\u002F463\\\u002F727\\\u002F1814637276bf9b45d4b803f385739011.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F9ad\\\u002F35d\\\u002F60b\\\u002F9ad35d60be3a1bff4e2dba406b4df69b.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F86d\\\u002F5f4\\\u002Faba\\\u002F86d5f4aba6107ff010df3669e6c1f6d8.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F5e9\\\u002F813\\\u002Fcef\\\u002F5e9813cef22ced7dbcc47785b6c91ee6.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F724\\\u002Fc97\\\u002F03e\\\u002F724c9703e8cf4523703b26551382232e.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fe43\\\u002F7a2\\\u002F621\\\u002Fe437a2621879baf14a21cd7e683227a6.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F362\\\u002F8ae\\\u002Fb8b\\\u002F3628aeb8b3eaacc234a19f84303b4650.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F43e\\\u002F0a6\\\u002F846\\\u002F43e0a6846d82e217c7597a28eb419866.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F78c\\\u002F759\\\u002Fde5\\\u002F78c759de5222db2eafca3be5a3dac47d.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F239\\\u002F915\\\u002F2c1\\\u002F2399152c11c6651845023c98f970dc9d.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Ff67\\\u002F7ff\\\u002F1db\\\u002Ff677ff1db493a0aac20e3c938a035c32.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fc0c\\\u002Fcf4\\\u002Fda8\\\u002Fc0ccf4da814778205c4d5f2d1eb6b100.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fad3\\\u002Ffa3\\\u002F472\\\u002Fad3fa3472b0ab17e0ca67ee019732b0d.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fcd8\\\u002Fa94\\\u002Fb26\\\u002Fcd8a94b26754d577992fb784ea5ee3a3.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fd46\\\u002F373\\\u002Fc24\\\u002Fd46373c242f736eb1d0dc511b01fdbbe.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Ff0d\\\u002F4c5\\\u002F5f4\\\u002Ff0d4c55f4b886aa172f334bd821627ed.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Faeb\\\u002F91e\\\u002F5fe\\\u002Faeb91e5fe802798f9210ada7713a5873.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fe17\\\u002F60c\\\u002Fe41\\\u002Fe1760ce413ed82c2f603eebcf1858512.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F7d7\\\u002Fe45\\\u002F6cb\\\u002F7d7e456cb3db7fea84d9c722085d4563.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002F649\\\u002F998\\\u002F7a1\\\u002F6499987a1df749e524017236c722925e.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fac4\\\u002Fb40\\\u002F4d1\\\u002Fac4b404d11c649898fa773a28cd99ce3.jpg\"]}","metaDescription":"Многие сообщества геймеров благодарны разработчикам эмуляторов за их многолетний труд. Эмуляторы — важная часть многих сообществ любителей классических игр, они предоставляют игрокам доступ к таким...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":true}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"3d_graphics,gamedev,reverse-engineering,games"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
