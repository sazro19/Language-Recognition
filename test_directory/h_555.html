<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Ультимативный гайд по созданию CI/CD в GitLab с автодеплоем в Kubernetes на голом железе всего за 514$ в год ( ͡° ͜ʖ ͡°) / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/company\/domclick\/blog\/577964\/"},"headline":"Ультимативный гайд по созданию CI\/CD в GitLab с автодеплоем в Kubernetes на голом железе всего за 514$ в год ( ͡° ͜ʖ ͡°)","datePublished":"2021-10-14T11:02:07+03:00","dateModified":"2021-10-22T00:21:50+03:00","author":{"@type":"Person","name":"Алексей Ермаков"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Шел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выход...","url":"https:\/\/habr.com\/ru\/company\/domclick\/blog\/577964\/#post-content-body","about":["c_domclick","h_devops","h_kubernetes","f_develop","f_admin"],"image":["https:\/\/habr.com\/share\/publication\/577964\/4aa48a85d70e02cd429c1ec00ac0de41\/","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/dd9\/7fd\/b3b\/dd97fdb3bb7dc37f60dc3c21c4ffd56a.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/804\/10f\/ad9\/80410fad9beda70d7dadfac5662de297.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/576\/40a\/542\/57640a542728589bc045af3e85cf0da6.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/31a\/98f\/e69\/31a98fe6919959b34a12496a29bdf5a1.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/91e\/9df\/d43\/91e9dfd438b388a7b377f62922535793.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/efe\/56f\/e73\/efe56fe7315d7ccd577439ed41500975.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f85\/8de\/61f\/f858de61f85648c3f5596e7c624a056f.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/8fb\/4ee\/f3c\/8fb4eef3c9b944dfe2ed653d3bd773d9.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/e87\/915\/732\/e87915732ae701b58493726587a53d9d.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/ce0\/da1\/6ed\/ce0da16ed7023c2d59bd42fb82f0a98e.jpeg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/3a6\/127\/d5f\/3a6127d5f73c55f6869e6741edba0a55.jpeg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/799\/b54\/34f\/799b5434f566d015630722bfb6d433b5.jpeg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/d9e\/98f\/bfa\/d9e98fbfa28545819ca716c05f5b50f7.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/e48\/428\/710\/e48428710d5c97ccc1545d7acc2b2b3b.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/adb\/008\/413\/adb008413ef6590cdeb48283b577028f.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/469\/9dd\/8af\/4699dd8af81548ab61da3dc63ac10e75.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/c41\/cd8\/3c5\/c41cd83c5789e9660b0c5fe294ff3be9.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/676\/b1d\/b53\/676b1db539f4b9a746adf9d6127819d8.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/977\/b39\/1a8\/977b391a89bdc29b54305e09a1672b6c.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/bf7\/974\/2da\/bf79742da0fa0b645edd3ee9f2a3fdfe.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/3a0\/9ca\/807\/3a09ca80751eb853d268c13f047d2864.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/86a\/cc8\/d95\/86acc8d9587bb0aff314f82fee4339b0.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/93b\/558\/862\/93b5588621122e72ea3733e0862cef3f.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/cd1\/df4\/987\/cd1df4987dffc3d74234e8c049783ea0.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/521\/12d\/62d\/52112d62d7e1d8750d0e9003faa5cddf.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/9a5\/657\/74f\/9a565774fa9d3f390a5e6b27d93277e1.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/435\/de0\/dba\/435de0dba0c20688449c270bb21bbbb0.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/765\/6d5\/99e\/7656d599e2b943842c4dc21772bce0cd.jpg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/4a0\/47e\/4e4\/4a047e4e403c61bb050069cf250c461d.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/294\/260\/d53\/294260d53a298f0bbcd897bc6d76deb5.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/585\/756\/de2\/585756de2560bfcc27ffedcd4eb95171.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/80b\/cc8\/e07\/80bcc8e073480b3bebc443b8c08989e2.jpeg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/a5c\/6d9\/93c\/a5c6d993c62342d5283e0ff49b591700.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/dff\/715\/6e5\/dff7156e58649eee9dd15b6e68077e75.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/c2b\/822\/78e\/c2b82278eb0c7c507b239dbae0e18b77.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/e89\/068\/be9\/e89068be97b8a44f8f6e948f9ce9ed73.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/915\/8d2\/dfc\/9158d2dfc19bb4d2586ed09c3abd5a2a.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/397\/fc6\/813\/397fc6813c488ea1b705c47aac1bf3b4.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/b88\/382\/5d1\/b883825d100b4eab56b75fa51c4fe7ad.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/940\/17d\/ff9\/94017dff9ad438d8eb9a75436dca91e4.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/860\/40d\/2d4\/86040d2d4ebd5f5988fa50cc9ebd3c10.jpeg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/b4f\/0b3\/cef\/b4f0b3cef5f2ac6e336822cad753d5cf.gif","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/45c\/7e4\/387\/45c7e4387aa72a5de7e30d1feafd8e18.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/7ee\/1ff\/d88\/7ee1ffd88a84bfaf04b74854721add19.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/df0\/b34\/7eb\/df0b347eb56ea832bcca89beefe9fca0.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/258\/2d1\/0d6\/2582d10d6f58dfad942f26d589dba1e6.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/897\/5b3\/0ca\/8975b30cacc4c2510ef417d7f4ca4466.gif","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/19d\/c5e\/d04\/19dc5ed046156cd3e4e3e008c5ba4a8f.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/0e5\/ea3\/8b0\/0e5ea38b0987973d1d31919e19770650.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/be4\/fa5\/3f0\/be4fa53f04711cdb41396a67023d5354.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f69\/958\/533\/f6995853328927b5b15bb730718a522e.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/58e\/c8d\/20f\/58ec8d20f6ebcac9bbf111a333288698.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/58d\/2aa\/dcf\/58d2aadcfba0dec70dc020af200c53ff.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/140\/062\/a8d\/140062a8d771e63645a2aa60e1512458.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/095\/f8d\/72f\/095f8d72f11cffe5f764cd46e3170697.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/e08\/44f\/d87\/e0844fd87343a2093e4131896517e788.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/8b7\/0d9\/13a\/8b70d913ac64cb66c340585549d789a1.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/fcb\/479\/faf\/fcb479faf3587910e98c8a9718d1cc03.gif","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/f49\/f71\/7e8\/f49f717e8e6fa01a92168f0a6e080c88.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/728\/d23\/298\/728d2329859b9db64b4f81473b87c887.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/655\/318\/30d\/65531830d33feb341595eab02e5bd5f1.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/ab0\/06b\/ffb\/ab006bffb1058a0439b02f81bb40b67f.gif","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/aa1\/50c\/a9b\/aa150ca9becfb645d0592e80df2bbab5.gif","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/9ca\/43c\/6bc\/9ca43c6bc9cb81c5fc1205e481ace983.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Ультимативный гайд по созданию CI/CD в GitLab с автодеплоем в Kubernetes на голом железе всего за 514$ в год ( ͡° ͜ʖ ͡°)" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Ультимативный гайд по созданию CI/CD в GitLab с автодеплоем в Kubernetes на голом железе всего за 514$ в год ( ͡° ͜ʖ ͡°)" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Ультимативный гайд по созданию CI/CD в GitLab с автодеплоем в Kubernetes на голом железе всего за 514$ в год ( ͡° ͜ʖ ͡°)" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Шел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выходят статьи о создании неубиваемых..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Шел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выходят статьи о создании неубиваемых..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Шел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выходят статьи о создании неубиваемых..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Шел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выходят статьи о создании неубиваемых..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Шел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выходят статьи о создании неубиваемых..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habrastorage.org/getpro/habr/upload_files/3a5/067/42f/3a506742f30c010e5f909a0f744d3470.jpg" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/3a5/067/42f/3a506742f30c010e5f909a0f744d3470.jpg" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/3a5/067/42f/3a506742f30c010e5f909a0f744d3470.jpg" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/3a5/067/42f/3a506742f30c010e5f909a0f744d3470.jpg" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/3a5/067/42f/3a506742f30c010e5f909a0f744d3470.jpg" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="577964" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-14T08:02:07.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/577964/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/company/domclick/blog/577964/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habrastorage.org/getpro/habr/upload_files/3a5/067/42f/3a506742f30c010e5f909a0f744d3470.jpg" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" companyName="domclick" data-async-called="true" class="tm-page"><div class="tm-page-width"><div class="tm-page__header"><!----></div> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"><div class="tm-company-card tm-company-article__company-card"><div class="tm-company-card__info"><div class="tm-company-card__header"><a href="/ru/company/domclick/profile/" class="tm-company-card__avatar"><div class="tm-entity-image"><img alt="" height="48" src="//habrastorage.org/getpro/habr/company/d28/115/f55/d28115f5503229d4f9018292fabd1840.jpg" width="48" class="tm-entity-image__pic"></div></a> <!----> <div class="tm-rating tm-company-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">571.71</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div> <div class="tm-company-card__info"><a href="/ru/company/domclick/profile/" class="tm-company-card__name">
        Домклик
      </a> <div class="tm-company-card__description">Место силы</div></div></div> <div class="tm-company-card__buttons"><!----> <!----></div></div> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/Mopckou/" title="Mopckou" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/cf7/5a0/cfa/cf75a0cfaa7d58688f230e90fa0042d5.jpg" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/Mopckou/" class="tm-user-info__username">
      Mopckou
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-14T08:02:07.000Z" title="2021-10-14, 11:02">14  октября   в 11:02</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Ультимативный гайд по созданию CI/CD в GitLab с автодеплоем в Kubernetes на голом железе всего за 514$ в год ( ͡° ͜ʖ ͡°)</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/company/domclick/blog/" class="tm-article-snippet__hubs-item-link router-link-active"><span>Блог компании ДомКлик</span> <!----></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/devops/" class="tm-article-snippet__hubs-item-link"><span>DevOps</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/kubernetes/" class="tm-article-snippet__hubs-item-link"><span>Kubernetes</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <div class="tm-article-snippet__labels"><div class="tm-article-snippet__label"><span>
        Tutorial
      </span></div></div> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><figure class="full-width "><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/dd9/7fd/b3b/dd97fdb3bb7dc37f60dc3c21c4ffd56a.jpg" width="780" height="458" data-src="https://habrastorage.org/getpro/habr/upload_files/dd9/7fd/b3b/dd97fdb3bb7dc37f60dc3c21c4ffd56a.jpg" data-blurred="true"/><figcaption></figcaption></figure><p>Шел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выходят статьи о создании неубиваемых Kubernetes-кластеров, которые, по видимому, всех нас переживут. А кто-нибудь подумал о простых пацанах (пацанессах)??? Как быть обычному программисту, который хочет свой небольшой кластер и ламповый CI/CD с автодеплоем приложения, чтобы кенты с района не засмеяли?</p><p>Всем привет, меня зовут Алексей и я <s>алкоголик</s> разработчик на Python/Go в Домклик. Сегодня мы будем понижать порог входа в self-hosted Kubernetes и GitLab AutoDevops.</p><p>Это очередная статья из серии «ультимативных». Мы уже писали раньше, например, о том, как выглядит<a href="https://habr.com/ru/company/domclick/blog/531254/"> асинхронное приложение</a> здорового человека. Или <a href="https://habr.com/ru/company/domclick/blog/532030/">гайд по поиску</a> утечек памяти в Python. Сегодня тоже будет весело. </p><p>Статья получилась довольно большая, поэтому после каждой главы будет стрелочка <a href="#0">↑</a>, нажав на которую вы обратно перейдёте к оглавлению. Те, кто хочет всё и сразу — переходите к разделу <strong>TL;DR</strong>, там будет краткая выжимка из статьи.</p><hr/><a class="anchor" name="0" id="0"></a><h2>Оглавление</h2><ol><li><p><a href="#%D0%92%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5">Введение</a></p></li><li><p><a href="#1">Установка Kubernetes на голое железо</a></p><ul><li><p><a href="#1">Установка Kubernetes</a></p></li><li><p><a href="#2">Установка Helm</a></p></li><li><p><a href="#3">Установка Ingress-nginx</a></p></li><li><p><a href="#4">Установка Metallb</a></p></li></ul></li><li><p><a href="#5">Настройка CI/CD в Gitlab</a></p><ul><li><p><a href="#5">Выбираем доменное имя для сервиса</a></p></li><li><p><a href="#6">Создание проекта в GitLab</a></p></li><li><p><a href="#7">Интеграция Kubernetes-кластера</a></p></li><li><p><a href="#8">Настройка GitLab AutoDevops</a></p></li><li><p><a href="#9">Разбираем канареечный деплой на практике</a></p></li></ul></li><li><p><a href="#10">TL;DR</a></p></li></ol><hr/><a class="anchor" name="%D0%92%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5" id="Введение"></a><h2>Введение</h2><p>Начнем с самого животрепещущего — с ценообразования. Откуда взялись эти 514$? </p><p>Если в вас живет маленький стартапер, то вам рано или поздно придется где-то развернуть свой кластер и настроить автоматическую поставку приложения в production-окружение (не руками же деплоить в 2к21?). Платить жадным гигантам по типу гугла или амазона огромные деньги — это зашквар. Денях-то нет, вот мы и держимся. Поэтому я решил попробовать собрать свой кластер и настроить CI/CD за минимально возможные средства, но при этом попытался не перегибать палку в чрезмерной экономии. </p><p>Кластер решил делать минимальный, состоящий из двух узлов — master и worker. Обе машины имеют конфигурацию 2x2,2 ГГц, 4 Гб RAM, 40 Гб SSD. Аренда одной в месяц ~ 12$. В год за две машины ~ 278$. Платил в рублях, перевел в доллары для удобства дальнейших расчетов (курс 72 р).</p><p>CI/CD решил реализовывать в GitLab (лежит к нему душа). И как оказалось, это довольно большая статья расходов. Еще в начале года был silver-аккаунт, с более менее приличными ценами ~ 9$ в месяц. Но сейчас его упразднили и на его место пришел premium за 19$ в месяц или 228$ в год. Естественно, там много плюшек типа овер-дофига CI-минут, канареечный деплой, защищенные переменные окружения, дашборд окружений Куба и т.д., но цена довольно кусачая.</p><p>Третья статья, самая маленькая — покупка доменного имени. Мне обошлось в 8$ за первый год (за последующие там вроде в два раза больше берут).</p><p>Итого: 278$ + 228$ + 8$ = 514$.</p><p>А что, если купить еще один VPS и установить туда GitLab? Официальная документация <a href="https://docs.gitlab.com/ee/install/requirements.html#memory">рекомендует</a> использовать машину с двумя ядрами и 4 Гб оперативы. Если брать VPS у того же провайдера, то выйдет 12$ в месяц, а в год — 144$. Экономия в таком случае 84$ за год. Но тут прибавляется забота об установке, настройке, администрировании GitLab. И не уверен, насколько полная функциональность в таком случае будет доступна. Знатоки self-managed GitLab, напишите в коменты. </p><p>В итоге я решил не заморачиваться с установкой своего GitLab и весь материал статьи отрабатывал на конфигурации за 514$. Но вот только пару дней назад, неудовлетворенный качеством предоставляемых облачным провайдером услуг, решил погуглить в надежде на более дешевые альтернативы. Оказалось, что есть машины не просто дешевле, так ещё и мощнее. Например, предлагают в аренду VPS [3x2,8 ГГц, 5 Гб RAM, 60 Гб SSD] за 9$ и [2x2,8 ГГц, 2 Гб RAM, 40 Гб SSD] за 6$ в месяц. За год выйдет: (9$ + 6$) * 12 + 228$ + 8$ = 416$. В будущем планирую арендовать машины именно у этого провайдера.</p><p>Вывод: если задаться целью максимально сэкономить, то варианты найдутся. А на этом вступление окончено. Дальше будет долго, нудно и моментами даже чересчур подробно; думаю, полностью прочтут эту статью два человека: я и наш шеф-редактор блога (за что ему большое спасибо!). <a href="#0">↑</a></p><a class="anchor" name="1" id="1"></a><h2>Установка Kubernetes на голое железо</h2><h3>Установка Kubernetes</h3><p>Вам легко будет установить по этой замечательной <a href="https://www.reg.ru/support/vps-servery/oblachnie-serveri-vps/ustanovka-programmnogo-obespechenija/kubernetes">инструкции</a>. Но в ней есть ряд критических моментов, которые я разобрал под спойлером.</p><details class="spoiler"><summary>Подсказки по установке Kubernetes на Ubuntu 20.04 LTS</summary><div class="spoiler__content"><p>Установка делится на этапы и пункты. Здесь показаны те пункты, в которых возникает ошибка.</p><h3>Этап 1. Пункт 4.</h3><pre><code class="bash">sudo systemctl enable docker</code></pre><p>Если выполнить эту команду, будет ошибка:</p><figure class="full-width "><img src="/img/image-loader.svg" height="80" data-src="https://habrastorage.org/getpro/habr/upload_files/804/10f/ad9/80410fad9beda70d7dadfac5662de297.png" data-width="1368"/><figcaption></figcaption></figure><p>Поэтому откройте файл <em>/etc/hosts</em>:</p><pre><code class="bash">nano /etc/hosts</code></pre><p>В моем случае не определен хост <em>ruvds-2p1sn</em>, мне надо добавить:</p><pre><code>127.0.0.1 ruvds-2p1sn</code></pre><p>А также в этом файле введите следующее имя (это для master-ноды; когда будете повторять для worker-ноды, то введите <code>kubernetes-worker</code>)</p><pre><code>127.0.0.1 kubernetes-master</code></pre><p>У меня файл выглядит так:</p><figure class="full-width "><img src="/img/image-loader.svg" height="330" data-src="https://habrastorage.org/getpro/habr/upload_files/576/40a/542/57640a542728589bc045af3e85cf0da6.png" data-width="1026"/><figcaption></figcaption></figure><p>Сохраняем и выходим. После чего можно выполнить команду:</p><pre><code>sudo systemctl enable docker</code></pre><h3>Этап 2. Пункт 1.</h3><pre><code class="bash">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add</code></pre><p>Эта команда приведёт к ошибке:</p><figure class="full-width "><img src="/img/image-loader.svg" height="226" data-src="https://habrastorage.org/getpro/habr/upload_files/31a/98f/e69/31a98fe6919959b34a12496a29bdf5a1.png" data-width="1942"/><figcaption></figcaption></figure><p>Здесь нужно установить <em>curl</em>. Скопируйте предложенную в консоли команду и выполните:</p><pre><code>apt install curl</code></pre><p>Потом выполните такую команду:</p><pre><code>apt-get update &amp;&amp; apt-get install -y gnupg2</code></pre><p>Готово. Теперь уже выполняем команду из пункта 1 второго этапа.</p><h3>Этап 2. Пункт 2.</h3><pre><code>sudo apt-add-repository "deb http://apt.kubernetes.io/ kubernetes-xenial main"</code></pre><p>Эта команда приведёт к ошибке:</p><figure class="full-width "><img src="/img/image-loader.svg" height="71" data-src="https://habrastorage.org/getpro/habr/upload_files/91e/9df/d43/91e9dfd438b388a7b377f62922535793.png" data-width="1746"/><figcaption></figcaption></figure><pre><code class="bash">sudo apt-get install software-properties-common</code></pre><p>И возвращайтесь к команде пункта 2.</p><h3>Этап 2. Пункт 3.</h3><p>Предыдущие ошибки легко гуглятся и решаются одной командой. А вот с этой командой сложнее:</p><pre><code class="bash">sudo apt install kubeadm kubelet kubectl</code></pre><p>Еще в начале этого года с ней не было проблем. Но на момент написания статьи эта команда приводит к проблеме инициализации master-ноды на <strong>этапе 3 пункт 4</strong>. Что изменилось? Вышла новая версия утилиты — <strong>1.22.2.</strong> В начале же года я ставил версию <strong>1.20.2</strong> и всё было хорошо. Причину сбоя инициализации я на просторах интернета не нашел. Почти все руководства по установке не указывают конкретную версию утилит. А мы это исправим:</p><pre><code class="bash">sudo apt install kubeadm=1.20.2-00 kubelet=1.20.2-00 kubectl=1.20.2-00</code></pre><p>Вам же я предлагаю сначала попробовать с последней версией (если это, конечно, не 1.22.2), и если в пункте 4 этапа 3 есть проблемы, то возвращайтесь сюда и откатывайтесь на версию <strong>1.20.2</strong>.</p><p>И обязательно надо выполнить эту команду:</p><pre><code>sudo apt-mark hold kubeadm kubelet kubectl</code></pre><h3>Этап 3. Пункт 1.</h3><pre><code class="bash">sudo swapoff –a</code></pre><p>Эта команда нерабочая. Будет ошибка:</p><figure class="full-width "><img src="/img/image-loader.svg" height="72" data-src="https://habrastorage.org/getpro/habr/upload_files/efe/56f/e73/efe56fe7315d7ccd577439ed41500975.png" data-width="1068"/><figcaption></figcaption></figure><p>Я заморочился и даже сравнил с перепечатанной командой вручную.</p><figure class="full-width "><img src="/img/image-loader.svg" height="456" data-src="https://habrastorage.org/getpro/habr/upload_files/f85/8de/61f/f858de61f85648c3f5596e7c624a056f.png" data-width="1810"/><figcaption></figcaption></figure><p>Оказалось, что тирешка вовсе не тирешка -_- . Используйте эту команду:</p><pre><code class="bash">sudo swapoff -a</code></pre><h3>Этап 3. Пункт 4.</h3><p>На этом этапе есть <strong>!критическое!</strong> замечание. Нужно выполнить такую команду:</p><pre><code>sudo kubeadm init --pod-network-cidr=10.244.0.0/16</code></pre><p>Да, обязательно нужно добавить этот странный диапазон IP-адресов. Это нужно для сетевого плагина <strong>Flannel</strong>, который устанавливается далее по инструкции.</p><h2>Этап 3. Пункт 7.</h2><p>Тут команда верная, но адрес слетел на следующую строку. Используйте это:</p><pre><code>sudo kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</code></pre><p>На этом всё. Повторяйте инструкцию для worker-ноды (исключая некоторые пункты, которые нужны только для master-узла).</p></div></details><p><strong>UPD 21.10.21 </strong>Попробовал<strong> </strong>установить кластер и на <code>CentOS 8</code> по этой <a href="https://upcloud.com/community/tutorials/install-kubernetes-cluster-centos-8/">инструкции</a>. Проблем практически не было (в отличии от <code>Ubuntu</code>), инструкция очень даже рабочая. Но есть пару моментов, на которые хочу обратить внимание под спойлером.</p><details class="spoiler"><summary>Подсказки по установке Kubernetes на CentOS 8.</summary><div class="spoiler__content"><p>Почти все команды с <code>cat -</code>нерабочие, я их тут поправил. Команда в пункте 6:</p><pre><code>cat &lt;&lt;EOF> /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF</code></pre><p>И команда в пункте 1 следующего раздела:</p><pre><code>cat &lt;&lt;EOF> /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF</code></pre><p>Очень важный момент - в этой инструкции для фаервола добавляют некоторые исключения и доверительные хосты. Если следовать чисто по статье, то в последствии не получится достучаться до ingress-nginx (лично у меня не получилось). Поэтому я решил просто <a href="https://linuxconfig.org/redhat-8-stop-start-firewall">выключить</a> фаервол (все-таки поднимаем dev кластер).</p><p>И в отличии от Ubuntu на CentOS 8 я смог поставить самую крайнюю (1.22.2) версию куба.</p></div></details><p>Поздравляю! Теперь у вас есть свой собственный Kubernetes кластер! <a href="#0">↑</a></p><a class="anchor" name="2" id="2"></a><h3>Установка Helm</h3><p>Инструкция взята с официального <a href="https://helm.sh/docs/intro/install/">сайта</a> для Ubuntu.</p><pre><code class="bash">curl https://baltocdn.com/helm/signing.asc | sudo apt-key add -
sudo apt-get install apt-transport-https --yes
echo "deb https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
sudo apt-get update
sudo apt-get install helm</code></pre><p>Проверим успешность установки:</p><pre><code class="bash">helm version</code></pre><figure class="full-width "><img src="/img/image-loader.svg" height="78" data-src="https://habrastorage.org/getpro/habr/upload_files/8fb/4ee/f3c/8fb4eef3c9b944dfe2ed653d3bd773d9.png" data-width="1436"/><figcaption></figcaption></figure><details class="spoiler"><summary>Инструкция для CentOS 8. </summary><div class="spoiler__content"><p>Тоже с официального <a href="https://helm.sh/docs/intro/install/#from-script">сайта</a>:</p><pre><code class="bash">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh</code></pre></div></details><p>Helm установлен! <a href="#0">↑</a></p><a class="anchor" name="3" id="3"></a><h3>Установка Ingress-nginx</h3><p>Инструкцию стянул из официальной <a href="https://kubernetes.github.io/ingress-nginx/deploy/#using-helm">документации</a>.</p><pre><code class="bash">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx 
helm repo update 
helm install ingress-nginx ingress-nginx/ingress-nginx</code></pre><p>Также запросим установленные сервисы:</p><pre><code>kubectl get svc</code></pre><figure class="full-width "><img src="/img/image-loader.svg" height="190" data-src="https://habrastorage.org/getpro/habr/upload_files/e87/915/732/e87915732ae701b58493726587a53d9d.png" data-width="2244"/><figcaption></figcaption></figure><p>Если бы вы пользовались облачным сервисом <strong>GKE</strong> или <strong>AWS</strong>, то в графе <code>EXTERNAL-IP</code> появился бы выделенный IP-адрес. </p><p>А Ingress-сервис стал бы доступен по адресу: <code>http://*external-ip*:80</code></p><figure class="full-width "><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/ce0/da1/6ed/ce0da16ed7023c2d59bd42fb82f0a98e.jpeg" alt="В облачных &quot;Kubernetes-as-a-service&quot; есть прослойка между пользователем и кластером — Cloud Load Balancer." title="В облачных &quot;Kubernetes-as-a-service&quot; есть прослойка между пользователем и кластером — Cloud Load Balancer." width="756" height="567" data-src="https://habrastorage.org/getpro/habr/upload_files/ce0/da1/6ed/ce0da16ed7023c2d59bd42fb82f0a98e.jpeg" data-blurred="true"/><figcaption>В облачных "Kubernetes-as-a-service" есть прослойка между пользователем и кластером — Cloud Load Balancer.</figcaption></figure><p>Но когда вы устанавливаете Куб на голое железо, внешний балансировщик отсутствует, поэтому службы не получают EXTERNAL-IP. Это описано в <a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#bare-metal-considerations">документации</a> к Ingress-nginx (эти красивые картинки стянул оттуда же), а также <a href="https://docs.gitlab.com/ee/topics/autodevops/requirements.html#auto-devops-requirements-for-bare-metal">тут</a>.</p><figure class="full-width "><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/3a6/127/d5f/3a6127d5f73c55f6869e6741edba0a55.jpeg" alt="В &quot;bare-metal&quot; конфигурации эта прослойка отсутствует." title="В &quot;bare-metal&quot; конфигурации эта прослойка отсутствует." width="756" height="484" data-src="https://habrastorage.org/getpro/habr/upload_files/3a6/127/d5f/3a6127d5f73c55f6869e6741edba0a55.jpeg" data-blurred="true"/><figcaption>В "bare-metal" конфигурации эта прослойка отсутствует.</figcaption></figure><p>Будем использовать первое предложенное в этом документе решение — поставим Metallb, который заменит нам внешний балансировщик. <a href="#0">↑</a></p><a class="anchor" name="4" id="4"></a><h3>Установка Metallb</h3><p>Внесем изменения в configmap:</p><pre><code class="bash">kubectl edit configmap -n kube-system kube-proxy</code></pre><p>Нужно в <code>mode</code> записать <code>ipvs</code>, a <code>strictARP</code> активировать. Кусок конфигурации должен выглядеть так:</p><pre><code>apiVersion: kubeproxy.config.k8s.io/v1alpha1 
kind: KubeProxyConfiguration 
mode: "ipvs" 
ipvs:  
    strictARP: true</code></pre><p>Сохраняем и выходим, если сможете конечно, ибо запускается vim. Главное помните, в любой непонятной ситуации вводите:</p><figure class=""><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/799/b54/34f/799b5434f566d015630722bfb6d433b5.jpeg" width="490" height="350" data-src="https://habrastorage.org/getpro/habr/upload_files/799/b54/34f/799b5434f566d015630722bfb6d433b5.jpeg" data-blurred="true"/><figcaption></figcaption></figure><p>Добавляем Helm-репозиторий:</p><pre><code>helm repo add metallb https://metallb.github.io/metallb</code></pre><p>Создаем файл с именем <code>values.yaml</code><strong> </strong>и вставляем шаблон:</p><pre><code>configInline:
  address-pools:
   - name: default
     protocol: layer2
     addresses:
     - x.x.x.x/24</code></pre><p>В поле <code>addresses</code> указываем пул IP-адресов, которые заберёт в своё пользование Metallb. Адреса нужно указать в виде CIDR. В моём пользовании всего две виртуальные машины, поэтому речи о пуле адресов не идёт. Маска подсети для одного-единственного IP-адреса записывается как "<code>/32</code>".</p><p>В моем случае конфигурация выглядит так:</p><pre><code>configInline:
  address-pools:
   - name: default
     protocol: layer2
     addresses:
     - 194.87.253.108/32
     - 87.247.157.40/32</code></pre><p>Сохраняем и выходим. Теперь установим <code>helm chart metallb</code> с указанием файла конфигурации:</p><pre><code>helm install metallb metallb/metallb -f values.yaml</code></pre><p>После чего запросим сервисы:</p><pre><code>kubectl get svc</code></pre><figure class="full-width "><img src="/img/image-loader.svg" height="150" data-src="https://habrastorage.org/getpro/habr/upload_files/d9e/98f/bfa/d9e98fbfa28545819ca716c05f5b50f7.png" data-width="1976"/><figcaption></figcaption></figure><p>Если вы всё сделали правильно, то в графе <code>EXTERNAL-IP</code> появится выделенный IP-адрес для этого сервиса. Проверим в браузере:</p><figure class="full-width "><img src="/img/image-loader.svg" height="350" data-src="https://habrastorage.org/getpro/habr/upload_files/e48/428/710/e48428710d5c97ccc1545d7acc2b2b3b.png" data-width="1736"/><figcaption></figcaption></figure><p>На этом настройка Куба на голом железе завершена. <a href="#0">↑</a></p><details class="spoiler"><summary>Альтернативное решение</summary><div class="spoiler__content"><p>К любому из сервисов (с типом <code>LoadBalancer</code>), можно обратиться по <code>NodePort</code>. Например, Ingress-сервис будет доступен по адресу: <code>http://*ip-master-node*:*NodePort*</code>.</p><figure class="full-width "><img src="/img/image-loader.svg" height="364" data-src="https://habrastorage.org/getpro/habr/upload_files/adb/008/413/adb008413ef6590cdeb48283b577028f.png" data-width="1940"/><figcaption></figcaption></figure><p>Номер <code>NodePort</code> и тип сервиса можно увидеть тут:</p><figure class="full-width "><img src="/img/image-loader.svg" height="180" data-src="https://habrastorage.org/getpro/habr/upload_files/469/9dd/8af/4699dd8af81548ab61da3dc63ac10e75.png" data-width="2234"/><figcaption></figcaption></figure><p>Это один из вариантов решения проблемы отсутствия внешнего балансировщика. Описано в той же <a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service">документации</a>.</p><p>Если мы возьмём доменное имя, например, example.com, и свяжем его с IP-адресом master-ноды, то сервис будет доступен по адресу: <code>http://example.com:32128</code>. Выглядит стремновато. Но как вариант, можно поставить на master-ноду nginx и проксировать трафик с порта 80 на порт 32128. И тогда Ingress будет доступен по адресу <code>http://example.com</code>.</p><p>Нашел даже интересный проект на <a href="https://github.com/staticfloat/docker-nginx-certbot">Github</a>, который кроме запуска nginx в Docker-контейнере еще и настраивает SSL-сертификаты. Надо лишь указать, на какие доменные имена нужно выпустить сертификаты, и всё остальное он сделает сам. Действительно, ставится буквально одной командой, что очень порадовало. </p><p>Но лично у меня с этой схемой начались проблемы, когда я начал разворачивать Kubernetes dashboard и настраивать авторизацию через Keycloak. Поэтому, этот вариант пусть останется в истории.</p></div></details><a class="anchor" name="5" id="5"></a><h2>Настройка CI/CD в GitLab</h2><h3>Выбираем доменное имя для сервиса</h3><p>Сначала нужно придумать название для своего сервиса и купить доменное имя. Чур, мой сервис будет называться <code>awesomeservice</code>, а доменную зону я выбрал модную и красивую — <code>.tech</code>. Где покупать, в принципе, не имеет значения. </p><p>Cвяжем <code>external-ip</code> Ingress-nginx с новым купленным доменным именем. Для этого создайте A-запись (<code>awesomeservice.tech -> 194.87.253.108</code>). Полное обновление DNS-сервера занимает не более трёх часов. После этого Ingress-nginx будет доступен уже по доменному имени.</p><figure class="full-width "><img src="/img/image-loader.svg" height="366" data-src="https://habrastorage.org/getpro/habr/upload_files/c41/cd8/3c5/c41cd83c5789e9660b0c5fe294ff3be9.png" data-width="1782"/><figcaption></figcaption></figure><p>Естественно архитектура, будет микросервисная, а это значит, что для проекта могут быть развернуты разные приложения со своим API. У нас будет вспомогательный микросервис <code>coolapp</code>. И кряхтеть он будет по адресу <code>http://coolapp.awesomeservice.tech</code>. Причем это production-окружение, которое будет использовать конечный пользователь. Еще понадобятся test- и staging-окружения<strong>. </strong>В итоге у нас будет развёрнуто сразу несколько приложений с такими поддоменными именами:</p><ol><li><p>http://<strong>coolapp</strong>.awesomeservice.tech</p></li><li><p>http://<strong>staging.coolapp</strong>.awesomeservice.tech</p></li><li><p>http://<strong>qa01.coolapp</strong>.awesomeservice.tech</p></li><li><p>http://<strong>qa02.coolapp</strong>.awesomeservice.tech </p></li></ol><p>Это значит, надо сделать ещё четыре A-записи для поддоменых имен: <code>coolapp.</code>, <code>staging.coolapp.</code>, <code>qa01.coolapp.</code>, <code>qa02.coolapp.</code>. И да, все эти имена разрешаются на Ingress <code>EXTERNAL-IP</code>. <a href="#0">↑</a></p><a class="anchor" name="6" id="6"></a><h2>Создание проекта в GitLab</h2><figure class=""><img src="/img/image-loader.svg" height="338" data-src="https://habrastorage.org/getpro/habr/upload_files/676/b1d/b53/676b1db539f4b9a746adf9d6127819d8.png" data-width="300"/><figcaption></figcaption></figure><p>Создаём пустой проект. В 2к21 ребята из GitLab еще не завезли шаблон для Python-проекта ¯\_(ツ)_/¯.</p><figure class="full-width "><img src="/img/image-loader.svg" height="882" data-src="https://habrastorage.org/getpro/habr/upload_files/977/b39/1a8/977b391a89bdc29b54305e09a1672b6c.png" data-width="1656"/><figcaption></figcaption></figure><p>Создадим вспомогательное приложение coolapp для сервиса awesomeservice<strong>. </strong>Использовать будем слегка модифицированный микросервис на FastApi из предыдущих <a href="https://habr.com/ru/company/domclick/blog/551332/">статей</a>. Иерархия:</p><pre><code>coolapp
├── Dockerfile
├── README.md
├── main.py
└── requirements.txt
</code></pre><details class="spoiler"><summary>Dockerfile</summary><div class="spoiler__content"><pre><code>FROM python:3.8

EXPOSE 8080

WORKDIR app

COPY requirements.txt requirements.txt

RUN pip install -r requirements.txt

COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]
</code></pre></div></details><details class="spoiler"><summary>main.py</summary><div class="spoiler__content"><pre><code>from fastapi import FastAPI, Cookie
from typing import Optional
from uuid import uuid4

app = FastAPI()
uuid = uuid4()


@app.get("/api/v1/uuid")
async def root(key: Optional[str] = Cookie(None)):
    print(key)
    return {'uuid': uuid}


@app.get("/healthz")
async def health_check():
    return {}
</code></pre><p>Ручку <code>/healthz</code> будет использовать Kubernetes для проверки работоспособности поды.</p></div></details><details class="spoiler"><summary>requirements.txt</summary><div class="spoiler__content"><pre><code>fastapi==0.63.0
uvicorn==0.13.3
requests==2.26.0
</code></pre></div></details><p>Сборка и запуск приложения:</p><pre><code class="python">docker build . -t coolapp 
docker run -p 8080:8080 -t coolapp</code></pre><p>Проверяем работу:</p><figure class="full-width "><img src="/img/image-loader.svg" height="476" data-src="https://habrastorage.org/getpro/habr/upload_files/bf7/974/2da/bf79742da0fa0b645edd3ee9f2a3fdfe.png" data-width="1700"/><figcaption></figcaption></figure><p>Пушим проект в удаленный репозиторий. <a href="#0">↑</a></p><a class="anchor" name="7" id="7"></a><h2>Интеграция Kubernetes-кластера</h2><p>На главной проекта нажимаем кнопку <code>&lt;Add Kubernetes cluster></code>.</p><figure class="full-width "><img src="/img/image-loader.svg" height="1078" data-src="https://habrastorage.org/getpro/habr/upload_files/3a0/9ca/807/3a09ca80751eb853d268c13f047d2864.png" data-width="1498"/><figcaption></figcaption></figure><p>С невозмутимым лицом проходим мимо предложения воспользоваться облачными сервисами GKE, AWS. Переходим во вкладку «Подключить существующий кластер».</p><figure class="full-width "><img src="/img/image-loader.svg" height="548" data-src="https://habrastorage.org/getpro/habr/upload_files/86a/cc8/d95/86acc8d9587bb0aff314f82fee4339b0.png" data-width="2399"/><figcaption></figcaption></figure><p>В принципе, <a href="https://docs.gitlab.com/ee/user/project/clusters/add_existing_cluster.html#how-to-add-an-existing-cluster">официальная</a> документация довольно подробно расписывает, как заполнить каждое поле. Но для удобства продублирую инструкцию тут:</p><figure class="full-width "><img src="/img/image-loader.svg" height="1222" data-src="https://habrastorage.org/getpro/habr/upload_files/93b/558/862/93b5588621122e72ea3733e0862cef3f.png" data-width="1438"/><figcaption></figcaption></figure><p>Здесь надо заполнить шесть полей:</p><ol><li><p>Kubernetes cluster name</p></li><li><p>Environment scope</p></li><li><p>API URL</p></li><li><p>CA Certificate</p></li><li><p>Service Token</p></li><li><p>Project namespace prefix (optional, unique)</p></li></ol><p>Галочки <em>RBAC-enabled cluster</em>, <em>GitLab-managed cluster</em> и <em>Namespace per environment</em><strong> </strong>должны быть активны.</p><details class="spoiler"><summary>Kubernetes cluster name</summary><div class="spoiler__content"><p>Просто записываем имя кластера. У меня это<code>devkube</code>.</p></div></details><details class="spoiler"><summary>Environment scope</summary><div class="spoiler__content"><p>Оставляем <code>*</code>.</p></div></details><details class="spoiler"><summary>API URL</summary><div class="spoiler__content"><p>В консоли выполните:</p><pre><code>kubectl cluster-info | grep -E 'Kubernetes master|Kubernetes control plane' | awk '/http/ {print $NF}'</code></pre><figure class="full-width "><img src="/img/image-loader.svg" height="72" data-src="https://habrastorage.org/getpro/habr/upload_files/cd1/df4/987/cd1df4987dffc3d74234e8c049783ea0.png" data-width="2072"/><figcaption></figcaption></figure><p>Копируем вывод из консоли и вставляем.</p></div></details><details class="spoiler"><summary>CA Certificate</summary><div class="spoiler__content"><p>Выполните команду:</p><pre><code>kubectl get secrets</code></pre><p>Найдите название секрета, который начинается на <code>default-token-xxxxx</code>.</p><figure class="full-width "><img src="/img/image-loader.svg" height="366" data-src="https://habrastorage.org/getpro/habr/upload_files/521/12d/62d/52112d62d7e1d8750d0e9003faa5cddf.png" data-width="1522"/><figcaption></figcaption></figure><p>Вставьте это название секрета в следующую команду вместо <code>secret name</code>.</p><pre><code>kubectl get secret "secret name" -o jsonpath="{['data']['ca\.crt']}" | base64 --decode</code></pre><figure class="full-width "><img src="/img/image-loader.svg" height="692" data-src="https://habrastorage.org/getpro/habr/upload_files/9a5/657/74f/9a565774fa9d3f390a5e6b27d93277e1.png" data-width="1976"/><figcaption></figcaption></figure><p>Скопируйте весь вывод консоли в поле <code>CA Certificate</code>.</p></div></details><details class="spoiler"><summary>Service Token</summary><div class="spoiler__content"><p>Создайте файл <code>gitlab-admin-service-account.yaml</code> и вставьте:</p><pre><code class="yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: gitlab
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: gitlab-admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: gitlab
    namespace: kube-system
</code></pre><p>Выполните в той же папке с файлом:</p><pre><code>kubectl apply -f gitlab-admin-service-account.yaml</code></pre><p>После создания ресурсов выполните:</p><pre><code>kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep gitlab | awk '{print $1}')</code></pre><figure class="full-width "><img src="/img/image-loader.svg" height="690" data-src="https://habrastorage.org/getpro/habr/upload_files/435/de0/dba/435de0dba0c20688449c270bb21bbbb0.png" data-width="2148"/><figcaption></figcaption></figure><p>Скопируйте токен и вставьте в поле <code>Service Token</code>.</p></div></details><details class="spoiler"><summary>Project namespace</summary><div class="spoiler__content"><p>Введите префикс вашего пространства имён проекта. Пространство имен  проекта будет составлено из двух частей: префикса и имени окружения. Если не вписать, то GitLab сам сгенерирует некрасивое название с циферками. У меня это <code>coolapp-devkube</code>. Префикс должен быть уникальным для каждого проекта.</p></div></details><p>Заполняем все поля и сохраняем. В итоге должно выглядеть примерно так:</p><figure class="full-width "><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/765/6d5/99e/7656d599e2b943842c4dc21772bce0cd.jpg" width="1279" height="1282" data-src="https://habrastorage.org/getpro/habr/upload_files/765/6d5/99e/7656d599e2b943842c4dc21772bce0cd.jpg" data-blurred="true"/><figcaption></figcaption></figure><p>После добавления кластера сразу будут показаны его настройки. В окне &lt;<em>Base domain></em> введите базовый адрес кластера. В моем случае это <code>awesomeservice.tech</code><strong>.</strong></p><figure class="full-width "><img src="/img/image-loader.svg" height="608" data-src="https://habrastorage.org/getpro/habr/upload_files/4a0/47e/4e4/4a047e4e403c61bb050069cf250c461d.png" data-width="1000"/><figcaption></figcaption></figure><p>Теперь активируем <em>Auto Devops</em>. На главной проекта нажмите кнопку &lt;<em>Enable Auto Devops></em>. </p><figure class="full-width "><img src="/img/image-loader.svg" height="778" data-src="https://habrastorage.org/getpro/habr/upload_files/294/260/d53/294260d53a298f0bbcd897bc6d76deb5.png" data-width="1996"/><figcaption></figcaption></figure><p>Откроются настройки проекта, где нужно тыкнуть галочку &lt;<em>Default to Auto DevOps pipeline></em> и выбрать стратегию развертывания приложения. Я выбрал третий вариант, с предварительным деплоем в staging-среде, после которой будет доступна постепенная (ступенчатая) выкатка в production-среду. Подробнее о стратегиях выкатки можно почитать <a href="https://docs.gitlab.com/ee/topics/autodevops/requirements.html#auto-devops-deployment-strategy">тут</a>.</p><figure class="full-width "><img src="/img/image-loader.svg" height="780" data-src="https://habrastorage.org/getpro/habr/upload_files/585/756/de2/585756de2560bfcc27ffedcd4eb95171.png" data-width="2024"/><figcaption></figcaption></figure><p>Начиная с этого момента для проекта активен Auto Devops. <a href="#0">↑</a></p><a class="anchor" name="8" id="8"></a><h2>Настройка GitLab AutoDevops</h2><p>Краткий <a href="https://habr.com/ru/post/416557/">обзор</a> Auto Devops:</p><blockquote><p><a href="https://habr.com/ru/post/416557/#auto-devops-vyhodit-v-obschiy-dostup-core-starter-premium-ultimate-free-bronze-silver-gold"><strong>Auto DevOps</strong></a><strong> покрывает весь цикл поставки:</strong> Просто сделайте коммит вашего кода в GitLab и позвольте Auto DevOps заняться остальным: эта система проведет <a href="https://docs.gitlab.com/ee/topics/autodevops/#auto-build">сборку</a>, <a href="https://docs.gitlab.com/ee/topics/autodevops/#auto-test">тестирование</a>, проверку <a href="https://docs.gitlab.com/ee/topics/autodevops/#auto-code-quality">качества кода</a>, <a href="https://docs.gitlab.com/ee/topics/autodevops/#auto-sast">безопасности</a> и <a href="https://docs.gitlab.com/ee/topics/autodevops/#auto-license-management">лицензий</a>, <a href="https://docs.gitlab.com/ee/topics/autodevops/#auto-review-apps">пакетирование</a>, <a href="https://docs.gitlab.com/ee/topics/autodevops/#auto-dast">тестирование производительности</a>, <a href="https://docs.gitlab.com/ee/topics/autodevops/#auto-deploy">развертывание</a> и <a href="https://docs.gitlab.com/ee/topics/autodevops/#auto-monitoring">мониторинг</a> вашего приложения.</p></blockquote><details class="spoiler"><summary>Звучит так классно, что даже утопично... Вам так не кажется?</summary><div class="spoiler__content"><p>Да. Вам не кажется.</p><figure class=""><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/80b/cc8/e07/80bcc8e073480b3bebc443b8c08989e2.jpeg" alt="" title="" width="212" height="191" data-src="https://habrastorage.org/getpro/habr/upload_files/80b/cc8/e07/80bcc8e073480b3bebc443b8c08989e2.jpeg" data-blurred="true"/><figcaption></figcaption></figure></div></details><p>После активации AutoDevops в <s>master</s> main-ветке сразу же запустится конвейер. </p><figure class="full-width "><img src="/img/image-loader.svg" height="762" data-src="https://habrastorage.org/getpro/habr/upload_files/a5c/6d9/93c/a5c6d993c62342d5283e0ff49b591700.png" data-width="2030"/><figcaption></figcaption></figure><p>И конечно же, он зафейлится, разве могло быть иначе? </p><figure class="full-width "><img src="/img/image-loader.svg" height="978" data-src="https://habrastorage.org/getpro/habr/upload_files/dff/715/6e5/dff7156e58649eee9dd15b6e68077e75.png" data-width="2322"/><figcaption></figcaption></figure><p>Сборка прошла успешно, что уже радует. В блоке тестирования прошли такие этапы, как проверка лицензии, качества кода и т.д. В общем, прошло всё то, что на этом этапе нас мало интересует. В итоге конвейер завершил работу на тестировании. </p><figure class="full-width "><img src="/img/image-loader.svg" height="376" data-src="https://habrastorage.org/getpro/habr/upload_files/c2b/822/78e/c2b82278eb0c7c507b239dbae0e18b77.png" data-width="1766"/><figcaption></figcaption></figure><p>Быстрое гугление показало, что это проблема для всех питонистов: тестирование Python-проектов из коробки работать не будет. Но мы этап тестирования опустим, потому что наша цель — настроить автоматизированную поставку приложений. Выключать стадии можно несколькими способами.</p><p>1) Например, с помощью создания специальных <a href="https://docs.gitlab.com/ee/topics/autodevops/customize.html#disable-jobs">переменных окружения</a> в настройках проекта. Для этого перейдите в <code>Settings -> CI/CD -> Variables</code> и создайте переменную окружения <code>TEST_DISABLED=true.</code></p><details class="spoiler"><summary>После этого нужно обязательно создать новый pipeline, текущий все равно будет запускать test.</summary><div class="spoiler__content"><figure class="full-width "><img src="/img/image-loader.svg" height="958" data-src="https://habrastorage.org/getpro/habr/upload_files/e89/068/be9/e89068be97b8a44f8f6e948f9ce9ed73.png" data-width="2354"/><figcaption></figcaption></figure><p>Мы пропустили test, но ошибка возникла на этапе развертывания приложения в среду review (это аналог общепринятого окружения dev). Gitlab <a href="https://docs.gitlab.com/ee/topics/autodevops/troubleshooting.html#error-release--failed-timed-out-waiting-for-the-condition">ожидает</a>, что приложение отвечает по порту 5000, у нас же рабочий порт 8080. Можем, конечно, изменить на 5000, но так неинтересно. Хочется иметь возможность задавать порт самому. Решим эту проблему чуть позже.</p></div></details><p>2) Auto DevOps полностью изменяем, он работает по <a href="https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Auto-DevOps.gitlab-ci.yml">шаблону</a>, который, по сути, является реализацией<code>.gitlab-ci.yml.</code>Мы можем в проекте определить свой <code>.gitlab-ci.yml</code> и добавить свои этапы, или переопределить стандартные из AutoDevops. Пойдём по второму пути. </p><p>Создадим ветку <code>feature/autodevops</code>(pipeline запустится автоматом).</p><figure class=""><img src="/img/image-loader.svg" height="1000" data-src="https://habrastorage.org/getpro/habr/upload_files/915/8d2/dfc/9158d2dfc19bb4d2586ed09c3abd5a2a.png" data-width="2406"/><figcaption></figcaption></figure><p>Обратите внимание, что в ветке всё равно будет этап <code>test</code>, потому что я создал переменную среды <code>TETEST_DISABLED</code> как <code>protect variable</code>. Переменные такого типа доступны только в <code>protected </code>ветках, коей <code>main</code> и является.</p><p>Теперь переопределим стандартный <a href="https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Auto-DevOps.gitlab-ci.yml">шаблон</a> AutoDevops. Мы оставим почти все стадии, уберём только <code>test</code>, <code>deploy</code> (это заглушка и так), <code>dast</code> и <code>performance</code>. Создайте файл <code>.gitlab-ci.yml</code> и вставьте следующие инструкции:</p><pre><code class="yaml">variables:
  ROLLOUT_RESOURCE_TYPE: deployment  # без этого деплой фейлится


stages:
  - build
  - review
  - staging
  - canary
  - production
  - incremental rollout 10%
  - incremental rollout 25%
  - incremental rollout 50%
  - incremental rollout 100%
  - cleanup


include:
  - template: Jobs/Build.gitlab-ci.yml
  - template: Jobs/Deploy.gitlab-ci.yml

</code></pre><p>В <code>stages</code><strong> </strong>перечислены все стадии, которые будут выполняться, их реализация находится в подтягиваемых нами шаблонах<strong> </strong>(<code>include</code>)<strong>. </strong>Например, шаблон <a href="https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Jobs/Deploy.gitlab-ci.yml">деплоя</a>, в котором описаны все стадии начиная с <code>review</code> до <code>cleanup</code>. Там же можно заметить, что <code>review</code> и <code>cleanup</code> выполняются только в ветках, а остальные — в main-ветке, это логично. </p><p>Если сейчас запушить, то будет ошибка во время деплоя, потому что GitLab ожидает приложение на порту 5000. Разумеется, и тут мы не ограничены и можем указать нестандартный порт. GitLab деплоит приложение с помощью Helm-<a href="https://gitlab.com/gitlab-org/cluster-integration/auto-deploy-image/-/blob/master/assets/auto-deploy-app/values.yaml">чарта</a>, настройки которого можно переопределить у себя в проекте. Для этого нужно создать папку <code>.gitlab </code>и файл <code>auto-deploy-values.yaml.</code> Чтобы приложение успешно развернулось, достаточно переопределить <code>service.internalPort</code>, <code>service.externalPort</code> и обязательно указать наш кастомный health check в разделе <code>livenessProbe</code> и <code>readinessProbe</code>. Также я явно указал, что TLS выключен, настройка сертификатов — это отдельная тема. Если этого не сделать, то, например, Postman будет ругаться на сертификат (через браузер же всё норм).</p><pre><code class="yaml">service:
  internalPort: 8080
  externalPort: 8080

livenessProbe:
  path: /healthz

readinessProbe:
  path: /healthz

ingress:
  enabled: true
  tls:
    enabled: false</code></pre><p>Иерархия проекта такая (меняться больше не будет):</p><pre><code>coolapp
├── .gitlab
│   └── auto-deploy-values.yaml
├── .gitlab-ci.yml
├── Dockerfile
├── README.md
├── main.py
└── requirements.txt</code></pre><p>Запушим изменения и посмотрим результат выполнения конвейера. </p><figure class="full-width "><img src="/img/image-loader.svg" height="462" data-src="https://habrastorage.org/getpro/habr/upload_files/397/fc6/813/397fc6813c488ea1b705c47aac1bf3b4.png" data-width="1492"/><figcaption></figcaption></figure><p>Конвейер успешно завершил работу, но не спешите радоваться, это ещё не всё. Зайдём и проверим, что и куда задеплоилось.</p><figure class="full-width "><img src="/img/image-loader.svg" height="602" data-src="https://habrastorage.org/getpro/habr/upload_files/b88/382/5d1/b883825d100b4eab56b75fa51c4fe7ad.png" data-width="1492"/><figcaption></figcaption></figure><p>Детализация стадии review показывает, что сервис успешно развёрнут по адресу с интересным поддоменом <code>29857899-review-feature-cu-jfvpge</code>. Естественно, этот URL нерабочий, мы же не делали A-запись для такого поддомена.</p><figure class="full-width "><img src="/img/image-loader.svg" height="858" data-src="https://habrastorage.org/getpro/habr/upload_files/940/17d/ff9/94017dff9ad438d8eb9a75436dca91e4.png" data-width="2278"/><figcaption></figcaption></figure><p>Дело в том, что для каждой ветки GitLab (согласно шаблону AutoDevops) генерирует уникальный URL и разворачивает под ним сервис. Именно такая система была на моем прошлом месте работы, это довольно удобно, когда можно для своей ветки раскатить сервис и тестировать его изолированно. Но годится это для больших компаний и проектов. К тому же, чтобы это заработало нужно для домена <code>awesomeservice.tech</code> уметь настраивать автоподдомены. Для текущей статьи и в целом для небольшого проекта это излишняя фича, поэтому для веток мы сделаем два окружения: qa01 и qa02. Почему именно два?</p><figure class=""><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/860/40d/2d4/86040d2d4ebd5f5988fa50cc9ebd3c10.jpeg" width="512" height="512" data-src="https://habrastorage.org/getpro/habr/upload_files/860/40d/2d4/86040d2d4ebd5f5988fa50cc9ebd3c10.jpeg" data-blurred="true"/><figcaption></figcaption></figure><p>Начнем с того, что выключим стадии <code>review</code> и <code>cleanup</code>. Так как создаётся отдельный сервис для каждой ветки, ресурсы начинаются быстро плодиться и их надо чистить; для этого существует <code>cleanup</code> — она удаляет все созданные ресурсы, связанные с этой веткой. Просто взять и удалить <code>review</code> и <code>cleanup</code> из <code>stages</code> не получится. Если мы используем шаблон, то все описанные там стадии должны быть указаны в блоке <code>stages</code> нашего gitlab-ci.yml. Но стадии можно выключить, как я уже упоминал ранее, с помощью специальных <a href="https://docs.gitlab.com/ee/topics/autodevops/customize.html#disable-jobs">переменных</a> окружения. Переменная <code>REVIEW_DISABLED</code> отключает сразу обе стадии, это видно в реализации оных в шаблоне <a href="https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Jobs/Deploy.gitlab-ci.yml">Jobs/Deploy.gitlab-ci.yml</a>. Заодно включим стадию <code>canary</code> (она по умолчанию выключена), это нам понадобится для конвейера в main-ветке.</p><pre><code class="yaml">variables:
  ROLLOUT_RESOURCE_TYPE: deployment 
  REVIEW_DISABLED: "true"
  CANARY_ENABLED: "true"


stages:
  - build
  - review  # off stage
  - staging
  - canary
  - production
  - incremental rollout 10%
  - incremental rollout 25%
  - incremental rollout 50%
  - incremental rollout 100%
  - cleanup  # off stage


include:
  - template: Jobs/Build.gitlab-ci.yml
  - template: Jobs/Deploy.gitlab-ci.yml

</code></pre><p>После выключения этапа <code>review</code> создадим свою стадию с именем <code>qa</code>. За основу возьмем стадию <code>staging</code> из того же стандартного шаблона. Вот так она выглядит:</p><pre><code class="yaml">staging:
  extends: .auto-deploy
  stage: staging
  script:
    - auto-deploy check_kube_domain
    - auto-deploy download_chart
    - auto-deploy ensure_namespace
    - auto-deploy initialize_tiller
    - auto-deploy create_secret
    - auto-deploy deploy
  environment:
    name: staging
    url: http://$CI_PROJECT_PATH_SLUG-staging.$KUBE_INGRESS_BASE_DOMAIN
  rules:
    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == ""'
      when: never
    - if: '$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      when: never
    - if: '$STAGING_ENABLED'
</code></pre><p>Нужно будет сделать небольшие правочки в блоках <code>stage</code>, <code>environment</code> и <code>rules</code>, а вот <code>script</code> останется нетронутым. Всё довольно просто: в <code>stage</code> записывается имя стадии, в <code>environment.url</code> указывается путь, под которым будет развёрнуто приложение (эта строчка просто пробрасывается в Ingress в <code>spec.rules.host</code> — кто знает, тот знает). В этом URL можно заметить странный префикс <code>$CI_PROJECT_PATH_SLUG, </code>если его оставить, то приложение развернётся с путем <code>http://mopckou-coolapp-staging.awesomeservice.tech</code>.</p><p>Выглядит стрёмно, поэтому для окружения <code>qa01</code> и <code>qa02</code> избавимся от этого префикса. И наконец, добавим ручной выбор, в какое окружение деплоить приложения в блоке <code>rules</code>. Вот так выглядят новенькие стадии <code>qa01</code> и <code>qa02</code>:</p><pre><code class="yaml">qa01:
  extends: .auto-deploy
  stage: qa
  script:
    - auto-deploy check_kube_domain
    - auto-deploy download_chart
    - auto-deploy ensure_namespace
    - auto-deploy initialize_tiller
    - auto-deploy create_secret
    - auto-deploy deploy
  environment:
    name: qa01
    url: http://qa01.coolapp.$KUBE_INGRESS_BASE_DOMAIN  # убрал префикс $CI_PROJECT_PATH_SLUG-
  rules:
    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == ""'
      when: never # не трогаем
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: never # эта стадия не запускается если ветка называется main (default branch)
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'
      when: manual # для ручного выбора куда деплоить

qa02: # копирка предыдущего блока, просто заменил qa01 на qa02
  extends: .auto-deploy
  stage: qa
  script:
    - auto-deploy check_kube_domain
    - auto-deploy download_chart
    - auto-deploy ensure_namespace
    - auto-deploy initialize_tiller
    - auto-deploy create_secret
    - auto-deploy deploy
  environment:
    name: qa02
    url: http://qa02.coolapp.$KUBE_INGRESS_BASE_DOMAIN
  rules:
    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == ""'
      when: never
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'
      when: manual</code></pre><p>Эти стадии можно сделать более читаемыми с помощью якорей. Следующая запись полностью эквивалентна предыдущей:</p><pre><code class="yaml">.qa_env_setup: &amp;qa_setup
  extends: .auto-deploy
  stage: qa
  script:
    - auto-deploy check_kube_domain
    - auto-deploy download_chart
    - auto-deploy ensure_namespace
    - auto-deploy initialize_tiller
    - auto-deploy create_secret
    - auto-deploy deploy
  rules:
    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == ""'
      when: never
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'
      when: manual


qa01:
  &lt;&lt;: *qa_setup
  environment:
    name: qa01
    url: http://qa01.coolapp.$KUBE_INGRESS_BASE_DOMAIN

qa02:
  &lt;&lt;: *qa_setup
  environment:
    name: qa02
    url: http://qa02.coolapp.$KUBE_INGRESS_BASE_DOMAIN</code></pre><p>А для остальных этапов (<code>staging</code>, <code>canary</code>, <code>production</code>) придется так же переопредилить URL, чтобы избавиться от некрасивого префикса.</p><pre><code class="yaml">staging:
  extends: .auto-deploy
  environment:
    name: staging
    url: http://staging.coolapp.$KUBE_INGRESS_BASE_DOMAIN

.url: &amp;production_url
  environment:
    name: production
    url: http://coolapp.$KUBE_INGRESS_BASE_DOMAIN

production_manual:
  extends: .auto-deploy
  &lt;&lt;: *production_url

production:
  extends: .auto-deploy
  &lt;&lt;: *production_url

canary:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 10%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 25%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 50%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 100%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 10%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 25%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 50%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 100%:
  extends: .auto-deploy
  &lt;&lt;: *production_url
</code></pre><details class="spoiler"><summary>Полный gitlab-ci.yml</summary><div class="spoiler__content"><pre><code class="yaml">variables:
  ROLLOUT_RESOURCE_TYPE: deployment  # без этого деплой фейлится
  REVIEW_DISABLED: "true"
  CANARY_ENABLED: "true"


stages:
  - build
  - review  # off stage
  - qa
  - staging
  - canary
  - production
  - incremental rollout 10%
  - incremental rollout 25%
  - incremental rollout 50%
  - incremental rollout 100%
  - cleanup  # off stage


.qa_env_setup: &amp;qa_setup
  extends: .auto-deploy
  stage: qa
  script:
    - auto-deploy check_kube_domain
    - auto-deploy download_chart
    - auto-deploy ensure_namespace
    - auto-deploy initialize_tiller
    - auto-deploy create_secret
    - auto-deploy deploy
  rules:
    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == ""'
      when: never
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'
      when: manual

.production_env_setup: &amp;production_url
  environment:
    name: production
    url: http://coolapp.$KUBE_INGRESS_BASE_DOMAIN


qa01:
  &lt;&lt;: *qa_setup
  environment:
    name: qa01
    url: http://qa01.coolapp.$KUBE_INGRESS_BASE_DOMAIN

qa02:
  &lt;&lt;: *qa_setup
  environment:
    name: qa02
    url: http://qa02.coolapp.$KUBE_INGRESS_BASE_DOMAIN

staging:
  extends: .auto-deploy
  environment:
    name: staging
    url: http://staging.coolapp.$KUBE_INGRESS_BASE_DOMAIN

production_manual:
  extends: .auto-deploy
  &lt;&lt;: *production_url

production:
  extends: .auto-deploy
  &lt;&lt;: *production_url

canary:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 10%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 25%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 50%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 100%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 10%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 25%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 50%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 100%:
  extends: .auto-deploy
  &lt;&lt;: *production_url


include:
  - template: Jobs/Build.gitlab-ci.yml
  - template: Jobs/Deploy.gitlab-ci.yml

</code></pre></div></details><p>Пушим изменения и наблюдаем за новеньким конвейером:</p><figure class="bordered full-width "><img src="/img/image-loader.svg" height="720" data-src="https://habrastorage.org/getpro/habr/upload_files/b4f/0b3/cef/b4f0b3cef5f2ac6e336822cad753d5cf.gif" data-width="1280"/><figcaption></figcaption></figure><p>Приложение успешно развёрнуто в окружении <code>qa01</code> и <code>qa02</code>. Посмотрим теперь детализацию этапа <code>qa01</code>:</p><figure class="full-width "><img src="/img/image-loader.svg" height="382" data-src="https://habrastorage.org/getpro/habr/upload_files/45c/7e4/387/45c7e4387aa72a5de7e30d1feafd8e18.png" data-width="1226"/><figcaption></figcaption></figure><p>Приложение развёрнуто с поддоменом <code>qa01.coolapp</code>. Проверим работу:</p><figure class="full-width "><img src="/img/image-loader.svg" height="234" data-src="https://habrastorage.org/getpro/habr/upload_files/7ee/1ff/d88/7ee1ffd88a84bfaf04b74854721add19.png" data-width="1452"/><figcaption></figcaption></figure><p>Приложение отвечает и отдает <code>uuid</code> по запросу. Chrome ругается на незащищенное HTTP-соединение, но настройка сертификатов выходит за рамки этой статьи. </p><p>В GitLab есть удобная борда для мониторинга под в каждом окружении. Перейдите в Deployments → Environments.<strong> </strong></p><figure class="full-width "><img src="/img/image-loader.svg" height="890" data-src="https://habrastorage.org/getpro/habr/upload_files/df0/b34/7eb/df0b347eb56ea832bcca89beefe9fca0.png" data-width="2432"/><figcaption></figcaption></figure><p>Но в данный момент она не работает. Панель включается только когда у каждой поды есть аннотация: <code>app.gitlab.com/app=$CI_PROJECT_PATH_SLUG</code> и <code>app.gitlab.com/env=$CI_ENVIRONMENT_SLUG</code>. Ребята из GitLab позаботились о нас и в Helm-чарте пробрасывают аннотацию подам, нам надо лишь переопределить эти параметры. Есть специальная переменная окружения<code>HELM_UPGRADE_EXTRA_ARGS</code>, с помощью которой можно переопределить любой параметр из <a href="https://gitlab.com/gitlab-org/cluster-integration/auto-deploy-image/-/blob/master/assets/auto-deploy-app/values.yaml">Helm-чарта</a>.</p><p>Эту переменную я указал в <code>gitlab-ci.yaml</code> проекта в блоке <code>variables</code>, чтобы все переменные окружения были в одном месте. Но, конечно, все их можно указать на сайте в настройках вашего проекта в GitLab. </p><pre><code class="yaml">  HELM_UPGRADE_EXTRA_ARGS: "--set gitlab.env=$CI_ENVIRONMENT_SLUG,gitlab.app=$CI_PROJECT_PATH_SLUG"
</code></pre><details class="spoiler"><summary>Теперь уже точно полный gitlab-ci.yaml. Честно-честно!</summary><div class="spoiler__content"><pre><code>variables:
  ROLLOUT_RESOURCE_TYPE: deployment
  REVIEW_DISABLED: "true"
  CANARY_ENABLED: "true"
  HELM_UPGRADE_EXTRA_ARGS: "--set gitlab.env=$CI_ENVIRONMENT_SLUG,gitlab.app=$CI_PROJECT_PATH_SLUG"


stages:
  - build
  - review  # off stage
  - qa
  - staging
  - canary
  - production
  - incremental rollout 10%
  - incremental rollout 25%
  - incremental rollout 50%
  - incremental rollout 100%
  - cleanup  # off stage


.qa_env_setup: &amp;qa_setup
  extends: .auto-deploy
  stage: qa
  script:
    - auto-deploy check_kube_domain
    - auto-deploy download_chart
    - auto-deploy ensure_namespace
    - auto-deploy initialize_tiller
    - auto-deploy create_secret
    - auto-deploy deploy
  rules:
    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == ""'
      when: never
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'
      when: manual

.production_env_setup: &amp;production_url
  environment:
    name: production
    url: http://coolapp.$KUBE_INGRESS_BASE_DOMAIN


qa01:
  &lt;&lt;: *qa_setup
  environment:
    name: qa01
    url: http://qa01.coolapp.$KUBE_INGRESS_BASE_DOMAIN

qa02:
  &lt;&lt;: *qa_setup
  environment:
    name: qa02
    url: http://qa02.coolapp.$KUBE_INGRESS_BASE_DOMAIN

staging:
  extends: .auto-deploy
  environment:
    name: staging
    url: http://staging.coolapp.$KUBE_INGRESS_BASE_DOMAIN

production_manual:
  extends: .auto-deploy
  &lt;&lt;: *production_url

production:
  extends: .auto-deploy
  &lt;&lt;: *production_url

canary:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 10%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 25%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 50%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

timed rollout 100%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 10%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 25%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 50%:
  extends: .auto-deploy
  &lt;&lt;: *production_url

rollout 100%:
  extends: .auto-deploy
  &lt;&lt;: *production_url


include:
  - template: Jobs/Build.gitlab-ci.yml
  - template: Jobs/Deploy.gitlab-ci.yml

</code></pre></div></details><p>Пушим изменения, деплоим в qa01 и qa02 и бежим в Deployments → Environments.</p><figure class="full-width "><img src="/img/image-loader.svg" height="894" data-src="https://habrastorage.org/getpro/habr/upload_files/258/2d1/0d6/2582d10d6f58dfad942f26d589dba1e6.png" data-width="2426"/><figcaption></figcaption></figure><p>Появилась доска с информацией, сколько под развёрнуто и в каком окружении. Эти зеленые квадратики, кстати, кликабельные, так можно сразу провалиться к логам поды, они транслируются в режиме онлайн.</p><p>С тестовым окружением мы закончили, теперь сливаем ветку в <s>master</s> <code>main</code>. И наблюдаем за красивым пайпланчиком в главной ветке:</p><figure class="full-width "><img src="/img/image-loader.svg" height="720" data-src="https://habrastorage.org/getpro/habr/upload_files/897/5b3/0ca/8975b30cacc4c2510ef417d7f4ca4466.gif" data-width="1280"/><figcaption></figcaption></figure><figure class="full-width "><img src="/img/image-loader.svg" height="1148" data-src="https://habrastorage.org/getpro/habr/upload_files/19d/c5e/d04/19dc5ed046156cd3e4e3e008c5ba4a8f.png" data-width="2428"/><figcaption></figcaption></figure><p>Приложение доступно по адресу:</p><p><a href="http://staging.coolapp.awesomeservice.tech/api/v1/uuid">http://staging.coolapp.awesomeservice.tech/api/v1/uuid</a> — для staging-окружения</p><figure class="full-width "><img src="/img/image-loader.svg" height="502" data-src="https://habrastorage.org/getpro/habr/upload_files/0e5/ea3/8b0/0e5ea38b0987973d1d31919e19770650.png" data-width="1700"/><figcaption></figcaption></figure><p><a href="http://coolapp.awesomeservice.tech/api/v1/uuid">http://coolapp.awesomeservice.tech/api/v1/uuid</a> — для prod-окружения</p><figure class="full-width "><img src="/img/image-loader.svg" height="526" data-src="https://habrastorage.org/getpro/habr/upload_files/be4/fa5/3f0/be4fa53f04711cdb41396a67023d5354.png" data-width="1702"/><figcaption></figcaption></figure><p>Масштабировать приложение очень просто. В переменных окружения проекта (Settings → CI/CD → Variables) создайте переменную <code>PRODUCTION_REPLICAS </code>с желаемым количеством под. </p><figure class="full-width "><img src="/img/image-loader.svg" height="358" data-src="https://habrastorage.org/getpro/habr/upload_files/f69/958/533/f6995853328927b5b15bb730718a522e.png" data-width="1840"/><figcaption></figcaption></figure><p>И запустите <em>Re-deploy</em> в панели:</p><figure class="full-width "><img src="/img/image-loader.svg" height="538" data-src="https://habrastorage.org/getpro/habr/upload_files/58e/c8d/20f/58ec8d20f6ebcac9bbf111a333288698.png" data-width="2430"/><figcaption></figcaption></figure><p>Приложение успешно расплодилось до пяти под.</p><figure class="full-width "><img src="/img/image-loader.svg" height="568" data-src="https://habrastorage.org/getpro/habr/upload_files/58d/2aa/dcf/58d2aadcfba0dec70dc020af200c53ff.png" data-width="2434"/><figcaption></figcaption></figure><p>По идее, на этой замечательной ноте можно бы закругляться. Но на десерт давайте всё-таки разберёмся, как работает канареечный деплой. <a href="#0">↑</a></p><a class="anchor" name="9" id="9"></a><h2>Разбираем канареечный деплой на практике</h2><p><a href="https://docs.gitlab.com/ee/user/project/canary_deployments.html">Суть</a> канареечного деплоя в том, что мы направляем часть продуктового трафика на новую версию приложения (какую часть в процентах, мы выбираем сами). Наблюдаем, как ведёт себя новое приложение; если нет ошибок, то перебрасываем весь трафик на новую версию; если всё плохо, то просто откатываемся на предыдущую стабильную версию. </p><p><strong>Достоинство:</strong> в случае ошибки страдает только небольшая часть пользователей, а не все, как при классическом деплое. <strong>Недостаток:</strong> надо понимать, что запрос от одного пользователя может попасть случайно как на стабильную версию, так и на новую канареечную. Это может привести к путанице и, возможно, к некоторым ошибкам. По идее, это можно решить настройкой <a href="https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies">sessionAffinity </a>для Kubernetes services.</p><p>Продемонстрирую на практике. Изменим код приложения, чтобы по его ответу сразу было понятно, что это новая версия. Добавим в ответ ручки <code>/api/v1/uuid</code> ещё один ключ <code>time</code>:</p><pre><code class="python">from time import ctime

from fastapi import FastAPI, Cookie
from typing import Optional
from uuid import uuid4

app = FastAPI()
uuid = uuid4()


@app.get("/api/v1/uuid")
async def root(key: Optional[str] = Cookie(None)):
    print(key)
    return {
        'uuid': uuid,
        'time': ctime()
    }


@app.get("/healthz")
async def health_check():
    return {}
</code></pre><p>Пушим изменение и ждём, пока отработает deploy в staging-окружении:</p><figure class="full-width "><img src="/img/image-loader.svg" height="708" data-src="https://habrastorage.org/getpro/habr/upload_files/140/062/a8d/140062a8d771e63645a2aa60e1512458.png" data-width="1956"/><figcaption></figcaption></figure><p>Как только вы запустите canary stage, в том же пространстве имён запустится такое же количество под с новой версией приложения. В названии под есть специальный префикс <code>-canary-</code>:</p><figure class="full-width "><img src="/img/image-loader.svg" height="542" data-src="https://habrastorage.org/getpro/habr/upload_files/095/f8d/72f/095f8d72f11cffe5f764cd46e3170697.png" data-width="1772"/><figcaption></figcaption></figure><p>Пока что весь трафик на старой версии приложения. Как только вы нажмете на конвейере на этап с процентом, то выбранная доля трафика станет поступать на канареечные поды.</p><figure class="full-width "><img src="/img/image-loader.svg" height="750" data-src="https://habrastorage.org/getpro/habr/upload_files/e08/44f/d87/e0844fd87343a2093e4131896517e788.png" data-width="2028"/><figcaption></figcaption></figure><p>Теперь взглянем на панель окружений.</p><figure class="full-width "><img src="/img/image-loader.svg" height="602" data-src="https://habrastorage.org/getpro/habr/upload_files/8b7/0d9/13a/8b70d913ac64cb66c340585549d789a1.png" data-width="2410"/><figcaption></figcaption></figure><p>Видно, что прибавилось ещё пять под с жёлтым кружочком, это обозначение канареечной поды. На панели можно менять соотношение трафика в любую сторону, и даже пустить весь поток на новую версию приложения.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Трафик поступает то на канареечную поду, то на стабильную версию приложения. Соотношение трафика 50/50" title="Трафик поступает то на канареечную поду, то на стабильную версию приложения. Соотношение трафика 50/50" height="720" data-src="https://habrastorage.org/getpro/habr/upload_files/fcb/479/faf/fcb479faf3587910e98c8a9718d1cc03.gif" data-width="1280"/><figcaption>Трафик поступает то на канареечную поду, то на стабильную версию приложения. Соотношение трафика 50/50</figcaption></figure><p>В конвейере долю трафика можно менять как в большую сторону, так и в меньшую. Но как только вы нажмете на 100 %, весь трафик перейдёт на канареечные поды, в это время будут созданы поды с новой версией микросервиса и старое приложение начнёт удаляться. </p><figure class="full-width "><img src="/img/image-loader.svg" height="688" data-src="https://habrastorage.org/getpro/habr/upload_files/f49/f71/7e8/f49f717e8e6fa01a92168f0a6e080c88.png" data-width="1862"/><figcaption></figcaption></figure><p>Как только все новые будут запущены, а трафик на них переключится, канареечные поды начнут удаляться. </p><figure class="full-width "><img src="/img/image-loader.svg" height="658" data-src="https://habrastorage.org/getpro/habr/upload_files/728/d23/298/728d2329859b9db64b4f81473b87c887.png" data-width="1842"/><figcaption></figcaption></figure><p>На этом процесc деплоя на новую версию закончен. <a href="#0">↑</a></p><figure class="full-width "><img src="/img/image-loader.svg" height="372" data-src="https://habrastorage.org/getpro/habr/upload_files/655/318/30d/65531830d33feb341595eab02e5bd5f1.png" data-width="1780"/><figcaption></figcaption></figure><a class="anchor" name="10" id="10"></a><h2>TL;DR</h2><blockquote><p>1. <a href="#1">Установите</a> кластер на голое железо.</p><p>2. Купите доменное имя (<a href="#5">подробнее тут</a>), у меня это <code>awesomeservice.tech</code><strong>. </strong>И зарегистрируйте четыре поддомена: <code>coolapp.</code>, <code>staging.coolapp.</code>, <code>qa01.coolapp</code>, <code>qa02.coolapp</code>.<strong> </strong>В моем случае:</p><p>-<strong> coolapp.</strong>awesomeservice.tech</p><p>- <strong>staging.coolapp</strong>.awesomeservice.tech</p><p>-<strong> qa01.coolapp</strong>.awesomeservice.tech</p><p>-<strong> qa02.coolapp.</strong>awesomeservice.tech</p><p>Поддоменные имена легко меняются в gitlab-ci.yaml (см. следующий пункт).</p><p>3. Форкните готовый <a href="https://gitlab.com/Mopckou/coolapp">шаблон</a> проекта на Python. Там уже есть настроенный gitlab-ci.yaml.</p><p>4. <a href="#7">Подключите</a> свой кластер Куба к проекту в GitLab. После чего в настройках укажите <code>base domain</code>. У меня это <code>awesomeservice.tech</code>.</p><p>5. <a href="#8">Активируйте</a> в проекте <strong>AutoDevops</strong>.</p></blockquote><p>Создайте конвейер и наслаждайтесь:</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Pipeline в любой дочерней ветке" title="Pipeline в любой дочерней ветке" height="720" data-src="https://habrastorage.org/getpro/habr/upload_files/ab0/06b/ffb/ab006bffb1058a0439b02f81bb40b67f.gif" data-width="1280"/><figcaption>Pipeline в любой дочерней ветке</figcaption></figure><figure class="full-width "><img src="/img/image-loader.svg" alt="
Pipeline в главной ветке" title="
Pipeline в главной ветке" height="720" data-src="https://habrastorage.org/getpro/habr/upload_files/aa1/50c/a9b/aa150ca9becfb645d0592e80df2bbab5.gif" data-width="1280"/><figcaption>
Pipeline в главной ветке</figcaption></figure><hr/><p>В итоге мы создали свой небольшой Kubernetes кластер, состоящий из двух нод, и всё это на голом железе. И что важно — настроили в GitLab автодеплой приложения. На этой прекрасной ноте можно заканчивать.  </p><details class="spoiler"><summary>Релизные практики. Best practice</summary><div class="spoiler__content"><div class="tm-iframe_temp" data-src="https://embedd.srv.habr.com/iframe/61661f90f61f533babdf2eca" data-style="" id="61661f90f61f533babdf2eca" width=""></div></div></details><details class="spoiler"><summary>Пссс... парень</summary><div class="spoiler__content"><figure class="full-width "><img src="/img/image-loader.svg" height="807" data-src="https://habrastorage.org/getpro/habr/upload_files/9ca/43c/6bc/9ca43c6bc9cb81c5fc1205e481ace983.png" data-width="749"/><figcaption></figcaption></figure><p><a href="https://gitlab.com/Mopckou/coolapp">GitLab</a></p></div></details></div></div> <!----> <div class="tm-article-poll"><div class="tm-notice tm-article-poll__notice tm-notice_positive"><!----> <div class="tm-notice__inner"><!----> <div class="tm-notice__content"><span>Только зарегистрированные пользователи могут участвовать в опросе. <a rel="nofollow" href="/kek/v1/auth/habrahabr/?back=/ru/company/domclick/blog/577964/&hl=ru">Войдите</a>, пожалуйста.</span></div></div></div> <div class="tm-article-poll__header">Вопрос, который давно меня беспокоит. Что всё-таки лучше?</div> <div class="tm-article-poll__answers"><div class="tm-article-poll__answer"><div class="tm-article-poll__answer-data"><span class="tm-article-poll__answer-percent">
            38%
          </span> <span class="tm-article-poll__answer-label">Симпл-димпл</span> <span class="tm-article-poll__answer-votes">
            19
          </span></div> <div class="tm-article-poll__answer-bar"><div class="tm-article-poll__answer-progress" style="width:38%;"></div></div></div><div class="tm-article-poll__answer"><div class="tm-article-poll__answer-data"><span class="tm-article-poll__answer-percent tm-article-poll__answer-percent_winning">
            62%
          </span> <span class="tm-article-poll__answer-label">Нет! Попыт!</span> <span class="tm-article-poll__answer-votes">
            31
          </span></div> <div class="tm-article-poll__answer-bar"><div class="tm-article-poll__answer-progress tm-article-poll__answer-progress_winning" style="width:62%;"></div></div></div></div> <div class="tm-article-poll__stats">
       Проголосовали 50 пользователей. 

       Воздержались 29 пользователей. 
    </div></div></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bci%2Fcd%5D" class="tm-tags-list__link">ci/cd</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bgitlab%5D" class="tm-tags-list__link">gitlab</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bkubernetes%5D" class="tm-tags-list__link">kubernetes</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bself-hosted%5D" class="tm-tags-list__link">self-hosted</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bautodevops%5D" class="tm-tags-list__link">autodevops</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/company/domclick/blog/" class="tm-hubs-list__link router-link-active">
    Блог компании ДомКлик
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/devops/" class="tm-hubs-list__link">
    DevOps
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/kubernetes/" class="tm-hubs-list__link">
    Kubernetes
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 40: ↑39 и ↓1</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 40: ↑39 и ↓1" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+38</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">10K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    167
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"><div class="tm-article-author__company"><div class="tm-article-author__company-card"><div class="tm-company-snippet"><a href="/ru/company/domclick/profile/" class="tm-company-snippet__logo-link"><div class="tm-entity-image"><img alt="" height="40" src="//habrastorage.org/getpro/habr/company/d28/115/f55/d28115f5503229d4f9018292fabd1840.jpg" width="40" class="tm-entity-image__pic"></div></a> <div class="tm-company-snippet__info"><a href="/ru/company/domclick/profile/" class="tm-company-snippet__title">Домклик</a> <div class="tm-company-snippet__description">Место силы</div></div></div> <div class="tm-article-author__buttons"><!----> <!----></div></div> <div class="tm-article-author__company-contacts"><a href="https://domclick.ru/" rel="noopener" target="_blank" class="tm-article-author__contact">
      Сайт
    </a><a href="https://team.domclick.ru/" rel="noopener" target="_blank" class="tm-article-author__contact">
      Сайт
    </a></div> <div class="tm-article-author__separator"></div></div> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/Mopckou/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/cf7/5a0/cfa/cf75a0cfaa7d58688f230e90fa0042d5.jpg" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 36 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    36
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">38</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Алексей Ермаков</span> <a href="/ru/users/Mopckou/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @Mopckou
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Python Developer</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/company/domclick/blog/577964/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 27 
    </span></a> <!----></div></div></div>  <!---->  <!----> <!----></div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__placeholder_initial"></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <section class="tm-block tm-block_spacing-bottom"><header class="tm-block__header"><h2 class="tm-block__title">Информация</h2> <!----></header> <div class="tm-block__body"><div class="tm-company-basic-info"><dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата основания</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2015-07-18T21:00:00.000Z" title="2015-07-19, 00:00">19  июля  2015</time></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Местоположение</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    Россия
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Сайт</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><a href="https://domclick.ru/" target="_blank" class="tm-company-basic-info__link">
      domclick.ru
    </a></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Численность</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    501–1 000 человек
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата регистрации</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2020-03-17T09:21:32.000Z" title="2020-03-17, 12:21">17  марта  2020</time></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Представитель</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><a href="/ru/users/malanshakova/" class="tm-company-basic-info__link">
      Мария Ланшакова
    </a></dd></dl></div></div> <!----></section> <div class="tm-company-widgets"></div> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/company/domclick/blog/577964/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/company/domclick/blog/577964/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"577964":{"id":"577964","timePublished":"2021-10-14T08:02:07+00:00","isCorporative":true,"lang":"ru","titleHtml":"Ультимативный гайд по созданию CI\u002FCD в GitLab с автодеплоем в Kubernetes на голом железе всего за 514$ в год ( ͡° ͜ʖ ͡°)","leadData":{"textHtml":"\u003Cp\u003EШел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выходят статьи о создании неубиваемых Kubernetes-кластеров, которые, по видимому, всех нас переживут. А кто-нибудь подумал о простых пацанах (пацанессах)??? Как быть обычному программисту, который хочет свой небольшой кластер и ламповый CI\u002FCD с автодеплоем приложения, чтобы кенты с района не засмеяли?\u003C\u002Fp\u003E\u003Cp\u003EВсем привет, меня зовут Алексей и я \u003Cs\u003Eалкоголик\u003C\u002Fs\u003E разработчик на Python\u002FGo в Домклик. Сегодня мы будем понижать порог входа в self-hosted Kubernetes и GitLab AutoDevops.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a5\u002F067\u002F42f\u002F3a506742f30c010e5f909a0f744d3470.jpg","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a5\u002F067\u002F42f\u002F3a506742f30c010e5f909a0f744d3470.jpg","fit":"cover","positionY":0,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[{"type":"tutorial","data":null}],"author":{"scoreStats":{"score":36,"votesCount":36},"rating":38,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"1820241","alias":"Mopckou","fullname":"Алексей Ермаков","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Fcf7\u002F5a0\u002Fcfa\u002Fcf75a0cfaa7d58688f230e90fa0042d5.jpg","speciality":"Python Developer"},"statistics":{"commentsCount":27,"favoritesCount":167,"readingCount":10249,"score":38,"votesCount":40},"hubs":[{"relatedData":null,"id":"22422","alias":"domclick","type":"corporative","title":"Блог компании ДомКлик","titleHtml":"Блог компании ДомКлик","isProfiled":false},{"relatedData":null,"id":"20788","alias":"devops","type":"collective","title":"DevOps","titleHtml":"DevOps","isProfiled":true},{"relatedData":null,"id":"22196","alias":"kubernetes","type":"collective","title":"Kubernetes","titleHtml":"Kubernetes","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"6","alias":"admin","title":"Администрирование"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fdd9\u002F7fd\u002Fb3b\u002Fdd97fdb3bb7dc37f60dc3c21c4ffd56a.jpg\" width=\"780\" height=\"458\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fdd9\u002F7fd\u002Fb3b\u002Fdd97fdb3bb7dc37f60dc3c21c4ffd56a.jpg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EШел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выходят статьи о создании неубиваемых Kubernetes-кластеров, которые, по видимому, всех нас переживут. А кто-нибудь подумал о простых пацанах (пацанессах)??? Как быть обычному программисту, который хочет свой небольшой кластер и ламповый CI\u002FCD с автодеплоем приложения, чтобы кенты с района не засмеяли?\u003C\u002Fp\u003E\u003Cp\u003EВсем привет, меня зовут Алексей и я \u003Cs\u003Eалкоголик\u003C\u002Fs\u003E разработчик на Python\u002FGo в Домклик. Сегодня мы будем понижать порог входа в self-hosted Kubernetes и GitLab AutoDevops.\u003C\u002Fp\u003E\u003Cp\u003EЭто очередная статья из серии «ультимативных». Мы уже писали раньше, например, о том, как выглядит\u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompany\u002Fdomclick\u002Fblog\u002F531254\u002F\"\u003E асинхронное приложение\u003C\u002Fa\u003E здорового человека. Или \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompany\u002Fdomclick\u002Fblog\u002F532030\u002F\"\u003Eгайд по поиску\u003C\u002Fa\u003E утечек памяти в Python. Сегодня тоже будет весело. \u003C\u002Fp\u003E\u003Cp\u003EСтатья получилась довольно большая, поэтому после каждой главы будет стрелочка \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E, нажав на которую вы обратно перейдёте к оглавлению. Те, кто хочет всё и сразу — переходите к разделу \u003Cstrong\u003ETL;DR\u003C\u002Fstrong\u003E, там будет краткая выжимка из статьи.\u003C\u002Fp\u003E\u003Chr\u002F\u003E\u003Ca class=\"anchor\" name=\"0\" id=\"0\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EОглавление\u003C\u002Fh2\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#%D0%92%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5\"\u003EВведение\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#1\"\u003EУстановка Kubernetes на голое железо\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#1\"\u003EУстановка Kubernetes\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#2\"\u003EУстановка Helm\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#3\"\u003EУстановка Ingress-nginx\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#4\"\u003EУстановка Metallb\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#5\"\u003EНастройка CI\u002FCD в Gitlab\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#5\"\u003EВыбираем доменное имя для сервиса\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#6\"\u003EСоздание проекта в GitLab\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#7\"\u003EИнтеграция Kubernetes-кластера\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#8\"\u003EНастройка GitLab AutoDevops\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#9\"\u003EРазбираем канареечный деплой на практике\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ca href=\"#10\"\u003ETL;DR\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Chr\u002F\u003E\u003Ca class=\"anchor\" name=\"%D0%92%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5\" id=\"Введение\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EВведение\u003C\u002Fh2\u003E\u003Cp\u003EНачнем с самого животрепещущего — с ценообразования. Откуда взялись эти 514$? \u003C\u002Fp\u003E\u003Cp\u003EЕсли в вас живет маленький стартапер, то вам рано или поздно придется где-то развернуть свой кластер и настроить автоматическую поставку приложения в production-окружение (не руками же деплоить в 2к21?). Платить жадным гигантам по типу гугла или амазона огромные деньги — это зашквар. Денях-то нет, вот мы и держимся. Поэтому я решил попробовать собрать свой кластер и настроить CI\u002FCD за минимально возможные средства, но при этом попытался не перегибать палку в чрезмерной экономии. \u003C\u002Fp\u003E\u003Cp\u003EКластер решил делать минимальный, состоящий из двух узлов — master и worker. Обе машины имеют конфигурацию 2x2,2 ГГц, 4 Гб RAM, 40 Гб SSD. Аренда одной в месяц ~ 12$. В год за две машины ~ 278$. Платил в рублях, перевел в доллары для удобства дальнейших расчетов (курс 72 р).\u003C\u002Fp\u003E\u003Cp\u003ECI\u002FCD решил реализовывать в GitLab (лежит к нему душа). И как оказалось, это довольно большая статья расходов. Еще в начале года был silver-аккаунт, с более менее приличными ценами ~ 9$ в месяц. Но сейчас его упразднили и на его место пришел premium за 19$ в месяц или 228$ в год. Естественно, там много плюшек типа овер-дофига CI-минут, канареечный деплой, защищенные переменные окружения, дашборд окружений Куба и т.д., но цена довольно кусачая.\u003C\u002Fp\u003E\u003Cp\u003EТретья статья, самая маленькая — покупка доменного имени. Мне обошлось в 8$ за первый год (за последующие там вроде в два раза больше берут).\u003C\u002Fp\u003E\u003Cp\u003EИтого: 278$ + 228$ + 8$ = 514$.\u003C\u002Fp\u003E\u003Cp\u003EА что, если купить еще один VPS и установить туда GitLab? Официальная документация \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Finstall\u002Frequirements.html#memory\"\u003Eрекомендует\u003C\u002Fa\u003E использовать машину с двумя ядрами и 4 Гб оперативы. Если брать VPS у того же провайдера, то выйдет 12$ в месяц, а в год — 144$. Экономия в таком случае 84$ за год. Но тут прибавляется забота об установке, настройке, администрировании GitLab. И не уверен, насколько полная функциональность в таком случае будет доступна. Знатоки self-managed GitLab, напишите в коменты. \u003C\u002Fp\u003E\u003Cp\u003EВ итоге я решил не заморачиваться с установкой своего GitLab и весь материал статьи отрабатывал на конфигурации за 514$. Но вот только пару дней назад, неудовлетворенный качеством предоставляемых облачным провайдером услуг, решил погуглить в надежде на более дешевые альтернативы. Оказалось, что есть машины не просто дешевле, так ещё и мощнее. Например, предлагают в аренду VPS [3x2,8 ГГц, 5 Гб RAM, 60 Гб SSD] за 9$ и [2x2,8 ГГц, 2 Гб RAM, 40 Гб SSD] за 6$ в месяц. За год выйдет: (9$ + 6$) * 12 + 228$ + 8$ = 416$. В будущем планирую арендовать машины именно у этого провайдера.\u003C\u002Fp\u003E\u003Cp\u003EВывод: если задаться целью максимально сэкономить, то варианты найдутся. А на этом вступление окончено. Дальше будет долго, нудно и моментами даже чересчур подробно; думаю, полностью прочтут эту статью два человека: я и наш шеф-редактор блога (за что ему большое спасибо!). \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"1\" id=\"1\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EУстановка Kubernetes на голое железо\u003C\u002Fh2\u003E\u003Ch3\u003EУстановка Kubernetes\u003C\u002Fh3\u003E\u003Cp\u003EВам легко будет установить по этой замечательной \u003Ca href=\"https:\u002F\u002Fwww.reg.ru\u002Fsupport\u002Fvps-servery\u002Foblachnie-serveri-vps\u002Fustanovka-programmnogo-obespechenija\u002Fkubernetes\"\u003Eинструкции\u003C\u002Fa\u003E. Но в ней есть ряд критических моментов, которые я разобрал под спойлером.\u003C\u002Fp\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EПодсказки по установке Kubernetes на Ubuntu 20.04 LTS\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EУстановка делится на этапы и пункты. Здесь показаны те пункты, в которых возникает ошибка.\u003C\u002Fp\u003E\u003Ch3\u003EЭтап 1. Пункт 4.\u003C\u002Fh3\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Esudo systemctl enable docker\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЕсли выполнить эту команду, будет ошибка:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"80\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F804\u002F10f\u002Fad9\u002F80410fad9beda70d7dadfac5662de297.png\" data-width=\"1368\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПоэтому откройте файл \u003Cem\u003E\u002Fetc\u002Fhosts\u003C\u002Fem\u003E:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Enano \u002Fetc\u002Fhosts\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВ моем случае не определен хост \u003Cem\u003Eruvds-2p1sn\u003C\u002Fem\u003E, мне надо добавить:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E127.0.0.1 ruvds-2p1sn\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EА также в этом файле введите следующее имя (это для master-ноды; когда будете повторять для worker-ноды, то введите \u003Ccode\u003Ekubernetes-worker\u003C\u002Fcode\u003E)\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003E127.0.0.1 kubernetes-master\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EУ меня файл выглядит так:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"330\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F576\u002F40a\u002F542\u002F57640a542728589bc045af3e85cf0da6.png\" data-width=\"1026\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСохраняем и выходим. После чего можно выполнить команду:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Esudo systemctl enable docker\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Ch3\u003EЭтап 2. Пункт 1.\u003C\u002Fh3\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ecurl -s https:\u002F\u002Fpackages.cloud.google.com\u002Fapt\u002Fdoc\u002Fapt-key.gpg | sudo apt-key add\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЭта команда приведёт к ошибке:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"226\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F31a\u002F98f\u002Fe69\u002F31a98fe6919959b34a12496a29bdf5a1.png\" data-width=\"1942\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЗдесь нужно установить \u003Cem\u003Ecurl\u003C\u002Fem\u003E. Скопируйте предложенную в консоли команду и выполните:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Eapt install curl\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПотом выполните такую команду:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Eapt-get update &amp;&amp; apt-get install -y gnupg2\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EГотово. Теперь уже выполняем команду из пункта 1 второго этапа.\u003C\u002Fp\u003E\u003Ch3\u003EЭтап 2. Пункт 2.\u003C\u002Fh3\u003E\u003Cpre\u003E\u003Ccode\u003Esudo apt-add-repository \"deb http:\u002F\u002Fapt.kubernetes.io\u002F kubernetes-xenial main\"\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЭта команда приведёт к ошибке:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"71\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F91e\u002F9df\u002Fd43\u002F91e9dfd438b388a7b377f62922535793.png\" data-width=\"1746\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Esudo apt-get install software-properties-common\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EИ возвращайтесь к команде пункта 2.\u003C\u002Fp\u003E\u003Ch3\u003EЭтап 2. Пункт 3.\u003C\u002Fh3\u003E\u003Cp\u003EПредыдущие ошибки легко гуглятся и решаются одной командой. А вот с этой командой сложнее:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Esudo apt install kubeadm kubelet kubectl\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЕще в начале этого года с ней не было проблем. Но на момент написания статьи эта команда приводит к проблеме инициализации master-ноды на \u003Cstrong\u003Eэтапе 3 пункт 4\u003C\u002Fstrong\u003E. Что изменилось? Вышла новая версия утилиты — \u003Cstrong\u003E1.22.2.\u003C\u002Fstrong\u003E В начале же года я ставил версию \u003Cstrong\u003E1.20.2\u003C\u002Fstrong\u003E и всё было хорошо. Причину сбоя инициализации я на просторах интернета не нашел. Почти все руководства по установке не указывают конкретную версию утилит. А мы это исправим:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Esudo apt install kubeadm=1.20.2-00 kubelet=1.20.2-00 kubectl=1.20.2-00\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВам же я предлагаю сначала попробовать с последней версией (если это, конечно, не 1.22.2), и если в пункте 4 этапа 3 есть проблемы, то возвращайтесь сюда и откатывайтесь на версию \u003Cstrong\u003E1.20.2\u003C\u002Fstrong\u003E.\u003C\u002Fp\u003E\u003Cp\u003EИ обязательно надо выполнить эту команду:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Esudo apt-mark hold kubeadm kubelet kubectl\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Ch3\u003EЭтап 3. Пункт 1.\u003C\u002Fh3\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Esudo swapoff –a\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЭта команда нерабочая. Будет ошибка:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"72\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fefe\u002F56f\u002Fe73\u002Fefe56fe7315d7ccd577439ed41500975.png\" data-width=\"1068\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЯ заморочился и даже сравнил с перепечатанной командой вручную.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"456\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff85\u002F8de\u002F61f\u002Ff858de61f85648c3f5596e7c624a056f.png\" data-width=\"1810\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EОказалось, что тирешка вовсе не тирешка -_- . Используйте эту команду:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Esudo swapoff -a\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Ch3\u003EЭтап 3. Пункт 4.\u003C\u002Fh3\u003E\u003Cp\u003EНа этом этапе есть \u003Cstrong\u003E!критическое!\u003C\u002Fstrong\u003E замечание. Нужно выполнить такую команду:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Esudo kubeadm init --pod-network-cidr=10.244.0.0\u002F16\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EДа, обязательно нужно добавить этот странный диапазон IP-адресов. Это нужно для сетевого плагина \u003Cstrong\u003EFlannel\u003C\u002Fstrong\u003E, который устанавливается далее по инструкции.\u003C\u002Fp\u003E\u003Ch2\u003EЭтап 3. Пункт 7.\u003C\u002Fh2\u003E\u003Cp\u003EТут команда верная, но адрес слетел на следующую строку. Используйте это:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Esudo kubectl apply -f https:\u002F\u002Fraw.githubusercontent.com\u002Fcoreos\u002Fflannel\u002Fmaster\u002FDocumentation\u002Fkube-flannel.yml\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EНа этом всё. Повторяйте инструкцию для worker-ноды (исключая некоторые пункты, которые нужны только для master-узла).\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cp\u003E\u003Cstrong\u003EUPD 21.10.21 \u003C\u002Fstrong\u003EПопробовал\u003Cstrong\u003E \u003C\u002Fstrong\u003Eустановить кластер и на \u003Ccode\u003ECentOS 8\u003C\u002Fcode\u003E по этой \u003Ca href=\"https:\u002F\u002Fupcloud.com\u002Fcommunity\u002Ftutorials\u002Finstall-kubernetes-cluster-centos-8\u002F\"\u003Eинструкции\u003C\u002Fa\u003E. Проблем практически не было (в отличии от \u003Ccode\u003EUbuntu\u003C\u002Fcode\u003E), инструкция очень даже рабочая. Но есть пару моментов, на которые хочу обратить внимание под спойлером.\u003C\u002Fp\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EПодсказки по установке Kubernetes на CentOS 8.\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EПочти все команды с \u003Ccode\u003Ecat -\u003C\u002Fcode\u003Eнерабочие, я их тут поправил. Команда в пункте 6:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ecat &lt;&lt;EOF\u003E \u002Fetc\u002Fsysctl.d\u002Fk8s.conf\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nEOF\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EИ команда в пункте 1 следующего раздела:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ecat &lt;&lt;EOF\u003E \u002Fetc\u002Fyum.repos.d\u002Fkubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https:\u002F\u002Fpackages.cloud.google.com\u002Fyum\u002Frepos\u002Fkubernetes-el7-\\$basearch\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https:\u002F\u002Fpackages.cloud.google.com\u002Fyum\u002Fdoc\u002Fyum-key.gpg https:\u002F\u002Fpackages.cloud.google.com\u002Fyum\u002Fdoc\u002Frpm-package-key.gpg\nexclude=kubelet kubeadm kubectl\nEOF\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EОчень важный момент - в этой инструкции для фаервола добавляют некоторые исключения и доверительные хосты. Если следовать чисто по статье, то в последствии не получится достучаться до ingress-nginx (лично у меня не получилось). Поэтому я решил просто \u003Ca href=\"https:\u002F\u002Flinuxconfig.org\u002Fredhat-8-stop-start-firewall\"\u003Eвыключить\u003C\u002Fa\u003E фаервол (все-таки поднимаем dev кластер).\u003C\u002Fp\u003E\u003Cp\u003EИ в отличии от Ubuntu на CentOS 8 я смог поставить самую крайнюю (1.22.2) версию куба.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cp\u003EПоздравляю! Теперь у вас есть свой собственный Kubernetes кластер! \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"2\" id=\"2\"\u003E\u003C\u002Fa\u003E\u003Ch3\u003EУстановка Helm\u003C\u002Fh3\u003E\u003Cp\u003EИнструкция взята с официального \u003Ca href=\"https:\u002F\u002Fhelm.sh\u002Fdocs\u002Fintro\u002Finstall\u002F\"\u003Eсайта\u003C\u002Fa\u003E для Ubuntu.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ecurl https:\u002F\u002Fbaltocdn.com\u002Fhelm\u002Fsigning.asc | sudo apt-key add -\nsudo apt-get install apt-transport-https --yes\necho \"deb https:\u002F\u002Fbaltocdn.com\u002Fhelm\u002Fstable\u002Fdebian\u002F all main\" | sudo tee \u002Fetc\u002Fapt\u002Fsources.list.d\u002Fhelm-stable-debian.list\nsudo apt-get update\nsudo apt-get install helm\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПроверим успешность установки:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ehelm version\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"78\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8fb\u002F4ee\u002Ff3c\u002F8fb4eef3c9b944dfe2ed653d3bd773d9.png\" data-width=\"1436\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EИнструкция для CentOS 8. \u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EТоже с официального \u003Ca href=\"https:\u002F\u002Fhelm.sh\u002Fdocs\u002Fintro\u002Finstall\u002F#from-script\"\u003Eсайта\u003C\u002Fa\u003E:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ecurl -fsSL -o get_helm.sh https:\u002F\u002Fraw.githubusercontent.com\u002Fhelm\u002Fhelm\u002Fmain\u002Fscripts\u002Fget-helm-3\nchmod 700 get_helm.sh\n.\u002Fget_helm.sh\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cp\u003EHelm установлен! \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"3\" id=\"3\"\u003E\u003C\u002Fa\u003E\u003Ch3\u003EУстановка Ingress-nginx\u003C\u002Fh3\u003E\u003Cp\u003EИнструкцию стянул из официальной \u003Ca href=\"https:\u002F\u002Fkubernetes.github.io\u002Fingress-nginx\u002Fdeploy\u002F#using-helm\"\u003Eдокументации\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ehelm repo add ingress-nginx https:\u002F\u002Fkubernetes.github.io\u002Fingress-nginx \nhelm repo update \nhelm install ingress-nginx ingress-nginx\u002Fingress-nginx\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EТакже запросим установленные сервисы:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ekubectl get svc\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"190\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe87\u002F915\u002F732\u002Fe87915732ae701b58493726587a53d9d.png\" data-width=\"2244\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЕсли бы вы пользовались облачным сервисом \u003Cstrong\u003EGKE\u003C\u002Fstrong\u003E или \u003Cstrong\u003EAWS\u003C\u002Fstrong\u003E, то в графе \u003Ccode\u003EEXTERNAL-IP\u003C\u002Fcode\u003E появился бы выделенный IP-адрес. \u003C\u002Fp\u003E\u003Cp\u003EА Ingress-сервис стал бы доступен по адресу: \u003Ccode\u003Ehttp:\u002F\u002F*external-ip*:80\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fce0\u002Fda1\u002F6ed\u002Fce0da16ed7023c2d59bd42fb82f0a98e.jpeg\" alt=\"В облачных &quot;Kubernetes-as-a-service&quot; есть прослойка между пользователем и кластером — Cloud Load Balancer.\" title=\"В облачных &quot;Kubernetes-as-a-service&quot; есть прослойка между пользователем и кластером — Cloud Load Balancer.\" width=\"756\" height=\"567\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fce0\u002Fda1\u002F6ed\u002Fce0da16ed7023c2d59bd42fb82f0a98e.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003EВ облачных \"Kubernetes-as-a-service\" есть прослойка между пользователем и кластером — Cloud Load Balancer.\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНо когда вы устанавливаете Куб на голое железо, внешний балансировщик отсутствует, поэтому службы не получают EXTERNAL-IP. Это описано в \u003Ca href=\"https:\u002F\u002Fkubernetes.github.io\u002Fingress-nginx\u002Fdeploy\u002Fbaremetal\u002F#bare-metal-considerations\"\u003Eдокументации\u003C\u002Fa\u003E к Ingress-nginx (эти красивые картинки стянул оттуда же), а также \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002Frequirements.html#auto-devops-requirements-for-bare-metal\"\u003Eтут\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a6\u002F127\u002Fd5f\u002F3a6127d5f73c55f6869e6741edba0a55.jpeg\" alt=\"В &quot;bare-metal&quot; конфигурации эта прослойка отсутствует.\" title=\"В &quot;bare-metal&quot; конфигурации эта прослойка отсутствует.\" width=\"756\" height=\"484\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a6\u002F127\u002Fd5f\u002F3a6127d5f73c55f6869e6741edba0a55.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003EВ \"bare-metal\" конфигурации эта прослойка отсутствует.\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EБудем использовать первое предложенное в этом документе решение — поставим Metallb, который заменит нам внешний балансировщик. \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"4\" id=\"4\"\u003E\u003C\u002Fa\u003E\u003Ch3\u003EУстановка Metallb\u003C\u002Fh3\u003E\u003Cp\u003EВнесем изменения в configmap:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ekubectl edit configmap -n kube-system kube-proxy\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EНужно в \u003Ccode\u003Emode\u003C\u002Fcode\u003E записать \u003Ccode\u003Eipvs\u003C\u002Fcode\u003E, a \u003Ccode\u003EstrictARP\u003C\u002Fcode\u003E активировать. Кусок конфигурации должен выглядеть так:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003EapiVersion: kubeproxy.config.k8s.io\u002Fv1alpha1 \nkind: KubeProxyConfiguration \nmode: \"ipvs\" \nipvs:  \n    strictARP: true\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EСохраняем и выходим, если сможете конечно, ибо запускается vim. Главное помните, в любой непонятной ситуации вводите:\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F799\u002Fb54\u002F34f\u002F799b5434f566d015630722bfb6d433b5.jpeg\" width=\"490\" height=\"350\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F799\u002Fb54\u002F34f\u002F799b5434f566d015630722bfb6d433b5.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДобавляем Helm-репозиторий:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ehelm repo add metallb https:\u002F\u002Fmetallb.github.io\u002Fmetallb\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EСоздаем файл с именем \u003Ccode\u003Evalues.yaml\u003C\u002Fcode\u003E\u003Cstrong\u003E \u003C\u002Fstrong\u003Eи вставляем шаблон:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003EconfigInline:\n  address-pools:\n   - name: default\n     protocol: layer2\n     addresses:\n     - x.x.x.x\u002F24\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВ поле \u003Ccode\u003Eaddresses\u003C\u002Fcode\u003E указываем пул IP-адресов, которые заберёт в своё пользование Metallb. Адреса нужно указать в виде CIDR. В моём пользовании всего две виртуальные машины, поэтому речи о пуле адресов не идёт. Маска подсети для одного-единственного IP-адреса записывается как \"\u003Ccode\u003E\u002F32\u003C\u002Fcode\u003E\".\u003C\u002Fp\u003E\u003Cp\u003EВ моем случае конфигурация выглядит так:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003EconfigInline:\n  address-pools:\n   - name: default\n     protocol: layer2\n     addresses:\n     - 194.87.253.108\u002F32\n     - 87.247.157.40\u002F32\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EСохраняем и выходим. Теперь установим \u003Ccode\u003Ehelm chart metallb\u003C\u002Fcode\u003E с указанием файла конфигурации:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ehelm install metallb metallb\u002Fmetallb -f values.yaml\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПосле чего запросим сервисы:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ekubectl get svc\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"150\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd9e\u002F98f\u002Fbfa\u002Fd9e98fbfa28545819ca716c05f5b50f7.png\" data-width=\"1976\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЕсли вы всё сделали правильно, то в графе \u003Ccode\u003EEXTERNAL-IP\u003C\u002Fcode\u003E появится выделенный IP-адрес для этого сервиса. Проверим в браузере:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"350\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe48\u002F428\u002F710\u002Fe48428710d5c97ccc1545d7acc2b2b3b.png\" data-width=\"1736\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНа этом настройка Куба на голом железе завершена. \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EАльтернативное решение\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EК любому из сервисов (с типом \u003Ccode\u003ELoadBalancer\u003C\u002Fcode\u003E), можно обратиться по \u003Ccode\u003ENodePort\u003C\u002Fcode\u003E. Например, Ingress-сервис будет доступен по адресу: \u003Ccode\u003Ehttp:\u002F\u002F*ip-master-node*:*NodePort*\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"364\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fadb\u002F008\u002F413\u002Fadb008413ef6590cdeb48283b577028f.png\" data-width=\"1940\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНомер \u003Ccode\u003ENodePort\u003C\u002Fcode\u003E и тип сервиса можно увидеть тут:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"180\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F469\u002F9dd\u002F8af\u002F4699dd8af81548ab61da3dc63ac10e75.png\" data-width=\"2234\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЭто один из вариантов решения проблемы отсутствия внешнего балансировщика. Описано в той же \u003Ca href=\"https:\u002F\u002Fkubernetes.github.io\u002Fingress-nginx\u002Fdeploy\u002Fbaremetal\u002F#over-a-nodeport-service\"\u003Eдокументации\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EЕсли мы возьмём доменное имя, например, example.com, и свяжем его с IP-адресом master-ноды, то сервис будет доступен по адресу: \u003Ccode\u003Ehttp:\u002F\u002Fexample.com:32128\u003C\u002Fcode\u003E. Выглядит стремновато. Но как вариант, можно поставить на master-ноду nginx и проксировать трафик с порта 80 на порт 32128. И тогда Ingress будет доступен по адресу \u003Ccode\u003Ehttp:\u002F\u002Fexample.com\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003EНашел даже интересный проект на \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fstaticfloat\u002Fdocker-nginx-certbot\"\u003EGithub\u003C\u002Fa\u003E, который кроме запуска nginx в Docker-контейнере еще и настраивает SSL-сертификаты. Надо лишь указать, на какие доменные имена нужно выпустить сертификаты, и всё остальное он сделает сам. Действительно, ставится буквально одной командой, что очень порадовало. \u003C\u002Fp\u003E\u003Cp\u003EНо лично у меня с этой схемой начались проблемы, когда я начал разворачивать Kubernetes dashboard и настраивать авторизацию через Keycloak. Поэтому, этот вариант пусть останется в истории.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Ca class=\"anchor\" name=\"5\" id=\"5\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EНастройка CI\u002FCD в GitLab\u003C\u002Fh2\u003E\u003Ch3\u003EВыбираем доменное имя для сервиса\u003C\u002Fh3\u003E\u003Cp\u003EСначала нужно придумать название для своего сервиса и купить доменное имя. Чур, мой сервис будет называться \u003Ccode\u003Eawesomeservice\u003C\u002Fcode\u003E, а доменную зону я выбрал модную и красивую — \u003Ccode\u003E.tech\u003C\u002Fcode\u003E. Где покупать, в принципе, не имеет значения. \u003C\u002Fp\u003E\u003Cp\u003ECвяжем \u003Ccode\u003Eexternal-ip\u003C\u002Fcode\u003E Ingress-nginx с новым купленным доменным именем. Для этого создайте A-запись (\u003Ccode\u003Eawesomeservice.tech -\u003E 194.87.253.108\u003C\u002Fcode\u003E). Полное обновление DNS-сервера занимает не более трёх часов. После этого Ingress-nginx будет доступен уже по доменному имени.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"366\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc41\u002Fcd8\u002F3c5\u002Fc41cd83c5789e9660b0c5fe294ff3be9.png\" data-width=\"1782\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЕстественно архитектура, будет микросервисная, а это значит, что для проекта могут быть развернуты разные приложения со своим API. У нас будет вспомогательный микросервис \u003Ccode\u003Ecoolapp\u003C\u002Fcode\u003E. И кряхтеть он будет по адресу \u003Ccode\u003Ehttp:\u002F\u002Fcoolapp.awesomeservice.tech\u003C\u002Fcode\u003E. Причем это production-окружение, которое будет использовать конечный пользователь. Еще понадобятся test- и staging-окружения\u003Cstrong\u003E. \u003C\u002Fstrong\u003EВ итоге у нас будет развёрнуто сразу несколько приложений с такими поддоменными именами:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003Ehttp:\u002F\u002F\u003Cstrong\u003Ecoolapp\u003C\u002Fstrong\u003E.awesomeservice.tech\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Ehttp:\u002F\u002F\u003Cstrong\u003Estaging.coolapp\u003C\u002Fstrong\u003E.awesomeservice.tech\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Ehttp:\u002F\u002F\u003Cstrong\u003Eqa01.coolapp\u003C\u002Fstrong\u003E.awesomeservice.tech\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Ehttp:\u002F\u002F\u003Cstrong\u003Eqa02.coolapp\u003C\u002Fstrong\u003E.awesomeservice.tech \u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EЭто значит, надо сделать ещё четыре A-записи для поддоменых имен: \u003Ccode\u003Ecoolapp.\u003C\u002Fcode\u003E, \u003Ccode\u003Estaging.coolapp.\u003C\u002Fcode\u003E, \u003Ccode\u003Eqa01.coolapp.\u003C\u002Fcode\u003E, \u003Ccode\u003Eqa02.coolapp.\u003C\u002Fcode\u003E. И да, все эти имена разрешаются на Ingress \u003Ccode\u003EEXTERNAL-IP\u003C\u002Fcode\u003E. \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"6\" id=\"6\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EСоздание проекта в GitLab\u003C\u002Fh2\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"338\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F676\u002Fb1d\u002Fb53\u002F676b1db539f4b9a746adf9d6127819d8.png\" data-width=\"300\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСоздаём пустой проект. В 2к21 ребята из GitLab еще не завезли шаблон для Python-проекта ¯\\_(ツ)_\u002F¯.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"882\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F977\u002Fb39\u002F1a8\u002F977b391a89bdc29b54305e09a1672b6c.png\" data-width=\"1656\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСоздадим вспомогательное приложение coolapp для сервиса awesomeservice\u003Cstrong\u003E. \u003C\u002Fstrong\u003EИспользовать будем слегка модифицированный микросервис на FastApi из предыдущих \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fcompany\u002Fdomclick\u002Fblog\u002F551332\u002F\"\u003Eстатей\u003C\u002Fa\u003E. Иерархия:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ecoolapp\n├── Dockerfile\n├── README.md\n├── main.py\n└── requirements.txt\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EDockerfile\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cpre\u003E\u003Ccode\u003EFROM python:3.8\n\nEXPOSE 8080\n\nWORKDIR app\n\nCOPY requirements.txt requirements.txt\n\nRUN pip install -r requirements.txt\n\nCOPY . .\n\nCMD [\"uvicorn\", \"main:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8080\"]\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003Emain.py\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cpre\u003E\u003Ccode\u003Efrom fastapi import FastAPI, Cookie\nfrom typing import Optional\nfrom uuid import uuid4\n\napp = FastAPI()\nuuid = uuid4()\n\n\n@app.get(\"\u002Fapi\u002Fv1\u002Fuuid\")\nasync def root(key: Optional[str] = Cookie(None)):\n    print(key)\n    return {'uuid': uuid}\n\n\n@app.get(\"\u002Fhealthz\")\nasync def health_check():\n    return {}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EРучку \u003Ccode\u003E\u002Fhealthz\u003C\u002Fcode\u003E будет использовать Kubernetes для проверки работоспособности поды.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003Erequirements.txt\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cpre\u003E\u003Ccode\u003Efastapi==0.63.0\nuvicorn==0.13.3\nrequests==2.26.0\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cp\u003EСборка и запуск приложения:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Edocker build . -t coolapp \ndocker run -p 8080:8080 -t coolapp\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПроверяем работу:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"476\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fbf7\u002F974\u002F2da\u002Fbf79742da0fa0b645edd3ee9f2a3fdfe.png\" data-width=\"1700\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПушим проект в удаленный репозиторий. \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"7\" id=\"7\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EИнтеграция Kubernetes-кластера\u003C\u002Fh2\u003E\u003Cp\u003EНа главной проекта нажимаем кнопку \u003Ccode\u003E&lt;Add Kubernetes cluster\u003E\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"1078\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a0\u002F9ca\u002F807\u002F3a09ca80751eb853d268c13f047d2864.png\" data-width=\"1498\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EС невозмутимым лицом проходим мимо предложения воспользоваться облачными сервисами GKE, AWS. Переходим во вкладку «Подключить существующий кластер».\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"548\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F86a\u002Fcc8\u002Fd95\u002F86acc8d9587bb0aff314f82fee4339b0.png\" data-width=\"2399\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ принципе, \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Fuser\u002Fproject\u002Fclusters\u002Fadd_existing_cluster.html#how-to-add-an-existing-cluster\"\u003Eофициальная\u003C\u002Fa\u003E документация довольно подробно расписывает, как заполнить каждое поле. Но для удобства продублирую инструкцию тут:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"1222\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F93b\u002F558\u002F862\u002F93b5588621122e72ea3733e0862cef3f.png\" data-width=\"1438\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЗдесь надо заполнить шесть полей:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EKubernetes cluster name\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EEnvironment scope\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EAPI URL\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003ECA Certificate\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EService Token\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EProject namespace prefix (optional, unique)\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EГалочки \u003Cem\u003ERBAC-enabled cluster\u003C\u002Fem\u003E, \u003Cem\u003EGitLab-managed cluster\u003C\u002Fem\u003E и \u003Cem\u003ENamespace per environment\u003C\u002Fem\u003E\u003Cstrong\u003E \u003C\u002Fstrong\u003Eдолжны быть активны.\u003C\u002Fp\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EKubernetes cluster name\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EПросто записываем имя кластера. У меня это\u003Ccode\u003Edevkube\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EEnvironment scope\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EОставляем \u003Ccode\u003E*\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EAPI URL\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EВ консоли выполните:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ekubectl cluster-info | grep -E 'Kubernetes master|Kubernetes control plane' | awk '\u002Fhttp\u002F {print $NF}'\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"72\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fcd1\u002Fdf4\u002F987\u002Fcd1df4987dffc3d74234e8c049783ea0.png\" data-width=\"2072\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКопируем вывод из консоли и вставляем.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003ECA Certificate\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EВыполните команду:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ekubectl get secrets\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EНайдите название секрета, который начинается на \u003Ccode\u003Edefault-token-xxxxx\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"366\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F521\u002F12d\u002F62d\u002F52112d62d7e1d8750d0e9003faa5cddf.png\" data-width=\"1522\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВставьте это название секрета в следующую команду вместо \u003Ccode\u003Esecret name\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ekubectl get secret \"secret name\" -o jsonpath=\"{['data']['ca\\.crt']}\" | base64 --decode\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"692\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F9a5\u002F657\u002F74f\u002F9a565774fa9d3f390a5e6b27d93277e1.png\" data-width=\"1976\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСкопируйте весь вывод консоли в поле \u003Ccode\u003ECA Certificate\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EService Token\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EСоздайте файл \u003Ccode\u003Egitlab-admin-service-account.yaml\u003C\u002Fcode\u003E и вставьте:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"yaml\"\u003EapiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: gitlab\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io\u002Fv1\nkind: ClusterRoleBinding\nmetadata:\n  name: gitlab-admin\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n  - kind: ServiceAccount\n    name: gitlab\n    namespace: kube-system\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВыполните в той же папке с файлом:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ekubectl apply -f gitlab-admin-service-account.yaml\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПосле создания ресурсов выполните:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ekubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep gitlab | awk '{print $1}')\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"690\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F435\u002Fde0\u002Fdba\u002F435de0dba0c20688449c270bb21bbbb0.png\" data-width=\"2148\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСкопируйте токен и вставьте в поле \u003Ccode\u003EService Token\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EProject namespace\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EВведите префикс вашего пространства имён проекта. Пространство имен  проекта будет составлено из двух частей: префикса и имени окружения. Если не вписать, то GitLab сам сгенерирует некрасивое название с циферками. У меня это \u003Ccode\u003Ecoolapp-devkube\u003C\u002Fcode\u003E. Префикс должен быть уникальным для каждого проекта.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cp\u003EЗаполняем все поля и сохраняем. В итоге должно выглядеть примерно так:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F765\u002F6d5\u002F99e\u002F7656d599e2b943842c4dc21772bce0cd.jpg\" width=\"1279\" height=\"1282\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F765\u002F6d5\u002F99e\u002F7656d599e2b943842c4dc21772bce0cd.jpg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПосле добавления кластера сразу будут показаны его настройки. В окне &lt;\u003Cem\u003EBase domain\u003E\u003C\u002Fem\u003E введите базовый адрес кластера. В моем случае это \u003Ccode\u003Eawesomeservice.tech\u003C\u002Fcode\u003E\u003Cstrong\u003E.\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"608\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F4a0\u002F47e\u002F4e4\u002F4a047e4e403c61bb050069cf250c461d.png\" data-width=\"1000\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EТеперь активируем \u003Cem\u003EAuto Devops\u003C\u002Fem\u003E. На главной проекта нажмите кнопку &lt;\u003Cem\u003EEnable Auto Devops\u003E\u003C\u002Fem\u003E. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"778\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F294\u002F260\u002Fd53\u002F294260d53a298f0bbcd897bc6d76deb5.png\" data-width=\"1996\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EОткроются настройки проекта, где нужно тыкнуть галочку &lt;\u003Cem\u003EDefault to Auto DevOps pipeline\u003E\u003C\u002Fem\u003E и выбрать стратегию развертывания приложения. Я выбрал третий вариант, с предварительным деплоем в staging-среде, после которой будет доступна постепенная (ступенчатая) выкатка в production-среду. Подробнее о стратегиях выкатки можно почитать \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002Frequirements.html#auto-devops-deployment-strategy\"\u003Eтут\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"780\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F585\u002F756\u002Fde2\u002F585756de2560bfcc27ffedcd4eb95171.png\" data-width=\"2024\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНачиная с этого момента для проекта активен Auto Devops. \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"8\" id=\"8\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EНастройка GitLab AutoDevops\u003C\u002Fh2\u003E\u003Cp\u003EКраткий \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F416557\u002F\"\u003Eобзор\u003C\u002Fa\u003E Auto Devops:\u003C\u002Fp\u003E\u003Cblockquote\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F416557\u002F#auto-devops-vyhodit-v-obschiy-dostup-core-starter-premium-ultimate-free-bronze-silver-gold\"\u003E\u003Cstrong\u003EAuto DevOps\u003C\u002Fstrong\u003E\u003C\u002Fa\u003E\u003Cstrong\u003E покрывает весь цикл поставки:\u003C\u002Fstrong\u003E Просто сделайте коммит вашего кода в GitLab и позвольте Auto DevOps заняться остальным: эта система проведет \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002F#auto-build\"\u003Eсборку\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002F#auto-test\"\u003Eтестирование\u003C\u002Fa\u003E, проверку \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002F#auto-code-quality\"\u003Eкачества кода\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002F#auto-sast\"\u003Eбезопасности\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002F#auto-license-management\"\u003Eлицензий\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002F#auto-review-apps\"\u003Eпакетирование\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002F#auto-dast\"\u003Eтестирование производительности\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002F#auto-deploy\"\u003Eразвертывание\u003C\u002Fa\u003E и \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002F#auto-monitoring\"\u003Eмониторинг\u003C\u002Fa\u003E вашего приложения.\u003C\u002Fp\u003E\u003C\u002Fblockquote\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EЗвучит так классно, что даже утопично... Вам так не кажется?\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cp\u003EДа. Вам не кажется.\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F80b\u002Fcc8\u002Fe07\u002F80bcc8e073480b3bebc443b8c08989e2.jpeg\" alt=\"\" title=\"\" width=\"212\" height=\"191\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F80b\u002Fcc8\u002Fe07\u002F80bcc8e073480b3bebc443b8c08989e2.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cp\u003EПосле активации AutoDevops в \u003Cs\u003Emaster\u003C\u002Fs\u003E main-ветке сразу же запустится конвейер. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"762\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa5c\u002F6d9\u002F93c\u002Fa5c6d993c62342d5283e0ff49b591700.png\" data-width=\"2030\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EИ конечно же, он зафейлится, разве могло быть иначе? \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"978\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fdff\u002F715\u002F6e5\u002Fdff7156e58649eee9dd15b6e68077e75.png\" data-width=\"2322\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСборка прошла успешно, что уже радует. В блоке тестирования прошли такие этапы, как проверка лицензии, качества кода и т.д. В общем, прошло всё то, что на этом этапе нас мало интересует. В итоге конвейер завершил работу на тестировании. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"376\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fc2b\u002F822\u002F78e\u002Fc2b82278eb0c7c507b239dbae0e18b77.png\" data-width=\"1766\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EБыстрое гугление показало, что это проблема для всех питонистов: тестирование Python-проектов из коробки работать не будет. Но мы этап тестирования опустим, потому что наша цель — настроить автоматизированную поставку приложений. Выключать стадии можно несколькими способами.\u003C\u002Fp\u003E\u003Cp\u003E1) Например, с помощью создания специальных \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002Fcustomize.html#disable-jobs\"\u003Eпеременных окружения\u003C\u002Fa\u003E в настройках проекта. Для этого перейдите в \u003Ccode\u003ESettings -\u003E CI\u002FCD -\u003E Variables\u003C\u002Fcode\u003E и создайте переменную окружения \u003Ccode\u003ETEST_DISABLED=true.\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EПосле этого нужно обязательно создать новый pipeline, текущий все равно будет запускать test.\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"958\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe89\u002F068\u002Fbe9\u002Fe89068be97b8a44f8f6e948f9ce9ed73.png\" data-width=\"2354\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EМы пропустили test, но ошибка возникла на этапе развертывания приложения в среду review (это аналог общепринятого окружения dev). Gitlab \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002Ftroubleshooting.html#error-release--failed-timed-out-waiting-for-the-condition\"\u003Eожидает\u003C\u002Fa\u003E, что приложение отвечает по порту 5000, у нас же рабочий порт 8080. Можем, конечно, изменить на 5000, но так неинтересно. Хочется иметь возможность задавать порт самому. Решим эту проблему чуть позже.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cp\u003E2) Auto DevOps полностью изменяем, он работает по \u003Ca href=\"https:\u002F\u002Fgitlab.com\u002Fgitlab-org\u002Fgitlab\u002F-\u002Fblob\u002Fmaster\u002Flib\u002Fgitlab\u002Fci\u002Ftemplates\u002FAuto-DevOps.gitlab-ci.yml\"\u003Eшаблону\u003C\u002Fa\u003E, который, по сути, является реализацией\u003Ccode\u003E.gitlab-ci.yml.\u003C\u002Fcode\u003EМы можем в проекте определить свой \u003Ccode\u003E.gitlab-ci.yml\u003C\u002Fcode\u003E и добавить свои этапы, или переопределить стандартные из AutoDevops. Пойдём по второму пути. \u003C\u002Fp\u003E\u003Cp\u003EСоздадим ветку \u003Ccode\u003Efeature\u002Fautodevops\u003C\u002Fcode\u003E(pipeline запустится автоматом).\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"1000\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F915\u002F8d2\u002Fdfc\u002F9158d2dfc19bb4d2586ed09c3abd5a2a.png\" data-width=\"2406\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EОбратите внимание, что в ветке всё равно будет этап \u003Ccode\u003Etest\u003C\u002Fcode\u003E, потому что я создал переменную среды \u003Ccode\u003ETETEST_DISABLED\u003C\u002Fcode\u003E как \u003Ccode\u003Eprotect variable\u003C\u002Fcode\u003E. Переменные такого типа доступны только в \u003Ccode\u003Eprotected \u003C\u002Fcode\u003Eветках, коей \u003Ccode\u003Emain\u003C\u002Fcode\u003E и является.\u003C\u002Fp\u003E\u003Cp\u003EТеперь переопределим стандартный \u003Ca href=\"https:\u002F\u002Fgitlab.com\u002Fgitlab-org\u002Fgitlab\u002F-\u002Fblob\u002Fmaster\u002Flib\u002Fgitlab\u002Fci\u002Ftemplates\u002FAuto-DevOps.gitlab-ci.yml\"\u003Eшаблон\u003C\u002Fa\u003E AutoDevops. Мы оставим почти все стадии, уберём только \u003Ccode\u003Etest\u003C\u002Fcode\u003E, \u003Ccode\u003Edeploy\u003C\u002Fcode\u003E (это заглушка и так), \u003Ccode\u003Edast\u003C\u002Fcode\u003E и \u003Ccode\u003Eperformance\u003C\u002Fcode\u003E. Создайте файл \u003Ccode\u003E.gitlab-ci.yml\u003C\u002Fcode\u003E и вставьте следующие инструкции:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"yaml\"\u003Evariables:\n  ROLLOUT_RESOURCE_TYPE: deployment  # без этого деплой фейлится\n\n\nstages:\n  - build\n  - review\n  - staging\n  - canary\n  - production\n  - incremental rollout 10%\n  - incremental rollout 25%\n  - incremental rollout 50%\n  - incremental rollout 100%\n  - cleanup\n\n\ninclude:\n  - template: Jobs\u002FBuild.gitlab-ci.yml\n  - template: Jobs\u002FDeploy.gitlab-ci.yml\n\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВ \u003Ccode\u003Estages\u003C\u002Fcode\u003E\u003Cstrong\u003E \u003C\u002Fstrong\u003Eперечислены все стадии, которые будут выполняться, их реализация находится в подтягиваемых нами шаблонах\u003Cstrong\u003E \u003C\u002Fstrong\u003E(\u003Ccode\u003Einclude\u003C\u002Fcode\u003E)\u003Cstrong\u003E. \u003C\u002Fstrong\u003EНапример, шаблон \u003Ca href=\"https:\u002F\u002Fgitlab.com\u002Fgitlab-org\u002Fgitlab\u002F-\u002Fblob\u002Fmaster\u002Flib\u002Fgitlab\u002Fci\u002Ftemplates\u002FJobs\u002FDeploy.gitlab-ci.yml\"\u003Eдеплоя\u003C\u002Fa\u003E, в котором описаны все стадии начиная с \u003Ccode\u003Ereview\u003C\u002Fcode\u003E до \u003Ccode\u003Ecleanup\u003C\u002Fcode\u003E. Там же можно заметить, что \u003Ccode\u003Ereview\u003C\u002Fcode\u003E и \u003Ccode\u003Ecleanup\u003C\u002Fcode\u003E выполняются только в ветках, а остальные — в main-ветке, это логично. \u003C\u002Fp\u003E\u003Cp\u003EЕсли сейчас запушить, то будет ошибка во время деплоя, потому что GitLab ожидает приложение на порту 5000. Разумеется, и тут мы не ограничены и можем указать нестандартный порт. GitLab деплоит приложение с помощью Helm-\u003Ca href=\"https:\u002F\u002Fgitlab.com\u002Fgitlab-org\u002Fcluster-integration\u002Fauto-deploy-image\u002F-\u002Fblob\u002Fmaster\u002Fassets\u002Fauto-deploy-app\u002Fvalues.yaml\"\u003Eчарта\u003C\u002Fa\u003E, настройки которого можно переопределить у себя в проекте. Для этого нужно создать папку \u003Ccode\u003E.gitlab \u003C\u002Fcode\u003Eи файл \u003Ccode\u003Eauto-deploy-values.yaml.\u003C\u002Fcode\u003E Чтобы приложение успешно развернулось, достаточно переопределить \u003Ccode\u003Eservice.internalPort\u003C\u002Fcode\u003E, \u003Ccode\u003Eservice.externalPort\u003C\u002Fcode\u003E и обязательно указать наш кастомный health check в разделе \u003Ccode\u003ElivenessProbe\u003C\u002Fcode\u003E и \u003Ccode\u003EreadinessProbe\u003C\u002Fcode\u003E. Также я явно указал, что TLS выключен, настройка сертификатов — это отдельная тема. Если этого не сделать, то, например, Postman будет ругаться на сертификат (через браузер же всё норм).\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"yaml\"\u003Eservice:\n  internalPort: 8080\n  externalPort: 8080\n\nlivenessProbe:\n  path: \u002Fhealthz\n\nreadinessProbe:\n  path: \u002Fhealthz\n\ningress:\n  enabled: true\n  tls:\n    enabled: false\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EИерархия проекта такая (меняться больше не будет):\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Ecoolapp\n├── .gitlab\n│   └── auto-deploy-values.yaml\n├── .gitlab-ci.yml\n├── Dockerfile\n├── README.md\n├── main.py\n└── requirements.txt\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЗапушим изменения и посмотрим результат выполнения конвейера. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"462\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F397\u002Ffc6\u002F813\u002F397fc6813c488ea1b705c47aac1bf3b4.png\" data-width=\"1492\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКонвейер успешно завершил работу, но не спешите радоваться, это ещё не всё. Зайдём и проверим, что и куда задеплоилось.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"602\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb88\u002F382\u002F5d1\u002Fb883825d100b4eab56b75fa51c4fe7ad.png\" data-width=\"1492\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДетализация стадии review показывает, что сервис успешно развёрнут по адресу с интересным поддоменом \u003Ccode\u003E29857899-review-feature-cu-jfvpge\u003C\u002Fcode\u003E. Естественно, этот URL нерабочий, мы же не делали A-запись для такого поддомена.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"858\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F940\u002F17d\u002Fff9\u002F94017dff9ad438d8eb9a75436dca91e4.png\" data-width=\"2278\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДело в том, что для каждой ветки GitLab (согласно шаблону AutoDevops) генерирует уникальный URL и разворачивает под ним сервис. Именно такая система была на моем прошлом месте работы, это довольно удобно, когда можно для своей ветки раскатить сервис и тестировать его изолированно. Но годится это для больших компаний и проектов. К тому же, чтобы это заработало нужно для домена \u003Ccode\u003Eawesomeservice.tech\u003C\u002Fcode\u003E уметь настраивать автоподдомены. Для текущей статьи и в целом для небольшого проекта это излишняя фича, поэтому для веток мы сделаем два окружения: qa01 и qa02. Почему именно два?\u003C\u002Fp\u003E\u003Cfigure class=\"\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F860\u002F40d\u002F2d4\u002F86040d2d4ebd5f5988fa50cc9ebd3c10.jpeg\" width=\"512\" height=\"512\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F860\u002F40d\u002F2d4\u002F86040d2d4ebd5f5988fa50cc9ebd3c10.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНачнем с того, что выключим стадии \u003Ccode\u003Ereview\u003C\u002Fcode\u003E и \u003Ccode\u003Ecleanup\u003C\u002Fcode\u003E. Так как создаётся отдельный сервис для каждой ветки, ресурсы начинаются быстро плодиться и их надо чистить; для этого существует \u003Ccode\u003Ecleanup\u003C\u002Fcode\u003E — она удаляет все созданные ресурсы, связанные с этой веткой. Просто взять и удалить \u003Ccode\u003Ereview\u003C\u002Fcode\u003E и \u003Ccode\u003Ecleanup\u003C\u002Fcode\u003E из \u003Ccode\u003Estages\u003C\u002Fcode\u003E не получится. Если мы используем шаблон, то все описанные там стадии должны быть указаны в блоке \u003Ccode\u003Estages\u003C\u002Fcode\u003E нашего gitlab-ci.yml. Но стадии можно выключить, как я уже упоминал ранее, с помощью специальных \u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Ftopics\u002Fautodevops\u002Fcustomize.html#disable-jobs\"\u003Eпеременных\u003C\u002Fa\u003E окружения. Переменная \u003Ccode\u003EREVIEW_DISABLED\u003C\u002Fcode\u003E отключает сразу обе стадии, это видно в реализации оных в шаблоне \u003Ca href=\"https:\u002F\u002Fgitlab.com\u002Fgitlab-org\u002Fgitlab\u002F-\u002Fblob\u002Fmaster\u002Flib\u002Fgitlab\u002Fci\u002Ftemplates\u002FJobs\u002FDeploy.gitlab-ci.yml\"\u003EJobs\u002FDeploy.gitlab-ci.yml\u003C\u002Fa\u003E. Заодно включим стадию \u003Ccode\u003Ecanary\u003C\u002Fcode\u003E (она по умолчанию выключена), это нам понадобится для конвейера в main-ветке.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"yaml\"\u003Evariables:\n  ROLLOUT_RESOURCE_TYPE: deployment \n  REVIEW_DISABLED: \"true\"\n  CANARY_ENABLED: \"true\"\n\n\nstages:\n  - build\n  - review  # off stage\n  - staging\n  - canary\n  - production\n  - incremental rollout 10%\n  - incremental rollout 25%\n  - incremental rollout 50%\n  - incremental rollout 100%\n  - cleanup  # off stage\n\n\ninclude:\n  - template: Jobs\u002FBuild.gitlab-ci.yml\n  - template: Jobs\u002FDeploy.gitlab-ci.yml\n\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПосле выключения этапа \u003Ccode\u003Ereview\u003C\u002Fcode\u003E создадим свою стадию с именем \u003Ccode\u003Eqa\u003C\u002Fcode\u003E. За основу возьмем стадию \u003Ccode\u003Estaging\u003C\u002Fcode\u003E из того же стандартного шаблона. Вот так она выглядит:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"yaml\"\u003Estaging:\n  extends: .auto-deploy\n  stage: staging\n  script:\n    - auto-deploy check_kube_domain\n    - auto-deploy download_chart\n    - auto-deploy ensure_namespace\n    - auto-deploy initialize_tiller\n    - auto-deploy create_secret\n    - auto-deploy deploy\n  environment:\n    name: staging\n    url: http:\u002F\u002F$CI_PROJECT_PATH_SLUG-staging.$KUBE_INGRESS_BASE_DOMAIN\n  rules:\n    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == \"\"'\n      when: never\n    - if: '$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'\n      when: never\n    - if: '$STAGING_ENABLED'\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EНужно будет сделать небольшие правочки в блоках \u003Ccode\u003Estage\u003C\u002Fcode\u003E, \u003Ccode\u003Eenvironment\u003C\u002Fcode\u003E и \u003Ccode\u003Erules\u003C\u002Fcode\u003E, а вот \u003Ccode\u003Escript\u003C\u002Fcode\u003E останется нетронутым. Всё довольно просто: в \u003Ccode\u003Estage\u003C\u002Fcode\u003E записывается имя стадии, в \u003Ccode\u003Eenvironment.url\u003C\u002Fcode\u003E указывается путь, под которым будет развёрнуто приложение (эта строчка просто пробрасывается в Ingress в \u003Ccode\u003Espec.rules.host\u003C\u002Fcode\u003E — кто знает, тот знает). В этом URL можно заметить странный префикс \u003Ccode\u003E$CI_PROJECT_PATH_SLUG, \u003C\u002Fcode\u003Eесли его оставить, то приложение развернётся с путем \u003Ccode\u003Ehttp:\u002F\u002Fmopckou-coolapp-staging.awesomeservice.tech\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003EВыглядит стрёмно, поэтому для окружения \u003Ccode\u003Eqa01\u003C\u002Fcode\u003E и \u003Ccode\u003Eqa02\u003C\u002Fcode\u003E избавимся от этого префикса. И наконец, добавим ручной выбор, в какое окружение деплоить приложения в блоке \u003Ccode\u003Erules\u003C\u002Fcode\u003E. Вот так выглядят новенькие стадии \u003Ccode\u003Eqa01\u003C\u002Fcode\u003E и \u003Ccode\u003Eqa02\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"yaml\"\u003Eqa01:\n  extends: .auto-deploy\n  stage: qa\n  script:\n    - auto-deploy check_kube_domain\n    - auto-deploy download_chart\n    - auto-deploy ensure_namespace\n    - auto-deploy initialize_tiller\n    - auto-deploy create_secret\n    - auto-deploy deploy\n  environment:\n    name: qa01\n    url: http:\u002F\u002Fqa01.coolapp.$KUBE_INGRESS_BASE_DOMAIN  # убрал префикс $CI_PROJECT_PATH_SLUG-\n  rules:\n    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == \"\"'\n      when: never # не трогаем\n    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'\n      when: never # эта стадия не запускается если ветка называется main (default branch)\n    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'\n      when: manual # для ручного выбора куда деплоить\n\nqa02: # копирка предыдущего блока, просто заменил qa01 на qa02\n  extends: .auto-deploy\n  stage: qa\n  script:\n    - auto-deploy check_kube_domain\n    - auto-deploy download_chart\n    - auto-deploy ensure_namespace\n    - auto-deploy initialize_tiller\n    - auto-deploy create_secret\n    - auto-deploy deploy\n  environment:\n    name: qa02\n    url: http:\u002F\u002Fqa02.coolapp.$KUBE_INGRESS_BASE_DOMAIN\n  rules:\n    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == \"\"'\n      when: never\n    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'\n      when: never\n    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'\n      when: manual\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЭти стадии можно сделать более читаемыми с помощью якорей. Следующая запись полностью эквивалентна предыдущей:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"yaml\"\u003E.qa_env_setup: &amp;qa_setup\n  extends: .auto-deploy\n  stage: qa\n  script:\n    - auto-deploy check_kube_domain\n    - auto-deploy download_chart\n    - auto-deploy ensure_namespace\n    - auto-deploy initialize_tiller\n    - auto-deploy create_secret\n    - auto-deploy deploy\n  rules:\n    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == \"\"'\n      when: never\n    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'\n      when: never\n    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'\n      when: manual\n\n\nqa01:\n  &lt;&lt;: *qa_setup\n  environment:\n    name: qa01\n    url: http:\u002F\u002Fqa01.coolapp.$KUBE_INGRESS_BASE_DOMAIN\n\nqa02:\n  &lt;&lt;: *qa_setup\n  environment:\n    name: qa02\n    url: http:\u002F\u002Fqa02.coolapp.$KUBE_INGRESS_BASE_DOMAIN\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EА для остальных этапов (\u003Ccode\u003Estaging\u003C\u002Fcode\u003E, \u003Ccode\u003Ecanary\u003C\u002Fcode\u003E, \u003Ccode\u003Eproduction\u003C\u002Fcode\u003E) придется так же переопредилить URL, чтобы избавиться от некрасивого префикса.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"yaml\"\u003Estaging:\n  extends: .auto-deploy\n  environment:\n    name: staging\n    url: http:\u002F\u002Fstaging.coolapp.$KUBE_INGRESS_BASE_DOMAIN\n\n.url: &amp;production_url\n  environment:\n    name: production\n    url: http:\u002F\u002Fcoolapp.$KUBE_INGRESS_BASE_DOMAIN\n\nproduction_manual:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nproduction:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ncanary:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 10%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 25%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 50%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 100%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 10%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 25%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 50%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 100%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EПолный gitlab-ci.yml\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cpre\u003E\u003Ccode class=\"yaml\"\u003Evariables:\n  ROLLOUT_RESOURCE_TYPE: deployment  # без этого деплой фейлится\n  REVIEW_DISABLED: \"true\"\n  CANARY_ENABLED: \"true\"\n\n\nstages:\n  - build\n  - review  # off stage\n  - qa\n  - staging\n  - canary\n  - production\n  - incremental rollout 10%\n  - incremental rollout 25%\n  - incremental rollout 50%\n  - incremental rollout 100%\n  - cleanup  # off stage\n\n\n.qa_env_setup: &amp;qa_setup\n  extends: .auto-deploy\n  stage: qa\n  script:\n    - auto-deploy check_kube_domain\n    - auto-deploy download_chart\n    - auto-deploy ensure_namespace\n    - auto-deploy initialize_tiller\n    - auto-deploy create_secret\n    - auto-deploy deploy\n  rules:\n    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == \"\"'\n      when: never\n    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'\n      when: never\n    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'\n      when: manual\n\n.production_env_setup: &amp;production_url\n  environment:\n    name: production\n    url: http:\u002F\u002Fcoolapp.$KUBE_INGRESS_BASE_DOMAIN\n\n\nqa01:\n  &lt;&lt;: *qa_setup\n  environment:\n    name: qa01\n    url: http:\u002F\u002Fqa01.coolapp.$KUBE_INGRESS_BASE_DOMAIN\n\nqa02:\n  &lt;&lt;: *qa_setup\n  environment:\n    name: qa02\n    url: http:\u002F\u002Fqa02.coolapp.$KUBE_INGRESS_BASE_DOMAIN\n\nstaging:\n  extends: .auto-deploy\n  environment:\n    name: staging\n    url: http:\u002F\u002Fstaging.coolapp.$KUBE_INGRESS_BASE_DOMAIN\n\nproduction_manual:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nproduction:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ncanary:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 10%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 25%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 50%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 100%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 10%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 25%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 50%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 100%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\n\ninclude:\n  - template: Jobs\u002FBuild.gitlab-ci.yml\n  - template: Jobs\u002FDeploy.gitlab-ci.yml\n\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cp\u003EПушим изменения и наблюдаем за новеньким конвейером:\u003C\u002Fp\u003E\u003Cfigure class=\"bordered full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"720\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb4f\u002F0b3\u002Fcef\u002Fb4f0b3cef5f2ac6e336822cad753d5cf.gif\" data-width=\"1280\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПриложение успешно развёрнуто в окружении \u003Ccode\u003Eqa01\u003C\u002Fcode\u003E и \u003Ccode\u003Eqa02\u003C\u002Fcode\u003E. Посмотрим теперь детализацию этапа \u003Ccode\u003Eqa01\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"382\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F45c\u002F7e4\u002F387\u002F45c7e4387aa72a5de7e30d1feafd8e18.png\" data-width=\"1226\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПриложение развёрнуто с поддоменом \u003Ccode\u003Eqa01.coolapp\u003C\u002Fcode\u003E. Проверим работу:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"234\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F7ee\u002F1ff\u002Fd88\u002F7ee1ffd88a84bfaf04b74854721add19.png\" data-width=\"1452\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПриложение отвечает и отдает \u003Ccode\u003Euuid\u003C\u002Fcode\u003E по запросу. Chrome ругается на незащищенное HTTP-соединение, но настройка сертификатов выходит за рамки этой статьи. \u003C\u002Fp\u003E\u003Cp\u003EВ GitLab есть удобная борда для мониторинга под в каждом окружении. Перейдите в Deployments → Environments.\u003Cstrong\u003E \u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"890\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fdf0\u002Fb34\u002F7eb\u002Fdf0b347eb56ea832bcca89beefe9fca0.png\" data-width=\"2432\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНо в данный момент она не работает. Панель включается только когда у каждой поды есть аннотация: \u003Ccode\u003Eapp.gitlab.com\u002Fapp=$CI_PROJECT_PATH_SLUG\u003C\u002Fcode\u003E и \u003Ccode\u003Eapp.gitlab.com\u002Fenv=$CI_ENVIRONMENT_SLUG\u003C\u002Fcode\u003E. Ребята из GitLab позаботились о нас и в Helm-чарте пробрасывают аннотацию подам, нам надо лишь переопределить эти параметры. Есть специальная переменная окружения\u003Ccode\u003EHELM_UPGRADE_EXTRA_ARGS\u003C\u002Fcode\u003E, с помощью которой можно переопределить любой параметр из \u003Ca href=\"https:\u002F\u002Fgitlab.com\u002Fgitlab-org\u002Fcluster-integration\u002Fauto-deploy-image\u002F-\u002Fblob\u002Fmaster\u002Fassets\u002Fauto-deploy-app\u002Fvalues.yaml\"\u003EHelm-чарта\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EЭту переменную я указал в \u003Ccode\u003Egitlab-ci.yaml\u003C\u002Fcode\u003E проекта в блоке \u003Ccode\u003Evariables\u003C\u002Fcode\u003E, чтобы все переменные окружения были в одном месте. Но, конечно, все их можно указать на сайте в настройках вашего проекта в GitLab. \u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"yaml\"\u003E  HELM_UPGRADE_EXTRA_ARGS: \"--set gitlab.env=$CI_ENVIRONMENT_SLUG,gitlab.app=$CI_PROJECT_PATH_SLUG\"\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EТеперь уже точно полный gitlab-ci.yaml. Честно-честно!\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cpre\u003E\u003Ccode\u003Evariables:\n  ROLLOUT_RESOURCE_TYPE: deployment\n  REVIEW_DISABLED: \"true\"\n  CANARY_ENABLED: \"true\"\n  HELM_UPGRADE_EXTRA_ARGS: \"--set gitlab.env=$CI_ENVIRONMENT_SLUG,gitlab.app=$CI_PROJECT_PATH_SLUG\"\n\n\nstages:\n  - build\n  - review  # off stage\n  - qa\n  - staging\n  - canary\n  - production\n  - incremental rollout 10%\n  - incremental rollout 25%\n  - incremental rollout 50%\n  - incremental rollout 100%\n  - cleanup  # off stage\n\n\n.qa_env_setup: &amp;qa_setup\n  extends: .auto-deploy\n  stage: qa\n  script:\n    - auto-deploy check_kube_domain\n    - auto-deploy download_chart\n    - auto-deploy ensure_namespace\n    - auto-deploy initialize_tiller\n    - auto-deploy create_secret\n    - auto-deploy deploy\n  rules:\n    - if: '$CI_KUBERNETES_ACTIVE == null || $CI_KUBERNETES_ACTIVE == \"\"'\n      when: never\n    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'\n      when: never\n    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'\n      when: manual\n\n.production_env_setup: &amp;production_url\n  environment:\n    name: production\n    url: http:\u002F\u002Fcoolapp.$KUBE_INGRESS_BASE_DOMAIN\n\n\nqa01:\n  &lt;&lt;: *qa_setup\n  environment:\n    name: qa01\n    url: http:\u002F\u002Fqa01.coolapp.$KUBE_INGRESS_BASE_DOMAIN\n\nqa02:\n  &lt;&lt;: *qa_setup\n  environment:\n    name: qa02\n    url: http:\u002F\u002Fqa02.coolapp.$KUBE_INGRESS_BASE_DOMAIN\n\nstaging:\n  extends: .auto-deploy\n  environment:\n    name: staging\n    url: http:\u002F\u002Fstaging.coolapp.$KUBE_INGRESS_BASE_DOMAIN\n\nproduction_manual:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nproduction:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ncanary:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 10%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 25%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 50%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\ntimed rollout 100%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 10%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 25%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 50%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\nrollout 100%:\n  extends: .auto-deploy\n  &lt;&lt;: *production_url\n\n\ninclude:\n  - template: Jobs\u002FBuild.gitlab-ci.yml\n  - template: Jobs\u002FDeploy.gitlab-ci.yml\n\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cp\u003EПушим изменения, деплоим в qa01 и qa02 и бежим в Deployments → Environments.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"894\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F258\u002F2d1\u002F0d6\u002F2582d10d6f58dfad942f26d589dba1e6.png\" data-width=\"2426\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПоявилась доска с информацией, сколько под развёрнуто и в каком окружении. Эти зеленые квадратики, кстати, кликабельные, так можно сразу провалиться к логам поды, они транслируются в режиме онлайн.\u003C\u002Fp\u003E\u003Cp\u003EС тестовым окружением мы закончили, теперь сливаем ветку в \u003Cs\u003Emaster\u003C\u002Fs\u003E \u003Ccode\u003Emain\u003C\u002Fcode\u003E. И наблюдаем за красивым пайпланчиком в главной ветке:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"720\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F897\u002F5b3\u002F0ca\u002F8975b30cacc4c2510ef417d7f4ca4466.gif\" data-width=\"1280\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"1148\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F19d\u002Fc5e\u002Fd04\u002F19dc5ed046156cd3e4e3e008c5ba4a8f.png\" data-width=\"2428\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПриложение доступно по адресу:\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"http:\u002F\u002Fstaging.coolapp.awesomeservice.tech\u002Fapi\u002Fv1\u002Fuuid\"\u003Ehttp:\u002F\u002Fstaging.coolapp.awesomeservice.tech\u002Fapi\u002Fv1\u002Fuuid\u003C\u002Fa\u003E — для staging-окружения\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"502\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0e5\u002Fea3\u002F8b0\u002F0e5ea38b0987973d1d31919e19770650.png\" data-width=\"1700\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003Ca href=\"http:\u002F\u002Fcoolapp.awesomeservice.tech\u002Fapi\u002Fv1\u002Fuuid\"\u003Ehttp:\u002F\u002Fcoolapp.awesomeservice.tech\u002Fapi\u002Fv1\u002Fuuid\u003C\u002Fa\u003E — для prod-окружения\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"526\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fbe4\u002Ffa5\u002F3f0\u002Fbe4fa53f04711cdb41396a67023d5354.png\" data-width=\"1702\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EМасштабировать приложение очень просто. В переменных окружения проекта (Settings → CI\u002FCD → Variables) создайте переменную \u003Ccode\u003EPRODUCTION_REPLICAS \u003C\u002Fcode\u003Eс желаемым количеством под. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"358\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff69\u002F958\u002F533\u002Ff6995853328927b5b15bb730718a522e.png\" data-width=\"1840\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EИ запустите \u003Cem\u003ERe-deploy\u003C\u002Fem\u003E в панели:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"538\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F58e\u002Fc8d\u002F20f\u002F58ec8d20f6ebcac9bbf111a333288698.png\" data-width=\"2430\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПриложение успешно расплодилось до пяти под.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"568\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F58d\u002F2aa\u002Fdcf\u002F58d2aadcfba0dec70dc020af200c53ff.png\" data-width=\"2434\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПо идее, на этой замечательной ноте можно бы закругляться. Но на десерт давайте всё-таки разберёмся, как работает канареечный деплой. \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Ca class=\"anchor\" name=\"9\" id=\"9\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003EРазбираем канареечный деплой на практике\u003C\u002Fh2\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fdocs.gitlab.com\u002Fee\u002Fuser\u002Fproject\u002Fcanary_deployments.html\"\u003EСуть\u003C\u002Fa\u003E канареечного деплоя в том, что мы направляем часть продуктового трафика на новую версию приложения (какую часть в процентах, мы выбираем сами). Наблюдаем, как ведёт себя новое приложение; если нет ошибок, то перебрасываем весь трафик на новую версию; если всё плохо, то просто откатываемся на предыдущую стабильную версию. \u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EДостоинство:\u003C\u002Fstrong\u003E в случае ошибки страдает только небольшая часть пользователей, а не все, как при классическом деплое. \u003Cstrong\u003EНедостаток:\u003C\u002Fstrong\u003E надо понимать, что запрос от одного пользователя может попасть случайно как на стабильную версию, так и на новую канареечную. Это может привести к путанице и, возможно, к некоторым ошибкам. По идее, это можно решить настройкой \u003Ca href=\"https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Fconcepts\u002Fservices-networking\u002Fservice\u002F#virtual-ips-and-service-proxies\"\u003EsessionAffinity \u003C\u002Fa\u003Eдля Kubernetes services.\u003C\u002Fp\u003E\u003Cp\u003EПродемонстрирую на практике. Изменим код приложения, чтобы по его ответу сразу было понятно, что это новая версия. Добавим в ответ ручки \u003Ccode\u003E\u002Fapi\u002Fv1\u002Fuuid\u003C\u002Fcode\u003E ещё один ключ \u003Ccode\u003Etime\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Efrom time import ctime\n\nfrom fastapi import FastAPI, Cookie\nfrom typing import Optional\nfrom uuid import uuid4\n\napp = FastAPI()\nuuid = uuid4()\n\n\n@app.get(\"\u002Fapi\u002Fv1\u002Fuuid\")\nasync def root(key: Optional[str] = Cookie(None)):\n    print(key)\n    return {\n        'uuid': uuid,\n        'time': ctime()\n    }\n\n\n@app.get(\"\u002Fhealthz\")\nasync def health_check():\n    return {}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПушим изменение и ждём, пока отработает deploy в staging-окружении:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"708\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F140\u002F062\u002Fa8d\u002F140062a8d771e63645a2aa60e1512458.png\" data-width=\"1956\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак только вы запустите canary stage, в том же пространстве имён запустится такое же количество под с новой версией приложения. В названии под есть специальный префикс \u003Ccode\u003E-canary-\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"542\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F095\u002Ff8d\u002F72f\u002F095f8d72f11cffe5f764cd46e3170697.png\" data-width=\"1772\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПока что весь трафик на старой версии приложения. Как только вы нажмете на конвейере на этап с процентом, то выбранная доля трафика станет поступать на канареечные поды.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"750\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fe08\u002F44f\u002Fd87\u002Fe0844fd87343a2093e4131896517e788.png\" data-width=\"2028\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EТеперь взглянем на панель окружений.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"602\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8b7\u002F0d9\u002F13a\u002F8b70d913ac64cb66c340585549d789a1.png\" data-width=\"2410\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВидно, что прибавилось ещё пять под с жёлтым кружочком, это обозначение канареечной поды. На панели можно менять соотношение трафика в любую сторону, и даже пустить весь поток на новую версию приложения.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Трафик поступает то на канареечную поду, то на стабильную версию приложения. Соотношение трафика 50\u002F50\" title=\"Трафик поступает то на канареечную поду, то на стабильную версию приложения. Соотношение трафика 50\u002F50\" height=\"720\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffcb\u002F479\u002Ffaf\u002Ffcb479faf3587910e98c8a9718d1cc03.gif\" data-width=\"1280\"\u002F\u003E\u003Cfigcaption\u003EТрафик поступает то на канареечную поду, то на стабильную версию приложения. Соотношение трафика 50\u002F50\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ конвейере долю трафика можно менять как в большую сторону, так и в меньшую. Но как только вы нажмете на 100 %, весь трафик перейдёт на канареечные поды, в это время будут созданы поды с новой версией микросервиса и старое приложение начнёт удаляться. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"688\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ff49\u002Ff71\u002F7e8\u002Ff49f717e8e6fa01a92168f0a6e080c88.png\" data-width=\"1862\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак только все новые будут запущены, а трафик на них переключится, канареечные поды начнут удаляться. \u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"658\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F728\u002Fd23\u002F298\u002F728d2329859b9db64b4f81473b87c887.png\" data-width=\"1842\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНа этом процесc деплоя на новую версию закончен. \u003Ca href=\"#0\"\u003E↑\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"372\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F655\u002F318\u002F30d\u002F65531830d33feb341595eab02e5bd5f1.png\" data-width=\"1780\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Ca class=\"anchor\" name=\"10\" id=\"10\"\u003E\u003C\u002Fa\u003E\u003Ch2\u003ETL;DR\u003C\u002Fh2\u003E\u003Cblockquote\u003E\u003Cp\u003E1. \u003Ca href=\"#1\"\u003EУстановите\u003C\u002Fa\u003E кластер на голое железо.\u003C\u002Fp\u003E\u003Cp\u003E2. Купите доменное имя (\u003Ca href=\"#5\"\u003Eподробнее тут\u003C\u002Fa\u003E), у меня это \u003Ccode\u003Eawesomeservice.tech\u003C\u002Fcode\u003E\u003Cstrong\u003E. \u003C\u002Fstrong\u003EИ зарегистрируйте четыре поддомена: \u003Ccode\u003Ecoolapp.\u003C\u002Fcode\u003E, \u003Ccode\u003Estaging.coolapp.\u003C\u002Fcode\u003E, \u003Ccode\u003Eqa01.coolapp\u003C\u002Fcode\u003E, \u003Ccode\u003Eqa02.coolapp\u003C\u002Fcode\u003E.\u003Cstrong\u003E \u003C\u002Fstrong\u003EВ моем случае:\u003C\u002Fp\u003E\u003Cp\u003E-\u003Cstrong\u003E coolapp.\u003C\u002Fstrong\u003Eawesomeservice.tech\u003C\u002Fp\u003E\u003Cp\u003E- \u003Cstrong\u003Estaging.coolapp\u003C\u002Fstrong\u003E.awesomeservice.tech\u003C\u002Fp\u003E\u003Cp\u003E-\u003Cstrong\u003E qa01.coolapp\u003C\u002Fstrong\u003E.awesomeservice.tech\u003C\u002Fp\u003E\u003Cp\u003E-\u003Cstrong\u003E qa02.coolapp.\u003C\u002Fstrong\u003Eawesomeservice.tech\u003C\u002Fp\u003E\u003Cp\u003EПоддоменные имена легко меняются в gitlab-ci.yaml (см. следующий пункт).\u003C\u002Fp\u003E\u003Cp\u003E3. Форкните готовый \u003Ca href=\"https:\u002F\u002Fgitlab.com\u002FMopckou\u002Fcoolapp\"\u003Eшаблон\u003C\u002Fa\u003E проекта на Python. Там уже есть настроенный gitlab-ci.yaml.\u003C\u002Fp\u003E\u003Cp\u003E4. \u003Ca href=\"#7\"\u003EПодключите\u003C\u002Fa\u003E свой кластер Куба к проекту в GitLab. После чего в настройках укажите \u003Ccode\u003Ebase domain\u003C\u002Fcode\u003E. У меня это \u003Ccode\u003Eawesomeservice.tech\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cp\u003E5. \u003Ca href=\"#8\"\u003EАктивируйте\u003C\u002Fa\u003E в проекте \u003Cstrong\u003EAutoDevops\u003C\u002Fstrong\u003E.\u003C\u002Fp\u003E\u003C\u002Fblockquote\u003E\u003Cp\u003EСоздайте конвейер и наслаждайтесь:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Pipeline в любой дочерней ветке\" title=\"Pipeline в любой дочерней ветке\" height=\"720\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fab0\u002F06b\u002Fffb\u002Fab006bffb1058a0439b02f81bb40b67f.gif\" data-width=\"1280\"\u002F\u003E\u003Cfigcaption\u003EPipeline в любой дочерней ветке\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"\nPipeline в главной ветке\" title=\"\nPipeline в главной ветке\" height=\"720\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Faa1\u002F50c\u002Fa9b\u002Faa150ca9becfb645d0592e80df2bbab5.gif\" data-width=\"1280\"\u002F\u003E\u003Cfigcaption\u003E\nPipeline в главной ветке\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Chr\u002F\u003E\u003Cp\u003EВ итоге мы создали свой небольшой Kubernetes кластер, состоящий из двух нод, и всё это на голом железе. И что важно — настроили в GitLab автодеплой приложения. На этой прекрасной ноте можно заканчивать.  \u003C\u002Fp\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EРелизные практики. Best practice\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fembedd.srv.habr.com\u002Fiframe\u002F61661f90f61f533babdf2eca\" data-style=\"\" id=\"61661f90f61f533babdf2eca\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003Cdetails class=\"spoiler\"\u003E\u003Csummary\u003EПссс... парень\u003C\u002Fsummary\u003E\u003Cdiv class=\"spoiler__content\"\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"807\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F9ca\u002F43c\u002F6bc\u002F9ca43c6bc9cb81c5fc1205e481ace983.png\" data-width=\"749\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fgitlab.com\u002FMopckou\u002Fcoolapp\"\u003EGitLab\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdetails\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"ci\u002Fcd"},{"titleHtml":"gitlab"},{"titleHtml":"kubernetes"},{"titleHtml":"self-hosted"},{"titleHtml":"autodevops"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a5\u002F067\u002F42f\u002F3a506742f30c010e5f909a0f744d3470.jpg","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a5\u002F067\u002F42f\u002F3a506742f30c010e5f909a0f744d3470.jpg","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002Fdomclick\\\u002Fblog\\\u002F577964\\\u002F\"},\"headline\":\"Ультимативный гайд по созданию CI\\\u002FCD в GitLab с автодеплоем в Kubernetes на голом железе всего за 514$ в год ( ͡° ͜ʖ ͡°)\",\"datePublished\":\"2021-10-14T11:02:07+03:00\",\"dateModified\":\"2021-10-22T00:21:50+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Алексей Ермаков\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Шел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выход...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002Fdomclick\\\u002Fblog\\\u002F577964\\\u002F#post-content-body\",\"about\":[\"c_domclick\",\"h_devops\",\"h_kubernetes\",\"f_develop\",\"f_admin\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F577964\\\u002F4aa48a85d70e02cd429c1ec00ac0de41\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fdd9\\\u002F7fd\\\u002Fb3b\\\u002Fdd97fdb3bb7dc37f60dc3c21c4ffd56a.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F804\\\u002F10f\\\u002Fad9\\\u002F80410fad9beda70d7dadfac5662de297.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F576\\\u002F40a\\\u002F542\\\u002F57640a542728589bc045af3e85cf0da6.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F31a\\\u002F98f\\\u002Fe69\\\u002F31a98fe6919959b34a12496a29bdf5a1.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F91e\\\u002F9df\\\u002Fd43\\\u002F91e9dfd438b388a7b377f62922535793.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fefe\\\u002F56f\\\u002Fe73\\\u002Fefe56fe7315d7ccd577439ed41500975.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff85\\\u002F8de\\\u002F61f\\\u002Ff858de61f85648c3f5596e7c624a056f.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F8fb\\\u002F4ee\\\u002Ff3c\\\u002F8fb4eef3c9b944dfe2ed653d3bd773d9.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fe87\\\u002F915\\\u002F732\\\u002Fe87915732ae701b58493726587a53d9d.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fce0\\\u002Fda1\\\u002F6ed\\\u002Fce0da16ed7023c2d59bd42fb82f0a98e.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F3a6\\\u002F127\\\u002Fd5f\\\u002F3a6127d5f73c55f6869e6741edba0a55.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F799\\\u002Fb54\\\u002F34f\\\u002F799b5434f566d015630722bfb6d433b5.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fd9e\\\u002F98f\\\u002Fbfa\\\u002Fd9e98fbfa28545819ca716c05f5b50f7.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fe48\\\u002F428\\\u002F710\\\u002Fe48428710d5c97ccc1545d7acc2b2b3b.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fadb\\\u002F008\\\u002F413\\\u002Fadb008413ef6590cdeb48283b577028f.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F469\\\u002F9dd\\\u002F8af\\\u002F4699dd8af81548ab61da3dc63ac10e75.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fc41\\\u002Fcd8\\\u002F3c5\\\u002Fc41cd83c5789e9660b0c5fe294ff3be9.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F676\\\u002Fb1d\\\u002Fb53\\\u002F676b1db539f4b9a746adf9d6127819d8.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F977\\\u002Fb39\\\u002F1a8\\\u002F977b391a89bdc29b54305e09a1672b6c.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fbf7\\\u002F974\\\u002F2da\\\u002Fbf79742da0fa0b645edd3ee9f2a3fdfe.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F3a0\\\u002F9ca\\\u002F807\\\u002F3a09ca80751eb853d268c13f047d2864.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F86a\\\u002Fcc8\\\u002Fd95\\\u002F86acc8d9587bb0aff314f82fee4339b0.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F93b\\\u002F558\\\u002F862\\\u002F93b5588621122e72ea3733e0862cef3f.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fcd1\\\u002Fdf4\\\u002F987\\\u002Fcd1df4987dffc3d74234e8c049783ea0.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F521\\\u002F12d\\\u002F62d\\\u002F52112d62d7e1d8750d0e9003faa5cddf.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F9a5\\\u002F657\\\u002F74f\\\u002F9a565774fa9d3f390a5e6b27d93277e1.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F435\\\u002Fde0\\\u002Fdba\\\u002F435de0dba0c20688449c270bb21bbbb0.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F765\\\u002F6d5\\\u002F99e\\\u002F7656d599e2b943842c4dc21772bce0cd.jpg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F4a0\\\u002F47e\\\u002F4e4\\\u002F4a047e4e403c61bb050069cf250c461d.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F294\\\u002F260\\\u002Fd53\\\u002F294260d53a298f0bbcd897bc6d76deb5.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F585\\\u002F756\\\u002Fde2\\\u002F585756de2560bfcc27ffedcd4eb95171.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F80b\\\u002Fcc8\\\u002Fe07\\\u002F80bcc8e073480b3bebc443b8c08989e2.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fa5c\\\u002F6d9\\\u002F93c\\\u002Fa5c6d993c62342d5283e0ff49b591700.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fdff\\\u002F715\\\u002F6e5\\\u002Fdff7156e58649eee9dd15b6e68077e75.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fc2b\\\u002F822\\\u002F78e\\\u002Fc2b82278eb0c7c507b239dbae0e18b77.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fe89\\\u002F068\\\u002Fbe9\\\u002Fe89068be97b8a44f8f6e948f9ce9ed73.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F915\\\u002F8d2\\\u002Fdfc\\\u002F9158d2dfc19bb4d2586ed09c3abd5a2a.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F397\\\u002Ffc6\\\u002F813\\\u002F397fc6813c488ea1b705c47aac1bf3b4.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fb88\\\u002F382\\\u002F5d1\\\u002Fb883825d100b4eab56b75fa51c4fe7ad.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F940\\\u002F17d\\\u002Fff9\\\u002F94017dff9ad438d8eb9a75436dca91e4.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F860\\\u002F40d\\\u002F2d4\\\u002F86040d2d4ebd5f5988fa50cc9ebd3c10.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fb4f\\\u002F0b3\\\u002Fcef\\\u002Fb4f0b3cef5f2ac6e336822cad753d5cf.gif\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F45c\\\u002F7e4\\\u002F387\\\u002F45c7e4387aa72a5de7e30d1feafd8e18.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F7ee\\\u002F1ff\\\u002Fd88\\\u002F7ee1ffd88a84bfaf04b74854721add19.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fdf0\\\u002Fb34\\\u002F7eb\\\u002Fdf0b347eb56ea832bcca89beefe9fca0.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F258\\\u002F2d1\\\u002F0d6\\\u002F2582d10d6f58dfad942f26d589dba1e6.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F897\\\u002F5b3\\\u002F0ca\\\u002F8975b30cacc4c2510ef417d7f4ca4466.gif\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F19d\\\u002Fc5e\\\u002Fd04\\\u002F19dc5ed046156cd3e4e3e008c5ba4a8f.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F0e5\\\u002Fea3\\\u002F8b0\\\u002F0e5ea38b0987973d1d31919e19770650.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fbe4\\\u002Ffa5\\\u002F3f0\\\u002Fbe4fa53f04711cdb41396a67023d5354.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff69\\\u002F958\\\u002F533\\\u002Ff6995853328927b5b15bb730718a522e.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F58e\\\u002Fc8d\\\u002F20f\\\u002F58ec8d20f6ebcac9bbf111a333288698.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F58d\\\u002F2aa\\\u002Fdcf\\\u002F58d2aadcfba0dec70dc020af200c53ff.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F140\\\u002F062\\\u002Fa8d\\\u002F140062a8d771e63645a2aa60e1512458.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F095\\\u002Ff8d\\\u002F72f\\\u002F095f8d72f11cffe5f764cd46e3170697.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fe08\\\u002F44f\\\u002Fd87\\\u002Fe0844fd87343a2093e4131896517e788.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F8b7\\\u002F0d9\\\u002F13a\\\u002F8b70d913ac64cb66c340585549d789a1.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ffcb\\\u002F479\\\u002Ffaf\\\u002Ffcb479faf3587910e98c8a9718d1cc03.gif\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ff49\\\u002Ff71\\\u002F7e8\\\u002Ff49f717e8e6fa01a92168f0a6e080c88.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F728\\\u002Fd23\\\u002F298\\\u002F728d2329859b9db64b4f81473b87c887.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F655\\\u002F318\\\u002F30d\\\u002F65531830d33feb341595eab02e5bd5f1.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fab0\\\u002F06b\\\u002Fffb\\\u002Fab006bffb1058a0439b02f81bb40b67f.gif\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Faa1\\\u002F50c\\\u002Fa9b\\\u002Faa150ca9becfb645d0592e80df2bbab5.gif\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F9ca\\\u002F43c\\\u002F6bc\\\u002F9ca43c6bc9cb81c5fc1205e481ace983.png\"]}","metaDescription":"Шел 2021 год, русские хакеры продолжают переигрывать и уничтожать загнивающий Запад, вмешиваясь в выборы, ломая фейсбуки и пентагоны. Тем временем на Хабре выходят статьи о создании неубиваемых...","mainImageUrl":null,"amp":false},"polls":[{"id":"36054","timeElapsed":null,"answersType":"radio","votesCount":50,"passCount":29,"textHtml":"Вопрос, который давно меня беспокоит. Что всё-таки лучше?","relatedData":null,"variants":[{"id":"170002","textHtml":"Симпл-димпл","votesCount":19,"percent":38,"selected":false},{"id":"170004","textHtml":"Нет! Попыт!","votesCount":31,"percent":62,"selected":false}]}],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":""},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{"domclick":{"alias":"domclick","imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fcompany\u002Fd28\u002F115\u002Ff55\u002Fd28115f5503229d4f9018292fabd1840.jpg","titleHtml":"Домклик","descriptionHtml":"Место силы","relatedData":null,"statistics":{"postsCount":136,"newsCount":0,"vacanciesCount":5,"employeesCount":83,"careerRating":null,"subscribersCount":613,"rating":571.71,"invest":null},"foundationDate":{"year":"2015","month":"07","day":"19"},"location":{"city":null,"region":null,"country":{"id":"168","title":"Россия"}},"siteUrl":"https:\u002F\u002Fdomclick.ru\u002F","staffNumber":"501–1 000 человек","registrationDate":"2020-03-17T09:21:32+00:00","representativeUser":{"alias":"malanshakova","fullname":"Мария Ланшакова"},"contacts":[{"title":"Сайт","url":"https:\u002F\u002Fdomclick.ru\u002F"},{"title":"Сайт","url":"https:\u002F\u002Fteam.domclick.ru\u002F"}],"settings":{"analyticsSettings":[{"type":"ga","trackingId":"UA-70398634-1"}],"branding":null,"status":"active"},"metadata":{"titleHtml":"Домклик, Россия - Место силы с 19 июля 2015 г.","title":"Домклик, Россия - Место силы с 19 июля 2015 г.","keywords":["Программирование","Python","JavaScript","Разработка веб-сайтов","DevOps"],"descriptionHtml":"136 статей от авторов компании Домклик","description":"136 статей от авторов компании Домклик"},"aDeskSettings":null,"careerAlias":"domclick","maxCustomTrackerLinks":0}},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
