<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Как мутировать код в Angular-схематиках и не поседеть / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/company\/tinkoff\/blog\/582120\/"},"headline":"Как мутировать код в Angular-схематиках и не поседеть","datePublished":"2021-10-07T12:15:58+03:00","dateModified":"2021-10-07T12:34:55+03:00","author":{"@type":"Person","name":"Игорь Кацуба"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Чтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики...","url":"https:\/\/habr.com\/ru\/company\/tinkoff\/blog\/582120\/#post-content-body","about":["c_tinkoff","h_javascript","h_angular","h_typescript","f_develop"],"image":["https:\/\/habr.com\/share\/publication\/582120\/b843a712bf2c825df681afe28dc8e91a\/","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/6bf\/125\/0de\/6bf1250de170cea1f21c38b92701d723.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Как мутировать код в Angular-схематиках и не поседеть" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Как мутировать код в Angular-схематиках и не поседеть" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Как мутировать код в Angular-схематиках и не поседеть" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Чтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики для добавления, обновления и настройки..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Чтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики для добавления, обновления и настройки..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Чтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики для добавления, обновления и настройки..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Чтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики для добавления, обновления и настройки..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Чтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики для добавления, обновления и настройки..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habrastorage.org/getpro/habr/upload_files/6bf/125/0de/6bf1250de170cea1f21c38b92701d723.png" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/6bf/125/0de/6bf1250de170cea1f21c38b92701d723.png" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/6bf/125/0de/6bf1250de170cea1f21c38b92701d723.png" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/6bf/125/0de/6bf1250de170cea1f21c38b92701d723.png" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/6bf/125/0de/6bf1250de170cea1f21c38b92701d723.png" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="582120" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-07T09:15:58.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/582120/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/company/tinkoff/blog/582120/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habrastorage.org/getpro/habr/upload_files/6bf/125/0de/6bf1250de170cea1f21c38b92701d723.png" data-vmid="image:href"><link data-vue-meta="ssr" rel="amphtml" href="https://habr.com/ru/amp/post/582120/">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" companyName="tinkoff" data-async-called="true" class="tm-page"><div class="tm-page-width"><div class="tm-page__header"><div class="tm-company-card__branding tm-company-article__branding tm-company-card__branding_loading"><div class="tm-company-card__branding-placeholder"><!----></div> <img src="//habrastorage.org/getpro/habr/branding/2df/b89/248/2dfb89248ab9bc5d3c0794e44d25f33c.png" width="100%" class="tm-company-card__branding-image"></div></div> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"><div class="tm-company-card tm-company-article__company-card"><div class="tm-company-card__info"><div class="tm-company-card__header"><a href="/ru/company/tinkoff/profile/" class="tm-company-card__avatar"><div class="tm-entity-image"><img alt="" height="48" src="//habrastorage.org/getpro/habr/company/6f0/965/c1f/6f0965c1feae8a79dc103989aa6c7e91.png" width="48" class="tm-entity-image__pic"></div></a> <!----> <div class="tm-rating tm-company-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">310.12</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div> <div class="tm-company-card__info"><a href="/ru/company/tinkoff/profile/" class="tm-company-card__name">
        TINKOFF
      </a> <div class="tm-company-card__description">IT’s Tinkoff — просто о сложном</div></div></div> <div class="tm-company-card__buttons"><!----> <!----></div></div> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/Katsuba/" title="Katsuba" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/5f1/a43/8da/5f1a438da34cf9e42943b47ffc32d338.jpg" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/Katsuba/" class="tm-user-info__username">
      Katsuba
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-07T09:15:58.000Z" title="2021-10-07, 12:15">7  октября   в 12:15</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Как мутировать код в Angular-схематиках и не поседеть</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/company/tinkoff/blog/" class="tm-article-snippet__hubs-item-link router-link-active"><span>Блог компании TINKOFF</span> <!----></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/javascript/" class="tm-article-snippet__hubs-item-link"><span>JavaScript</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/angular/" class="tm-article-snippet__hubs-item-link"><span>Angular</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/typescript/" class="tm-article-snippet__hubs-item-link"><span>TypeScript</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><figure class="full-width "><img src="/img/image-loader.svg" height="881" data-src="https://habrastorage.org/getpro/habr/upload_files/6bf/125/0de/6bf1250de170cea1f21c38b92701d723.png" data-width="1561"/><figcaption></figcaption></figure><p>Чтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики для добавления, обновления и настройки библиотек и кодогенерации в приложениях. Во время выполнения схематика вы получаете доступ к файловой системе и можете мутировать исходный код приложения так, как вам нужно. «Но, чтобы мутировать код, нужно работать с AST, а это сложно», — возможно, скажете вы, и будете правы!</p><p>В этой статье расскажу, как мы пытаемся упростить работу с AST и сделать написание схематиков обыденным. А еще покажу, что так же просто можно работать с AST не только в Angular-проектах, а практически в любом проекте на JavaScript/TypeScript. </p><hr/><h2>Что такое схематик</h2><p>Технически схематик — это функция, которая принимает два аргумента на вход: специфичные для схематика опции и контекст, который используется для логирования и несет в себе утилитарные функции.</p><p>Функция возвращает тип <code>Rule</code>. Давайте посмотрим на него внимательнее:</p><pre><code class="javascript">type Rule = (tree: Tree, context: SchematicContext) => Tree | Observable&lt;Tree> | Rule | Promise&lt;void | Rule> | void;</code></pre><p>Из определения типа понятно, что <code>Rule</code> может быть как синхронным, так и асинхронным. И, как бонус, мы можем вернуть <code>Observable</code>. Из типа <code>Rule</code> остался только один неизвестный интерфейс — <code>Tree</code>. <code>Tree</code> — это виртуальная абстракция для работы с файловой системой, изменения в которой накладываются на реальную файловую систему.</p><p>Каждая команда <code>ng</code>, которая использует схематики, имеет собственные настройки, но в итоге все сводится именно к вызову вышеописанной функции.</p><h2>Зачем нужен схематик</h2><p>Мы широко используем схематики по целому ряду причин.</p><p><strong>Выполнение миграций при обновлении библиотек</strong>. В основном используется при мажорных изменениях и помогает разработчикам более просто мигрировать. Сам Angular всегда использует миграции для переезда между версиями. Мы даже<a href="https://github.com/renovatebot/renovate/pull/7632"> <u>контрибьютили в RenovateBot</u></a>, чтобы у пользователей была возможность запускать миграции при автоматическом обновлении зависимостей.</p><p><strong>Настройка библиотек при их добавлении в проект.</strong> Позволяет сразу подготовить приложение к использованию: добавить импорт в нужный модуль, заинжектить дефолтные конфиги или внести изменения в процесс сборки.</p><p><strong>Кодогенерация.</strong> Быстрое создание скелетов библиотек, приложений, компонентов, директив, etc. Например, схематики позволяют в одну команду создать лейзи роут вашего приложения со всеми нужными базовыми конфигами. Мы широко используем эту возможность не только для добавления и генерации кода новых фичей, но и для миграции кодовой базы на другой функционал. Каждый пункт можно развернуть в достаточно большой список кейсов, но оставим это на откуп вашей фантазии и комментариям.</p><p>По итогу можно сказать, что написание схематиков неплохо экономит время пользователей. Но…</p><h2>Есть подвох</h2><p>В какой-то момент мы осознали, что на создание схематика потратили больше ресурсов, чем планировали. Хотя задача заключалась в добавлении одного импорта модуля в главный модуль приложения при миграции.</p><p>Проблема была в том, что мы решили работать с AST для мутаций. Но это не так просто разработчику, который большую часть времени работает с сущностями Angular и версткой.</p><p>Например, команда Angular использует typescript API в миграциях. Но как часто вы сталкиваетесь с программным использованием пакета typescript? Как часто вы оперируете нодами из TS-компилятора, чтобы добавить пару новых проперти в объект или элемента в массив?</p><p>Ниже — пример функции, которая добавляет данные в метаданные модуля (<a href="https://github.com/angular/components/blob/f4a54d64cc6bbb8557e72fc5f2ec7e9a88714ce2/src/cdk/schematics/utils/vendored-ast-utils/index.ts#L336"><u>оригинал</u></a>). <em>Осторожно: код приведен для примера, не советую напрягаться и пытаться понять, что в нем происходит!</em></p><pre><code class="javascript">export function addSymbolToNgModuleMetadata(
  source: ts.SourceFile,
  ngModulePath: string,
  metadataField: string,
  symbolName: string,
  importPath: string | null = null,
): Change[] {
  const nodes = getDecoratorMetadata(source, 'NgModule', '@angular/core');
  let node: any = nodes[0];  // tslint:disable-line:no-any

  // Find the decorator declaration.
  if (!node) {
    return [];
  }

  // Get all the children property assignment of object literals.
  const matchingProperties = getMetadataField(
    node as ts.ObjectLiteralExpression,
    metadataField,
  );

  // Get the last node of the array literal.
  if (!matchingProperties) {
    return [];
  }
  if (matchingProperties.length == 0) {
    // We haven't found the field in the metadata declaration. Insert a new field.
    const expr = node as ts.ObjectLiteralExpression;
    let position: number;
    let toInsert: string;
    if (expr.properties.length == 0) {
      position = expr.getEnd() - 1;
      toInsert = `  ${metadataField}: [${symbolName}]\\\\n`;
    } else {
      node = expr.properties[expr.properties.length - 1];
      position = node.getEnd();
      // Get the indentation of the last element, if any.
      const text = node.getFullText(source);
      const matches = text.match(/^\\\\r?\\\\n\\\\s*/);
      if (matches &amp;&amp; matches.length > 0) {
        toInsert = `,${matches[0]}${metadataField}: [${symbolName}]`;
      } else {
        toInsert = `, ${metadataField}: [${symbolName}]`;
      }
    }
    if (importPath !== null) {
      return [
        new InsertChange(ngModulePath, position, toInsert),
        insertImport(source, ngModulePath, symbolName.replace(/\\\\..*$/, ''), importPath),
      ];
    } else {
      return [new InsertChange(ngModulePath, position, toInsert)];
    }
  }
  const assignment = matchingProperties[0] as ts.PropertyAssignment;

  // If it's not an array, nothing we can do really.
  if (assignment.initializer.kind !== ts.SyntaxKind.ArrayLiteralExpression) {
    return [];
  }

  const arrLiteral = assignment.initializer as ts.ArrayLiteralExpression;
  if (arrLiteral.elements.length == 0) {
    // Forward the property.
    node = arrLiteral;
  } else {
    node = arrLiteral.elements;
  }

  if (!node) {
    // tslint:disable-next-line: no-console
    console.error('No app module found. Please add your new class to your component.');

    return [];
  }

  if (Array.isArray(node)) {
    const nodeArray = node as {} as Array&lt;ts.Node>;
    const symbolsArray = nodeArray.map(node => node.getText());
    if (symbolsArray.includes(symbolName)) {
      return [];
    }

    node = node[node.length - 1];
  }

  let toInsert: string;
  let position = node.getEnd();
  if (node.kind == ts.SyntaxKind.ObjectLiteralExpression) {
    // We haven't found the field in the metadata declaration. Insert a new
    // field.
    const expr = node as ts.ObjectLiteralExpression;
    if (expr.properties.length == 0) {
      position = expr.getEnd() - 1;
      toInsert = `  ${symbolName}\\\\n`;
    } else {
      // Get the indentation of the last element, if any.
      const text = node.getFullText(source);
      if (text.match(/^\\\\r?\\\\r?\\\\n/)) {
        toInsert = `,${text.match(/^\\\\r?\\\\n\\\\s*/)[0]}${symbolName}`;
      } else {
        toInsert = `, ${symbolName}`;
      }
    }
  } else if (node.kind == ts.SyntaxKind.ArrayLiteralExpression) {
    // We found the field but it's empty. Insert it just before the `]`.
    position--;
    toInsert = `${symbolName}`;
  } else {
    // Get the indentation of the last element, if any.
    const text = node.getFullText(source);
    if (text.match(/^\\\\r?\\\\n/)) {
      toInsert = `,${text.match(/^\\\\r?\\\\n(\\\\r?)\\\\s*/)[0]}${symbolName}`;
    } else {
      toInsert = `, ${symbolName}`;
    }
  }
  if (importPath !== null) {
    return [
      new InsertChange(ngModulePath, position, toInsert),
      insertImport(source, ngModulePath, symbolName.replace(/\\\\..*$/, ''), importPath),
    ];
  }

  return [new InsertChange(ngModulePath, position, toInsert)];
}</code></pre><p>Выглядит совершенно не вдохновляюще. Поэтому мы решили создать верхнеуровневую библиотеку, которая позволяет писать схематики намного проще.</p><h2>ng-morph</h2><p>В основе библиотеки лежит<a href="https://github.com/dsherret/ts-morph"><u> ts-morph.</u></a> По сути, ts-morph — это обертка над компилятором typescript, которая упрощает работу с AST.</p><p>Представляю вашему вниманию <code>ng-morph</code>. Это набор утилит, который позволит вам писать схематики намного проще и быстрее. Чтобы не быть голословным, предлагаю сразу рассмотреть несколько примеров с его использованием.</p><p><strong>Задача № 1. </strong>Добавить импорт модуля <code>SomeModule</code> в корневой модуль приложения.</p><p><strong>Решение.</strong></p><pre><code class="javascript">const rule: Rule = (tree: Tree, context: SchematicContext): void => {
  setActiveProject(createProject(tree));

  const appModule = getMainModule('src/main.ts');

  addImportToNgModule(appModule, 'SomeModule');

  addImports(appModule.getFilePath(), {moduleSpecifier: '@some/package', namedExports: ['SomeModule']})

  saveActiveProject();
}
</code></pre><p>Рассмотрим решение построчно:</p><ol><li><p>Создаем проект <code>ng-morph</code> и делаем его активным. Это важно, так как все утилитарные функции работают именно в контексте активного проекта. Под проектом нужно понимать класс, который дает API к файловой системе, компилятору и т. д.</p></li><li><p>По точке входа приложения находим главный модуль приложения.</p></li><li><p>Добавляем в импорты найденного модуля новый.</p></li><li><p>Добавляем импорт модуля в файл, где расположен корневой модуль.</p></li><li><p>Сохраняем проект.</p></li></ol><p>Теперь сравните это решение с функцией выше из исходников Angular. Если вы будете использовать <code>ng-morph</code>, скорее всего, вам не придется писать что-то подобное.</p><p><strong>Задача № 2. </strong>В проекте неожиданно меняется стиль написания имени для enum на uppercase.</p><p><strong>Решение. </strong>Логичные вопросы: при чем здесь <code>ng-morph</code>? Ведь мы говорим про схематики, неужели нужно настраивать и писать схематики только для того, чтобы переименовать энамы?</p><p>Все верно. Схематики кажутся слишком сложными для переименования энамов. Но все же давайте посмотрим, что нам может предложить <code>ng-morph</code>:</p><pre><code class="javascript">setActiveProject(createProject(new NgMorphTree('/')));

const enums = getEnums('/**/*.ts');

editEnums(enums, ({name}) => ({name: name.toUpperCase()}))</code></pre><ol><li><p>Создаем проект. Тут есть важное отличие: скрипт не завернут в функцию схематика и аргумент tree создается вручную с помощью класса NgMorphHost.</p></li><li><p>Ищем все enum в проекте.</p></li><li><p>Переименовываем все enum.</p></li></ol><p>На этом примере мы видим, что <code>ng-morph</code> умеет работать и вне функций схематиков! Да, мы используем <code>ng-morph</code> не только в схематиках и не только в Angular-проектах. </p><h2>Что еще умеет ng-moprh?</h2><p><strong>Создавать</strong></p><pre><code class="javascript">createImports('/src/some.ts', [
  {
    namedImports: ['CoreModule'],
    moduleSpecifier: '@org/core',
    isTypeOnly: true,
  }
]);
</code></pre><p><strong>Искать</strong></p><pre><code class="javascript">const imports = getImports('src/**/*.ts', {
  moduleSpecifier: '@org/*',
});</code></pre><p><strong>Изменять</strong></p><pre><code class="javascript">editImports(imports, ({moduleSpecifier}) => ({
  moduleSpecifier: moduleSpecifier.replace('@org', '@new-org')
})</code></pre><p><strong>Удалять</strong></p><pre><code class="javascript">removeImports(imports)</code></pre><p>Почти по каждой сущности в TS есть свой набор функций: <code>get*</code>, <code>edit*</code>, <code>add*</code>, <code>remove*</code>. Например, <code>getClass</code>, <code>removeConstrucor</code>, <code>addDecorator</code>. Начали появляться утилитарные функции для работы со специфичными для Angular кейсами:</p><ol><li><p><code>getBootstrapFn</code> — функция, возвращающая <code>CallExpression</code>.</p></li><li><p><code>getMainModule</code> — функция, которая возвращает декларацию главного модуля.</p></li><li><p>Куча утилитарных функций по изменению метаданных сущностей Angular: <code>addDeclarationToNgModule</code>, <code>addProviderToDirective</code> и т. д.</p></li></ol><p><code>ng-morph</code> также содержит утилиты для работы с <code>json</code>. Например, для работы с зависимостями в <code>package.json</code>:</p><pre><code class="javascript">addPackageJsonDependency(tree, {
  name: '@package/name',
  version: '~2.0.0',
  type: NodeDependencyType.Dev
});</code></pre><p>Но если нужна более низкоуровневая работы, всегда можно поработать с ts-morph API, а из него провалиться еще ниже — в API самого typescript.</p><h3>Вместо заключения</h3><p>На данный момент roadmap не существует. Мы достаточно быстро реализовали то, чего нам не хватало, и решили показать это сообществу. И, естественно, хочется развивать инструмент дальше.</p><p>Тем не менее список фич первой необходимости все же есть:</p><ol><li><p>Высокоуровневая работа с шаблонами.</p></li><li><p>Высокоуровневая работа со стилями.</p></li><li><p>Наращивание тулинга по работе с сущностями Angular.</p></li></ol><p>И мы будем рады, если сообщество Angular поможет нам это сделать!</p><h3>Ссылки, которые вы так ждали</h3><p>Репозиторий с кодом:</p><div class="embed_link"><div class="embed__thumb" style="background-image: url(&quot;https://opengraph.githubassets.com/04bc1c3bda29147f12447825788abe12e74113532dfa4d3782d894191aade9ae/TinkoffCreditSystems/ng-morph&quot;);"></div><div class="embed__caption"><div class="embed__caption-title"><span>GitHub - TinkoffCreditSystems/ng-morph: Code mutations in schematics were never easier than now.</span></div><a href="https://github.com/TinkoffCreditSystems/ng-morph" target="_blank" rel="noopener noreferrer nofollow" class="embed__caption-link">github.com</a></div></div><p>Сайт с документацией и примерами:</p><div class="embed_link"><div class="embed__thumb" style="background-image: url(&quot;undefined&quot;);"></div><div class="embed__caption"><div class="embed__caption-title"><span>ng-morph</span></div><a href="https://tinkoffcreditsystems.github.io/ng-morph/" target="_blank" rel="noopener noreferrer nofollow" class="embed__caption-link">tinkoffcreditsystems.github.io</a></div></div><h3>Уже используют ng-morph</h3><p>Из известных мне — наша дружественная и лучшая библиотека компонентов для Angular:</p><div class="embed_link"><div class="embed__thumb" style="background-image: url(&quot;https://repository-images.githubusercontent.com/298620687/b5fd7180-46db-11eb-9c69-822a8e279ce8&quot;);"></div><div class="embed__caption"><div class="embed__caption-title"><span>GitHub - TinkoffCreditSystems/taiga-ui: Angular UI Kit and components library for awesome people</span></div><a href="https://github.com/TinkoffCreditSystems/taiga-ui" target="_blank" rel="noopener noreferrer nofollow" class="embed__caption-link">github.com</a></div></div></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bangular%5D" class="tm-tags-list__link">angular</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Btypescript%5D" class="tm-tags-list__link">typescript</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bast%5D" class="tm-tags-list__link">ast</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BC%D1%83%D1%82%D0%B0%D1%86%D0%B8%D1%8F%5D" class="tm-tags-list__link">мутация</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BC%D0%BE%D0%B4%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F%5D" class="tm-tags-list__link">модификация</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bng-morph%5D" class="tm-tags-list__link">ng-morph</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bts-morph%5D" class="tm-tags-list__link">ts-morph</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bschematic%5D" class="tm-tags-list__link">schematic</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bschematics%5D" class="tm-tags-list__link">schematics</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/company/tinkoff/blog/" class="tm-hubs-list__link router-link-active">
    Блог компании TINKOFF
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/javascript/" class="tm-hubs-list__link">
    JavaScript
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/angular/" class="tm-hubs-list__link">
    Angular
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/typescript/" class="tm-hubs-list__link">
    TypeScript
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 15: ↑15 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 15: ↑15 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+15</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">1.5K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    16
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"><div class="tm-article-author__company"><div class="tm-article-author__company-card"><div class="tm-company-snippet"><a href="/ru/company/tinkoff/profile/" class="tm-company-snippet__logo-link"><div class="tm-entity-image"><img alt="" height="40" src="//habrastorage.org/getpro/habr/company/6f0/965/c1f/6f0965c1feae8a79dc103989aa6c7e91.png" width="40" class="tm-entity-image__pic"></div></a> <div class="tm-company-snippet__info"><a href="/ru/company/tinkoff/profile/" class="tm-company-snippet__title">TINKOFF</a> <div class="tm-company-snippet__description">IT’s Tinkoff — просто о сложном</div></div></div> <div class="tm-article-author__buttons"><!----> <!----></div></div> <!----> <div class="tm-article-author__separator"></div></div> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/Katsuba/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/5f1/a43/8da/5f1a438da34cf9e42943b47ffc32d338.jpg" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 35 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    33
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">15</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Игорь Кацуба</span> <a href="/ru/users/Katsuba/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @Katsuba
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Frontend-developer</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <button type="submit" class="tm-user-card__button btn btn_transparent btn_small">
      Задонатить
    </button> <!----> <!----></div></div> <div class="tm-article-author__user-contacts"><a href="https://www.buymeacoffee.com/katsuba" rel="noopener" target="_blank" class="tm-article-author__contact">
      Сайт
    </a><a href="https://career.habr.com/igorkatsuba" rel="noopener" target="_blank" class="tm-article-author__contact">
      Хабр Карьера
    </a><a href="https://twitter.com/katsuba_igor" rel="noopener" target="_blank" class="tm-article-author__contact">
      Twitter
    </a><a href="https://github.com/IKatsuba/" rel="noopener" target="_blank" class="tm-article-author__contact">
      Github
    </a><a href="https://telegram.me/Katsuba" rel="noopener" target="_blank" class="tm-article-author__contact">
      Telegram
    </a></div></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/company/tinkoff/blog/582120/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментировать 
    </span></a> <!----></div></div></div>  <!---->  <!----> <!----></div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__placeholder_initial"></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <section class="tm-block tm-block_spacing-bottom"><header class="tm-block__header"><h2 class="tm-block__title">Информация</h2> <!----></header> <div class="tm-block__body"><div class="tm-company-basic-info"><dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата основания</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2005-11-17T21:00:00.000Z" title="2005-11-18, 00:00">18  ноября  2005</time></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Местоположение</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    Россия
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Сайт</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><a href="https://www.tinkoff.ru/career/" target="_blank" class="tm-company-basic-info__link">
      www.tinkoff.ru
    </a></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Численность</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    5 001–10 000 человек
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата регистрации</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2011-10-26T13:45:16.000Z" title="2011-10-26, 17:45">26  октября  2011</time></dd></dl> <!----></div></div> <!----></section> <div class="tm-company-widgets"></div> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/company/tinkoff/blog/582120/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/company/tinkoff/blog/582120/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"582120":{"id":"582120","timePublished":"2021-10-07T09:15:58+00:00","isCorporative":true,"lang":"ru","titleHtml":"Как мутировать код в Angular-схематиках и не поседеть","leadData":{"textHtml":"\u003Cp\u003EЧтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики для добавления, обновления и настройки библиотек и кодогенерации в приложениях. Во время выполнения схематика вы получаете доступ к файловой системе и можете мутировать исходный код приложения так, как вам нужно. «Но, чтобы мутировать код, нужно работать с AST, а это сложно», — возможно, скажете вы, и будете правы!\u003C\u002Fp\u003E\u003Cp\u003EВ этой статье расскажу, как мы пытаемся упростить работу с AST и сделать написание схематиков обыденным. А еще покажу, что так же просто можно работать с AST не только в Angular-проектах, а практически в любом проекте на JavaScript\u002FTypeScript. \u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6bf\u002F125\u002F0de\u002F6bf1250de170cea1f21c38b92701d723.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6bf\u002F125\u002F0de\u002F6bf1250de170cea1f21c38b92701d723.png","fit":"cover","positionY":0,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":33,"votesCount":35},"rating":15,"relatedData":null,"contacts":[{"title":"Сайт","url":"https:\u002F\u002Fwww.buymeacoffee.com\u002Fkatsuba","value":"https:\u002F\u002Fwww.buymeacoffee.com\u002Fkatsuba"},{"title":"Хабр Карьера","url":"https:\u002F\u002Fcareer.habr.com\u002Figorkatsuba","value":"igorkatsuba"},{"title":"Twitter","url":"https:\u002F\u002Ftwitter.com\u002Fkatsuba_igor","value":"katsuba_igor"},{"title":"Github","url":"https:\u002F\u002Fgithub.com\u002FIKatsuba\u002F","value":"IKatsuba"},{"title":"Telegram","url":"https:\u002F\u002Ftelegram.me\u002FKatsuba","value":"Katsuba"}],"authorContacts":[{"title":"Сайт","url":"https:\u002F\u002Fwww.buymeacoffee.com\u002Fkatsuba","value":"https:\u002F\u002Fwww.buymeacoffee.com\u002Fkatsuba"},{"title":"Хабр Карьера","url":"https:\u002F\u002Fcareer.habr.com\u002Figorkatsuba","value":"igorkatsuba"},{"title":"Twitter","url":"https:\u002F\u002Ftwitter.com\u002Fkatsuba_igor","value":"katsuba_igor"},{"title":"Github","url":"https:\u002F\u002Fgithub.com\u002FIKatsuba\u002F","value":"IKatsuba"},{"title":"Telegram","url":"https:\u002F\u002Ftelegram.me\u002FKatsuba","value":"Katsuba"}],"paymentDetails":{"paymentYandexMoney":"410015887275145","paymentPayPalMe":"igorkatsuba","paymentWebmoney":null},"id":"1227827","alias":"Katsuba","fullname":"Игорь Кацуба","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F5f1\u002Fa43\u002F8da\u002F5f1a438da34cf9e42943b47ffc32d338.jpg","speciality":"Frontend-developer"},"statistics":{"commentsCount":0,"favoritesCount":16,"readingCount":1531,"score":15,"votesCount":15},"hubs":[{"relatedData":null,"id":"17420","alias":"tinkoff","type":"corporative","title":"Блог компании TINKOFF","titleHtml":"Блог компании TINKOFF","isProfiled":false},{"relatedData":null,"id":"357","alias":"javascript","type":"collective","title":"JavaScript","titleHtml":"JavaScript","isProfiled":true},{"relatedData":null,"id":"18109","alias":"angular","type":"collective","title":"Angular","titleHtml":"Angular","isProfiled":true},{"relatedData":null,"id":"21370","alias":"typescript","type":"collective","title":"TypeScript","titleHtml":"TypeScript","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"881\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6bf\u002F125\u002F0de\u002F6bf1250de170cea1f21c38b92701d723.png\" data-width=\"1561\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЧтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики для добавления, обновления и настройки библиотек и кодогенерации в приложениях. Во время выполнения схематика вы получаете доступ к файловой системе и можете мутировать исходный код приложения так, как вам нужно. «Но, чтобы мутировать код, нужно работать с AST, а это сложно», — возможно, скажете вы, и будете правы!\u003C\u002Fp\u003E\u003Cp\u003EВ этой статье расскажу, как мы пытаемся упростить работу с AST и сделать написание схематиков обыденным. А еще покажу, что так же просто можно работать с AST не только в Angular-проектах, а практически в любом проекте на JavaScript\u002FTypeScript. \u003C\u002Fp\u003E\u003Chr\u002F\u003E\u003Ch2\u003EЧто такое схематик\u003C\u002Fh2\u003E\u003Cp\u003EТехнически схематик — это функция, которая принимает два аргумента на вход: специфичные для схематика опции и контекст, который используется для логирования и несет в себе утилитарные функции.\u003C\u002Fp\u003E\u003Cp\u003EФункция возвращает тип \u003Ccode\u003ERule\u003C\u002Fcode\u003E. Давайте посмотрим на него внимательнее:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"javascript\"\u003Etype Rule = (tree: Tree, context: SchematicContext) =\u003E Tree | Observable&lt;Tree\u003E | Rule | Promise&lt;void | Rule\u003E | void;\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EИз определения типа понятно, что \u003Ccode\u003ERule\u003C\u002Fcode\u003E может быть как синхронным, так и асинхронным. И, как бонус, мы можем вернуть \u003Ccode\u003EObservable\u003C\u002Fcode\u003E. Из типа \u003Ccode\u003ERule\u003C\u002Fcode\u003E остался только один неизвестный интерфейс — \u003Ccode\u003ETree\u003C\u002Fcode\u003E. \u003Ccode\u003ETree\u003C\u002Fcode\u003E — это виртуальная абстракция для работы с файловой системой, изменения в которой накладываются на реальную файловую систему.\u003C\u002Fp\u003E\u003Cp\u003EКаждая команда \u003Ccode\u003Eng\u003C\u002Fcode\u003E, которая использует схематики, имеет собственные настройки, но в итоге все сводится именно к вызову вышеописанной функции.\u003C\u002Fp\u003E\u003Ch2\u003EЗачем нужен схематик\u003C\u002Fh2\u003E\u003Cp\u003EМы широко используем схематики по целому ряду причин.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EВыполнение миграций при обновлении библиотек\u003C\u002Fstrong\u003E. В основном используется при мажорных изменениях и помогает разработчикам более просто мигрировать. Сам Angular всегда использует миграции для переезда между версиями. Мы даже\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Frenovatebot\u002Frenovate\u002Fpull\u002F7632\"\u003E \u003Cu\u003Eконтрибьютили в RenovateBot\u003C\u002Fu\u003E\u003C\u002Fa\u003E, чтобы у пользователей была возможность запускать миграции при автоматическом обновлении зависимостей.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EНастройка библиотек при их добавлении в проект.\u003C\u002Fstrong\u003E Позволяет сразу подготовить приложение к использованию: добавить импорт в нужный модуль, заинжектить дефолтные конфиги или внести изменения в процесс сборки.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EКодогенерация.\u003C\u002Fstrong\u003E Быстрое создание скелетов библиотек, приложений, компонентов, директив, etc. Например, схематики позволяют в одну команду создать лейзи роут вашего приложения со всеми нужными базовыми конфигами. Мы широко используем эту возможность не только для добавления и генерации кода новых фичей, но и для миграции кодовой базы на другой функционал. Каждый пункт можно развернуть в достаточно большой список кейсов, но оставим это на откуп вашей фантазии и комментариям.\u003C\u002Fp\u003E\u003Cp\u003EПо итогу можно сказать, что написание схематиков неплохо экономит время пользователей. Но…\u003C\u002Fp\u003E\u003Ch2\u003EЕсть подвох\u003C\u002Fh2\u003E\u003Cp\u003EВ какой-то момент мы осознали, что на создание схематика потратили больше ресурсов, чем планировали. Хотя задача заключалась в добавлении одного импорта модуля в главный модуль приложения при миграции.\u003C\u002Fp\u003E\u003Cp\u003EПроблема была в том, что мы решили работать с AST для мутаций. Но это не так просто разработчику, который большую часть времени работает с сущностями Angular и версткой.\u003C\u002Fp\u003E\u003Cp\u003EНапример, команда Angular использует typescript API в миграциях. Но как часто вы сталкиваетесь с программным использованием пакета typescript? Как часто вы оперируете нодами из TS-компилятора, чтобы добавить пару новых проперти в объект или элемента в массив?\u003C\u002Fp\u003E\u003Cp\u003EНиже — пример функции, которая добавляет данные в метаданные модуля (\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fangular\u002Fcomponents\u002Fblob\u002Ff4a54d64cc6bbb8557e72fc5f2ec7e9a88714ce2\u002Fsrc\u002Fcdk\u002Fschematics\u002Futils\u002Fvendored-ast-utils\u002Findex.ts#L336\"\u003E\u003Cu\u003Eоригинал\u003C\u002Fu\u003E\u003C\u002Fa\u003E). \u003Cem\u003EОсторожно: код приведен для примера, не советую напрягаться и пытаться понять, что в нем происходит!\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"javascript\"\u003Eexport function addSymbolToNgModuleMetadata(\n  source: ts.SourceFile,\n  ngModulePath: string,\n  metadataField: string,\n  symbolName: string,\n  importPath: string | null = null,\n): Change[] {\n  const nodes = getDecoratorMetadata(source, 'NgModule', '@angular\u002Fcore');\n  let node: any = nodes[0];  \u002F\u002F tslint:disable-line:no-any\n\n  \u002F\u002F Find the decorator declaration.\n  if (!node) {\n    return [];\n  }\n\n  \u002F\u002F Get all the children property assignment of object literals.\n  const matchingProperties = getMetadataField(\n    node as ts.ObjectLiteralExpression,\n    metadataField,\n  );\n\n  \u002F\u002F Get the last node of the array literal.\n  if (!matchingProperties) {\n    return [];\n  }\n  if (matchingProperties.length == 0) {\n    \u002F\u002F We haven't found the field in the metadata declaration. Insert a new field.\n    const expr = node as ts.ObjectLiteralExpression;\n    let position: number;\n    let toInsert: string;\n    if (expr.properties.length == 0) {\n      position = expr.getEnd() - 1;\n      toInsert = `  ${metadataField}: [${symbolName}]\\\\\\\\n`;\n    } else {\n      node = expr.properties[expr.properties.length - 1];\n      position = node.getEnd();\n      \u002F\u002F Get the indentation of the last element, if any.\n      const text = node.getFullText(source);\n      const matches = text.match(\u002F^\\\\\\\\r?\\\\\\\\n\\\\\\\\s*\u002F);\n      if (matches &amp;&amp; matches.length \u003E 0) {\n        toInsert = `,${matches[0]}${metadataField}: [${symbolName}]`;\n      } else {\n        toInsert = `, ${metadataField}: [${symbolName}]`;\n      }\n    }\n    if (importPath !== null) {\n      return [\n        new InsertChange(ngModulePath, position, toInsert),\n        insertImport(source, ngModulePath, symbolName.replace(\u002F\\\\\\\\..*$\u002F, ''), importPath),\n      ];\n    } else {\n      return [new InsertChange(ngModulePath, position, toInsert)];\n    }\n  }\n  const assignment = matchingProperties[0] as ts.PropertyAssignment;\n\n  \u002F\u002F If it's not an array, nothing we can do really.\n  if (assignment.initializer.kind !== ts.SyntaxKind.ArrayLiteralExpression) {\n    return [];\n  }\n\n  const arrLiteral = assignment.initializer as ts.ArrayLiteralExpression;\n  if (arrLiteral.elements.length == 0) {\n    \u002F\u002F Forward the property.\n    node = arrLiteral;\n  } else {\n    node = arrLiteral.elements;\n  }\n\n  if (!node) {\n    \u002F\u002F tslint:disable-next-line: no-console\n    console.error('No app module found. Please add your new class to your component.');\n\n    return [];\n  }\n\n  if (Array.isArray(node)) {\n    const nodeArray = node as {} as Array&lt;ts.Node\u003E;\n    const symbolsArray = nodeArray.map(node =\u003E node.getText());\n    if (symbolsArray.includes(symbolName)) {\n      return [];\n    }\n\n    node = node[node.length - 1];\n  }\n\n  let toInsert: string;\n  let position = node.getEnd();\n  if (node.kind == ts.SyntaxKind.ObjectLiteralExpression) {\n    \u002F\u002F We haven't found the field in the metadata declaration. Insert a new\n    \u002F\u002F field.\n    const expr = node as ts.ObjectLiteralExpression;\n    if (expr.properties.length == 0) {\n      position = expr.getEnd() - 1;\n      toInsert = `  ${symbolName}\\\\\\\\n`;\n    } else {\n      \u002F\u002F Get the indentation of the last element, if any.\n      const text = node.getFullText(source);\n      if (text.match(\u002F^\\\\\\\\r?\\\\\\\\r?\\\\\\\\n\u002F)) {\n        toInsert = `,${text.match(\u002F^\\\\\\\\r?\\\\\\\\n\\\\\\\\s*\u002F)[0]}${symbolName}`;\n      } else {\n        toInsert = `, ${symbolName}`;\n      }\n    }\n  } else if (node.kind == ts.SyntaxKind.ArrayLiteralExpression) {\n    \u002F\u002F We found the field but it's empty. Insert it just before the `]`.\n    position--;\n    toInsert = `${symbolName}`;\n  } else {\n    \u002F\u002F Get the indentation of the last element, if any.\n    const text = node.getFullText(source);\n    if (text.match(\u002F^\\\\\\\\r?\\\\\\\\n\u002F)) {\n      toInsert = `,${text.match(\u002F^\\\\\\\\r?\\\\\\\\n(\\\\\\\\r?)\\\\\\\\s*\u002F)[0]}${symbolName}`;\n    } else {\n      toInsert = `, ${symbolName}`;\n    }\n  }\n  if (importPath !== null) {\n    return [\n      new InsertChange(ngModulePath, position, toInsert),\n      insertImport(source, ngModulePath, symbolName.replace(\u002F\\\\\\\\..*$\u002F, ''), importPath),\n    ];\n  }\n\n  return [new InsertChange(ngModulePath, position, toInsert)];\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВыглядит совершенно не вдохновляюще. Поэтому мы решили создать верхнеуровневую библиотеку, которая позволяет писать схематики намного проще.\u003C\u002Fp\u003E\u003Ch2\u003Eng-morph\u003C\u002Fh2\u003E\u003Cp\u003EВ основе библиотеки лежит\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fdsherret\u002Fts-morph\"\u003E\u003Cu\u003E ts-morph.\u003C\u002Fu\u003E\u003C\u002Fa\u003E По сути, ts-morph — это обертка над компилятором typescript, которая упрощает работу с AST.\u003C\u002Fp\u003E\u003Cp\u003EПредставляю вашему вниманию \u003Ccode\u003Eng-morph\u003C\u002Fcode\u003E. Это набор утилит, который позволит вам писать схематики намного проще и быстрее. Чтобы не быть голословным, предлагаю сразу рассмотреть несколько примеров с его использованием.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EЗадача № 1. \u003C\u002Fstrong\u003EДобавить импорт модуля \u003Ccode\u003ESomeModule\u003C\u002Fcode\u003E в корневой модуль приложения.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EРешение.\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"javascript\"\u003Econst rule: Rule = (tree: Tree, context: SchematicContext): void =\u003E {\n  setActiveProject(createProject(tree));\n\n  const appModule = getMainModule('src\u002Fmain.ts');\n\n  addImportToNgModule(appModule, 'SomeModule');\n\n  addImports(appModule.getFilePath(), {moduleSpecifier: '@some\u002Fpackage', namedExports: ['SomeModule']})\n\n  saveActiveProject();\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EРассмотрим решение построчно:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EСоздаем проект \u003Ccode\u003Eng-morph\u003C\u002Fcode\u003E и делаем его активным. Это важно, так как все утилитарные функции работают именно в контексте активного проекта. Под проектом нужно понимать класс, который дает API к файловой системе, компилятору и т. д.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EПо точке входа приложения находим главный модуль приложения.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EДобавляем в импорты найденного модуля новый.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EДобавляем импорт модуля в файл, где расположен корневой модуль.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EСохраняем проект.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EТеперь сравните это решение с функцией выше из исходников Angular. Если вы будете использовать \u003Ccode\u003Eng-morph\u003C\u002Fcode\u003E, скорее всего, вам не придется писать что-то подобное.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EЗадача № 2. \u003C\u002Fstrong\u003EВ проекте неожиданно меняется стиль написания имени для enum на uppercase.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EРешение. \u003C\u002Fstrong\u003EЛогичные вопросы: при чем здесь \u003Ccode\u003Eng-morph\u003C\u002Fcode\u003E? Ведь мы говорим про схематики, неужели нужно настраивать и писать схематики только для того, чтобы переименовать энамы?\u003C\u002Fp\u003E\u003Cp\u003EВсе верно. Схематики кажутся слишком сложными для переименования энамов. Но все же давайте посмотрим, что нам может предложить \u003Ccode\u003Eng-morph\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"javascript\"\u003EsetActiveProject(createProject(new NgMorphTree('\u002F')));\n\nconst enums = getEnums('\u002F**\u002F*.ts');\n\neditEnums(enums, ({name}) =\u003E ({name: name.toUpperCase()}))\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EСоздаем проект. Тут есть важное отличие: скрипт не завернут в функцию схематика и аргумент tree создается вручную с помощью класса NgMorphHost.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EИщем все enum в проекте.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EПереименовываем все enum.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EНа этом примере мы видим, что \u003Ccode\u003Eng-morph\u003C\u002Fcode\u003E умеет работать и вне функций схематиков! Да, мы используем \u003Ccode\u003Eng-morph\u003C\u002Fcode\u003E не только в схематиках и не только в Angular-проектах. \u003C\u002Fp\u003E\u003Ch2\u003EЧто еще умеет ng-moprh?\u003C\u002Fh2\u003E\u003Cp\u003E\u003Cstrong\u003EСоздавать\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"javascript\"\u003EcreateImports('\u002Fsrc\u002Fsome.ts', [\n  {\n    namedImports: ['CoreModule'],\n    moduleSpecifier: '@org\u002Fcore',\n    isTypeOnly: true,\n  }\n]);\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Cstrong\u003EИскать\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"javascript\"\u003Econst imports = getImports('src\u002F**\u002F*.ts', {\n  moduleSpecifier: '@org\u002F*',\n});\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Cstrong\u003EИзменять\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"javascript\"\u003EeditImports(imports, ({moduleSpecifier}) =\u003E ({\n  moduleSpecifier: moduleSpecifier.replace('@org', '@new-org')\n})\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003E\u003Cstrong\u003EУдалять\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"javascript\"\u003EremoveImports(imports)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПочти по каждой сущности в TS есть свой набор функций: \u003Ccode\u003Eget*\u003C\u002Fcode\u003E, \u003Ccode\u003Eedit*\u003C\u002Fcode\u003E, \u003Ccode\u003Eadd*\u003C\u002Fcode\u003E, \u003Ccode\u003Eremove*\u003C\u002Fcode\u003E. Например, \u003Ccode\u003EgetClass\u003C\u002Fcode\u003E, \u003Ccode\u003EremoveConstrucor\u003C\u002Fcode\u003E, \u003Ccode\u003EaddDecorator\u003C\u002Fcode\u003E. Начали появляться утилитарные функции для работы со специфичными для Angular кейсами:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EgetBootstrapFn\u003C\u002Fcode\u003E — функция, возвращающая \u003Ccode\u003ECallExpression\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EgetMainModule\u003C\u002Fcode\u003E — функция, которая возвращает декларацию главного модуля.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EКуча утилитарных функций по изменению метаданных сущностей Angular: \u003Ccode\u003EaddDeclarationToNgModule\u003C\u002Fcode\u003E, \u003Ccode\u003EaddProviderToDirective\u003C\u002Fcode\u003E и т. д.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003E\u003Ccode\u003Eng-morph\u003C\u002Fcode\u003E также содержит утилиты для работы с \u003Ccode\u003Ejson\u003C\u002Fcode\u003E. Например, для работы с зависимостями в \u003Ccode\u003Epackage.json\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"javascript\"\u003EaddPackageJsonDependency(tree, {\n  name: '@package\u002Fname',\n  version: '~2.0.0',\n  type: NodeDependencyType.Dev\n});\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EНо если нужна более низкоуровневая работы, всегда можно поработать с ts-morph API, а из него провалиться еще ниже — в API самого typescript.\u003C\u002Fp\u003E\u003Ch3\u003EВместо заключения\u003C\u002Fh3\u003E\u003Cp\u003EНа данный момент roadmap не существует. Мы достаточно быстро реализовали то, чего нам не хватало, и решили показать это сообществу. И, естественно, хочется развивать инструмент дальше.\u003C\u002Fp\u003E\u003Cp\u003EТем не менее список фич первой необходимости все же есть:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EВысокоуровневая работа с шаблонами.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EВысокоуровневая работа со стилями.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EНаращивание тулинга по работе с сущностями Angular.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EИ мы будем рады, если сообщество Angular поможет нам это сделать!\u003C\u002Fp\u003E\u003Ch3\u003EСсылки, которые вы так ждали\u003C\u002Fh3\u003E\u003Cp\u003EРепозиторий с кодом:\u003C\u002Fp\u003E\u003Cdiv class=\"embed_link\"\u003E\u003Cdiv class=\"embed__thumb\" style=\"background-image: url(&quot;https:\u002F\u002Fopengraph.githubassets.com\u002F04bc1c3bda29147f12447825788abe12e74113532dfa4d3782d894191aade9ae\u002FTinkoffCreditSystems\u002Fng-morph&quot;);\"\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"embed__caption\"\u003E\u003Cdiv class=\"embed__caption-title\"\u003E\u003Cspan\u003EGitHub - TinkoffCreditSystems\u002Fng-morph: Code mutations in schematics were never easier than now.\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FTinkoffCreditSystems\u002Fng-morph\" target=\"_blank\" rel=\"noopener noreferrer nofollow\" class=\"embed__caption-link\"\u003Egithub.com\u003C\u002Fa\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cp\u003EСайт с документацией и примерами:\u003C\u002Fp\u003E\u003Cdiv class=\"embed_link\"\u003E\u003Cdiv class=\"embed__thumb\" style=\"background-image: url(&quot;undefined&quot;);\"\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"embed__caption\"\u003E\u003Cdiv class=\"embed__caption-title\"\u003E\u003Cspan\u003Eng-morph\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E\u003Ca href=\"https:\u002F\u002Ftinkoffcreditsystems.github.io\u002Fng-morph\u002F\" target=\"_blank\" rel=\"noopener noreferrer nofollow\" class=\"embed__caption-link\"\u003Etinkoffcreditsystems.github.io\u003C\u002Fa\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Ch3\u003EУже используют ng-morph\u003C\u002Fh3\u003E\u003Cp\u003EИз известных мне — наша дружественная и лучшая библиотека компонентов для Angular:\u003C\u002Fp\u003E\u003Cdiv class=\"embed_link\"\u003E\u003Cdiv class=\"embed__thumb\" style=\"background-image: url(&quot;https:\u002F\u002Frepository-images.githubusercontent.com\u002F298620687\u002Fb5fd7180-46db-11eb-9c69-822a8e279ce8&quot;);\"\u003E\u003C\u002Fdiv\u003E\u003Cdiv class=\"embed__caption\"\u003E\u003Cdiv class=\"embed__caption-title\"\u003E\u003Cspan\u003EGitHub - TinkoffCreditSystems\u002Ftaiga-ui: Angular UI Kit and components library for awesome people\u003C\u002Fspan\u003E\u003C\u002Fdiv\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FTinkoffCreditSystems\u002Ftaiga-ui\" target=\"_blank\" rel=\"noopener noreferrer nofollow\" class=\"embed__caption-link\"\u003Egithub.com\u003C\u002Fa\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"angular"},{"titleHtml":"typescript"},{"titleHtml":"ast"},{"titleHtml":"мутация"},{"titleHtml":"модификация"},{"titleHtml":"ng-morph"},{"titleHtml":"ts-morph"},{"titleHtml":"schematic"},{"titleHtml":"schematics"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6bf\u002F125\u002F0de\u002F6bf1250de170cea1f21c38b92701d723.png","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6bf\u002F125\u002F0de\u002F6bf1250de170cea1f21c38b92701d723.png","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002Ftinkoff\\\u002Fblog\\\u002F582120\\\u002F\"},\"headline\":\"Как мутировать код в Angular-схематиках и не поседеть\",\"datePublished\":\"2021-10-07T12:15:58+03:00\",\"dateModified\":\"2021-10-07T12:34:55+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Игорь Кацуба\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Чтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002Ftinkoff\\\u002Fblog\\\u002F582120\\\u002F#post-content-body\",\"about\":[\"c_tinkoff\",\"h_javascript\",\"h_angular\",\"h_typescript\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F582120\\\u002Fb843a712bf2c825df681afe28dc8e91a\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F6bf\\\u002F125\\\u002F0de\\\u002F6bf1250de170cea1f21c38b92701d723.png\"]}","metaDescription":"Чтобы использовать Angular CLI на полную, разработчики должны знать, что такое схематики. Например, команды ng add, ng update и ng generate используют схематики для добавления, обновления и настройки...","mainImageUrl":null,"amp":true},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":""},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{"tinkoff":{"alias":"tinkoff","imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fcompany\u002F6f0\u002F965\u002Fc1f\u002F6f0965c1feae8a79dc103989aa6c7e91.png","titleHtml":"TINKOFF","descriptionHtml":"IT’s Tinkoff — просто о сложном","relatedData":null,"statistics":{"postsCount":275,"newsCount":2,"vacanciesCount":50,"employeesCount":192,"careerRating":null,"subscribersCount":38295,"rating":310.12,"invest":null},"foundationDate":{"year":"2005","month":"11","day":"18"},"location":{"city":null,"region":null,"country":{"id":"168","title":"Россия"}},"siteUrl":"https:\u002F\u002Fwww.tinkoff.ru\u002Fcareer\u002F","staffNumber":"5 001–10 000 человек","registrationDate":"2011-10-26T13:45:16+00:00","representativeUser":null,"contacts":[],"settings":{"analyticsSettings":[{"type":"ga","trackingId":"UA-9110453-17"}],"branding":{"imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fbranding\u002F2df\u002Fb89\u002F248\u002F2dfb89248ab9bc5d3c0794e44d25f33c.png","linkUrl":"","pixelUrl":""},"status":"active"},"metadata":{"titleHtml":"TINKOFF, Россия - IT’s Tinkoff — просто о сложном с 18 ноября 2005 г.","title":"TINKOFF, Россия - IT’s Tinkoff — просто о сложном с 18 ноября 2005 г.","keywords":["Разработка веб-сайтов","Angular","TypeScript","JavaScript","Разработка под Android"],"descriptionHtml":"275 статей от авторов компании TINKOFF","description":"275 статей от авторов компании TINKOFF"},"aDeskSettings":null,"careerAlias":"tinkoff","maxCustomTrackerLinks":3}},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
