<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Средства автоматизации анализа вредоносных программ / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/582976\/"},"headline":"Средства автоматизации анализа вредоносных программ","datePublished":"2021-10-12T12:38:54+03:00","dateModified":"2021-10-23T12:01:51+03:00","author":{"@type":"Person","name":"rivitna"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Часть 3-яДобрались-таки до окончания статьи. Правда, долог и тернист был этот путь...Пока не забыл, сразу хочу выразить благодарность своим друзьям за поддержку...","url":"https:\/\/habr.com\/ru\/post\/582976\/#post-content-body","about":["h_infosecurity","h_reverse-engineering","f_develop"],"image":["https:\/\/habr.com\/share\/publication\/582976\/a9477ad536660d3bfc18d98d5f93678b\/","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/372\/434\/509\/3724345099f8fce65bdd6a3a096c0213.jpeg","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/91d\/2a4\/efe\/91d2a4efe217125c2cdc0af8b3cb6407.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/3a4\/177\/456\/3a4177456feb90f80a58f85c29bc10f7.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/ccb\/7a1\/c56\/ccb7a1c56507276216f809c62bd52e61.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/8c4\/d18\/dfa\/8c4d18dfada0bbb506c53b47417dcaa2.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/2bd\/759\/647\/2bd7596470d9418d841912b7b251dd7d.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/906\/196\/c33\/906196c33d8675aa09cbf43a129e850f.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/fd1\/8b5\/af3\/fd18b5af33bc96e8de2ca3dc14fb7aa1.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/b5f\/798\/6f2\/b5f7986f252a59d162905817134c4b19.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/ff1\/e7a\/d3b\/ff1e7ad3bf9c6d25eabd730373f87034.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/817\/429\/e17\/817429e1752127cc83cf3eeaec17920b.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/7b3\/2fa\/3a0\/7b32fa3a0f46525abfa7d42b662ae5a1.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/d2d\/d2f\/ef8\/d2dd2fef85f65aee63c590bcf33102ea.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/fbb\/b8a\/586\/fbbb8a5861d3a985d049cafa00c3a629.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/67f\/122\/d03\/67f122d034352685211c4b2e2219dc4e.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/9a9\/b06\/ca4\/9a9b06ca4f206e29fc505e9a29f3233a.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/b97\/8fb\/bc7\/b978fbbc79462bcab4979e4bc0630575.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/b4a\/d15\/7ee\/b4ad157ee175276304d140bcbe20c5b5.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/70b\/deb\/d2a\/70bdebd2ada054ad75de75a4ca64ffea.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/53d\/d47\/ec6\/53dd47ec65a2d5378175d33e7fb6a8f5.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/190\/677\/056\/19067705685043c6632f7d06dced6ff8.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/44c\/017\/3cd\/44c0173cdc44af4acd97e145ea013a0a.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/384\/567\/2bb\/3845672bb2b1db4d7fa1ebcaa77eac21.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/8d0\/02d\/733\/8d002d73311ad4c7f752f9d42e623972.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/99c\/7e1\/d33\/99c7e1d33647be33493a1ed7440ee884.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Средства автоматизации анализа вредоносных программ" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Средства автоматизации анализа вредоносных программ" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Средства автоматизации анализа вредоносных программ" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Часть 3-яДобрались-таки до окончания статьи. Правда, долог и тернист был этот путь...Пока не забыл, сразу хочу выразить благодарность своим друзьям за поддержку и помощь в публикации статей. За то,..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Часть 3-яДобрались-таки до окончания статьи. Правда, долог и тернист был этот путь...Пока не забыл, сразу хочу выразить благодарность своим друзьям за поддержку и помощь в публикации статей. За то,..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Часть 3-яДобрались-таки до окончания статьи. Правда, долог и тернист был этот путь...Пока не забыл, сразу хочу выразить благодарность своим друзьям за поддержку и помощь в публикации статей. За то,..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Часть 3-яДобрались-таки до окончания статьи. Правда, долог и тернист был этот путь...Пока не забыл, сразу хочу выразить благодарность своим друзьям за поддержку и помощь в публикации статей. За то,..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Часть 3-яДобрались-таки до окончания статьи. Правда, долог и тернист был этот путь...Пока не забыл, сразу хочу выразить благодарность своим друзьям за поддержку и помощь в публикации статей. За то,..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habrastorage.org/getpro/habr/upload_files/372/434/509/3724345099f8fce65bdd6a3a096c0213.jpeg" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/372/434/509/3724345099f8fce65bdd6a3a096c0213.jpeg" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/372/434/509/3724345099f8fce65bdd6a3a096c0213.jpeg" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/372/434/509/3724345099f8fce65bdd6a3a096c0213.jpeg" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/372/434/509/3724345099f8fce65bdd6a3a096c0213.jpeg" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="582976" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-12T09:38:54.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/582976/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/582976/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habrastorage.org/getpro/habr/upload_files/372/434/509/3724345099f8fce65bdd6a3a096c0213.jpeg" data-vmid="image:href"><link data-vue-meta="ssr" rel="amphtml" href="https://habr.com/ru/amp/post/582976/">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/rivitna/" title="rivitna" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_pink"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="/ru/users/rivitna/" class="tm-user-info__username">
      rivitna
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-12T09:38:54.000Z" title="2021-10-12, 12:38">12  октября   в 12:38</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Средства автоматизации анализа вредоносных программ</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/infosecurity/" class="tm-article-snippet__hubs-item-link"><span>Информационная безопасность</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/reverse-engineering/" class="tm-article-snippet__hubs-item-link"><span>Реверс-инжиниринг</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><h2>Часть 3-я</h2><figure class="full-width "><img src="https://habrastorage.org/r/w780q1/getpro/habr/upload_files/372/434/509/3724345099f8fce65bdd6a3a096c0213.jpeg" width="2048" height="1365" data-src="https://habrastorage.org/getpro/habr/upload_files/372/434/509/3724345099f8fce65bdd6a3a096c0213.jpeg" data-blurred="true"/><figcaption></figcaption></figure><p>Добрались-таки до окончания статьи. Правда, долог и тернист был этот путь...</p><p>Пока не забыл, сразу хочу выразить благодарность своим друзьям за поддержку и помощь в публикации статей. За то, что всячески помогают, старательно читают статьи до конца и дают полезные советы и рекомендации. За то, что хвалят, но и критикуют меня, в том числе за чрезмерно бумерский юмор.</p><p>В <a href="https://habr.com/ru/post/570200/" rel="noopener noreferrer nofollow">первой части</a> я достойно "похоронил" группу <em>REvil</em>, а к 3-й они бодрые и полные сил после отпуска, но, правда, с некоторыми ключевыми потерями вернулись к своим "темным делам" и возобновили ненадолго работу своих серверов. Но как оказалось, это все же были "предсмертные судороги". К слову сказать, декриптор для <em>Kaseya</em>, оказывается, был "слит по ошибке"… Такие дела!</p><hr/><p>В <a href="https://habr.com/ru/post/572260/" rel="noopener noreferrer nofollow">предыдущей части</a> мы наконец-то расшифровали строки в образце <em>REvil</em>, а главное, научились делать это автоматизировано. Конечно, чудес не бывает, надо предварительно пореверсить и разобраться в функции расшифровки строк, а потом уже написать скрипт. При наличии навыков и готовых аналогичных скриптов, от которых можно отталкиваться, обычно сделать это не сложно, и времени займет не так много. Но зато при анализе других образцов того же семейства вредоносных программ готовый инструментарий значительно облегчит жизнь. Поэтому всегда стараюсь аккуратно раскладывать разработанный инструментарий по семействам и версиям, чтобы всегда иметь его под рукой. Под инструментарием я понимаю не только различные программы на <em>Python</em>, <em>IDAPython</em>, <em>x64dbgpy</em> и т.п., но и, например, различные правила, прежде всего, имею в виду, конечно, <em>YARA</em>-правила.</p><p>Также не могу не упомянуть об альтернативном способе автоматизированной расшифровки строк, заключающемся в непосредственных вызовах функций расшифровки. Для этого можно также воспользоваться богатым функционалом <em>IDA Pro</em>. Возможно, мы коснемся этого в одной из статей. Для меня же более предпочтителен способ, который я изложил во 2-й части. Но случаи, как известно, бывают разными…</p><p><strong>Деобфускация вызовов функций API</strong></p><p><strong>Вариант 1 (REvil)</strong></p><p>В <a href="https://habr.com/ru/post/570200/" rel="noopener noreferrer nofollow">первой части</a> статьи при расшифровке данных конфигурации наткнулись на функцию <em>sub_404E2C</em>. Судя по контексту, предположили, что она осуществляет выделение памяти, и дали ей соответствующее имя <em>_alloc</em>. И вот теперь самое время вернуться к этому и разобраться во всем.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Код функции _alloc (sub_404E2C)" title="Код функции _alloc (sub_404E2C)" height="722" data-src="https://habrastorage.org/getpro/habr/upload_files/91d/2a4/efe/91d2a4efe217125c2cdc0af8b3cb6407.png" data-width="930"/><figcaption>Код функции _alloc (sub_404E2C)</figcaption></figure><p>Внутри функции <em>_alloc </em>(<em>sub_404E2C</em>) осуществляются вызовы функций, адреса которых содержатся в глобальных переменных <em>dword_41150C</em> и <em>dword_411320</em> из секции данных "<em>.data</em>". По переменной <em>dword_41150C</em> смотрим список ссылок на нее (<em>xrefs</em>).</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Список ссылок (xrefs) на dword_41150C" title="Список ссылок (xrefs) на dword_41150C" height="574" data-src="https://habrastorage.org/getpro/habr/upload_files/3a4/177/456/3a4177456feb90f80a58f85c29bc10f7.png" data-width="825"/><figcaption>Список ссылок (xrefs) на dword_41150C</figcaption></figure><p>Как видно на изображении, осуществляются только вызовы функции, а непосредственного присвоения переменной нет. Если посмотреть соседние переменные, выяснится, что они также содержат адреса функций, при этом некоторые даже не используются. Можно предположить, что перед нами, по сути, <em>IAT</em> (<em>Import Address Table</em>), элементы которой изначально содержат некоторые "магические" 32-битные значения. Эти значения используются для идентификации функций и при старте программы заменяются фактическими адресами функций. Остается найти только начало таблицы.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Начало таблицы адресов функций API" title="Начало таблицы адресов функций API" height="507" data-src="https://habrastorage.org/getpro/habr/upload_files/ccb/7a1/c56/ccb7a1c56507276216f809c62bd52e61.png" data-width="823"/><figcaption>Начало таблицы адресов функций API</figcaption></figure><p>После недолгого поиска находим начало таблицы, переменная <em>dword_411298</em> является ее нулевым элементом. В окне <em>xrefs</em> видно, что присвоение элементам таблицы осуществляется с использованием индексной адресации со смещением в функции <em>sub_4073A3</em>.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Код функции получения адресов функций API (sub_4073A3)" title="Код функции получения адресов функций API (sub_4073A3)" height="228" data-src="https://habrastorage.org/getpro/habr/upload_files/8c4/d18/dfa/8c4d18dfada0bbb506c53b47417dcaa2.png" data-width="638"/><figcaption>Код функции получения адресов функций API (sub_4073A3)</figcaption></figure><p>Функция <em>sub_4073A3 </em>осуществляет заполнение таблицы импорта, для этого используется функция <em>sub_4075AE</em>, которая на вход получает "магическое" значение из таблицы, а возвращает фактический адрес функции. То есть функция <em>sub_4075AE</em> "разрешает" адрес функции по некоему значению. Обычно это значение представляет собой контрольную сумму (хеш) от имени функции <em>API</em>. Контрольная сумма может также включать в себя и имя библиотеки (<em>DLL</em>), которая экспортирует эту функцию. Алгоритмы подсчета контрольной суммы могут быть самыми разнообразными, это может быть и стандартный <em>CRC32</em>, и вообще любой, который взбредет в голову автору. Очевидно, что коллизий для функций <em>API</em> при этом быть не должно. Далее для получения адресов функций <em>API</em> производится перечисление <em>DLL</em> и экспортируемых ими функций, обычно это делается через <em>PEB</em> (<em>Process Environment Block</em>). При совпадении контрольной суммы (хеша) с указанным в коде программы извлекается адрес найденной функции.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Начальный фрагмент кода функции &quot;разрешения&quot; адреса функции API (sub_4075AE)" title="Начальный фрагмент кода функции &quot;разрешения&quot; адреса функции API (sub_4075AE)" height="575" data-src="https://habrastorage.org/getpro/habr/upload_files/2bd/759/647/2bd7596470d9418d841912b7b251dd7d.png" data-width="594"/><figcaption>Начальный фрагмент кода функции "разрешения" адреса функции API (sub_4075AE)</figcaption></figure><p>Код функции <em>sub_4075AE</em> навевает легкую грусть, причем на изображении приведен лишь небольшой фрагмент кода функции. Разбираться в коде функции для получения алгоритма вычисления контрольной суммы или нет? Ответ определяется, прежде всего, целесообразностью.</p><p>Мы же в данном случае пойдем легким путем. Итак, определимся с исходными данными. Итак, таблица начинается с <em>RVA</em> (<em>relative virtual address</em>) <em>11298h</em>, содержит <em>2F8h / 4 = 190</em> элементов, то есть функций <em>API</em>. Если поставить точку останова (<em>breakpoint</em>), например, на <em>RVA</em> <em>73С3h</em>, когда таблица импорта будет полностью заполнена, и извлечь значения всех элементов таблицы импорта, то можно получить полный список используемых функций <em>API</em>.</p><p>Что для этого потребуется? Виртуальная среда <em>Windows 7</em> и выше с установленным дополнительным программным обеспечением:</p><div><div class="table"><table><tbody><tr><td><p><a href="https://x64dbg.com" rel="noopener noreferrer nofollow">отладчик x64dbg</a></p></td></tr><tr><td><p><a href="https://github.com/x64dbg/x64dbgpy/releases/tag/b275005" rel="noopener noreferrer nofollow">плагин x64dbgpy</a></p></td></tr><tr><td><p><a href="https://www.python.org/downloads/release/python-2718/" rel="noopener noreferrer nofollow"><em>Python 2.7.18</em></a></p></td></tr></tbody></table></div></div><p>Осталось только разработать скрипт <em>x64dbgpy</em>. И он получился очень даже очень несложным.</p><pre><code class="python">import io
from x64dbgpy.pluginsdk import *


BREAK_RVA = 0x73C3
IMPORT_LIST_RVA = 0x11298
NUM_IMPORT_FUNCS = 0x2F8 // 4


Run()

base_addr = BaseFromAddr(GetEIP())

break_addr = base_addr + BREAK_RVA
SetBreakpoint(break_addr)

Run()

DeleteBreakpoint(break_addr)

with io.open('ida_import.txt', 'wb') as f:

    fnc_name_buf = ctypes.create_string_buffer(x64dbg.MAX_LABEL_SIZE)

    fnc_addr_rva = IMPORT_LIST_RVA

    for _ in range(NUM_IMPORT_FUNCS):

        fnc_addr = ReadDword(base_addr + fnc_addr_rva)
        if x64dbg.DbgGetLabelAt(fnc_addr, x64dbg.SEG_DEFAULT, fnc_name_buf):
            f.write(b'%08X\t%s\r\n' % (fnc_addr_rva, fnc_name_buf.value))

        fnc_addr_rva += 4</code></pre><p>Разберемся в его работе. Скрипт запускается сразу после открытия образца в отладчике. По умолчанию, при запуске отладчик первоначально останавливает отладку в точке входа образца (<em>entry point</em>), для этого в начале скрипта вызывается функция плагина <em>x64dbgpy</em> <em>Run.</em></p><figure class="full-width "><img src="/img/image-loader.svg" alt="Окно отладчика x64dbg" title="Окно отладчика x64dbg" height="796" data-src="https://habrastorage.org/getpro/habr/upload_files/906/196/c33/906196c33d8675aa09cbf43a129e850f.png" data-width="1274"/><figcaption>Окно отладчика x64dbg</figcaption></figure><p>При останове в точке входа в скрипте определяется базовый адрес, по которому загружен модуль, устанавливается точка останова для извлечения функций <em>API</em> (<em>RVA</em> <em>73C3h</em>) и возобновляется выполнение (<em>Run</em>). После останова в данной точке, в цикле извлекается значение каждого элемента таблицы, то есть фактический адрес функции <em>API</em> с помощью функции <em>ReadDword</em>, а далее по этому адресу определяется имя функции <em>API</em> с помощью замечательной функции <em>DbgGetLabelAt</em>, осуществляющей получение метки для указанного адреса.</p><p>В итоге после запуска скрипта получим текстовый файл <em>ida_import.txt</em>, который содержит <em>RVA</em> элементов таблицы импорта и соответствующие им имена функций <em>API</em>.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Результат работы скрипта x64dbgpy" title="Результат работы скрипта x64dbgpy" height="1152" data-src="https://habrastorage.org/getpro/habr/upload_files/fd1/8b5/af3/fd18b5af33bc96e8de2ca3dc14fb7aa1.png" data-width="957"/><figcaption>Результат работы скрипта x64dbgpy</figcaption></figure><p>Для переименования элементов таблицы импорта можно воспользоваться универсальным для подобных случаев скриптом на IDAPython.</p><pre><code class="python">import sys
import io
import idautils
import idaapi


IDA_IMPORT_FILENAME = 'ida_import.txt'


def read_import_func_list():

    func_list = []

    with io.open(IDA_IMPORT_FILENAME, 'rt') as f:

        for line in f:
            s = line.strip()
            if (s == ''):
                continue
            fnc_entry = s.split('\t', 2)
            fnc_rva = int(fnc_entry[0], 16)
            if (fnc_rva != 0) and (fnc_entry[1] != ''):
                func_list.append((fnc_rva, fnc_entry[1]))

    return func_list
            

func_list = read_import_func_list()
print(str(len(func_list)) + ' import functions loaded.')

for fnc_entry in func_list:

    fnc_ea = fnc_entry[0] + ida_nalt.get_imagebase()
    ida_bytes.create_data(fnc_ea, ida_bytes.FF_DWORD, 4, BADADDR)
    ida_name.set_name(fnc_ea, fnc_entry[1],
                      ida_name.SN_FORCE | ida_name.SN_NOWARN)</code></pre><p>Результат выполнения скрипта:</p><figure class="full-width "><img src="/img/image-loader.svg" height="987" data-src="https://habrastorage.org/getpro/habr/upload_files/b5f/798/6f2/b5f7986f252a59d162905817134c4b19.png" data-width="1577"/><figcaption></figcaption></figure><p>И напоследок с чего начинали, собственно функция <em>_alloc </em>(<em>sub_404E2C</em>):</p><figure class="full-width "><img src="/img/image-loader.svg" height="740" data-src="https://habrastorage.org/getpro/habr/upload_files/ff1/e7a/d3b/ff1e7ad3bf9c6d25eabd730373f87034.png" data-width="921"/><figcaption></figcaption></figure><p>Как видим, все отлично, причем <em>IDA</em> сама при переименовании установила прототипы функций <em>API</em>.</p><p><strong>Вариант 2 (BlackMatter)</strong></p><p>Ну а что у конкурентов? Тот же джентльменский набор: зашифрованные конфигурационные данные, обфускация строк и вызовов функций <em>API</em>. Но реализация несколько иная. Для демонстрации взял достаточно свежий образец <em>BlackMatter v2.0</em> (сборка 2021-09-26 08:10:51):</p><p><a href="https://www.virustotal.com/gui/file/fe2b2beeff98cae90f58a5b2f01dab31eaa98d274757a7dd9f70f4dc8432a6e2" rel="noopener noreferrer nofollow">VT</a></p><p><a href="https://app.any.run/tasks/206e5747-26c9-45a4-ad3d-7210939940e6/" rel="noopener noreferrer nofollow">ANY.RUN</a></p><figure class="full-width "><img src="/img/image-loader.svg" alt="Обфускация вызовов функций API" title="Обфускация вызовов функций API" height="741" data-src="https://habrastorage.org/getpro/habr/upload_files/817/429/e17/817429e1752127cc83cf3eeaec17920b.png" data-width="920"/><figcaption>Обфускация вызовов функций API</figcaption></figure><p>Сразу приведу фрагмент функции, которая отвечает за импорт в программе. Немного "причесал" ее, чтобы проще было разбираться.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Начальный фрагмент кода функции load_import" title="Начальный фрагмент кода функции load_import" height="843" data-src="https://habrastorage.org/getpro/habr/upload_files/7b3/2fa/3a0/7b32fa3a0f46525abfa7d42b662ae5a1.png" data-width="878"/><figcaption>Начальный фрагмент кода функции load_import</figcaption></figure><p>Функция <em>api_resolve</em> – собственно и есть та функция, которая "разрешает" адрес функции <em>API</em> по некоему магическому числу. Функция <em>load_lib_and_IAT</em> загружает <em>DLL</em> и заполняет для нее таблицу, своего рода <em>IAT</em> (<em>Import Address Table</em>), то есть получает с помощью <em>api_resolve</em> адреса необходимых функций <em>API</em>, экспортируемых данной <em>DLL</em>, и заносит их в таблицу. На самом деле, как потом выясним, в таблицу заносятся не совсем адреса функций <em>API</em>… На входе <em>load_lib_and_IAT</em> используется таблица, соответствующая каждой <em>DLL</em>, которую  назвал <em>IT</em> (<em>Import Table</em>). В начале каждой такой таблицы содержится 32-битное число, которое идентифицирует <em>DLL</em>, а далее следуют 32-битные числа, идентифицирующие функции <em>API</em>. В качестве маркера конца таблицы используется значение <em>0CCCCCCCCh</em>. Все 15 таблиц <em>IT</em>, соответствующих 15 <em>DLL</em>, содержатся в кодовой секции программы-вымогателя.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Таблицы IT в кодовой секции" title="Таблицы IT в кодовой секции" height="800" data-src="https://habrastorage.org/getpro/habr/upload_files/d2d/d2f/ef8/d2dd2fef85f65aee63c590bcf33102ea.png" data-width="931"/><figcaption>Таблицы IT в кодовой секции</figcaption></figure><p>С образцом <em>REvil</em> мы поленились разбираться с функцией получения адреса функции <em>API</em>. В данном же случае мы обойдемся исключительно статическим анализом.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Начало кода функции api_resolve" title="Начало кода функции api_resolve" height="761" data-src="https://habrastorage.org/getpro/habr/upload_files/fbb/b8a/586/fbbb8a5861d3a985d049cafa00c3a629.png" data-width="857"/><figcaption>Начало кода функции api_resolve</figcaption></figure><p>Не могу пройти мимо и не отметить оригинальное решение. В начальном фрагменте <em>api_resolve</em> видим 2 рекурсивных вызова, то есть при самом первом вызове функция дважды рекурсивно вызовет себя для получения адресов двух важных функций <em>API</em>, в принципе не трудно догадаться каких. В чем же оригинальность? По моему мнению, в самом подходе. Адреса функций <em>unknownfunc0 и unknownfunc1</em> будут гарантированно проинициализированы первыми при вызове <em>api_resolve</em>.</p><p>Теперь основной фрагмент функции, непосредственно отвечающий за "разрешение" адресов функций <em>API</em>.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="&quot;Разрешение&quot; адресов функций API" title="&quot;Разрешение&quot; адресов функций API" height="900" data-src="https://habrastorage.org/getpro/habr/upload_files/67f/122/d03/67f122d034352685211c4b2e2219dc4e.png" data-width="992"/><figcaption>"Разрешение" адресов функций API</figcaption></figure><p>Вначале осуществляется завуалированное получение адреса <em>PEB (fs:[30h])</em>. Понятно, для чего это сделано! Для затруднения анализа и автоматизированного выявления такого кода. Допустим, мое <em>YARA</em>-правило, написанное для выявления подобного кода перечисления модулей с помощью <em>PEB</em>, попросту не сработает. Такая же штука проделана при получении адреса <em>PE</em>-заголовка. В остальном далее все стандартно: перечисляются все загруженные модули и эскпортируемые ими функции. Для каждого такого сочетания считается контрольная сумма. Имя <em>DLL</em> содержится в <em>Unicode</em>, поэтому для подсчета контрольной суммы используется  функция под названием <em>get_wide_str_hash</em>, а для имени функции, которая в <em>ANSI</em>, – соответственно <em>get_str_hash</em>. Причем в качестве начального значения контрольной суммы для имени функции используется контрольная сумма имени DLL.</p><p>Теперь код самих функций получения контрольных сумм.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Код функции получения контрольной суммы строки Unicode" title="Код функции получения контрольной суммы строки Unicode" height="823" data-src="https://habrastorage.org/getpro/habr/upload_files/9a9/b06/ca4/9a9b06ca4f206e29fc505e9a29f3233a.png" data-width="921"/><figcaption>Код функции получения контрольной суммы строки Unicode</figcaption></figure><figure class="full-width "><img src="/img/image-loader.svg" alt="Код функции получения контрольной суммы строки ANSI" title="Код функции получения контрольной суммы строки ANSI" height="660" data-src="https://habrastorage.org/getpro/habr/upload_files/b97/8fb/bc7/b978fbbc79462bcab4979e4bc0630575.png" data-width="920"/><figcaption>Код функции получения контрольной суммы строки ANSI</figcaption></figure><p>По сути, не считая различия в типах используемых символов, эти функции практически идентичны, только в версии для Unicode при подсчете контрольной суммы все символы латиницы преобразуются в нижний регистр. Вообще инструкция <em>or ax, 20h</em> представляет собой простой и эффективный способ преобразования из верхнего регистра латиницы в нижний. Как видим, для подсчета контрольной суммы используется в цикле круговой сдвиг промежуточной суммы вправо на 13 (<em>ROR 13</em>) и сложение с кодом текущего символа. Вариации этого алгоритма достаточно популярны у авторов вредоносного ПО. Когда первоначально анализировал <em>BlaсkMatter</em>, мне, например, сразу вспомнился <em>Metasploit</em> / <em>Cobalt Strike</em>. Также обращаю внимание, что "бесполезный" код сложения и вычитания <em>61h</em> может стать отличным паттерном для <em>YARA</em>-правила для детектирования <em>BlackMatter</em>.</p><p>Реализация кода получения контрольных сумм на <em>Python</em>:</p><pre><code class="python">ror32 = lambda val, shift: \
    ((val &amp; 0xFFFFFFFF) >> (shift &amp; 0x1F)) | \
    ((val &lt;&lt; (32 - (shift &amp; 0x1F))) &amp; 0xFFFFFFFF)


def get_wide_str_hash(s, n=0):

    for ch in s:

        m = ord(ch)
        if (m >= 0x41) and (m &lt;= 0x5A):
            m |= 0x20
        n = m + ror32(n, 13)

    return ror32(n, 13)


def get_str_hash(s, n=0):

    for ch in s:

        n = ord(ch) + ror32(n, 13)

    return ror32(n, 13)


def get_api_func_name_hash(lib_name, fnc_name):

    return get_str_hash(fnc_name, get_wide_str_hash(lib_name, 0))</code></pre><p>А что дальше? Дальше следует получить все возможные имена <em>DLL</em> и функций <em>API</em>. Задача состоит в том, что необходимо написать скрипт, который получает список экспортируемых функций определенных <em>DLL</em> или же попросту всех <em>DLL</em> из <em>System32</em>. Для этого можно воспользоваться, например, готовым инструментом на <em>Python</em> для работы с <em>PE</em>–файлами <a href="https://github.com/erocarrera/pefile" rel="noopener noreferrer nofollow"><em>pefile</em></a> авторства <em>Ero Carrera</em>. Я же пользуюсь своим классом, который есть на моем <a href="https://github.com/rivitna/pe_tools" rel="noopener noreferrer nofollow"><em>GitHub'е</em></a>. На самом деле, что будет использоваться для достижения результата, не важно, главное, результат. Вариант такого списка, полученного в виде текстового файла <em>api_names.txt</em>, в качестве символа-разделителя используется символ табуляции:</p><figure class="full-width "><img src="/img/image-loader.svg" height="862" data-src="https://habrastorage.org/getpro/habr/upload_files/b4a/d15/7ee/b4ad157ee175276304d140bcbe20c5b5.png" data-width="599"/><figcaption></figcaption></figure><p>Такой готовый список в дальнейшем можно использовать в неизменном виде и для других аналогичных случаев. Далее с помощью него и скрипта на <em>Python</em> получаем список контрольных сумм имен функций <em>API</em> для данного конкретного случая:</p><pre><code class="python">import io


XOR_MASK = 0x43013FCC


with io.open('api_names.txt', 'rt') as f:
    func_names = f.read().splitlines()

with io.open('api_hashes.txt', 'wt') as f:
    for name in func_names:
        name = name.strip()
        if (name == ''):
            continue
        names = name.split('\t')
        h = get_api_func_name_hash(names[0], names[1]) ^ XOR_MASK
        f.write('%08X\t%s\n' % (h, names[1]))</code></pre><p>На изображении с начальным фрагментом <em>api_resolve</em> видно, что в коде программы содержатся не сами значения контрольных сумм функций <em>API</em>, а сложенные по модулю 2 (<em>XOR</em>) с неким 32-битным числом <em>43013FCCh</em>. И это дополнительный прием для усложнения анализа, в коде программы он используется практически везде, не только для контрольных сумм функций <em>API</em>, но и для строк, формируемых в стеке. В таблицах <em>IT</em> также содержатся значения контрольных сумм, сложенные по модулю 2 с числом <em>43013FCCh</em>. Поэтому при получении списка контрольных сумм этот факт выше был учтен, и полученные контрольные суммы были дополнительно сложены по модулю 2 с <em>43013FCCh</em>. Это число, с которым производится операция <em>XOR</em>, является произвольным, и от образца к образцу <em>BlackMatter</em> различается.</p><p>Фрагмент полученного списка с контрольными суммами функций <em>API </em>(текстовый файл <em>api_hashes.txt</em>), среди которых есть те самые, для получения адресов которых в <em>api_resolve</em> использовалась рекурсия.</p><figure class="full-width "><img src="/img/image-loader.svg" height="706" data-src="https://habrastorage.org/getpro/habr/upload_files/70b/deb/d2a/70bdebd2ada054ad75de75a4ca64ffea.png" data-width="559"/><figcaption></figcaption></figure><p>Это две низкоуровневые функции из <em>ntdll.dll</em>, которые используются для реализации функций <em>GetProcAddress</em> и <em>LoadLibraryExW</em> соответственно.</p><p>Вернемся снова к фрагменту функции <em>load_import</em>, но уже более понятному и читаемому. Теперь мы видим, что создается куча (<em>heap</em>), в которой допустимо выполнение кода, осуществляется получение адреса функции <em>HeapAlloc</em>. Дескриптор созданной кучи и адрес <em>HeapAlloc</em> вместе с адресом таблицы IT, содержащей контрольные суммы функций API, а также адресом таблицы IAT, куда в результате заносятся адреса функций, передаются в качестве аргументов при вызовах функций <em>load_lib_and_IAT.</em></p><figure class="full-width "><img src="/img/image-loader.svg" alt="Начальный фрагмент кода функции load_import" title="Начальный фрагмент кода функции load_import" height="941" data-src="https://habrastorage.org/getpro/habr/upload_files/53d/d47/ec6/53dd47ec65a2d5378175d33e7fb6a8f5.png" data-width="986"/><figcaption>Начальный фрагмент кода функции load_import</figcaption></figure><p>Код функции <em>load_lib_and_IAT</em>, пожалуй, приведу практически весь.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="Начальный фрагмент функции load_lib_and_IAT" title="Начальный фрагмент функции load_lib_and_IAT" height="900" data-src="https://habrastorage.org/getpro/habr/upload_files/190/677/056/19067705685043c6632f7d06dced6ff8.png" data-width="1112"/><figcaption>Начальный фрагмент функции load_lib_and_IAT</figcaption></figure><p>Как уже было сказано ранее, первый элемент таблицы <em>IT</em> содержит контрольную сумму имени <em>DLL</em>, и с помощью <em>load_lib</em> осуществляется загрузка требуемой <em>DLL</em>. А далее для всех следующих элементов и до конца таблицы (<em>0ССССССССh</em>) определяется соответствующий адрес функции API, выделяется блок памяти на куче размером 16 байт, в который записывается случайно выбранный обфусцированный код вызова функции <em>API</em> (5 вариантов). Об этом также говорилось выше, что в <em>IAT</em> записываются не совсем адреса функций <em>API</em>.</p><figure class="full-width "><img src="/img/image-loader.svg" alt="" title="" height="921" data-src="https://habrastorage.org/getpro/habr/upload_files/44c/017/3cd/44c0173cdc44af4acd97e145ea013a0a.png" data-width="924"/><figcaption></figcaption></figure><figure class="full-width "><img src="/img/image-loader.svg" alt="Создание обфусцированного кода вызова функции API" title="Создание обфусцированного кода вызова функции API" height="801" data-src="https://habrastorage.org/getpro/habr/upload_files/384/567/2bb/3845672bb2b1db4d7fa1ebcaa77eac21.png" data-width="923"/><figcaption>Создание обфусцированного кода вызова функции API</figcaption></figure><p>Как видим, таблицы <em>IAT</em> в итоге содержат адреса на обфусцированный код вызова соответствующих функций <em>API</em>. Я специально остановился на этом моменте, чтобы продемонстрировать, какие сложности вызовет деобфускация только с помощью отладчика. А для нас же это совершенно не важно, как обфусцируется вызов функций, анализ осуществляется статически, каждый элемент таблицы <em>IAT</em> можно смело переименовать соответственно имени функции <em>API</em>, и суть от этого совершенно не изменится, так как в том или ином виде осуществляется вызов конкретной функции <em>API</em>. Таким образом, остается только написать скрипт <em>IDAPython</em>, который, используя ранее полученный список контрольных сумм функций <em>API</em>, переименует элементы всех таблиц <em>IAT</em>. Для этого можно воспользоваться подходом, аналогичным тому, что был использован в <a href="https://habr.com/ru/post/572260/" rel="noopener noreferrer nofollow">предыдущей части </a>для деобфускации строк. Приводить это скрипт, пожалуй, не буду. :-) Интереснее и полезнее его будет написать самостоятельно.</p><p>Конечный результат же будет таков:</p><figure class="full-width "><img src="/img/image-loader.svg" height="942" data-src="https://habrastorage.org/getpro/habr/upload_files/8d0/02d/733/8d002d73311ad4c7f752f9d42e623972.png" data-width="1072"/><figcaption></figcaption></figure><p>И фрагмент кода <em>BlackMatter</em>, который был вначале:</p><figure class="full-width "><img src="/img/image-loader.svg" height="741" data-src="https://habrastorage.org/getpro/habr/upload_files/99c/7e1/d33/99c7e1d33647be33493a1ed7440ee884.png" data-width="920"/><figcaption></figcaption></figure><p>Большая часть приведенных в статье скриптов содержится в моем <a href="https://github.com/rivitna/Malware" rel="noopener noreferrer nofollow"><em>GitHub'е</em></a>.</p><hr/><p>Всем огромное спасибо за внимание и терпение!</p></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%80%D0%B5%D0%B2%D0%B5%D1%80%D1%81-%D0%B8%D0%BD%D0%B6%D0%B8%D0%BD%D0%B8%D1%80%D0%B8%D0%BD%D0%B3%5D" class="tm-tags-list__link">реверс-инжиниринг</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bmalware%20analysis%5D" class="tm-tags-list__link">malware analysis</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bwindows%5D" class="tm-tags-list__link">windows</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D0%B2%D1%80%D0%B5%D0%B4%D0%BE%D0%BD%D0%BE%D1%81%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%BF%D0%BE%5D" class="tm-tags-list__link">анализ вредоносного по</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%20%D0%B2%D1%80%D0%B5%D0%B4%D0%BE%D0%BD%D0%BE%D1%81%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%BA%D0%BE%D0%B4%D0%B0%5D" class="tm-tags-list__link">анализ вредоносного кода</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/infosecurity/" class="tm-hubs-list__link">
    Информационная безопасность
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/reverse-engineering/" class="tm-hubs-list__link">
    Реверс-инжиниринг
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 5: ↑5 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 5: ↑5 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+5</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">1.1K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    16
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/rivitna/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_pink"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 23 голоса " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    23
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">5</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><!----> <a href="/ru/users/rivitna/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @rivitna
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Malware analyst, reverse engineer, APT researcher</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/582976/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 4 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/582976/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/582976/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"582976":{"id":"582976","timePublished":"2021-10-12T09:38:54+00:00","isCorporative":false,"lang":"ru","titleHtml":"Средства автоматизации анализа вредоносных программ","leadData":{"textHtml":"\u003Cp\u003EЗаключительная часть статьи, посвященной средствам автоматизации анализа вредоносных программ. В этой части рассматриваются способы деобфускации вызовов функций \u003Cem\u003EAPI\u003C\u002Fem\u003E на примере программ-вымогателей \u003Cem\u003EREvil\u003C\u002Fem\u003E и \u003Cem\u003EBlackMatter\u003C\u002Fem\u003E.\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F372\u002F434\u002F509\u002F3724345099f8fce65bdd6a3a096c0213.jpeg","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F372\u002F434\u002F509\u002F3724345099f8fce65bdd6a3a096c0213.jpeg","fit":"cover","positionY":0,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":23,"votesCount":23},"rating":5,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"1477535","alias":"rivitna","fullname":null,"avatarUrl":null,"speciality":"Malware analyst, reverse engineer, APT researcher"},"statistics":{"commentsCount":4,"favoritesCount":16,"readingCount":1097,"score":5,"votesCount":5},"hubs":[{"relatedData":null,"id":"50","alias":"infosecurity","type":"collective","title":"Информационная безопасность","titleHtml":"Информационная безопасность","isProfiled":true},{"relatedData":null,"id":"19011","alias":"reverse-engineering","type":"collective","title":"Реверс-инжиниринг","titleHtml":"Реверс-инжиниринг","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Ch2\u003EЧасть 3-я\u003C\u002Fh2\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F372\u002F434\u002F509\u002F3724345099f8fce65bdd6a3a096c0213.jpeg\" width=\"2048\" height=\"1365\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F372\u002F434\u002F509\u002F3724345099f8fce65bdd6a3a096c0213.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДобрались-таки до окончания статьи. Правда, долог и тернист был этот путь...\u003C\u002Fp\u003E\u003Cp\u003EПока не забыл, сразу хочу выразить благодарность своим друзьям за поддержку и помощь в публикации статей. За то, что всячески помогают, старательно читают статьи до конца и дают полезные советы и рекомендации. За то, что хвалят, но и критикуют меня, в том числе за чрезмерно бумерский юмор.\u003C\u002Fp\u003E\u003Cp\u003EВ \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F570200\u002F\" rel=\"noopener noreferrer nofollow\"\u003Eпервой части\u003C\u002Fa\u003E я достойно \"похоронил\" группу \u003Cem\u003EREvil\u003C\u002Fem\u003E, а к 3-й они бодрые и полные сил после отпуска, но, правда, с некоторыми ключевыми потерями вернулись к своим \"темным делам\" и возобновили ненадолго работу своих серверов. Но как оказалось, это все же были \"предсмертные судороги\". К слову сказать, декриптор для \u003Cem\u003EKaseya\u003C\u002Fem\u003E, оказывается, был \"слит по ошибке\"… Такие дела!\u003C\u002Fp\u003E\u003Chr\u002F\u003E\u003Cp\u003EВ \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F572260\u002F\" rel=\"noopener noreferrer nofollow\"\u003Eпредыдущей части\u003C\u002Fa\u003E мы наконец-то расшифровали строки в образце \u003Cem\u003EREvil\u003C\u002Fem\u003E, а главное, научились делать это автоматизировано. Конечно, чудес не бывает, надо предварительно пореверсить и разобраться в функции расшифровки строк, а потом уже написать скрипт. При наличии навыков и готовых аналогичных скриптов, от которых можно отталкиваться, обычно сделать это не сложно, и времени займет не так много. Но зато при анализе других образцов того же семейства вредоносных программ готовый инструментарий значительно облегчит жизнь. Поэтому всегда стараюсь аккуратно раскладывать разработанный инструментарий по семействам и версиям, чтобы всегда иметь его под рукой. Под инструментарием я понимаю не только различные программы на \u003Cem\u003EPython\u003C\u002Fem\u003E, \u003Cem\u003EIDAPython\u003C\u002Fem\u003E, \u003Cem\u003Ex64dbgpy\u003C\u002Fem\u003E и т.п., но и, например, различные правила, прежде всего, имею в виду, конечно, \u003Cem\u003EYARA\u003C\u002Fem\u003E-правила.\u003C\u002Fp\u003E\u003Cp\u003EТакже не могу не упомянуть об альтернативном способе автоматизированной расшифровки строк, заключающемся в непосредственных вызовах функций расшифровки. Для этого можно также воспользоваться богатым функционалом \u003Cem\u003EIDA Pro\u003C\u002Fem\u003E. Возможно, мы коснемся этого в одной из статей. Для меня же более предпочтителен способ, который я изложил во 2-й части. Но случаи, как известно, бывают разными…\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EДеобфускация вызовов функций API\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EВариант 1 (REvil)\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EВ \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F570200\u002F\" rel=\"noopener noreferrer nofollow\"\u003Eпервой части\u003C\u002Fa\u003E статьи при расшифровке данных конфигурации наткнулись на функцию \u003Cem\u003Esub_404E2C\u003C\u002Fem\u003E. Судя по контексту, предположили, что она осуществляет выделение памяти, и дали ей соответствующее имя \u003Cem\u003E_alloc\u003C\u002Fem\u003E. И вот теперь самое время вернуться к этому и разобраться во всем.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Код функции _alloc (sub_404E2C)\" title=\"Код функции _alloc (sub_404E2C)\" height=\"722\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F91d\u002F2a4\u002Fefe\u002F91d2a4efe217125c2cdc0af8b3cb6407.png\" data-width=\"930\"\u002F\u003E\u003Cfigcaption\u003EКод функции _alloc (sub_404E2C)\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВнутри функции \u003Cem\u003E_alloc \u003C\u002Fem\u003E(\u003Cem\u003Esub_404E2C\u003C\u002Fem\u003E) осуществляются вызовы функций, адреса которых содержатся в глобальных переменных \u003Cem\u003Edword_41150C\u003C\u002Fem\u003E и \u003Cem\u003Edword_411320\u003C\u002Fem\u003E из секции данных \"\u003Cem\u003E.data\u003C\u002Fem\u003E\". По переменной \u003Cem\u003Edword_41150C\u003C\u002Fem\u003E смотрим список ссылок на нее (\u003Cem\u003Exrefs\u003C\u002Fem\u003E).\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Список ссылок (xrefs) на dword_41150C\" title=\"Список ссылок (xrefs) на dword_41150C\" height=\"574\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F3a4\u002F177\u002F456\u002F3a4177456feb90f80a58f85c29bc10f7.png\" data-width=\"825\"\u002F\u003E\u003Cfigcaption\u003EСписок ссылок (xrefs) на dword_41150C\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак видно на изображении, осуществляются только вызовы функции, а непосредственного присвоения переменной нет. Если посмотреть соседние переменные, выяснится, что они также содержат адреса функций, при этом некоторые даже не используются. Можно предположить, что перед нами, по сути, \u003Cem\u003EIAT\u003C\u002Fem\u003E (\u003Cem\u003EImport Address Table\u003C\u002Fem\u003E), элементы которой изначально содержат некоторые \"магические\" 32-битные значения. Эти значения используются для идентификации функций и при старте программы заменяются фактическими адресами функций. Остается найти только начало таблицы.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Начало таблицы адресов функций API\" title=\"Начало таблицы адресов функций API\" height=\"507\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fccb\u002F7a1\u002Fc56\u002Fccb7a1c56507276216f809c62bd52e61.png\" data-width=\"823\"\u002F\u003E\u003Cfigcaption\u003EНачало таблицы адресов функций API\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПосле недолгого поиска находим начало таблицы, переменная \u003Cem\u003Edword_411298\u003C\u002Fem\u003E является ее нулевым элементом. В окне \u003Cem\u003Exrefs\u003C\u002Fem\u003E видно, что присвоение элементам таблицы осуществляется с использованием индексной адресации со смещением в функции \u003Cem\u003Esub_4073A3\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Код функции получения адресов функций API (sub_4073A3)\" title=\"Код функции получения адресов функций API (sub_4073A3)\" height=\"228\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8c4\u002Fd18\u002Fdfa\u002F8c4d18dfada0bbb506c53b47417dcaa2.png\" data-width=\"638\"\u002F\u003E\u003Cfigcaption\u003EКод функции получения адресов функций API (sub_4073A3)\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EФункция \u003Cem\u003Esub_4073A3 \u003C\u002Fem\u003Eосуществляет заполнение таблицы импорта, для этого используется функция \u003Cem\u003Esub_4075AE\u003C\u002Fem\u003E, которая на вход получает \"магическое\" значение из таблицы, а возвращает фактический адрес функции. То есть функция \u003Cem\u003Esub_4075AE\u003C\u002Fem\u003E \"разрешает\" адрес функции по некоему значению. Обычно это значение представляет собой контрольную сумму (хеш) от имени функции \u003Cem\u003EAPI\u003C\u002Fem\u003E. Контрольная сумма может также включать в себя и имя библиотеки (\u003Cem\u003EDLL\u003C\u002Fem\u003E), которая экспортирует эту функцию. Алгоритмы подсчета контрольной суммы могут быть самыми разнообразными, это может быть и стандартный \u003Cem\u003ECRC32\u003C\u002Fem\u003E, и вообще любой, который взбредет в голову автору. Очевидно, что коллизий для функций \u003Cem\u003EAPI\u003C\u002Fem\u003E при этом быть не должно. Далее для получения адресов функций \u003Cem\u003EAPI\u003C\u002Fem\u003E производится перечисление \u003Cem\u003EDLL\u003C\u002Fem\u003E и экспортируемых ими функций, обычно это делается через \u003Cem\u003EPEB\u003C\u002Fem\u003E (\u003Cem\u003EProcess Environment Block\u003C\u002Fem\u003E). При совпадении контрольной суммы (хеша) с указанным в коде программы извлекается адрес найденной функции.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Начальный фрагмент кода функции &quot;разрешения&quot; адреса функции API (sub_4075AE)\" title=\"Начальный фрагмент кода функции &quot;разрешения&quot; адреса функции API (sub_4075AE)\" height=\"575\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F2bd\u002F759\u002F647\u002F2bd7596470d9418d841912b7b251dd7d.png\" data-width=\"594\"\u002F\u003E\u003Cfigcaption\u003EНачальный фрагмент кода функции \"разрешения\" адреса функции API (sub_4075AE)\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКод функции \u003Cem\u003Esub_4075AE\u003C\u002Fem\u003E навевает легкую грусть, причем на изображении приведен лишь небольшой фрагмент кода функции. Разбираться в коде функции для получения алгоритма вычисления контрольной суммы или нет? Ответ определяется, прежде всего, целесообразностью.\u003C\u002Fp\u003E\u003Cp\u003EМы же в данном случае пойдем легким путем. Итак, определимся с исходными данными. Итак, таблица начинается с \u003Cem\u003ERVA\u003C\u002Fem\u003E (\u003Cem\u003Erelative virtual address\u003C\u002Fem\u003E) \u003Cem\u003E11298h\u003C\u002Fem\u003E, содержит \u003Cem\u003E2F8h \u002F 4 = 190\u003C\u002Fem\u003E элементов, то есть функций \u003Cem\u003EAPI\u003C\u002Fem\u003E. Если поставить точку останова (\u003Cem\u003Ebreakpoint\u003C\u002Fem\u003E), например, на \u003Cem\u003ERVA\u003C\u002Fem\u003E \u003Cem\u003E73С3h\u003C\u002Fem\u003E, когда таблица импорта будет полностью заполнена, и извлечь значения всех элементов таблицы импорта, то можно получить полный список используемых функций \u003Cem\u003EAPI\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cp\u003EЧто для этого потребуется? Виртуальная среда \u003Cem\u003EWindows 7\u003C\u002Fem\u003E и выше с установленным дополнительным программным обеспечением:\u003C\u002Fp\u003E\u003Cdiv\u003E\u003Cdiv class=\"table\"\u003E\u003Ctable\u003E\u003Ctbody\u003E\u003Ctr\u003E\u003Ctd\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fx64dbg.com\" rel=\"noopener noreferrer nofollow\"\u003Eотладчик x64dbg\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fx64dbg\u002Fx64dbgpy\u002Freleases\u002Ftag\u002Fb275005\" rel=\"noopener noreferrer nofollow\"\u003Eплагин x64dbgpy\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fwww.python.org\u002Fdownloads\u002Frelease\u002Fpython-2718\u002F\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003EPython 2.7.18\u003C\u002Fem\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003C\u002Ftbody\u003E\u003C\u002Ftable\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cp\u003EОсталось только разработать скрипт \u003Cem\u003Ex64dbgpy\u003C\u002Fem\u003E. И он получился очень даже очень несложным.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Eimport io\nfrom x64dbgpy.pluginsdk import *\n\n\nBREAK_RVA = 0x73C3\nIMPORT_LIST_RVA = 0x11298\nNUM_IMPORT_FUNCS = 0x2F8 \u002F\u002F 4\n\n\nRun()\n\nbase_addr = BaseFromAddr(GetEIP())\n\nbreak_addr = base_addr + BREAK_RVA\nSetBreakpoint(break_addr)\n\nRun()\n\nDeleteBreakpoint(break_addr)\n\nwith io.open('ida_import.txt', 'wb') as f:\n\n    fnc_name_buf = ctypes.create_string_buffer(x64dbg.MAX_LABEL_SIZE)\n\n    fnc_addr_rva = IMPORT_LIST_RVA\n\n    for _ in range(NUM_IMPORT_FUNCS):\n\n        fnc_addr = ReadDword(base_addr + fnc_addr_rva)\n        if x64dbg.DbgGetLabelAt(fnc_addr, x64dbg.SEG_DEFAULT, fnc_name_buf):\n            f.write(b'%08X\\t%s\\r\\n' % (fnc_addr_rva, fnc_name_buf.value))\n\n        fnc_addr_rva += 4\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EРазберемся в его работе. Скрипт запускается сразу после открытия образца в отладчике. По умолчанию, при запуске отладчик первоначально останавливает отладку в точке входа образца (\u003Cem\u003Eentry point\u003C\u002Fem\u003E), для этого в начале скрипта вызывается функция плагина \u003Cem\u003Ex64dbgpy\u003C\u002Fem\u003E \u003Cem\u003ERun.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Окно отладчика x64dbg\" title=\"Окно отладчика x64dbg\" height=\"796\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F906\u002F196\u002Fc33\u002F906196c33d8675aa09cbf43a129e850f.png\" data-width=\"1274\"\u002F\u003E\u003Cfigcaption\u003EОкно отладчика x64dbg\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПри останове в точке входа в скрипте определяется базовый адрес, по которому загружен модуль, устанавливается точка останова для извлечения функций \u003Cem\u003EAPI\u003C\u002Fem\u003E (\u003Cem\u003ERVA\u003C\u002Fem\u003E \u003Cem\u003E73C3h\u003C\u002Fem\u003E) и возобновляется выполнение (\u003Cem\u003ERun\u003C\u002Fem\u003E). После останова в данной точке, в цикле извлекается значение каждого элемента таблицы, то есть фактический адрес функции \u003Cem\u003EAPI\u003C\u002Fem\u003E с помощью функции \u003Cem\u003EReadDword\u003C\u002Fem\u003E, а далее по этому адресу определяется имя функции \u003Cem\u003EAPI\u003C\u002Fem\u003E с помощью замечательной функции \u003Cem\u003EDbgGetLabelAt\u003C\u002Fem\u003E, осуществляющей получение метки для указанного адреса.\u003C\u002Fp\u003E\u003Cp\u003EВ итоге после запуска скрипта получим текстовый файл \u003Cem\u003Eida_import.txt\u003C\u002Fem\u003E, который содержит \u003Cem\u003ERVA\u003C\u002Fem\u003E элементов таблицы импорта и соответствующие им имена функций \u003Cem\u003EAPI\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Результат работы скрипта x64dbgpy\" title=\"Результат работы скрипта x64dbgpy\" height=\"1152\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffd1\u002F8b5\u002Faf3\u002Ffd18b5af33bc96e8de2ca3dc14fb7aa1.png\" data-width=\"957\"\u002F\u003E\u003Cfigcaption\u003EРезультат работы скрипта x64dbgpy\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EДля переименования элементов таблицы импорта можно воспользоваться универсальным для подобных случаев скриптом на IDAPython.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Eimport sys\nimport io\nimport idautils\nimport idaapi\n\n\nIDA_IMPORT_FILENAME = 'ida_import.txt'\n\n\ndef read_import_func_list():\n\n    func_list = []\n\n    with io.open(IDA_IMPORT_FILENAME, 'rt') as f:\n\n        for line in f:\n            s = line.strip()\n            if (s == ''):\n                continue\n            fnc_entry = s.split('\\t', 2)\n            fnc_rva = int(fnc_entry[0], 16)\n            if (fnc_rva != 0) and (fnc_entry[1] != ''):\n                func_list.append((fnc_rva, fnc_entry[1]))\n\n    return func_list\n            \n\nfunc_list = read_import_func_list()\nprint(str(len(func_list)) + ' import functions loaded.')\n\nfor fnc_entry in func_list:\n\n    fnc_ea = fnc_entry[0] + ida_nalt.get_imagebase()\n    ida_bytes.create_data(fnc_ea, ida_bytes.FF_DWORD, 4, BADADDR)\n    ida_name.set_name(fnc_ea, fnc_entry[1],\n                      ida_name.SN_FORCE | ida_name.SN_NOWARN)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EРезультат выполнения скрипта:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"987\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb5f\u002F798\u002F6f2\u002Fb5f7986f252a59d162905817134c4b19.png\" data-width=\"1577\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EИ напоследок с чего начинали, собственно функция \u003Cem\u003E_alloc \u003C\u002Fem\u003E(\u003Cem\u003Esub_404E2C\u003C\u002Fem\u003E):\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"740\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fff1\u002Fe7a\u002Fd3b\u002Fff1e7ad3bf9c6d25eabd730373f87034.png\" data-width=\"921\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак видим, все отлично, причем \u003Cem\u003EIDA\u003C\u002Fem\u003E сама при переименовании установила прототипы функций \u003Cem\u003EAPI\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003EВариант 2 (BlackMatter)\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EНу а что у конкурентов? Тот же джентльменский набор: зашифрованные конфигурационные данные, обфускация строк и вызовов функций \u003Cem\u003EAPI\u003C\u002Fem\u003E. Но реализация несколько иная. Для демонстрации взял достаточно свежий образец \u003Cem\u003EBlackMatter v2.0\u003C\u002Fem\u003E (сборка 2021-09-26 08:10:51):\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fwww.virustotal.com\u002Fgui\u002Ffile\u002Ffe2b2beeff98cae90f58a5b2f01dab31eaa98d274757a7dd9f70f4dc8432a6e2\" rel=\"noopener noreferrer nofollow\"\u003EVT\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fapp.any.run\u002Ftasks\u002F206e5747-26c9-45a4-ad3d-7210939940e6\u002F\" rel=\"noopener noreferrer nofollow\"\u003EANY.RUN\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Обфускация вызовов функций API\" title=\"Обфускация вызовов функций API\" height=\"741\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F817\u002F429\u002Fe17\u002F817429e1752127cc83cf3eeaec17920b.png\" data-width=\"920\"\u002F\u003E\u003Cfigcaption\u003EОбфускация вызовов функций API\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EСразу приведу фрагмент функции, которая отвечает за импорт в программе. Немного \"причесал\" ее, чтобы проще было разбираться.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Начальный фрагмент кода функции load_import\" title=\"Начальный фрагмент кода функции load_import\" height=\"843\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F7b3\u002F2fa\u002F3a0\u002F7b32fa3a0f46525abfa7d42b662ae5a1.png\" data-width=\"878\"\u002F\u003E\u003Cfigcaption\u003EНачальный фрагмент кода функции load_import\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EФункция \u003Cem\u003Eapi_resolve\u003C\u002Fem\u003E – собственно и есть та функция, которая \"разрешает\" адрес функции \u003Cem\u003EAPI\u003C\u002Fem\u003E по некоему магическому числу. Функция \u003Cem\u003Eload_lib_and_IAT\u003C\u002Fem\u003E загружает \u003Cem\u003EDLL\u003C\u002Fem\u003E и заполняет для нее таблицу, своего рода \u003Cem\u003EIAT\u003C\u002Fem\u003E (\u003Cem\u003EImport Address Table\u003C\u002Fem\u003E), то есть получает с помощью \u003Cem\u003Eapi_resolve\u003C\u002Fem\u003E адреса необходимых функций \u003Cem\u003EAPI\u003C\u002Fem\u003E, экспортируемых данной \u003Cem\u003EDLL\u003C\u002Fem\u003E, и заносит их в таблицу. На самом деле, как потом выясним, в таблицу заносятся не совсем адреса функций \u003Cem\u003EAPI\u003C\u002Fem\u003E… На входе \u003Cem\u003Eload_lib_and_IAT\u003C\u002Fem\u003E используется таблица, соответствующая каждой \u003Cem\u003EDLL\u003C\u002Fem\u003E, которую  назвал \u003Cem\u003EIT\u003C\u002Fem\u003E (\u003Cem\u003EImport Table\u003C\u002Fem\u003E). В начале каждой такой таблицы содержится 32-битное число, которое идентифицирует \u003Cem\u003EDLL\u003C\u002Fem\u003E, а далее следуют 32-битные числа, идентифицирующие функции \u003Cem\u003EAPI\u003C\u002Fem\u003E. В качестве маркера конца таблицы используется значение \u003Cem\u003E0CCCCCCCCh\u003C\u002Fem\u003E. Все 15 таблиц \u003Cem\u003EIT\u003C\u002Fem\u003E, соответствующих 15 \u003Cem\u003EDLL\u003C\u002Fem\u003E, содержатся в кодовой секции программы-вымогателя.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Таблицы IT в кодовой секции\" title=\"Таблицы IT в кодовой секции\" height=\"800\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fd2d\u002Fd2f\u002Fef8\u002Fd2dd2fef85f65aee63c590bcf33102ea.png\" data-width=\"931\"\u002F\u003E\u003Cfigcaption\u003EТаблицы IT в кодовой секции\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EС образцом \u003Cem\u003EREvil\u003C\u002Fem\u003E мы поленились разбираться с функцией получения адреса функции \u003Cem\u003EAPI\u003C\u002Fem\u003E. В данном же случае мы обойдемся исключительно статическим анализом.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Начало кода функции api_resolve\" title=\"Начало кода функции api_resolve\" height=\"761\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffbb\u002Fb8a\u002F586\u002Ffbbb8a5861d3a985d049cafa00c3a629.png\" data-width=\"857\"\u002F\u003E\u003Cfigcaption\u003EНачало кода функции api_resolve\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EНе могу пройти мимо и не отметить оригинальное решение. В начальном фрагменте \u003Cem\u003Eapi_resolve\u003C\u002Fem\u003E видим 2 рекурсивных вызова, то есть при самом первом вызове функция дважды рекурсивно вызовет себя для получения адресов двух важных функций \u003Cem\u003EAPI\u003C\u002Fem\u003E, в принципе не трудно догадаться каких. В чем же оригинальность? По моему мнению, в самом подходе. Адреса функций \u003Cem\u003Eunknownfunc0 и unknownfunc1\u003C\u002Fem\u003E будут гарантированно проинициализированы первыми при вызове \u003Cem\u003Eapi_resolve\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cp\u003EТеперь основной фрагмент функции, непосредственно отвечающий за \"разрешение\" адресов функций \u003Cem\u003EAPI\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"&quot;Разрешение&quot; адресов функций API\" title=\"&quot;Разрешение&quot; адресов функций API\" height=\"900\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F67f\u002F122\u002Fd03\u002F67f122d034352685211c4b2e2219dc4e.png\" data-width=\"992\"\u002F\u003E\u003Cfigcaption\u003E\"Разрешение\" адресов функций API\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВначале осуществляется завуалированное получение адреса \u003Cem\u003EPEB (fs:[30h])\u003C\u002Fem\u003E. Понятно, для чего это сделано! Для затруднения анализа и автоматизированного выявления такого кода. Допустим, мое \u003Cem\u003EYARA\u003C\u002Fem\u003E-правило, написанное для выявления подобного кода перечисления модулей с помощью \u003Cem\u003EPEB\u003C\u002Fem\u003E, попросту не сработает. Такая же штука проделана при получении адреса \u003Cem\u003EPE\u003C\u002Fem\u003E-заголовка. В остальном далее все стандартно: перечисляются все загруженные модули и эскпортируемые ими функции. Для каждого такого сочетания считается контрольная сумма. Имя \u003Cem\u003EDLL\u003C\u002Fem\u003E содержится в \u003Cem\u003EUnicode\u003C\u002Fem\u003E, поэтому для подсчета контрольной суммы используется  функция под названием \u003Cem\u003Eget_wide_str_hash\u003C\u002Fem\u003E, а для имени функции, которая в \u003Cem\u003EANSI\u003C\u002Fem\u003E, – соответственно \u003Cem\u003Eget_str_hash\u003C\u002Fem\u003E. Причем в качестве начального значения контрольной суммы для имени функции используется контрольная сумма имени DLL.\u003C\u002Fp\u003E\u003Cp\u003EТеперь код самих функций получения контрольных сумм.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Код функции получения контрольной суммы строки Unicode\" title=\"Код функции получения контрольной суммы строки Unicode\" height=\"823\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F9a9\u002Fb06\u002Fca4\u002F9a9b06ca4f206e29fc505e9a29f3233a.png\" data-width=\"921\"\u002F\u003E\u003Cfigcaption\u003EКод функции получения контрольной суммы строки Unicode\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Код функции получения контрольной суммы строки ANSI\" title=\"Код функции получения контрольной суммы строки ANSI\" height=\"660\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb97\u002F8fb\u002Fbc7\u002Fb978fbbc79462bcab4979e4bc0630575.png\" data-width=\"920\"\u002F\u003E\u003Cfigcaption\u003EКод функции получения контрольной суммы строки ANSI\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПо сути, не считая различия в типах используемых символов, эти функции практически идентичны, только в версии для Unicode при подсчете контрольной суммы все символы латиницы преобразуются в нижний регистр. Вообще инструкция \u003Cem\u003Eor ax, 20h\u003C\u002Fem\u003E представляет собой простой и эффективный способ преобразования из верхнего регистра латиницы в нижний. Как видим, для подсчета контрольной суммы используется в цикле круговой сдвиг промежуточной суммы вправо на 13 (\u003Cem\u003EROR 13\u003C\u002Fem\u003E) и сложение с кодом текущего символа. Вариации этого алгоритма достаточно популярны у авторов вредоносного ПО. Когда первоначально анализировал \u003Cem\u003EBlaсkMatter\u003C\u002Fem\u003E, мне, например, сразу вспомнился \u003Cem\u003EMetasploit\u003C\u002Fem\u003E \u002F \u003Cem\u003ECobalt Strike\u003C\u002Fem\u003E. Также обращаю внимание, что \"бесполезный\" код сложения и вычитания \u003Cem\u003E61h\u003C\u002Fem\u003E может стать отличным паттерном для \u003Cem\u003EYARA\u003C\u002Fem\u003E-правила для детектирования \u003Cem\u003EBlackMatter\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cp\u003EРеализация кода получения контрольных сумм на \u003Cem\u003EPython\u003C\u002Fem\u003E:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Eror32 = lambda val, shift: \\\n    ((val &amp; 0xFFFFFFFF) \u003E\u003E (shift &amp; 0x1F)) | \\\n    ((val &lt;&lt; (32 - (shift &amp; 0x1F))) &amp; 0xFFFFFFFF)\n\n\ndef get_wide_str_hash(s, n=0):\n\n    for ch in s:\n\n        m = ord(ch)\n        if (m \u003E= 0x41) and (m &lt;= 0x5A):\n            m |= 0x20\n        n = m + ror32(n, 13)\n\n    return ror32(n, 13)\n\n\ndef get_str_hash(s, n=0):\n\n    for ch in s:\n\n        n = ord(ch) + ror32(n, 13)\n\n    return ror32(n, 13)\n\n\ndef get_api_func_name_hash(lib_name, fnc_name):\n\n    return get_str_hash(fnc_name, get_wide_str_hash(lib_name, 0))\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EА что дальше? Дальше следует получить все возможные имена \u003Cem\u003EDLL\u003C\u002Fem\u003E и функций \u003Cem\u003EAPI\u003C\u002Fem\u003E. Задача состоит в том, что необходимо написать скрипт, который получает список экспортируемых функций определенных \u003Cem\u003EDLL\u003C\u002Fem\u003E или же попросту всех \u003Cem\u003EDLL\u003C\u002Fem\u003E из \u003Cem\u003ESystem32\u003C\u002Fem\u003E. Для этого можно воспользоваться, например, готовым инструментом на \u003Cem\u003EPython\u003C\u002Fem\u003E для работы с \u003Cem\u003EPE\u003C\u002Fem\u003E–файлами \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Ferocarrera\u002Fpefile\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003Epefile\u003C\u002Fem\u003E\u003C\u002Fa\u003E авторства \u003Cem\u003EEro Carrera\u003C\u002Fem\u003E. Я же пользуюсь своим классом, который есть на моем \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Frivitna\u002Fpe_tools\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003EGitHub'е\u003C\u002Fem\u003E\u003C\u002Fa\u003E. На самом деле, что будет использоваться для достижения результата, не важно, главное, результат. Вариант такого списка, полученного в виде текстового файла \u003Cem\u003Eapi_names.txt\u003C\u002Fem\u003E, в качестве символа-разделителя используется символ табуляции:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"862\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb4a\u002Fd15\u002F7ee\u002Fb4ad157ee175276304d140bcbe20c5b5.png\" data-width=\"599\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EТакой готовый список в дальнейшем можно использовать в неизменном виде и для других аналогичных случаев. Далее с помощью него и скрипта на \u003Cem\u003EPython\u003C\u002Fem\u003E получаем список контрольных сумм имен функций \u003Cem\u003EAPI\u003C\u002Fem\u003E для данного конкретного случая:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Eimport io\n\n\nXOR_MASK = 0x43013FCC\n\n\nwith io.open('api_names.txt', 'rt') as f:\n    func_names = f.read().splitlines()\n\nwith io.open('api_hashes.txt', 'wt') as f:\n    for name in func_names:\n        name = name.strip()\n        if (name == ''):\n            continue\n        names = name.split('\\t')\n        h = get_api_func_name_hash(names[0], names[1]) ^ XOR_MASK\n        f.write('%08X\\t%s\\n' % (h, names[1]))\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EНа изображении с начальным фрагментом \u003Cem\u003Eapi_resolve\u003C\u002Fem\u003E видно, что в коде программы содержатся не сами значения контрольных сумм функций \u003Cem\u003EAPI\u003C\u002Fem\u003E, а сложенные по модулю 2 (\u003Cem\u003EXOR\u003C\u002Fem\u003E) с неким 32-битным числом \u003Cem\u003E43013FCCh\u003C\u002Fem\u003E. И это дополнительный прием для усложнения анализа, в коде программы он используется практически везде, не только для контрольных сумм функций \u003Cem\u003EAPI\u003C\u002Fem\u003E, но и для строк, формируемых в стеке. В таблицах \u003Cem\u003EIT\u003C\u002Fem\u003E также содержатся значения контрольных сумм, сложенные по модулю 2 с числом \u003Cem\u003E43013FCCh\u003C\u002Fem\u003E. Поэтому при получении списка контрольных сумм этот факт выше был учтен, и полученные контрольные суммы были дополнительно сложены по модулю 2 с \u003Cem\u003E43013FCCh\u003C\u002Fem\u003E. Это число, с которым производится операция \u003Cem\u003EXOR\u003C\u002Fem\u003E, является произвольным, и от образца к образцу \u003Cem\u003EBlackMatter\u003C\u002Fem\u003E различается.\u003C\u002Fp\u003E\u003Cp\u003EФрагмент полученного списка с контрольными суммами функций \u003Cem\u003EAPI \u003C\u002Fem\u003E(текстовый файл \u003Cem\u003Eapi_hashes.txt\u003C\u002Fem\u003E), среди которых есть те самые, для получения адресов которых в \u003Cem\u003Eapi_resolve\u003C\u002Fem\u003E использовалась рекурсия.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"706\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F70b\u002Fdeb\u002Fd2a\u002F70bdebd2ada054ad75de75a4ca64ffea.png\" data-width=\"559\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЭто две низкоуровневые функции из \u003Cem\u003Entdll.dll\u003C\u002Fem\u003E, которые используются для реализации функций \u003Cem\u003EGetProcAddress\u003C\u002Fem\u003E и \u003Cem\u003ELoadLibraryExW\u003C\u002Fem\u003E соответственно.\u003C\u002Fp\u003E\u003Cp\u003EВернемся снова к фрагменту функции \u003Cem\u003Eload_import\u003C\u002Fem\u003E, но уже более понятному и читаемому. Теперь мы видим, что создается куча (\u003Cem\u003Eheap\u003C\u002Fem\u003E), в которой допустимо выполнение кода, осуществляется получение адреса функции \u003Cem\u003EHeapAlloc\u003C\u002Fem\u003E. Дескриптор созданной кучи и адрес \u003Cem\u003EHeapAlloc\u003C\u002Fem\u003E вместе с адресом таблицы IT, содержащей контрольные суммы функций API, а также адресом таблицы IAT, куда в результате заносятся адреса функций, передаются в качестве аргументов при вызовах функций \u003Cem\u003Eload_lib_and_IAT.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Начальный фрагмент кода функции load_import\" title=\"Начальный фрагмент кода функции load_import\" height=\"941\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F53d\u002Fd47\u002Fec6\u002F53dd47ec65a2d5378175d33e7fb6a8f5.png\" data-width=\"986\"\u002F\u003E\u003Cfigcaption\u003EНачальный фрагмент кода функции load_import\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКод функции \u003Cem\u003Eload_lib_and_IAT\u003C\u002Fem\u003E, пожалуй, приведу практически весь.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Начальный фрагмент функции load_lib_and_IAT\" title=\"Начальный фрагмент функции load_lib_and_IAT\" height=\"900\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F190\u002F677\u002F056\u002F19067705685043c6632f7d06dced6ff8.png\" data-width=\"1112\"\u002F\u003E\u003Cfigcaption\u003EНачальный фрагмент функции load_lib_and_IAT\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак уже было сказано ранее, первый элемент таблицы \u003Cem\u003EIT\u003C\u002Fem\u003E содержит контрольную сумму имени \u003Cem\u003EDLL\u003C\u002Fem\u003E, и с помощью \u003Cem\u003Eload_lib\u003C\u002Fem\u003E осуществляется загрузка требуемой \u003Cem\u003EDLL\u003C\u002Fem\u003E. А далее для всех следующих элементов и до конца таблицы (\u003Cem\u003E0ССССССССh\u003C\u002Fem\u003E) определяется соответствующий адрес функции API, выделяется блок памяти на куче размером 16 байт, в который записывается случайно выбранный обфусцированный код вызова функции \u003Cem\u003EAPI\u003C\u002Fem\u003E (5 вариантов). Об этом также говорилось выше, что в \u003Cem\u003EIAT\u003C\u002Fem\u003E записываются не совсем адреса функций \u003Cem\u003EAPI\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"\" title=\"\" height=\"921\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F44c\u002F017\u002F3cd\u002F44c0173cdc44af4acd97e145ea013a0a.png\" data-width=\"924\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Создание обфусцированного кода вызова функции API\" title=\"Создание обфусцированного кода вызова функции API\" height=\"801\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F384\u002F567\u002F2bb\u002F3845672bb2b1db4d7fa1ebcaa77eac21.png\" data-width=\"923\"\u002F\u003E\u003Cfigcaption\u003EСоздание обфусцированного кода вызова функции API\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EКак видим, таблицы \u003Cem\u003EIAT\u003C\u002Fem\u003E в итоге содержат адреса на обфусцированный код вызова соответствующих функций \u003Cem\u003EAPI\u003C\u002Fem\u003E. Я специально остановился на этом моменте, чтобы продемонстрировать, какие сложности вызовет деобфускация только с помощью отладчика. А для нас же это совершенно не важно, как обфусцируется вызов функций, анализ осуществляется статически, каждый элемент таблицы \u003Cem\u003EIAT\u003C\u002Fem\u003E можно смело переименовать соответственно имени функции \u003Cem\u003EAPI\u003C\u002Fem\u003E, и суть от этого совершенно не изменится, так как в том или ином виде осуществляется вызов конкретной функции \u003Cem\u003EAPI\u003C\u002Fem\u003E. Таким образом, остается только написать скрипт \u003Cem\u003EIDAPython\u003C\u002Fem\u003E, который, используя ранее полученный список контрольных сумм функций \u003Cem\u003EAPI\u003C\u002Fem\u003E, переименует элементы всех таблиц \u003Cem\u003EIAT\u003C\u002Fem\u003E. Для этого можно воспользоваться подходом, аналогичным тому, что был использован в \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F572260\u002F\" rel=\"noopener noreferrer nofollow\"\u003Eпредыдущей части \u003C\u002Fa\u003Eдля деобфускации строк. Приводить это скрипт, пожалуй, не буду. :-) Интереснее и полезнее его будет написать самостоятельно.\u003C\u002Fp\u003E\u003Cp\u003EКонечный результат же будет таков:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"942\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F8d0\u002F02d\u002F733\u002F8d002d73311ad4c7f752f9d42e623972.png\" data-width=\"1072\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EИ фрагмент кода \u003Cem\u003EBlackMatter\u003C\u002Fem\u003E, который был вначале:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"741\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F99c\u002F7e1\u002Fd33\u002F99c7e1d33647be33493a1ed7440ee884.png\" data-width=\"920\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EБольшая часть приведенных в статье скриптов содержится в моем \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Frivitna\u002FMalware\" rel=\"noopener noreferrer nofollow\"\u003E\u003Cem\u003EGitHub'е\u003C\u002Fem\u003E\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Chr\u002F\u003E\u003Cp\u003EВсем огромное спасибо за внимание и терпение!\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"реверс-инжиниринг"},{"titleHtml":"malware analysis"},{"titleHtml":"windows"},{"titleHtml":"анализ вредоносного по"},{"titleHtml":"анализ вредоносного кода"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F372\u002F434\u002F509\u002F3724345099f8fce65bdd6a3a096c0213.jpeg","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F372\u002F434\u002F509\u002F3724345099f8fce65bdd6a3a096c0213.jpeg","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F582976\\\u002F\"},\"headline\":\"Средства автоматизации анализа вредоносных программ\",\"datePublished\":\"2021-10-12T12:38:54+03:00\",\"dateModified\":\"2021-10-23T12:01:51+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"rivitna\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Часть 3-яДобрались-таки до окончания статьи. Правда, долог и тернист был этот путь...Пока не забыл, сразу хочу выразить благодарность своим друзьям за поддержку...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F582976\\\u002F#post-content-body\",\"about\":[\"h_infosecurity\",\"h_reverse-engineering\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F582976\\\u002Fa9477ad536660d3bfc18d98d5f93678b\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F372\\\u002F434\\\u002F509\\\u002F3724345099f8fce65bdd6a3a096c0213.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F91d\\\u002F2a4\\\u002Fefe\\\u002F91d2a4efe217125c2cdc0af8b3cb6407.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F3a4\\\u002F177\\\u002F456\\\u002F3a4177456feb90f80a58f85c29bc10f7.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fccb\\\u002F7a1\\\u002Fc56\\\u002Fccb7a1c56507276216f809c62bd52e61.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F8c4\\\u002Fd18\\\u002Fdfa\\\u002F8c4d18dfada0bbb506c53b47417dcaa2.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F2bd\\\u002F759\\\u002F647\\\u002F2bd7596470d9418d841912b7b251dd7d.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F906\\\u002F196\\\u002Fc33\\\u002F906196c33d8675aa09cbf43a129e850f.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ffd1\\\u002F8b5\\\u002Faf3\\\u002Ffd18b5af33bc96e8de2ca3dc14fb7aa1.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fb5f\\\u002F798\\\u002F6f2\\\u002Fb5f7986f252a59d162905817134c4b19.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fff1\\\u002Fe7a\\\u002Fd3b\\\u002Fff1e7ad3bf9c6d25eabd730373f87034.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F817\\\u002F429\\\u002Fe17\\\u002F817429e1752127cc83cf3eeaec17920b.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F7b3\\\u002F2fa\\\u002F3a0\\\u002F7b32fa3a0f46525abfa7d42b662ae5a1.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fd2d\\\u002Fd2f\\\u002Fef8\\\u002Fd2dd2fef85f65aee63c590bcf33102ea.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ffbb\\\u002Fb8a\\\u002F586\\\u002Ffbbb8a5861d3a985d049cafa00c3a629.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F67f\\\u002F122\\\u002Fd03\\\u002F67f122d034352685211c4b2e2219dc4e.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F9a9\\\u002Fb06\\\u002Fca4\\\u002F9a9b06ca4f206e29fc505e9a29f3233a.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fb97\\\u002F8fb\\\u002Fbc7\\\u002Fb978fbbc79462bcab4979e4bc0630575.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fb4a\\\u002Fd15\\\u002F7ee\\\u002Fb4ad157ee175276304d140bcbe20c5b5.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F70b\\\u002Fdeb\\\u002Fd2a\\\u002F70bdebd2ada054ad75de75a4ca64ffea.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F53d\\\u002Fd47\\\u002Fec6\\\u002F53dd47ec65a2d5378175d33e7fb6a8f5.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F190\\\u002F677\\\u002F056\\\u002F19067705685043c6632f7d06dced6ff8.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F44c\\\u002F017\\\u002F3cd\\\u002F44c0173cdc44af4acd97e145ea013a0a.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F384\\\u002F567\\\u002F2bb\\\u002F3845672bb2b1db4d7fa1ebcaa77eac21.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F8d0\\\u002F02d\\\u002F733\\\u002F8d002d73311ad4c7f752f9d42e623972.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F99c\\\u002F7e1\\\u002Fd33\\\u002F99c7e1d33647be33493a1ed7440ee884.png\"]}","metaDescription":"Часть 3-яДобрались-таки до окончания статьи. Правда, долог и тернист был этот путь...Пока не забыл, сразу хочу выразить благодарность своим друзьям за поддержку и помощь в публикации статей. За то,...","mainImageUrl":null,"amp":true},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"infosecurity,reverse-engineering"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
