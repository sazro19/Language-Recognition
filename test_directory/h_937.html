<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Python service layer: основы оформления бизнес-логики на примере Django-приложений / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/581964\/"},"headline":"Python service layer: основы оформления бизнес-логики на примере Django-приложений","datePublished":"2021-10-06T17:29:45+03:00","dateModified":"2021-10-06T17:29:45+03:00","author":{"@type":"Person","name":"ChasingRainbows"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Django - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику.","url":"https:\/\/habr.com\/ru\/post\/581964\/#post-content-body","about":["h_python","h_django","f_develop"],"image":["https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/96c\/4de\/37b\/96c4de37b5b6bcb2ce258ff29303e932.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Python service layer: основы оформления бизнес-логики на примере Django-приложений" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Python service layer: основы оформления бизнес-логики на примере Django-приложений" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Python service layer: основы оформления бизнес-логики на примере Django-приложений" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Django - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику. Хранение бизнес-логики в моделях или..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Django - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику. Хранение бизнес-логики в моделях или..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Django - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику. Хранение бизнес-логики в моделях или..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Django - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику. Хранение бизнес-логики в моделях или..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Django - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику. Хранение бизнес-логики в моделях или..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/581964/3b27b084c6175ee44ff86f55dbe5c27f/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/581964/3b27b084c6175ee44ff86f55dbe5c27f/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/581964/3b27b084c6175ee44ff86f55dbe5c27f/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/581964/3b27b084c6175ee44ff86f55dbe5c27f/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/581964/3b27b084c6175ee44ff86f55dbe5c27f/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="581964" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2021-10-06T14:29:45.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/581964/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/581964/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/581964/3b27b084c6175ee44ff86f55dbe5c27f/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/ChasingRainbows/" title="ChasingRainbows" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_lilac"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="/ru/users/ChasingRainbows/" class="tm-user-info__username">
      ChasingRainbows
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2021-10-06T14:29:45.000Z" title="2021-10-06, 17:29">6  октября   в 17:29</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Python service layer: основы оформления бизнес-логики на примере Django-приложений</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/python/" class="tm-article-snippet__hubs-item-link"><span>Python</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/django/" class="tm-article-snippet__hubs-item-link"><span>Django</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <div class="tm-article-snippet__labels"><div class="tm-article-snippet__label"><span>
        Из песочницы
      </span></div></div> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><p>Django - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику. Хранение бизнес-логики в моделях или views имеет множество недостатков, которые обычно начинают проявляться при росте кодовой базы проекта. Чтобы решить эти проблемы, разработчики часто начинают искать способы выделения бизнес-логики в своем приложении.</p><p>В этой статье я хотел бы попробовать дать стартовую точку на пути выделения слоя бизнес-логики у себя в приложениях и навести на новые мысли тех разработчиков, которые считают выделение этого слоя в своих приложениях чем-то излишним.</p><p>Так же хочу обратить внимание, что цель данной статьи не в том, чтобы дать правила, которым требуется слепо следовать, но в том, чтобы указать направление. Сервисный слой и в принципе его наличие, это такая вещь, которую нужно адаптировать под нужды вашей команды, компании и бизнеса.</p><p>На самом деле, изложенный далее текст относится не только к Django-проектам. Разрабатывая веб-приложения, используя другие инструменты, вроде Flask, люди используют те же концепции веб-разработки, причём часто именно в таком же виде, как они реализованы, в Django - views, request-response объекты, middlewares, модели, формы.</p><figure class="full-width "><img src="/img/image-loader.svg" height="2500" data-src="https://habrastorage.org/getpro/habr/upload_files/96c/4de/37b/96c4de37b5b6bcb2ce258ff29303e932.png" data-width="2446"/><figcaption></figcaption></figure><h2>Как обычно обстоят дела в реальных Django-проектах?</h2><p>Большинство начинающих разработчиков на Django, после прохождения официального туториала, зачастую начинают интересоваться, собственно, а где и как им хранить код? Вариантов много, но типичный Django-разработчик, скорее всего, найдет для себя ответ в знаменитой книге "Two Scopes of Django", заключающийся в следующем принципе: <em>"Fat Models, Utility Modules, Thin Views, Stupid Templates"</em>.</p><p>Со временем данный подход стал дефолтным в Django-сообществе. И этот подход, несомненно, работает. Какое-то время.</p><p>В реальности, большинство крупных проектов представляют из себя не просто CRUD-приложения, а нечто большее. Более менее серьезный бизнес-процесс подразумевает за собой манипулирование несколькими сущностями, какие-то промежуточные операции и прочее.</p><p>Следуя данному принципу, в какой-то момент роста проекта вырисовывается весьма интересная картина.</p><h4>Эти модели слишком толстые</h4><p>На самом деле, считаю правило "толстых моделей" корнем всех проблем. Самые простые бизнес-процессы, как правило, взаимодействуют только с одной сущностью. Но с ростом этих сущностей в одном бизнес-процессе у разработчика возникает следующая дилемма: <em>"Ок, я написал огромную простыню кода, которая использует несколько моделей. В какую из моделей мне положить всё это добро?"</em>.</p><p>В худшем случае разработчик оставит весь код в модели, импортируя модели друг в друга или вынося некоторые куски кода в некие другие модули, затем снова импортируя их эти же в модели. Добро пожаловать в кольцевые импорты! В вырожденных случаях разработчик может просто начать складировать код всех моделей и их логики в один файл, получая на выходе один <code>models.py</code> на 1000+ строк кода.</p><p>Но чаще всего бизнес-логика начинает плавно перетекать во views.</p><h4>Кажется, наши тонкие views становятся не такими уж и тонкими</h4><p>Авторы "Two Scopes of Django" сами же пишут, что хранение логики во views - плохая идея, и вводят в своей книге главу "Trimming Models", в рамках которой поясняют, что при росте модели логику стоит выносить в слой, который они называют "Utility Modules".</p><p>Однако, реальность довольна сурова. Бизнес-логика перетекает во views бесконтрольно, потому что никто точно не может сказать, когда наша <em>thin view</em> стала не такой уж и <em>thin</em>. А писать код во views быстро и просто. Там сразу и request-объект со всеми данными, и формы, которые эти данные отвалидировали.</p><p>Впоследствии размер view начинает постепенно расти и в коде начинают появляться интересные ситуации, например, использование элемента глобального состояния view, такого как request-объект, прямо в бизнес логике, что намертво прибивает эту бизнес-логику к этой view.</p><p>Разработчикам удобно использовать глобальное состояние view прямо в бизнес-логике. Некоторые даже не брезгуют доклеивать к нему свои промежуточные вычисления. Это всегда затрудняет чтение кода. Это делает невозможным переиспользование данной бизнес-логики в других местах проекта, таких как celery-задачи, или management-команды. В конце концов это мешает вам адекватно покрыть ваш код unit-тестами. Единственной точкой тестирования в этом случае остается ваш view.</p><p>На этом этапе бизнес-логика становится сильно привязанной к инфраструктурному слою (фреймворк/библиотека) вашего проекта.</p><h4>Каша из Utility Modules</h4><p>Utility Modules - одна из самых недопонятых концепций в мире Django. Что именно мы должны там хранить? Многие из нас начинают складировать там мусор.</p><p>Часто я наблюдаю, что люди даже не пытаются как-то формализовать правила к этому слою в своих приложениях. Все называют его по-разному. Кто-то создаёт в корне проекта файлик <code>utils.py</code>, кто-то создаёт модули <code>helpers</code> или <code>processors</code>. А кто-то - всё это одновременно.</p><p>В этих модулях часто могут лежать как и элементы бизнес-логики, так и какие-то универсальные утилиты. Одним словом, каша.</p><h3>Сервисный слой</h3><p>Основа концепции сервисного слоя закладывается в понимании разницы между бизнес-логикой и инфраструктурой. Часто разработчики склонны путать эти понятия, поэтому давайте дадим им определения.</p><p><em>Бизнес-логика</em> - это код реализации бизнес-правил. Например, логика списаний с одного баланса и начисление на другой. Слой бизнес-логики является отображением процессов реального мира на программный код.</p><p><em>Код инфраструктуры</em> - это код реализации инфраструктурных процессов, манипулирующий в основном искусственными понятиями, сформулированными сугубо для разработки ПО, например: вью, модели, фреймворки, субд, валидация входных параметров, реквесты, респонсы, API и тд.</p><p>Что такое сервисный слой? Давайте тоже попробуем дать определение. Сервисный слой - это такой набор компонентов программного кода, которые инкапсулируют в себе логику приложения. Такие компоненты мы и будем называть <em>сервисами бизнес-логики</em> или <em>доменными сервисами</em>.</p><p>Бизнес-логика в сервисном слое стремится быть максимально изолированной от нашей инфраструктуры, которая представляет из себя детали реализации фреймворка и других внешних зависимостей, и быть максимально близкой к предметной области. Я специально использую слово <em>стремится</em> вместо <em>должна</em>, потому что разработчики должны самостоятельно решать, какой уровень изоляции им требуется.</p><p>Если говорить в терминах Django, то целью сервисного слоя будет вынести весь код, относящийся к бизнес-логике приложения, из моделей, view и всех остальных мест, где её быть не должно, вроде middlewares или management-команд, в отдельные модули, оформленные по определенным правилам, оставляя в инфраструктурном слое лишь вызовы из этих модулей.</p><p>В рамках сервисного слоя можно выделить также <em>инфраструктурные сервисы</em>. Дело в том, что полностью вынести какие-то инфраструктурные операции за пределы бизнес-логики далеко не всегда возможно. Например, такие операции, как общение с СУБД, запись/чтение диска, хождение по сети. Их-то и можно изолировать в инфраструктурных сервисах, чтобы затем использовать в своей бизнес-логике c помощью более высокоуровневого интерфейса.</p><p>Инфраструктурные сервисы здорово помогают читать бизнес-логику, так как скрывают детали реализации работы с вашей инфраструктурой, а также упрощают написание тестов бизнес-логики, так как один сервисный эндпоинт гораздо проще подменить на mock, чем набор низкоуровневых операций.</p><p>Таким образом, сервисом в самом общем понимании является базовый блок кода, слоя бизнес-логики, либо инфраструктурного слоя, но не одновременно.</p><h4>Сервисный слой на уровне структуры проекта</h4><p>С чего же можно начать формирование сервисного слоя? Начнём с самого простого - структуры модулей. Следует договориться о создании отдельных модулей на уровне каждого Django-приложения. В данной статье в качестве примера будем называть такие модули <em>services</em>:</p><pre><code class="bash">project_name
├── app_name
│   ├── services
│   │   └── ...
│   ├── tests
│   ├── views
│   ├── models
...</code></pre><p>Вы также можете сделать один глобальный модуль сервисов, если у вас, например, мало django-приложений, словом, отталкивайтесь от своего проекта.</p><p>Внутри services будут храниться наши модули сервисов. Каждый отдельный модуль сервисов хранит в себе какой-то один бизнес-процесс, объединённый тесным контекстом. Модуль сервиса на уровне структуры проекта может состоять как из одного py-файла, так и из сложного набора подмодулей, организованного исходя из требований вашей бизнес-логики. Соблюдайте баланс, старайтесь не класть несколько сервисов используемых в рамках одного бизнес-процесса в один файл:</p><pre><code>services
├── __init__.py
├── complicated_service_example
│   ├── __init__.py
│   └── ...
└── simple_service_example.py</code></pre><p>При оформлении сервиса в виде модуля старайтесь явно отражать его публичный API в <code>__init__.py</code> , туда должны быть импортированы только сущности, предназначенные для публичного использования.</p><p>Также структуру сервисного слоя можно оформить исходя из разделения на инфраструктурные сервисы и сервисы бизнес-логики.</p><pre><code>services
├── __init__.py
├── example_with_separated_service_layers
│ ├── __init__.py
│ ├── infrastructure
│ │   └── ...
│ ├── domain
│ │   └── ...
...  </code></pre><h4>Сервисный слой на уровне кода</h4><p>Проектируя код сервисного слоя, в голове следует держать главное правило:</p><p><em>В сервисном слое следует изолировать бизнес-логику от инфраструктуры</em>.</p><p>Проектируя сервисный слой, вы должны заставить работать свой фреймворк на свою бизнес-логику, а не наоборот, как это часто происходит в Django-приложениях. Это значит, что вы не должны использовать в коде сервисов бизнес-логики такие вещи, как request-объекты, которые принимают views, формы, celery-задачи, различные сторонние библиотеки, отвечающие за инфраструктурные задачи и т. д. Это правило очень важно. И весь подход к написанию кода отталкивается именно от него. В местах, когда вынести из пайплайна бизнес-логики инфраструктуру невозможно, требуется должным образом её изолировать. Способы изоляции будут описаны далее.</p><p>На уровне кода типичный сервис бизнес-логики представляет из себя разновидность паттерна <a href="https://en.wikipedia.org/wiki/Command_pattern" rel="noopener noreferrer nofollow">Command</a>, который является производной от паттерна <a href="https://refactoring.com/catalog/replaceFunctionWithCommand.html" rel="noopener noreferrer nofollow">Method Object</a>.</p><p>Для примера придумаем простой сервис с минимальным количеством бизнес-логики. Допустим, требуется периодически готовить отчёт о пользователях в системе. Нужно взять все <code>username</code> пользователей, затем сохранить их в csv-файл, имя которого должно быть сгенерировано определенным образом.</p><p>Создадим в директории <code>services</code> файл <code>make_users_report_service.py</code> со следующим содержимым:</p><pre><code class="python">import csv

from datetime import datetime
from typing import List

from django.contrib.auth.models import User

class MakeUsersReportService:

    def _extract_username_list(self) -> List[str]:     
        return list(User.objects.values_list('username', flat=True))

    def _generate_file_name(self) -> str:     
        return '{}-{}'.format('users_report', datetime.now().isoformat())

    def _load_username_list_to_csv(self, file_name: str, username_list: List[str]) -> str:     
        full_path = f'reports/{file_name}.csv'

        with open(full_path, 'w', newline='') as csv_file:         
            writer = csv.writer(csv_file)
            writer.writerow(['username'])
            writer.writerows(             
                ([username] for username in username_list) 
            )

        return full_path

    def execute(self) -> str:     
        username_list = self._extract_username_list()     
        file_name = self._generate_file_name()     
        return self._load_username_list_to_csv(file_name, username_list)</code></pre><p>Такой сервис в виде класса является базовым строительным блоком сервисного слоя. Давайте внимательно рассмотрим его особенности:</p><p><strong>1) Используются аннотации типов</strong></p><p>Аннотации типов и их чекеры вроде mypy - одно из самых значимых нововведений Python за последние годы. Аннотации типов в сервисном слое важны, в первую очередь из-за того, что <em>помогают следовать правилам</em> инфраструктурного слоя.</p><p>Если методы вашего сервиса возвращают или принимают инфраструктурные объекты, к примеру, из Django, то это является явным маркером того, что вы что-то делаете не так.</p><p>Аннотации типов также помогают отразить неявные зависимости внутри кода, так как вам придется импортировать типы, объекты которых не создаются в вашем коде напрямую, если вы хотите использовать их в качестве аргументов или возвращаемых значений методов.</p><p><strong>2) В коде единственная публичная точка входа</strong></p><p>Обратите внимание на метод <code>execute</code> - он является единственной публичной точкой входа в данном сервисе. Всё, что он делает - вызывает под капотом приватные методы в определенном порядке. Такая схема позволяет проще читать код - открыв сервис, сразу видно, в какой последовательности вызывается логика и как её вызывать.</p><p>Данный подход помогает в проектировании сервисов. Помните, если вам хочется сделать несколько публичных методов подобных <code>execute</code> в одном сервисе, то это явный признак того, что скорее всего логику нужно разделить и вынести в отдельный сервис.</p><p><strong>3) Изолированы обращения к СУБД</strong></p><p>Такое инфраструктурное действие, как обращение к СУБД, изолировано в отдельном методе - <code>_extract_username_list</code>. В приватном методe вы можете заменить, к примеру, вызов <code>values_list</code> на raw-sql запрос, или вообще, обращение к некому внешнему API, но при этом ваша бизнес-логика, которой просто нужен список из юзернеймов, всё равно не изменится. Мы зафиксировали интерфейс в примитивах языка.</p><p>В данном примере нужны только username-ы пользователей, и поэтому мы можем ограничиться встроенными типами Python - <code>List[str]</code> и не возвращать список объектов модели, ведь Django ORM является такой же частью инфраструктуры как и всё остальное. Более сложные кейсы мы рассмотрим чуть позже.</p><p>Выбор, конечно, за вами, но помните, используя queryset-ы напрямую в коде вашей бизнес-логики, вы усложняете себе написание unit-тестов, ведь замокать queryset-ы гораздо сложнее чем просто метод, возвращающий примитив языка. Использование интеграционных тестов Django, которые позволяют вам поднять под капотом тестовую СУБД, важно, но отрабатывают такие тесты гораздо дольше, чем обычные unit-тесты, которые её не используют. А в случае если источником данных выступает некий внешний API стороннего сервиса, то и выбора по сути не остаётся - надо мокать его. </p><p>Для тестирования бизнес-логики не нужно каждый раз использовать тестовую базу данных. Ведь для бизнес-логики неважно откуда пришли данные - из СУБД ли, из файла на диске или внешнего API.</p><p>Для себя я вывел такую формулу: если возможно, покрывайте ваш сервис на 70% юнит-тестами с замоканным источником данных и на 30% интеграционными тестами, которые умеют поднимать вашу инфраструктуру, частью которой и является ваш источник данных в виде СУБД. Такая практика сделает приятнее разработку по TDD, а также ускорит прохождение тестов в вашем CI/CD пайплайне, что тоже не может не радовать.</p><p><strong>4) Изолированы обращения к коду формирования csv-файла</strong></p><p>Запись информации в файл на диске - такая же инфраструктурная задача. В принципе, все тезисы, что я перечислил в 3 пункте про СУБД, подходят и сюда - проще тестировать, не надо менять остальной код в случае, если понадобится писать, к примеру, exel файл вместо csv.</p><p><strong>5) Название сервиса отражает конкретное действие</strong></p><p>Название сервиса должно отражать некое конкретное действие. Размытое название сигнализирует о том, что код выполняет более чем одно конкретное действие, что является нежелательным для <em>сервисов бизнес-логики</em>.</p><p>Только что мы рассмотрели пример очень простого сервиса, состоящего из трёх простых этапов. Бизнес-логики в этом сервисе было весьма мало. В реальности сервисы, конечно же, гораздо сложнее. Давайте рассмотрим, какие проблемы у вас могут возникнуть с кодом выше и как их можно решить в рамках сервисного слоя.</p><h3>Value Object, DTO, DAO</h3><p>Давайте представим, что теперь в наш отчёт нужно писать не только username-ы пользователей, но так же и их emal-ы, имена, id и прочее. В рамках сервисного слоя мы стремимся отгородить бизнес-логику от инфраструктуры. А это значит, что вернув список из объектов Django-модели, мы отступим от наших принципов.</p><p>Тогда, часть кода выше, отвечающая за запрос к СУБД можно модифицировать следующим образом (реализацию остальных методов пока опустим):</p><pre><code class="python">...
from dataclasses import dataclass
from typing import Generator

from django.contrib.auth.models import User

@dataclass
class UsersReportRow:
    pk: int
    username: str
    email: str
    is_active: bool

class UsersReportService:

    def _extract_users_data(self) -> Generator[UsersReportRow]:     
        for user in User.objects.all():         
            yield UsersReportRow(             
                pk=user.pk,             
                username=user.username,
                email=user.email,   
                is_active=user.is_active,
            )
...</code></pre><p>Метод <code>_extract_username_list</code> мы заменили на <code>_extract_users_data</code>, который теперь возвращает генератор с <a href="https://www.martinfowler.com/bliki/ValueObject.html" rel="noopener noreferrer nofollow">Value Object</a>-ами, реализованный в виде дата-класса. Дата-классы - весьма полезный инструмент в разработке на Python.</p><p>Часто питонисты пренебрегают создавать классы просто для передачи данных и могут использовать в подобных ситуациях, к примеру, список из dict-ов, что является худшей альтернативой. Достоинство классов перед dict-ами состоит в фиксированной схеме данных, которая находится у вас в коде. Такую фиксированную схему данных удобнее использовать в аннотациях типов. При вызове метода, который возвращает пользовательский объект вместо dict, отпадает потребность идти и каждый раз вспоминать его содержимое - ваша IDE сможет помочь вам, когда вам потребуется обратиться к атрибутам.</p><p>Иногда под Value Object имеют в виду другой паттерн - <a href="https://www.martinfowler.com/eaaCatalog/dataTransferObject.html" rel="noopener noreferrer nofollow">DTO - Data Transfer Object</a>. С моей точки зрения, DTO - сущность общения между сервисами, в то время как Value Object является сущностью общения внутри сервиса.</p><p>Если представить, что наш сервис ,помимо пути к сгенерированному отчёту, должен будет вернуть ещё какую-либо информацию, например, уникальный id отчёта, это могло бы выглядеть так:</p><pre><code class="python">...
from dataclasses import dataclass

@dataclass
class UsersReportDTO:
    full_path: str
    report_id: str

class UsersReportService:
...
    def execute(self) -> UsersReportDTO:
        ...
        return UsersReportDTO(
            full_path=full_path,
            report_id=report_id,
        )</code></pre><p>Чаще всего, помимо чтения данных, может понадобится и много других операций с хранилищем: создание, обновление данных, агрегация. Как оставить сервис простым и не засорять бизнес-логику кодом работы с хранилищем?</p><p>Ответ - изолировать работу с вашим хранилищем через <a href="https://en.wikipedia.org/wiki/Data_access_object" rel="noopener noreferrer nofollow">DAO - Data access object</a>. Вот так может выглядеть DAO для взаимодействия с таблицей пользователей в Django:</p><pre><code class="python">from dataclasses import dataclass
from typing import Iterable

from django.contrib.auth.models import User


@dataclass
class UserEntity:
    pk: int
    username: str
    email: str
    is_active: bool


class UsersDAO:

    def _orm_to_entity(self, user_orm: User) -> UserEntity:     
        return UserEntity(         
            pk=user_orm.pk,         
            username=user_orm.username,
            email=user_orm.email,
            is_active=user_orm.is_active, 
        )

    def fetch_all(self) -> Iterable[UserEntity]:     
        return map(self._orm_to_entity, User.objects.all())

    def count_all(self) -> int:
        ...

    def update_is_active(self, users_ids: Iterable[int], is_active: bool) -> None:  
        ...
</code></pre><p>Таким образом, в коде сервиса вашей бизнес-логики  остаётся только использование DAO без построения запросов к СУБД напрямую.</p><p>Хочу ещё раз обратить внимание - мы специально не используем объекты моделей Django. Заставляя двигать данные внутри нашего сервисного слоя через примитивы языка и пользовательские объекты, мы изолируем нашу бизнес-логику от инфраструктуры.</p><p>Изолирование работы с ORM в коде обычно вызывает больше всего негативных эмоций у Django-разработчиков. Думаю, это происходит в первую очередь из-за того, что очень часто доменная модель бизнес-сущностей накладывается на модели Django в начале разработки новой фичи.</p><p>Может быть, такая изоляция и выглядит избыточной, когда в примере можно сделать всего один простой запрос в ORM, но поверьте, если для бизнес-логики вам в какой-то момент потребуется не просто достать набор строк из таблицы, а собрать некий агрегат, делая несколько запросов в разные источники данных, или сделать raw-sql запрос через драйвер к СУБД, который возвращает вместо адекватного объекта какой-то tuple из tuple-ов, то помимо всех достоинств, описанных ещё в предыдущем более простом примере, вы получите ещё и улучшенную в разы читаемость кода.</p><p>Так же весьма важным эффектом является то, что изолируя ORM, если в какой-то момет вам придётся заменить источник данных, к примеру, на MongoDB, или вообще, веб-API вашего другого сервиса, вам не придётся переписывать кучу unit-тестов и всю бизнес-логику. Нужно будет только переписать тесты на ваш DAO или метод сервиса, который возвращает DTO/Value Object. Главное лишь то, чтобы ваш код изолирующий работу с данными сохранял старый интерфейс. Сделайте вашу инфраструктуру зависимой от бизнес-логики, а не наоборот!</p><h3>Dependency injection - построение комплексных сервисов</h3><p>Чаще всего, нам требуется писать сложные пайплайны бизнес-логики, и в таких случаях, при помещении всего кода в один сервис, он становится плохо читаемым. Тогда требуется отделять сложные части пайплайна в отдельные сервисы. Таким образом, сервисы могут быть комплексными и использовать под капотом другие сервисы, как инфраструктурные, так и доменные.</p><p>Теперь давайте снова усложним наш пример. Представим, что заказчик захотел, чтобы помимо csv-файла была так же возможность сгенерировать и exel-файл.</p><p>Создадим два новых инфраструктурных сервиса, затем встроим их в наш сервис бизнес-логики. Один из них будет отвечать за запись xlsx, а второй - за csv.</p><p>Модифицируем исходный файл <code>make_users_report_service.py</code> (снова опустим подробности реализации):</p><pre><code class="python">...
import abc
from typing import Iterable

class IReportFileAdapter(abc.ABC):

    @abc.abstractmethod
    def create_report_file(self, file_name: str, username_list: Iterable[UsersReportRow]) -> str:     
        pass

...

class UsersReportService:

    def __init__(self, report_file_adapter: IReportFileAdapter):     
        self.report_file_adapter = report_file_adapter

    def _extract_users_data(self) -> Generator[UsersReportRow]:     
        ...

    def _generate_file_name(self) -> str:     
        ...

    def execute(self) -> str:     
        username_list = self._extract_users_data()     
        file_name = self._generate_file_name()     
        return self.report_file_adapter.create_report_file(file_name, users_data_list)</code></pre><p>И далее, создадим новый файл с инфраструктурными сервисами, реализованными в виде адаптеров  <code>report_file_adapters.py</code>:</p><pre><code class="python">import abc
from typing import Iterable

from .make_users_report_service import IReportFileAdapter

class CSVReportFileAdapter(IReportFileAdapter):

    def create_report_file(self, file_name: str, username_list: List[str]) -> str:     
        ...

class XLSXReportFileAdapter(IReportFileAdapter):

    def create_report_file(self, file_name: str, username_list: List[str]) -> str:     
        ...
      </code></pre><p>Таким образом, вызывать сервис бизнес-логики вы сможете с разными адаптерами, в зависимости от того, какой файл вам нужно сгенерировать.</p><pre><code class="python">from your_django_app.services.reports import (
    UsersReportService,
    CSVReportFileAdapter,
)

users_report_service = UsersReportService(report_file_adapter=CSVReportFileAdapter())
path_to_report = users_report_service.execute()</code></pre><p>Давайте рассмотрим написанный код подробнее:</p><p><strong>1) Inversion of Control</strong></p><p>С помощью абстрактного базового класса мы эмулировали интерфейс в нашем коде и положили его именно рядом с нашей бизнес-логикой, а не адаптерами. Таким образом, мы смогли достичь <a href="https://en.wikipedia.org/wiki/Inversion_of_control" rel="noopener noreferrer nofollow">Инверсии управления</a> в нашем коде. Благодаря этому в файл с бизнес-логикой не нужно делать импорты инфраструктурных сервисов, которые умеют писать csv/xlsx. Мы добились зависимости инфраструктурного слоя от бизнес-логики, а не наоборот.</p><p>Вы так же можете достичь IoC с помощью типа <a href="https://mypy.readthedocs.io/en/stable/protocols.html#simple-user-defined-protocols" rel="noopener noreferrer nofollow">Protocol</a>, появившегося в typing начиная с python 3.8.</p><p>Многие считают IoC в python излишним. Применяйте по ситуации: если вам не нужна высокая степень изоляции компонентов, можно обойтись и без IoC, либо использовать абстрактные базовые классы с реализацией, которые уже следовало бы держать рядом с адаптерами в моём примере. Сервисный слой гибок.</p><p><strong>2) Удобный mock</strong></p><p>Одному мне не нравится каждый раз писать в тестах длинный <code>@mock.patch('...')</code>? Длинный путь к объекту, который вы хотите замокать, банально неудобно читать и прописывать. К тому же, при перемещении или переименовании объекта, который вы мокаете, эту строку нужно будет не забыть поправить. Теперь всё можно сделать гораздо приятнее. Встраивая сервисы друг в друга, при написании тестов, вы получаете возможность пробрасывать Mock при инициализации вашего сервиса:</p><pre><code class="python">from mock import Mock
from unittest import TestCase

from your_django_app.services.reports import (
    UsersReportService,
    IReportFileAdapter,
)


class UsersReportServiceTestCase(TestCase):

    def test_example(self):
        report_file_adapter_mock = Mock(spec=IReportFileAdapter)
        users_report_service = UsersReportService(
            report_file_adapter=report_file_adapter_mock
        )
        ...
...</code></pre><p>Используя внедрение зависимостей, вы можете строить сложные пайплайны бизнес-логики из большого количества ваших рабочих блоков с кодом - сервисов.</p><h3>О любви Python-сообщества к библиотекам и зависимости от инфрастурктуры</h3><p>Что делают в python-сообществе когда возникает проблема? Правильно - пишут новую awesome-библиотеку (<s>и теперь у нас две проблемы</s>). Идея сервисного слоя не нова, и библиотеки на эту тему уже есть.</p><p><a href="https://github.com/mixxorz/django-service-objects" rel="noopener noreferrer nofollow">https://github.com/mixxorz/django-service-objects</a> - автор предлагает писать сервисный слой на основе Django-форм. С моей точки зрения, валидация входных данных должна происходить в инфраструктурном слое, а не перегружать собой слой бизнес-логики. На слое сервисов можно валидировать только бизнес-правила. А всякие проверки, что число - это число, а не строка, лучше оставить обычным Django-формам.</p><p><a href="https://github.com/dry-python/stories" rel="noopener noreferrer nofollow">https://github.com/dry-python/stories</a> - ещё одна библиотека для построения сервисного слоя. Давно слежу за ребятами. Помимо stories, у них много других интересных библиотек на разные темы.</p><p>Я против использования подобных библиотек. И вот почему:</p><ol><li><p>Сторонняя библиотека - это уже часть инфраструктуры, сама по себе. Завязывая вашу бизнес-логику на такую библиотеку, вы заранее завязываете свою бизнес-логику на инфраструктуру, что уже противоречит идеи разделения бизнес-логики и инфраструктуры на разные слои. Однажды вам может понадобится выйти за рамки вашей библиотеки для написания бизнес-логики, и, скорее всего, это будет больно. Сильно задумайтесь, нужно ли вам это.</p></li><li><p>У многих в голове стереотип, что Python - язык для data science и каких-то DevOps-скриптов, и без дополнительных приседаний в виде специальных библиотек, нормально оформить в нём сложную бизнес-логику нельзя. Естественно, это не правда. Python давно готов для написания серьезных приложений с нагруженной бизнес-логикой. В этой статье я привёл примеры разных приёмов, которые не требовали сторонних зависимостей для описания бизнес-логики. Если вам захочется выйти за рамки описанного в статье, вы будете ограничены лишь языком программирования, а не какой-то библиотекой.</p></li></ol><p>Сервисный слой должен оставаться гибким, и подходить потребностям вашей команды. Имейте это в виду, если всё-таки решитесь завязать ядро вашего приложения, которым является ваша бизнес-логика, на какую-то библиотеку.</p><h3>Что дальше?</h3><p>Лучше всех по теме негативных последствий от зависимости бизнес-логики от инфраструктуры приложения уже высказывался Роберт Мартин в своих статьях "<a href="https://blog.cleancoder.com/uncle-bob/2011/09/30/Screaming-Architecture.html" rel="noopener noreferrer nofollow">Screaming Architecture</a>" и "<a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html" rel="noopener noreferrer nofollow">The Clean Architecture</a>", а также прекрасной книге "Clean Architecture: A Craftsman's Guide to Software Structure and Design".</p><p>В принципе, если возвести все приемы, которые я показал в статье, в абсолют, и везде использовать DI и IoC, а также ещё пару приёмов, то у вас получится своя реализация чистой архитектуры.</p><p>Вы могли видеть в данной статье элементы Domain-driven design. Для ознакомления рекомендую обратить внимание на книгу "Domain-Driven Design: Tackling Complexity in the Heart of Software" от Эрика Эванса. Сервисный слой можно также развить в полноценное DDD приложение.</p><hr/><h3>Подводя итог</h3><p>Итак, подведём итог нашему путешествию в сервисный слой:</p><ol><li><p>Начните со структуры - заведите отдельный модуль для вашего сервисного слоя и хорошо структурируйте его.</p></li><li><p>Сервисы бизнес-логики оформляются в виде классов-команд (классов с одним публичным методом). Инфраструктурные - по ситуации.</p></li><li><p>Трафик данных в сервисах, а также между ними, лучше всего осуществлять в примитивах языках и пользовательских объектах с помощью Value Object, DTO, DAO.</p></li><li><p>Больше тестов! Покрывайте сервисы тестами, активно мокайте инфраструктуру и другие сервисы от которых вы зависите.</p></li><li><p>Сервисы могут быть комплексными и вызывать под капотом другие сервисы. Такое взаимодействие будет удобно организовать через Dependency Injection.</p></li><li><p>Сервисный слой должен подходить потребностям вашей команды. Опасайтесь завязки на чужие решения в виде библиотек или фреймворков. Используйте только те приёмы, что вы считаете нужными. Возможно, просто вынесение кода из ваших views, без серьезной изоляции инфраструктуры, может решить большинство ваших проблем.</p></li></ol></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bpython%5D" class="tm-tags-list__link">python</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bpython3%5D" class="tm-tags-list__link">python3</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bpython%203%5D" class="tm-tags-list__link">python 3</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bdjango%5D" class="tm-tags-list__link">django</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bclean%20architecture%5D" class="tm-tags-list__link">clean architecture</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bservice%20layer%5D" class="tm-tags-list__link">service layer</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bddd%5D" class="tm-tags-list__link">ddd</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bdomain-driven%20design%5D" class="tm-tags-list__link">domain-driven design</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bunit%20testing%5D" class="tm-tags-list__link">unit testing</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bclean%20code%5D" class="tm-tags-list__link">clean code</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/python/" class="tm-hubs-list__link">
    Python
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/django/" class="tm-hubs-list__link">
    Django
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 20: ↑20 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 20: ↑20 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+20</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">5.5K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    78
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/ChasingRainbows/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_lilac"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 5 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    5
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">20</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><!----> <a href="/ru/users/ChasingRainbows/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @ChasingRainbows
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Пользователь</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/581964/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 15 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/581964/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/581964/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"581964":{"id":"581964","timePublished":"2021-10-06T14:29:45+00:00","isCorporative":false,"lang":"ru","titleHtml":"Python service layer: основы оформления бизнес-логики на примере Django-приложений","leadData":{"textHtml":"\u003Cp\u003EDjango - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику. Хранение бизнес-логики в моделях или views имеет множество недостатков, которые обычно начинают проявляться при росте кодовой базы проекта. Чтобы решить эти проблемы, разработчики часто начинают искать способы выделения бизнес-логики в своем приложении.\u003C\u002Fp\u003E\u003Cp\u003EВ этой статье я хотел бы попробовать дать стартовую точку на пути выделения слоя бизнес-логики у себя в приложениях и навести на новые мысли тех разработчиков, которые считают выделение этого слоя в своих приложениях чем-то излишним.\u003C\u002Fp\u003E\u003Cp\u003EТак же хочу обратить внимание, что цель данной статьи не в том, чтобы дать правила, которым требуется слепо следовать, но в том, чтобы указать направление. Сервисный слой и в принципе его наличие, это такая вещь, которую нужно адаптировать под нужды вашей команды, компании и бизнеса.\u003C\u002Fp\u003E\u003Cp\u003EНа самом деле, изложенный далее текст относится не только к Django-проектам. Разрабатывая веб-приложения, используя другие инструменты, вроде Flask, люди используют те же концепции веб-разработки, причём часто именно в таком же виде, как они реализованы, в Django - views, request-response объекты, middlewares, модели, формы.\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F31c\u002F667\u002Fb50\u002F31c667b50f0ec762b61ace2fd6aa4da9.png","fit":"cover","positionY":33.181818181818,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[{"type":"sandbox","data":null}],"author":{"scoreStats":{"score":5,"votesCount":5},"rating":20,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"2277966","alias":"ChasingRainbows","fullname":null,"avatarUrl":null,"speciality":null},"statistics":{"commentsCount":15,"favoritesCount":78,"readingCount":5487,"score":20,"votesCount":20},"hubs":[{"relatedData":null,"id":"340","alias":"python","type":"collective","title":"Python","titleHtml":"Python","isProfiled":true},{"relatedData":null,"id":"403","alias":"django","type":"collective","title":"Django","titleHtml":"Django","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cp\u003EDjango - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику. Хранение бизнес-логики в моделях или views имеет множество недостатков, которые обычно начинают проявляться при росте кодовой базы проекта. Чтобы решить эти проблемы, разработчики часто начинают искать способы выделения бизнес-логики в своем приложении.\u003C\u002Fp\u003E\u003Cp\u003EВ этой статье я хотел бы попробовать дать стартовую точку на пути выделения слоя бизнес-логики у себя в приложениях и навести на новые мысли тех разработчиков, которые считают выделение этого слоя в своих приложениях чем-то излишним.\u003C\u002Fp\u003E\u003Cp\u003EТак же хочу обратить внимание, что цель данной статьи не в том, чтобы дать правила, которым требуется слепо следовать, но в том, чтобы указать направление. Сервисный слой и в принципе его наличие, это такая вещь, которую нужно адаптировать под нужды вашей команды, компании и бизнеса.\u003C\u002Fp\u003E\u003Cp\u003EНа самом деле, изложенный далее текст относится не только к Django-проектам. Разрабатывая веб-приложения, используя другие инструменты, вроде Flask, люди используют те же концепции веб-разработки, причём часто именно в таком же виде, как они реализованы, в Django - views, request-response объекты, middlewares, модели, формы.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" height=\"2500\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F96c\u002F4de\u002F37b\u002F96c4de37b5b6bcb2ce258ff29303e932.png\" data-width=\"2446\"\u002F\u003E\u003Cfigcaption\u003E\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Ch2\u003EКак обычно обстоят дела в реальных Django-проектах?\u003C\u002Fh2\u003E\u003Cp\u003EБольшинство начинающих разработчиков на Django, после прохождения официального туториала, зачастую начинают интересоваться, собственно, а где и как им хранить код? Вариантов много, но типичный Django-разработчик, скорее всего, найдет для себя ответ в знаменитой книге \"Two Scopes of Django\", заключающийся в следующем принципе: \u003Cem\u003E\"Fat Models, Utility Modules, Thin Views, Stupid Templates\"\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cp\u003EСо временем данный подход стал дефолтным в Django-сообществе. И этот подход, несомненно, работает. Какое-то время.\u003C\u002Fp\u003E\u003Cp\u003EВ реальности, большинство крупных проектов представляют из себя не просто CRUD-приложения, а нечто большее. Более менее серьезный бизнес-процесс подразумевает за собой манипулирование несколькими сущностями, какие-то промежуточные операции и прочее.\u003C\u002Fp\u003E\u003Cp\u003EСледуя данному принципу, в какой-то момент роста проекта вырисовывается весьма интересная картина.\u003C\u002Fp\u003E\u003Ch4\u003EЭти модели слишком толстые\u003C\u002Fh4\u003E\u003Cp\u003EНа самом деле, считаю правило \"толстых моделей\" корнем всех проблем. Самые простые бизнес-процессы, как правило, взаимодействуют только с одной сущностью. Но с ростом этих сущностей в одном бизнес-процессе у разработчика возникает следующая дилемма: \u003Cem\u003E\"Ок, я написал огромную простыню кода, которая использует несколько моделей. В какую из моделей мне положить всё это добро?\"\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cp\u003EВ худшем случае разработчик оставит весь код в модели, импортируя модели друг в друга или вынося некоторые куски кода в некие другие модули, затем снова импортируя их эти же в модели. Добро пожаловать в кольцевые импорты! В вырожденных случаях разработчик может просто начать складировать код всех моделей и их логики в один файл, получая на выходе один \u003Ccode\u003Emodels.py\u003C\u002Fcode\u003E на 1000+ строк кода.\u003C\u002Fp\u003E\u003Cp\u003EНо чаще всего бизнес-логика начинает плавно перетекать во views.\u003C\u002Fp\u003E\u003Ch4\u003EКажется, наши тонкие views становятся не такими уж и тонкими\u003C\u002Fh4\u003E\u003Cp\u003EАвторы \"Two Scopes of Django\" сами же пишут, что хранение логики во views - плохая идея, и вводят в своей книге главу \"Trimming Models\", в рамках которой поясняют, что при росте модели логику стоит выносить в слой, который они называют \"Utility Modules\".\u003C\u002Fp\u003E\u003Cp\u003EОднако, реальность довольна сурова. Бизнес-логика перетекает во views бесконтрольно, потому что никто точно не может сказать, когда наша \u003Cem\u003Ethin view\u003C\u002Fem\u003E стала не такой уж и \u003Cem\u003Ethin\u003C\u002Fem\u003E. А писать код во views быстро и просто. Там сразу и request-объект со всеми данными, и формы, которые эти данные отвалидировали.\u003C\u002Fp\u003E\u003Cp\u003EВпоследствии размер view начинает постепенно расти и в коде начинают появляться интересные ситуации, например, использование элемента глобального состояния view, такого как request-объект, прямо в бизнес логике, что намертво прибивает эту бизнес-логику к этой view.\u003C\u002Fp\u003E\u003Cp\u003EРазработчикам удобно использовать глобальное состояние view прямо в бизнес-логике. Некоторые даже не брезгуют доклеивать к нему свои промежуточные вычисления. Это всегда затрудняет чтение кода. Это делает невозможным переиспользование данной бизнес-логики в других местах проекта, таких как celery-задачи, или management-команды. В конце концов это мешает вам адекватно покрыть ваш код unit-тестами. Единственной точкой тестирования в этом случае остается ваш view.\u003C\u002Fp\u003E\u003Cp\u003EНа этом этапе бизнес-логика становится сильно привязанной к инфраструктурному слою (фреймворк\u002Fбиблиотека) вашего проекта.\u003C\u002Fp\u003E\u003Ch4\u003EКаша из Utility Modules\u003C\u002Fh4\u003E\u003Cp\u003EUtility Modules - одна из самых недопонятых концепций в мире Django. Что именно мы должны там хранить? Многие из нас начинают складировать там мусор.\u003C\u002Fp\u003E\u003Cp\u003EЧасто я наблюдаю, что люди даже не пытаются как-то формализовать правила к этому слою в своих приложениях. Все называют его по-разному. Кто-то создаёт в корне проекта файлик \u003Ccode\u003Eutils.py\u003C\u002Fcode\u003E, кто-то создаёт модули \u003Ccode\u003Ehelpers\u003C\u002Fcode\u003E или \u003Ccode\u003Eprocessors\u003C\u002Fcode\u003E. А кто-то - всё это одновременно.\u003C\u002Fp\u003E\u003Cp\u003EВ этих модулях часто могут лежать как и элементы бизнес-логики, так и какие-то универсальные утилиты. Одним словом, каша.\u003C\u002Fp\u003E\u003Ch3\u003EСервисный слой\u003C\u002Fh3\u003E\u003Cp\u003EОснова концепции сервисного слоя закладывается в понимании разницы между бизнес-логикой и инфраструктурой. Часто разработчики склонны путать эти понятия, поэтому давайте дадим им определения.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cem\u003EБизнес-логика\u003C\u002Fem\u003E - это код реализации бизнес-правил. Например, логика списаний с одного баланса и начисление на другой. Слой бизнес-логики является отображением процессов реального мира на программный код.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cem\u003EКод инфраструктуры\u003C\u002Fem\u003E - это код реализации инфраструктурных процессов, манипулирующий в основном искусственными понятиями, сформулированными сугубо для разработки ПО, например: вью, модели, фреймворки, субд, валидация входных параметров, реквесты, респонсы, API и тд.\u003C\u002Fp\u003E\u003Cp\u003EЧто такое сервисный слой? Давайте тоже попробуем дать определение. Сервисный слой - это такой набор компонентов программного кода, которые инкапсулируют в себе логику приложения. Такие компоненты мы и будем называть \u003Cem\u003Eсервисами бизнес-логики\u003C\u002Fem\u003E или \u003Cem\u003Eдоменными сервисами\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cp\u003EБизнес-логика в сервисном слое стремится быть максимально изолированной от нашей инфраструктуры, которая представляет из себя детали реализации фреймворка и других внешних зависимостей, и быть максимально близкой к предметной области. Я специально использую слово \u003Cem\u003Eстремится\u003C\u002Fem\u003E вместо \u003Cem\u003Eдолжна\u003C\u002Fem\u003E, потому что разработчики должны самостоятельно решать, какой уровень изоляции им требуется.\u003C\u002Fp\u003E\u003Cp\u003EЕсли говорить в терминах Django, то целью сервисного слоя будет вынести весь код, относящийся к бизнес-логике приложения, из моделей, view и всех остальных мест, где её быть не должно, вроде middlewares или management-команд, в отдельные модули, оформленные по определенным правилам, оставляя в инфраструктурном слое лишь вызовы из этих модулей.\u003C\u002Fp\u003E\u003Cp\u003EВ рамках сервисного слоя можно выделить также \u003Cem\u003Eинфраструктурные сервисы\u003C\u002Fem\u003E. Дело в том, что полностью вынести какие-то инфраструктурные операции за пределы бизнес-логики далеко не всегда возможно. Например, такие операции, как общение с СУБД, запись\u002Fчтение диска, хождение по сети. Их-то и можно изолировать в инфраструктурных сервисах, чтобы затем использовать в своей бизнес-логике c помощью более высокоуровневого интерфейса.\u003C\u002Fp\u003E\u003Cp\u003EИнфраструктурные сервисы здорово помогают читать бизнес-логику, так как скрывают детали реализации работы с вашей инфраструктурой, а также упрощают написание тестов бизнес-логики, так как один сервисный эндпоинт гораздо проще подменить на mock, чем набор низкоуровневых операций.\u003C\u002Fp\u003E\u003Cp\u003EТаким образом, сервисом в самом общем понимании является базовый блок кода, слоя бизнес-логики, либо инфраструктурного слоя, но не одновременно.\u003C\u002Fp\u003E\u003Ch4\u003EСервисный слой на уровне структуры проекта\u003C\u002Fh4\u003E\u003Cp\u003EС чего же можно начать формирование сервисного слоя? Начнём с самого простого - структуры модулей. Следует договориться о создании отдельных модулей на уровне каждого Django-приложения. В данной статье в качестве примера будем называть такие модули \u003Cem\u003Eservices\u003C\u002Fem\u003E:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Eproject_name\n├── app_name\n│   ├── services\n│   │   └── ...\n│   ├── tests\n│   ├── views\n│   ├── models\n...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EВы также можете сделать один глобальный модуль сервисов, если у вас, например, мало django-приложений, словом, отталкивайтесь от своего проекта.\u003C\u002Fp\u003E\u003Cp\u003EВнутри services будут храниться наши модули сервисов. Каждый отдельный модуль сервисов хранит в себе какой-то один бизнес-процесс, объединённый тесным контекстом. Модуль сервиса на уровне структуры проекта может состоять как из одного py-файла, так и из сложного набора подмодулей, организованного исходя из требований вашей бизнес-логики. Соблюдайте баланс, старайтесь не класть несколько сервисов используемых в рамках одного бизнес-процесса в один файл:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Eservices\n├── __init__.py\n├── complicated_service_example\n│   ├── __init__.py\n│   └── ...\n└── simple_service_example.py\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EПри оформлении сервиса в виде модуля старайтесь явно отражать его публичный API в \u003Ccode\u003E__init__.py\u003C\u002Fcode\u003E , туда должны быть импортированы только сущности, предназначенные для публичного использования.\u003C\u002Fp\u003E\u003Cp\u003EТакже структуру сервисного слоя можно оформить исходя из разделения на инфраструктурные сервисы и сервисы бизнес-логики.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode\u003Eservices\n├── __init__.py\n├── example_with_separated_service_layers\n│ ├── __init__.py\n│ ├── infrastructure\n│ │   └── ...\n│ ├── domain\n│ │   └── ...\n...  \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Ch4\u003EСервисный слой на уровне кода\u003C\u002Fh4\u003E\u003Cp\u003EПроектируя код сервисного слоя, в голове следует держать главное правило:\u003C\u002Fp\u003E\u003Cp\u003E\u003Cem\u003EВ сервисном слое следует изолировать бизнес-логику от инфраструктуры\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cp\u003EПроектируя сервисный слой, вы должны заставить работать свой фреймворк на свою бизнес-логику, а не наоборот, как это часто происходит в Django-приложениях. Это значит, что вы не должны использовать в коде сервисов бизнес-логики такие вещи, как request-объекты, которые принимают views, формы, celery-задачи, различные сторонние библиотеки, отвечающие за инфраструктурные задачи и т. д. Это правило очень важно. И весь подход к написанию кода отталкивается именно от него. В местах, когда вынести из пайплайна бизнес-логики инфраструктуру невозможно, требуется должным образом её изолировать. Способы изоляции будут описаны далее.\u003C\u002Fp\u003E\u003Cp\u003EНа уровне кода типичный сервис бизнес-логики представляет из себя разновидность паттерна \u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FCommand_pattern\" rel=\"noopener noreferrer nofollow\"\u003ECommand\u003C\u002Fa\u003E, который является производной от паттерна \u003Ca href=\"https:\u002F\u002Frefactoring.com\u002Fcatalog\u002FreplaceFunctionWithCommand.html\" rel=\"noopener noreferrer nofollow\"\u003EMethod Object\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cp\u003EДля примера придумаем простой сервис с минимальным количеством бизнес-логики. Допустим, требуется периодически готовить отчёт о пользователях в системе. Нужно взять все \u003Ccode\u003Eusername\u003C\u002Fcode\u003E пользователей, затем сохранить их в csv-файл, имя которого должно быть сгенерировано определенным образом.\u003C\u002Fp\u003E\u003Cp\u003EСоздадим в директории \u003Ccode\u003Eservices\u003C\u002Fcode\u003E файл \u003Ccode\u003Emake_users_report_service.py\u003C\u002Fcode\u003E со следующим содержимым:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Eimport csv\n\nfrom datetime import datetime\nfrom typing import List\n\nfrom django.contrib.auth.models import User\n\nclass MakeUsersReportService:\n\n    def _extract_username_list(self) -\u003E List[str]:     \n        return list(User.objects.values_list('username', flat=True))\n\n    def _generate_file_name(self) -\u003E str:     \n        return '{}-{}'.format('users_report', datetime.now().isoformat())\n\n    def _load_username_list_to_csv(self, file_name: str, username_list: List[str]) -\u003E str:     \n        full_path = f'reports\u002F{file_name}.csv'\n\n        with open(full_path, 'w', newline='') as csv_file:         \n            writer = csv.writer(csv_file)\n            writer.writerow(['username'])\n            writer.writerows(             \n                ([username] for username in username_list) \n            )\n\n        return full_path\n\n    def execute(self) -\u003E str:     \n        username_list = self._extract_username_list()     \n        file_name = self._generate_file_name()     \n        return self._load_username_list_to_csv(file_name, username_list)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EТакой сервис в виде класса является базовым строительным блоком сервисного слоя. Давайте внимательно рассмотрим его особенности:\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E1) Используются аннотации типов\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EАннотации типов и их чекеры вроде mypy - одно из самых значимых нововведений Python за последние годы. Аннотации типов в сервисном слое важны, в первую очередь из-за того, что \u003Cem\u003Eпомогают следовать правилам\u003C\u002Fem\u003E инфраструктурного слоя.\u003C\u002Fp\u003E\u003Cp\u003EЕсли методы вашего сервиса возвращают или принимают инфраструктурные объекты, к примеру, из Django, то это является явным маркером того, что вы что-то делаете не так.\u003C\u002Fp\u003E\u003Cp\u003EАннотации типов также помогают отразить неявные зависимости внутри кода, так как вам придется импортировать типы, объекты которых не создаются в вашем коде напрямую, если вы хотите использовать их в качестве аргументов или возвращаемых значений методов.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E2) В коде единственная публичная точка входа\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EОбратите внимание на метод \u003Ccode\u003Eexecute\u003C\u002Fcode\u003E - он является единственной публичной точкой входа в данном сервисе. Всё, что он делает - вызывает под капотом приватные методы в определенном порядке. Такая схема позволяет проще читать код - открыв сервис, сразу видно, в какой последовательности вызывается логика и как её вызывать.\u003C\u002Fp\u003E\u003Cp\u003EДанный подход помогает в проектировании сервисов. Помните, если вам хочется сделать несколько публичных методов подобных \u003Ccode\u003Eexecute\u003C\u002Fcode\u003E в одном сервисе, то это явный признак того, что скорее всего логику нужно разделить и вынести в отдельный сервис.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E3) Изолированы обращения к СУБД\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EТакое инфраструктурное действие, как обращение к СУБД, изолировано в отдельном методе - \u003Ccode\u003E_extract_username_list\u003C\u002Fcode\u003E. В приватном методe вы можете заменить, к примеру, вызов \u003Ccode\u003Evalues_list\u003C\u002Fcode\u003E на raw-sql запрос, или вообще, обращение к некому внешнему API, но при этом ваша бизнес-логика, которой просто нужен список из юзернеймов, всё равно не изменится. Мы зафиксировали интерфейс в примитивах языка.\u003C\u002Fp\u003E\u003Cp\u003EВ данном примере нужны только username-ы пользователей, и поэтому мы можем ограничиться встроенными типами Python - \u003Ccode\u003EList[str]\u003C\u002Fcode\u003E и не возвращать список объектов модели, ведь Django ORM является такой же частью инфраструктуры как и всё остальное. Более сложные кейсы мы рассмотрим чуть позже.\u003C\u002Fp\u003E\u003Cp\u003EВыбор, конечно, за вами, но помните, используя queryset-ы напрямую в коде вашей бизнес-логики, вы усложняете себе написание unit-тестов, ведь замокать queryset-ы гораздо сложнее чем просто метод, возвращающий примитив языка. Использование интеграционных тестов Django, которые позволяют вам поднять под капотом тестовую СУБД, важно, но отрабатывают такие тесты гораздо дольше, чем обычные unit-тесты, которые её не используют. А в случае если источником данных выступает некий внешний API стороннего сервиса, то и выбора по сути не остаётся - надо мокать его. \u003C\u002Fp\u003E\u003Cp\u003EДля тестирования бизнес-логики не нужно каждый раз использовать тестовую базу данных. Ведь для бизнес-логики неважно откуда пришли данные - из СУБД ли, из файла на диске или внешнего API.\u003C\u002Fp\u003E\u003Cp\u003EДля себя я вывел такую формулу: если возможно, покрывайте ваш сервис на 70% юнит-тестами с замоканным источником данных и на 30% интеграционными тестами, которые умеют поднимать вашу инфраструктуру, частью которой и является ваш источник данных в виде СУБД. Такая практика сделает приятнее разработку по TDD, а также ускорит прохождение тестов в вашем CI\u002FCD пайплайне, что тоже не может не радовать.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E4) Изолированы обращения к коду формирования csv-файла\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EЗапись информации в файл на диске - такая же инфраструктурная задача. В принципе, все тезисы, что я перечислил в 3 пункте про СУБД, подходят и сюда - проще тестировать, не надо менять остальной код в случае, если понадобится писать, к примеру, exel файл вместо csv.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E5) Название сервиса отражает конкретное действие\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EНазвание сервиса должно отражать некое конкретное действие. Размытое название сигнализирует о том, что код выполняет более чем одно конкретное действие, что является нежелательным для \u003Cem\u003Eсервисов бизнес-логики\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\u003Cp\u003EТолько что мы рассмотрели пример очень простого сервиса, состоящего из трёх простых этапов. Бизнес-логики в этом сервисе было весьма мало. В реальности сервисы, конечно же, гораздо сложнее. Давайте рассмотрим, какие проблемы у вас могут возникнуть с кодом выше и как их можно решить в рамках сервисного слоя.\u003C\u002Fp\u003E\u003Ch3\u003EValue Object, DTO, DAO\u003C\u002Fh3\u003E\u003Cp\u003EДавайте представим, что теперь в наш отчёт нужно писать не только username-ы пользователей, но так же и их emal-ы, имена, id и прочее. В рамках сервисного слоя мы стремимся отгородить бизнес-логику от инфраструктуры. А это значит, что вернув список из объектов Django-модели, мы отступим от наших принципов.\u003C\u002Fp\u003E\u003Cp\u003EТогда, часть кода выше, отвечающая за запрос к СУБД можно модифицировать следующим образом (реализацию остальных методов пока опустим):\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003E...\nfrom dataclasses import dataclass\nfrom typing import Generator\n\nfrom django.contrib.auth.models import User\n\n@dataclass\nclass UsersReportRow:\n    pk: int\n    username: str\n    email: str\n    is_active: bool\n\nclass UsersReportService:\n\n    def _extract_users_data(self) -\u003E Generator[UsersReportRow]:     \n        for user in User.objects.all():         \n            yield UsersReportRow(             \n                pk=user.pk,             \n                username=user.username,\n                email=user.email,   \n                is_active=user.is_active,\n            )\n...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EМетод \u003Ccode\u003E_extract_username_list\u003C\u002Fcode\u003E мы заменили на \u003Ccode\u003E_extract_users_data\u003C\u002Fcode\u003E, который теперь возвращает генератор с \u003Ca href=\"https:\u002F\u002Fwww.martinfowler.com\u002Fbliki\u002FValueObject.html\" rel=\"noopener noreferrer nofollow\"\u003EValue Object\u003C\u002Fa\u003E-ами, реализованный в виде дата-класса. Дата-классы - весьма полезный инструмент в разработке на Python.\u003C\u002Fp\u003E\u003Cp\u003EЧасто питонисты пренебрегают создавать классы просто для передачи данных и могут использовать в подобных ситуациях, к примеру, список из dict-ов, что является худшей альтернативой. Достоинство классов перед dict-ами состоит в фиксированной схеме данных, которая находится у вас в коде. Такую фиксированную схему данных удобнее использовать в аннотациях типов. При вызове метода, который возвращает пользовательский объект вместо dict, отпадает потребность идти и каждый раз вспоминать его содержимое - ваша IDE сможет помочь вам, когда вам потребуется обратиться к атрибутам.\u003C\u002Fp\u003E\u003Cp\u003EИногда под Value Object имеют в виду другой паттерн - \u003Ca href=\"https:\u002F\u002Fwww.martinfowler.com\u002FeaaCatalog\u002FdataTransferObject.html\" rel=\"noopener noreferrer nofollow\"\u003EDTO - Data Transfer Object\u003C\u002Fa\u003E. С моей точки зрения, DTO - сущность общения между сервисами, в то время как Value Object является сущностью общения внутри сервиса.\u003C\u002Fp\u003E\u003Cp\u003EЕсли представить, что наш сервис ,помимо пути к сгенерированному отчёту, должен будет вернуть ещё какую-либо информацию, например, уникальный id отчёта, это могло бы выглядеть так:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003E...\nfrom dataclasses import dataclass\n\n@dataclass\nclass UsersReportDTO:\n    full_path: str\n    report_id: str\n\nclass UsersReportService:\n...\n    def execute(self) -\u003E UsersReportDTO:\n        ...\n        return UsersReportDTO(\n            full_path=full_path,\n            report_id=report_id,\n        )\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EЧаще всего, помимо чтения данных, может понадобится и много других операций с хранилищем: создание, обновление данных, агрегация. Как оставить сервис простым и не засорять бизнес-логику кодом работы с хранилищем?\u003C\u002Fp\u003E\u003Cp\u003EОтвет - изолировать работу с вашим хранилищем через \u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FData_access_object\" rel=\"noopener noreferrer nofollow\"\u003EDAO - Data access object\u003C\u002Fa\u003E. Вот так может выглядеть DAO для взаимодействия с таблицей пользователей в Django:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Efrom dataclasses import dataclass\nfrom typing import Iterable\n\nfrom django.contrib.auth.models import User\n\n\n@dataclass\nclass UserEntity:\n    pk: int\n    username: str\n    email: str\n    is_active: bool\n\n\nclass UsersDAO:\n\n    def _orm_to_entity(self, user_orm: User) -\u003E UserEntity:     \n        return UserEntity(         \n            pk=user_orm.pk,         \n            username=user_orm.username,\n            email=user_orm.email,\n            is_active=user_orm.is_active, \n        )\n\n    def fetch_all(self) -\u003E Iterable[UserEntity]:     \n        return map(self._orm_to_entity, User.objects.all())\n\n    def count_all(self) -\u003E int:\n        ...\n\n    def update_is_active(self, users_ids: Iterable[int], is_active: bool) -\u003E None:  \n        ...\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EТаким образом, в коде сервиса вашей бизнес-логики  остаётся только использование DAO без построения запросов к СУБД напрямую.\u003C\u002Fp\u003E\u003Cp\u003EХочу ещё раз обратить внимание - мы специально не используем объекты моделей Django. Заставляя двигать данные внутри нашего сервисного слоя через примитивы языка и пользовательские объекты, мы изолируем нашу бизнес-логику от инфраструктуры.\u003C\u002Fp\u003E\u003Cp\u003EИзолирование работы с ORM в коде обычно вызывает больше всего негативных эмоций у Django-разработчиков. Думаю, это происходит в первую очередь из-за того, что очень часто доменная модель бизнес-сущностей накладывается на модели Django в начале разработки новой фичи.\u003C\u002Fp\u003E\u003Cp\u003EМожет быть, такая изоляция и выглядит избыточной, когда в примере можно сделать всего один простой запрос в ORM, но поверьте, если для бизнес-логики вам в какой-то момент потребуется не просто достать набор строк из таблицы, а собрать некий агрегат, делая несколько запросов в разные источники данных, или сделать raw-sql запрос через драйвер к СУБД, который возвращает вместо адекватного объекта какой-то tuple из tuple-ов, то помимо всех достоинств, описанных ещё в предыдущем более простом примере, вы получите ещё и улучшенную в разы читаемость кода.\u003C\u002Fp\u003E\u003Cp\u003EТак же весьма важным эффектом является то, что изолируя ORM, если в какой-то момет вам придётся заменить источник данных, к примеру, на MongoDB, или вообще, веб-API вашего другого сервиса, вам не придётся переписывать кучу unit-тестов и всю бизнес-логику. Нужно будет только переписать тесты на ваш DAO или метод сервиса, который возвращает DTO\u002FValue Object. Главное лишь то, чтобы ваш код изолирующий работу с данными сохранял старый интерфейс. Сделайте вашу инфраструктуру зависимой от бизнес-логики, а не наоборот!\u003C\u002Fp\u003E\u003Ch3\u003EDependency injection - построение комплексных сервисов\u003C\u002Fh3\u003E\u003Cp\u003EЧаще всего, нам требуется писать сложные пайплайны бизнес-логики, и в таких случаях, при помещении всего кода в один сервис, он становится плохо читаемым. Тогда требуется отделять сложные части пайплайна в отдельные сервисы. Таким образом, сервисы могут быть комплексными и использовать под капотом другие сервисы, как инфраструктурные, так и доменные.\u003C\u002Fp\u003E\u003Cp\u003EТеперь давайте снова усложним наш пример. Представим, что заказчик захотел, чтобы помимо csv-файла была так же возможность сгенерировать и exel-файл.\u003C\u002Fp\u003E\u003Cp\u003EСоздадим два новых инфраструктурных сервиса, затем встроим их в наш сервис бизнес-логики. Один из них будет отвечать за запись xlsx, а второй - за csv.\u003C\u002Fp\u003E\u003Cp\u003EМодифицируем исходный файл \u003Ccode\u003Emake_users_report_service.py\u003C\u002Fcode\u003E (снова опустим подробности реализации):\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003E...\nimport abc\nfrom typing import Iterable\n\nclass IReportFileAdapter(abc.ABC):\n\n    @abc.abstractmethod\n    def create_report_file(self, file_name: str, username_list: Iterable[UsersReportRow]) -\u003E str:     \n        pass\n\n...\n\nclass UsersReportService:\n\n    def __init__(self, report_file_adapter: IReportFileAdapter):     \n        self.report_file_adapter = report_file_adapter\n\n    def _extract_users_data(self) -\u003E Generator[UsersReportRow]:     \n        ...\n\n    def _generate_file_name(self) -\u003E str:     \n        ...\n\n    def execute(self) -\u003E str:     \n        username_list = self._extract_users_data()     \n        file_name = self._generate_file_name()     \n        return self.report_file_adapter.create_report_file(file_name, users_data_list)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EИ далее, создадим новый файл с инфраструктурными сервисами, реализованными в виде адаптеров  \u003Ccode\u003Ereport_file_adapters.py\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Eimport abc\nfrom typing import Iterable\n\nfrom .make_users_report_service import IReportFileAdapter\n\nclass CSVReportFileAdapter(IReportFileAdapter):\n\n    def create_report_file(self, file_name: str, username_list: List[str]) -\u003E str:     \n        ...\n\nclass XLSXReportFileAdapter(IReportFileAdapter):\n\n    def create_report_file(self, file_name: str, username_list: List[str]) -\u003E str:     \n        ...\n      \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EТаким образом, вызывать сервис бизнес-логики вы сможете с разными адаптерами, в зависимости от того, какой файл вам нужно сгенерировать.\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Efrom your_django_app.services.reports import (\n    UsersReportService,\n    CSVReportFileAdapter,\n)\n\nusers_report_service = UsersReportService(report_file_adapter=CSVReportFileAdapter())\npath_to_report = users_report_service.execute()\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EДавайте рассмотрим написанный код подробнее:\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E1) Inversion of Control\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EС помощью абстрактного базового класса мы эмулировали интерфейс в нашем коде и положили его именно рядом с нашей бизнес-логикой, а не адаптерами. Таким образом, мы смогли достичь \u003Ca href=\"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FInversion_of_control\" rel=\"noopener noreferrer nofollow\"\u003EИнверсии управления\u003C\u002Fa\u003E в нашем коде. Благодаря этому в файл с бизнес-логикой не нужно делать импорты инфраструктурных сервисов, которые умеют писать csv\u002Fxlsx. Мы добились зависимости инфраструктурного слоя от бизнес-логики, а не наоборот.\u003C\u002Fp\u003E\u003Cp\u003EВы так же можете достичь IoC с помощью типа \u003Ca href=\"https:\u002F\u002Fmypy.readthedocs.io\u002Fen\u002Fstable\u002Fprotocols.html#simple-user-defined-protocols\" rel=\"noopener noreferrer nofollow\"\u003EProtocol\u003C\u002Fa\u003E, появившегося в typing начиная с python 3.8.\u003C\u002Fp\u003E\u003Cp\u003EМногие считают IoC в python излишним. Применяйте по ситуации: если вам не нужна высокая степень изоляции компонентов, можно обойтись и без IoC, либо использовать абстрактные базовые классы с реализацией, которые уже следовало бы держать рядом с адаптерами в моём примере. Сервисный слой гибок.\u003C\u002Fp\u003E\u003Cp\u003E\u003Cstrong\u003E2) Удобный mock\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cp\u003EОдному мне не нравится каждый раз писать в тестах длинный \u003Ccode\u003E@mock.patch('...')\u003C\u002Fcode\u003E? Длинный путь к объекту, который вы хотите замокать, банально неудобно читать и прописывать. К тому же, при перемещении или переименовании объекта, который вы мокаете, эту строку нужно будет не забыть поправить. Теперь всё можно сделать гораздо приятнее. Встраивая сервисы друг в друга, при написании тестов, вы получаете возможность пробрасывать Mock при инициализации вашего сервиса:\u003C\u002Fp\u003E\u003Cpre\u003E\u003Ccode class=\"python\"\u003Efrom mock import Mock\nfrom unittest import TestCase\n\nfrom your_django_app.services.reports import (\n    UsersReportService,\n    IReportFileAdapter,\n)\n\n\nclass UsersReportServiceTestCase(TestCase):\n\n    def test_example(self):\n        report_file_adapter_mock = Mock(spec=IReportFileAdapter)\n        users_report_service = UsersReportService(\n            report_file_adapter=report_file_adapter_mock\n        )\n        ...\n...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cp\u003EИспользуя внедрение зависимостей, вы можете строить сложные пайплайны бизнес-логики из большого количества ваших рабочих блоков с кодом - сервисов.\u003C\u002Fp\u003E\u003Ch3\u003EО любви Python-сообщества к библиотекам и зависимости от инфрастурктуры\u003C\u002Fh3\u003E\u003Cp\u003EЧто делают в python-сообществе когда возникает проблема? Правильно - пишут новую awesome-библиотеку (\u003Cs\u003Eи теперь у нас две проблемы\u003C\u002Fs\u003E). Идея сервисного слоя не нова, и библиотеки на эту тему уже есть.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fmixxorz\u002Fdjango-service-objects\" rel=\"noopener noreferrer nofollow\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fmixxorz\u002Fdjango-service-objects\u003C\u002Fa\u003E - автор предлагает писать сервисный слой на основе Django-форм. С моей точки зрения, валидация входных данных должна происходить в инфраструктурном слое, а не перегружать собой слой бизнес-логики. На слое сервисов можно валидировать только бизнес-правила. А всякие проверки, что число - это число, а не строка, лучше оставить обычным Django-формам.\u003C\u002Fp\u003E\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fdry-python\u002Fstories\" rel=\"noopener noreferrer nofollow\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fdry-python\u002Fstories\u003C\u002Fa\u003E - ещё одна библиотека для построения сервисного слоя. Давно слежу за ребятами. Помимо stories, у них много других интересных библиотек на разные темы.\u003C\u002Fp\u003E\u003Cp\u003EЯ против использования подобных библиотек. И вот почему:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EСторонняя библиотека - это уже часть инфраструктуры, сама по себе. Завязывая вашу бизнес-логику на такую библиотеку, вы заранее завязываете свою бизнес-логику на инфраструктуру, что уже противоречит идеи разделения бизнес-логики и инфраструктуры на разные слои. Однажды вам может понадобится выйти за рамки вашей библиотеки для написания бизнес-логики, и, скорее всего, это будет больно. Сильно задумайтесь, нужно ли вам это.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EУ многих в голове стереотип, что Python - язык для data science и каких-то DevOps-скриптов, и без дополнительных приседаний в виде специальных библиотек, нормально оформить в нём сложную бизнес-логику нельзя. Естественно, это не правда. Python давно готов для написания серьезных приложений с нагруженной бизнес-логикой. В этой статье я привёл примеры разных приёмов, которые не требовали сторонних зависимостей для описания бизнес-логики. Если вам захочется выйти за рамки описанного в статье, вы будете ограничены лишь языком программирования, а не какой-то библиотекой.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003EСервисный слой должен оставаться гибким, и подходить потребностям вашей команды. Имейте это в виду, если всё-таки решитесь завязать ядро вашего приложения, которым является ваша бизнес-логика, на какую-то библиотеку.\u003C\u002Fp\u003E\u003Ch3\u003EЧто дальше?\u003C\u002Fh3\u003E\u003Cp\u003EЛучше всех по теме негативных последствий от зависимости бизнес-логики от инфраструктуры приложения уже высказывался Роберт Мартин в своих статьях \"\u003Ca href=\"https:\u002F\u002Fblog.cleancoder.com\u002Funcle-bob\u002F2011\u002F09\u002F30\u002FScreaming-Architecture.html\" rel=\"noopener noreferrer nofollow\"\u003EScreaming Architecture\u003C\u002Fa\u003E\" и \"\u003Ca href=\"https:\u002F\u002Fblog.cleancoder.com\u002Funcle-bob\u002F2012\u002F08\u002F13\u002Fthe-clean-architecture.html\" rel=\"noopener noreferrer nofollow\"\u003EThe Clean Architecture\u003C\u002Fa\u003E\", а также прекрасной книге \"Clean Architecture: A Craftsman's Guide to Software Structure and Design\".\u003C\u002Fp\u003E\u003Cp\u003EВ принципе, если возвести все приемы, которые я показал в статье, в абсолют, и везде использовать DI и IoC, а также ещё пару приёмов, то у вас получится своя реализация чистой архитектуры.\u003C\u002Fp\u003E\u003Cp\u003EВы могли видеть в данной статье элементы Domain-driven design. Для ознакомления рекомендую обратить внимание на книгу \"Domain-Driven Design: Tackling Complexity in the Heart of Software\" от Эрика Эванса. Сервисный слой можно также развить в полноценное DDD приложение.\u003C\u002Fp\u003E\u003Chr\u002F\u003E\u003Ch3\u003EПодводя итог\u003C\u002Fh3\u003E\u003Cp\u003EИтак, подведём итог нашему путешествию в сервисный слой:\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EНачните со структуры - заведите отдельный модуль для вашего сервисного слоя и хорошо структурируйте его.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EСервисы бизнес-логики оформляются в виде классов-команд (классов с одним публичным методом). Инфраструктурные - по ситуации.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EТрафик данных в сервисах, а также между ними, лучше всего осуществлять в примитивах языках и пользовательских объектах с помощью Value Object, DTO, DAO.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EБольше тестов! Покрывайте сервисы тестами, активно мокайте инфраструктуру и другие сервисы от которых вы зависите.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EСервисы могут быть комплексными и вызывать под капотом другие сервисы. Такое взаимодействие будет удобно организовать через Dependency Injection.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EСервисный слой должен подходить потребностям вашей команды. Опасайтесь завязки на чужие решения в виде библиотек или фреймворков. Используйте только те приёмы, что вы считаете нужными. Возможно, просто вынесение кода из ваших views, без серьезной изоляции инфраструктуры, может решить большинство ваших проблем.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"python"},{"titleHtml":"python3"},{"titleHtml":"python 3"},{"titleHtml":"django"},{"titleHtml":"clean architecture"},{"titleHtml":"service layer"},{"titleHtml":"ddd"},{"titleHtml":"domain-driven design"},{"titleHtml":"unit testing"},{"titleHtml":"clean code"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F581964\u002F3b27b084c6175ee44ff86f55dbe5c27f\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F581964\u002F3b27b084c6175ee44ff86f55dbe5c27f\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F581964\\\u002F\"},\"headline\":\"Python service layer: основы оформления бизнес-логики на примере Django-приложений\",\"datePublished\":\"2021-10-06T17:29:45+03:00\",\"dateModified\":\"2021-10-06T17:29:45+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"ChasingRainbows\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Django - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику.\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F581964\\\u002F#post-content-body\",\"about\":[\"h_python\",\"h_django\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F96c\\\u002F4de\\\u002F37b\\\u002F96c4de37b5b6bcb2ce258ff29303e932.png\"]}","metaDescription":"Django - отличный фреймворк, но он, на самом деле, толком не дает, да и не должен давать, ответ на вопрос, каким образом лучше всего хранить вашу бизнес-логику. Хранение бизнес-логики в моделях или...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"python,django"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
